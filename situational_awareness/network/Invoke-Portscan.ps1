 &('Sv') ('y6'+'M')  (  [type]("{1}{0}{2}" -F 's','sY','tEM.mAth') );    &("{1}{2}{0}"-f 'IABle','sEt-','vaR')  ("iztH"+"mr")  ( [tyPe]("{0}{1}{4}{3}{2}"-F'sysT','Em.','VErTer','coN','BIt') );$m4hkC  =  [tyPe]("{0}{1}" -F 'Arr','aY') ;   &("{0}{1}{2}" -f 'sE','T-VARia','bLe') ("{1}{0}"-f 'an','eD6') ([type]("{1}{2}{0}{3}" -F'e','enVIRo','nm','nT') )  ;    &("{0}{2}{1}"-f'SeT-','tEm','i')  ("{1}{4}{2}{3}{0}" -f 'b','VaRiAbL','s','O','e:K3z') ([TYPe]("{4}{6}{1}{2}{5}{3}{0}" -f'TeR','sTEm.','Xml','LWRi','S','.Xm','Y') );   &("{2}{0}{1}" -f 'eT-','iteM','s')  ("VA"+"R"+"IAbLe:4"+"0"+"KFqo")  ( [tyPE]("{0}{1}{2}"-f'S','TRIn','G')) ;   $OzE = [typE]("{1}{3}{4}{5}{2}{6}{0}"-F'iNG.ThReAdpooL','SY','REa','s','Tem','.th','d') ;  &('SV') ("Dt5"+"law")  ([TYpe]("{0}{2}{3}{1}"-F'caLlB','TBridge','acKEve','n') );  $qvWt1  = [Type]("{1}{0}{4}{2}{3}" -F'M.ne','SysTE','RE','ss','T.ipADd');  &("{1}{0}"-f 'eM','sEt-IT') ('vARIa'+'BLe'+':cy9Ub')  (  [tyPe]("{2}{1}{0}{3}"-f'bl','T','sCRip','oCK')  );function INV`OkE`-POrT`s`caN
{


    [CmdletBinding()]Param (
        
        [Parameter(PAraMetErSETnAmE="CMDho`S`Ts",

                   VALuefroMPipELINE=${TR`Ue},
                   mANdatOrY = ${t`RuE})]
                   [String[]] ${H`o`StS},

        [Parameter(ParAMEteRseTnAmE="Fh`os`TS",
                   MandATORy = ${t`RUE})]
                   [Alias("iL")]
                   [String]  ${hos`TFi`le},

        [Parameter(MaNDAToRY = ${F`AlSe})]
                   [Alias({"{1}{0}" -f 'de','exclu'})]
                   [String] ${eXcLU`de`hOS`Ts},

        [Parameter(mANdAtoRY = ${F`Al`Se})]
                   [Alias("p")]
                   [String] ${pO`R`Ts},

        [Parameter(mANdATORy = ${fA`L`SE})]
                   [Alias("iP")]
                   [String] ${p`Or`TfIle},

        [Parameter(MaNdAToRY = ${f`ALSE})]
                   [String] ${T`o`PPOR`Ts},

        [Parameter(MAndaTORy = ${f`AlSe})]
                   [Alias({"{1}{0}" -f 'rts','xPo'})]
                   [String] ${EXClu`deD`P`Orts},

        [Parameter(mANDatORY = ${FA`LsE})]
                   [Switch] ${op`En},

        
        [Parameter(mANDatOry = ${F`A`lSE})]
                   [Alias("Pn")]
                   [Switch] ${SK`I`p`disCOVeRy},

        [Parameter(mAndatorY = ${F`Al`SE})]
                   [Alias("sn")]
                   [Switch] ${PiN`G`onLY},

        [Parameter(MaNDAtOrY = ${Fa`lSe})]
                   [Alias("PS")]
                   [string] ${dIscovER`yP`o`RTs} = ("{0}{1}{2}"-f '-1,445,80',',44','3'),

        
        [Parameter(ManDATORy = ${F`AlsE})]
                   [int] ${ThR`Ea`Ds} = 100,

        [Parameter(mANdATOrY = ${Fa`L`SE})]
                   [int] ${nHo`sTS} = 25,

        [Parameter(mandaToRy = ${Fa`L`se})]
                   [int] ${ti`MeO`Ut} = 2000,

        [Parameter(mandatory = ${f`ALSe})]
                   [int] ${sleEPt`im`eR} = 500,

        [Parameter(manDATorY = ${fa`lse})]
                   [int] ${SYNc`F`REQ} = 1024,

        [Parameter(MaNDaTOry = ${FA`lSE})]
                   [int] ${T},

        
        [Parameter(MaNDatoRY = ${F`Al`se})]
                   [Alias("oG")]
                   [String] ${Gr`e`pout},

        [Parameter(mANDAToRY = ${fa`l`sE})]
                   [Alias("oX")]
                   [String] ${xmLo`Ut},

        [Parameter(mandAtOry = ${fAl`sE})]
                   [Alias("oN")]
                   [String] ${readaB`LEO`Ut},

        [Parameter(mAnDatOry = ${F`ALsE})]
                   [Alias("oA")]
                   [String] ${A`l`L`FoRmaTSO`UT},

        [Parameter(MandaTORy = ${fal`sE})]
                   [Switch] ${NOprO`gReS`S`Me`TEr},

        [Parameter(mAnDAtORy = ${f`ALSE})]
                   [Alias("q")]
                   [Switch] ${Qu`Iet},

        [Parameter(MandAtORY = ${F`ALSe})]
                   [Alias("F")]
                   [Switch] ${f`oRCe`O`VeRWR`iTe}

        
        
    )

    PROCESS {

        &("{2}{0}{3}{1}" -f '-','e','Set','StrictMod') -Version 2.0

        ${ver`sIoN} = .13
        ${h`oSTL`ist} = &("{1}{0}{2}{3}" -f '-Ob','New','jec','t') ("{0}{5}{3}{2}{4}{1}"-f'S','t','ayLi','r','s','ystem.Collections.Ar')
        ${po`R`TL`isT} = &("{0}{1}{2}" -f 'New-Ob','j','ect') ("{6}{4}{1}{5}{0}{3}{2}"-f'.ArrayL','llect','st','i','o','ions','System.C')
        ${HostP`Or`T`LI`St} = &("{0}{1}{3}{2}" -f 'Ne','w','t','-Objec') ("{0}{3}{6}{4}{1}{2}{5}" -f 'S','ns.Array','Lis','ys','ctio','t','tem.Colle')

        ${s`CanNeDHOs`T`l`IsT} = @()

        function pA`Rs`E-hosTs
        {
            Param (
                [Parameter(MaNdAtORy = ${T`RUe})] [String] ${h`OsTS}
            )

            [String[]] ${Ih`O`stS} = ${HOs`Ts}.("{1}{0}"-f 'it','Spl').Invoke(",")

            foreach(${IH`OSt} in ${IHO`stS})
            {
                ${I`hoSt} = ${ih`osT}.("{1}{0}{2}"-f'eplac','R','e').Invoke(" ", "")

                if(!${I`h`OST})
                {
                    continue
                }

                if(${i`HoST}.("{0}{1}" -f'conta','ins').Invoke("/"))
                {
                    ${N`ETP`ART} = ${I`HoSt}.("{0}{1}" -f 'spli','t').Invoke("/")[0]
                    [uint32]${Ma`SKP`ArT} = ${I`hoSt}.("{1}{0}" -f 'it','spl').Invoke("/")[1]

                    ${ADD`R`ESS} =  (&("{1}{0}" -f'E','VariABl')  ("{1}{0}" -f'WT1','QV'))."v`ALUe"::("{0}{1}" -f 'Pars','e').Invoke(${nET`P`ART})

                    if (${m`ASkPA`RT} -ge ${a`DDRE`SS}.("{1}{2}{0}"-f'tes','Get','AddressBy').Invoke()."lEn`g`TH" * 8)
                    {
                        throw ("{0}{2}{1}" -f'Ba','mask','d host ')
                    }

                    ${n`UMHoS`TS} =   (  &("{1}{0}{2}"-f 't-itE','GE','m')  ('VarIAble:'+'y6'+'M') )."vaL`Ue"::("{0}{1}" -f 'Po','w').Invoke(2,((${add`Re`Ss}.("{0}{1}{2}{3}" -f'GetAd','dr','es','sBytes').Invoke()."LeNG`Th" *8) - ${mA`sKp`ArT}))

                    ${s`TarTaDd`RESS} = ${Ad`dRe`Ss}.("{3}{0}{1}{4}{2}"-f'ddres','sB','s','GetA','yte').Invoke()
                      ( &("{1}{2}{0}"-f 'bLE','gET-VAR','IA') ('M4hK'+'C') -vAL)::("{0}{1}" -f 'Revers','e').Invoke(${s`Ta`RTaDDrE`sS})

                    ${S`TArt`ADDRess} =   (  &("{0}{1}"-f'itE','M')  ("{2}{1}{0}{4}{3}"-f 'i','AR','v','ztHMR','able:i') )."V`ALuE"::("{0}{1}" -f 'ToUInt','32').Invoke(${sTARtA`D`dReSs}, 0)
                    [uint32]${s`TaR`TmaSk} = ( (&("{2}{1}{0}"-f 'ARIabLE','et-V','g')  ("{1}{0}" -f'm','Y6')  )."val`UE"::("{0}{1}"-f'Po','w').Invoke(2, ${mA`s`KPArT})-1) * (  (&("{2}{0}{1}{3}"-f'-','V','get','ARiABle')  ('Y6'+'m') -VAl)::("{1}{0}" -f 'w','Po').Invoke(2,(32 - ${MaSkPa`RT})))
                    ${S`T`AR`Tad`Dress} = ${StaR`T`A`ddrEss} -band ${StA`Rt`mASk}

                    
                    ${StAr`Ta`D`dresS} =  (&('Ls')  ('Va'+'R'+'i'+'aBl'+'E:IZTHmr'))."VA`LUe"::("{1}{0}"-f'tBytes','Ge').Invoke(${STA`R`TadDr`eSs})[0..3]
                      ( &("{2}{1}{0}"-f 'BLe','ia','vaR') ('M4H'+'kC')  -VALu)::("{0}{1}" -f'Re','verse').Invoke(${STA`RTadd`ReSs})

                    ${A`d`dReSs} = [System.Net.IPAddress] [byte[]] ${s`TaRta`DDreSs}

                    ${ho`STLi`sT}.("{0}{1}" -f 'A','dd').Invoke(${A`ddr`esS}."I`PaDdreSST`OST`RI`NG")

                    for (${I}=0; ${i} -lt ${N`Umh`ostS}-1; ${i}++)
                    {

                        ${n`E`xTaDd`REss} =  ${a`Dd`ReSS}.("{2}{1}{3}{0}"-f 'ytes','e','G','tAddressB').Invoke()
                         ( &('gi')  ("vaRiabLe"+":m4hK"+"c") )."val`UE"::("{0}{1}" -f'Reve','rse').Invoke(${N`eXtaDD`R`EsS})
                        ${nex`TaD`d`ReSS} =    (&("{3}{2}{1}{0}" -f 'bLe','-vARIa','t','gE') ('iZTh'+'mR') -VALU )::("{1}{2}{0}"-f 't32','T','oUIn').Invoke(${nE`XtaDdrE`sS}, 0)
                        ${nE`XTaddr`e`SS} ++
                        ${ne`X`TaDd`ReSS} =   $iZThMr::("{0}{1}"-f'GetByte','s').Invoke(${N`EXTAdDR`eSs})[0..3]
                         (  &("{3}{1}{0}{2}" -f 'rIAb','T-vA','lE','ge') ("{0}{1}" -f'M4','hKC')  -val  )::("{1}{2}{0}"-f'e','Reve','rs').Invoke(${ne`Xt`AddResS})

                        ${Ad`D`ReSS} = [System.Net.IPAddress] [byte[]] ${NEX`T`ADDr`EsS}
                        ${hO`s`TLI`ST}.("{1}{0}"-f'dd','A').Invoke(${aD`drEsS}."IpA`dD`Resst`osTr`i`Ng")

                    }

                }
                else
                {
                    ${hOs`Tl`isT}.("{1}{0}" -f 'dd','A').Invoke(${iho`st})
                }
            }
        }

        function P`ArS`e-IL`HOsTs
        {
           Param (
                [Parameter(MANDAtorY = ${tr`UE})] [String] ${H`OSTFIle}
            )

            &("{3}{0}{1}{2}" -f 'C','onte','nt','Get-') ${h`oStFi`LE} | &("{4}{0}{1}{3}{2}"-f 'h','-O','ect','bj','ForEac') {
                &("{0}{2}{1}"-f'Pa','osts','rse-H') ${_}
            }
        }

        function eXCLUD`E-H`OS`TS
        {
            Param (
                [Parameter(MandATOrY = ${t`RUe})] [String] ${eX`clude`h`Osts}
            )

            [String[]] ${I`ho`stS} = ${Ex`cluDE`HosTS}.("{1}{0}"-f 'lit','Sp').Invoke(",")

            foreach(${i`hOst} in ${iH`osts})
            {
                ${IH`oST} = ${I`HOST}.("{0}{1}{2}"-f'R','e','place').Invoke(" ", "")
                ${HO`Stl`Ist}.("{0}{2}{1}"-f'Re','e','mov').Invoke(${ihO`sT})
            }
        }

        function GEt`-`TOppO`Rt
        {
            Param (
                [Parameter(MAnDAtOrY = ${tR`Ue})]
                [ValidateRange(1,1000)]
                [int] ${nUmP`OR`TS}
            )

            
            [int[]] ${t`o`Pp`ortLISt} = @(80,23,443,21,3389,110,445,139,143,53,135,3306,8080,22
                        1723,111,995,993,5900,1025,1720,548,113,81,6001,179,1026,2000,8443,
                        8000,32768,554,26,1433,49152,2001,515,8008,49154,1027,5666,646,5000,
                        5631,631,49153,8081,2049,88,79,5800,106,2121,1110,49155,6000,513,
                        990,5357,49156,543,544,5101,144,7,389,8009,9999,5009,7070,5190,3000,
                        5432,1900,3986,13,1029,9,5051,6646,49157,1028,873,1755,2717,4899,9100,
                        119,37,1000,3001,5001,82,10010,1030,9090,2107,1024,2103,6004,1801,
                        5050,19,8031,1041,255,1048,1049,1053,1054,1056,1064,3703,17,808,3689,
                        1031,1044,1071,5901,100,9102,2869,4001,5120,8010,9000,2105,636,1038,
                        2601,1,7000,1066,1069,625,311,280,254,4000,1761,5003,2002,1998,2005,
                        1032,1050,6112,1521,2161,6002,2401,902,4045,787,7937,1058,2383,1033,
                        1040,1059,50000,5555,1494,3,593,2301,3268,7938,1022,1234,1035,1036,1037,
                        1074,8002,9001,464,497,1935,2003,6666,6543,24,1352,3269,1111,407,500,
                        20,2006,1034,1218,3260,15000,4444,264,33,2004,1042,42510,999,3052,1023,
                        222,1068,888,7100,1717,992,2008,7001,2007,8082,512,1043,2009,5801,1700,
                        7019,50001,4662,2065,42,2602,3333,9535,5100,2604,4002,5002,1047,1051,1052,
                        1055,1060,1062,1311,3283,4443,5225,5226,6059,6789,8089,8651,8652,8701,9415,
                        9593,9594,9595,16992,16993,20828,23502,32769,33354,35500,52869,55555,55600,
                        64623,64680,65000,65389,1067,13782,366,5902,9050,85,1002,5500,1863,1864,
                        5431,8085,10243,45100,49999,51103,49,90,6667,1503,6881,27000,340,1500,8021,
                        2222,5566,8088,8899,9071,5102,6005,9101,163,5679,146,648,1666,83,3476,5004,
                        5214,8001,8083,8084,9207,14238,30,912,12345,2030,2605,6,541,4,1248,3005,8007,
                        306,880,2500,1086,1088,2525,4242,8291,9009,52822,900,6101,2809,7200,211,800,
                        987,1083,12000,705,711,20005,6969,13783,1045,1046,1061,1063,1070,1072,1073,
                        1075,1077,1078,1079,1081,1082,1085,1093,1094,1096,1098,1099,1100,1104,1106,
                        1107,1108,1148,1169,1272,1310,1687,1718,1783,1840,2100,2119,2135,2144,2160,
                        2190,2260,2381,2399,2492,2607,2718,2811,2875,3017,3031,3071,3211,3300,3301,
                        3323,3325,3351,3404,3551,3580,3659,3766,3784,3801,3827,3998,4003,4126,4129,
                        4449,5222,5269,5633,5718,5810,5825,5877,5910,5911,5925,5959,5960,5961,5962,
                        5987,5988,5989,6123,6129,6156,6389,6580,6901,7106,7625,7777,7778,7911,8086,
                        8181,8222,8333,8400,8402,8600,8649,8873,8994,9002,9011,9080,9220,9290,9485,
                        9500,9502,9503,9618,9900,9968,10002,10012,10024,10025,10566,10616,10617,10621,
                        10626,10628,10629,11110,13456,14442,15002,15003,15660,16001,16016,16018,17988,
                        19101,19801,19842,20000,20031,20221,20222,21571,22939,24800,25734,27715,28201,
                        30000,30718,31038,32781,32782,33899,34571,34572,34573,40193,48080,49158,49159,
                        49160,50003,50006,50800,57294,58080,60020,63331,65129,691,212,1001,1999,2020,
                        2998,6003,7002,50002,32,2033,3372,99,425,749,5903,43,458,5405,6106,6502,7007,
                        13722,1087,1089,1124,1152,1183,1186,1247,1296,1334,1580,1782,2126,2179,2191,2251,
                        2522,3011,3030,3077,3261,3493,3546,3737,3828,3871,3880,3918,3995,4006,4111,4446,
                        5054,5200,5280,5298,5822,5859,5904,5915,5922,5963,7103,7402,7435,7443,7512,8011,
                        8090,8100,8180,8254,8500,8654,9091,9110,9666,9877,9943,9944,9998,10004,10778,15742,
                        16012,18988,19283,19315,19780,24444,27352,27353,27355,32784,49163,49165,49175,
                        50389,50636,51493,55055,56738,61532,61900,62078,1021,9040,666,700,84,545,1112,
                        1524,2040,4321,5802,38292,49400,1084,1600,2048,2111,3006,6547,6699,9111,16080,
                        555,667,720,801,1443,1533,2106,5560,6007,1090,1091,1114,1117,1119,1122,1131,1138,
                        1151,1175,1199,1201,1271,1862,2323,2393,2394,2608,2725,2909,3003,3168,3221,3322,
                        3324,3390,3517,3527,3800,3809,3814,3826,3869,3878,3889,3905,3914,3920,3945,3971,
                        4004,4005,4279,4445,4550,4567,4848,4900,5033,5080,5087,5221,5440,5544,5678,5730,
                        5811,5815,5850,5862,5906,5907,5950,5952,6025,6510,6565,6567,6689,6692,6779,6792,
                        6839,7025,7496,7676,7800,7920,7921,7999,8022,8042,8045,8093,8099,8200,8290,8292,
                        8300,8383,9003,9081,9099,9200,9418,9575,9878,9898,9917,10003,10180,10215,11111,
                        12174,12265,14441,15004,16000,16113,17877,18040,18101,19350,25735,26214,27356,
                        30951,32783,32785,40911,41511,44176,44501,49161,49167,49176,50300,50500,52673,
                        52848,54045,54328,55056,56737,57797,60443,70,417,714,722,777,981,1009,2022,4224,
                        4998,6346,301,524,668,765,2041,5999,10082,259,1007,1417,1434,1984,2038,2068,4343,
                        6009,7004,44443,109,687,726,911,1461,2035,4125,6006,7201,9103,125,481,683,903,
                        1011,1455,2013,2043,2047,6668,6669,256,406,843,2042,2045,5998,9929,31337,44442,
                        1092,1095,1102,1105,1113,1121,1123,1126,1130,1132,1137,1141,1145,1147,1149,1154,
                        1164,1165,1166,1174,1185,1187,1192,1198,1213,1216,1217,1233,1236,1244,1259,1277,
                        1287,1300,1301,1309,1322,1328,1556,1641,1688,1719,1721,1805,1812,1839,1875,1914,
                        1971,1972,1974,2099,2170,2196,2200,2288,2366,2382,2557,2800,2910,2920,2968,3007,
                        3013,3050,3119,3304,3307,3376,3400,3410,3514,3684,3697,3700,3824,3846,3848,3859,
                        3863,3870,3872,3888,3907,3916,3931,3941,3957,3963,3968,3969,3972,3990,3993,3994,
                        4009,4040,4080,4096,4143,4147,4200,4252,4430,4555,4600,4658,4875,4949,5040,5063,
                        5074,5151,5212,5223,5242,5279,5339,5353,5501,5807,5812,5818,5823,5868,5869,5899,
                        5905,5909,5914,5918,5938,5940,5968,5981,6051,6060,6068,6203,6247,6500,6504,6520,
                        6550,6600)
            ${NU`Mpo`RtS}--
            ${Por`T`LIST}."AD`dr`ANgE"(${tOPpOrTl`I`sT}[0..${Nu`m`Po`RTS}])
        }

        function Pa`R`Se-`PORTs
        {
            Param (
                [Parameter(ManDaTOrY = ${TR`Ue})] [String] ${PoR`TS},
                [Parameter(mandatoRy = ${T`RuE})] ${p`L`Ist}
            )

            foreach (${PR`AN`Ge} in ${p`oRts}.("{1}{0}"-f 'plit','S').Invoke(","))
            {

                
                if (${P`R`ANGe} -eq "-1")
                {
                    ${pL`ist}."a`dd"([int]${P`R`ANGe})
                }
                elseif (${Pr`ANgE}.("{1}{2}{0}" -f 'tains','Co','n').Invoke("-"))
                {
                    [int[]] ${R`ANgE} = ${pRa`NGe}.("{1}{0}"-f 'it','Spl').Invoke("-")
                    if (${R`A`NGe}."C`OUNt" -ne 2 -or ${p`R`AnGe}.("{0}{1}"-f 'Sp','lit').Invoke("-")[0] -eq "" -or ${p`RAnGe}.("{0}{1}"-f 's','plit').Invoke("-")[1] -eq "")
                    {
                        throw ("{3}{5}{2}{1}{4}{0}" -f'range','o','id p','I','rt ','nval')
                    }

                    ${PlI`St}."a`Dd`RAnge"(${ra`NGe}[0]..${RA`N`ge}[1])
                }
                else
                {
                    ${Pl`iST}."a`dd"([int]${PR`AN`GE})
                }

            }
            foreach (${P} in ${P`l`IST})
            {
                if (${P} -lt -1 -or ${p} -gt 65535)
                {
                    throw ('Po'+'rt '+"$p "+'out'+' '+'of'+' '+'rang'+'e')
                }
            }
         }

        function PAr`S`e-I`Pports
        {
           Param (
                [Parameter(MANdAtOry = ${t`RUE})] [String] ${pO`RtfI`lE}
            )

            &("{0}{3}{2}{1}" -f 'G','t','-Conten','et') ${P`Ortf`ilE} | &("{2}{4}{3}{1}{0}"-f 't','c','ForEach','e','-Obj') {
                &("{1}{0}{2}{3}" -f'arse-P','P','o','rts') -Ports ${_} -pList ${p`Or`Tlist}
            }
        }

        function REmov`E-Po`R`TS
        {
            Param (
                [Parameter(MandAtoRy = ${TR`Ue})] [string] ${ExC`L`UdEdP`o`Rts}
            )

            [int[]] ${ex`Cl`U`deDP`orTS} = ${ExCLu`DEdp`oR`TS}.("{1}{0}"-f'plit','S').Invoke(",")

            foreach (${X} in ${ex`Clu`dEDPO`R`TS})
            {
                ${P`ORtli`sT}.("{0}{1}" -f 'R','emove').Invoke(${X})
            }
        }

        function wrI`Te-P`Or`TS`cANOut
        {
            Param (
                [Parameter(mANDatORY = ${T`RuE}, pARaMeterSETnamE="CO`MMENT")] [string] ${COm`m`enT},
                [Parameter(mAndATORY = ${tr`UE}, parameTeRseTnAMe="HO`S`TOUT")] [string] ${oUth`oST},
                [Parameter(maNdAtorY = ${t`RUe}, ParameteRSeTNAME="h`osto`Ut")] [bool] ${I`SuP},
                [Parameter(MaNDatoRy = ${tr`Ue}, parAmETeRsetNaMe="Host`OuT")] ${o`PEnpO`RTs},
                [Parameter(mAnDaTORy = ${TR`UE}, pARAmETeRsETname="hOsTO`Ut")] ${CLOSED`PoR`Ts},
                [Parameter(manDATOry = ${tR`Ue}, ParAMETERsetnAmE="h`OSTOuT")] ${FIL`T`EreDpo`RTS},
                [Parameter()] [bool] ${SkI`p`dISCOVe`RY},
                [Parameter()] [System.IO.StreamWriter] ${GREp`S`Tr`eaM},
                [Parameter()] [System.Xml.XmlWriter] ${x`mlstrE`AM},
                [Parameter()] [System.IO.StreamWriter] ${REAd`A`Bl`EStre`AM}

            )
            switch (${psc`M`d`LeT}.paRAmeTERSeTNAme)
            {
                ("{1}{0}" -f 'nt','Comme')
                {

                    &("{2}{1}{0}{3}" -f 'V','ite-','Wr','erbose') ${Com`M`EnT}

                    if (${G`Re`p`sTreaM}) {
                        ${GrE`PstRe`Am}.("{3}{1}{0}{2}"-f 'teLi','i','ne','Wr').Invoke("# " + ${C`oM`mENT})
                    }
                    if (${XMlS`TRe`Am}) {
                        ${XmlS`T`REAm}.("{2}{3}{0}{1}" -f 'mm','ent','W','riteCo').Invoke(${c`omMenT})
                    }
                    if (${r`e`AdABL`estrEam}) {
                        ${REAda`B`LES`Tr`eAM}.("{2}{0}{1}" -f 'Li','ne','Write').Invoke(${COmM`E`Nt})
                    }
                }
                ("{1}{0}{2}" -f 'stOu','Ho','t')
                {
                    ${O`p`orT} =  $40KFqO::("{0}{1}"-f'jo','in').Invoke(",", ${opENP`OR`TS}.("{1}{0}{2}"-f 'ra','ToAr','y').Invoke())
                    ${CP`oRT} =  (&("{0}{1}"-f 'gC','i')  ("VarI"+"aB"+"Le:40"+"KfqO")  )."VaL`Ue"::("{0}{1}"-f'jo','in').Invoke(",", ${ClOs`ED`PortS}.("{2}{1}{0}" -f'rray','A','To').Invoke())
                    ${F`pORt} =   ( &("{0}{1}" -f'vARIaB','le') ("{1}{0}"-f'qo','40kF') )."VaL`Ue"::("{0}{1}" -f 'j','oin').Invoke(",", ${FiltER`eDp`oR`TS}.("{2}{1}{0}" -f'ray','r','ToA').Invoke())

                    if (${grep`STre`Am}) {
                       
                       if (${i`SUP} -and !${sKi`p`DiSc`ovERY}) {
                            ${grEPS`Tr`e`AM}.("{3}{1}{2}{0}"-f'ne','rit','eli','w').Invoke(('Host'+': '+"$outhost`tStatus: "+'Up'))
                        }
                        if (${is`Up} -or ${S`K`iP`dIscOv`ERY}) {
                            if (${op`O`Rt} -ne "") {
                                ${gRE`PsTRE`Am}.("{2}{1}{0}"-f'teline','i','wr').Invoke(('Ho'+'st: '+"$outhost`tOpen "+'Po'+'rts'+': '+"$oPort"))
                            }
                            if (${cpo`Rt} -ne "") {
                                ${g`R`eps`Tream}.("{1}{0}" -f'teline','wri').Invoke(('Ho'+'st: '+"$outhost`tClosed "+'Por'+'ts: '+"$cPort"))
                            }
                            if (${FPO`Rt} -ne "") {
                                ${G`R`E`pStrEAM}.("{0}{1}{2}"-f'wr','ite','line').Invoke(('H'+'ost: '+"$outhost`tFiltered "+'Ports'+': '+"$fPort"))
                            }
                        }
                        elseif (!${SK`ipD`ISco`VEry}) {
                            ${g`REPS`Tream}.("{2}{0}{1}"-f 'l','ine','write').Invoke(('Host'+': '+"$outhost`tStatus: "+'D'+'own'))
                        }
                    }
                    if (${X`MlST`Re`AM}) {
                        ${xmLSt`R`eam}.("{0}{3}{4}{2}{1}"-f'Wr','t','men','i','teStartEle').Invoke(("{0}{1}"-f 'H','ost'))

                        ${XmLS`T`REAM}.("{5}{2}{3}{0}{1}{4}" -f'S','tri','teAt','tribute','ng','Wri').Invoke("id", ${ouThO`st})
                        if (!${SK`IpD`iSCoVe`RY}) {
                            if (${IS`UP}) {
                                ${x`M`l`streAm}.("{5}{3}{6}{1}{0}{4}{2}" -f 'but','ttri','g','te','eStrin','Wri','A').Invoke(("{0}{1}" -f 'St','atus'), "Up")
                             }
                             else {
                                ${Xmlstr`E`AM}.("{2}{3}{1}{5}{4}{0}"-f 'ring','t','Wr','i','teSt','eAttribu').Invoke(("{0}{1}"-f 'Statu','s'), ("{0}{1}"-f 'Do','wns'))
                             }
                        }

                        ${xM`lSTre`Am}.("{4}{2}{3}{0}{1}" -f'n','t','teS','tartEleme','Wri').Invoke(("{1}{0}" -f'ts','Por'))
                        foreach(${P} in ${op`e`NP`orTS}) {
                            ${x`mlS`T`Ream}.("{0}{2}{1}{3}{4}" -f'writes','rtEl','ta','em','ent').Invoke(("{0}{1}"-f 'Po','rt'))
                            ${x`mlst`RE`Am}."WriteA`T`TRi`BuTestR`i`NG"("id", [string]${P})
                            ${X`m`LsTre`AM}.("{0}{3}{5}{2}{1}{4}" -f'WriteAt','S','e','tri','tring','but').Invoke(("{1}{0}" -f 'te','sta'), ("{0}{1}" -f 'ope','n'))
                            ${XmLs`T`RE`Am}.("{0}{3}{2}{1}"-f 'Write','t','Elemen','End').Invoke()

                        }
                        foreach (${P} in ${cLo`Se`D`PORts}) {
                            ${XM`lSTRE`Am}.("{0}{1}{2}{3}{4}"-f 'writ','es','tart','Eleme','nt').Invoke(("{1}{0}"-f 'rt','Po'))
                            ${xm`lst`R`eAM}."wR`it`EatT`R`IBuTEs`Tring"("id", [string]${P})
                            ${x`mLstRe`Am}.("{2}{4}{5}{0}{3}{6}{1}" -f't','ng','W','tribute','rit','eA','Stri').Invoke(("{0}{1}"-f 's','tate'), ("{0}{1}" -f 'c','losed'))
                            ${xmLsTr`e`Am}.("{1}{2}{3}{0}" -f't','W','rit','eEndElemen').Invoke()
                        }
                        foreach (${P} in ${Fil`Te`Re`D`pOrTS}) {
                            ${xmlstR`E`AM}.("{0}{1}{4}{2}{3}"-f 'wri','testart','le','ment','E').Invoke(("{1}{0}"-f 'rt','Po'))
                            ${X`MLS`TREaM}."wrI`T`EAT`Tr`ibUTEsTRiNg"("id", [string]${P})
                            ${xM`l`s`TreAm}.("{2}{0}{1}{4}{6}{5}{3}"-f'it','eA','Wr','g','ttribu','eStrin','t').Invoke(("{0}{1}" -f'sta','te'), ("{1}{0}"-f'ltered','fi'))
                            ${x`mLS`TrE`AM}.("{1}{3}{0}{2}"-f 'emen','W','t','riteEndEl').Invoke()
                        }

                        ${xM`ls`TReAm}.("{0}{3}{2}{1}" -f 'WriteE','t','emen','ndEl').Invoke()
                        ${xM`LS`TREAm}.("{3}{0}{2}{1}" -f 'El','nt','eme','WriteEnd').Invoke()
                    }
                    if (${R`eAd`A`BlesTReAM}) {
                        ${R`Ead`AbLEs`TReaM}.("{1}{3}{0}{2}"-f 'elin','wr','e','it').Invoke(('Po'+'r'+'sca'+'n.ps1 '+'scan'+' '+'r'+'eport '+'fo'+'r '+"$outhost"))
                        if (${I`SUp}) {
                            ${r`E`AdABLESTrE`Am}.("{2}{0}{1}" -f'e','line','writ').Invoke(("{3}{0}{1}{2}"-f 'ost',' is',' up','H'))
                        }

                        if (${Is`UP} -or ${SKIpDI`S`cOveRy}) {

                            ${rEA`D`ABlES`TREAm}.("{2}{1}{0}"-f'ine','el','writ').Invoke(("{0,-10}{1,0}" -f ("{1}{0}"-f 'T','POR'), ("{1}{0}"-f 'TE','STA')))

                            [int[]]${alLP`O`Rts} = ${OP`enp`ORTs} + ${CL`O`sEDpORtS} + ${Fil`TeReD`poR`Ts}
                            foreach(${p} in (${ALLp`orTs}| &("{1}{2}{0}" -f'ct','Sort-Ob','je')))
                            {
                                if (${Op`en`POrTS}.("{1}{0}" -f'ins','Conta').Invoke(${p})) {
                                    ${r`e`ADaB`lEs`TrEam}.("{0}{1}{2}" -f'writel','i','ne').Invoke(("{0,-10}{1,0}" -f ${P}, ("{0}{1}" -f'o','pen')))
                                }
                                elseif (${clo`S`ed`PoRts}.("{0}{1}"-f 'Co','ntains').Invoke(${p})) {
                                    ${r`ead`AB`lestReam}.("{0}{1}{2}"-f 'writ','eli','ne').Invoke(("{0,-10}{1,0}" -f ${p}, ("{0}{2}{1}"-f 'c','d','lose')))
                                }
                                elseif (${filT`E`ReDPor`TS}.("{2}{0}{1}" -f'ntain','s','Co').Invoke(${p})) {
                                    ${Re`AdaBl`e`S`TREam}.("{1}{2}{0}{3}"-f'itel','w','r','ine').Invoke(("{0,-10}{1,0}" -f ${P}, ("{2}{1}{0}"-f 'red','te','fil')))
                                }
                            }

                        }
                        elseif(!${S`kIpdi`sCO`Ve`RY}) {
                            ${r`ea`d`ABlEstreaM}.("{1}{2}{0}"-f 'teline','wr','i').Invoke(("{1}{0}{2}{3}" -f's','Ho','t is ','Down'))
                        }
                        ${reaDABLE`St`Re`Am}.("{2}{1}{0}"-f 'ine','l','write').Invoke("")
                    }
                }
            }
        }

        
        function coNver`T`-`swITCHTOBool
        {
            Param (
                [Parameter(MANdatORY = ${t`RUE})] ${sWi`T`CHv`AlUE}
            )
            If (${SWi`T`Ch`VaLue}) {
                return ${t`Rue}
            }
            return ${FaL`sE}
        }

        try
        {

            [bool] ${skIP`DIS`co`VeRY} = &("{3}{5}{4}{1}{0}{2}"-f 'to','Switch','Bool','Conv','rt-','e') (${s`kIp`D`IScov`ery})
            [bool] ${p`INgO`NLy} = &("{2}{1}{0}{3}" -f 'vert-','n','Co','SwitchtoBool') (${pi`NGON`LY})
            [bool] ${Q`Uiet}  = &("{3}{2}{4}{0}{1}" -f'o','l','t-Switchto','Conver','Bo') (${Qu`IeT})
            [bool] ${forc`EOVe`RwrITe}  = &("{5}{3}{2}{1}{4}{0}" -f 'ol','w','vert-S','on','itchtoBo','C') (${F`ORCeOv`eR`wRITe})

            
            
            

              ( &("{1}{2}{0}"-f'BlE','ge','t-VARiA') ("{1}{0}" -f 'N','Ed6A') -va  )::"CurRen`TdIREc`To`Ry"=(&("{0}{2}{1}{3}" -f 'Get-','io','Locat','n') -PSProvider ("{2}{1}{0}" -f'm','ste','FileSy'))."pr`OV`IDeR`pATH"

            if (${PS`CMD`lEt}.PARAMeTErSETnAmE -eq ("{1}{2}{0}" -f's','cmd','Host'))
            {
                foreach(${H} in ${h`OsTs})
                {
                    &("{0}{2}{1}"-f'Pa','s','rse-Host')(${h}) | &("{1}{0}{2}"-f '-Nu','Out','ll')
                }
            }
            else
            {
                &("{4}{0}{1}{3}{2}" -f 'a','r','ts','se-ILHos','P')(${HoS`TF`iLe}) | &("{0}{1}" -f 'O','ut-Null')
            }
            if(${EX`cLuDEH`OsTs})
            {
                &("{4}{1}{3}{0}{2}"-f 's','lude','ts','-Ho','Exc')(${ExcLuD`EhOs`Ts})
            }
            if ((${To`ppo`RTs} -and ${p`O`RtS}) -or (${t`OppO`RtS} -and ${p`OR`TfilE}))
            {
                throw ("{3}{6}{2}{0}{7}{8}{9}{1}{4}{5}{10}"-f'set','her spe','not ','Ca','cific ','port','n',' topPo','r','ts with ot','s')
            }
            if(${pO`R`TS})
            {
                &("{2}{0}{3}{1}"-f 'ar','-Ports','P','se') -Ports ${p`oR`Ts} -pList ${p`OR`TList} | &("{1}{2}{0}" -f 'ull','Ou','t-N')
            }
            if(${p`oRtFi`le})
            {
                &("{0}{1}{2}{3}" -f'Pa','rse-','IpPor','ts')(${P`ort`File}) | &("{0}{1}"-f'Out-Nu','ll')
            }
            if(${PoR`T`lI`sT}."CoU`Nt" -eq 0)
            {
                if (${T`oPpOR`Ts})
                {
                    &("{2}{0}{1}{3}" -f 't-Top','P','Ge','ort')(${TO`Pp`or`TS}) | &("{2}{0}{1}"-f 'N','ull','Out-')
                }
                else
                {
                    
                    &("{2}{1}{0}"-f 'ort','t-TopP','Ge')(50) | &("{2}{0}{1}" -f 'Nul','l','Out-')
                }
            }
            if (${E`xc`lu`deDPoR`Ts})
            {
                &("{2}{3}{1}{0}"-f 'orts','ove-P','Re','m') -ExcludedPorts ${exc`Lud`eDp`oRTs} | &("{2}{1}{0}" -f'Null','ut-','O')
            }

            if(${T})
            {
                switch (${T})
                {
                    5 {${n`hOsTS}=30;  ${T`HreAds} = 1000; ${Ti`M`eOUt} = 750 }
                    4 {${NH`OSTs}=25;  ${t`hR`eAds} = 1000; ${TIMe`o`Ut} = 1200 }
                    3 {${nho`s`TS}=20;  ${Th`R`eadS} = 100;  ${t`iMeo`Ut} = 2500 }
                    2 {${nhO`STs}=15;  ${tHr`ea`dS} = 32;   ${TIm`E`OuT} = 3000 }
                    1 {${N`HosTs}=10;  ${th`Re`ADs} = 32;   ${TiM`eo`UT} = 5000 }
                    ("{1}{0}" -f 'ault','def') {
                        throw ("{2}{0}{4}{1}{3}" -f 'd T ','ame','Invali','ter','par')
                    }
                }
            }

            ${gRe`Pst`R`EaM} = ${N`ULl}
            ${xmL`STr`eaM} = ${nU`Ll}
            ${REA`dABLe`sTReam} = ${n`UlL}

            if(${ALLFOrM`A`TSOut})
            {
                if (${grEP`OUT} -or ${XM`l`oUT} -or ${reaD`Ab`lEouT}) {
                     &("{0}{1}{2}" -f 'Writ','e-War','ning') ("{3}{10}{8}{9}{5}{0}{1}{12}{4}{7}{11}{2}{6}" -f' output... going ','to ig','/-','Bo','-','r','oX','o','pecifie','d with othe','th -oA s','G/-oN','nore ')
                }
                ${g`RE`PoUT} = ${ALlF`OrmA`Tso`Ut} + ("{0}{1}"-f '.gnma','p')
                ${XM`lO`Ut} = ${A`Llfo`R`MATSOUT} + ("{1}{0}"-f'xml','.')
                ${ReADa`BlE`OuT} = ${aLLfor`Mat`S`out} + ("{0}{1}" -f'.nm','ap')
            }
            if (${G`REpoUt}) {
                if (!${fOR`cEove`Rwrite} -and (&("{2}{0}{1}"-f'st-Pa','th','Te') ${g`R`EpoUt})) {
                    throw ('Err'+'o'+'r: '+"$AllformatsOut "+'al'+'ready '+'ex'+'ists.'+' '+'Eit'+'her '+'d'+'ele'+'te '+'the'+' '+'f'+'ile '+'or'+' '+'speci'+'fy'+' '+'the'+' '+'-'+'f '+'fla'+'g')
                }
                ${GRE`pSTr`EAm} = [System.IO.StreamWriter] ${GRE`pO`Ut}
            }
            if (${r`EADaB`le`oUT}) {
                if (!${f`orcEOvE`RWri`Te} -and (&("{0}{1}"-f'Test-Pat','h') ${r`eADab`l`EoUT})) {
                    throw ('Err'+'or: '+"$ReadableOut "+'alre'+'a'+'dy '+'e'+'xists'+'. '+'Eit'+'her '+'d'+'elet'+'e '+'the'+' '+'fil'+'e '+'o'+'r '+'sp'+'e'+'cify '+'t'+'he '+'-f'+' '+'fla'+'g')
                }
                ${r`EaDa`B`LesT`REaM} = [System.IO.StreamWriter] ${RE`ADAbL`eOuT}
            }
            if (${xml`Out}) {
                if (!${f`ORC`E`ovErWrITe} -and (&("{2}{1}{0}" -f 'Path','-','Test') ${xM`L`OUT})) {
                    throw ('Er'+'ror'+': '+"$XmlOut "+'alrea'+'d'+'y '+'exis'+'t'+'s. '+'Eith'+'er'+' '+'de'+'lete '+'t'+'he '+'fi'+'le '+'o'+'r '+'sp'+'e'+'cify '+'t'+'he '+'-f'+' '+'f'+'lag')
                }

                ${xmlSt`R`EAM} =    ( &("{0}{1}"-f 'g','ci') ("{1}{3}{4}{2}{0}" -f'zSOB','vaR','k3','iab','LE:') )."VaL`UE"::"CrEA`Te"([string]${X`m`LouT})
                ${Xm`l`sTReAm}.("{0}{2}{5}{4}{1}{3}"-f'Wr','cum','ite','ent','Do','Start').Invoke()
                ${x`M`LstrE`AM}.("{5}{1}{4}{2}{0}{3}" -f'me','rt','le','nt','E','WriteSta').Invoke(("{2}{0}{1}"-f 'ca','nrun','Ports'))
                ${X`mLSTrE`AM}.("{0}{2}{3}{5}{1}{4}"-f'Wr','Stri','i','t','ng','eAttribute').Invoke(("{1}{0}{2}" -f'sio','ver','n'), ${V`Er`siON})

            }

            &("{1}{0}{2}"-f'-','Parse','Ports') -Ports ${disCOV`er`Y`por`TS} -pList ${hO`sTpoRtL`Ist} | &("{2}{0}{1}" -f'-','Null','Out')

            ${s`TAR`TDate} = &("{2}{1}{0}"-f'Date','-','Get')
            ${mYinvOC`AtiON`l`ine} = ${PScMd`LeT}."MY`INVOc`AtIOn"."Li`NE"
            ${sTA`RtmsG} = ('Inv'+'o'+'ke-Portsca'+'n.p'+'s1 '+"v$version "+'scan'+' '+'init'+'iated'+' '+"$startdate "+'a'+'s: '+"$myInvocationLine")

            
            &("{2}{0}{1}{3}"-f 'ri','te-PortscanOu','W','t') -comment ${S`T`ARtMsg} -grepStream ${G`RE`PSt`REAM} -xmlStream ${Xm`ls`Tr`Eam} -readableStream ${Rea`daBlEstr`eam}

            
            ${S`pO`RTL`iSt} =  ( &('GI') ("VArIABlE:4"+"0"+"KfQO"))."VA`LuE"::("{0}{1}" -f 'joi','n').Invoke(",", ${p`ortL`IST})
            ${s`Ho`sTpOR`TlI`St} =  $40Kfqo::("{1}{0}" -f'n','joi').Invoke(",", ${hoS`TPO`RTl`IST})

            
            
            
            ${pOR`Ts`CA`NcOde} = {
                param (
                    [Parameter( mANDatorY = ${t`RUe})] [string] ${T`h`oSt},
                    [Parameter( MaNDaTORY = ${tr`Ue})][bool] ${s`k`IpdI`ScovEry},
                    [Parameter( MANDATOrY = ${TR`UE})][bool] ${P`I`NGOn`LY},
                    [Parameter( MandaTOrY = ${TR`Ue})][int] ${TI`meo`Ut},
                    [Parameter( MaNdatOry = ${T`RuE})] ${PO`RtL`ISt},
                    [Parameter( mandAtoRy = ${t`Rue})] ${Ho`StPo`Rt`L`IST},
                    [Parameter( MandAtORY = ${TR`Ue})][int] ${M`Axt`HrE`ADS})
                Process
                {
                ${opeN`p`ortS} = &("{0}{2}{1}{3}"-f'New','c','-Obje','t') ("{5}{0}{4}{3}{2}{1}" -f 'stem.Col','ArrayList','s.','tion','lec','Sy')
                ${c`lO`sedPORTS} = &("{0}{1}{2}"-f 'Ne','w-Obje','ct') ("{4}{3}{2}{1}{0}" -f 's.ArrayList','on','Collecti','tem.','Sys')
                ${fILT`Er`E`dPoRTS} = &("{2}{0}{1}" -f 'b','ject','New-O') ("{1}{3}{4}{2}{0}" -f 'ns.ArrayList','System.C','o','oll','ecti')

                ${SoCkE`TS} = @{}
                ${tiM`eO`U`Ts} = &("{1}{2}{0}" -f'bject','N','ew-O') ("{1}{0}"-f'e','Hashtabl')

                
                ${FtHr`E`Ads} = &("{1}{2}{0}"-f 't','New-Obj','ec') ("{1}{0}"-f'nt','i')
                ${at`hREaDs} = &("{3}{0}{2}{1}" -f'e','t','w-Objec','N') ("{0}{1}"-f 'i','nt')
                 (&("{1}{2}{0}"-f'e','GeT-VARiaB','l') ('O'+'Ze')  -VAluEo  )::"GETM`AXth`REaDs"([ref]${F`THre`ADS}, [ref]${A`Thre`Ads}) | &("{1}{0}{2}"-f 'l','Out-Nu','l')
                  ( &('lS') ("VAr"+"IAbLe:oz"+"E") )."vA`LUE"::("{0}{3}{2}{1}{4}"-f 'S','axT','M','et','hreads').Invoke(${Fth`R`eADs},${ma`xT`HR`eads}) | &("{1}{0}"-f'ull','Out-N')

                function NEW`-sC`RI`ptBl`o`c`KcAllback {
                    param(
                        [parameter(mANDAtORy=${tr`Ue})]
                        [ValidateNotNullOrEmpty()]
                        [scriptblock]${CA`l`LBacK}
                    )

                    
                    if (-not (("{3}{2}{0}{1}" -f 'v','entBridge','lbackE','Cal') -as [type])) {
                        &("{1}{0}{2}"-f 'd-Ty','Ad','pe') @"
                            using System;

                            public sealed class CallbackEventBridge
                            {
                                public event AsyncCallback CallbackComplete = delegate { };

                                private CallbackEventBridge() {}

                                private void CallbackInternal(IAsyncResult result)
                                {
                                    CallbackComplete(result);
                                }

                                public AsyncCallback Callback
                                {
                                    get { return new AsyncCallback(CallbackInternal); }
                                }

                                public static CallbackEventBridge Create()
                                {
                                    return new CallbackEventBridge();
                                }
                            }
"@
                    }

                    ${bR`iDGe} =  (  &("{1}{2}{0}"-f 'm','Get-It','e')  ("v"+"ArIa"+"bLe"+":"+"Dt5laW")  )."vA`LuE"::("{0}{1}" -f'C','reate').Invoke()
                    &("{1}{5}{4}{3}{2}{0}"-f'ent','Re','Ev','-Object','ster','gi') -InputObject ${b`Ridge} -EventName ("{4}{0}{1}{2}{3}"-f'lbackC','o','mplet','e','Cal') -Action ${cAll`BA`CK} | &("{1}{0}"-f 't-Null','Ou')

                    ${bRI`DGE}."C`AllBACk"

                }

                function TE`S`T-pOrT {

                    Param (
                        [Parameter(mandAToRY = ${t`RUe})] [String] ${H},
                        [Parameter(manDAToRY = ${tR`Ue})] [int] ${P},
                        [Parameter(MAnDaTORY = ${TR`Ue})] [int] ${tiMeo`Ut}
                    )

                    try {
                        ${PAdDr`e`Ss} =   $QVwT1::("{1}{0}" -f'rse','Pa').Invoke(${H})
                        ${sock`ETS}[${P}] = &("{2}{0}{1}" -f 'ob','ject','new-') ("{7}{2}{0}{5}{6}{3}{1}{4}" -f 'Ne','lie','tem.','s.TcpC','nt','t.Sock','et','Sys') ${PaDd`R`esS}."a`ddr`essfA`m`iLy"

                    }
                    catch {
                        
                        ${s`oCke`TS}[${p}] = &("{2}{1}{0}"-f '-object','w','ne') ("{7}{5}{2}{1}{4}{3}{0}{6}" -f's.','.','em.Net','cket','So','t','TcpClient','Sys')
                    }

                    
                    ${S`Cr`IpT`Bl`OcKASStr`InG} = @"

                        #somewhat of a race condition with the timeout, but I don't think it matters
                        if ( `$sockets[$p] -ne `$NULL)
                        {
                            if (!`$timeouts[$p].Disposed) {
                                `$timeouts[$p].Dispose()
                            }

                            `$status = `$sockets[$p].Connected;
                            if (`$status -eq `$True)
                            {
                                #write-host "$p is open"
                                `$openPorts.Add($p)
                            }
                            else
                            {
                                #write-host "$p is closed"
                                `$closedPorts.Add($p)

                            }
                            `$sockets[$p].Close();

                            `$sockets.Remove($p)
                        }
"@
                    ${tIM`EOU`TCalL`BaCk} = @"
                        #write-host "$p is filtered"
                        `$sockets[$p].Close()
                        if (!`$timeouts[$p].Disposed) {
                            `$timeouts[$p].Dispose()
                            `$filteredPorts.Add($p)
                        }
                        `$sockets.Remove($p)
"@

                    ${Ti`MEOU`Tc`ALlB`ACK} =  $cy9UB::("{0}{2}{1}"-f 'Crea','e','t').Invoke(${TiMe`OUt`CA`l`lBacK})

                    ${timE`o`UtS}[${P}] = &("{0}{2}{1}"-f 'New','t','-Objec') ("{1}{0}{2}{3}" -f 'y','S','stem.Timers.Time','r')
                    &("{4}{3}{1}{0}{2}"-f'b','gister-O','jectEvent','e','R') -InputObject ${tIME`Ou`Ts}[${P}] -EventName ("{0}{1}" -f 'Elap','sed') -Action ${T`i`mE`OuTCAL`l`Back} | &("{2}{1}{0}" -f'-Null','t','Ou')
                    ${t`ime`oUTS}[${P}]."Inte`R`Val" = ${T`iMEOut}
                    ${TI`MEOUtS}[${p}]."e`N`AblEd" = ${Tr`Ue}

                    ${MYS`CrIP`Tb`L`OCk} =   $cy9uB::("{1}{2}{0}" -f'e','Cre','at').Invoke(${SCRI`pT`B`lo`ck`A`SstrIng})
                    ${X} = ${s`oc`KeTs}[${P}].("{0}{1}{2}{3}" -f 'be','ginConn','e','ct').Invoke(${h}, ${P},(&("{4}{3}{5}{1}{0}{2}{6}"-f'ckCall','tBlo','ba','w','Ne','-Scrip','ck')(${m`Ys`crI`pT`BLOCK})) , ${NU`lL})

                }

                function pORtsCaN-`Al`I`Ve
                {
                    Param (
                        [Parameter(manDatory = ${t`RuE})] [String] ${h}
                    )

                    Try
                    {

                        
                        if (${HoST`p`oRTLISt}.("{1}{0}{2}" -f 'n','Contai','s').Invoke(-1))
                        {
                            ${Pi`Ng} = &("{0}{2}{1}"-f 'new-','t','objec') ("{4}{1}{6}{3}{8}{2}{0}{7}{5}"-f 'nfor','stem.N','kI','t.','Sy','Ping','e','mation.','Networ')
                            ${PR`eSUlT} = ${Pi`Ng}.("{1}{0}"-f'd','sen').Invoke(${H})
                            if (${p`REs`UlT}."STA`TUs" -eq ("{0}{1}"-f 'S','uccess'))
                            {
                                return ${t`RUe}
                            }
                        }
                        foreach(${Po`Rt} in ${HOStPOrT`lI`sT})
                        {
                            if (${PO`Rt} -ne -1)
                            {
                                &("{0}{1}" -f 'Test-Por','t') -h ${H} -p ${P`orT} -timeout ${TIme`O`Ut}
                            }
                        }

                        do {
                            &("{0}{2}{1}" -f 'Sta','ep','rt-Sle') -Milli 100
                            if ((${o`penPOr`Ts}."CO`UNT" -gt 0) -or (${cLos`eD`Ports}."CO`UNt" -gt 0)) {
                                return ${Tr`UE}
                            }
                        }
                        While (${sOck`E`Ts}."C`OUNT" -gt 0)

                    }
                    Catch
                    {
                        &("{1}{3}{0}{2}" -f'e-','Wr','Error','it') ('Except'+'i'+'on '+'try'+'ing '+'to'+' '+'h'+'ost '+'scan'+' '+"$h")
                        &("{1}{2}{0}"-f'-Error','Writ','e') ${_}."ExC`E`PTIon"."mess`AGE";
                    }

                    return ${Fa`lSE}
                }

                function pOR`TS`c`An-`pOrt
                {
                    Param (
                        [Parameter(mAndAtORY = ${tR`Ue})] [String] ${H}
                    )

                    [string[]]${Po`RtS} = @()

                    foreach(${P`orT} in ${pOR`T`lIST})
                    {
                        Try
                        {
                            &("{1}{0}{2}"-f 't-Por','Tes','t') -h ${H} -p ${PO`Rt} -timeout ${tI`ME`ouT}
                        }
                        Catch
                        {
                            &("{0}{1}{2}{3}"-f 'Wr','ite-E','rr','or') ('E'+'xcepti'+'on '+'trying'+' '+'to'+' '+'s'+'can '+"$h "+'p'+'ort '+"$Port")
                            &("{0}{2}{3}{1}" -f'W','rror','ri','te-E') ${_}."Exc`E`PTiON"."mESS`AgE";
                        }
                    }
                }
                [bool] ${hO`StrEs`U`lT} = ${fA`L`SE}

                if(!${SKi`PdIS`COVe`Ry})
                {
                    [bool] ${HosT`R`Es`Ult} = &("{3}{0}{2}{1}" -f 'can-A','e','liv','PortS') ${TH`O`ST}
                    ${OP`enPO`RTs}.("{1}{0}"-f 'ear','cl').Invoke()
                    ${cLOs`e`DPOrts}.("{1}{0}" -f'lear','c').Invoke()
                    ${F`ilT`Er`edPoR`TS}.("{1}{0}" -f 'lear','C').Invoke()
                }
                if((!${p`IN`go`NLY}) -and (${HOStR`ES`ULT} -or ${skipdiS`C`Ov`ERy}))
                {
                    &("{2}{0}{1}" -f 'n-Po','rt','Portsca') ${TH`oSt}
                }
                while (${SocKe`Ts}."cOU`Nt" -gt 0) {
                    &("{2}{1}{0}"-f'eep','l','Start-S') -Milli 500
                }

                return @(${hOStRes`U`lt}, ${Ope`N`PO`Rts}, ${clos`E`D`POrts}, ${FIlTere`dp`Orts})
                }
            }

            
            

            [int]${Sa`VEiT`eR`AT`IOn} = 0
            [int]${Co`M`Pu`TERsD`onE}=0
            [int]${uPhO`StS}=0
            while ((${SAvEiteR`At`I`On} * ${sy`N`Cfr`eQ}) -lt ${host`Li`St}."coU`NT")
            {

                &("{1}{0}"-f 't-Job','Ge') | &("{0}{1}{2}"-f 'R','e','move-Job') -Force
                ${SI`NdEX} = (${S`AvEI`TeRA`TIoN}*${S`yn`CfREq})
                ${eiN`d`EX} = ((${sa`VE`itERa`T`ion}+1)*${sYN`CF`R`eQ})-1

                foreach (${IH`oSt} in ${HOsTLI`St}[${Si`Nd`Ex}..${Ei`N`dex}])
                {
                    ${C`Tr} = @(&("{1}{0}{2}" -f 't-','Ge','Job') -state ("{0}{1}"-f'Runnin','g'))
                    while (${c`TR}."C`OUNt" -ge ${Nho`sts})
                    {
                        &("{0}{1}{2}"-f'Start-S','lee','p') -Milliseconds ${sL`E`e`ptImER}
                        ${c`Tr} = @(&("{0}{1}"-f'Get-J','ob') -state ("{0}{2}{1}" -f 'R','ing','unn'))
                    }

                    ${com`P`UtER`Sd`oNe}++
                    if(!${N`oPR`oGrEs`sMe`Ter})
                    {
                        &("{0}{1}{2}" -f'Write','-Prog','ress') -status ("{1}{0}{2}" -f'an','Port Sc','ning') -Activity ${St`A`RTMsg} -CurrentOperation ('s'+'t'+'arting'+' '+'co'+'mp'+'uter '+"$computersDone")  -PercentComplete (${Co`mP`UTERs`d`ONE} / ${ho`Stl`iSt}."CO`UNT" * 100)
                    }

                    &("{0}{2}{1}" -f 'St','Job','art-') -ScriptBlock ${p`ORtsc`AN`C`ode} -Name ${iHO`sT} -ArgumentList @(${I`h`osT}, ${S`KIpdIsCOV`e`Ry}, ${PI`N`GONLY}, ${T`i`MEouT}, ${pOR`TL`IST}, ${HoStpor`T`list}, ${TH`REa`dS})  | &("{2}{1}{0}"-f'll','-Nu','Out')
                }

                &("{0}{2}{1}"-f'Ge','Job','t-') | &("{0}{2}{1}"-f'Wa','ob','it-J') | &("{0}{2}{1}" -f 'Out-','l','Nul')

                foreach (${J`oB} in &("{1}{2}{0}" -f 'b','Get-','Jo'))
                {
                    ${j`oBOut} = @(&("{1}{0}{3}{2}" -f 'ceiv','Re','-Job','e') ${J`ob})
                    [bool]${Ho`st`Up} = ${Jo`Bout}[0]
                    ${jO`B`Name} = ${J`OB}."nA`mE"

                    ${O`pEnp`or`Ts} = ${Jo`B`OuT}[1]
                    ${c`LOSeD`PORTS} = ${jO`BOut}[2]
                    ${fIL`T`eRe`DpOrTs} = ${j`OBOUT}[3]

                    if(${h`OSt`Up}) {
                        ${Up`HO`StS} ++
                    }

                    if (!${QU`iET})
                    {
                        if(${O`pEN}){
                            if(${open`poR`TS}){
                                ${ho`ST`DaTe} = &("{0}{1}{2}"-f'G','e','t-Date')
                                ${ho`s`TOBj} = &("{0}{2}{1}" -f'New-','bject','O') ("{2}{3}{1}{0}"-f'Object','m.','Sy','ste')
                                ${H`Ost`oBj} | &("{0}{2}{1}"-f 'Add-M','er','emb') -MemberType ("{1}{2}{0}{3}" -f'ert','Notep','rop','y') -Name ("{1}{2}{0}" -f'ame','Host','n') -Value ${j`OBN`AME}
                                ${hOS`T`oBJ} | &("{0}{2}{1}" -f 'Add-Memb','r','e') -MemberType ("{3}{2}{1}{0}"-f'perty','ro','tep','No') -Name ("{0}{1}" -f'al','ive') -Value ${hOST`UP}
                                ${hoS`TobJ} | &("{0}{2}{1}" -f 'Ad','ember','d-M') -MemberType ("{3}{1}{2}{0}"-f 'roperty','ot','ep','N') -Name ("{1}{0}{2}" -f'enP','op','orts') -Value ${o`peNPor`Ts}
                                ${HoStO`BJ} | &("{2}{0}{1}"-f'-Mem','ber','Add') -MemberType ("{0}{2}{3}{1}"-f'Not','ty','eprope','r') -Name ("{1}{0}{2}" -f 'lo','c','sedPorts') -Value ${CL`o`Se`dpoRtS}
                                ${ho`STO`Bj} | &("{0}{1}{2}"-f'A','dd-Mem','ber') -MemberType ("{2}{3}{1}{0}"-f'perty','epro','N','ot') -Name ("{0}{1}{2}" -f 'fil','teredPort','s') -Value ${f`IltErEdpo`Rts}
                                ${Hos`TObJ} | &("{1}{2}{0}"-f'ber','Ad','d-Mem') -MemberType ("{1}{0}{2}"-f 'opert','NotePr','y') -Name ("{1}{0}{2}"-f'i','f','nishTime') -Value ${hO`stdAte}
                                ${SC`ANN`edH`oStlISt} += ${HO`STOBj}
                            }
                        }
                        else {
                            ${hoST`Da`TE} = &("{2}{1}{0}"-f'-Date','t','Ge')
                            ${H`OSTOBj} = &("{0}{1}{2}{3}"-f'New','-','Obje','ct') ("{2}{3}{1}{0}" -f 'ect','.Obj','Syst','em')
                            ${H`osT`oBj} | &("{0}{2}{1}" -f 'Ad','-Member','d') -MemberType ("{2}{0}{1}" -f 'teprop','erty','No') -Name ("{0}{1}"-f 'Hostn','ame') -Value ${jOBNa`Me}
                            ${hOsTO`BJ} | &("{1}{0}{2}" -f'embe','Add-M','r') -MemberType ("{2}{1}{0}{3}"-f'e','t','No','property') -Name ("{0}{1}"-f'ali','ve') -Value ${h`O`StuP}
                            ${HO`s`TobJ} | &("{0}{1}{2}" -f 'Ad','d-','Member') -MemberType ("{2}{1}{0}" -f'eproperty','ot','N') -Name ("{1}{2}{0}" -f's','o','penPort') -Value ${ope`N`pOrts}
                            ${H`osT`oBj} | &("{1}{0}{2}"-f 'm','Add-Me','ber') -MemberType ("{0}{1}{2}" -f'N','ote','property') -Name ("{1}{2}{0}{3}" -f'osedPort','c','l','s') -Value ${cl`O`sEd`PorTS}
                            ${h`oST`ObJ} | &("{2}{0}{1}{3}" -f 'd-M','emb','Ad','er') -MemberType ("{2}{1}{0}{3}" -f 'prope','te','No','rty') -Name ("{0}{2}{1}"-f'fi','teredPorts','l') -Value ${fiLteR`edpO`RTS}
                            ${HOs`ToBJ} | &("{1}{2}{0}"-f'ember','Add-','M') -MemberType ("{3}{2}{1}{0}" -f'ty','r','rope','NoteP') -Name ("{1}{0}{2}" -f'im','finishT','e') -Value ${HO`s`TDATE}
                            ${SCaNnE`d`hO`StLI`sT} += ${ho`St`oBJ}
                        }
                    }

                    &("{4}{3}{1}{0}{2}" -f'scanO','t','ut','-Por','Write') -outhost ${J`O`BnaME} -isUp ${h`oSt`Up} -openPorts ${O`pEN`pOr`Ts} -closedPorts ${cLose`dpOR`TS} -filteredPorts ${fi`lter`E`dportS} -grepStream ${Gre`pst`Re`Am} -xmlStream ${xM`l`StREam} -readableStream ${RE`Adable`S`TReam} -SkipDiscovery ${sKIP`DISc`Ov`ERY}
                }

                if (${Gr`E`pstR`EaM}) {
                    ${GrE`P`strEaM}.("{0}{1}"-f 'fl','ush').Invoke()
                }
                if (${XM`Ls`T`ReaM}) {
                    ${X`ML`STr`eAm}.("{1}{0}"-f 'lush','f').Invoke()
                }
                if(${rE`ADAbL`EStREAm}) {
                    ${rea`DaBlEst`RE`Am}.("{0}{1}" -f'flus','h').Invoke()
                }

                ${SaVEitEra`TI`ON} ++
            }

            ${ENDDA`Te} = &("{2}{1}{0}" -f 'Date','et-','G')
            ${to`Ta`lTiMe} = (${en`Dda`Te} - ${S`Tar`TdAtE})."t`O`TalsEcO`NDs"
            ${enD`M`Sg} = ('Po'+'rt '+'sc'+'an '+'comp'+'le'+'te '+'a'+'t '+"$enddate "+"($totaltime "+'seco'+'nd'+'s)')
            if (!${skI`pdis`c`oveRy}) {
                ${endM`sG} += (', '+"$upHosts "+'ho'+'sts'+' '+'a'+'re '+'up')
            }

            &("{3}{0}{4}{1}{2}"-f 'o','tscan','Out','Write-P','r') -comment ${EN`D`mSg} -grepStream ${g`Rep`StREaM} -xmlStream ${X`mLs`TReaM} -readableStream ${r`EA`D`Ables`TREaM}

            if(${GRE`P`ST`Ream}) {
                ${gr`E`psTrEAm}.("{1}{0}" -f'ose','Cl').Invoke()
            }
            if (${x`mL`StrEAM}) {
                ${x`MLSTr`EaM}.("{0}{1}" -f 'C','lose').Invoke()
            }
            if(${R`EAdaBLeST`R`Eam}) {
                ${READa`BlE`stRe`AM}.("{1}{0}" -f'e','Clos').Invoke()
            }

            return ${SCaN`NeDhoSt`L`i`St}

        }
        Catch
        {
            &("{1}{2}{3}{0}" -f'ror','W','r','ite-Er') ${_}."eXCep`TIOn"."MESSa`ge";
        }
    }
}